<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DerivingStrategies #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# HLINT ignore &quot;Use for_&quot; #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE PartialTypeSignatures #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-partial-type-signatures #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-unrecognised-pragmas #-}</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="annot"><span class="hs-comment">{- | This module contains a simple (and musically rather naive)
 probabilistic model of protovoice derivations.
 This model can be used to sample a derivation,
 evaluate a derivations probability,
 or infer posterior distributions of the model parmeters from given derivations
 (i.e., &quot;learn&quot; the model's probabilities).

 This model is a /locally conjugate/ model:
 It samples a derivation using a sequence of random decisions with certain probabilities.
 These probabilities are generally unknown, so they are themselves modeled as random variables with prior distributions.
 The full model \(p(d, \theta)\) thus splits into
 \[p(D, \theta) = p(d \mid \theta) \cdot p(\theta),\]
 the prior over the probability variables
 \[p(\theta) = \prod_i p(\theta_i),\]
 and the likelihood of the derivation(s) given these probabilities
 \[p(D \mid \theta) = \prod_{d \in D} p(d \mid \theta) = \prod_{d \in D} \prod_i p(d_i \mid \theta, d_0, \ldots, d_{i-1}).\]
 Given all prior decisions, the likelihood of a decision \(d_i\) based on some parameter \(\theta_a\)
 \[p(d_i \mid \theta, d_{&lt;i})\]
 is [conjugate](https://en.wikipedia.org/wiki/Conjugate_prior) with the prior of that parameter \(p(\theta_a)\),
 which means that the posterior of the parameters given one (or several) derivation(s) \(p(\theta \mid D)\)
 can be computed analytically.

 The parameters \(\theta\) and their prior distributions
 are represented by the higher-kinded type 'PVParams'.
 Different instantiations of this type (using 'Hyper' or 'Probs') results in concrete record types
 that represent prior or posterior distributions
 or concrete values (probabilities) for the parameters.
 'PVParams' also supports 'jeffreysPrior' and 'uniformPrior' as default priors,
as well as 'sampleProbs' for sampling from a prior (see &quot;Inferenc.Conjugate&quot;).

 The likelihood \(p(d \mid \theta)\) of a derivation is represented by
 'sampleDerivation'.
 It can be executed under different &quot;modes&quot; (probability monads)
 for sampling, inference, or tracing (see &quot;Inference.Conjugate&quot;).
 The decisions during the derivation are represented by a 'Trace' (here @Trace PVParams@).
 In order to learn from a given derivation,
 the corresponding trace can be obtained using 'observeDerivation'.
 A combination of getting a trace and learning from it
 is provided by 'trainSinglePiece'.
-}</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html"><span class="hs-identifier">PVGrammar.Prob.Simple</span></a></span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Model Parameters</span></span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-comment">-- | A higher-kinded type that represents the global parameters (probabilities) of the model.</span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-comment">-- Use it as 'Hyper PVParams' to represent hyperparameters (priors and posteriors)</span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-comment">-- or as 'Probs PVParams' to represent actual probabilites.</span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-comment">-- Each record field corresponds to one parameter</span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-comment">-- that influences a specific type of decision in the generation process.</span><span>
</span><span id="line-61"></span><span>    </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier">PVParams</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsOuter"><span class="hs-identifier">PVParamsOuter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier">PVParamsInner</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#savePVHyper"><span class="hs-identifier">savePVHyper</span></a></span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#loadPVHyper"><span class="hs-identifier">loadPVHyper</span></a></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Likelihood Model</span></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-comment">-- | 'sampleDerivation' represents a probabilistic program that samples a derivation.</span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-comment">-- that can be interpreted in various modes for</span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-comment">-- - sampling ('sampleTrace', 'sampleResult'),</span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-comment">-- - inference ('evalTraceLogP', 'getPosterior'),</span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-comment">-- - tracing ('showTrace', 'traceTrace').</span><span>
</span><span id="line-75"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-comment">-- 'observeDerivation' takes and existing derivation and returns the corresponding trace.</span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleDerivation"><span class="hs-identifier">sampleDerivation</span></a></span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleDerivation%27"><span class="hs-identifier">sampleDerivation'</span></a></span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeDerivation"><span class="hs-identifier">observeDerivation</span></a></span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeDerivation%27"><span class="hs-identifier">observeDerivation'</span></a></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Utilities</span></span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#roundtrip"><span class="hs-identifier">roundtrip</span></a></span><span>
</span><span id="line-84"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#trainSinglePiece"><span class="hs-identifier">trainSinglePiece</span></a></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Likelihood model for parsing</span></span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-comment">-- | We need these specialized functions because of a dependency across steps:</span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-comment">-- During a double step (elaborating two transitions),</span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-comment">-- the process must decide whether to elaborate the left or right transition.</span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-comment">-- To normalize the derivation order, we can't elaborate the left transition</span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-comment">-- after the right one.</span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-comment">-- That means that the model *sometimes* has to make the decision to go right,</span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-comment">-- and sometimes not (i.e., after a right split).</span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-comment">-- During parsing, we don't know whether this decision had to be made or not,</span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-comment">-- since we don't know the previous derivation step yet.</span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-comment">-- Therefore, we don't include the decision in the current step,</span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-comment">-- but at the end of the previous one (in generation order),</span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-comment">-- where the context is known.</span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-comment">-- As a consequence, the result of this decision (if made)</span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-comment">-- needs to be passed to the functions scoring the previous step.</span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-comment">-- When parsing, make sure to maintain this information.</span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSingleStepParsing"><span class="hs-identifier">sampleSingleStepParsing</span></a></span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeSingleStepParsing"><span class="hs-identifier">observeSingleStepParsing</span></a></span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#evalSingleStep"><span class="hs-identifier">evalSingleStep</span></a></span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleDoubleStepParsing"><span class="hs-identifier">sampleDoubleStepParsing</span></a></span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeDoubleStepParsing"><span class="hs-identifier">observeDoubleStepParsing</span></a></span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#evalDoubleStep"><span class="hs-identifier">evalDoubleStep</span></a></span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Common.html"><span class="hs-identifier">Common</span></a></span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Common.html#Analysis"><span class="hs-identifier">Analysis</span></a></span><span>
</span><span id="line-113"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Common.html#anaDerivation"><span class="hs-identifier">anaDerivation</span></a></span><span>
</span><span id="line-114"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#anaTop"><span class="hs-identifier">anaTop</span></a></span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#Leftmost"><span class="hs-identifier">Leftmost</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#LeftmostDouble"><span class="hs-identifier">LeftmostDouble</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#LeftmostSingle"><span class="hs-identifier">LeftmostSingle</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier">Path</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#StartStop"><span class="hs-identifier">StartStop</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#getInner"><span class="hs-identifier">getInner</span></a></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PVGrammar.html"><span class="hs-identifier">PVGrammar</span></a></span><span>
</span><span id="line-124"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html"><span class="hs-identifier">PVGrammar.Generate</span></a></span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier">applySplit</span></a></span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#applySpread"><span class="hs-identifier">applySpread</span></a></span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#freezable"><span class="hs-identifier">freezable</span></a></span><span>
</span><span id="line-128"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">guard</span></span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unless</span></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">when</span></span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">lift</span></span><span class="hs-special">)</span><span>
</span><span id="line-136"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Except</span></span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">except</span></span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">runExceptT</span></span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.State</span></span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">StateT</span></span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">execStateT</span></span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Bi</span></span><span>
</span><span id="line-145"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">forM_</span></span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HM</span></span><span>
</span><span id="line-147"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashSet</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-148"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hashable</span></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-150"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-151"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">catMaybes</span></span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">fromMaybe</span></span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mapMaybe</span></span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Debug.Trace</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DT</span></span><span>
</span><span id="line-157"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Generics</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Inference.Conjugate</span></span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span class="hs-comment">-- import qualified Inference.Conjugate           as IC</span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">FromJSON</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ToJSON</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">eitherDecodeFileStrict</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">encodeFile</span></span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Internal.MultiSet.html"><span class="hs-identifier">Internal.MultiSet</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MS</span></span><span>
</span><span id="line-164"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Lens.Micro.TH</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">makeLenses</span></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Musicology.Pitch</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MP</span></span><span> </span><span class="hs-keyword">hiding</span><span>
</span><span id="line-166"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">a</span></span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">b</span></span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">c</span></span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">d</span></span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">e</span></span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">f</span></span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">g</span></span><span>
</span><span id="line-173"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Random.MWC.Probability</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">categorical</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">uniform</span></span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span class="hs-comment">-- orphan instances</span><span>
</span><span id="line-177"></span><span class="hs-comment">-- ================</span><span>
</span><span id="line-178"></span><span>
</span><span id="line-179"></span><span id="local-6989586621679474538"><span id="local-6989586621679474540"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Generic</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HyperRep</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-180"></span><span id="local-6989586621679474546"><span id="local-6989586621679474552"><span id="local-6989586621679474558"><span id="local-6989586621679474564"><span id="local-6989586621679474570"><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HyperRep</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-181"></span><span id="local-6989586621679474594"><span id="local-6989586621679474600"><span id="local-6989586621679474606"><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HyperRep</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span id="local-6989586621679474624"><span id="local-6989586621679474626"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Generic</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HyperRep</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Dirichlet</span></span><span> </span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-184"></span><span id="local-6989586621679474629"><span id="local-6989586621679474635"><span id="local-6989586621679474641"><span id="local-6989586621679474647"><span id="local-6989586621679474653"><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HyperRep</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Dirichlet</span></span><span> </span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-185"></span><span id="local-6989586621679474665"><span id="local-6989586621679474671"><span id="local-6989586621679474677"><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HyperRep</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Dirichlet</span></span><span> </span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span class="hs-comment">-- parameters</span><span>
</span><span id="line-188"></span><span class="hs-comment">-- ==========</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span class="annot"><span class="hs-comment">-- | Parameters for decisions about outer operations (split, spread, freeze).</span></span><span>
</span><span id="line-191"></span><span class="hs-keyword">data</span><span> </span><span id="PVParamsOuter"><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsOuter"><span class="hs-identifier hs-var">PVParamsOuter</span></a></span></span><span> </span><span id="local-6989586621679473197"><span class="annot"><a href="#local-6989586621679473197"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PVParamsOuter"><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsOuter"><span class="hs-identifier hs-var">PVParamsOuter</span></a></span></span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_pSingleFreeze"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsOuter f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pSingleFreeze"><span class="hs-identifier hs-var hs-var">_pSingleFreeze</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473197"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-193"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pDoubleLeft"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsOuter f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pDoubleLeft"><span class="hs-identifier hs-var hs-var">_pDoubleLeft</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473197"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-194"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pDoubleLeftFreeze"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsOuter f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pDoubleLeftFreeze"><span class="hs-identifier hs-var hs-var">_pDoubleLeftFreeze</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473197"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pDoubleRightSplit"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsOuter f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pDoubleRightSplit"><span class="hs-identifier hs-var hs-var">_pDoubleRightSplit</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473197"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-196"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-197"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679474692"><span id="local-6989586621679474694"><span class="annot"><span class="annottext">(forall x. PVParamsOuter f -&gt; Rep (PVParamsOuter f) x)
-&gt; (forall x. Rep (PVParamsOuter f) x -&gt; PVParamsOuter f)
-&gt; Generic (PVParamsOuter f)
forall x. Rep (PVParamsOuter f) x -&gt; PVParamsOuter f
forall x. PVParamsOuter f -&gt; Rep (PVParamsOuter f) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (f :: * -&gt; *) x. Rep (PVParamsOuter f) x -&gt; PVParamsOuter f
forall (f :: * -&gt; *) x. PVParamsOuter f -&gt; Rep (PVParamsOuter f) x
$cfrom :: forall (f :: * -&gt; *) x. PVParamsOuter f -&gt; Rep (PVParamsOuter f) x
from :: forall x. PVParamsOuter f -&gt; Rep (PVParamsOuter f) x
$cto :: forall (f :: * -&gt; *) x. Rep (PVParamsOuter f) x -&gt; PVParamsOuter f
to :: forall x. Rep (PVParamsOuter f) x -&gt; PVParamsOuter f
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span id="local-6989586621679473197"><span id="pDoubleLeft"><span id="pDoubleLeftFreeze"><span id="pDoubleRightSplit"><span id="pSingleFreeze"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">PVParamsOuter</span></span></span></span></span></span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span id="local-6989586621679473220"><span id="local-6989586621679474735"><span id="local-6989586621679474742"><span id="local-6989586621679474746"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679473220"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsOuter"><span class="hs-identifier hs-type">PVParamsOuter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473220"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-202"></span><span id="local-6989586621679473346"><span id="local-6989586621679474752"><span id="local-6989586621679474759"><span id="local-6989586621679474762"><span id="local-6989586621679474765"><span id="local-6989586621679474768"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679473346"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsOuter"><span class="hs-identifier hs-type">PVParamsOuter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473346"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span></span></span></span></span></span><span>
</span><span id="line-203"></span><span id="local-6989586621679473407"><span id="local-6989586621679474892"><span id="local-6989586621679474899"><span id="local-6989586621679474902"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679473407"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsOuter"><span class="hs-identifier hs-type">PVParamsOuter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473407"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span class="annot"><span class="hs-comment">{- | Parameters for decisions about inner operations
 (elaboration and distribution within splits and spreads).
-}</span></span><span>
</span><span id="line-208"></span><span class="hs-keyword">data</span><span> </span><span id="PVParamsInner"><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-var">PVParamsInner</span></a></span></span><span> </span><span id="local-6989586621679473408"><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PVParamsInner"><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-var">PVParamsInner</span></a></span></span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-comment">-- split</span><span>
</span><span id="line-210"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_pElaborateRegular"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pElaborateRegular"><span class="hs-identifier hs-var hs-var">_pElaborateRegular</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pElaborateL"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pElaborateL"><span class="hs-identifier hs-var hs-var">_pElaborateL</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pElaborateR"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pElaborateR"><span class="hs-identifier hs-var hs-var">_pElaborateR</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pRootFifths"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pRootFifths"><span class="hs-identifier hs-var hs-var">_pRootFifths</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pKeepL"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pKeepL"><span class="hs-identifier hs-var hs-var">_pKeepL</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pKeepR"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pKeepR"><span class="hs-identifier hs-var hs-var">_pKeepR</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-216"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pRepeatOverNeighbor"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pRepeatOverNeighbor"><span class="hs-identifier hs-var hs-var">_pRepeatOverNeighbor</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pNBChromatic"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pNBChromatic"><span class="hs-identifier hs-var hs-var">_pNBChromatic</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-218"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pNBAlt"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pNBAlt"><span class="hs-identifier hs-var hs-var">_pNBAlt</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-219"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pRepeatLeftOverRight"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pRepeatLeftOverRight"><span class="hs-identifier hs-var hs-var">_pRepeatLeftOverRight</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pRepeatAlter"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pRepeatAlter"><span class="hs-identifier hs-var hs-var">_pRepeatAlter</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-221"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pRepeatAlterUp"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pRepeatAlterUp"><span class="hs-identifier hs-var hs-var">_pRepeatAlterUp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pRepeatAlterSemis"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pRepeatAlterSemis"><span class="hs-identifier hs-var hs-var">_pRepeatAlterSemis</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-223"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pConnect"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pConnect"><span class="hs-identifier hs-var hs-var">_pConnect</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-224"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pConnectChromaticLeftOverRight"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pConnectChromaticLeftOverRight"><span class="hs-identifier hs-var hs-var">_pConnectChromaticLeftOverRight</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-225"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pPassUp"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pPassUp"><span class="hs-identifier hs-var hs-var">_pPassUp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-226"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pPassLeftOverRight"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pPassLeftOverRight"><span class="hs-identifier hs-var hs-var">_pPassLeftOverRight</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pNewPassingLeft"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pNewPassingLeft"><span class="hs-identifier hs-var hs-var">_pNewPassingLeft</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-228"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pNewPassingRight"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pNewPassingRight"><span class="hs-identifier hs-var hs-var">_pNewPassingRight</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- spread</span><span>
</span><span id="line-230"></span><span>    </span><span id="_pNewPassingMid"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pNewPassingMid"><span class="hs-identifier hs-var hs-var">_pNewPassingMid</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pNoteSpreadDirection"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f (Dirichlet 3)
</span><a href="PVGrammar.Prob.Simple.html#_pNoteSpreadDirection"><span class="hs-identifier hs-var hs-var">_pNoteSpreadDirection</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Dirichlet</span></span><span> </span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pNotesOnOtherSide"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pNotesOnOtherSide"><span class="hs-identifier hs-var hs-var">_pNotesOnOtherSide</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span> </span><span class="hs-comment">-- TODO: remove this, not needed anymore</span><span>
</span><span id="line-233"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pSpreadRepetitionEdge"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pSpreadRepetitionEdge"><span class="hs-identifier hs-var hs-var">_pSpreadRepetitionEdge</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679473408"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-234"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679475008"><span id="local-6989586621679475010"><span class="annot"><span class="annottext">(forall x. PVParamsInner f -&gt; Rep (PVParamsInner f) x)
-&gt; (forall x. Rep (PVParamsInner f) x -&gt; PVParamsInner f)
-&gt; Generic (PVParamsInner f)
forall x. Rep (PVParamsInner f) x -&gt; PVParamsInner f
forall x. PVParamsInner f -&gt; Rep (PVParamsInner f) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (f :: * -&gt; *) x. Rep (PVParamsInner f) x -&gt; PVParamsInner f
forall (f :: * -&gt; *) x. PVParamsInner f -&gt; Rep (PVParamsInner f) x
$cfrom :: forall (f :: * -&gt; *) x. PVParamsInner f -&gt; Rep (PVParamsInner f) x
from :: forall x. PVParamsInner f -&gt; Rep (PVParamsInner f) x
$cto :: forall (f :: * -&gt; *) x. Rep (PVParamsInner f) x -&gt; PVParamsInner f
to :: forall x. Rep (PVParamsInner f) x -&gt; PVParamsInner f
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span>
</span><span id="line-237"></span><span id="local-6989586621679473408"><span id="pConnect"><span id="pConnectChromaticLeftOverRight"><span id="pElaborateL"><span id="pElaborateR"><span id="pElaborateRegular"><span id="pKeepL"><span id="pKeepR"><span id="pNBAlt"><span id="pNBChromatic"><span id="pNewPassingLeft"><span id="pNewPassingMid"><span id="pNewPassingRight"><span id="pNoteSpreadDirection"><span id="pNotesOnOtherSide"><span id="pPassLeftOverRight"><span id="pPassUp"><span id="pRepeatAlter"><span id="pRepeatAlterSemis"><span id="pRepeatAlterUp"><span id="pRepeatLeftOverRight"><span id="pRepeatOverNeighbor"><span id="pRootFifths"><span id="pSpreadRepetitionEdge"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">PVParamsInner</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span id="local-6989586621679473482"><span id="local-6989586621679475659"><span id="local-6989586621679475685"><span id="local-6989586621679475689"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679473482"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679473482"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Dirichlet</span></span><span> </span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473482"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span id="local-6989586621679473484"><span id="local-6989586621679475694"><span id="local-6989586621679475701"><span id="local-6989586621679475704"><span id="local-6989586621679475707"><span id="local-6989586621679475710"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679473484"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679473484"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Dirichlet</span></span><span> </span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473484"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span></span></span></span></span></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span id="local-6989586621679473486"><span id="local-6989586621679476051"><span id="local-6989586621679476058"><span id="local-6989586621679476061"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-252"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679473486"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679473486"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Dirichlet</span></span><span> </span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473486"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span class="annot"><span class="hs-comment">-- | The combined parameters for inner and outer operations.</span></span><span>
</span><span id="line-258"></span><span class="hs-keyword">data</span><span> </span><span id="PVParams"><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-var">PVParams</span></a></span></span><span> </span><span id="local-6989586621679473487"><span class="annot"><a href="#local-6989586621679473487"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PVParams"><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-var">PVParams</span></a></span></span><span>
</span><span id="line-259"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_pOuter"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParams f -&gt; PVParamsOuter f
</span><a href="PVGrammar.Prob.Simple.html#_pOuter"><span class="hs-identifier hs-var hs-var">_pOuter</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsOuter"><span class="hs-identifier hs-type">PVParamsOuter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473487"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-260"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pInner"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParams f -&gt; PVParamsInner f
</span><a href="PVGrammar.Prob.Simple.html#_pInner"><span class="hs-identifier hs-var hs-var">_pInner</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473487"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-261"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-262"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679476284"><span id="local-6989586621679476286"><span class="annot"><span class="annottext">(forall x. PVParams f -&gt; Rep (PVParams f) x)
-&gt; (forall x. Rep (PVParams f) x -&gt; PVParams f)
-&gt; Generic (PVParams f)
forall x. Rep (PVParams f) x -&gt; PVParams f
forall x. PVParams f -&gt; Rep (PVParams f) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (f :: * -&gt; *) x. Rep (PVParams f) x -&gt; PVParams f
forall (f :: * -&gt; *) x. PVParams f -&gt; Rep (PVParams f) x
$cfrom :: forall (f :: * -&gt; *) x. PVParams f -&gt; Rep (PVParams f) x
from :: forall x. PVParams f -&gt; Rep (PVParams f) x
$cto :: forall (f :: * -&gt; *) x. Rep (PVParams f) x -&gt; PVParams f
to :: forall x. Rep (PVParams f) x -&gt; PVParams f
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span id="local-6989586621679473487"><span id="pInner"><span id="pOuter"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">PVParams</span></span></span></span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span id="local-6989586621679473497"><span id="local-6989586621679476305"><span id="local-6989586621679476310"><span id="local-6989586621679476314"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679473497"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679473497"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Dirichlet</span></span><span> </span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473497"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span id="local-6989586621679473178"><span id="local-6989586621679476319"><span id="local-6989586621679476325"><span id="local-6989586621679476328"><span id="local-6989586621679476331"><span id="local-6989586621679476334"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-273"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679473178"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679473178"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Dirichlet</span></span><span> </span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473178"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span></span></span></span></span></span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span id="local-6989586621679473177"><span id="local-6989586621679476400"><span id="local-6989586621679476406"><span id="local-6989586621679476409"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-279"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679473177"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679473177"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Dirichlet</span></span><span> </span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473177"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#savePVHyper"><span class="hs-identifier hs-type">savePVHyper</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hyper</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span id="savePVHyper"><span class="annot"><span class="annottext">savePVHyper :: String -&gt; Hyper PVParams -&gt; IO ()
</span><a href="PVGrammar.Prob.Simple.html#savePVHyper"><span class="hs-identifier hs-var hs-var">savePVHyper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Hyper PVParams -&gt; IO ()
String -&gt; PVParams HyperRep -&gt; IO ()
forall a. ToJSON a =&gt; String -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">encodeFile</span></span><span>
</span><span id="line-286"></span><span>
</span><span id="line-287"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#loadPVHyper"><span class="hs-identifier hs-type">loadPVHyper</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hyper</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-288"></span><span id="loadPVHyper"><span class="annot"><span class="annottext">loadPVHyper :: String -&gt; IO (Either String (Hyper PVParams))
</span><a href="PVGrammar.Prob.Simple.html#loadPVHyper"><span class="hs-identifier hs-var hs-var">loadPVHyper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO (Either String (Hyper PVParams))
String -&gt; IO (Either String (PVParams HyperRep))
forall a. FromJSON a =&gt; String -&gt; IO (Either String a)
</span><span class="hs-identifier hs-var">eitherDecodeFileStrict</span></span><span>
</span><span id="line-289"></span><span>
</span><span id="line-290"></span><span class="hs-keyword">type</span><span> </span><span id="PVProbs"><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVProbs"><span class="hs-identifier hs-var">PVProbs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ProbsRep</span></span><span>
</span><span id="line-291"></span><span class="hs-keyword">type</span><span> </span><span id="PVProbsInner"><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVProbsInner"><span class="hs-identifier hs-var">PVProbsInner</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ProbsRep</span></span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span class="hs-keyword">type</span><span> </span><span id="ContextSingle"><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextSingle"><span class="hs-identifier hs-var">ContextSingle</span></a></span></span><span> </span><span id="local-6989586621679476460"><span class="annot"><a href="#local-6989586621679476460"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#StartStop"><span class="hs-identifier hs-type">StartStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476460"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476460"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#StartStop"><span class="hs-identifier hs-type">StartStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476460"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span class="hs-keyword">type</span><span> </span><span id="ContextDouble"><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextDouble"><span class="hs-identifier hs-var">ContextDouble</span></a></span></span><span> </span><span id="local-6989586621679476461"><span class="annot"><a href="#local-6989586621679476461"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-295"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#StartStop"><span class="hs-identifier hs-type">StartStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476461"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476461"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476461"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476461"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#StartStop"><span class="hs-identifier hs-type">StartStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476461"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="hs-keyword">type</span><span> </span><span id="PVObs"><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-var">PVObs</span></a></span></span><span> </span><span id="local-6989586621679476462"><span class="annot"><a href="#local-6989586621679476462"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Trace</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679476462"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span class="hs-comment">-- helper distributions</span><span>
</span><span id="line-300"></span><span class="hs-comment">-- ====================</span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span class="hs-keyword">data</span><span> </span><span id="MagicalOctaves"><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalOctaves"><span class="hs-identifier hs-var">MagicalOctaves</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MagicalOctaves"><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalOctaves"><span class="hs-identifier hs-var">MagicalOctaves</span></a></span></span><span>
</span><span id="line-303"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679476465"><span id="local-6989586621679476467"><span class="annot"><span class="annottext">MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
(MagicalOctaves -&gt; MagicalOctaves -&gt; Bool)
-&gt; (MagicalOctaves -&gt; MagicalOctaves -&gt; Bool) -&gt; Eq MagicalOctaves
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
== :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
$c/= :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
/= :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476474"><span id="local-6989586621679476476"><span id="local-6989586621679476478"><span id="local-6989586621679476482"><span id="local-6989586621679476485"><span id="local-6989586621679476488"><span id="local-6989586621679476491"><span class="annot"><span class="annottext">Eq MagicalOctaves
Eq MagicalOctaves =&gt;
(MagicalOctaves -&gt; MagicalOctaves -&gt; Ordering)
-&gt; (MagicalOctaves -&gt; MagicalOctaves -&gt; Bool)
-&gt; (MagicalOctaves -&gt; MagicalOctaves -&gt; Bool)
-&gt; (MagicalOctaves -&gt; MagicalOctaves -&gt; Bool)
-&gt; (MagicalOctaves -&gt; MagicalOctaves -&gt; Bool)
-&gt; (MagicalOctaves -&gt; MagicalOctaves -&gt; MagicalOctaves)
-&gt; (MagicalOctaves -&gt; MagicalOctaves -&gt; MagicalOctaves)
-&gt; Ord MagicalOctaves
MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
MagicalOctaves -&gt; MagicalOctaves -&gt; Ordering
MagicalOctaves -&gt; MagicalOctaves -&gt; MagicalOctaves
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
$ccompare :: MagicalOctaves -&gt; MagicalOctaves -&gt; Ordering
compare :: MagicalOctaves -&gt; MagicalOctaves -&gt; Ordering
$c&lt; :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
&lt; :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
$c&lt;= :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
&lt;= :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
$c&gt; :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
&gt; :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
$c&gt;= :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
&gt;= :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
$cmax :: MagicalOctaves -&gt; MagicalOctaves -&gt; MagicalOctaves
max :: MagicalOctaves -&gt; MagicalOctaves -&gt; MagicalOctaves
$cmin :: MagicalOctaves -&gt; MagicalOctaves -&gt; MagicalOctaves
min :: MagicalOctaves -&gt; MagicalOctaves -&gt; MagicalOctaves
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476499"><span id="local-6989586621679476501"><span id="local-6989586621679476505"><span class="annot"><span class="annottext">Int -&gt; MagicalOctaves -&gt; ShowS
[MagicalOctaves] -&gt; ShowS
MagicalOctaves -&gt; String
(Int -&gt; MagicalOctaves -&gt; ShowS)
-&gt; (MagicalOctaves -&gt; String)
-&gt; ([MagicalOctaves] -&gt; ShowS)
-&gt; Show MagicalOctaves
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; MagicalOctaves -&gt; ShowS
showsPrec :: Int -&gt; MagicalOctaves -&gt; ShowS
$cshow :: MagicalOctaves -&gt; String
show :: MagicalOctaves -&gt; String
$cshowList :: [MagicalOctaves] -&gt; ShowS
showList :: [MagicalOctaves] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Distribution</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalOctaves"><span class="hs-identifier hs-type">MagicalOctaves</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-306"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="Params"><span class="annot"><span class="hs-identifier hs-var">Params</span></span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalOctaves"><span class="hs-identifier hs-type">MagicalOctaves</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="Support"><span class="annot"><span class="hs-identifier hs-var">Support</span></span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalOctaves"><span class="hs-identifier hs-type">MagicalOctaves</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-308"></span><span>  </span><span id="local-6989586621679476528"><span class="annot"><span class="annottext">distSample :: forall (m :: * -&gt; *).
PrimMonad m =&gt;
MagicalOctaves
-&gt; Params MagicalOctaves -&gt; Prob m (Support MagicalOctaves)
</span><a href="#local-6989586621679476528"><span class="hs-identifier hs-var hs-var hs-var">distSample</span></a></span></span><span> </span><span class="annot"><span class="annottext">MagicalOctaves
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Params MagicalOctaves
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`subtract`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; Prob m Int -&gt; Prob m Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Double] -&gt; Prob m Int
forall (f :: * -&gt; *) (m :: * -&gt; *).
(Foldable f, PrimMonad m) =&gt;
f Double -&gt; Prob m Int
</span><span class="hs-identifier hs-var">categorical</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.2</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.4</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.2</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.1</span></span><span class="hs-special">]</span><span>
</span><span id="line-309"></span><span>  </span><span id="local-6989586621679476532"><span class="annot"><span class="annottext">distLogP :: MagicalOctaves
-&gt; Params MagicalOctaves -&gt; Support MagicalOctaves -&gt; Double
</span><a href="#local-6989586621679476532"><span class="hs-identifier hs-var hs-var hs-var">distLogP</span></a></span></span><span> </span><span class="annot"><span class="annottext">MagicalOctaves
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Params MagicalOctaves
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Support MagicalOctaves
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0</span></span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span class="hs-keyword">data</span><span> </span><span id="MagicalID"><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalID"><span class="hs-identifier hs-var">MagicalID</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MagicalID"><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalID"><span class="hs-identifier hs-var">MagicalID</span></a></span></span><span>
</span><span id="line-312"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679476536"><span id="local-6989586621679476538"><span class="annot"><span class="annottext">MagicalID -&gt; MagicalID -&gt; Bool
(MagicalID -&gt; MagicalID -&gt; Bool)
-&gt; (MagicalID -&gt; MagicalID -&gt; Bool) -&gt; Eq MagicalID
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: MagicalID -&gt; MagicalID -&gt; Bool
== :: MagicalID -&gt; MagicalID -&gt; Bool
$c/= :: MagicalID -&gt; MagicalID -&gt; Bool
/= :: MagicalID -&gt; MagicalID -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476544"><span id="local-6989586621679476546"><span id="local-6989586621679476548"><span id="local-6989586621679476552"><span id="local-6989586621679476555"><span id="local-6989586621679476558"><span id="local-6989586621679476561"><span class="annot"><span class="annottext">Eq MagicalID
Eq MagicalID =&gt;
(MagicalID -&gt; MagicalID -&gt; Ordering)
-&gt; (MagicalID -&gt; MagicalID -&gt; Bool)
-&gt; (MagicalID -&gt; MagicalID -&gt; Bool)
-&gt; (MagicalID -&gt; MagicalID -&gt; Bool)
-&gt; (MagicalID -&gt; MagicalID -&gt; Bool)
-&gt; (MagicalID -&gt; MagicalID -&gt; MagicalID)
-&gt; (MagicalID -&gt; MagicalID -&gt; MagicalID)
-&gt; Ord MagicalID
MagicalID -&gt; MagicalID -&gt; Bool
MagicalID -&gt; MagicalID -&gt; Ordering
MagicalID -&gt; MagicalID -&gt; MagicalID
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
$ccompare :: MagicalID -&gt; MagicalID -&gt; Ordering
compare :: MagicalID -&gt; MagicalID -&gt; Ordering
$c&lt; :: MagicalID -&gt; MagicalID -&gt; Bool
&lt; :: MagicalID -&gt; MagicalID -&gt; Bool
$c&lt;= :: MagicalID -&gt; MagicalID -&gt; Bool
&lt;= :: MagicalID -&gt; MagicalID -&gt; Bool
$c&gt; :: MagicalID -&gt; MagicalID -&gt; Bool
&gt; :: MagicalID -&gt; MagicalID -&gt; Bool
$c&gt;= :: MagicalID -&gt; MagicalID -&gt; Bool
&gt;= :: MagicalID -&gt; MagicalID -&gt; Bool
$cmax :: MagicalID -&gt; MagicalID -&gt; MagicalID
max :: MagicalID -&gt; MagicalID -&gt; MagicalID
$cmin :: MagicalID -&gt; MagicalID -&gt; MagicalID
min :: MagicalID -&gt; MagicalID -&gt; MagicalID
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476564"><span id="local-6989586621679476566"><span id="local-6989586621679476570"><span class="annot"><span class="annottext">Int -&gt; MagicalID -&gt; ShowS
[MagicalID] -&gt; ShowS
MagicalID -&gt; String
(Int -&gt; MagicalID -&gt; ShowS)
-&gt; (MagicalID -&gt; String)
-&gt; ([MagicalID] -&gt; ShowS)
-&gt; Show MagicalID
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; MagicalID -&gt; ShowS
showsPrec :: Int -&gt; MagicalID -&gt; ShowS
$cshow :: MagicalID -&gt; String
show :: MagicalID -&gt; String
$cshowList :: [MagicalID] -&gt; ShowS
showList :: [MagicalID] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Distribution</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalID"><span class="hs-identifier hs-type">MagicalID</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-315"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="Params"><span class="annot"><span class="hs-identifier hs-var">Params</span></span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalID"><span class="hs-identifier hs-type">MagicalID</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-316"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="Support"><span class="annot"><span class="hs-identifier hs-var">Support</span></span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalID"><span class="hs-identifier hs-type">MagicalID</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-317"></span><span>  </span><span id="local-6989586621679476585"><span class="annot"><span class="annottext">distSample :: forall (m :: * -&gt; *).
PrimMonad m =&gt;
MagicalID -&gt; Params MagicalID -&gt; Prob m (Support MagicalID)
</span><span class="hs-identifier hs-var hs-var hs-var">distSample</span></span></span><span> </span><span class="annot"><span class="annottext">MagicalID
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Params MagicalID
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-318"></span><span>    </span><span id="local-6989586621679476586"><span class="annot"><a href="#local-6989586621679476586"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. (PrimMonad m, Variate a) =&gt; Prob m a
</span><span class="hs-identifier hs-var">uniform</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-319"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;id&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">show</span></span><span> </span><span class="annot"><a href="#local-6989586621679476586"><span class="hs-identifier hs-type">i</span></a></span><span>
</span><span id="line-320"></span><span>  </span><span id="local-6989586621679476588"><span class="annot"><span class="annottext">distLogP :: MagicalID -&gt; Params MagicalID -&gt; Support MagicalID -&gt; Double
</span><span class="hs-identifier hs-var hs-var hs-var">distLogP</span></span></span><span> </span><span class="annot"><span class="annottext">MagicalID
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Params MagicalID
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Support MagicalID
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0</span></span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span class="annot"><span class="hs-comment">{- | A helper function that tests whether 'observeDerivation''
 followed by 'sampleDerivation'' restores the original derivation.
 Useful for testing the compatibility of the two functions.
-}</span></span><span>
</span><span id="line-326"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#roundtrip"><span class="hs-identifier hs-type">roundtrip</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- [PVLeftmost SPitch])</span><span>
</span><span id="line-327"></span><span id="roundtrip"><span class="annot"><span class="annottext">roundtrip :: String -&gt; IO (Either String ())
</span><a href="PVGrammar.Prob.Simple.html#roundtrip"><span class="hs-identifier hs-var hs-var">roundtrip</span></a></span></span><span> </span><span id="local-6989586621679476589"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679476589"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>  </span><span id="local-6989586621679476590"><span class="annot"><a href="#local-6989586621679476590"><span class="hs-identifier hs-var">anaE</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO (Either String (PVAnalysis SPitch))
</span><a href="PVGrammar.html#loadAnalysis"><span class="hs-identifier hs-var">loadAnalysis</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679476589"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-329"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679476590"><span class="hs-identifier hs-type">anaE</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-330"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679476592"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679476592"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO (Either String ())
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679476592"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-331"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679476594"><span class="annot"><span class="annottext">PVAnalysis SPitch
</span><a href="#local-6989586621679476594"><span class="hs-identifier hs-var">ana</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-332"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679476595"><span class="annot"><span class="annottext">traceE :: Either String (Trace PVParams)
</span><a href="#local-6989586621679476595"><span class="hs-identifier hs-var hs-var">traceE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch] -&gt; Either String (Trace PVParams)
</span><a href="PVGrammar.Prob.Simple.html#observeDerivation%27"><span class="hs-identifier hs-var">observeDerivation'</span></a></span><span> </span><span class="annot"><span class="annottext">([PVLeftmost SPitch] -&gt; Either String (Trace PVParams))
-&gt; [PVLeftmost SPitch] -&gt; Either String (Trace PVParams)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PVAnalysis SPitch -&gt; [PVLeftmost SPitch]
forall s f h tr slc. Analysis s f h tr slc -&gt; [Leftmost s f h]
</span><a href="Common.html#anaDerivation"><span class="hs-identifier hs-var">anaDerivation</span></a></span><span> </span><span class="annot"><span class="annottext">PVAnalysis SPitch
</span><a href="#local-6989586621679476594"><span class="hs-identifier hs-var">ana</span></a></span><span>
</span><span id="line-333"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either String (Trace PVParams)
</span><a href="#local-6989586621679476595"><span class="hs-identifier hs-var">traceE</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-334"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679476596"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679476596"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO (Either String ())
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679476596"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-335"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679476597"><span class="annot"><span class="annottext">Trace PVParams
</span><a href="#local-6989586621679476597"><span class="hs-identifier hs-var">trace</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-336"></span><span>          </span><span class="annot"><span class="annottext">Trace PVParams -&gt; IO ()
forall a. Show a =&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">print</span></span><span> </span><span class="annot"><span class="annottext">Trace PVParams
</span><a href="#local-6989586621679476597"><span class="hs-identifier hs-var">trace</span></a></span><span>
</span><span id="line-337"></span><span>          </span><span class="annot"><span class="annottext">Either String () -&gt; IO (Either String ())
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either String () -&gt; IO (Either String ()))
-&gt; Either String () -&gt; IO (Either String ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; [PVLeftmost SPitch] -&gt; ()
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([PVLeftmost SPitch] -&gt; ())
-&gt; Either String [PVLeftmost SPitch] -&gt; Either String ()
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Trace PVParams
-&gt; TraceTraceI PVParams (Either String [PVLeftmost SPitch])
-&gt; Either String [PVLeftmost SPitch]
forall (r :: (* -&gt; *) -&gt; *) a. Trace r -&gt; TraceTraceI r a -&gt; a
</span><span class="hs-identifier hs-var">traceTrace</span></span><span> </span><span class="annot"><span class="annottext">Trace PVParams
</span><a href="#local-6989586621679476597"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">TraceTraceI PVParams (Either String [PVLeftmost SPitch])
forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m Geometric1,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 SampleCtx m MagicalID, SampleCtx m (Categorical 3),
 RandomInterpreter m PVParams) =&gt;
m (Either String [PVLeftmost SPitch])
</span><a href="PVGrammar.Prob.Simple.html#sampleDerivation%27"><span class="hs-identifier hs-var">sampleDerivation'</span></a></span><span>
</span><span id="line-338"></span><span>
</span><span id="line-339"></span><span class="annot"><span class="hs-comment">{- | Helper function: Load a single derivation
 and infer the corresponding posterior for a uniform prior.
-}</span></span><span>
</span><span id="line-342"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#trainSinglePiece"><span class="hs-identifier hs-type">trainSinglePiece</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HyperRep</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span id="trainSinglePiece"><span class="annot"><span class="annottext">trainSinglePiece :: String -&gt; IO (Maybe (PVParams HyperRep))
</span><a href="PVGrammar.Prob.Simple.html#trainSinglePiece"><span class="hs-identifier hs-var hs-var">trainSinglePiece</span></a></span></span><span> </span><span id="local-6989586621679476599"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679476599"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-344"></span><span>  </span><span id="local-6989586621679476600"><span class="annot"><a href="#local-6989586621679476600"><span class="hs-identifier hs-var">anaE</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO (Either String (PVAnalysis SPitch))
</span><a href="PVGrammar.html#loadAnalysis"><span class="hs-identifier hs-var">loadAnalysis</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679476599"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-345"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679476600"><span class="hs-identifier hs-type">anaE</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-346"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679476601"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679476601"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO (Maybe (PVParams HyperRep))
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679476601"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-347"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679476602"><span class="annot"><span class="annottext">PVAnalysis SPitch
</span><a href="#local-6989586621679476602"><span class="hs-identifier hs-var">ana</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-348"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679476603"><span class="annot"><span class="annottext">traceE :: Either String (Trace PVParams)
</span><a href="#local-6989586621679476603"><span class="hs-identifier hs-var hs-var">traceE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch] -&gt; Either String (Trace PVParams)
</span><a href="PVGrammar.Prob.Simple.html#observeDerivation%27"><span class="hs-identifier hs-var">observeDerivation'</span></a></span><span> </span><span class="annot"><span class="annottext">([PVLeftmost SPitch] -&gt; Either String (Trace PVParams))
-&gt; [PVLeftmost SPitch] -&gt; Either String (Trace PVParams)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PVAnalysis SPitch -&gt; [PVLeftmost SPitch]
forall s f h tr slc. Analysis s f h tr slc -&gt; [Leftmost s f h]
</span><a href="Common.html#anaDerivation"><span class="hs-identifier hs-var">anaDerivation</span></a></span><span> </span><span class="annot"><span class="annottext">PVAnalysis SPitch
</span><a href="#local-6989586621679476602"><span class="hs-identifier hs-var">ana</span></a></span><span>
</span><span id="line-349"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either String (Trace PVParams)
</span><a href="#local-6989586621679476603"><span class="hs-identifier hs-var">traceE</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-350"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679476604"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679476604"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO (Maybe (PVParams HyperRep))
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679476604"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-351"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679476605"><span class="annot"><span class="annottext">Trace PVParams
</span><a href="#local-6989586621679476605"><span class="hs-identifier hs-var">trace</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-352"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679476694"><span class="annot"><span class="annottext">prior :: Hyper PVParams
</span><a href="#local-6989586621679476694"><span class="hs-identifier hs-var hs-var">prior</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {k} (a :: k). Uniform a =&gt; Hyper a
forall (a :: (* -&gt; *) -&gt; *). Uniform a =&gt; Hyper a
</span><span class="hs-identifier hs-var">uniformPrior</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span>
</span><span id="line-353"></span><span>          </span><span class="annot"><span class="annottext">Maybe (PVParams HyperRep) -&gt; IO (Maybe (PVParams HyperRep))
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (PVParams HyperRep) -&gt; IO (Maybe (PVParams HyperRep)))
-&gt; Maybe (PVParams HyperRep) -&gt; IO (Maybe (PVParams HyperRep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PVParams HyperRep
-&gt; Trace PVParams
-&gt; UpdatePriorsI PVParams (Either String [PVLeftmost SPitch])
-&gt; Maybe (PVParams HyperRep)
forall (r :: (* -&gt; *) -&gt; *) a.
r HyperRep -&gt; Trace r -&gt; UpdatePriorsI r a -&gt; Maybe (r HyperRep)
</span><span class="hs-identifier hs-var">getPosterior</span></span><span> </span><span class="annot"><span class="annottext">PVParams HyperRep
</span><a href="#local-6989586621679476694"><span class="hs-identifier hs-var">prior</span></a></span><span> </span><span class="annot"><span class="annottext">Trace PVParams
</span><a href="#local-6989586621679476605"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
-&gt; UpdatePriorsI PVParams (Either String [PVLeftmost SPitch])
forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m Geometric1,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 SampleCtx m MagicalID, SampleCtx m (Categorical 3),
 RandomInterpreter m PVParams) =&gt;
Path (Edges SPitch) (Notes SPitch)
-&gt; m (Either String [PVLeftmost SPitch])
</span><a href="PVGrammar.Prob.Simple.html#sampleDerivation"><span class="hs-identifier hs-var">sampleDerivation</span></a></span><span> </span><span class="annot"><span class="annottext">(Path (Edges SPitch) (Notes SPitch)
 -&gt; UpdatePriorsI PVParams (Either String [PVLeftmost SPitch]))
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; UpdatePriorsI PVParams (Either String [PVLeftmost SPitch])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PVAnalysis SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
forall s f h tr slc. Analysis s f h tr slc -&gt; Path tr slc
</span><a href="Common.html#anaTop"><span class="hs-identifier hs-var">anaTop</span></a></span><span> </span><span class="annot"><span class="annottext">PVAnalysis SPitch
</span><a href="#local-6989586621679476602"><span class="hs-identifier hs-var">ana</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-354"></span><span>
</span><span id="line-355"></span><span class="hs-comment">-- the generative process</span><span>
</span><span id="line-356"></span><span class="hs-comment">-- ======================</span><span>
</span><span id="line-357"></span><span>
</span><span id="line-358"></span><span class="annot"><span class="hs-comment">-- | A shorthand for 'sampleDerivation' starting from &#8906;&#8212;&#8212;&#8905;.</span></span><span>
</span><span id="line-359"></span><span id="local-6989586621679476695"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleDerivation%27"><span class="hs-identifier hs-type">sampleDerivation'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679476695"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#PVLeftmost"><span class="hs-identifier hs-type">PVLeftmost</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-360"></span><span id="sampleDerivation%27"><span class="annot"><span class="annottext">sampleDerivation' :: m (Either String [PVLeftmost SPitch])
</span><a href="PVGrammar.Prob.Simple.html#sampleDerivation%27"><span class="hs-identifier hs-var hs-var">sampleDerivation'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
-&gt; m (Either String [PVLeftmost SPitch])
forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m Geometric1,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 SampleCtx m MagicalID, SampleCtx m (Categorical 3),
 RandomInterpreter m PVParams) =&gt;
Path (Edges SPitch) (Notes SPitch)
-&gt; m (Either String [PVLeftmost SPitch])
</span><a href="PVGrammar.Prob.Simple.html#sampleDerivation"><span class="hs-identifier hs-var">sampleDerivation</span></a></span><span> </span><span class="annot"><span class="annottext">(Path (Edges SPitch) (Notes SPitch)
 -&gt; m (Either String [PVLeftmost SPitch]))
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; m (Either String [PVLeftmost SPitch])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
forall around between. around -&gt; Path around between
</span><a href="Common.html#PathEnd"><span class="hs-identifier hs-var">PathEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
forall n. Hashable n =&gt; Edges n
</span><a href="PVGrammar.html#topEdges"><span class="hs-identifier hs-var">topEdges</span></a></span><span>
</span><span id="line-361"></span><span>
</span><span id="line-362"></span><span class="annot"><span class="hs-comment">-- | A shorthand for 'observeDerivation' starting from &#8906;&#8212;&#8212;&#8905;.</span></span><span>
</span><span id="line-363"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeDerivation%27"><span class="hs-identifier hs-type">observeDerivation'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#PVLeftmost"><span class="hs-identifier hs-type">PVLeftmost</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Trace</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-364"></span><span id="observeDerivation%27"><span class="annot"><span class="annottext">observeDerivation' :: [PVLeftmost SPitch] -&gt; Either String (Trace PVParams)
</span><a href="PVGrammar.Prob.Simple.html#observeDerivation%27"><span class="hs-identifier hs-var hs-var">observeDerivation'</span></a></span></span><span> </span><span id="local-6989586621679476721"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679476721"><span class="hs-identifier hs-var">deriv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Either String (Trace PVParams)
</span><a href="PVGrammar.Prob.Simple.html#observeDerivation"><span class="hs-identifier hs-var">observeDerivation</span></a></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679476721"><span class="hs-identifier hs-var">deriv</span></a></span><span> </span><span class="annot"><span class="annottext">(Path (Edges SPitch) (Notes SPitch)
 -&gt; Either String (Trace PVParams))
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Either String (Trace PVParams)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
forall around between. around -&gt; Path around between
</span><a href="Common.html#PathEnd"><span class="hs-identifier hs-var">PathEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
forall n. Hashable n =&gt; Edges n
</span><a href="PVGrammar.html#topEdges"><span class="hs-identifier hs-var">topEdges</span></a></span><span>
</span><span id="line-365"></span><span>
</span><span id="line-366"></span><span class="annot"><span class="hs-comment">{- | A probabilistic program that samples a derivation starting from a given root path.
 Can be interpreted by the interpreter functions in &quot;Inference.Conjugate&quot;.
-}</span></span><span>
</span><span id="line-369"></span><span id="local-6989586621679476722"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleDerivation"><span class="hs-identifier hs-type">sampleDerivation</span></a></span><span>
</span><span id="line-370"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ root path</span></span><span>
</span><span id="line-373"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679476722"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#PVLeftmost"><span class="hs-identifier hs-type">PVLeftmost</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-374"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ a probabilistic program</span></span><span>
</span><span id="line-375"></span><span id="sampleDerivation"><span class="annot"><span class="annottext">sampleDerivation :: Path (Edges SPitch) (Notes SPitch)
-&gt; m (Either String [PVLeftmost SPitch])
</span><a href="PVGrammar.Prob.Simple.html#sampleDerivation"><span class="hs-identifier hs-var hs-var">sampleDerivation</span></a></span></span><span> </span><span id="local-6989586621679476743"><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679476743"><span class="hs-identifier hs-var">top</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT String m [PVLeftmost SPitch]
-&gt; m (Either String [PVLeftmost SPitch])
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT String m [PVLeftmost SPitch]
 -&gt; m (Either String [PVLeftmost SPitch]))
-&gt; ExceptT String m [PVLeftmost SPitch]
-&gt; m (Either String [PVLeftmost SPitch])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; ExceptT String m [PVLeftmost SPitch]
forall {m :: * -&gt; *}.
(SampleCtx m Bernoulli, SampleCtx m Geometric1,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 SampleCtx m MagicalID, SampleCtx m (Categorical 3),
 RandomInterpreter m PVParams) =&gt;
StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; ExceptT String m [PVLeftmost SPitch]
</span><a href="#local-6989586621679476744"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
forall a. StartStop a
</span><a href="Common.html#Start"><span class="hs-identifier hs-var">Start</span></a></span><span> </span><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679476743"><span class="hs-identifier hs-var">top</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-376"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-377"></span><span>  </span><span id="local-6989586621679476744"><span class="annot"><span class="annottext">go :: StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; ExceptT String m [PVLeftmost SPitch]
</span><a href="#local-6989586621679476744"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679476818"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476818"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span id="local-6989586621679476819"><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679476819"><span class="hs-identifier hs-var">surface</span></a></span></span><span> </span><span id="local-6989586621679476820"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679476820"><span class="hs-identifier hs-var">ars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679476819"><span class="hs-identifier hs-var">surface</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-378"></span><span>    </span><span class="hs-comment">-- 1 trans left:</span><span>
</span><span id="line-379"></span><span>    </span><span class="annot"><a href="Common.html#PathEnd"><span class="hs-identifier hs-type">PathEnd</span></a></span><span> </span><span id="local-6989586621679476821"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476821"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-380"></span><span>      </span><span id="local-6989586621679476822"><span class="annot"><a href="#local-6989586621679476822"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (LeftmostSingle (Split SPitch) (Freeze SPitch))
-&gt; ExceptT String m (LeftmostSingle (Split SPitch) (Freeze SPitch))
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT String m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m (LeftmostSingle (Split SPitch) (Freeze SPitch))
 -&gt; ExceptT
      String m (LeftmostSingle (Split SPitch) (Freeze SPitch)))
-&gt; m (LeftmostSingle (Split SPitch) (Freeze SPitch))
-&gt; ExceptT String m (LeftmostSingle (Split SPitch) (Freeze SPitch))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch
-&gt; m (LeftmostSingle (Split SPitch) (Freeze SPitch))
forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m Geometric1,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 SampleCtx m MagicalID, RandomInterpreter m PVParams) =&gt;
ContextSingle SPitch
-&gt; m (LeftmostSingle (Split SPitch) (Freeze SPitch))
</span><a href="PVGrammar.Prob.Simple.html#sampleSingleStep"><span class="hs-identifier hs-var">sampleSingleStep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476818"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476821"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
forall a. StartStop a
</span><a href="Common.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-381"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679476822"><span class="hs-identifier hs-type">step</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-382"></span><span>        </span><span class="annot"><a href="Common.html#LMSingleSplit"><span class="hs-identifier hs-type">LMSingleSplit</span></a></span><span> </span><span id="local-6989586621679476826"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679476826"><span class="hs-identifier hs-var">splitOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-383"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679476827"><span class="annot"><a href="#local-6989586621679476827"><span class="hs-identifier hs-var">ctl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476828"><span class="annot"><a href="#local-6989586621679476828"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476829"><span class="annot"><a href="#local-6989586621679476829"><span class="hs-identifier hs-var">ctr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either String (Edges SPitch, Notes SPitch, Edges SPitch)
-&gt; ExceptT String m (Edges SPitch, Notes SPitch, Edges SPitch)
forall (m :: * -&gt; *) e a. Monad m =&gt; Either e a -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">except</span></span><span> </span><span class="annot"><span class="annottext">(Either String (Edges SPitch, Notes SPitch, Edges SPitch)
 -&gt; ExceptT String m (Edges SPitch, Notes SPitch, Edges SPitch))
-&gt; Either String (Edges SPitch, Notes SPitch, Edges SPitch)
-&gt; ExceptT String m (Edges SPitch, Notes SPitch, Edges SPitch)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Split SPitch
-&gt; Edges SPitch
-&gt; Either String (Edges SPitch, Notes SPitch, Edges SPitch)
forall n.
(Ord n, Notation n, Hashable n) =&gt;
Split n -&gt; Edges n -&gt; Either String (Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier hs-var">applySplit</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679476826"><span class="hs-identifier hs-var">splitOp</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476821"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-384"></span><span>          </span><span id="local-6989586621679476830"><span class="annot"><a href="#local-6989586621679476830"><span class="hs-identifier hs-var">nextSteps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679476744"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476818"><span class="hs-identifier hs-type">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476827"><span class="hs-identifier hs-type">ctl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476828"><span class="hs-identifier hs-type">cs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#PathEnd"><span class="hs-identifier hs-type">PathEnd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476829"><span class="hs-identifier hs-type">ctr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>
</span><span id="line-385"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Common.html#LMSplitOnly"><span class="hs-identifier hs-type">LMSplitOnly</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476826"><span class="hs-identifier hs-type">splitOp</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621679476830"><span class="hs-identifier hs-type">nextSteps</span></a></span><span>
</span><span id="line-386"></span><span>        </span><span class="annot"><a href="Common.html#LMSingleFreeze"><span class="hs-identifier hs-type">LMSingleFreeze</span></a></span><span> </span><span id="local-6989586621679476834"><span class="annot"><span class="annottext">Freeze SPitch
</span><a href="#local-6989586621679476834"><span class="hs-identifier hs-var">freezeOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch] -&gt; ExceptT String m [PVLeftmost SPitch]
forall a. a -&gt; ExceptT String m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Freeze SPitch -&gt; PVLeftmost SPitch
forall f s h. f -&gt; Leftmost s f h
</span><a href="Common.html#LMFreezeOnly"><span class="hs-identifier hs-var">LMFreezeOnly</span></a></span><span> </span><span class="annot"><span class="annottext">Freeze SPitch
</span><a href="#local-6989586621679476834"><span class="hs-identifier hs-var">freezeOp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-comment">-- 2 trans left</span><span>
</span><span id="line-388"></span><span>    </span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span id="local-6989586621679476836"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476836"><span class="hs-identifier hs-var">tl</span></a></span></span><span> </span><span id="local-6989586621679476837"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476837"><span class="hs-identifier hs-var">sm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#PathEnd"><span class="hs-identifier hs-type">PathEnd</span></a></span><span> </span><span id="local-6989586621679476838"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476838"><span class="hs-identifier hs-var">tr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Edges SPitch
-&gt; Notes SPitch
-&gt; Edges SPitch
-&gt; StartStop (Notes SPitch)
-&gt; Bool
-&gt; (Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch))
-&gt; ExceptT String m [PVLeftmost SPitch]
</span><a href="#local-6989586621679476839"><span class="hs-identifier hs-var">goDouble</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476818"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476836"><span class="hs-identifier hs-var">tl</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476837"><span class="hs-identifier hs-var">sm</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476838"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
forall a. StartStop a
</span><a href="Common.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679476820"><span class="hs-identifier hs-var">ars</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
forall around between. around -&gt; Path around between
</span><a href="Common.html#PathEnd"><span class="hs-identifier hs-var">PathEnd</span></a></span><span>
</span><span id="line-389"></span><span>    </span><span class="hs-comment">-- 3 or more trans left</span><span>
</span><span id="line-390"></span><span>    </span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span id="local-6989586621679476840"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476840"><span class="hs-identifier hs-var">tl</span></a></span></span><span> </span><span id="local-6989586621679476841"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476841"><span class="hs-identifier hs-var">sm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span id="local-6989586621679476842"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476842"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span id="local-6989586621679476843"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476843"><span class="hs-identifier hs-var">sr</span></a></span></span><span> </span><span id="local-6989586621679476844"><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679476844"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-391"></span><span>      </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Edges SPitch
-&gt; Notes SPitch
-&gt; Edges SPitch
-&gt; StartStop (Notes SPitch)
-&gt; Bool
-&gt; (Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch))
-&gt; ExceptT String m [PVLeftmost SPitch]
</span><a href="#local-6989586621679476839"><span class="hs-identifier hs-var">goDouble</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476818"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476840"><span class="hs-identifier hs-var">tl</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476841"><span class="hs-identifier hs-var">sm</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476842"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Notes SPitch -&gt; StartStop (Notes SPitch)
forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476843"><span class="hs-identifier hs-var">sr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679476820"><span class="hs-identifier hs-var">ars</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679476846"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476846"><span class="hs-identifier hs-var">tr'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
-&gt; Notes SPitch
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476846"><span class="hs-identifier hs-var">tr'</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476843"><span class="hs-identifier hs-var">sr</span></a></span><span> </span><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679476844"><span class="hs-identifier hs-var">rest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-comment">-- helper for the two cases of 2+ edges (2 and 3+):</span><span>
</span><span id="line-394"></span><span>  </span><span id="local-6989586621679476839"><span class="annot"><span class="annottext">goDouble :: StartStop (Notes SPitch)
-&gt; Edges SPitch
-&gt; Notes SPitch
-&gt; Edges SPitch
-&gt; StartStop (Notes SPitch)
-&gt; Bool
-&gt; (Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch))
-&gt; ExceptT String m [PVLeftmost SPitch]
</span><a href="#local-6989586621679476839"><span class="hs-identifier hs-var hs-var">goDouble</span></a></span></span><span> </span><span id="local-6989586621679476847"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476847"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span id="local-6989586621679476848"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476848"><span class="hs-identifier hs-var">tl</span></a></span></span><span> </span><span id="local-6989586621679476849"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476849"><span class="hs-identifier hs-var">sm</span></a></span></span><span> </span><span id="local-6989586621679476850"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476850"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span id="local-6989586621679476851"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476851"><span class="hs-identifier hs-var">sr</span></a></span></span><span> </span><span id="local-6989586621679476852"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679476852"><span class="hs-identifier hs-var">ars</span></a></span></span><span> </span><span id="local-6989586621679476853"><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679476853"><span class="hs-identifier hs-var">mkrest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-395"></span><span>    </span><span id="local-6989586621679476854"><span class="annot"><a href="#local-6989586621679476854"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch))
-&gt; ExceptT
     String
     m
     (LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch))
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT String m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m (LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch))
 -&gt; ExceptT
      String
      m
      (LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)))
-&gt; m (LeftmostDouble
        (Split SPitch) (Freeze SPitch) (Spread SPitch))
-&gt; ExceptT
     String
     m
     (LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ContextDouble SPitch
-&gt; Bool
-&gt; m (LeftmostDouble
        (Split SPitch) (Freeze SPitch) (Spread SPitch))
forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m Geometric1,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 SampleCtx m MagicalID, SampleCtx m (Categorical 3),
 RandomInterpreter m PVParams) =&gt;
ContextDouble SPitch
-&gt; Bool
-&gt; m (LeftmostDouble
        (Split SPitch) (Freeze SPitch) (Spread SPitch))
</span><a href="PVGrammar.Prob.Simple.html#sampleDoubleStep"><span class="hs-identifier hs-var">sampleDoubleStep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476847"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476848"><span class="hs-identifier hs-var">tl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476849"><span class="hs-identifier hs-var">sm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476850"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476851"><span class="hs-identifier hs-var">sr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679476852"><span class="hs-identifier hs-var">ars</span></a></span><span>
</span><span id="line-396"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679476854"><span class="hs-identifier hs-type">step</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-397"></span><span>      </span><span class="annot"><a href="Common.html#LMDoubleSplitLeft"><span class="hs-identifier hs-type">LMDoubleSplitLeft</span></a></span><span> </span><span id="local-6989586621679476857"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679476857"><span class="hs-identifier hs-var">splitOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-398"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679476858"><span class="annot"><a href="#local-6989586621679476858"><span class="hs-identifier hs-var">ctl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476859"><span class="annot"><a href="#local-6989586621679476859"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476860"><span class="annot"><a href="#local-6989586621679476860"><span class="hs-identifier hs-var">ctr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either String (Edges SPitch, Notes SPitch, Edges SPitch)
-&gt; ExceptT String m (Edges SPitch, Notes SPitch, Edges SPitch)
forall (m :: * -&gt; *) e a. Monad m =&gt; Either e a -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">except</span></span><span> </span><span class="annot"><span class="annottext">(Either String (Edges SPitch, Notes SPitch, Edges SPitch)
 -&gt; ExceptT String m (Edges SPitch, Notes SPitch, Edges SPitch))
-&gt; Either String (Edges SPitch, Notes SPitch, Edges SPitch)
-&gt; ExceptT String m (Edges SPitch, Notes SPitch, Edges SPitch)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Split SPitch
-&gt; Edges SPitch
-&gt; Either String (Edges SPitch, Notes SPitch, Edges SPitch)
forall n.
(Ord n, Notation n, Hashable n) =&gt;
Split n -&gt; Edges n -&gt; Either String (Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier hs-var">applySplit</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679476857"><span class="hs-identifier hs-var">splitOp</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476848"><span class="hs-identifier hs-var">tl</span></a></span><span>
</span><span id="line-399"></span><span>        </span><span id="local-6989586621679476861"><span class="annot"><a href="#local-6989586621679476861"><span class="hs-identifier hs-var">nextSteps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679476744"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476847"><span class="hs-identifier hs-type">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476858"><span class="hs-identifier hs-type">ctl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476859"><span class="hs-identifier hs-type">cs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476860"><span class="hs-identifier hs-type">ctr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476849"><span class="hs-identifier hs-type">sm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679476853"><span class="hs-identifier hs-type">mkrest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476850"><span class="hs-identifier hs-type">tr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>
</span><span id="line-400"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Common.html#LMSplitLeft"><span class="hs-identifier hs-type">LMSplitLeft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476857"><span class="hs-identifier hs-type">splitOp</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621679476861"><span class="hs-identifier hs-type">nextSteps</span></a></span><span>
</span><span id="line-401"></span><span>      </span><span class="annot"><a href="Common.html#LMDoubleFreezeLeft"><span class="hs-identifier hs-type">LMDoubleFreezeLeft</span></a></span><span> </span><span id="local-6989586621679476864"><span class="annot"><span class="annottext">Freeze SPitch
</span><a href="#local-6989586621679476864"><span class="hs-identifier hs-var">freezeOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-402"></span><span>        </span><span id="local-6989586621679476865"><span class="annot"><a href="#local-6989586621679476865"><span class="hs-identifier hs-var">nextSteps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; ExceptT String m [PVLeftmost SPitch]
</span><a href="#local-6989586621679476744"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Notes SPitch -&gt; StartStop (Notes SPitch)
forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476849"><span class="hs-identifier hs-var">sm</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679476853"><span class="hs-identifier hs-var">mkrest</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476850"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-403"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Common.html#LMFreezeLeft"><span class="hs-identifier hs-type">LMFreezeLeft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476864"><span class="hs-identifier hs-type">freezeOp</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621679476865"><span class="hs-identifier hs-type">nextSteps</span></a></span><span>
</span><span id="line-404"></span><span>      </span><span class="annot"><a href="Common.html#LMDoubleSplitRight"><span class="hs-identifier hs-type">LMDoubleSplitRight</span></a></span><span> </span><span id="local-6989586621679476868"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679476868"><span class="hs-identifier hs-var">splitOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-405"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679476869"><span class="annot"><a href="#local-6989586621679476869"><span class="hs-identifier hs-var">ctl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476870"><span class="annot"><a href="#local-6989586621679476870"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476871"><span class="annot"><a href="#local-6989586621679476871"><span class="hs-identifier hs-var">ctr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either String (Edges SPitch, Notes SPitch, Edges SPitch)
-&gt; ExceptT String m (Edges SPitch, Notes SPitch, Edges SPitch)
forall (m :: * -&gt; *) e a. Monad m =&gt; Either e a -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">except</span></span><span> </span><span class="annot"><span class="annottext">(Either String (Edges SPitch, Notes SPitch, Edges SPitch)
 -&gt; ExceptT String m (Edges SPitch, Notes SPitch, Edges SPitch))
-&gt; Either String (Edges SPitch, Notes SPitch, Edges SPitch)
-&gt; ExceptT String m (Edges SPitch, Notes SPitch, Edges SPitch)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Split SPitch
-&gt; Edges SPitch
-&gt; Either String (Edges SPitch, Notes SPitch, Edges SPitch)
forall n.
(Ord n, Notation n, Hashable n) =&gt;
Split n -&gt; Edges n -&gt; Either String (Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier hs-var">applySplit</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679476868"><span class="hs-identifier hs-var">splitOp</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476850"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-406"></span><span>        </span><span id="local-6989586621679476872"><span class="annot"><a href="#local-6989586621679476872"><span class="hs-identifier hs-var">nextSteps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679476744"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476847"><span class="hs-identifier hs-type">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476848"><span class="hs-identifier hs-type">tl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476849"><span class="hs-identifier hs-type">sm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476869"><span class="hs-identifier hs-type">ctl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476870"><span class="hs-identifier hs-type">cs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679476853"><span class="hs-identifier hs-type">mkrest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476871"><span class="hs-identifier hs-type">ctr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span>
</span><span id="line-407"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Common.html#LMSplitRight"><span class="hs-identifier hs-type">LMSplitRight</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476868"><span class="hs-identifier hs-type">splitOp</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621679476872"><span class="hs-identifier hs-type">nextSteps</span></a></span><span>
</span><span id="line-408"></span><span>      </span><span class="annot"><a href="Common.html#LMDoubleSpread"><span class="hs-identifier hs-type">LMDoubleSpread</span></a></span><span> </span><span id="local-6989586621679476875"><span class="annot"><span class="annottext">Spread SPitch
</span><a href="#local-6989586621679476875"><span class="hs-identifier hs-var">spreadOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-409"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679476876"><span class="annot"><a href="#local-6989586621679476876"><span class="hs-identifier hs-var">ctl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476877"><span class="annot"><a href="#local-6989586621679476877"><span class="hs-identifier hs-var">csl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476878"><span class="annot"><a href="#local-6989586621679476878"><span class="hs-identifier hs-var">ctm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476879"><span class="annot"><a href="#local-6989586621679476879"><span class="hs-identifier hs-var">csr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476880"><span class="annot"><a href="#local-6989586621679476880"><span class="hs-identifier hs-var">ctr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either
  String
  (Edges SPitch, Notes SPitch, Edges SPitch, Notes SPitch,
   Edges SPitch)
-&gt; ExceptT
     String
     m
     (Edges SPitch, Notes SPitch, Edges SPitch, Notes SPitch,
      Edges SPitch)
forall (m :: * -&gt; *) e a. Monad m =&gt; Either e a -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">except</span></span><span> </span><span class="annot"><span class="annottext">(Either
   String
   (Edges SPitch, Notes SPitch, Edges SPitch, Notes SPitch,
    Edges SPitch)
 -&gt; ExceptT
      String
      m
      (Edges SPitch, Notes SPitch, Edges SPitch, Notes SPitch,
       Edges SPitch))
-&gt; Either
     String
     (Edges SPitch, Notes SPitch, Edges SPitch, Notes SPitch,
      Edges SPitch)
-&gt; ExceptT
     String
     m
     (Edges SPitch, Notes SPitch, Edges SPitch, Notes SPitch,
      Edges SPitch)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Spread SPitch
-&gt; Edges SPitch
-&gt; Notes SPitch
-&gt; Edges SPitch
-&gt; Either
     String
     (Edges SPitch, Notes SPitch, Edges SPitch, Notes SPitch,
      Edges SPitch)
forall n.
(Ord n, Notation n, Hashable n) =&gt;
Spread n
-&gt; Edges n
-&gt; Notes n
-&gt; Edges n
-&gt; Either String (Edges n, Notes n, Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySpread"><span class="hs-identifier hs-var">applySpread</span></a></span><span> </span><span class="annot"><span class="annottext">Spread SPitch
</span><a href="#local-6989586621679476875"><span class="hs-identifier hs-var">spreadOp</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476848"><span class="hs-identifier hs-var">tl</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476849"><span class="hs-identifier hs-var">sm</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476850"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-410"></span><span>        </span><span id="local-6989586621679476881"><span class="annot"><a href="#local-6989586621679476881"><span class="hs-identifier hs-var">nextSteps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679476744"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476847"><span class="hs-identifier hs-type">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476876"><span class="hs-identifier hs-type">ctl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476877"><span class="hs-identifier hs-type">csl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476878"><span class="hs-identifier hs-type">ctm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476879"><span class="hs-identifier hs-type">csr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679476853"><span class="hs-identifier hs-type">mkrest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476880"><span class="hs-identifier hs-type">ctr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>
</span><span id="line-411"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Common.html#LMSpread"><span class="hs-identifier hs-type">LMSpread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476875"><span class="hs-identifier hs-type">spreadOp</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621679476881"><span class="hs-identifier hs-type">nextSteps</span></a></span><span>
</span><span id="line-412"></span><span>
</span><span id="line-413"></span><span class="annot"><span class="hs-comment">{- | Walk through a derivation (starting at a given root path)
 and return the corresponding 'Trace' (if possible).
 The trace can be used together with 'sampleDerivation'
 for inference ('getPosterior') or for showing the trace ('printTrace').
-}</span></span><span>
</span><span id="line-418"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeDerivation"><span class="hs-identifier hs-type">observeDerivation</span></a></span><span>
</span><span id="line-419"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#PVLeftmost"><span class="hs-identifier hs-type">PVLeftmost</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span>
</span><span id="line-420"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-421"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Trace</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span id="observeDerivation"><span class="annot"><span class="annottext">observeDerivation :: [PVLeftmost SPitch]
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Either String (Trace PVParams)
</span><a href="PVGrammar.Prob.Simple.html#observeDerivation"><span class="hs-identifier hs-var hs-var">observeDerivation</span></a></span></span><span> </span><span id="local-6989586621679476884"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679476884"><span class="hs-identifier hs-var">deriv</span></a></span></span><span> </span><span id="local-6989586621679476885"><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679476885"><span class="hs-identifier hs-var">top</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-423"></span><span>  </span><span class="annot"><span class="annottext">StateT (Trace PVParams) (Either String) ()
-&gt; Trace PVParams -&gt; Either String (Trace PVParams)
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m s
</span><span class="hs-identifier hs-var">execStateT</span></span><span>
</span><span id="line-424"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; [PVLeftmost SPitch]
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="#local-6989586621679476886"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
forall a. StartStop a
</span><a href="Common.html#Start"><span class="hs-identifier hs-var">Start</span></a></span><span> </span><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679476885"><span class="hs-identifier hs-var">top</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679476884"><span class="hs-identifier hs-var">deriv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-425"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Seq (String, Dynamic) -&gt; Trace PVParams
forall (r :: (* -&gt; *) -&gt; *). Seq (String, Dynamic) -&gt; Trace r
</span><span class="hs-identifier hs-var">Trace</span></span><span> </span><span class="annot"><span class="annottext">Seq (String, Dynamic)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-426"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-427"></span><span>  </span><span class="annot"><a href="#local-6989586621679476886"><span class="hs-identifier hs-type">go</span></a></span><span>
</span><span id="line-428"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.html#StartStop"><span class="hs-identifier hs-type">StartStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-429"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-430"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-431"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#PVLeftmost"><span class="hs-identifier hs-type">PVLeftmost</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span>
</span><span id="line-432"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-433"></span><span>  </span><span id="local-6989586621679476886"><span class="annot"><span class="annottext">go :: StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; [PVLeftmost SPitch]
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="#local-6989586621679476886"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679476887"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476887"><span class="hs-identifier hs-var">_sl</span></a></span></span><span> </span><span id="local-6989586621679476888"><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679476888"><span class="hs-identifier hs-var">_surface</span></a></span></span><span> </span><span id="local-6989586621679476889"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679476889"><span class="hs-identifier hs-var">_ars</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either String () -&gt; StateT (Trace PVParams) (Either String) ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (Trace PVParams) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Either String () -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; Either String () -&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Derivation incomplete.&quot;</span></span><span>
</span><span id="line-434"></span><span>  </span><span class="annot"><a href="#local-6989586621679476886"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621679476890"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476890"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#PathEnd"><span class="hs-identifier hs-type">PathEnd</span></a></span><span> </span><span id="local-6989586621679476891"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476891"><span class="hs-identifier hs-var">trans</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679476892"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679476892"><span class="hs-identifier hs-var">_ars</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679476893"><span class="annot"><span class="annottext">PVLeftmost SPitch
</span><a href="#local-6989586621679476893"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679476894"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679476894"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PVLeftmost SPitch
</span><a href="#local-6989586621679476893"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-435"></span><span>    </span><span class="annot"><a href="Common.html#LMSingle"><span class="hs-identifier hs-type">LMSingle</span></a></span><span> </span><span id="local-6989586621679476896"><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) (Freeze SPitch)
</span><a href="#local-6989586621679476896"><span class="hs-identifier hs-var">single</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-436"></span><span>      </span><span class="annot"><span class="annottext">ContextSingle SPitch
-&gt; LeftmostSingle (Split SPitch) (Freeze SPitch)
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeSingleStep"><span class="hs-identifier hs-var">observeSingleStep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476890"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476891"><span class="hs-identifier hs-var">trans</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
forall a. StartStop a
</span><a href="Common.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) (Freeze SPitch)
</span><a href="#local-6989586621679476896"><span class="hs-identifier hs-var">single</span></a></span><span>
</span><span id="line-437"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) (Freeze SPitch)
</span><a href="#local-6989586621679476896"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-438"></span><span>        </span><span class="annot"><a href="Common.html#LMSingleFreeze"><span class="hs-identifier hs-type">LMSingleFreeze</span></a></span><span> </span><span class="annot"><span class="annottext">Freeze SPitch
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; StateT (Trace PVParams) (Either String) ()
forall a. a -&gt; StateT (Trace PVParams) (Either String) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>        </span><span class="annot"><a href="Common.html#LMSingleSplit"><span class="hs-identifier hs-type">LMSingleSplit</span></a></span><span> </span><span id="local-6989586621679476898"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679476898"><span class="hs-identifier hs-var">splitOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-440"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679476899"><span class="annot"><a href="#local-6989586621679476899"><span class="hs-identifier hs-var">ctl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476900"><span class="annot"><a href="#local-6989586621679476900"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476901"><span class="annot"><a href="#local-6989586621679476901"><span class="hs-identifier hs-var">ctr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either String (Edges SPitch, Notes SPitch, Edges SPitch)
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (Edges SPitch, Notes SPitch, Edges SPitch)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (Trace PVParams) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Either String (Edges SPitch, Notes SPitch, Edges SPitch)
 -&gt; StateT
      (Trace PVParams)
      (Either String)
      (Edges SPitch, Notes SPitch, Edges SPitch))
-&gt; Either String (Edges SPitch, Notes SPitch, Edges SPitch)
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (Edges SPitch, Notes SPitch, Edges SPitch)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Split SPitch
-&gt; Edges SPitch
-&gt; Either String (Edges SPitch, Notes SPitch, Edges SPitch)
forall n.
(Ord n, Notation n, Hashable n) =&gt;
Split n -&gt; Edges n -&gt; Either String (Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier hs-var">applySplit</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679476898"><span class="hs-identifier hs-var">splitOp</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476891"><span class="hs-identifier hs-var">trans</span></a></span><span>
</span><span id="line-441"></span><span>          </span><span class="annot"><a href="#local-6989586621679476886"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476890"><span class="hs-identifier hs-type">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476899"><span class="hs-identifier hs-type">ctl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476900"><span class="hs-identifier hs-type">cs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#PathEnd"><span class="hs-identifier hs-type">PathEnd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476901"><span class="hs-identifier hs-type">ctr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="annot"><a href="#local-6989586621679476894"><span class="hs-identifier hs-type">rest</span></a></span><span>
</span><span id="line-442"></span><span>    </span><span class="annot"><a href="Common.html#LMDouble"><span class="hs-identifier hs-type">LMDouble</span></a></span><span> </span><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either String () -&gt; StateT (Trace PVParams) (Either String) ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (Trace PVParams) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Either String () -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; Either String () -&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Double operation on single transition.&quot;</span></span><span>
</span><span id="line-443"></span><span>  </span><span class="annot"><a href="#local-6989586621679476886"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621679476903"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476903"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span id="local-6989586621679476904"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476904"><span class="hs-identifier hs-var">tl</span></a></span></span><span> </span><span id="local-6989586621679476905"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476905"><span class="hs-identifier hs-var">sm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#PathEnd"><span class="hs-identifier hs-type">PathEnd</span></a></span><span> </span><span id="local-6989586621679476906"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476906"><span class="hs-identifier hs-var">tr</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679476907"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679476907"><span class="hs-identifier hs-var">ars</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679476908"><span class="annot"><span class="annottext">PVLeftmost SPitch
</span><a href="#local-6989586621679476908"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679476909"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679476909"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-444"></span><span>    </span><span class="annot"><span class="annottext">PVLeftmost SPitch
-&gt; [PVLeftmost SPitch]
-&gt; Bool
-&gt; ContextDouble SPitch
-&gt; (Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch))
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="#local-6989586621679476910"><span class="hs-identifier hs-var">goDouble</span></a></span><span> </span><span class="annot"><span class="annottext">PVLeftmost SPitch
</span><a href="#local-6989586621679476908"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679476909"><span class="hs-identifier hs-var">rest</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679476907"><span class="hs-identifier hs-var">ars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476903"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476904"><span class="hs-identifier hs-var">tl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476905"><span class="hs-identifier hs-var">sm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476906"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
forall a. StartStop a
</span><a href="Common.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
forall around between. around -&gt; Path around between
</span><a href="Common.html#PathEnd"><span class="hs-identifier hs-var">PathEnd</span></a></span><span>
</span><span id="line-445"></span><span>  </span><span class="annot"><a href="#local-6989586621679476886"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621679476911"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476911"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span id="local-6989586621679476912"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476912"><span class="hs-identifier hs-var">tl</span></a></span></span><span> </span><span id="local-6989586621679476913"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476913"><span class="hs-identifier hs-var">sm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span id="local-6989586621679476914"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476914"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span id="local-6989586621679476915"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476915"><span class="hs-identifier hs-var">sr</span></a></span></span><span> </span><span id="local-6989586621679476916"><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679476916"><span class="hs-identifier hs-var">pathRest</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679476917"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679476917"><span class="hs-identifier hs-var">ars</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679476918"><span class="annot"><span class="annottext">PVLeftmost SPitch
</span><a href="#local-6989586621679476918"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679476919"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679476919"><span class="hs-identifier hs-var">derivRest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-446"></span><span>    </span><span class="annot"><span class="annottext">PVLeftmost SPitch
-&gt; [PVLeftmost SPitch]
-&gt; Bool
-&gt; ContextDouble SPitch
-&gt; (Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch))
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="#local-6989586621679476910"><span class="hs-identifier hs-var">goDouble</span></a></span><span> </span><span class="annot"><span class="annottext">PVLeftmost SPitch
</span><a href="#local-6989586621679476918"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679476919"><span class="hs-identifier hs-var">derivRest</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679476917"><span class="hs-identifier hs-var">ars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476911"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476912"><span class="hs-identifier hs-var">tl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476913"><span class="hs-identifier hs-var">sm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476914"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Notes SPitch -&gt; StartStop (Notes SPitch)
forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476915"><span class="hs-identifier hs-var">sr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch))
 -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; (Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch))
-&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-447"></span><span>      </span><span class="hs-glyph">\</span><span id="local-6989586621679476920"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476920"><span class="hs-identifier hs-var">tr'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
-&gt; Notes SPitch
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476920"><span class="hs-identifier hs-var">tr'</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476915"><span class="hs-identifier hs-var">sr</span></a></span><span> </span><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679476916"><span class="hs-identifier hs-var">pathRest</span></a></span><span>
</span><span id="line-448"></span><span>
</span><span id="line-449"></span><span>  </span><span id="local-6989586621679476910"><span class="annot"><span class="annottext">goDouble :: PVLeftmost SPitch
-&gt; [PVLeftmost SPitch]
-&gt; Bool
-&gt; ContextDouble SPitch
-&gt; (Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch))
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="#local-6989586621679476910"><span class="hs-identifier hs-var hs-var">goDouble</span></a></span></span><span> </span><span id="local-6989586621679476953"><span class="annot"><span class="annottext">PVLeftmost SPitch
</span><a href="#local-6989586621679476953"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621679476954"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679476954"><span class="hs-identifier hs-var">rest</span></a></span></span><span> </span><span id="local-6989586621679476955"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679476955"><span class="hs-identifier hs-var">ars</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679476956"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476956"><span class="hs-identifier hs-var">sl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476957"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476957"><span class="hs-identifier hs-var">tl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476958"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476958"><span class="hs-identifier hs-var">sm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476959"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476959"><span class="hs-identifier hs-var">tr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476960"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476960"><span class="hs-identifier hs-var">sr</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679476961"><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679476961"><span class="hs-identifier hs-var">mkRest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PVLeftmost SPitch
</span><a href="#local-6989586621679476953"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-450"></span><span>    </span><span class="annot"><a href="Common.html#LMSingle"><span class="hs-identifier hs-type">LMSingle</span></a></span><span> </span><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) (Freeze SPitch)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either String () -&gt; StateT (Trace PVParams) (Either String) ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (Trace PVParams) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Either String () -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; Either String () -&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Single operation with several transitions left.&quot;</span></span><span>
</span><span id="line-451"></span><span>    </span><span class="annot"><a href="Common.html#LMDouble"><span class="hs-identifier hs-type">LMDouble</span></a></span><span> </span><span id="local-6989586621679476962"><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
</span><a href="#local-6989586621679476962"><span class="hs-identifier hs-var">double</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-452"></span><span>      </span><span class="annot"><span class="annottext">ContextDouble SPitch
-&gt; Bool
-&gt; LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeDoubleStep"><span class="hs-identifier hs-var">observeDoubleStep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476956"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476957"><span class="hs-identifier hs-var">tl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476958"><span class="hs-identifier hs-var">sm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476959"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679476960"><span class="hs-identifier hs-var">sr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679476955"><span class="hs-identifier hs-var">ars</span></a></span><span> </span><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
</span><a href="#local-6989586621679476962"><span class="hs-identifier hs-var">double</span></a></span><span>
</span><span id="line-453"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
</span><a href="#local-6989586621679476962"><span class="hs-identifier hs-var">double</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-454"></span><span>        </span><span class="annot"><a href="Common.html#LMDoubleFreezeLeft"><span class="hs-identifier hs-type">LMDoubleFreezeLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Freeze SPitch
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-455"></span><span>          </span><span class="annot"><span class="annottext">Bool
-&gt; StateT (Trace PVParams) (Either String) ()
-&gt; StateT (Trace PVParams) (Either String) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679476955"><span class="hs-identifier hs-var">ars</span></a></span><span> </span><span class="annot"><span class="annottext">(StateT (Trace PVParams) (Either String) ()
 -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; StateT (Trace PVParams) (Either String) ()
-&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Either String () -&gt; StateT (Trace PVParams) (Either String) ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (Trace PVParams) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Either String () -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; Either String () -&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;FreezeLeft after SplitRight.&quot;</span></span><span>
</span><span id="line-456"></span><span>          </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; [PVLeftmost SPitch]
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="#local-6989586621679476886"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Notes SPitch -&gt; StartStop (Notes SPitch)
forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476958"><span class="hs-identifier hs-var">sm</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679476961"><span class="hs-identifier hs-var">mkRest</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476959"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679476954"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-457"></span><span>        </span><span class="annot"><a href="Common.html#LMDoubleSplitLeft"><span class="hs-identifier hs-type">LMDoubleSplitLeft</span></a></span><span> </span><span id="local-6989586621679476964"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679476964"><span class="hs-identifier hs-var">splitOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-458"></span><span>          </span><span class="annot"><span class="annottext">Bool
-&gt; StateT (Trace PVParams) (Either String) ()
-&gt; StateT (Trace PVParams) (Either String) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679476955"><span class="hs-identifier hs-var">ars</span></a></span><span> </span><span class="annot"><span class="annottext">(StateT (Trace PVParams) (Either String) ()
 -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; StateT (Trace PVParams) (Either String) ()
-&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Either String () -&gt; StateT (Trace PVParams) (Either String) ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (Trace PVParams) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Either String () -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; Either String () -&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SplitLeft after SplitRight.&quot;</span></span><span>
</span><span id="line-459"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679476965"><span class="annot"><a href="#local-6989586621679476965"><span class="hs-identifier hs-var">ctl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476966"><span class="annot"><a href="#local-6989586621679476966"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476967"><span class="annot"><a href="#local-6989586621679476967"><span class="hs-identifier hs-var">ctr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either String (Edges SPitch, Notes SPitch, Edges SPitch)
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (Edges SPitch, Notes SPitch, Edges SPitch)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (Trace PVParams) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Either String (Edges SPitch, Notes SPitch, Edges SPitch)
 -&gt; StateT
      (Trace PVParams)
      (Either String)
      (Edges SPitch, Notes SPitch, Edges SPitch))
-&gt; Either String (Edges SPitch, Notes SPitch, Edges SPitch)
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (Edges SPitch, Notes SPitch, Edges SPitch)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Split SPitch
-&gt; Edges SPitch
-&gt; Either String (Edges SPitch, Notes SPitch, Edges SPitch)
forall n.
(Ord n, Notation n, Hashable n) =&gt;
Split n -&gt; Edges n -&gt; Either String (Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier hs-var">applySplit</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679476964"><span class="hs-identifier hs-var">splitOp</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476957"><span class="hs-identifier hs-var">tl</span></a></span><span>
</span><span id="line-460"></span><span>          </span><span class="annot"><a href="#local-6989586621679476886"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476956"><span class="hs-identifier hs-type">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476965"><span class="hs-identifier hs-type">ctl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476966"><span class="hs-identifier hs-type">cs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476967"><span class="hs-identifier hs-type">ctr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476958"><span class="hs-identifier hs-type">sm</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621679476961"><span class="hs-identifier hs-type">mkRest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476959"><span class="hs-identifier hs-type">tr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="annot"><a href="#local-6989586621679476954"><span class="hs-identifier hs-type">rest</span></a></span><span>
</span><span id="line-461"></span><span>        </span><span class="annot"><a href="Common.html#LMDoubleSplitRight"><span class="hs-identifier hs-type">LMDoubleSplitRight</span></a></span><span> </span><span id="local-6989586621679476968"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679476968"><span class="hs-identifier hs-var">splitOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-462"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679476969"><span class="annot"><a href="#local-6989586621679476969"><span class="hs-identifier hs-var">ctl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476970"><span class="annot"><a href="#local-6989586621679476970"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476971"><span class="annot"><a href="#local-6989586621679476971"><span class="hs-identifier hs-var">ctr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either String (Edges SPitch, Notes SPitch, Edges SPitch)
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (Edges SPitch, Notes SPitch, Edges SPitch)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (Trace PVParams) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Either String (Edges SPitch, Notes SPitch, Edges SPitch)
 -&gt; StateT
      (Trace PVParams)
      (Either String)
      (Edges SPitch, Notes SPitch, Edges SPitch))
-&gt; Either String (Edges SPitch, Notes SPitch, Edges SPitch)
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (Edges SPitch, Notes SPitch, Edges SPitch)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Split SPitch
-&gt; Edges SPitch
-&gt; Either String (Edges SPitch, Notes SPitch, Edges SPitch)
forall n.
(Ord n, Notation n, Hashable n) =&gt;
Split n -&gt; Edges n -&gt; Either String (Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier hs-var">applySplit</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679476968"><span class="hs-identifier hs-var">splitOp</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476959"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-463"></span><span>          </span><span class="annot"><a href="#local-6989586621679476886"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476956"><span class="hs-identifier hs-type">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476957"><span class="hs-identifier hs-type">tl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476958"><span class="hs-identifier hs-type">sm</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476969"><span class="hs-identifier hs-type">ctl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476970"><span class="hs-identifier hs-type">cs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621679476961"><span class="hs-identifier hs-type">mkRest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476971"><span class="hs-identifier hs-type">ctr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span> </span><span class="annot"><a href="#local-6989586621679476954"><span class="hs-identifier hs-type">rest</span></a></span><span>
</span><span id="line-464"></span><span>        </span><span class="annot"><a href="Common.html#LMDoubleSpread"><span class="hs-identifier hs-type">LMDoubleSpread</span></a></span><span> </span><span id="local-6989586621679476972"><span class="annot"><span class="annottext">Spread SPitch
</span><a href="#local-6989586621679476972"><span class="hs-identifier hs-var">spreadOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-465"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679476973"><span class="annot"><a href="#local-6989586621679476973"><span class="hs-identifier hs-var">ctl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476974"><span class="annot"><a href="#local-6989586621679476974"><span class="hs-identifier hs-var">csl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476975"><span class="annot"><a href="#local-6989586621679476975"><span class="hs-identifier hs-var">ctm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476976"><span class="annot"><a href="#local-6989586621679476976"><span class="hs-identifier hs-var">csr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679476977"><span class="annot"><a href="#local-6989586621679476977"><span class="hs-identifier hs-var">ctr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either
  String
  (Edges SPitch, Notes SPitch, Edges SPitch, Notes SPitch,
   Edges SPitch)
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (Edges SPitch, Notes SPitch, Edges SPitch, Notes SPitch,
      Edges SPitch)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (Trace PVParams) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Either
   String
   (Edges SPitch, Notes SPitch, Edges SPitch, Notes SPitch,
    Edges SPitch)
 -&gt; StateT
      (Trace PVParams)
      (Either String)
      (Edges SPitch, Notes SPitch, Edges SPitch, Notes SPitch,
       Edges SPitch))
-&gt; Either
     String
     (Edges SPitch, Notes SPitch, Edges SPitch, Notes SPitch,
      Edges SPitch)
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (Edges SPitch, Notes SPitch, Edges SPitch, Notes SPitch,
      Edges SPitch)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Spread SPitch
-&gt; Edges SPitch
-&gt; Notes SPitch
-&gt; Edges SPitch
-&gt; Either
     String
     (Edges SPitch, Notes SPitch, Edges SPitch, Notes SPitch,
      Edges SPitch)
forall n.
(Ord n, Notation n, Hashable n) =&gt;
Spread n
-&gt; Edges n
-&gt; Notes n
-&gt; Edges n
-&gt; Either String (Edges n, Notes n, Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySpread"><span class="hs-identifier hs-var">applySpread</span></a></span><span> </span><span class="annot"><span class="annottext">Spread SPitch
</span><a href="#local-6989586621679476972"><span class="hs-identifier hs-var">spreadOp</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476957"><span class="hs-identifier hs-var">tl</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679476958"><span class="hs-identifier hs-var">sm</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679476959"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-466"></span><span>          </span><span class="annot"><a href="#local-6989586621679476886"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476956"><span class="hs-identifier hs-type">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476973"><span class="hs-identifier hs-type">ctl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476974"><span class="hs-identifier hs-type">csl</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476975"><span class="hs-identifier hs-type">ctm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476976"><span class="hs-identifier hs-type">csr</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621679476961"><span class="hs-identifier hs-type">mkRest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679476977"><span class="hs-identifier hs-type">ctr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="annot"><a href="#local-6989586621679476954"><span class="hs-identifier hs-type">rest</span></a></span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span id="local-6989586621679476978"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSingleStep"><span class="hs-identifier hs-type">sampleSingleStep</span></a></span><span>
</span><span id="line-469"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextSingle"><span class="hs-identifier hs-type">ContextSingle</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679476978"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#LeftmostSingle"><span class="hs-identifier hs-type">LeftmostSingle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-470"></span><span id="sampleSingleStep"><span class="annot"><span class="annottext">sampleSingleStep :: ContextSingle SPitch
-&gt; m (LeftmostSingle (Split SPitch) (Freeze SPitch))
</span><a href="PVGrammar.Prob.Simple.html#sampleSingleStep"><span class="hs-identifier hs-var hs-var">sampleSingleStep</span></a></span></span><span> </span><span id="local-6989586621679477017"><span class="annot"><span class="annottext">parents :: ContextSingle SPitch
</span><a href="#local-6989586621679477017"><span class="hs-identifier hs-var">parents</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477018"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679477018"><span class="hs-identifier hs-var">trans</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-471"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Edges SPitch -&gt; Bool
forall n. (Eq (IntervalOf n), HasPitch n) =&gt; Edges n -&gt; Bool
</span><a href="PVGrammar.Generate.html#freezable"><span class="hs-identifier hs-var">freezable</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679477018"><span class="hs-identifier hs-var">trans</span></a></span><span>
</span><span id="line-472"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-473"></span><span>      </span><span id="local-6989586621679477019"><span class="annot"><a href="#local-6989586621679477019"><span class="hs-identifier hs-var">shouldFreeze</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-474"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli -&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall p l.
(Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor PVParams p -&gt; m (Support l)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldFreeze (single)&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">(Accessor PVParams Beta -&gt; m (Support Bernoulli))
-&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pSingleFreeze"><span class="hs-identifier hs-var">pSingleFreeze</span></a></span><span>
</span><span id="line-475"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679477019"><span class="hs-identifier hs-type">shouldFreeze</span></a></span><span>
</span><span id="line-476"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="Common.html#LMSingleFreeze"><span class="hs-identifier hs-type">LMSingleFreeze</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleFreeze"><span class="hs-identifier hs-type">sampleFreeze</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477017"><span class="hs-identifier hs-type">parents</span></a></span><span>
</span><span id="line-477"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="Common.html#LMSingleSplit"><span class="hs-identifier hs-type">LMSingleSplit</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSplit"><span class="hs-identifier hs-type">sampleSplit</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477017"><span class="hs-identifier hs-type">parents</span></a></span><span>
</span><span id="line-478"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Split SPitch -&gt; LeftmostSingle (Split SPitch) (Freeze SPitch)
forall s f. s -&gt; LeftmostSingle s f
</span><a href="Common.html#LMSingleSplit"><span class="hs-identifier hs-var">LMSingleSplit</span></a></span><span> </span><span class="annot"><span class="annottext">(Split SPitch -&gt; LeftmostSingle (Split SPitch) (Freeze SPitch))
-&gt; m (Split SPitch)
-&gt; m (LeftmostSingle (Split SPitch) (Freeze SPitch))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch -&gt; m (Split SPitch)
forall (m :: * -&gt; *).
(SampleCtx m Geometric1, SampleCtx m Bernoulli,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 SampleCtx m MagicalID, RandomInterpreter m PVParams) =&gt;
ContextSingle SPitch -&gt; m (Split SPitch)
</span><a href="PVGrammar.Prob.Simple.html#sampleSplit"><span class="hs-identifier hs-var">sampleSplit</span></a></span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch
</span><a href="#local-6989586621679477017"><span class="hs-identifier hs-var">parents</span></a></span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeSingleStep"><span class="hs-identifier hs-type">observeSingleStep</span></a></span><span>
</span><span id="line-481"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextSingle"><span class="hs-identifier hs-type">ContextSingle</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.html#LeftmostSingle"><span class="hs-identifier hs-type">LeftmostSingle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-482"></span><span id="observeSingleStep"><span class="annot"><span class="annottext">observeSingleStep :: ContextSingle SPitch
-&gt; LeftmostSingle (Split SPitch) (Freeze SPitch)
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeSingleStep"><span class="hs-identifier hs-var hs-var">observeSingleStep</span></a></span></span><span> </span><span id="local-6989586621679477028"><span class="annot"><span class="annottext">parents :: ContextSingle SPitch
</span><a href="#local-6989586621679477028"><span class="hs-identifier hs-var">parents</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477029"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679477029"><span class="hs-identifier hs-var">trans</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679477030"><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) (Freeze SPitch)
</span><a href="#local-6989586621679477030"><span class="hs-identifier hs-var">singleOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-483"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Edges SPitch -&gt; Bool
forall n. (Eq (IntervalOf n), HasPitch n) =&gt; Edges n -&gt; Bool
</span><a href="PVGrammar.Generate.html#freezable"><span class="hs-identifier hs-var">freezable</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679477029"><span class="hs-identifier hs-var">trans</span></a></span><span>
</span><span id="line-484"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) (Freeze SPitch)
</span><a href="#local-6989586621679477030"><span class="hs-identifier hs-var">singleOp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-485"></span><span>      </span><span class="annot"><a href="Common.html#LMSingleFreeze"><span class="hs-identifier hs-type">LMSingleFreeze</span></a></span><span> </span><span id="local-6989586621679477031"><span class="annot"><span class="annottext">Freeze SPitch
</span><a href="#local-6989586621679477031"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-486"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-487"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldFreeze (single)&quot;</span></span><span>
</span><span id="line-488"></span><span>          </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-489"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pSingleFreeze"><span class="hs-identifier hs-var">pSingleFreeze</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-490"></span><span>          </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-491"></span><span>        </span><span class="annot"><span class="annottext">ContextSingle SPitch
-&gt; Freeze SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeFreeze"><span class="hs-identifier hs-var">observeFreeze</span></a></span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch
</span><a href="#local-6989586621679477028"><span class="hs-identifier hs-var">parents</span></a></span><span> </span><span class="annot"><span class="annottext">Freeze SPitch
</span><a href="#local-6989586621679477031"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-492"></span><span>      </span><span class="annot"><a href="Common.html#LMSingleSplit"><span class="hs-identifier hs-type">LMSingleSplit</span></a></span><span> </span><span id="local-6989586621679477037"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679477037"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-493"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-494"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldFreeze (single)&quot;</span></span><span>
</span><span id="line-495"></span><span>          </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-496"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pSingleFreeze"><span class="hs-identifier hs-var">pSingleFreeze</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span>          </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-498"></span><span>        </span><span class="annot"><span class="annottext">ContextSingle SPitch
-&gt; Split SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeSplit"><span class="hs-identifier hs-var">observeSplit</span></a></span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch
</span><a href="#local-6989586621679477028"><span class="hs-identifier hs-var">parents</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679477037"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-499"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) (Freeze SPitch)
</span><a href="#local-6989586621679477030"><span class="hs-identifier hs-var">singleOp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-500"></span><span>      </span><span class="annot"><a href="Common.html#LMSingleFreeze"><span class="hs-identifier hs-type">LMSingleFreeze</span></a></span><span> </span><span class="annot"><span class="annottext">Freeze SPitch
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either String () -&gt; StateT (Trace PVParams) (Either String) ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (Trace PVParams) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Either String () -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; Either String () -&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Freezing a non-freezable transition.&quot;</span></span><span>
</span><span id="line-501"></span><span>      </span><span class="annot"><a href="Common.html#LMSingleSplit"><span class="hs-identifier hs-type">LMSingleSplit</span></a></span><span> </span><span id="local-6989586621679477042"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679477042"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch
-&gt; Split SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeSplit"><span class="hs-identifier hs-var">observeSplit</span></a></span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch
</span><a href="#local-6989586621679477028"><span class="hs-identifier hs-var">parents</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679477042"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-502"></span><span>
</span><span id="line-503"></span><span id="local-6989586621679477043"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleDoubleStep"><span class="hs-identifier hs-type">sampleDoubleStep</span></a></span><span>
</span><span id="line-504"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-505"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextDouble"><span class="hs-identifier hs-type">ContextDouble</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-506"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-507"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679477043"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#LeftmostDouble"><span class="hs-identifier hs-type">LeftmostDouble</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-508"></span><span id="sampleDoubleStep"><span class="annot"><span class="annottext">sampleDoubleStep :: ContextDouble SPitch
-&gt; Bool
-&gt; m (LeftmostDouble
        (Split SPitch) (Freeze SPitch) (Spread SPitch))
</span><a href="PVGrammar.Prob.Simple.html#sampleDoubleStep"><span class="hs-identifier hs-var hs-var">sampleDoubleStep</span></a></span></span><span> </span><span id="local-6989586621679477103"><span class="annot"><span class="annottext">parents :: ContextDouble SPitch
</span><a href="#local-6989586621679477103"><span class="hs-identifier hs-var">parents</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679477104"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679477104"><span class="hs-identifier hs-var">sliceL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477105"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679477105"><span class="hs-identifier hs-var">transL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477106"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679477106"><span class="hs-identifier hs-var">sliceM</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477107"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679477107"><span class="hs-identifier hs-var">transR</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477108"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679477108"><span class="hs-identifier hs-var">sliceR</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679477109"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679477109"><span class="hs-identifier hs-var">afterRightSplit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-509"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679477109"><span class="hs-identifier hs-var">afterRightSplit</span></a></span><span>
</span><span id="line-510"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-511"></span><span>      </span><span id="local-6989586621679477110"><span class="annot"><a href="#local-6989586621679477110"><span class="hs-identifier hs-var">shouldSplitRight</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-512"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli -&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall p l.
(Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor PVParams p -&gt; m (Support l)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldSplitRight&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">(Accessor PVParams Beta -&gt; m (Support Bernoulli))
-&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleRightSplit"><span class="hs-identifier hs-var">pDoubleRightSplit</span></a></span><span>
</span><span id="line-513"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679477110"><span class="hs-identifier hs-type">shouldSplitRight</span></a></span><span>
</span><span id="line-514"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="Common.html#LMDoubleSplitRight"><span class="hs-identifier hs-type">LMDoubleSplitRight</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSplit"><span class="hs-identifier hs-type">sampleSplit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477106"><span class="hs-identifier hs-type">sliceM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679477107"><span class="hs-identifier hs-type">transR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679477108"><span class="hs-identifier hs-type">sliceR</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-515"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="Common.html#LMDoubleSpread"><span class="hs-identifier hs-type">LMDoubleSpread</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSpread"><span class="hs-identifier hs-type">sampleSpread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477103"><span class="hs-identifier hs-type">parents</span></a></span><span>
</span><span id="line-516"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-517"></span><span>      </span><span id="local-6989586621679477115"><span class="annot"><a href="#local-6989586621679477115"><span class="hs-identifier hs-var">continueLeft</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-518"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli -&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall p l.
(Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor PVParams p -&gt; m (Support l)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;continueLeft&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">(Accessor PVParams Beta -&gt; m (Support Bernoulli))
-&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeft"><span class="hs-identifier hs-var">pDoubleLeft</span></a></span><span>
</span><span id="line-519"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679477115"><span class="hs-identifier hs-type">continueLeft</span></a></span><span>
</span><span id="line-520"></span><span>        </span><span class="hs-keyword">then</span><span>
</span><span id="line-521"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#freezable"><span class="hs-identifier hs-type">freezable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477105"><span class="hs-identifier hs-type">transL</span></a></span><span>
</span><span id="line-522"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-523"></span><span>              </span><span id="local-6989586621679477119"><span class="annot"><a href="#local-6989586621679477119"><span class="hs-identifier hs-var">shouldFreeze</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-524"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">sampleValue</span></span><span> </span><span class="annot"><span class="hs-string">&quot;shouldFreeze (double)&quot;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bernoulli</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-525"></span><span>                  </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-type">pOuter</span></a></span><span>
</span><span id="line-526"></span><span>                    </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pDoubleLeftFreeze"><span class="hs-identifier hs-type">pDoubleLeftFreeze</span></a></span><span>
</span><span id="line-527"></span><span>              </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679477119"><span class="hs-identifier hs-type">shouldFreeze</span></a></span><span>
</span><span id="line-528"></span><span>                </span><span class="hs-keyword">then</span><span>
</span><span id="line-529"></span><span>                  </span><span class="annot"><a href="Common.html#LMDoubleFreezeLeft"><span class="hs-identifier hs-type">LMDoubleFreezeLeft</span></a></span><span>
</span><span id="line-530"></span><span>                    </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleFreeze"><span class="hs-identifier hs-type">sampleFreeze</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679477104"><span class="hs-identifier hs-type">sliceL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679477105"><span class="hs-identifier hs-type">transL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477106"><span class="hs-identifier hs-type">sliceM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-531"></span><span>                </span><span class="hs-keyword">else</span><span>
</span><span id="line-532"></span><span>                  </span><span class="annot"><a href="Common.html#LMDoubleSplitLeft"><span class="hs-identifier hs-type">LMDoubleSplitLeft</span></a></span><span>
</span><span id="line-533"></span><span>                    </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSplit"><span class="hs-identifier hs-type">sampleSplit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679477104"><span class="hs-identifier hs-type">sliceL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679477105"><span class="hs-identifier hs-type">transL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477106"><span class="hs-identifier hs-type">sliceM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-534"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="Common.html#LMDoubleSplitLeft"><span class="hs-identifier hs-type">LMDoubleSplitLeft</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSplit"><span class="hs-identifier hs-type">sampleSplit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679477104"><span class="hs-identifier hs-type">sliceL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679477105"><span class="hs-identifier hs-type">transL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477106"><span class="hs-identifier hs-type">sliceM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-535"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleDoubleStep"><span class="hs-identifier hs-type">sampleDoubleStep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477103"><span class="hs-identifier hs-type">parents</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span>
</span><span id="line-536"></span><span>
</span><span id="line-537"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeDoubleStep"><span class="hs-identifier hs-type">observeDoubleStep</span></a></span><span>
</span><span id="line-538"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextDouble"><span class="hs-identifier hs-type">ContextDouble</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-539"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-540"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.html#LeftmostDouble"><span class="hs-identifier hs-type">LeftmostDouble</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-541"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-542"></span><span id="observeDoubleStep"><span class="annot"><span class="annottext">observeDoubleStep :: ContextDouble SPitch
-&gt; Bool
-&gt; LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeDoubleStep"><span class="hs-identifier hs-var hs-var">observeDoubleStep</span></a></span></span><span> </span><span id="local-6989586621679477123"><span class="annot"><span class="annottext">parents :: ContextDouble SPitch
</span><a href="#local-6989586621679477123"><span class="hs-identifier hs-var">parents</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679477124"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679477124"><span class="hs-identifier hs-var">sliceL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477125"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679477125"><span class="hs-identifier hs-var">transL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477126"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679477126"><span class="hs-identifier hs-var">sliceM</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477127"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679477127"><span class="hs-identifier hs-var">transR</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477128"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679477128"><span class="hs-identifier hs-var">sliceR</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679477129"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679477129"><span class="hs-identifier hs-var">afterRightSplit</span></a></span></span><span> </span><span id="local-6989586621679477130"><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
</span><a href="#local-6989586621679477130"><span class="hs-identifier hs-var">doubleOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-543"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
</span><a href="#local-6989586621679477130"><span class="hs-identifier hs-var">doubleOp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-544"></span><span>    </span><span class="annot"><a href="Common.html#LMDoubleFreezeLeft"><span class="hs-identifier hs-type">LMDoubleFreezeLeft</span></a></span><span> </span><span id="local-6989586621679477131"><span class="annot"><span class="annottext">Freeze SPitch
</span><a href="#local-6989586621679477131"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-545"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;continueLeft&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeft"><span class="hs-identifier hs-var">pDoubleLeft</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-546"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-547"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldFreeze (double)&quot;</span></span><span>
</span><span id="line-548"></span><span>        </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-549"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeftFreeze"><span class="hs-identifier hs-var">pDoubleLeftFreeze</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-550"></span><span>        </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-551"></span><span>      </span><span class="annot"><span class="annottext">ContextSingle SPitch
-&gt; Freeze SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeFreeze"><span class="hs-identifier hs-var">observeFreeze</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679477124"><span class="hs-identifier hs-var">sliceL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679477125"><span class="hs-identifier hs-var">transL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Notes SPitch -&gt; StartStop (Notes SPitch)
forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679477126"><span class="hs-identifier hs-var">sliceM</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Freeze SPitch
</span><a href="#local-6989586621679477131"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-552"></span><span>    </span><span class="annot"><a href="Common.html#LMDoubleSplitLeft"><span class="hs-identifier hs-type">LMDoubleSplitLeft</span></a></span><span> </span><span id="local-6989586621679477138"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679477138"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-553"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;continueLeft&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeft"><span class="hs-identifier hs-var">pDoubleLeft</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-554"></span><span>      </span><span class="annot"><span class="annottext">Bool
-&gt; StateT (Trace PVParams) (Either String) ()
-&gt; StateT (Trace PVParams) (Either String) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Edges SPitch -&gt; Bool
forall n. (Eq (IntervalOf n), HasPitch n) =&gt; Edges n -&gt; Bool
</span><a href="PVGrammar.Generate.html#freezable"><span class="hs-identifier hs-var">freezable</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679477125"><span class="hs-identifier hs-var">transL</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT (Trace PVParams) (Either String) ()
 -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; StateT (Trace PVParams) (Either String) ()
-&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-555"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-556"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldFreeze (double)&quot;</span></span><span>
</span><span id="line-557"></span><span>          </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-558"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeftFreeze"><span class="hs-identifier hs-var">pDoubleLeftFreeze</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-559"></span><span>          </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-560"></span><span>      </span><span class="annot"><span class="annottext">ContextSingle SPitch
-&gt; Split SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeSplit"><span class="hs-identifier hs-var">observeSplit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679477124"><span class="hs-identifier hs-var">sliceL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679477125"><span class="hs-identifier hs-var">transL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Notes SPitch -&gt; StartStop (Notes SPitch)
forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679477126"><span class="hs-identifier hs-var">sliceM</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679477138"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-561"></span><span>    </span><span class="annot"><a href="Common.html#LMDoubleSplitRight"><span class="hs-identifier hs-type">LMDoubleSplitRight</span></a></span><span> </span><span id="local-6989586621679477145"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679477145"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-562"></span><span>      </span><span class="annot"><span class="annottext">Bool
-&gt; StateT (Trace PVParams) (Either String) ()
-&gt; StateT (Trace PVParams) (Either String) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679477129"><span class="hs-identifier hs-var">afterRightSplit</span></a></span><span> </span><span class="annot"><span class="annottext">(StateT (Trace PVParams) (Either String) ()
 -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; StateT (Trace PVParams) (Either String) ()
-&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-563"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;continueLeft&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeft"><span class="hs-identifier hs-var">pDoubleLeft</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-564"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-565"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldSplitRight&quot;</span></span><span>
</span><span id="line-566"></span><span>        </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-567"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleRightSplit"><span class="hs-identifier hs-var">pDoubleRightSplit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-568"></span><span>        </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-569"></span><span>      </span><span class="annot"><span class="annottext">ContextSingle SPitch
-&gt; Split SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeSplit"><span class="hs-identifier hs-var">observeSplit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Notes SPitch -&gt; StartStop (Notes SPitch)
forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679477126"><span class="hs-identifier hs-var">sliceM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679477127"><span class="hs-identifier hs-var">transR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679477128"><span class="hs-identifier hs-var">sliceR</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679477145"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-570"></span><span>    </span><span class="annot"><a href="Common.html#LMDoubleSpread"><span class="hs-identifier hs-type">LMDoubleSpread</span></a></span><span> </span><span id="local-6989586621679477152"><span class="annot"><span class="annottext">Spread SPitch
</span><a href="#local-6989586621679477152"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-571"></span><span>      </span><span class="annot"><span class="annottext">Bool
-&gt; StateT (Trace PVParams) (Either String) ()
-&gt; StateT (Trace PVParams) (Either String) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679477129"><span class="hs-identifier hs-var">afterRightSplit</span></a></span><span> </span><span class="annot"><span class="annottext">(StateT (Trace PVParams) (Either String) ()
 -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; StateT (Trace PVParams) (Either String) ()
-&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-572"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;continueLeft&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeft"><span class="hs-identifier hs-var">pDoubleLeft</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-573"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-574"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldSplitRight&quot;</span></span><span>
</span><span id="line-575"></span><span>        </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-576"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleRightSplit"><span class="hs-identifier hs-var">pDoubleRightSplit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-577"></span><span>        </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-578"></span><span>      </span><span class="annot"><span class="annottext">ContextDouble SPitch
-&gt; Spread SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeSpread"><span class="hs-identifier hs-var">observeSpread</span></a></span><span> </span><span class="annot"><span class="annottext">ContextDouble SPitch
</span><a href="#local-6989586621679477123"><span class="hs-identifier hs-var">parents</span></a></span><span> </span><span class="annot"><span class="annottext">Spread SPitch
</span><a href="#local-6989586621679477152"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-579"></span><span>
</span><span id="line-580"></span><span id="local-6989586621679473641"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleFreeze"><span class="hs-identifier hs-type">sampleFreeze</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">RandomInterpreter</span></span><span> </span><span class="annot"><a href="#local-6989586621679473641"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextSingle"><span class="hs-identifier hs-type">ContextSingle</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679473641"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-581"></span><span id="sampleFreeze"><span class="annot"><span class="annottext">sampleFreeze :: forall (m :: * -&gt; *).
RandomInterpreter m PVParams =&gt;
ContextSingle SPitch -&gt; m (Freeze SPitch)
</span><a href="PVGrammar.Prob.Simple.html#sampleFreeze"><span class="hs-identifier hs-var hs-var">sampleFreeze</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span id="local-6989586621679477165"><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679477165"><span class="hs-identifier hs-var">reg</span></a></span></span><span> </span><span id="local-6989586621679477166"><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679477166"><span class="hs-identifier hs-var">pass</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Freeze SPitch -&gt; m (Freeze SPitch)
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet (Edge SPitch) -&gt; Freeze SPitch
forall n. HashSet (Edge n) -&gt; Freeze n
</span><a href="PVGrammar.html#FreezeOp"><span class="hs-identifier hs-var">FreezeOp</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679477165"><span class="hs-identifier hs-var">reg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-582"></span><span>
</span><span id="line-583"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeFreeze"><span class="hs-identifier hs-type">observeFreeze</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextSingle"><span class="hs-identifier hs-type">ContextSingle</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-584"></span><span id="observeFreeze"><span class="annot"><span class="annottext">observeFreeze :: ContextSingle SPitch
-&gt; Freeze SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeFreeze"><span class="hs-identifier hs-var hs-var">observeFreeze</span></a></span></span><span> </span><span id="local-6989586621679477168"><span class="annot"><span class="annottext">ContextSingle SPitch
</span><a href="#local-6989586621679477168"><span class="hs-identifier hs-var">_parents</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#FreezeOp"><span class="hs-identifier hs-type">FreezeOp</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; StateT (Trace PVParams) (Either String) ()
forall a. a -&gt; StateT (Trace PVParams) (Either String) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-585"></span><span>
</span><span id="line-586"></span><span class="hs-comment">-- helper for sampleSplit and observeSplit</span><span>
</span><span id="line-587"></span><span id="local-6989586621679473681"><span id="local-6989586621679473682"><span id="local-6989586621679473683"><span class="annot"><a href="PVGrammar.Prob.Simple.html#collectElabos"><span class="hs-identifier hs-type">collectElabos</span></a></span><span>
</span><span id="line-588"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679473681"><span class="hs-identifier hs-type">o1</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-589"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#InnerEdge"><span class="hs-identifier hs-type">InnerEdge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-590"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679473682"><span class="hs-identifier hs-type">o2</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-591"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679473683"><span class="hs-identifier hs-type">o3</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-592"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#StartStop"><span class="hs-identifier hs-type">StartStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#StartStop"><span class="hs-identifier hs-type">StartStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679473681"><span class="hs-identifier hs-type">o1</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-593"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-594"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679473682"><span class="hs-identifier hs-type">o2</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-595"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679473683"><span class="hs-identifier hs-type">o3</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-596"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-597"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-598"></span><span>     </span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-599"></span><span id="collectElabos"><span class="annot"><span class="annottext">collectElabos :: forall o1 o2 o3.
[(Edge SPitch, [(Note SPitch, o1)])]
-&gt; [(InnerEdge SPitch, [(Note SPitch, PassingOrnament)])]
-&gt; [(Note SPitch, [(Note SPitch, o2)])]
-&gt; [(Note SPitch, [(Note SPitch, o3)])]
-&gt; (Map (Edge SPitch) [(Note SPitch, o1)],
    Map (InnerEdge SPitch) [(Note SPitch, PassingOrnament)],
    Map (Note SPitch) [(Note SPitch, o2)],
    Map (Note SPitch) [(Note SPitch, o3)], HashSet (Edge SPitch),
    HashSet (Edge SPitch))
</span><a href="PVGrammar.Prob.Simple.html#collectElabos"><span class="hs-identifier hs-var hs-var">collectElabos</span></a></span></span><span> </span><span id="local-6989586621679477194"><span class="annot"><span class="annottext">[(Edge SPitch, [(Note SPitch, o1)])]
</span><a href="#local-6989586621679477194"><span class="hs-identifier hs-var">childrenT</span></a></span></span><span> </span><span id="local-6989586621679477195"><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(Note SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679477195"><span class="hs-identifier hs-var">childrenNT</span></a></span></span><span> </span><span id="local-6989586621679477196"><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, o2)])]
</span><a href="#local-6989586621679477196"><span class="hs-identifier hs-var">childrenL</span></a></span></span><span> </span><span id="local-6989586621679477197"><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, o3)])]
</span><a href="#local-6989586621679477197"><span class="hs-identifier hs-var">childrenR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-600"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477198"><span class="annot"><span class="annottext">splitTs :: Map (Edge SPitch) [(Note SPitch, o1)]
</span><a href="#local-6989586621679477198"><span class="hs-identifier hs-var hs-var">splitTs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(Note SPitch, o1)])]
-&gt; Map (Edge SPitch) [(Note SPitch, o1)]
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(Note SPitch, o1)])]
</span><a href="#local-6989586621679477194"><span class="hs-identifier hs-var">childrenT</span></a></span><span>
</span><span id="line-601"></span><span>      </span><span id="local-6989586621679477200"><span class="annot"><span class="annottext">splitNTs :: Map (InnerEdge SPitch) [(Note SPitch, PassingOrnament)]
</span><a href="#local-6989586621679477200"><span class="hs-identifier hs-var hs-var">splitNTs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(Note SPitch, PassingOrnament)])]
-&gt; Map (InnerEdge SPitch) [(Note SPitch, PassingOrnament)]
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(Note SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679477195"><span class="hs-identifier hs-var">childrenNT</span></a></span><span>
</span><span id="line-602"></span><span>      </span><span id="local-6989586621679477201"><span class="annot"><span class="annottext">fromLeft :: Map (Note SPitch) [(Note SPitch, o2)]
</span><a href="#local-6989586621679477201"><span class="hs-identifier hs-var hs-var">fromLeft</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, o2)])]
-&gt; Map (Note SPitch) [(Note SPitch, o2)]
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, o2)])]
</span><a href="#local-6989586621679477196"><span class="hs-identifier hs-var">childrenL</span></a></span><span>
</span><span id="line-603"></span><span>      </span><span id="local-6989586621679477202"><span class="annot"><span class="annottext">fromRight :: Map (Note SPitch) [(Note SPitch, o3)]
</span><a href="#local-6989586621679477202"><span class="hs-identifier hs-var hs-var">fromRight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, o3)])]
-&gt; Map (Note SPitch) [(Note SPitch, o3)]
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, o3)])]
</span><a href="#local-6989586621679477197"><span class="hs-identifier hs-var">childrenR</span></a></span><span>
</span><span id="line-604"></span><span>      </span><span id="local-6989586621679477203"><span class="annot"><span class="annottext">keepLeftT :: [Edge SPitch]
</span><a href="#local-6989586621679477203"><span class="hs-identifier hs-var hs-var">keepLeftT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(Note SPitch, o1)])]
-&gt; (Edge SPitch -&gt; Note SPitch -&gt; Edge SPitch) -&gt; [Edge SPitch]
forall p c o.
[(p, [(c, o)])] -&gt; (p -&gt; c -&gt; Edge SPitch) -&gt; [Edge SPitch]
</span><a href="#local-6989586621679477204"><span class="hs-identifier hs-var">getEdges</span></a></span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(Note SPitch, o1)])]
</span><a href="#local-6989586621679477194"><span class="hs-identifier hs-var">childrenT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679477205"><span class="annot"><span class="annottext">Edge SPitch
</span><a href="#local-6989586621679477205"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679477206"><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477206"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Edge SPitch -&gt; StartStop (Note SPitch)
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">Edge SPitch
</span><a href="#local-6989586621679477205"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Note SPitch -&gt; StartStop (Note SPitch)
forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477206"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-605"></span><span>      </span><span id="local-6989586621679477208"><span class="annot"><span class="annottext">keepLeftL :: [Edge SPitch]
</span><a href="#local-6989586621679477208"><span class="hs-identifier hs-var hs-var">keepLeftL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, o2)])]
-&gt; (Note SPitch -&gt; Note SPitch -&gt; Edge SPitch) -&gt; [Edge SPitch]
forall p c o.
[(p, [(c, o)])] -&gt; (p -&gt; c -&gt; Edge SPitch) -&gt; [Edge SPitch]
</span><a href="#local-6989586621679477204"><span class="hs-identifier hs-var">getEdges</span></a></span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, o2)])]
</span><a href="#local-6989586621679477196"><span class="hs-identifier hs-var">childrenL</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679477209"><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477209"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679477210"><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477210"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Note SPitch -&gt; StartStop (Note SPitch)
forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477209"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Note SPitch -&gt; StartStop (Note SPitch)
forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477210"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-606"></span><span>      </span><span id="local-6989586621679477211"><span class="annot"><span class="annottext">keepLeftNT :: [Edge SPitch]
</span><a href="#local-6989586621679477211"><span class="hs-identifier hs-var hs-var">keepLeftNT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-607"></span><span>        </span><span class="hs-comment">-- List</span><span>
</span><span id="line-608"></span><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679477212"><span class="annot"><a href="#local-6989586621679477212"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477213"><span class="annot"><a href="#local-6989586621679477213"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(Note SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679477195"><span class="hs-identifier hs-var">childrenNT</span></a></span><span>
</span><span id="line-609"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679477214"><span class="annot"><a href="#local-6989586621679477214"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477215"><span class="annot"><a href="#local-6989586621679477215"><span class="hs-identifier hs-var">orn</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679477213"><span class="hs-identifier hs-type">cs</span></a></span><span>
</span><span id="line-610"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">guard</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621679477215"><span class="hs-identifier hs-type">orn</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">/=</span></span><span> </span><span class="annot"><a href="PVGrammar.html#PassingRight"><span class="hs-identifier hs-type">PassingRight</span></a></span><span>
</span><span id="line-611"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477212"><span class="hs-identifier hs-type">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477214"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-612"></span><span>      </span><span id="local-6989586621679477218"><span class="annot"><span class="annottext">leftEdges :: HashSet (Edge SPitch)
</span><a href="#local-6989586621679477218"><span class="hs-identifier hs-var hs-var">leftEdges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Edge SPitch] -&gt; HashSet (Edge SPitch)
forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">([Edge SPitch] -&gt; HashSet (Edge SPitch))
-&gt; [Edge SPitch] -&gt; HashSet (Edge SPitch)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Edge SPitch]
</span><a href="#local-6989586621679477203"><span class="hs-identifier hs-var">keepLeftT</span></a></span><span> </span><span class="annot"><span class="annottext">[Edge SPitch] -&gt; [Edge SPitch] -&gt; [Edge SPitch]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Edge SPitch]
</span><a href="#local-6989586621679477211"><span class="hs-identifier hs-var">keepLeftNT</span></a></span><span> </span><span class="annot"><span class="annottext">[Edge SPitch] -&gt; [Edge SPitch] -&gt; [Edge SPitch]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Edge SPitch]
</span><a href="#local-6989586621679477208"><span class="hs-identifier hs-var">keepLeftL</span></a></span><span>
</span><span id="line-613"></span><span>      </span><span id="local-6989586621679477220"><span class="annot"><span class="annottext">keepRightT :: [Edge SPitch]
</span><a href="#local-6989586621679477220"><span class="hs-identifier hs-var hs-var">keepRightT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(Note SPitch, o1)])]
-&gt; (Edge SPitch -&gt; Note SPitch -&gt; Edge SPitch) -&gt; [Edge SPitch]
forall p c o.
[(p, [(c, o)])] -&gt; (p -&gt; c -&gt; Edge SPitch) -&gt; [Edge SPitch]
</span><a href="#local-6989586621679477204"><span class="hs-identifier hs-var">getEdges</span></a></span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(Note SPitch, o1)])]
</span><a href="#local-6989586621679477194"><span class="hs-identifier hs-var">childrenT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679477221"><span class="annot"><span class="annottext">Edge SPitch
</span><a href="#local-6989586621679477221"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679477222"><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477222"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Note SPitch -&gt; StartStop (Note SPitch)
forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477222"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edge SPitch -&gt; StartStop (Note SPitch)
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">Edge SPitch
</span><a href="#local-6989586621679477221"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-614"></span><span>      </span><span id="local-6989586621679477224"><span class="annot"><span class="annottext">keepRightR :: [Edge SPitch]
</span><a href="#local-6989586621679477224"><span class="hs-identifier hs-var hs-var">keepRightR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, o3)])]
-&gt; (Note SPitch -&gt; Note SPitch -&gt; Edge SPitch) -&gt; [Edge SPitch]
forall p c o.
[(p, [(c, o)])] -&gt; (p -&gt; c -&gt; Edge SPitch) -&gt; [Edge SPitch]
</span><a href="#local-6989586621679477204"><span class="hs-identifier hs-var">getEdges</span></a></span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, o3)])]
</span><a href="#local-6989586621679477197"><span class="hs-identifier hs-var">childrenR</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679477225"><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477225"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621679477226"><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477226"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Note SPitch -&gt; StartStop (Note SPitch)
forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477226"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Note SPitch -&gt; StartStop (Note SPitch)
forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477225"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-615"></span><span>      </span><span id="local-6989586621679477227"><span class="annot"><span class="annottext">keepRightNT :: [Edge SPitch]
</span><a href="#local-6989586621679477227"><span class="hs-identifier hs-var hs-var">keepRightNT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-616"></span><span>        </span><span class="hs-comment">-- List</span><span>
</span><span id="line-617"></span><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477228"><span class="annot"><a href="#local-6989586621679477228"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477229"><span class="annot"><a href="#local-6989586621679477229"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(Note SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679477195"><span class="hs-identifier hs-var">childrenNT</span></a></span><span>
</span><span id="line-618"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679477230"><span class="annot"><a href="#local-6989586621679477230"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477231"><span class="annot"><a href="#local-6989586621679477231"><span class="hs-identifier hs-var">orn</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679477229"><span class="hs-identifier hs-type">cs</span></a></span><span>
</span><span id="line-619"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">guard</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621679477231"><span class="hs-identifier hs-type">orn</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">/=</span></span><span> </span><span class="annot"><a href="PVGrammar.html#PassingLeft"><span class="hs-identifier hs-type">PassingLeft</span></a></span><span>
</span><span id="line-620"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477230"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477228"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-621"></span><span>      </span><span id="local-6989586621679477233"><span class="annot"><span class="annottext">rightEdges :: HashSet (Edge SPitch)
</span><a href="#local-6989586621679477233"><span class="hs-identifier hs-var hs-var">rightEdges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Edge SPitch] -&gt; HashSet (Edge SPitch)
forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">([Edge SPitch] -&gt; HashSet (Edge SPitch))
-&gt; [Edge SPitch] -&gt; HashSet (Edge SPitch)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Edge SPitch]
</span><a href="#local-6989586621679477220"><span class="hs-identifier hs-var">keepRightT</span></a></span><span> </span><span class="annot"><span class="annottext">[Edge SPitch] -&gt; [Edge SPitch] -&gt; [Edge SPitch]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Edge SPitch]
</span><a href="#local-6989586621679477227"><span class="hs-identifier hs-var">keepRightNT</span></a></span><span> </span><span class="annot"><span class="annottext">[Edge SPitch] -&gt; [Edge SPitch] -&gt; [Edge SPitch]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Edge SPitch]
</span><a href="#local-6989586621679477224"><span class="hs-identifier hs-var">keepRightR</span></a></span><span>
</span><span id="line-622"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (Edge SPitch) [(Note SPitch, o1)]
</span><a href="#local-6989586621679477198"><span class="hs-identifier hs-var">splitTs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map (InnerEdge SPitch) [(Note SPitch, PassingOrnament)]
</span><a href="#local-6989586621679477200"><span class="hs-identifier hs-var">splitNTs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map (Note SPitch) [(Note SPitch, o2)]
</span><a href="#local-6989586621679477201"><span class="hs-identifier hs-var">fromLeft</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map (Note SPitch) [(Note SPitch, o3)]
</span><a href="#local-6989586621679477202"><span class="hs-identifier hs-var">fromRight</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679477218"><span class="hs-identifier hs-var">leftEdges</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679477233"><span class="hs-identifier hs-var">rightEdges</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-623"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-624"></span><span>  </span><span id="local-6989586621679473690"><span id="local-6989586621679473691"><span id="local-6989586621679473692"><span class="annot"><a href="#local-6989586621679477204"><span class="hs-identifier hs-type">getEdges</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679473690"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679473691"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679473692"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679473690"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679473691"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span></span></span></span><span>
</span><span id="line-625"></span><span>  </span><span id="local-6989586621679477204"><span class="annot"><span class="annottext">getEdges :: forall p c o.
[(p, [(c, o)])] -&gt; (p -&gt; c -&gt; Edge SPitch) -&gt; [Edge SPitch]
</span><a href="#local-6989586621679477204"><span class="hs-identifier hs-var hs-var">getEdges</span></a></span></span><span> </span><span id="local-6989586621679477237"><span class="annot"><span class="annottext">[(p, [(c, o)])]
</span><a href="#local-6989586621679477237"><span class="hs-identifier hs-var">elabos</span></a></span></span><span> </span><span id="local-6989586621679477238"><span class="annot"><span class="annottext">p -&gt; c -&gt; Edge SPitch
</span><a href="#local-6989586621679477238"><span class="hs-identifier hs-var">mkEdge</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-626"></span><span>    </span><span class="hs-comment">-- List</span><span>
</span><span id="line-627"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679477239"><span class="annot"><a href="#local-6989586621679477239"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477240"><span class="annot"><a href="#local-6989586621679477240"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(p, [(c, o)])]
</span><a href="#local-6989586621679477237"><span class="hs-identifier hs-var">elabos</span></a></span><span>
</span><span id="line-628"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679477241"><span class="annot"><a href="#local-6989586621679477241"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679477240"><span class="hs-identifier hs-type">cs</span></a></span><span>
</span><span id="line-629"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621679477238"><span class="hs-identifier hs-type">mkEdge</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477239"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477241"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-630"></span><span>
</span><span id="line-631"></span><span class="hs-comment">-- helper for sampleSplit and observeSplit</span><span>
</span><span id="line-632"></span><span id="local-6989586621679473702"><span id="local-6989586621679473703"><span id="local-6989586621679473704"><span class="annot"><a href="PVGrammar.Prob.Simple.html#collectNotes"><span class="hs-identifier hs-type">collectNotes</span></a></span><span>
</span><span id="line-633"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679473702"><span class="hs-identifier hs-type">o1</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-634"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#InnerEdge"><span class="hs-identifier hs-type">InnerEdge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-635"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679473703"><span class="hs-identifier hs-type">o2</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-636"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679473704"><span class="hs-identifier hs-type">o3</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-637"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span></span></span></span><span>
</span><span id="line-638"></span><span id="collectNotes"><span class="annot"><span class="annottext">collectNotes :: forall o1 o2 o3.
[(Edge SPitch, [(Note SPitch, o1)])]
-&gt; [(InnerEdge SPitch, [(Note SPitch, PassingOrnament)])]
-&gt; [(Note SPitch, [(Note SPitch, o2)])]
-&gt; [(Note SPitch, [(Note SPitch, o3)])]
-&gt; [Note SPitch]
</span><a href="PVGrammar.Prob.Simple.html#collectNotes"><span class="hs-identifier hs-var hs-var">collectNotes</span></a></span></span><span> </span><span id="local-6989586621679477256"><span class="annot"><span class="annottext">[(Edge SPitch, [(Note SPitch, o1)])]
</span><a href="#local-6989586621679477256"><span class="hs-identifier hs-var">childrenT</span></a></span></span><span> </span><span id="local-6989586621679477257"><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(Note SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679477257"><span class="hs-identifier hs-var">childrenNT</span></a></span></span><span> </span><span id="local-6989586621679477258"><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, o2)])]
</span><a href="#local-6989586621679477258"><span class="hs-identifier hs-var">childrenL</span></a></span></span><span> </span><span id="local-6989586621679477259"><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, o3)])]
</span><a href="#local-6989586621679477259"><span class="hs-identifier hs-var">childrenR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-639"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477260"><span class="annot"><span class="annottext">notesT :: [Note SPitch]
</span><a href="#local-6989586621679477260"><span class="hs-identifier hs-var hs-var">notesT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Edge SPitch, [(Note SPitch, o1)]) -&gt; [Note SPitch])
-&gt; [(Edge SPitch, [(Note SPitch, o1)])] -&gt; [Note SPitch]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Note SPitch, o1) -&gt; Note SPitch)
-&gt; [(Note SPitch, o1)] -&gt; [Note SPitch]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(Note SPitch, o1) -&gt; Note SPitch
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(Note SPitch, o1)] -&gt; [Note SPitch])
-&gt; ((Edge SPitch, [(Note SPitch, o1)]) -&gt; [(Note SPitch, o1)])
-&gt; (Edge SPitch, [(Note SPitch, o1)])
-&gt; [Note SPitch]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Edge SPitch, [(Note SPitch, o1)]) -&gt; [(Note SPitch, o1)]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(Note SPitch, o1)])]
</span><a href="#local-6989586621679477256"><span class="hs-identifier hs-var">childrenT</span></a></span><span>
</span><span id="line-640"></span><span>      </span><span id="local-6989586621679477262"><span class="annot"><span class="annottext">notesNT :: [Note SPitch]
</span><a href="#local-6989586621679477262"><span class="hs-identifier hs-var hs-var">notesNT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((InnerEdge SPitch, [(Note SPitch, PassingOrnament)])
 -&gt; [Note SPitch])
-&gt; [(InnerEdge SPitch, [(Note SPitch, PassingOrnament)])]
-&gt; [Note SPitch]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Note SPitch, PassingOrnament) -&gt; Note SPitch)
-&gt; [(Note SPitch, PassingOrnament)] -&gt; [Note SPitch]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(Note SPitch, PassingOrnament) -&gt; Note SPitch
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(Note SPitch, PassingOrnament)] -&gt; [Note SPitch])
-&gt; ((InnerEdge SPitch, [(Note SPitch, PassingOrnament)])
    -&gt; [(Note SPitch, PassingOrnament)])
-&gt; (InnerEdge SPitch, [(Note SPitch, PassingOrnament)])
-&gt; [Note SPitch]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(InnerEdge SPitch, [(Note SPitch, PassingOrnament)])
-&gt; [(Note SPitch, PassingOrnament)]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(Note SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679477257"><span class="hs-identifier hs-var">childrenNT</span></a></span><span>
</span><span id="line-641"></span><span>      </span><span id="local-6989586621679477263"><span class="annot"><span class="annottext">notesFromL :: [Note SPitch]
</span><a href="#local-6989586621679477263"><span class="hs-identifier hs-var hs-var">notesFromL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Note SPitch, [(Note SPitch, o2)]) -&gt; [Note SPitch])
-&gt; [(Note SPitch, [(Note SPitch, o2)])] -&gt; [Note SPitch]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Note SPitch, o2) -&gt; Note SPitch)
-&gt; [(Note SPitch, o2)] -&gt; [Note SPitch]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(Note SPitch, o2) -&gt; Note SPitch
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(Note SPitch, o2)] -&gt; [Note SPitch])
-&gt; ((Note SPitch, [(Note SPitch, o2)]) -&gt; [(Note SPitch, o2)])
-&gt; (Note SPitch, [(Note SPitch, o2)])
-&gt; [Note SPitch]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Note SPitch, [(Note SPitch, o2)]) -&gt; [(Note SPitch, o2)]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, o2)])]
</span><a href="#local-6989586621679477258"><span class="hs-identifier hs-var">childrenL</span></a></span><span>
</span><span id="line-642"></span><span>      </span><span id="local-6989586621679477264"><span class="annot"><span class="annottext">notesFromR :: [Note SPitch]
</span><a href="#local-6989586621679477264"><span class="hs-identifier hs-var hs-var">notesFromR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Note SPitch, [(Note SPitch, o3)]) -&gt; [Note SPitch])
-&gt; [(Note SPitch, [(Note SPitch, o3)])] -&gt; [Note SPitch]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Note SPitch, o3) -&gt; Note SPitch)
-&gt; [(Note SPitch, o3)] -&gt; [Note SPitch]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(Note SPitch, o3) -&gt; Note SPitch
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(Note SPitch, o3)] -&gt; [Note SPitch])
-&gt; ((Note SPitch, [(Note SPitch, o3)]) -&gt; [(Note SPitch, o3)])
-&gt; (Note SPitch, [(Note SPitch, o3)])
-&gt; [Note SPitch]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Note SPitch, [(Note SPitch, o3)]) -&gt; [(Note SPitch, o3)]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, o3)])]
</span><a href="#local-6989586621679477259"><span class="hs-identifier hs-var">childrenR</span></a></span><span>
</span><span id="line-643"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[Note SPitch] -&gt; [Note SPitch]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">([Note SPitch] -&gt; [Note SPitch]) -&gt; [Note SPitch] -&gt; [Note SPitch]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Note SPitch]
</span><a href="#local-6989586621679477260"><span class="hs-identifier hs-var">notesT</span></a></span><span> </span><span class="annot"><span class="annottext">[Note SPitch] -&gt; [Note SPitch] -&gt; [Note SPitch]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Note SPitch]
</span><a href="#local-6989586621679477262"><span class="hs-identifier hs-var">notesNT</span></a></span><span> </span><span class="annot"><span class="annottext">[Note SPitch] -&gt; [Note SPitch] -&gt; [Note SPitch]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Note SPitch]
</span><a href="#local-6989586621679477263"><span class="hs-identifier hs-var">notesFromL</span></a></span><span> </span><span class="annot"><span class="annottext">[Note SPitch] -&gt; [Note SPitch] -&gt; [Note SPitch]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Note SPitch]
</span><a href="#local-6989586621679477264"><span class="hs-identifier hs-var">notesFromR</span></a></span><span>
</span><span id="line-644"></span><span>
</span><span id="line-645"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSplit"><span class="hs-identifier hs-type">sampleSplit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679477266"><span class="annot"><a href="#local-6989586621679477266"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextSingle"><span class="hs-identifier hs-type">ContextSingle</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679477266"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-646"></span><span id="sampleSplit"><span class="annot"><span class="annottext">sampleSplit :: ContextSingle SPitch -&gt; m (Split SPitch)
</span><a href="PVGrammar.Prob.Simple.html#sampleSplit"><span class="hs-identifier hs-var hs-var">sampleSplit</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679477354"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679477354"><span class="hs-identifier hs-var">sliceL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477355"><span class="annot"><span class="annottext">edges :: Edges SPitch
</span><a href="#local-6989586621679477355"><span class="hs-identifier hs-var">edges</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span id="local-6989586621679477356"><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679477356"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621679477357"><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679477357"><span class="hs-identifier hs-var">nts</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477358"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679477358"><span class="hs-identifier hs-var">sliceR</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-647"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;\nPerforming split (smp) on: &quot; &lt;&gt; show edges</span><span>
</span><span id="line-648"></span><span>  </span><span class="hs-comment">-- ornament regular edges at least once</span><span>
</span><span id="line-649"></span><span>  </span><span id="local-6989586621679477359"><span class="annot"><a href="#local-6989586621679477359"><span class="hs-identifier hs-var">childrenT</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Edge SPitch -&gt; m (Edge SPitch, [(Note SPitch, DoubleOrnament)]))
-&gt; [Edge SPitch]
-&gt; m [(Edge SPitch, [(Note SPitch, DoubleOrnament)])]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Edge SPitch -&gt; m (Edge SPitch, [(Note SPitch, DoubleOrnament)])
forall (m :: * -&gt; *).
(SampleCtx m Geometric1, SampleCtx m Bernoulli,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 SampleCtx m MagicalID, RandomInterpreter m PVParams) =&gt;
Edge SPitch -&gt; m (Edge SPitch, [(Note SPitch, DoubleOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#sampleT"><span class="hs-identifier hs-var">sampleT</span></a></span><span> </span><span class="annot"><span class="annottext">([Edge SPitch]
 -&gt; m [(Edge SPitch, [(Note SPitch, DoubleOrnament)])])
-&gt; [Edge SPitch]
-&gt; m [(Edge SPitch, [(Note SPitch, DoubleOrnament)])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Edge SPitch] -&gt; [Edge SPitch]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">([Edge SPitch] -&gt; [Edge SPitch]) -&gt; [Edge SPitch] -&gt; [Edge SPitch]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch) -&gt; [Edge SPitch]
forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679477356"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-650"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;childrenT (smp): &quot; &lt;&gt; show childrenT</span><span>
</span><span id="line-651"></span><span>  </span><span class="hs-comment">-- ornament passing edges exactly once</span><span>
</span><span id="line-652"></span><span>  </span><span id="local-6989586621679477363"><span class="annot"><a href="#local-6989586621679477363"><span class="hs-identifier hs-var">childrenNT</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleNT"><span class="hs-identifier hs-type">sampleNT</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">L.sort</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Internal.MultiSet.html#toOccurList"><span class="hs-identifier hs-type">MS.toOccurList</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477357"><span class="hs-identifier hs-type">nts</span></a></span><span>
</span><span id="line-653"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;childrenNT (smp): &quot; &lt;&gt; show childrenNT</span><span>
</span><span id="line-654"></span><span>  </span><span class="hs-comment">-- ornament left notes</span><span>
</span><span id="line-655"></span><span>  </span><span id="local-6989586621679477366"><span class="annot"><a href="#local-6989586621679477366"><span class="hs-identifier hs-var">childrenL</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="Common.html#getInner"><span class="hs-identifier hs-type">getInner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477354"><span class="hs-identifier hs-type">sliceL</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-656"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Notes SPitch)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, RightOrnament)])]
-&gt; m [(Note SPitch, [(Note SPitch, RightOrnament)])]
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-657"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679477368"><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679477368"><span class="hs-identifier hs-var">notes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Note SPitch -&gt; m (Note SPitch, [(Note SPitch, RightOrnament)]))
-&gt; [Note SPitch]
-&gt; m [(Note SPitch, [(Note SPitch, RightOrnament)])]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Note SPitch -&gt; m (Note SPitch, [(Note SPitch, RightOrnament)])
forall (m :: * -&gt; *).
(SampleCtx m Geometric0, SampleCtx m Bernoulli,
 SampleCtx m MagicalOctaves, SampleCtx m MagicalID,
 RandomInterpreter m PVParams) =&gt;
Note SPitch -&gt; m (Note SPitch, [(Note SPitch, RightOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#sampleL"><span class="hs-identifier hs-var">sampleL</span></a></span><span> </span><span class="annot"><span class="annottext">([Note SPitch]
 -&gt; m [(Note SPitch, [(Note SPitch, RightOrnament)])])
-&gt; [Note SPitch]
-&gt; m [(Note SPitch, [(Note SPitch, RightOrnament)])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Note SPitch] -&gt; [Note SPitch]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">([Note SPitch] -&gt; [Note SPitch]) -&gt; [Note SPitch] -&gt; [Note SPitch]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch) -&gt; [Note SPitch]
forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679477368"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-658"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;childrenL (smp): &quot; &lt;&gt; show childrenL</span><span>
</span><span id="line-659"></span><span>  </span><span class="hs-comment">-- ornament right notes</span><span>
</span><span id="line-660"></span><span>  </span><span id="local-6989586621679477370"><span class="annot"><a href="#local-6989586621679477370"><span class="hs-identifier hs-var">childrenR</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="Common.html#getInner"><span class="hs-identifier hs-type">getInner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477358"><span class="hs-identifier hs-type">sliceR</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-661"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Notes SPitch)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, LeftOrnament)])]
-&gt; m [(Note SPitch, [(Note SPitch, LeftOrnament)])]
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-662"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679477371"><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679477371"><span class="hs-identifier hs-var">notes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Note SPitch -&gt; m (Note SPitch, [(Note SPitch, LeftOrnament)]))
-&gt; [Note SPitch]
-&gt; m [(Note SPitch, [(Note SPitch, LeftOrnament)])]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Note SPitch -&gt; m (Note SPitch, [(Note SPitch, LeftOrnament)])
forall (m :: * -&gt; *).
(SampleCtx m Geometric0, SampleCtx m Bernoulli,
 SampleCtx m MagicalOctaves, SampleCtx m MagicalID,
 RandomInterpreter m PVParams) =&gt;
Note SPitch -&gt; m (Note SPitch, [(Note SPitch, LeftOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#sampleR"><span class="hs-identifier hs-var">sampleR</span></a></span><span> </span><span class="annot"><span class="annottext">([Note SPitch] -&gt; m [(Note SPitch, [(Note SPitch, LeftOrnament)])])
-&gt; [Note SPitch]
-&gt; m [(Note SPitch, [(Note SPitch, LeftOrnament)])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Note SPitch] -&gt; [Note SPitch]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">([Note SPitch] -&gt; [Note SPitch]) -&gt; [Note SPitch] -&gt; [Note SPitch]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch) -&gt; [Note SPitch]
forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679477371"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-663"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;childrenR (smp): &quot; &lt;&gt; show childrenR</span><span>
</span><span id="line-664"></span><span>  </span><span class="hs-comment">-- introduce new passing edges left and right</span><span>
</span><span id="line-665"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477373"><span class="annot"><a href="#local-6989586621679477373"><span class="hs-identifier hs-var hs-var">notes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(Note SPitch, DoubleOrnament)])]
-&gt; [(InnerEdge SPitch, [(Note SPitch, PassingOrnament)])]
-&gt; [(Note SPitch, [(Note SPitch, RightOrnament)])]
-&gt; [(Note SPitch, [(Note SPitch, LeftOrnament)])]
-&gt; [Note SPitch]
forall o1 o2 o3.
[(Edge SPitch, [(Note SPitch, o1)])]
-&gt; [(InnerEdge SPitch, [(Note SPitch, PassingOrnament)])]
-&gt; [(Note SPitch, [(Note SPitch, o2)])]
-&gt; [(Note SPitch, [(Note SPitch, o3)])]
-&gt; [Note SPitch]
</span><a href="PVGrammar.Prob.Simple.html#collectNotes"><span class="hs-identifier hs-var">collectNotes</span></a></span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(Note SPitch, DoubleOrnament)])]
</span><a href="#local-6989586621679477359"><span class="hs-identifier hs-var">childrenT</span></a></span><span> </span><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(Note SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679477363"><span class="hs-identifier hs-var">childrenNT</span></a></span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, RightOrnament)])]
</span><a href="#local-6989586621679477366"><span class="hs-identifier hs-var">childrenL</span></a></span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, LeftOrnament)])]
</span><a href="#local-6989586621679477370"><span class="hs-identifier hs-var">childrenR</span></a></span><span>
</span><span id="line-666"></span><span>  </span><span id="local-6989586621679477374"><span class="annot"><a href="#local-6989586621679477374"><span class="hs-identifier hs-var">passLeft</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="Common.html#getInner"><span class="hs-identifier hs-type">getInner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477354"><span class="hs-identifier hs-type">sliceL</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-667"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Notes SPitch)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch) -&gt; m (MultiSet (InnerEdge SPitch))
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-668"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679477376"><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679477376"><span class="hs-identifier hs-var">notesl</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-669"></span><span>      </span><span class="annot"><span class="annottext">[Note SPitch]
-&gt; [Note SPitch]
-&gt; (forall (f :: * -&gt; *) (f :: * -&gt; *).
    Functor f =&gt;
    (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; m (MultiSet (InnerEdge SPitch))
forall (m :: * -&gt; *).
(SampleCtx m Geometric0, RandomInterpreter m PVParams) =&gt;
[Note SPitch]
-&gt; [Note SPitch]
-&gt; (forall (f :: * -&gt; *) (f :: * -&gt; *).
    Functor f =&gt;
    (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; m (MultiSet (InnerEdge SPitch))
</span><a href="PVGrammar.Prob.Simple.html#samplePassing"><span class="hs-identifier hs-var">samplePassing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Note SPitch] -&gt; [Note SPitch]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">([Note SPitch] -&gt; [Note SPitch]) -&gt; [Note SPitch] -&gt; [Note SPitch]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch) -&gt; [Note SPitch]
forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679477376"><span class="hs-identifier hs-var">notesl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Note SPitch]
</span><a href="#local-6989586621679477373"><span class="hs-identifier hs-var">notes</span></a></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pNewPassingLeft"><span class="hs-identifier hs-var">pNewPassingLeft</span></a></span><span>
</span><span id="line-670"></span><span>  </span><span id="local-6989586621679477380"><span class="annot"><a href="#local-6989586621679477380"><span class="hs-identifier hs-var">passRight</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="Common.html#getInner"><span class="hs-identifier hs-type">getInner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477358"><span class="hs-identifier hs-type">sliceR</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-671"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Notes SPitch)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch) -&gt; m (MultiSet (InnerEdge SPitch))
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-672"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679477381"><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679477381"><span class="hs-identifier hs-var">notesr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-673"></span><span>      </span><span class="annot"><span class="annottext">[Note SPitch]
-&gt; [Note SPitch]
-&gt; (forall (f :: * -&gt; *) (f :: * -&gt; *).
    Functor f =&gt;
    (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; m (MultiSet (InnerEdge SPitch))
forall (m :: * -&gt; *).
(SampleCtx m Geometric0, RandomInterpreter m PVParams) =&gt;
[Note SPitch]
-&gt; [Note SPitch]
-&gt; (forall (f :: * -&gt; *) (f :: * -&gt; *).
    Functor f =&gt;
    (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; m (MultiSet (InnerEdge SPitch))
</span><a href="PVGrammar.Prob.Simple.html#samplePassing"><span class="hs-identifier hs-var">samplePassing</span></a></span><span> </span><span class="annot"><span class="annottext">[Note SPitch]
</span><a href="#local-6989586621679477373"><span class="hs-identifier hs-var">notes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Note SPitch] -&gt; [Note SPitch]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">([Note SPitch] -&gt; [Note SPitch]) -&gt; [Note SPitch] -&gt; [Note SPitch]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch) -&gt; [Note SPitch]
forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679477381"><span class="hs-identifier hs-var">notesr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pNewPassingRight"><span class="hs-identifier hs-var">pNewPassingRight</span></a></span><span>
</span><span id="line-674"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679477384"><span class="annot"><a href="#local-6989586621679477384"><span class="hs-identifier hs-var">splitReg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477385"><span class="annot"><a href="#local-6989586621679477385"><span class="hs-identifier hs-var">splitPass</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477386"><span class="annot"><a href="#local-6989586621679477386"><span class="hs-identifier hs-var">fromLeft</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477387"><span class="annot"><a href="#local-6989586621679477387"><span class="hs-identifier hs-var">fromRight</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477388"><span class="annot"><a href="#local-6989586621679477388"><span class="hs-identifier hs-var">leftEdges</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477389"><span class="annot"><a href="#local-6989586621679477389"><span class="hs-identifier hs-var">rightEdges</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-675"></span><span>        </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#collectElabos"><span class="hs-identifier hs-type">collectElabos</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477359"><span class="hs-identifier hs-type">childrenT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477363"><span class="hs-identifier hs-type">childrenNT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477366"><span class="hs-identifier hs-type">childrenL</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477370"><span class="hs-identifier hs-type">childrenR</span></a></span><span>
</span><span id="line-676"></span><span>  </span><span class="hs-comment">-- decide which edges to keep</span><span>
</span><span id="line-677"></span><span>  </span><span id="local-6989586621679477390"><span class="annot"><a href="#local-6989586621679477390"><span class="hs-identifier hs-var">keepLeft</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleKeepEdges"><span class="hs-identifier hs-type">sampleKeepEdges</span></a></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pKeepL"><span class="hs-identifier hs-type">pKeepL</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477388"><span class="hs-identifier hs-type">leftEdges</span></a></span><span>
</span><span id="line-678"></span><span>  </span><span id="local-6989586621679477394"><span class="annot"><a href="#local-6989586621679477394"><span class="hs-identifier hs-var">keepRight</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleKeepEdges"><span class="hs-identifier hs-type">sampleKeepEdges</span></a></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pKeepR"><span class="hs-identifier hs-type">pKeepR</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477389"><span class="hs-identifier hs-type">rightEdges</span></a></span><span>
</span><span id="line-679"></span><span>  </span><span class="hs-comment">-- combine all sampling results into split operation</span><span>
</span><span id="line-680"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477397"><span class="annot"><a href="#local-6989586621679477397"><span class="hs-identifier hs-var hs-var">splitOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-681"></span><span>        </span><span class="annot"><a href="PVGrammar.html#SplitOp"><span class="hs-identifier hs-type">SplitOp</span></a></span><span>
</span><span id="line-682"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Map (Edge SPitch) [(Note SPitch, DoubleOrnament)]
splitReg :: Map (Edge SPitch) [(Note SPitch, DoubleOrnament)]
splitReg :: Map (Edge SPitch) [(Note SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679477384"><span class="hs-identifier hs-var hs-var">splitReg</span></a></span><span>
</span><span id="line-683"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map (InnerEdge SPitch) [(Note SPitch, PassingOrnament)]
splitPass :: Map (InnerEdge SPitch) [(Note SPitch, PassingOrnament)]
splitPass :: Map (InnerEdge SPitch) [(Note SPitch, PassingOrnament)]
</span><a href="#local-6989586621679477385"><span class="hs-identifier hs-var hs-var">splitPass</span></a></span><span>
</span><span id="line-684"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map (Note SPitch) [(Note SPitch, RightOrnament)]
fromLeft :: Map (Note SPitch) [(Note SPitch, RightOrnament)]
fromLeft :: Map (Note SPitch) [(Note SPitch, RightOrnament)]
</span><a href="#local-6989586621679477386"><span class="hs-identifier hs-var hs-var">fromLeft</span></a></span><span>
</span><span id="line-685"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map (Note SPitch) [(Note SPitch, LeftOrnament)]
fromRight :: Map (Note SPitch) [(Note SPitch, LeftOrnament)]
fromRight :: Map (Note SPitch) [(Note SPitch, LeftOrnament)]
</span><a href="#local-6989586621679477387"><span class="hs-identifier hs-var hs-var">fromRight</span></a></span><span>
</span><span id="line-686"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
keepLeft :: HashSet (Edge SPitch)
keepLeft :: HashSet (Edge SPitch)
</span><a href="#local-6989586621679477390"><span class="hs-identifier hs-var hs-var">keepLeft</span></a></span><span>
</span><span id="line-687"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
keepRight :: HashSet (Edge SPitch)
keepRight :: HashSet (Edge SPitch)
</span><a href="#local-6989586621679477394"><span class="hs-identifier hs-var hs-var">keepRight</span></a></span><span>
</span><span id="line-688"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
passLeft :: MultiSet (InnerEdge SPitch)
passLeft :: MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679477374"><span class="hs-identifier hs-var hs-var">passLeft</span></a></span><span>
</span><span id="line-689"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
passRight :: MultiSet (InnerEdge SPitch)
passRight :: MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679477380"><span class="hs-identifier hs-var hs-var">passRight</span></a></span><span>
</span><span id="line-690"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-691"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;Performing split (smp): &quot; &lt;&gt; show splitOp</span><span>
</span><span id="line-692"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621679477397"><span class="hs-identifier hs-type">splitOp</span></a></span><span>
</span><span id="line-693"></span><span>
</span><span id="line-694"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeSplit"><span class="hs-identifier hs-type">observeSplit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextSingle"><span class="hs-identifier hs-type">ContextSingle</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-695"></span><span id="observeSplit"><span class="annot"><span class="annottext">observeSplit :: ContextSingle SPitch
-&gt; Split SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeSplit"><span class="hs-identifier hs-var hs-var">observeSplit</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679477407"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679477407"><span class="hs-identifier hs-var">sliceL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477408"><span class="annot"><span class="annottext">_edges :: Edges SPitch
</span><a href="#local-6989586621679477408"><span class="hs-identifier hs-var">_edges</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span id="local-6989586621679477409"><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679477409"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621679477410"><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679477410"><span class="hs-identifier hs-var">nts</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477411"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679477411"><span class="hs-identifier hs-var">sliceR</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679477412"><span class="annot"><span class="annottext">_splitOp :: Split SPitch
</span><a href="#local-6989586621679477412"><span class="hs-identifier hs-var">_splitOp</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#SplitOp"><span class="hs-identifier hs-type">SplitOp</span></a></span><span> </span><span id="local-6989586621679477413"><span class="annot"><span class="annottext">Map (Edge SPitch) [(Note SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679477413"><span class="hs-identifier hs-var">splitTs</span></a></span></span><span> </span><span id="local-6989586621679477414"><span class="annot"><span class="annottext">Map (InnerEdge SPitch) [(Note SPitch, PassingOrnament)]
</span><a href="#local-6989586621679477414"><span class="hs-identifier hs-var">splitNTs</span></a></span></span><span> </span><span id="local-6989586621679477415"><span class="annot"><span class="annottext">Map (Note SPitch) [(Note SPitch, RightOrnament)]
</span><a href="#local-6989586621679477415"><span class="hs-identifier hs-var">fromLeft</span></a></span></span><span> </span><span id="local-6989586621679477416"><span class="annot"><span class="annottext">Map (Note SPitch) [(Note SPitch, LeftOrnament)]
</span><a href="#local-6989586621679477416"><span class="hs-identifier hs-var">fromRight</span></a></span></span><span> </span><span id="local-6989586621679477417"><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679477417"><span class="hs-identifier hs-var">keepLeft</span></a></span></span><span> </span><span id="local-6989586621679477418"><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679477418"><span class="hs-identifier hs-var">keepRight</span></a></span></span><span> </span><span id="local-6989586621679477419"><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679477419"><span class="hs-identifier hs-var">passLeft</span></a></span></span><span> </span><span id="local-6989586621679477420"><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679477420"><span class="hs-identifier hs-var">passRight</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-696"></span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-697"></span><span>    </span><span class="hs-comment">-- DT.traceM $ &quot;\nPerforming split (obs): &quot; &lt;&gt; show splitOp</span><span>
</span><span id="line-698"></span><span>    </span><span class="hs-comment">-- observe ornaments of regular edges</span><span>
</span><span id="line-699"></span><span>    </span><span id="local-6989586621679477421"><span class="annot"><a href="#local-6989586621679477421"><span class="hs-identifier hs-var">childrenT</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Edge SPitch
 -&gt; StateT
      (Trace PVParams)
      (Either String)
      (Edge SPitch, [(Note SPitch, DoubleOrnament)]))
-&gt; [Edge SPitch]
-&gt; StateT
     (Trace PVParams)
     (Either String)
     [(Edge SPitch, [(Note SPitch, DoubleOrnament)])]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (Edge SPitch) [(Note SPitch, DoubleOrnament)]
-&gt; Edge SPitch
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (Edge SPitch, [(Note SPitch, DoubleOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#observeT"><span class="hs-identifier hs-var">observeT</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Edge SPitch) [(Note SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679477413"><span class="hs-identifier hs-var">splitTs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Edge SPitch]
 -&gt; StateT
      (Trace PVParams)
      (Either String)
      [(Edge SPitch, [(Note SPitch, DoubleOrnament)])])
-&gt; [Edge SPitch]
-&gt; StateT
     (Trace PVParams)
     (Either String)
     [(Edge SPitch, [(Note SPitch, DoubleOrnament)])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Edge SPitch] -&gt; [Edge SPitch]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">([Edge SPitch] -&gt; [Edge SPitch]) -&gt; [Edge SPitch] -&gt; [Edge SPitch]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch) -&gt; [Edge SPitch]
forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679477409"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-700"></span><span>    </span><span class="hs-comment">-- DT.traceM $ &quot;childrenT (obs): &quot; &lt;&gt; show childrenT</span><span>
</span><span id="line-701"></span><span>    </span><span class="hs-comment">-- observe ornaments of passing edges</span><span>
</span><span id="line-702"></span><span>    </span><span id="local-6989586621679477423"><span class="annot"><a href="#local-6989586621679477423"><span class="hs-identifier hs-var">childrenNT</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeNT"><span class="hs-identifier hs-type">observeNT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477414"><span class="hs-identifier hs-type">splitNTs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">L.sort</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Internal.MultiSet.html#toOccurList"><span class="hs-identifier hs-type">MS.toOccurList</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477410"><span class="hs-identifier hs-type">nts</span></a></span><span>
</span><span id="line-703"></span><span>    </span><span class="hs-comment">-- DT.traceM $ &quot;childrenNT (obs): &quot; &lt;&gt; show childrenNT</span><span>
</span><span id="line-704"></span><span>    </span><span class="hs-comment">-- observe ornaments of left notes</span><span>
</span><span id="line-705"></span><span>    </span><span id="local-6989586621679477425"><span class="annot"><a href="#local-6989586621679477425"><span class="hs-identifier hs-var">childrenL</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="Common.html#getInner"><span class="hs-identifier hs-type">getInner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477407"><span class="hs-identifier hs-type">sliceL</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-706"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Notes SPitch)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, RightOrnament)])]
-&gt; StateT
     (Trace PVParams)
     (Either String)
     [(Note SPitch, [(Note SPitch, RightOrnament)])]
forall a. a -&gt; StateT (Trace PVParams) (Either String) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-707"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679477426"><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679477426"><span class="hs-identifier hs-var">notes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Note SPitch
 -&gt; StateT
      (Trace PVParams)
      (Either String)
      (Note SPitch, [(Note SPitch, RightOrnament)]))
-&gt; [Note SPitch]
-&gt; StateT
     (Trace PVParams)
     (Either String)
     [(Note SPitch, [(Note SPitch, RightOrnament)])]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (Note SPitch) [(Note SPitch, RightOrnament)]
-&gt; Note SPitch
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (Note SPitch, [(Note SPitch, RightOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#observeL"><span class="hs-identifier hs-var">observeL</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Note SPitch) [(Note SPitch, RightOrnament)]
</span><a href="#local-6989586621679477415"><span class="hs-identifier hs-var">fromLeft</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Note SPitch]
 -&gt; StateT
      (Trace PVParams)
      (Either String)
      [(Note SPitch, [(Note SPitch, RightOrnament)])])
-&gt; [Note SPitch]
-&gt; StateT
     (Trace PVParams)
     (Either String)
     [(Note SPitch, [(Note SPitch, RightOrnament)])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Note SPitch] -&gt; [Note SPitch]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">([Note SPitch] -&gt; [Note SPitch]) -&gt; [Note SPitch] -&gt; [Note SPitch]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch) -&gt; [Note SPitch]
forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679477426"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-708"></span><span>    </span><span class="hs-comment">-- DT.traceM $ &quot;childrenL (obs): &quot; &lt;&gt; show childrenL</span><span>
</span><span id="line-709"></span><span>    </span><span class="hs-comment">-- observe ornaments of right notes</span><span>
</span><span id="line-710"></span><span>    </span><span id="local-6989586621679477428"><span class="annot"><a href="#local-6989586621679477428"><span class="hs-identifier hs-var">childrenR</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="Common.html#getInner"><span class="hs-identifier hs-type">getInner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477411"><span class="hs-identifier hs-type">sliceR</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-711"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Notes SPitch)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, LeftOrnament)])]
-&gt; StateT
     (Trace PVParams)
     (Either String)
     [(Note SPitch, [(Note SPitch, LeftOrnament)])]
forall a. a -&gt; StateT (Trace PVParams) (Either String) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-712"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679477429"><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679477429"><span class="hs-identifier hs-var">notes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-713"></span><span>        </span><span class="annot"><span class="annottext">(Note SPitch
 -&gt; StateT
      (Trace PVParams)
      (Either String)
      (Note SPitch, [(Note SPitch, LeftOrnament)]))
-&gt; [Note SPitch]
-&gt; StateT
     (Trace PVParams)
     (Either String)
     [(Note SPitch, [(Note SPitch, LeftOrnament)])]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (Note SPitch) [(Note SPitch, LeftOrnament)]
-&gt; Note SPitch
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (Note SPitch, [(Note SPitch, LeftOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#observeR"><span class="hs-identifier hs-var">observeR</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Note SPitch) [(Note SPitch, LeftOrnament)]
</span><a href="#local-6989586621679477416"><span class="hs-identifier hs-var">fromRight</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Note SPitch]
 -&gt; StateT
      (Trace PVParams)
      (Either String)
      [(Note SPitch, [(Note SPitch, LeftOrnament)])])
-&gt; [Note SPitch]
-&gt; StateT
     (Trace PVParams)
     (Either String)
     [(Note SPitch, [(Note SPitch, LeftOrnament)])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Note SPitch] -&gt; [Note SPitch]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">([Note SPitch] -&gt; [Note SPitch]) -&gt; [Note SPitch] -&gt; [Note SPitch]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch) -&gt; [Note SPitch]
forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679477429"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-714"></span><span>    </span><span class="hs-comment">-- DT.traceM $ &quot;childrenR (obs): &quot; &lt;&gt; show childrenR</span><span>
</span><span id="line-715"></span><span>    </span><span class="hs-comment">-- observe new passing edges</span><span>
</span><span id="line-716"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477431"><span class="annot"><a href="#local-6989586621679477431"><span class="hs-identifier hs-var hs-var">notes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(Note SPitch, DoubleOrnament)])]
-&gt; [(InnerEdge SPitch, [(Note SPitch, PassingOrnament)])]
-&gt; [(Note SPitch, [(Note SPitch, RightOrnament)])]
-&gt; [(Note SPitch, [(Note SPitch, LeftOrnament)])]
-&gt; [Note SPitch]
forall o1 o2 o3.
[(Edge SPitch, [(Note SPitch, o1)])]
-&gt; [(InnerEdge SPitch, [(Note SPitch, PassingOrnament)])]
-&gt; [(Note SPitch, [(Note SPitch, o2)])]
-&gt; [(Note SPitch, [(Note SPitch, o3)])]
-&gt; [Note SPitch]
</span><a href="PVGrammar.Prob.Simple.html#collectNotes"><span class="hs-identifier hs-var">collectNotes</span></a></span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(Note SPitch, DoubleOrnament)])]
</span><a href="#local-6989586621679477421"><span class="hs-identifier hs-var">childrenT</span></a></span><span> </span><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(Note SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679477423"><span class="hs-identifier hs-var">childrenNT</span></a></span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, RightOrnament)])]
</span><a href="#local-6989586621679477425"><span class="hs-identifier hs-var">childrenL</span></a></span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, [(Note SPitch, LeftOrnament)])]
</span><a href="#local-6989586621679477428"><span class="hs-identifier hs-var">childrenR</span></a></span><span>
</span><span id="line-717"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="Common.html#getInner"><span class="hs-identifier hs-type">getInner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477407"><span class="hs-identifier hs-type">sliceL</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-718"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Notes SPitch)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; StateT (Trace PVParams) (Either String) ()
forall a. a -&gt; StateT (Trace PVParams) (Either String) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-719"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679477432"><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679477432"><span class="hs-identifier hs-var">notesl</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-720"></span><span>        </span><span class="annot"><span class="annottext">[Note SPitch]
-&gt; [Note SPitch]
-&gt; (forall (f :: * -&gt; *) (f :: * -&gt; *).
    Functor f =&gt;
    (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; MultiSet (InnerEdge SPitch)
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observePassing"><span class="hs-identifier hs-var">observePassing</span></a></span><span>
</span><span id="line-721"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Note SPitch] -&gt; [Note SPitch]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">([Note SPitch] -&gt; [Note SPitch]) -&gt; [Note SPitch] -&gt; [Note SPitch]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch) -&gt; [Note SPitch]
forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679477432"><span class="hs-identifier hs-var">notesl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-722"></span><span>          </span><span class="annot"><span class="annottext">[Note SPitch]
</span><a href="#local-6989586621679477431"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-723"></span><span>          </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pNewPassingLeft"><span class="hs-identifier hs-var">pNewPassingLeft</span></a></span><span>
</span><span id="line-724"></span><span>          </span><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679477419"><span class="hs-identifier hs-var">passLeft</span></a></span><span>
</span><span id="line-725"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="Common.html#getInner"><span class="hs-identifier hs-type">getInner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477411"><span class="hs-identifier hs-type">sliceR</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-726"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Notes SPitch)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; StateT (Trace PVParams) (Either String) ()
forall a. a -&gt; StateT (Trace PVParams) (Either String) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-727"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679477436"><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679477436"><span class="hs-identifier hs-var">notesr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-728"></span><span>        </span><span class="annot"><span class="annottext">[Note SPitch]
-&gt; [Note SPitch]
-&gt; (forall (f :: * -&gt; *) (f :: * -&gt; *).
    Functor f =&gt;
    (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; MultiSet (InnerEdge SPitch)
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observePassing"><span class="hs-identifier hs-var">observePassing</span></a></span><span>
</span><span id="line-729"></span><span>          </span><span class="annot"><span class="annottext">[Note SPitch]
</span><a href="#local-6989586621679477431"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-730"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Note SPitch] -&gt; [Note SPitch]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">([Note SPitch] -&gt; [Note SPitch]) -&gt; [Note SPitch] -&gt; [Note SPitch]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch) -&gt; [Note SPitch]
forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679477436"><span class="hs-identifier hs-var">notesr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-731"></span><span>          </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pNewPassingRight"><span class="hs-identifier hs-var">pNewPassingRight</span></a></span><span>
</span><span id="line-732"></span><span>          </span><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679477420"><span class="hs-identifier hs-var">passRight</span></a></span><span>
</span><span id="line-733"></span><span>    </span><span class="hs-comment">-- observe which edges are kept</span><span>
</span><span id="line-734"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477439"><span class="annot"><a href="#local-6989586621679477439"><span class="hs-identifier hs-var">leftEdges</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477440"><span class="annot"><a href="#local-6989586621679477440"><span class="hs-identifier hs-var">rightEdges</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-735"></span><span>          </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#collectElabos"><span class="hs-identifier hs-type">collectElabos</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477421"><span class="hs-identifier hs-type">childrenT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477423"><span class="hs-identifier hs-type">childrenNT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477425"><span class="hs-identifier hs-type">childrenL</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477428"><span class="hs-identifier hs-type">childrenR</span></a></span><span>
</span><span id="line-736"></span><span>    </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeKeepEdges"><span class="hs-identifier hs-type">observeKeepEdges</span></a></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pKeepL"><span class="hs-identifier hs-type">pKeepL</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477439"><span class="hs-identifier hs-type">leftEdges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477417"><span class="hs-identifier hs-type">keepLeft</span></a></span><span>
</span><span id="line-737"></span><span>    </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeKeepEdges"><span class="hs-identifier hs-type">observeKeepEdges</span></a></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pKeepR"><span class="hs-identifier hs-type">pKeepR</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477440"><span class="hs-identifier hs-type">rightEdges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477418"><span class="hs-identifier hs-type">keepRight</span></a></span><span>
</span><span id="line-738"></span><span>
</span><span id="line-739"></span><span id="local-6989586621679477446"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleRootNote"><span class="hs-identifier hs-type">sampleRootNote</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679477446"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-740"></span><span id="sampleRootNote"><span class="annot"><span class="annottext">sampleRootNote :: Int -&gt; m (Note SPitch)
</span><a href="PVGrammar.Prob.Simple.html#sampleRootNote"><span class="hs-identifier hs-var hs-var">sampleRootNote</span></a></span></span><span> </span><span id="local-6989586621679477492"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477492"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-741"></span><span>  </span><span id="local-6989586621679477493"><span class="annot"><a href="#local-6989586621679477493"><span class="hs-identifier hs-var">fifthsSign</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Bernoulli -&gt; Params Bernoulli -&gt; m (Support Bernoulli)
forall d.
(Distribution d, SampleCtx m d) =&gt;
String -&gt; d -&gt; Params d -&gt; m (Support d)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) d.
(RandomInterpreter m r, Distribution d, SampleCtx m d) =&gt;
String -&gt; d -&gt; Params d -&gt; m (Support d)
</span><span class="hs-identifier hs-var">sampleConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rootFifthsSign&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">Double
Params Bernoulli
</span><span class="hs-number">0.5</span></span><span>
</span><span id="line-742"></span><span>  </span><span id="local-6989586621679477495"><span class="annot"><a href="#local-6989586621679477495"><span class="hs-identifier hs-var">fifthsN</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sampleValue</span></span><span> </span><span class="annot"><span class="hs-string">&quot;rootFifthsN&quot;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Geometric0</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-type">pInner</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pRootFifths"><span class="hs-identifier hs-type">pRootFifths</span></a></span><span>
</span><span id="line-743"></span><span>  </span><span id="local-6989586621679477500"><span class="annot"><a href="#local-6989586621679477500"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sampleConst</span></span><span> </span><span class="annot"><span class="hs-string">&quot;rootOctave&quot;</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalOctaves"><span class="hs-identifier hs-type">MagicalOctaves</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-744"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477501"><span class="annot"><a href="#local-6989586621679477501"><span class="hs-identifier hs-var hs-var">fs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679477493"><span class="hs-identifier hs-var">fifthsSign</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477495"><span class="hs-identifier hs-var">fifthsN</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477495"><span class="hs-identifier hs-var">fifthsN</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-745"></span><span>      </span><span id="local-6989586621679477503"><span class="annot"><a href="#local-6989586621679477503"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SIC -&gt; IOf SIC
SIC -&gt; SInterval
forall i. IntervalClass i =&gt; i -&gt; IOf i
</span><span class="hs-identifier hs-var">emb</span></span><span> </span><span class="annot"><span class="annottext">(SIC -&gt; SInterval) -&gt; Pitch SIC -&gt; SPitch
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Pitch SIC
</span><span class="hs-identifier hs-var">spc</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477501"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; SInterval -&gt; SPitch
forall {a}. AdditiveGroup a =&gt; Pitch a -&gt; a -&gt; Pitch a
</span><span class="hs-operator hs-var">+^</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SInterval
forall i. Interval i =&gt; i
</span><span class="hs-identifier hs-var">octave</span></span><span> </span><span class="annot"><span class="annottext">SInterval -&gt; Int -&gt; SInterval
forall v s. (VectorSpace v, s ~ Scalar v) =&gt; v -&gt; s -&gt; v
</span><span class="hs-operator hs-var">^*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477500"><span class="hs-identifier hs-var">os</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-746"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;root note (sample): &quot; &lt;&gt; show p</span><span>
</span><span id="line-747"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477503"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;root&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">show</span></span><span> </span><span class="annot"><a href="#local-6989586621679477492"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-748"></span><span>
</span><span id="line-749"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeRootNote"><span class="hs-identifier hs-type">observeRootNote</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-750"></span><span id="observeRootNote"><span class="annot"><span class="annottext">observeRootNote :: Note SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeRootNote"><span class="hs-identifier hs-var hs-var">observeRootNote</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span id="local-6989586621679477511"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477511"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-751"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Params Bernoulli
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall d (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Distribution d, Typeable (Support d), Monad m) =&gt;
String -&gt; d -&gt; Params d -&gt; Support d -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rootFifthsSign&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">Double
Params Bernoulli
</span><span class="hs-number">0.5</span></span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><a href="#local-6989586621679477513"><span class="hs-identifier hs-var">fifthsSign</span></a></span><span>
</span><span id="line-752"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; Geometric0
-&gt; Accessor PVParams Beta
-&gt; Support Geometric0
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rootFifthsN&quot;</span></span><span> </span><span class="annot"><span class="annottext">Geometric0
</span><span class="hs-identifier hs-var">Geometric0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pRootFifths"><span class="hs-identifier hs-var">pRootFifths</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
Support Geometric0
</span><a href="#local-6989586621679477517"><span class="hs-identifier hs-var">fifthsN</span></a></span><span>
</span><span id="line-753"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; MagicalOctaves
-&gt; Params MagicalOctaves
-&gt; Support MagicalOctaves
-&gt; StateT (Trace PVParams) (Either String) ()
forall d (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Distribution d, Typeable (Support d), Monad m) =&gt;
String -&gt; d -&gt; Params d -&gt; Support d -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rootOctave&quot;</span></span><span> </span><span class="annot"><span class="annottext">MagicalOctaves
</span><a href="PVGrammar.Prob.Simple.html#MagicalOctaves"><span class="hs-identifier hs-var">MagicalOctaves</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch -&gt; Int
forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">octaves</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477511"><span class="hs-identifier hs-var">child</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span class="hs-special">)</span><span>
</span><span id="line-754"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-755"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;root note (obs): &quot; &lt;&gt; show child</span><span>
</span><span id="line-756"></span><span>
</span><span id="line-757"></span><span>  </span><span id="local-6989586621679477519"><span class="annot"><span class="annottext">fs :: Int
</span><a href="#local-6989586621679477519"><span class="hs-identifier hs-var hs-var">fs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Int
forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">fifths</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477511"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-758"></span><span>  </span><span id="local-6989586621679477513"><span class="annot"><span class="annottext">fifthsSign :: Bool
</span><a href="#local-6989586621679477513"><span class="hs-identifier hs-var hs-var">fifthsSign</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477519"><span class="hs-identifier hs-var">fs</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-759"></span><span>  </span><span id="local-6989586621679477517"><span class="annot"><span class="annottext">fifthsN :: Int
</span><a href="#local-6989586621679477517"><span class="hs-identifier hs-var hs-var">fifthsN</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679477513"><span class="hs-identifier hs-var">fifthsSign</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477519"><span class="hs-identifier hs-var">fs</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477519"><span class="hs-identifier hs-var">fs</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-760"></span><span>
</span><span id="line-761"></span><span id="local-6989586621679477521"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleOctaveShift"><span class="hs-identifier hs-type">sampleOctaveShift</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679477521"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SInterval</span></span></span><span>
</span><span id="line-762"></span><span id="sampleOctaveShift"><span class="annot"><span class="annottext">sampleOctaveShift :: String -&gt; m SInterval
</span><a href="PVGrammar.Prob.Simple.html#sampleOctaveShift"><span class="hs-identifier hs-var hs-var">sampleOctaveShift</span></a></span></span><span> </span><span id="local-6989586621679477545"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679477545"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-763"></span><span>  </span><span id="local-6989586621679477546"><span class="annot"><a href="#local-6989586621679477546"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; MagicalOctaves
-&gt; Params MagicalOctaves
-&gt; m (Support MagicalOctaves)
forall d.
(Distribution d, SampleCtx m d) =&gt;
String -&gt; d -&gt; Params d -&gt; m (Support d)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) d.
(RandomInterpreter m r, Distribution d, SampleCtx m d) =&gt;
String -&gt; d -&gt; Params d -&gt; m (Support d)
</span><span class="hs-identifier hs-var">sampleConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679477545"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">MagicalOctaves
</span><a href="PVGrammar.Prob.Simple.html#MagicalOctaves"><span class="hs-identifier hs-var">MagicalOctaves</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-764"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477547"><span class="annot"><a href="#local-6989586621679477547"><span class="hs-identifier hs-var hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SInterval
forall i. Interval i =&gt; i
</span><span class="hs-identifier hs-var">octave</span></span><span> </span><span class="annot"><span class="annottext">SInterval -&gt; Int -&gt; SInterval
forall v s. (VectorSpace v, s ~ Scalar v) =&gt; v -&gt; s -&gt; v
</span><span class="hs-operator hs-var">^*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477546"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span class="hs-special">)</span><span>
</span><span id="line-765"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;octave shift (smp) &quot; &lt;&gt; show os</span><span>
</span><span id="line-766"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621679477547"><span class="hs-identifier hs-type">os</span></a></span><span>
</span><span id="line-767"></span><span>
</span><span id="line-768"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeOctaveShift"><span class="hs-identifier hs-type">observeOctaveShift</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SInterval</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-769"></span><span id="observeOctaveShift"><span class="annot"><span class="annottext">observeOctaveShift :: String -&gt; SInterval -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeOctaveShift"><span class="hs-identifier hs-var hs-var">observeOctaveShift</span></a></span></span><span> </span><span id="local-6989586621679477558"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679477558"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679477559"><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679477559"><span class="hs-identifier hs-var">interval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-770"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477560"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621679477560"><span class="hs-identifier hs-var hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SInterval -&gt; Int
forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">octaves</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679477559"><span class="hs-identifier hs-var">interval</span></a></span><span> </span><span class="annot"><span class="annottext">SInterval -&gt; SInterval -&gt; SInterval
forall v. AdditiveGroup v =&gt; v -&gt; v -&gt; v
</span><span class="hs-operator hs-var">^+^</span></span><span> </span><span class="annot"><span class="annottext">ImperfectInterval SInterval -&gt; SInterval
forall i. Interval i =&gt; ImperfectInterval i -&gt; i
</span><span class="hs-identifier hs-var">major</span></span><span> </span><span class="annot"><span class="annottext">ImperfectInterval SInterval
</span><span class="hs-identifier hs-var">second</span></span><span class="hs-special">)</span><span>
</span><span id="line-771"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; MagicalOctaves
-&gt; Params MagicalOctaves
-&gt; Support MagicalOctaves
-&gt; StateT (Trace PVParams) (Either String) ()
forall d (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Distribution d, Typeable (Support d), Monad m) =&gt;
String -&gt; d -&gt; Params d -&gt; Support d -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679477558"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">MagicalOctaves
</span><a href="PVGrammar.Prob.Simple.html#MagicalOctaves"><span class="hs-identifier hs-var">MagicalOctaves</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Support MagicalOctaves
 -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; Support MagicalOctaves
-&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477560"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span>
</span><span id="line-772"></span><span>
</span><span id="line-773"></span><span class="hs-comment">-- DT.traceM $ &quot;octave shift (obs) &quot; &lt;&gt; show (octave @SInterval ^* n)</span><span>
</span><span id="line-774"></span><span>
</span><span id="line-775"></span><span id="local-6989586621679477564"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleNeighbor"><span class="hs-identifier hs-type">sampleNeighbor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679477564"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span></span><span>
</span><span id="line-776"></span><span id="sampleNeighbor"><span class="annot"><span class="annottext">sampleNeighbor :: Bool -&gt; SPitch -&gt; m SPitch
</span><a href="PVGrammar.Prob.Simple.html#sampleNeighbor"><span class="hs-identifier hs-var hs-var">sampleNeighbor</span></a></span></span><span> </span><span id="local-6989586621679477614"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679477614"><span class="hs-identifier hs-var">stepUp</span></a></span></span><span> </span><span id="local-6989586621679477615"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477615"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-777"></span><span>  </span><span id="local-6989586621679477616"><span class="annot"><a href="#local-6989586621679477616"><span class="hs-identifier hs-var">chromatic</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli -&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall p l.
(Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor PVParams p -&gt; m (Support l)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nbChromatic&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">(Accessor PVParams Beta -&gt; m (Support Bernoulli))
-&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pNBChromatic"><span class="hs-identifier hs-var">pNBChromatic</span></a></span><span>
</span><span id="line-778"></span><span>  </span><span id="local-6989586621679477620"><span class="annot"><a href="#local-6989586621679477620"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleOctaveShift"><span class="hs-identifier hs-type">sampleOctaveShift</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;nbOctShift&quot;</span></span><span>
</span><span id="line-779"></span><span>  </span><span id="local-6989586621679477621"><span class="annot"><a href="#local-6989586621679477621"><span class="hs-identifier hs-var">alt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sampleValue</span></span><span> </span><span class="annot"><span class="hs-string">&quot;nbAlt&quot;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Geometric0</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-type">pInner</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pNBAlt"><span class="hs-identifier hs-type">pNBAlt</span></a></span><span>
</span><span id="line-780"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477625"><span class="annot"><a href="#local-6989586621679477625"><span class="hs-identifier hs-var hs-var">altInterval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SIC -&gt; IOf SIC
forall i. IntervalClass i =&gt; i -&gt; IOf i
</span><span class="hs-identifier hs-var">emb</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
Scalar SIC
</span><a href="#local-6989586621679477621"><span class="hs-identifier hs-var">alt</span></a></span><span> </span><span class="annot"><span class="annottext">Scalar SIC -&gt; SIC -&gt; SIC
forall v. VectorSpace v =&gt; Scalar v -&gt; v -&gt; v
</span><span class="hs-operator hs-var">*^</span></span><span> </span><span class="annot"><span class="annottext">forall i. Chromatic i =&gt; i
</span><span class="hs-identifier hs-var">chromaticSemitone</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">SIC</span></span><span class="hs-special">)</span><span>
</span><span id="line-781"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679477616"><span class="hs-identifier hs-type">chromatic</span></a></span><span>
</span><span id="line-782"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-783"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621679477615"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+^</span></span><span> </span><span class="annot"><a href="#local-6989586621679477620"><span class="hs-identifier hs-type">os</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+^</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679477614"><span class="hs-identifier hs-type">stepUp</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="#local-6989586621679477625"><span class="hs-identifier hs-type">altInterval</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">down</span></span><span> </span><span class="annot"><a href="#local-6989586621679477625"><span class="hs-identifier hs-type">altInterval</span></a></span><span>
</span><span id="line-784"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-785"></span><span>      </span><span id="local-6989586621679477629"><span class="annot"><a href="#local-6989586621679477629"><span class="hs-identifier hs-var">altUp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sampleConst</span></span><span> </span><span class="annot"><span class="hs-string">&quot;nbAltUp&quot;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bernoulli</span></span><span> </span><span class="annot"><span class="hs-number">0.5</span></span><span>
</span><span id="line-786"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477630"><span class="annot"><a href="#local-6989586621679477630"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-787"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679477629"><span class="hs-identifier hs-var">altUp</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679477614"><span class="hs-identifier hs-var">stepUp</span></a></span><span>
</span><span id="line-788"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ImperfectInterval SInterval -&gt; SInterval
forall i. Interval i =&gt; ImperfectInterval i -&gt; i
</span><span class="hs-identifier hs-var">major</span></span><span> </span><span class="annot"><span class="annottext">ImperfectInterval SInterval
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">SInterval -&gt; SInterval -&gt; SInterval
forall v. AdditiveGroup v =&gt; v -&gt; v -&gt; v
</span><span class="hs-operator hs-var">^+^</span></span><span> </span><span class="annot"><span class="annottext">IOf SIC
SInterval
</span><a href="#local-6989586621679477625"><span class="hs-identifier hs-var">altInterval</span></a></span><span>
</span><span id="line-789"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ImperfectInterval SInterval -&gt; SInterval
forall i. Chromatic i =&gt; ImperfectInterval i -&gt; i
</span><span class="hs-identifier hs-var">minor</span></span><span> </span><span class="annot"><span class="annottext">ImperfectInterval SInterval
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">SInterval -&gt; SInterval -&gt; SInterval
forall v. AdditiveGroup v =&gt; v -&gt; v -&gt; v
</span><span class="hs-operator hs-var">^-^</span></span><span> </span><span class="annot"><span class="annottext">IOf SIC
SInterval
</span><a href="#local-6989586621679477625"><span class="hs-identifier hs-var">altInterval</span></a></span><span>
</span><span id="line-790"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621679477615"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+^</span></span><span> </span><span class="annot"><a href="#local-6989586621679477620"><span class="hs-identifier hs-type">os</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+^</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679477614"><span class="hs-identifier hs-type">stepUp</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="#local-6989586621679477630"><span class="hs-identifier hs-type">step</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">down</span></span><span> </span><span class="annot"><a href="#local-6989586621679477630"><span class="hs-identifier hs-type">step</span></a></span><span>
</span><span id="line-791"></span><span>
</span><span id="line-792"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeNeighbor"><span class="hs-identifier hs-type">observeNeighbor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-793"></span><span id="observeNeighbor"><span class="annot"><span class="annottext">observeNeighbor :: Bool
-&gt; SPitch -&gt; SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeNeighbor"><span class="hs-identifier hs-var hs-var">observeNeighbor</span></a></span></span><span> </span><span id="local-6989586621679477634"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679477634"><span class="hs-identifier hs-var">goesUp</span></a></span></span><span> </span><span id="local-6989586621679477635"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477635"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621679477636"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477636"><span class="hs-identifier hs-var">nb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-794"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477637"><span class="annot"><span class="annottext">interval :: ICOf SInterval
</span><a href="#local-6989586621679477637"><span class="hs-identifier hs-var hs-var hs-var">interval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SInterval -&gt; ICOf SInterval
forall i. Interval i =&gt; i -&gt; ICOf i
</span><span class="hs-identifier hs-var">ic</span></span><span> </span><span class="annot"><span class="annottext">(SInterval -&gt; ICOf SInterval) -&gt; SInterval -&gt; ICOf SInterval
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477635"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; SPitch -&gt; SInterval
forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477636"><span class="hs-identifier hs-var">nb</span></a></span><span>
</span><span id="line-795"></span><span>      </span><span id="local-6989586621679477640"><span class="annot"><span class="annottext">isChromatic :: Bool
</span><a href="#local-6989586621679477640"><span class="hs-identifier hs-var hs-var hs-var">isChromatic</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SIC -&gt; Int
forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">diasteps</span></span><span> </span><span class="annot"><span class="annottext">ICOf SInterval
SIC
</span><a href="#local-6989586621679477637"><span class="hs-identifier hs-var">interval</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-796"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nbChromatic&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pNBChromatic"><span class="hs-identifier hs-var">pNBChromatic</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><a href="#local-6989586621679477640"><span class="hs-identifier hs-var">isChromatic</span></a></span><span>
</span><span id="line-797"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; SInterval -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeOctaveShift"><span class="hs-identifier hs-var">observeOctaveShift</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nbOctShift&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477635"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; SPitch -&gt; SInterval
forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477636"><span class="hs-identifier hs-var">nb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-798"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679477640"><span class="hs-identifier hs-var">isChromatic</span></a></span><span>
</span><span id="line-799"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-800"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477645"><span class="annot"><span class="annottext">alt :: Int
</span><a href="#local-6989586621679477645"><span class="hs-identifier hs-var hs-var">alt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">abs</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SIC -&gt; Int
forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">alteration</span></span><span> </span><span class="annot"><span class="annottext">ICOf SInterval
SIC
</span><a href="#local-6989586621679477637"><span class="hs-identifier hs-var">interval</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-801"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Geometric0
-&gt; Accessor PVParams Beta
-&gt; Support Geometric0
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nbAlt&quot;</span></span><span> </span><span class="annot"><span class="annottext">Geometric0
</span><span class="hs-identifier hs-var">Geometric0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pNBAlt"><span class="hs-identifier hs-var">pNBAlt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
Support Geometric0
</span><a href="#local-6989586621679477645"><span class="hs-identifier hs-var">alt</span></a></span><span>
</span><span id="line-802"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-803"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477651"><span class="annot"><span class="annottext">alt :: Int
</span><a href="#local-6989586621679477651"><span class="hs-identifier hs-var hs-var hs-var">alt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SIC -&gt; Int
forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">alteration</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SIC -&gt; SIC
forall i. Interval i =&gt; i -&gt; i
</span><span class="hs-identifier hs-var">iabs</span></span><span> </span><span class="annot"><span class="annottext">ICOf SInterval
SIC
</span><a href="#local-6989586621679477637"><span class="hs-identifier hs-var">interval</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-804"></span><span>          </span><span id="local-6989586621679477653"><span class="annot"><span class="annottext">altUp :: Bool
</span><a href="#local-6989586621679477653"><span class="hs-identifier hs-var hs-var hs-var">altUp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477651"><span class="hs-identifier hs-var">alt</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679477634"><span class="hs-identifier hs-var">goesUp</span></a></span><span>
</span><span id="line-805"></span><span>          </span><span id="local-6989586621679477654"><span class="annot"><span class="annottext">altN :: Int
</span><a href="#local-6989586621679477654"><span class="hs-identifier hs-var hs-var hs-var">altN</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477651"><span class="hs-identifier hs-var">alt</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477651"><span class="hs-identifier hs-var">alt</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477651"><span class="hs-identifier hs-var">alt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-806"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Geometric0
-&gt; Accessor PVParams Beta
-&gt; Support Geometric0
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nbAlt&quot;</span></span><span> </span><span class="annot"><span class="annottext">Geometric0
</span><span class="hs-identifier hs-var">Geometric0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pNBAlt"><span class="hs-identifier hs-var">pNBAlt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
Support Geometric0
</span><a href="#local-6989586621679477654"><span class="hs-identifier hs-var">altN</span></a></span><span>
</span><span id="line-807"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Params Bernoulli
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall d (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Distribution d, Typeable (Support d), Monad m) =&gt;
String -&gt; d -&gt; Params d -&gt; Support d -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nbAltUp&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">Double
Params Bernoulli
</span><span class="hs-number">0.5</span></span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><a href="#local-6989586621679477653"><span class="hs-identifier hs-var">altUp</span></a></span><span>
</span><span id="line-808"></span><span>
</span><span id="line-809"></span><span class="hs-comment">-- mkChildId1 pid i o = &quot;(&quot; &lt;&gt; pid &lt;&gt; &quot;)-&quot; &lt;&gt; o &lt;&gt; show i</span><span>
</span><span id="line-810"></span><span class="hs-comment">-- mkChildId2 il ir i o = &quot;(&quot; &lt;&gt; il &lt;&gt; &quot;)-&quot; &lt;&gt; o &lt;&gt; show i &lt;&gt; &quot;-(&quot; &lt;&gt; ir &lt;&gt; &quot;)&quot;</span><span>
</span><span id="line-811"></span><span>
</span><span id="line-812"></span><span id="local-6989586621679477658"><span id="local-6989586621679477659"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleDoubleChild"><span class="hs-identifier hs-type">sampleDoubleChild</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679477658"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679477659"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#DoubleOrnament"><span class="hs-identifier hs-type">DoubleOrnament</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-813"></span><span id="sampleDoubleChild"><span class="annot"><span class="annottext">sampleDoubleChild :: i -&gt; Note SPitch -&gt; Note SPitch -&gt; m (Note SPitch, DoubleOrnament)
</span><a href="PVGrammar.Prob.Simple.html#sampleDoubleChild"><span class="hs-identifier hs-var hs-var">sampleDoubleChild</span></a></span></span><span> </span><span id="local-6989586621679477749"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679477749"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span id="local-6989586621679477750"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477750"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span id="local-6989586621679477751"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679477751"><span class="hs-identifier hs-var">il</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span id="local-6989586621679477752"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477752"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span id="local-6989586621679477753"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679477753"><span class="hs-identifier hs-var">ir</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-814"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Int
forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477750"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Int
forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477752"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-815"></span><span>      </span><span id="local-6989586621679477755"><span class="annot"><a href="#local-6989586621679477755"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-816"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli -&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall p l.
(Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor PVParams p -&gt; m (Support l)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatOverNeighbor&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">(Accessor PVParams Beta -&gt; m (Support Bernoulli))
-&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatOverNeighbor"><span class="hs-identifier hs-var">pRepeatOverNeighbor</span></a></span><span>
</span><span id="line-817"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679477755"><span class="hs-identifier hs-type">rep</span></a></span><span>
</span><span id="line-818"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-819"></span><span>          </span><span id="local-6989586621679477759"><span class="annot"><a href="#local-6989586621679477759"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleOctaveShift"><span class="hs-identifier hs-type">sampleOctaveShift</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;doubleChildOctave&quot;</span></span><span>
</span><span id="line-820"></span><span>          </span><span id="local-6989586621679477760"><span class="annot"><a href="#local-6989586621679477760"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sampleConst</span></span><span> </span><span class="annot"><span class="hs-string">&quot;doubleChildId&quot;</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalID"><span class="hs-identifier hs-type">MagicalID</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-821"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679477750"><span class="hs-identifier hs-type">pl</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+^</span></span><span> </span><span class="annot"><a href="#local-6989586621679477759"><span class="hs-identifier hs-type">os</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679477760"><span class="hs-identifier hs-type">cid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#FullRepeat"><span class="hs-identifier hs-type">FullRepeat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-822"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-823"></span><span>          </span><span id="local-6989586621679477762"><span class="annot"><a href="#local-6989586621679477762"><span class="hs-identifier hs-var">stepUp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sampleConst</span></span><span> </span><span class="annot"><span class="hs-string">&quot;stepUp&quot;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bernoulli</span></span><span> </span><span class="annot"><span class="hs-number">0.5</span></span><span>
</span><span id="line-824"></span><span>          </span><span id="local-6989586621679477763"><span class="annot"><a href="#local-6989586621679477763"><span class="hs-identifier hs-var">nb</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleNeighbor"><span class="hs-identifier hs-type">sampleNeighbor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477762"><span class="hs-identifier hs-type">stepUp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477750"><span class="hs-identifier hs-type">pl</span></a></span><span>
</span><span id="line-825"></span><span>          </span><span id="local-6989586621679477764"><span class="annot"><a href="#local-6989586621679477764"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sampleConst</span></span><span> </span><span class="annot"><span class="hs-string">&quot;doubleChildId&quot;</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalID"><span class="hs-identifier hs-type">MagicalID</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-826"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477763"><span class="hs-identifier hs-type">nb</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679477764"><span class="hs-identifier hs-type">cid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#FullNeighbor"><span class="hs-identifier hs-type">FullNeighbor</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-827"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-828"></span><span>      </span><span id="local-6989586621679477766"><span class="annot"><a href="#local-6989586621679477766"><span class="hs-identifier hs-var">repeatLeft</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-829"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli -&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall p l.
(Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor PVParams p -&gt; m (Support l)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatLeftOverRight&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">(Accessor PVParams Beta -&gt; m (Support Bernoulli))
-&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-830"></span><span>          </span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span>
</span><span id="line-831"></span><span>            </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatLeftOverRight"><span class="hs-identifier hs-var">pRepeatLeftOverRight</span></a></span><span>
</span><span id="line-832"></span><span>      </span><span id="local-6989586621679477770"><span class="annot"><a href="#local-6989586621679477770"><span class="hs-identifier hs-var">repeatAlter</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sampleValue</span></span><span> </span><span class="annot"><span class="hs-string">&quot;repeatAlter&quot;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bernoulli</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-type">pInner</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pRepeatAlter"><span class="hs-identifier hs-type">pRepeatAlter</span></a></span><span>
</span><span id="line-833"></span><span>      </span><span id="local-6989586621679477774"><span class="annot"><a href="#local-6989586621679477774"><span class="hs-identifier hs-var">alt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-834"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679477770"><span class="hs-identifier hs-type">repeatAlter</span></a></span><span>
</span><span id="line-835"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-836"></span><span>            </span><span id="local-6989586621679477775"><span class="annot"><a href="#local-6989586621679477775"><span class="hs-identifier hs-var">alterUp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-837"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">sampleValue</span></span><span> </span><span class="annot"><span class="hs-string">&quot;repeatAlterUp&quot;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bernoulli</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-type">pInner</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pRepeatAlterUp"><span class="hs-identifier hs-type">pRepeatAlterUp</span></a></span><span>
</span><span id="line-838"></span><span>            </span><span id="local-6989586621679477779"><span class="annot"><a href="#local-6989586621679477779"><span class="hs-identifier hs-var">semis</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-839"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">sampleValue</span></span><span> </span><span class="annot"><span class="hs-string">&quot;repeatAlterSemis&quot;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Geometric1</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-type">pInner</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pRepeatAlterSemis"><span class="hs-identifier hs-type">pRepeatAlterSemis</span></a></span><span>
</span><span id="line-840"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679477775"><span class="hs-identifier hs-type">alterUp</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">id</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">down</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">chromaticSemitone</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">^*</span></span><span> </span><span class="annot"><a href="#local-6989586621679477779"><span class="hs-identifier hs-type">semis</span></a></span><span>
</span><span id="line-841"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">unison</span></span><span>
</span><span id="line-842"></span><span>      </span><span id="local-6989586621679477786"><span class="annot"><a href="#local-6989586621679477786"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleOctaveShift"><span class="hs-identifier hs-type">sampleOctaveShift</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;doubleChildOctave&quot;</span></span><span>
</span><span id="line-843"></span><span>      </span><span id="local-6989586621679477787"><span class="annot"><a href="#local-6989586621679477787"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sampleConst</span></span><span> </span><span class="annot"><span class="hs-string">&quot;doubleChildId&quot;</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalID"><span class="hs-identifier hs-type">MagicalID</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-844"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679477766"><span class="hs-identifier hs-type">repeatLeft</span></a></span><span>
</span><span id="line-845"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679477750"><span class="hs-identifier hs-type">pl</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+^</span></span><span> </span><span class="annot"><a href="#local-6989586621679477786"><span class="hs-identifier hs-type">os</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+^</span></span><span> </span><span class="annot"><a href="#local-6989586621679477774"><span class="hs-identifier hs-type">alt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679477787"><span class="hs-identifier hs-type">cid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#RightRepeatOfLeft"><span class="hs-identifier hs-type">RightRepeatOfLeft</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-846"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679477752"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+^</span></span><span> </span><span class="annot"><a href="#local-6989586621679477786"><span class="hs-identifier hs-type">os</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+^</span></span><span> </span><span class="annot"><a href="#local-6989586621679477774"><span class="hs-identifier hs-type">alt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679477787"><span class="hs-identifier hs-type">cid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#LeftRepeatOfRight"><span class="hs-identifier hs-type">LeftRepeatOfRight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-847"></span><span>
</span><span id="line-848"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeDoubleChild"><span class="hs-identifier hs-type">observeDoubleChild</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-849"></span><span id="observeDoubleChild"><span class="annot"><span class="annottext">observeDoubleChild :: Note SPitch
-&gt; Note SPitch
-&gt; Note SPitch
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeDoubleChild"><span class="hs-identifier hs-var hs-var">observeDoubleChild</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span id="local-6989586621679477791"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477791"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span id="local-6989586621679477792"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477792"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span id="local-6989586621679477793"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477793"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span id="local-6989586621679477794"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679477794"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-850"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Int
forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477791"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Int
forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477792"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-851"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477795"><span class="annot"><span class="annottext">isRep :: Bool
</span><a href="#local-6989586621679477795"><span class="hs-identifier hs-var hs-var hs-var">isRep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477793"><span class="hs-identifier hs-var">child</span></a></span><span> </span><span class="annot"><span class="annottext">Pitch SIC -&gt; Pitch SIC -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477791"><span class="hs-identifier hs-var">pl</span></a></span><span>
</span><span id="line-852"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-853"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatOverNeighbor&quot;</span></span><span>
</span><span id="line-854"></span><span>        </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-855"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatOverNeighbor"><span class="hs-identifier hs-var">pRepeatOverNeighbor</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-856"></span><span>        </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><a href="#local-6989586621679477795"><span class="hs-identifier hs-var">isRep</span></a></span><span>
</span><span id="line-857"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679477795"><span class="hs-identifier hs-var">isRep</span></a></span><span>
</span><span id="line-858"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-859"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; SInterval -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeOctaveShift"><span class="hs-identifier hs-var">observeOctaveShift</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;doubleChildOctave&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477791"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; SPitch -&gt; SInterval
forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477793"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-860"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; MagicalID
-&gt; Params MagicalID
-&gt; Support MagicalID
-&gt; StateT (Trace PVParams) (Either String) ()
forall d (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Distribution d, Typeable (Support d), Monad m) =&gt;
String -&gt; d -&gt; Params d -&gt; Support d -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;doubleChildId&quot;</span></span><span> </span><span class="annot"><span class="annottext">MagicalID
</span><a href="PVGrammar.Prob.Simple.html#MagicalID"><span class="hs-identifier hs-var">MagicalID</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
Support MagicalID
</span><a href="#local-6989586621679477794"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-861"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-862"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477800"><span class="annot"><span class="annottext">dir :: Ordering
</span><a href="#local-6989586621679477800"><span class="hs-identifier hs-var hs-var hs-var">dir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SIC -&gt; Ordering
forall i. Interval i =&gt; i -&gt; Ordering
</span><span class="hs-identifier hs-var">direction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477791"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">Pitch SIC -&gt; Pitch SIC -&gt; SIC
forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477793"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-863"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477802"><span class="annot"><span class="annottext">goesUp :: Bool
</span><a href="#local-6989586621679477802"><span class="hs-identifier hs-var hs-var hs-var">goesUp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ordering
</span><a href="#local-6989586621679477800"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="annot"><span class="annottext">Ordering -&gt; Ordering -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span>
</span><span id="line-864"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Params Bernoulli
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall d (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Distribution d, Typeable (Support d), Monad m) =&gt;
String -&gt; d -&gt; Params d -&gt; Support d -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;stepUp&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">Double
Params Bernoulli
</span><span class="hs-number">0.5</span></span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><a href="#local-6989586621679477802"><span class="hs-identifier hs-var">goesUp</span></a></span><span>
</span><span id="line-865"></span><span>          </span><span class="annot"><span class="annottext">Bool
-&gt; SPitch -&gt; SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeNeighbor"><span class="hs-identifier hs-var">observeNeighbor</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679477802"><span class="hs-identifier hs-var">goesUp</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477791"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477793"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-866"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; MagicalID
-&gt; Params MagicalID
-&gt; Support MagicalID
-&gt; StateT (Trace PVParams) (Either String) ()
forall d (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Distribution d, Typeable (Support d), Monad m) =&gt;
String -&gt; d -&gt; Params d -&gt; Support d -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;doubleChildId&quot;</span></span><span> </span><span class="annot"><span class="annottext">MagicalID
</span><a href="PVGrammar.Prob.Simple.html#MagicalID"><span class="hs-identifier hs-var">MagicalID</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
Support MagicalID
</span><a href="#local-6989586621679477794"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-867"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-868"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477803"><span class="annot"><span class="annottext">repeatLeft :: Bool
</span><a href="#local-6989586621679477803"><span class="hs-identifier hs-var hs-var hs-var">repeatLeft</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Int
forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477791"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Int
forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477793"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-869"></span><span>          </span><span id="local-6989586621679477804"><span class="annot"><span class="annottext">ref :: SPitch
</span><a href="#local-6989586621679477804"><span class="hs-identifier hs-var hs-var hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679477803"><span class="hs-identifier hs-var">repeatLeft</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477791"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477792"><span class="hs-identifier hs-var">pr</span></a></span><span>
</span><span id="line-870"></span><span>          </span><span id="local-6989586621679477805"><span class="annot"><span class="annottext">alt :: Int
</span><a href="#local-6989586621679477805"><span class="hs-identifier hs-var hs-var hs-var">alt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Int
forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">alteration</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477793"><span class="hs-identifier hs-var">child</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Int
forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">alteration</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477804"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-871"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-872"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatLeftOverRight&quot;</span></span><span>
</span><span id="line-873"></span><span>        </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-874"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatLeftOverRight"><span class="hs-identifier hs-var">pRepeatLeftOverRight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-875"></span><span>        </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><a href="#local-6989586621679477803"><span class="hs-identifier hs-var">repeatLeft</span></a></span><span>
</span><span id="line-876"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatAlter&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatAlter"><span class="hs-identifier hs-var">pRepeatAlter</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477805"><span class="hs-identifier hs-var">alt</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-877"></span><span>      </span><span class="annot"><span class="annottext">Bool
-&gt; StateT (Trace PVParams) (Either String) ()
-&gt; StateT (Trace PVParams) (Either String) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477805"><span class="hs-identifier hs-var">alt</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT (Trace PVParams) (Either String) ()
 -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; StateT (Trace PVParams) (Either String) ()
-&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-878"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatAlterUp&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatAlterUp"><span class="hs-identifier hs-var">pRepeatAlterUp</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477805"><span class="hs-identifier hs-var">alt</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-879"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Geometric1
-&gt; Accessor PVParams Beta
-&gt; Support Geometric1
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-880"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatAlterSemis&quot;</span></span><span>
</span><span id="line-881"></span><span>          </span><span class="annot"><span class="annottext">Geometric1
</span><span class="hs-identifier hs-var">Geometric1</span></span><span>
</span><span id="line-882"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatAlterSemis"><span class="hs-identifier hs-var">pRepeatAlterSemis</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-883"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int
forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">abs</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477805"><span class="hs-identifier hs-var">alt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-884"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; SInterval -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeOctaveShift"><span class="hs-identifier hs-var">observeOctaveShift</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;doubleChildOctave&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SInterval -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; SInterval -&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477804"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; SPitch -&gt; SInterval
forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477793"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-885"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; MagicalID
-&gt; Params MagicalID
-&gt; Support MagicalID
-&gt; StateT (Trace PVParams) (Either String) ()
forall d (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Distribution d, Typeable (Support d), Monad m) =&gt;
String -&gt; d -&gt; Params d -&gt; Support d -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;doubleChildId&quot;</span></span><span> </span><span class="annot"><span class="annottext">MagicalID
</span><a href="PVGrammar.Prob.Simple.html#MagicalID"><span class="hs-identifier hs-var">MagicalID</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
Support MagicalID
</span><a href="#local-6989586621679477794"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-886"></span><span>
</span><span id="line-887"></span><span id="local-6989586621679477818"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleT"><span class="hs-identifier hs-type">sampleT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679477818"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#DoubleOrnament"><span class="hs-identifier hs-type">DoubleOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-888"></span><span id="sampleT"><span class="annot"><span class="annottext">sampleT :: Edge SPitch -&gt; m (Edge SPitch, [(Note SPitch, DoubleOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#sampleT"><span class="hs-identifier hs-var hs-var">sampleT</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679477864"><span class="annot"><span class="annottext">StartStop (Note SPitch)
</span><a href="#local-6989586621679477864"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477865"><span class="annot"><span class="annottext">StartStop (Note SPitch)
</span><a href="#local-6989586621679477865"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-889"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;elaborating T (smp): &quot; &lt;&gt; show (l, r)</span><span>
</span><span id="line-890"></span><span>  </span><span id="local-6989586621679477866"><span class="annot"><a href="#local-6989586621679477866"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Geometric1 -&gt; Accessor PVParams Beta -&gt; m (Support Geometric1)
forall p l.
(Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor PVParams p -&gt; m (Support l)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;elaborateRegular&quot;</span></span><span> </span><span class="annot"><span class="annottext">Geometric1
</span><span class="hs-identifier hs-var">Geometric1</span></span><span> </span><span class="annot"><span class="annottext">(Accessor PVParams Beta -&gt; m (Support Geometric1))
-&gt; Accessor PVParams Beta -&gt; m (Support Geometric1)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pElaborateRegular"><span class="hs-identifier hs-var">pElaborateRegular</span></a></span><span>
</span><span id="line-891"></span><span>  </span><span id="local-6989586621679477870"><span class="annot"><a href="#local-6989586621679477870"><span class="hs-identifier hs-var">children</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">permutationPlate</span></span><span> </span><span class="annot"><a href="#local-6989586621679477866"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679477872"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477872"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Note SPitch)
</span><a href="#local-6989586621679477864"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Note SPitch)
</span><a href="#local-6989586621679477865"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-892"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Note SPitch)
</span><a href="Common.html#Start"><span class="hs-identifier hs-var">Start</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Note SPitch)
</span><a href="Common.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-893"></span><span>      </span><span id="local-6989586621679477873"><span class="annot"><a href="#local-6989586621679477873"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m (Note SPitch)
forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m Geometric0,
 SampleCtx m MagicalOctaves, RandomInterpreter m PVParams) =&gt;
Int -&gt; m (Note SPitch)
</span><a href="PVGrammar.Prob.Simple.html#sampleRootNote"><span class="hs-identifier hs-var">sampleRootNote</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477872"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-894"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679477873"><span class="hs-identifier hs-type">child</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#RootNote"><span class="hs-identifier hs-type">RootNote</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-895"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span id="local-6989586621679477875"><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477875"><span class="hs-identifier hs-var">nl</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span id="local-6989586621679477876"><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477876"><span class="hs-identifier hs-var">nr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-896"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679477877"><span class="annot"><a href="#local-6989586621679477877"><span class="hs-identifier hs-var">child</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679477878"><span class="annot"><a href="#local-6989586621679477878"><span class="hs-identifier hs-var">orn</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Note SPitch -&gt; Note SPitch -&gt; m (Note SPitch, DoubleOrnament)
forall i (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m MagicalOctaves,
 SampleCtx m MagicalID, SampleCtx m Geometric0,
 SampleCtx m Geometric1, RandomInterpreter m PVParams) =&gt;
i -&gt; Note SPitch -&gt; Note SPitch -&gt; m (Note SPitch, DoubleOrnament)
</span><a href="PVGrammar.Prob.Simple.html#sampleDoubleChild"><span class="hs-identifier hs-var">sampleDoubleChild</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679477872"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477875"><span class="hs-identifier hs-var">nl</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477876"><span class="hs-identifier hs-var">nr</span></a></span><span>
</span><span id="line-897"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679477877"><span class="hs-identifier hs-type">child</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679477878"><span class="hs-identifier hs-type">orn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-898"></span><span>    </span><span class="annot"><span class="annottext">Edge SPitch
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Note SPitch, DoubleOrnament)
-&gt; m (Maybe (Note SPitch, DoubleOrnament))
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Note SPitch, DoubleOrnament)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-899"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679477864"><span class="hs-identifier hs-type">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679477865"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">catMaybes</span></span><span> </span><span class="annot"><a href="#local-6989586621679477870"><span class="hs-identifier hs-type">children</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-900"></span><span>
</span><span id="line-901"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeT"><span class="hs-identifier hs-type">observeT</span></a></span><span>
</span><span id="line-902"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#DoubleOrnament"><span class="hs-identifier hs-type">DoubleOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-903"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-904"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#DoubleOrnament"><span class="hs-identifier hs-type">DoubleOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-905"></span><span id="observeT"><span class="annot"><span class="annottext">observeT :: Map (Edge SPitch) [(Note SPitch, DoubleOrnament)]
-&gt; Edge SPitch
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (Edge SPitch, [(Note SPitch, DoubleOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#observeT"><span class="hs-identifier hs-var hs-var">observeT</span></a></span></span><span> </span><span id="local-6989586621679477879"><span class="annot"><span class="annottext">Map (Edge SPitch) [(Note SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679477879"><span class="hs-identifier hs-var">splitTs</span></a></span></span><span> </span><span id="local-6989586621679477880"><span class="annot"><span class="annottext">Edge SPitch
</span><a href="#local-6989586621679477880"><span class="hs-identifier hs-var">parents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-906"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;elaborating T (obs): &quot; &lt;&gt; show parents</span><span>
</span><span id="line-907"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477881"><span class="annot"><span class="annottext">children :: [(Note SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679477881"><span class="hs-identifier hs-var hs-var hs-var">children</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, DoubleOrnament)]
-&gt; Maybe [(Note SPitch, DoubleOrnament)]
-&gt; [(Note SPitch, DoubleOrnament)]
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Maybe [(Note SPitch, DoubleOrnament)]
 -&gt; [(Note SPitch, DoubleOrnament)])
-&gt; Maybe [(Note SPitch, DoubleOrnament)]
-&gt; [(Note SPitch, DoubleOrnament)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Edge SPitch
-&gt; Map (Edge SPitch) [(Note SPitch, DoubleOrnament)]
-&gt; Maybe [(Note SPitch, DoubleOrnament)]
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">Edge SPitch
</span><a href="#local-6989586621679477880"><span class="hs-identifier hs-var">parents</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Edge SPitch) [(Note SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679477879"><span class="hs-identifier hs-var">splitTs</span></a></span><span>
</span><span id="line-908"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; Geometric1
-&gt; Accessor PVParams Beta
-&gt; Support Geometric1
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-909"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;elaborateRegular&quot;</span></span><span>
</span><span id="line-910"></span><span>    </span><span class="annot"><span class="annottext">Geometric1
</span><span class="hs-identifier hs-var">Geometric1</span></span><span>
</span><span id="line-911"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pElaborateRegular"><span class="hs-identifier hs-var">pElaborateRegular</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-912"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Note SPitch, DoubleOrnament)] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679477881"><span class="hs-identifier hs-var">children</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-913"></span><span>  </span><span class="annot"><span class="annottext">[(Note SPitch, DoubleOrnament)]
-&gt; ((Note SPitch, DoubleOrnament)
    -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; StateT (Trace PVParams) (Either String) ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679477881"><span class="hs-identifier hs-var">children</span></a></span><span> </span><span class="annot"><span class="annottext">(((Note SPitch, DoubleOrnament)
  -&gt; StateT (Trace PVParams) (Either String) ())
 -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; ((Note SPitch, DoubleOrnament)
    -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679477887"><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477887"><span class="hs-identifier hs-var">child</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DoubleOrnament
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Edge SPitch
</span><a href="#local-6989586621679477880"><span class="hs-identifier hs-var">parents</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-914"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Note SPitch)
</span><a href="Common.html#Start"><span class="hs-identifier hs-var">Start</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Note SPitch)
</span><a href="Common.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-915"></span><span>      </span><span class="annot"><span class="annottext">Note SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeRootNote"><span class="hs-identifier hs-var">observeRootNote</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477887"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-916"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span id="local-6989586621679477888"><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477888"><span class="hs-identifier hs-var">pl</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span id="local-6989586621679477889"><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477889"><span class="hs-identifier hs-var">pr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-917"></span><span>      </span><span class="annot"><span class="annottext">Note SPitch
-&gt; Note SPitch
-&gt; Note SPitch
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeDoubleChild"><span class="hs-identifier hs-var">observeDoubleChild</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477888"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477889"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679477887"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-918"></span><span>    </span><span class="annot"><span class="annottext">Edge SPitch
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either String () -&gt; StateT (Trace PVParams) (Either String) ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (Trace PVParams) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Either String () -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; Either String () -&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Either String ()) -&gt; String -&gt; Either String ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Invalid parent edge &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Edge SPitch -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Edge SPitch
</span><a href="#local-6989586621679477880"><span class="hs-identifier hs-var">parents</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-919"></span><span>  </span><span class="annot"><span class="annottext">(Edge SPitch, [(Note SPitch, DoubleOrnament)])
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (Edge SPitch, [(Note SPitch, DoubleOrnament)])
forall a. a -&gt; StateT (Trace PVParams) (Either String) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Edge SPitch
</span><a href="#local-6989586621679477880"><span class="hs-identifier hs-var">parents</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679477881"><span class="hs-identifier hs-var">children</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-920"></span><span>
</span><span id="line-921"></span><span class="hs-comment">-- requires distance &gt;= M2</span><span>
</span><span id="line-922"></span><span id="local-6989586621679477890"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleChromPassing"><span class="hs-identifier hs-type">sampleChromPassing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679477890"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-923"></span><span id="sampleChromPassing"><span class="annot"><span class="annottext">sampleChromPassing :: SPitch -&gt; SPitch -&gt; m (SPitch, PassingOrnament)
</span><a href="PVGrammar.Prob.Simple.html#sampleChromPassing"><span class="hs-identifier hs-var hs-var">sampleChromPassing</span></a></span></span><span> </span><span id="local-6989586621679477923"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477923"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span id="local-6989586621679477924"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477924"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-924"></span><span>  </span><span id="local-6989586621679477925"><span class="annot"><a href="#local-6989586621679477925"><span class="hs-identifier hs-var">atLeft</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-925"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli -&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall p l.
(Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor PVParams p -&gt; m (Support l)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;connectChromaticLeftOverRight&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">(Accessor PVParams Beta -&gt; m (Support Bernoulli))
-&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-926"></span><span>      </span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span>
</span><span id="line-927"></span><span>        </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pConnectChromaticLeftOverRight"><span class="hs-identifier hs-var">pConnectChromaticLeftOverRight</span></a></span><span>
</span><span id="line-928"></span><span>  </span><span id="local-6989586621679477929"><span class="annot"><a href="#local-6989586621679477929"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleOctaveShift"><span class="hs-identifier hs-type">sampleOctaveShift</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;connectChromaticOctave&quot;</span></span><span>
</span><span id="line-929"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477930"><span class="annot"><a href="#local-6989586621679477930"><span class="hs-identifier hs-var hs-var">dir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">SIC -&gt; Ordering
forall i. Interval i =&gt; i -&gt; Ordering
</span><span class="hs-identifier hs-var">direction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477923"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">Pitch SIC -&gt; Pitch SIC -&gt; SIC
forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477924"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ordering -&gt; Ordering -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SInterval -&gt; SInterval
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SInterval -&gt; SInterval
forall i. Interval i =&gt; i -&gt; i
</span><span class="hs-identifier hs-var">down</span></span><span>
</span><span id="line-930"></span><span>      </span><span id="local-6989586621679477931"><span class="annot"><a href="#local-6989586621679477931"><span class="hs-identifier hs-var hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-931"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679477925"><span class="hs-identifier hs-var">atLeft</span></a></span><span>
</span><span id="line-932"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477923"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; SInterval -&gt; SPitch
forall {a}. AdditiveGroup a =&gt; Pitch a -&gt; a -&gt; Pitch a
</span><span class="hs-operator hs-var">+^</span></span><span> </span><span class="annot"><span class="annottext">SInterval -&gt; SInterval
</span><a href="#local-6989586621679477930"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="annot"><span class="annottext">SInterval
forall i. Chromatic i =&gt; i
</span><span class="hs-identifier hs-var">chromaticSemitone</span></span><span>
</span><span id="line-933"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477924"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; SInterval -&gt; SPitch
forall {a}. AdditiveGroup a =&gt; Pitch a -&gt; a -&gt; Pitch a
</span><span class="hs-operator hs-var">-^</span></span><span> </span><span class="annot"><span class="annottext">SInterval -&gt; SInterval
</span><a href="#local-6989586621679477930"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="annot"><span class="annottext">SInterval
forall i. Chromatic i =&gt; i
</span><span class="hs-identifier hs-var">chromaticSemitone</span></span><span>
</span><span id="line-934"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679477931"><span class="hs-identifier hs-type">child</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+^</span></span><span> </span><span class="annot"><a href="#local-6989586621679477929"><span class="hs-identifier hs-type">os</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingMid"><span class="hs-identifier hs-type">PassingMid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-935"></span><span>
</span><span id="line-936"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeChromPassing"><span class="hs-identifier hs-type">observeChromPassing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-937"></span><span id="observeChromPassing"><span class="annot"><span class="annottext">observeChromPassing :: SPitch
-&gt; SPitch -&gt; SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeChromPassing"><span class="hs-identifier hs-var hs-var">observeChromPassing</span></a></span></span><span> </span><span id="local-6989586621679477935"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477935"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span id="local-6989586621679477936"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477936"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span id="local-6989586621679477937"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477937"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-938"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679477938"><span class="annot"><span class="annottext">isLeft :: Bool
</span><a href="#local-6989586621679477938"><span class="hs-identifier hs-var hs-var hs-var">isLeft</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Int
forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477935"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Int
forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477937"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-939"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-940"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;connectChromaticLeftOverRight&quot;</span></span><span>
</span><span id="line-941"></span><span>    </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-942"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pConnectChromaticLeftOverRight"><span class="hs-identifier hs-var">pConnectChromaticLeftOverRight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-943"></span><span>    </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><a href="#local-6989586621679477938"><span class="hs-identifier hs-var">isLeft</span></a></span><span>
</span><span id="line-944"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; SInterval -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeOctaveShift"><span class="hs-identifier hs-var">observeOctaveShift</span></a></span><span>
</span><span id="line-945"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;connectChromaticOctave&quot;</span></span><span>
</span><span id="line-946"></span><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679477938"><span class="hs-identifier hs-var">isLeft</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477935"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477936"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; SPitch -&gt; SInterval
forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477937"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-947"></span><span>
</span><span id="line-948"></span><span id="local-6989586621679477942"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleMidPassing"><span class="hs-identifier hs-type">sampleMidPassing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679477942"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-949"></span><span id="sampleMidPassing"><span class="annot"><span class="annottext">sampleMidPassing :: SPitch -&gt; SPitch -&gt; m (SPitch, PassingOrnament)
</span><a href="PVGrammar.Prob.Simple.html#sampleMidPassing"><span class="hs-identifier hs-var hs-var">sampleMidPassing</span></a></span></span><span> </span><span id="local-6989586621679477968"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477968"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span id="local-6989586621679477969"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477969"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-950"></span><span>  </span><span id="local-6989586621679477970"><span class="annot"><a href="#local-6989586621679477970"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SPitch -&gt; m SPitch
forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m MagicalOctaves,
 SampleCtx m Geometric0, RandomInterpreter m PVParams) =&gt;
Bool -&gt; SPitch -&gt; m SPitch
</span><a href="PVGrammar.Prob.Simple.html#sampleNeighbor"><span class="hs-identifier hs-var">sampleNeighbor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SIC -&gt; Ordering
forall i. Interval i =&gt; i -&gt; Ordering
</span><span class="hs-identifier hs-var">direction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477968"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">Pitch SIC -&gt; Pitch SIC -&gt; SIC
forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477969"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ordering -&gt; Ordering -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477968"><span class="hs-identifier hs-var">pl</span></a></span><span>
</span><span id="line-951"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679477970"><span class="hs-identifier hs-type">child</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingMid"><span class="hs-identifier hs-type">PassingMid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-952"></span><span>
</span><span id="line-953"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeMidPassing"><span class="hs-identifier hs-type">observeMidPassing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-954"></span><span id="observeMidPassing"><span class="annot"><span class="annottext">observeMidPassing :: SPitch
-&gt; SPitch -&gt; SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeMidPassing"><span class="hs-identifier hs-var hs-var">observeMidPassing</span></a></span></span><span> </span><span id="local-6989586621679477972"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477972"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span id="local-6989586621679477973"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477973"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-955"></span><span>  </span><span class="annot"><span class="annottext">Bool
-&gt; SPitch -&gt; SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeNeighbor"><span class="hs-identifier hs-var">observeNeighbor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SIC -&gt; Ordering
forall i. Interval i =&gt; i -&gt; Ordering
</span><span class="hs-identifier hs-var">direction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477972"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">Pitch SIC -&gt; Pitch SIC -&gt; SIC
forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477973"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ordering -&gt; Ordering -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679477972"><span class="hs-identifier hs-var">pl</span></a></span><span>
</span><span id="line-956"></span><span>
</span><span id="line-957"></span><span id="local-6989586621679477974"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleNonMidPassing"><span class="hs-identifier hs-type">sampleNonMidPassing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679477974"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-958"></span><span id="sampleNonMidPassing"><span class="annot"><span class="annottext">sampleNonMidPassing :: SPitch -&gt; SPitch -&gt; m (SPitch, PassingOrnament)
</span><a href="PVGrammar.Prob.Simple.html#sampleNonMidPassing"><span class="hs-identifier hs-var hs-var">sampleNonMidPassing</span></a></span></span><span> </span><span id="local-6989586621679478009"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478009"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span id="local-6989586621679478010"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478010"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-959"></span><span>  </span><span id="local-6989586621679478011"><span class="annot"><a href="#local-6989586621679478011"><span class="hs-identifier hs-var">left</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-960"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli -&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall p l.
(Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor PVParams p -&gt; m (Support l)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;passLeftOverRight&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">(Accessor PVParams Beta -&gt; m (Support Bernoulli))
-&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pPassLeftOverRight"><span class="hs-identifier hs-var">pPassLeftOverRight</span></a></span><span>
</span><span id="line-961"></span><span>  </span><span class="hs-comment">-- TODO: sampling like this overgenerates, since it allows passing motions to change direction</span><span>
</span><span id="line-962"></span><span>  </span><span class="hs-comment">-- the direction of a passing edge should be tracked explicitly!</span><span>
</span><span id="line-963"></span><span>  </span><span id="local-6989586621679478015"><span class="annot"><a href="#local-6989586621679478015"><span class="hs-identifier hs-var">dirUp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sampleValue</span></span><span> </span><span class="annot"><span class="hs-string">&quot;passUp&quot;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bernoulli</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-type">pInner</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pPassUp"><span class="hs-identifier hs-type">pPassUp</span></a></span><span>
</span><span id="line-964"></span><span>  </span><span class="hs-comment">-- let dirUp = direction (pc pl `pto` pc pr) == GT</span><span>
</span><span id="line-965"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679478011"><span class="hs-identifier hs-type">left</span></a></span><span>
</span><span id="line-966"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-967"></span><span>      </span><span id="local-6989586621679478019"><span class="annot"><a href="#local-6989586621679478019"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleNeighbor"><span class="hs-identifier hs-type">sampleNeighbor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478015"><span class="hs-identifier hs-type">dirUp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478009"><span class="hs-identifier hs-type">pl</span></a></span><span>
</span><span id="line-968"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679478019"><span class="hs-identifier hs-type">child</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingLeft"><span class="hs-identifier hs-type">PassingLeft</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-969"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-970"></span><span>      </span><span id="local-6989586621679478020"><span class="annot"><a href="#local-6989586621679478020"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleNeighbor"><span class="hs-identifier hs-type">sampleNeighbor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621679478015"><span class="hs-identifier hs-type">dirUp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679478010"><span class="hs-identifier hs-type">pr</span></a></span><span>
</span><span id="line-971"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679478020"><span class="hs-identifier hs-type">child</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingRight"><span class="hs-identifier hs-type">PassingRight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-972"></span><span>
</span><span id="line-973"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeNonMidPassing"><span class="hs-identifier hs-type">observeNonMidPassing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-974"></span><span id="observeNonMidPassing"><span class="annot"><span class="annottext">observeNonMidPassing :: SPitch
-&gt; SPitch
-&gt; SPitch
-&gt; PassingOrnament
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeNonMidPassing"><span class="hs-identifier hs-var hs-var">observeNonMidPassing</span></a></span></span><span> </span><span id="local-6989586621679478023"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478023"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span id="local-6989586621679478024"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478024"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span id="local-6989586621679478025"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478025"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span id="local-6989586621679478026"><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679478026"><span class="hs-identifier hs-var">orn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-975"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679478027"><span class="annot"><span class="annottext">left :: Bool
</span><a href="#local-6989586621679478027"><span class="hs-identifier hs-var hs-var hs-var">left</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679478026"><span class="hs-identifier hs-var">orn</span></a></span><span> </span><span class="annot"><span class="annottext">PassingOrnament -&gt; PassingOrnament -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="PVGrammar.html#PassingLeft"><span class="hs-identifier hs-var">PassingLeft</span></a></span><span>
</span><span id="line-976"></span><span>      </span><span id="local-6989586621679478028"><span class="annot"><span class="annottext">dirUp :: Bool
</span><a href="#local-6989586621679478028"><span class="hs-identifier hs-var hs-var hs-var">dirUp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-977"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679478027"><span class="hs-identifier hs-var">left</span></a></span><span>
</span><span id="line-978"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SIC -&gt; Ordering
forall i. Interval i =&gt; i -&gt; Ordering
</span><span class="hs-identifier hs-var">direction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478023"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">Pitch SIC -&gt; Pitch SIC -&gt; SIC
forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478025"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ordering -&gt; Ordering -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span>
</span><span id="line-979"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SIC -&gt; Ordering
forall i. Interval i =&gt; i -&gt; Ordering
</span><span class="hs-identifier hs-var">direction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478024"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">Pitch SIC -&gt; Pitch SIC -&gt; SIC
forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478025"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ordering -&gt; Ordering -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">LT</span></span><span>
</span><span id="line-980"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;passLeftOverRight&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pPassLeftOverRight"><span class="hs-identifier hs-var">pPassLeftOverRight</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><a href="#local-6989586621679478027"><span class="hs-identifier hs-var">left</span></a></span><span>
</span><span id="line-981"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;passUp&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pPassUp"><span class="hs-identifier hs-var">pPassUp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><a href="#local-6989586621679478028"><span class="hs-identifier hs-var">dirUp</span></a></span><span>
</span><span id="line-982"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679478027"><span class="hs-identifier hs-var">left</span></a></span><span>
</span><span id="line-983"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SPitch -&gt; SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeNeighbor"><span class="hs-identifier hs-var">observeNeighbor</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679478028"><span class="hs-identifier hs-var">dirUp</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478023"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478025"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-984"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SPitch -&gt; SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeNeighbor"><span class="hs-identifier hs-var">observeNeighbor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679478028"><span class="hs-identifier hs-var">dirUp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478024"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478025"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-985"></span><span>
</span><span id="line-986"></span><span id="local-6989586621679478035"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleNT"><span class="hs-identifier hs-type">sampleNT</span></a></span><span>
</span><span id="line-987"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#InnerEdge"><span class="hs-identifier hs-type">InnerEdge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679478035"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#InnerEdge"><span class="hs-identifier hs-type">InnerEdge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-988"></span><span id="sampleNT"><span class="annot"><span class="annottext">sampleNT :: (InnerEdge SPitch, Int)
-&gt; m (InnerEdge SPitch, [(Note SPitch, PassingOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#sampleNT"><span class="hs-identifier hs-var hs-var">sampleNT</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679478093"><span class="annot"><span class="annottext">nl :: Note SPitch
</span><a href="#local-6989586621679478093"><span class="hs-identifier hs-var">nl</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span id="local-6989586621679478094"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478094"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span id="local-6989586621679478095"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679478095"><span class="hs-identifier hs-var">il</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478096"><span class="annot"><span class="annottext">nr :: Note SPitch
</span><a href="#local-6989586621679478096"><span class="hs-identifier hs-var">nr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span id="local-6989586621679478097"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478097"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span id="local-6989586621679478098"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679478098"><span class="hs-identifier hs-var">ir</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478099"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679478099"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-989"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;Elaborating edge (smp): &quot; &lt;&gt; show ((pl, pr), n)</span><span>
</span><span id="line-990"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679478100"><span class="annot"><span class="annottext">dist :: Int
</span><a href="#local-6989586621679478100"><span class="hs-identifier hs-var hs-var hs-var">dist</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SIC -&gt; Int
forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">(SIC -&gt; Int) -&gt; SIC -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SIC -&gt; SIC
forall i. Interval i =&gt; i -&gt; i
</span><span class="hs-identifier hs-var">iabs</span></span><span> </span><span class="annot"><span class="annottext">(SIC -&gt; SIC) -&gt; SIC -&gt; SIC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478094"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">Pitch SIC -&gt; Pitch SIC -&gt; SIC
forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478097"><span class="hs-identifier hs-var">pr</span></a></span><span>
</span><span id="line-991"></span><span>  </span><span class="hs-comment">-- DT.traceM    $  &quot;passing from &quot;    &lt;&gt; showNotation pl    &lt;&gt; &quot; to &quot;    &lt;&gt; showNotation pr    &lt;&gt; &quot;: &quot;    &lt;&gt; show dist    &lt;&gt; &quot; steps.&quot;</span><span>
</span><span id="line-992"></span><span>  </span><span id="local-6989586621679478101"><span class="annot"><a href="#local-6989586621679478101"><span class="hs-identifier hs-var">children</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; (Int -&gt; m (Note SPitch, PassingOrnament))
-&gt; m [(Note SPitch, PassingOrnament)]
forall a. Ord a =&gt; Int -&gt; (Int -&gt; m a) -&gt; m [a]
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) a.
(RandomInterpreter m r, Ord a) =&gt;
Int -&gt; (Int -&gt; m a) -&gt; m [a]
</span><span class="hs-identifier hs-var">permutationPlate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679478099"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; m (Note SPitch, PassingOrnament))
 -&gt; m [(Note SPitch, PassingOrnament)])
-&gt; (Int -&gt; m (Note SPitch, PassingOrnament))
-&gt; m [(Note SPitch, PassingOrnament)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679478102"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679478102"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-993"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679478103"><span class="annot"><a href="#local-6989586621679478103"><span class="hs-identifier hs-var">child</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478104"><span class="annot"><a href="#local-6989586621679478104"><span class="hs-identifier hs-var">orn</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679478100"><span class="hs-identifier hs-var">dist</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-994"></span><span>      </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; SPitch -&gt; m (SPitch, PassingOrnament)
forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m MagicalOctaves,
 RandomInterpreter m PVParams) =&gt;
SPitch -&gt; SPitch -&gt; m (SPitch, PassingOrnament)
</span><a href="PVGrammar.Prob.Simple.html#sampleChromPassing"><span class="hs-identifier hs-var">sampleChromPassing</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478094"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478097"><span class="hs-identifier hs-var">pr</span></a></span><span>
</span><span id="line-995"></span><span>      </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-996"></span><span>        </span><span id="local-6989586621679478105"><span class="annot"><a href="#local-6989586621679478105"><span class="hs-identifier hs-var">connect</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli -&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall p l.
(Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor PVParams p -&gt; m (Support l)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;passingConnect&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">(Accessor PVParams Beta -&gt; m (Support Bernoulli))
-&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pConnect"><span class="hs-identifier hs-var">pConnect</span></a></span><span>
</span><span id="line-997"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679478105"><span class="hs-identifier hs-type">connect</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleMidPassing"><span class="hs-identifier hs-type">sampleMidPassing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478094"><span class="hs-identifier hs-type">pl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478097"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleNonMidPassing"><span class="hs-identifier hs-type">sampleNonMidPassing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478094"><span class="hs-identifier hs-type">pl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478097"><span class="hs-identifier hs-type">pr</span></a></span><span>
</span><span id="line-998"></span><span>      </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; SPitch -&gt; m (SPitch, PassingOrnament)
forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m MagicalOctaves,
 SampleCtx m Geometric0, RandomInterpreter m PVParams) =&gt;
SPitch -&gt; SPitch -&gt; m (SPitch, PassingOrnament)
</span><a href="PVGrammar.Prob.Simple.html#sampleNonMidPassing"><span class="hs-identifier hs-var">sampleNonMidPassing</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478094"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478097"><span class="hs-identifier hs-var">pr</span></a></span><span>
</span><span id="line-999"></span><span>    </span><span id="local-6989586621679478109"><span class="annot"><a href="#local-6989586621679478109"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sampleConst</span></span><span> </span><span class="annot"><span class="hs-string">&quot;passingChildId&quot;</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalID"><span class="hs-identifier hs-type">MagicalID</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1000"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478103"><span class="hs-identifier hs-type">child</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621679478109"><span class="hs-identifier hs-type">cid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679478104"><span class="hs-identifier hs-type">orn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1001"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679478093"><span class="hs-identifier hs-type">nl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679478096"><span class="hs-identifier hs-type">nr</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679478101"><span class="hs-identifier hs-type">children</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1002"></span><span>
</span><span id="line-1003"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeNT"><span class="hs-identifier hs-type">observeNT</span></a></span><span>
</span><span id="line-1004"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-1005"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#InnerEdge"><span class="hs-identifier hs-type">InnerEdge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1006"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#InnerEdge"><span class="hs-identifier hs-type">InnerEdge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-1007"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#InnerEdge"><span class="hs-identifier hs-type">InnerEdge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1008"></span><span id="observeNT"><span class="annot"><span class="annottext">observeNT :: Map (InnerEdge SPitch) [(Note SPitch, PassingOrnament)]
-&gt; (InnerEdge SPitch, Int)
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (InnerEdge SPitch, [(Note SPitch, PassingOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#observeNT"><span class="hs-identifier hs-var hs-var">observeNT</span></a></span></span><span> </span><span id="local-6989586621679478146"><span class="annot"><span class="annottext">Map (InnerEdge SPitch) [(Note SPitch, PassingOrnament)]
</span><a href="#local-6989586621679478146"><span class="hs-identifier hs-var">splitNTs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679478147"><span class="annot"><span class="annottext">nl :: Note SPitch
</span><a href="#local-6989586621679478147"><span class="hs-identifier hs-var">nl</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span id="local-6989586621679478148"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478148"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478149"><span class="annot"><span class="annottext">nr :: Note SPitch
</span><a href="#local-6989586621679478149"><span class="hs-identifier hs-var">nr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span id="local-6989586621679478150"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478150"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478151"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679478151"><span class="hs-identifier hs-var">_n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1009"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;Elaborating edge (obs): &quot; &lt;&gt; show ((pl, pr), n)</span><span>
</span><span id="line-1010"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679478152"><span class="annot"><span class="annottext">children :: [(Note SPitch, PassingOrnament)]
</span><a href="#local-6989586621679478152"><span class="hs-identifier hs-var hs-var hs-var">children</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, PassingOrnament)]
-&gt; Maybe [(Note SPitch, PassingOrnament)]
-&gt; [(Note SPitch, PassingOrnament)]
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Maybe [(Note SPitch, PassingOrnament)]
 -&gt; [(Note SPitch, PassingOrnament)])
-&gt; Maybe [(Note SPitch, PassingOrnament)]
-&gt; [(Note SPitch, PassingOrnament)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InnerEdge SPitch
-&gt; Map (InnerEdge SPitch) [(Note SPitch, PassingOrnament)]
-&gt; Maybe [(Note SPitch, PassingOrnament)]
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679478147"><span class="hs-identifier hs-var">nl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679478149"><span class="hs-identifier hs-var">nr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map (InnerEdge SPitch) [(Note SPitch, PassingOrnament)]
</span><a href="#local-6989586621679478146"><span class="hs-identifier hs-var">splitNTs</span></a></span><span>
</span><span id="line-1011"></span><span>  </span><span class="annot"><span class="annottext">[(Note SPitch, PassingOrnament)]
-&gt; ((Note SPitch, PassingOrnament)
    -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; StateT (Trace PVParams) (Either String) ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, PassingOrnament)]
</span><a href="#local-6989586621679478152"><span class="hs-identifier hs-var">children</span></a></span><span> </span><span class="annot"><span class="annottext">(((Note SPitch, PassingOrnament)
  -&gt; StateT (Trace PVParams) (Either String) ())
 -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; ((Note SPitch, PassingOrnament)
    -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span id="local-6989586621679478153"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478153"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span id="local-6989586621679478154"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679478154"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478155"><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679478155"><span class="hs-identifier hs-var">orn</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1012"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SIC -&gt; Int
forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">(SIC -&gt; Int) -&gt; SIC -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SIC -&gt; SIC
forall i. Interval i =&gt; i -&gt; i
</span><span class="hs-identifier hs-var">iabs</span></span><span> </span><span class="annot"><span class="annottext">(SIC -&gt; SIC) -&gt; SIC -&gt; SIC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478148"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">Pitch SIC -&gt; Pitch SIC -&gt; SIC
forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478150"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1013"></span><span>      </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPitch
-&gt; SPitch -&gt; SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeChromPassing"><span class="hs-identifier hs-var">observeChromPassing</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478148"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478150"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478153"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-1014"></span><span>      </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679478155"><span class="hs-identifier hs-var">orn</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1015"></span><span>        </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="PVGrammar.html#PassingMid"><span class="hs-identifier hs-var">PassingMid</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1016"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;passingConnect&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pConnect"><span class="hs-identifier hs-var">pConnect</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1017"></span><span>          </span><span class="annot"><span class="annottext">SPitch
-&gt; SPitch -&gt; SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeMidPassing"><span class="hs-identifier hs-var">observeMidPassing</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478148"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478150"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478153"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-1018"></span><span>        </span><span class="annot"><span class="annottext">PassingOrnament
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1019"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;passingConnect&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pConnect"><span class="hs-identifier hs-var">pConnect</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1020"></span><span>          </span><span class="annot"><span class="annottext">SPitch
-&gt; SPitch
-&gt; SPitch
-&gt; PassingOrnament
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeNonMidPassing"><span class="hs-identifier hs-var">observeNonMidPassing</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478148"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478150"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478153"><span class="hs-identifier hs-var">child</span></a></span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679478155"><span class="hs-identifier hs-var">orn</span></a></span><span>
</span><span id="line-1021"></span><span>      </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPitch
-&gt; SPitch
-&gt; SPitch
-&gt; PassingOrnament
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeNonMidPassing"><span class="hs-identifier hs-var">observeNonMidPassing</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478148"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478150"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478153"><span class="hs-identifier hs-var">child</span></a></span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679478155"><span class="hs-identifier hs-var">orn</span></a></span><span>
</span><span id="line-1022"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; MagicalID
-&gt; Params MagicalID
-&gt; Support MagicalID
-&gt; StateT (Trace PVParams) (Either String) ()
forall d (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Distribution d, Typeable (Support d), Monad m) =&gt;
String -&gt; d -&gt; Params d -&gt; Support d -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;passingChildId&quot;</span></span><span> </span><span class="annot"><span class="annottext">MagicalID
</span><a href="PVGrammar.Prob.Simple.html#MagicalID"><span class="hs-identifier hs-var">MagicalID</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
Support MagicalID
</span><a href="#local-6989586621679478154"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-1023"></span><span>  </span><span class="annot"><span class="annottext">(InnerEdge SPitch, [(Note SPitch, PassingOrnament)])
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (InnerEdge SPitch, [(Note SPitch, PassingOrnament)])
forall a. a -&gt; StateT (Trace PVParams) (Either String) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679478147"><span class="hs-identifier hs-var">nl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679478149"><span class="hs-identifier hs-var">nr</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, PassingOrnament)]
</span><a href="#local-6989586621679478152"><span class="hs-identifier hs-var">children</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1024"></span><span>
</span><span id="line-1025"></span><span id="local-6989586621679478162"><span id="local-6989586621679478163"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSingleOrn"><span class="hs-identifier hs-type">sampleSingleOrn</span></a></span><span>
</span><span id="line-1026"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-1027"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-1028"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679478162"><span class="hs-identifier hs-type">o</span></a></span><span>
</span><span id="line-1029"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679478162"><span class="hs-identifier hs-type">o</span></a></span><span>
</span><span id="line-1030"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Accessor</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-1031"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679478163"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679478162"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1032"></span><span id="sampleSingleOrn"><span class="annot"><span class="annottext">sampleSingleOrn :: Note SPitch
-&gt; o
-&gt; o
-&gt; (forall (f :: * -&gt; *) (f :: * -&gt; *).
    Functor f =&gt;
    (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; m (Note SPitch, [(Note SPitch, o)])
</span><a href="PVGrammar.Prob.Simple.html#sampleSingleOrn"><span class="hs-identifier hs-var hs-var">sampleSingleOrn</span></a></span></span><span> </span><span id="local-6989586621679478223"><span class="annot"><span class="annottext">parent :: Note SPitch
</span><a href="#local-6989586621679478223"><span class="hs-identifier hs-var">parent</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span id="local-6989586621679478224"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478224"><span class="hs-identifier hs-var">ppitch</span></a></span></span><span> </span><span id="local-6989586621679478225"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679478225"><span class="hs-identifier hs-var">pid</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679478226"><span class="annot"><span class="annottext">o
</span><a href="#local-6989586621679478226"><span class="hs-identifier hs-var">oRepeat</span></a></span></span><span> </span><span id="local-6989586621679478227"><span class="annot"><span class="annottext">o
</span><a href="#local-6989586621679478227"><span class="hs-identifier hs-var">oNeighbor</span></a></span></span><span> </span><span id="local-6989586621679478228"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="#local-6989586621679478228"><span class="hs-identifier hs-var">pElaborate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1033"></span><span>  </span><span id="local-6989586621679478229"><span class="annot"><a href="#local-6989586621679478229"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Geometric0 -&gt; Accessor PVParams Beta -&gt; m (Support Geometric0)
forall p l.
(Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor PVParams p -&gt; m (Support l)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;elaborateSingle&quot;</span></span><span> </span><span class="annot"><span class="annottext">Geometric0
</span><span class="hs-identifier hs-var">Geometric0</span></span><span> </span><span class="annot"><span class="annottext">(Accessor PVParams Beta -&gt; m (Support Geometric0))
-&gt; Accessor PVParams Beta -&gt; m (Support Geometric0)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="#local-6989586621679478228"><span class="hs-identifier hs-var">pElaborate</span></a></span><span>
</span><span id="line-1034"></span><span>  </span><span id="local-6989586621679478233"><span class="annot"><a href="#local-6989586621679478233"><span class="hs-identifier hs-var">children</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">permutationPlate</span></span><span> </span><span class="annot"><a href="#local-6989586621679478229"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679478234"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679478234"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1035"></span><span>    </span><span id="local-6989586621679478235"><span class="annot"><a href="#local-6989586621679478235"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1036"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli -&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall p l.
(Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor PVParams p -&gt; m (Support l)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatOverNeighborSingle&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">(Accessor PVParams Beta -&gt; m (Support Bernoulli))
-&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1037"></span><span>        </span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span>
</span><span id="line-1038"></span><span>          </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatOverNeighbor"><span class="hs-identifier hs-var">pRepeatOverNeighbor</span></a></span><span>
</span><span id="line-1039"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679478235"><span class="hs-identifier hs-type">rep</span></a></span><span>
</span><span id="line-1040"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1041"></span><span>        </span><span id="local-6989586621679478239"><span class="annot"><a href="#local-6989586621679478239"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleOctaveShift"><span class="hs-identifier hs-type">sampleOctaveShift</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;singleChildOctave&quot;</span></span><span>
</span><span id="line-1042"></span><span>        </span><span id="local-6989586621679478240"><span class="annot"><a href="#local-6989586621679478240"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sampleConst</span></span><span> </span><span class="annot"><span class="hs-string">&quot;singleChildId&quot;</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalID"><span class="hs-identifier hs-type">MagicalID</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1043"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679478224"><span class="hs-identifier hs-type">ppitch</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+^</span></span><span> </span><span class="annot"><a href="#local-6989586621679478239"><span class="hs-identifier hs-type">os</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679478240"><span class="hs-identifier hs-type">cid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679478226"><span class="hs-identifier hs-type">oRepeat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1044"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1045"></span><span>        </span><span id="local-6989586621679478241"><span class="annot"><a href="#local-6989586621679478241"><span class="hs-identifier hs-var">stepUp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sampleConst</span></span><span> </span><span class="annot"><span class="hs-string">&quot;singleUp&quot;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bernoulli</span></span><span> </span><span class="annot"><span class="hs-number">0.5</span></span><span>
</span><span id="line-1046"></span><span>        </span><span id="local-6989586621679478242"><span class="annot"><a href="#local-6989586621679478242"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleNeighbor"><span class="hs-identifier hs-type">sampleNeighbor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478241"><span class="hs-identifier hs-type">stepUp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478224"><span class="hs-identifier hs-type">ppitch</span></a></span><span>
</span><span id="line-1047"></span><span>        </span><span id="local-6989586621679478243"><span class="annot"><a href="#local-6989586621679478243"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sampleConst</span></span><span> </span><span class="annot"><span class="hs-string">&quot;singleChildId&quot;</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalID"><span class="hs-identifier hs-type">MagicalID</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1048"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478242"><span class="hs-identifier hs-type">child</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478243"><span class="hs-identifier hs-type">cid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679478227"><span class="hs-identifier hs-type">oNeighbor</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1049"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679478223"><span class="hs-identifier hs-type">parent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679478233"><span class="hs-identifier hs-type">children</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1050"></span><span>
</span><span id="line-1051"></span><span id="local-6989586621679473856"><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeSingleOrn"><span class="hs-identifier hs-type">observeSingleOrn</span></a></span><span>
</span><span id="line-1052"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679473856"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1053"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-1054"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Accessor</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-1055"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679473856"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-1056"></span><span id="observeSingleOrn"><span class="annot"><span class="annottext">observeSingleOrn :: forall o.
Map (Note SPitch) [(Note SPitch, o)]
-&gt; Note SPitch
-&gt; (forall (f :: * -&gt; *) (f :: * -&gt; *).
    Functor f =&gt;
    (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVObs (Note SPitch, [(Note SPitch, o)])
</span><a href="PVGrammar.Prob.Simple.html#observeSingleOrn"><span class="hs-identifier hs-var hs-var">observeSingleOrn</span></a></span></span><span> </span><span id="local-6989586621679478291"><span class="annot"><span class="annottext">Map (Note SPitch) [(Note SPitch, o)]
</span><a href="#local-6989586621679478291"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621679478292"><span class="annot"><span class="annottext">parent :: Note SPitch
</span><a href="#local-6989586621679478292"><span class="hs-identifier hs-var">parent</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span id="local-6989586621679478293"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478293"><span class="hs-identifier hs-var">ppitch</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679478294"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="#local-6989586621679478294"><span class="hs-identifier hs-var">pElaborate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1057"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679478295"><span class="annot"><span class="annottext">children :: [(Note SPitch, o)]
</span><a href="#local-6989586621679478295"><span class="hs-identifier hs-var hs-var hs-var">children</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, o)]
-&gt; Maybe [(Note SPitch, o)] -&gt; [(Note SPitch, o)]
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Maybe [(Note SPitch, o)] -&gt; [(Note SPitch, o)])
-&gt; Maybe [(Note SPitch, o)] -&gt; [(Note SPitch, o)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Note SPitch
-&gt; Map (Note SPitch) [(Note SPitch, o)] -&gt; Maybe [(Note SPitch, o)]
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679478292"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Note SPitch) [(Note SPitch, o)]
</span><a href="#local-6989586621679478291"><span class="hs-identifier hs-var">table</span></a></span><span>
</span><span id="line-1058"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; Geometric0
-&gt; Accessor PVParams Beta
-&gt; Support Geometric0
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-1059"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;elaborateSingle&quot;</span></span><span>
</span><span id="line-1060"></span><span>    </span><span class="annot"><span class="annottext">Geometric0
</span><span class="hs-identifier hs-var">Geometric0</span></span><span>
</span><span id="line-1061"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="#local-6989586621679478294"><span class="hs-identifier hs-var">pElaborate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1062"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Note SPitch, o)] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, o)]
</span><a href="#local-6989586621679478295"><span class="hs-identifier hs-var">children</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1063"></span><span>  </span><span class="annot"><span class="annottext">[(Note SPitch, o)]
-&gt; ((Note SPitch, o) -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; StateT (Trace PVParams) (Either String) ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, o)]
</span><a href="#local-6989586621679478295"><span class="hs-identifier hs-var">children</span></a></span><span> </span><span class="annot"><span class="annottext">(((Note SPitch, o) -&gt; StateT (Trace PVParams) (Either String) ())
 -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; ((Note SPitch, o) -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span id="local-6989586621679478299"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478299"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span id="local-6989586621679478300"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679478300"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">o
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1064"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679478301"><span class="annot"><span class="annottext">rep :: Bool
</span><a href="#local-6989586621679478301"><span class="hs-identifier hs-var hs-var hs-var">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478299"><span class="hs-identifier hs-var">child</span></a></span><span> </span><span class="annot"><span class="annottext">Pitch SIC -&gt; Pitch SIC -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478293"><span class="hs-identifier hs-var">ppitch</span></a></span><span>
</span><span id="line-1065"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-1066"></span><span>      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatOverNeighborSingle&quot;</span></span><span>
</span><span id="line-1067"></span><span>      </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-1068"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatOverNeighbor"><span class="hs-identifier hs-var">pRepeatOverNeighbor</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1069"></span><span>      </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><a href="#local-6989586621679478301"><span class="hs-identifier hs-var">rep</span></a></span><span>
</span><span id="line-1070"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679478301"><span class="hs-identifier hs-var">rep</span></a></span><span>
</span><span id="line-1071"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1072"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; SInterval -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeOctaveShift"><span class="hs-identifier hs-var">observeOctaveShift</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;singleChildOctave&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478293"><span class="hs-identifier hs-var">ppitch</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; SPitch -&gt; SInterval
forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478299"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1073"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; MagicalID
-&gt; Params MagicalID
-&gt; Support MagicalID
-&gt; StateT (Trace PVParams) (Either String) ()
forall d (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Distribution d, Typeable (Support d), Monad m) =&gt;
String -&gt; d -&gt; Params d -&gt; Support d -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;singleChildId&quot;</span></span><span> </span><span class="annot"><span class="annottext">MagicalID
</span><a href="PVGrammar.Prob.Simple.html#MagicalID"><span class="hs-identifier hs-var">MagicalID</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
Support MagicalID
</span><a href="#local-6989586621679478300"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-1074"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1075"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679478305"><span class="annot"><span class="annottext">dir :: Ordering
</span><a href="#local-6989586621679478305"><span class="hs-identifier hs-var hs-var hs-var">dir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SIC -&gt; Ordering
forall i. Interval i =&gt; i -&gt; Ordering
</span><span class="hs-identifier hs-var">direction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478293"><span class="hs-identifier hs-var">ppitch</span></a></span><span> </span><span class="annot"><span class="annottext">Pitch SIC -&gt; Pitch SIC -&gt; SIC
forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478299"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1076"></span><span>            </span><span id="local-6989586621679478306"><span class="annot"><span class="annottext">up :: Bool
</span><a href="#local-6989586621679478306"><span class="hs-identifier hs-var hs-var hs-var">up</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ordering
</span><a href="#local-6989586621679478305"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="annot"><span class="annottext">Ordering -&gt; Ordering -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span>
</span><span id="line-1077"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Params Bernoulli
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall d (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Distribution d, Typeable (Support d), Monad m) =&gt;
String -&gt; d -&gt; Params d -&gt; Support d -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;singleUp&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">Double
Params Bernoulli
</span><span class="hs-number">0.5</span></span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><a href="#local-6989586621679478306"><span class="hs-identifier hs-var">up</span></a></span><span>
</span><span id="line-1078"></span><span>        </span><span class="annot"><span class="annottext">Bool
-&gt; SPitch -&gt; SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeNeighbor"><span class="hs-identifier hs-var">observeNeighbor</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679478306"><span class="hs-identifier hs-var">up</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478293"><span class="hs-identifier hs-var">ppitch</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679478299"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-1079"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; MagicalID
-&gt; Params MagicalID
-&gt; Support MagicalID
-&gt; StateT (Trace PVParams) (Either String) ()
forall d (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Distribution d, Typeable (Support d), Monad m) =&gt;
String -&gt; d -&gt; Params d -&gt; Support d -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;singleChildId&quot;</span></span><span> </span><span class="annot"><span class="annottext">MagicalID
</span><a href="PVGrammar.Prob.Simple.html#MagicalID"><span class="hs-identifier hs-var">MagicalID</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
Support MagicalID
</span><a href="#local-6989586621679478300"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-1080"></span><span>  </span><span class="annot"><span class="annottext">(Note SPitch, [(Note SPitch, o)])
-&gt; StateT
     (Trace PVParams) (Either String) (Note SPitch, [(Note SPitch, o)])
forall a. a -&gt; StateT (Trace PVParams) (Either String) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679478292"><span class="hs-identifier hs-var">parent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, o)]
</span><a href="#local-6989586621679478295"><span class="hs-identifier hs-var">children</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1081"></span><span>
</span><span id="line-1082"></span><span id="local-6989586621679478307"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleL"><span class="hs-identifier hs-type">sampleL</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679478307"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#RightOrnament"><span class="hs-identifier hs-type">RightOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-1083"></span><span id="sampleL"><span class="annot"><span class="annottext">sampleL :: Note SPitch -&gt; m (Note SPitch, [(Note SPitch, RightOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#sampleL"><span class="hs-identifier hs-var hs-var">sampleL</span></a></span></span><span> </span><span id="local-6989586621679478326"><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679478326"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Note SPitch
-&gt; RightOrnament
-&gt; RightOrnament
-&gt; (forall (f :: * -&gt; *) (f :: * -&gt; *).
    Functor f =&gt;
    (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; m (Note SPitch, [(Note SPitch, RightOrnament)])
forall o (m :: * -&gt; *).
(SampleCtx m Geometric0, SampleCtx m Bernoulli,
 SampleCtx m MagicalOctaves, SampleCtx m MagicalID,
 RandomInterpreter m PVParams, Ord o) =&gt;
Note SPitch
-&gt; o
-&gt; o
-&gt; (forall (f :: * -&gt; *) (f :: * -&gt; *).
    Functor f =&gt;
    (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; m (Note SPitch, [(Note SPitch, o)])
</span><a href="PVGrammar.Prob.Simple.html#sampleSingleOrn"><span class="hs-identifier hs-var">sampleSingleOrn</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679478326"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">RightOrnament
</span><a href="PVGrammar.html#RightRepeat"><span class="hs-identifier hs-var">RightRepeat</span></a></span><span> </span><span class="annot"><span class="annottext">RightOrnament
</span><a href="PVGrammar.html#RightNeighbor"><span class="hs-identifier hs-var">RightNeighbor</span></a></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pElaborateL"><span class="hs-identifier hs-var">pElaborateL</span></a></span><span>
</span><span id="line-1084"></span><span>
</span><span id="line-1085"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeL"><span class="hs-identifier hs-type">observeL</span></a></span><span>
</span><span id="line-1086"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#RightOrnament"><span class="hs-identifier hs-type">RightOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1087"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-1088"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#RightOrnament"><span class="hs-identifier hs-type">RightOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1089"></span><span id="observeL"><span class="annot"><span class="annottext">observeL :: Map (Note SPitch) [(Note SPitch, RightOrnament)]
-&gt; Note SPitch
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (Note SPitch, [(Note SPitch, RightOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#observeL"><span class="hs-identifier hs-var hs-var">observeL</span></a></span></span><span> </span><span id="local-6989586621679478331"><span class="annot"><span class="annottext">Map (Note SPitch) [(Note SPitch, RightOrnament)]
</span><a href="#local-6989586621679478331"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span id="local-6989586621679478332"><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679478332"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (Note SPitch) [(Note SPitch, RightOrnament)]
-&gt; Note SPitch
-&gt; (forall (f :: * -&gt; *) (f :: * -&gt; *).
    Functor f =&gt;
    (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (Note SPitch, [(Note SPitch, RightOrnament)])
forall o.
Map (Note SPitch) [(Note SPitch, o)]
-&gt; Note SPitch
-&gt; (forall (f :: * -&gt; *) (f :: * -&gt; *).
    Functor f =&gt;
    (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVObs (Note SPitch, [(Note SPitch, o)])
</span><a href="PVGrammar.Prob.Simple.html#observeSingleOrn"><span class="hs-identifier hs-var">observeSingleOrn</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Note SPitch) [(Note SPitch, RightOrnament)]
</span><a href="#local-6989586621679478331"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679478332"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pElaborateL"><span class="hs-identifier hs-var">pElaborateL</span></a></span><span>
</span><span id="line-1090"></span><span>
</span><span id="line-1091"></span><span id="local-6989586621679478335"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleR"><span class="hs-identifier hs-type">sampleR</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679478335"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#LeftOrnament"><span class="hs-identifier hs-type">LeftOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-1092"></span><span id="sampleR"><span class="annot"><span class="annottext">sampleR :: Note SPitch -&gt; m (Note SPitch, [(Note SPitch, LeftOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#sampleR"><span class="hs-identifier hs-var hs-var">sampleR</span></a></span></span><span> </span><span id="local-6989586621679478354"><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679478354"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Note SPitch
-&gt; LeftOrnament
-&gt; LeftOrnament
-&gt; (forall (f :: * -&gt; *) (f :: * -&gt; *).
    Functor f =&gt;
    (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; m (Note SPitch, [(Note SPitch, LeftOrnament)])
forall o (m :: * -&gt; *).
(SampleCtx m Geometric0, SampleCtx m Bernoulli,
 SampleCtx m MagicalOctaves, SampleCtx m MagicalID,
 RandomInterpreter m PVParams, Ord o) =&gt;
Note SPitch
-&gt; o
-&gt; o
-&gt; (forall (f :: * -&gt; *) (f :: * -&gt; *).
    Functor f =&gt;
    (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; m (Note SPitch, [(Note SPitch, o)])
</span><a href="PVGrammar.Prob.Simple.html#sampleSingleOrn"><span class="hs-identifier hs-var">sampleSingleOrn</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679478354"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">LeftOrnament
</span><a href="PVGrammar.html#LeftRepeat"><span class="hs-identifier hs-var">LeftRepeat</span></a></span><span> </span><span class="annot"><span class="annottext">LeftOrnament
</span><a href="PVGrammar.html#LeftNeighbor"><span class="hs-identifier hs-var">LeftNeighbor</span></a></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pElaborateR"><span class="hs-identifier hs-var">pElaborateR</span></a></span><span>
</span><span id="line-1093"></span><span>
</span><span id="line-1094"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeR"><span class="hs-identifier hs-type">observeR</span></a></span><span>
</span><span id="line-1095"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#LeftOrnament"><span class="hs-identifier hs-type">LeftOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1096"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-1097"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#LeftOrnament"><span class="hs-identifier hs-type">LeftOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1098"></span><span id="observeR"><span class="annot"><span class="annottext">observeR :: Map (Note SPitch) [(Note SPitch, LeftOrnament)]
-&gt; Note SPitch
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (Note SPitch, [(Note SPitch, LeftOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#observeR"><span class="hs-identifier hs-var hs-var">observeR</span></a></span></span><span> </span><span id="local-6989586621679478359"><span class="annot"><span class="annottext">Map (Note SPitch) [(Note SPitch, LeftOrnament)]
</span><a href="#local-6989586621679478359"><span class="hs-identifier hs-var">rs</span></a></span></span><span> </span><span id="local-6989586621679478360"><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679478360"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (Note SPitch) [(Note SPitch, LeftOrnament)]
-&gt; Note SPitch
-&gt; (forall (f :: * -&gt; *) (f :: * -&gt; *).
    Functor f =&gt;
    (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; StateT
     (Trace PVParams)
     (Either String)
     (Note SPitch, [(Note SPitch, LeftOrnament)])
forall o.
Map (Note SPitch) [(Note SPitch, o)]
-&gt; Note SPitch
-&gt; (forall (f :: * -&gt; *) (f :: * -&gt; *).
    Functor f =&gt;
    (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVObs (Note SPitch, [(Note SPitch, o)])
</span><a href="PVGrammar.Prob.Simple.html#observeSingleOrn"><span class="hs-identifier hs-var">observeSingleOrn</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Note SPitch) [(Note SPitch, LeftOrnament)]
</span><a href="#local-6989586621679478359"><span class="hs-identifier hs-var">rs</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679478360"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pElaborateR"><span class="hs-identifier hs-var">pElaborateR</span></a></span><span>
</span><span id="line-1099"></span><span>
</span><span id="line-1100"></span><span id="local-6989586621679478363"><span id="local-6989586621679478364"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleKeepEdges"><span class="hs-identifier hs-type">sampleKeepEdges</span></a></span><span>
</span><span id="line-1101"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Accessor</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="annot"><a href="#local-6989586621679478363"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679478364"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="annot"><a href="#local-6989586621679478363"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1102"></span><span id="sampleKeepEdges"><span class="annot"><span class="annottext">sampleKeepEdges :: (forall (f :: * -&gt; *) (f :: * -&gt; *).
 Functor f =&gt;
 (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; HashSet e -&gt; m (HashSet e)
</span><a href="PVGrammar.Prob.Simple.html#sampleKeepEdges"><span class="hs-identifier hs-var hs-var">sampleKeepEdges</span></a></span></span><span> </span><span id="local-6989586621679478393"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="#local-6989586621679478393"><span class="hs-identifier hs-var">pKeep</span></a></span></span><span> </span><span id="local-6989586621679478394"><span class="annot"><span class="annottext">HashSet e
</span><a href="#local-6989586621679478394"><span class="hs-identifier hs-var">set</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1103"></span><span>  </span><span id="local-6989586621679478395"><span class="annot"><a href="#local-6989586621679478395"><span class="hs-identifier hs-var">kept</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(e -&gt; m (Maybe e)) -&gt; [e] -&gt; m [Maybe e]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">e -&gt; m (Maybe e)
</span><a href="#local-6989586621679478396"><span class="hs-identifier hs-var">sKeep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[e] -&gt; [e]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">([e] -&gt; [e]) -&gt; [e] -&gt; [e]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet e -&gt; [e]
forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet e
</span><a href="#local-6989586621679478394"><span class="hs-identifier hs-var">set</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1104"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.fromList</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">catMaybes</span></span><span> </span><span class="annot"><a href="#local-6989586621679478395"><span class="hs-identifier hs-type">kept</span></a></span><span>
</span><span id="line-1105"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1106"></span><span>  </span><span id="local-6989586621679478396"><span class="annot"><span class="annottext">sKeep :: e -&gt; m (Maybe e)
</span><a href="#local-6989586621679478396"><span class="hs-identifier hs-var hs-var">sKeep</span></a></span></span><span> </span><span id="local-6989586621679478397"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679478397"><span class="hs-identifier hs-var">elt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1107"></span><span>    </span><span id="local-6989586621679478398"><span class="annot"><a href="#local-6989586621679478398"><span class="hs-identifier hs-var">keep</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli -&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall p l.
(Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor PVParams p -&gt; m (Support l)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;keep&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="#local-6989586621679478393"><span class="hs-identifier hs-var">pKeep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1108"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679478398"><span class="hs-identifier hs-type">keep</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621679478397"><span class="hs-identifier hs-type">elt</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>
</span><span id="line-1109"></span><span>
</span><span id="line-1110"></span><span id="local-6989586621679473742"><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeKeepEdges"><span class="hs-identifier hs-type">observeKeepEdges</span></a></span><span>
</span><span id="line-1111"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679473742"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679473742"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679473742"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1112"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Accessor</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-1113"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="annot"><a href="#local-6989586621679473742"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-1114"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="annot"><a href="#local-6989586621679473742"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-1115"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-1116"></span><span id="observeKeepEdges"><span class="annot"><span class="annottext">observeKeepEdges :: forall e.
(Eq e, Hashable e, Ord e) =&gt;
(forall (f :: * -&gt; *) (f :: * -&gt; *).
 Functor f =&gt;
 (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; HashSet e
-&gt; HashSet e
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeKeepEdges"><span class="hs-identifier hs-var hs-var">observeKeepEdges</span></a></span></span><span> </span><span id="local-6989586621679478417"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="#local-6989586621679478417"><span class="hs-identifier hs-var">pKeep</span></a></span></span><span> </span><span id="local-6989586621679478418"><span class="annot"><span class="annottext">HashSet e
</span><a href="#local-6989586621679478418"><span class="hs-identifier hs-var">candidates</span></a></span></span><span> </span><span id="local-6989586621679478419"><span class="annot"><span class="annottext">HashSet e
</span><a href="#local-6989586621679478419"><span class="hs-identifier hs-var">kept</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1117"></span><span>  </span><span class="annot"><span class="annottext">(e -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; [e] -&gt; StateT (Trace PVParams) (Either String) ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span>
</span><span id="line-1118"></span><span>    </span><span class="annot"><span class="annottext">e -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="#local-6989586621679478421"><span class="hs-identifier hs-var">oKeep</span></a></span><span>
</span><span id="line-1119"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[e] -&gt; [e]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">([e] -&gt; [e]) -&gt; [e] -&gt; [e]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet e -&gt; [e]
forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet e
</span><a href="#local-6989586621679478418"><span class="hs-identifier hs-var">candidates</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1120"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1121"></span><span>  </span><span id="local-6989586621679478421"><span class="annot"><span class="annottext">oKeep :: e -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="#local-6989586621679478421"><span class="hs-identifier hs-var hs-var">oKeep</span></a></span></span><span> </span><span id="local-6989586621679478422"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679478422"><span class="hs-identifier hs-var">edge</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1122"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;keep&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="#local-6989586621679478417"><span class="hs-identifier hs-var">pKeep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">e -&gt; HashSet e -&gt; Bool
forall a. (Eq a, Hashable a) =&gt; a -&gt; HashSet a -&gt; Bool
</span><span class="hs-identifier hs-var">S.member</span></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679478422"><span class="hs-identifier hs-var">edge</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet e
</span><a href="#local-6989586621679478419"><span class="hs-identifier hs-var">kept</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1123"></span><span>
</span><span id="line-1124"></span><span id="local-6989586621679478427"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSpread"><span class="hs-identifier hs-type">sampleSpread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextDouble"><span class="hs-identifier hs-type">ContextDouble</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679478427"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-1125"></span><span id="sampleSpread"><span class="annot"><span class="annottext">sampleSpread :: ContextDouble SPitch -&gt; m (Spread SPitch)
</span><a href="PVGrammar.Prob.Simple.html#sampleSpread"><span class="hs-identifier hs-var hs-var">sampleSpread</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679478484"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679478484"><span class="hs-identifier hs-var">_sliceL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478485"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679478485"><span class="hs-identifier hs-var">_transL</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679478486"><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679478486"><span class="hs-identifier hs-var">sliceM</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478487"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679478487"><span class="hs-identifier hs-var">_transR</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478488"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679478488"><span class="hs-identifier hs-var">_sliceR</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1126"></span><span>  </span><span class="hs-comment">-- distribute notes</span><span>
</span><span id="line-1127"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679478489"><span class="annot"><span class="annottext">notes :: [Note SPitch]
</span><a href="#local-6989586621679478489"><span class="hs-identifier hs-var hs-var hs-var">notes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Note SPitch] -&gt; [Note SPitch]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">([Note SPitch] -&gt; [Note SPitch]) -&gt; [Note SPitch] -&gt; [Note SPitch]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch) -&gt; [Note SPitch]
forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679478486"><span class="hs-identifier hs-var">sliceM</span></a></span><span>
</span><span id="line-1128"></span><span>  </span><span id="local-6989586621679478490"><span class="annot"><a href="#local-6989586621679478490"><span class="hs-identifier hs-var">dists</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Note SPitch -&gt; m (SpreadChildren SPitch))
-&gt; [Note SPitch] -&gt; m [SpreadChildren SPitch]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Note SPitch -&gt; m (SpreadChildren SPitch)
forall {m :: * -&gt; *} {n}.
(SampleCtx m (Categorical 3), RandomInterpreter m PVParams) =&gt;
Note n -&gt; m (SpreadChildren n)
</span><a href="#local-6989586621679478491"><span class="hs-identifier hs-var">distNote</span></a></span><span> </span><span class="annot"><span class="annottext">[Note SPitch]
</span><a href="#local-6989586621679478489"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-1129"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;dists (sm):&quot; &lt;&gt; show dists</span><span>
</span><span id="line-1130"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679478492"><span class="annot"><a href="#local-6989586621679478492"><span class="hs-identifier hs-var hs-var">notesLeft</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SpreadChildren SPitch -&gt; Maybe (Note SPitch))
-&gt; [SpreadChildren SPitch] -&gt; [Note SPitch]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">SpreadChildren SPitch -&gt; Maybe (Note SPitch)
forall n. SpreadChildren n -&gt; Maybe (Note n)
</span><a href="PVGrammar.html#leftSpreadChild"><span class="hs-identifier hs-var">leftSpreadChild</span></a></span><span> </span><span class="annot"><span class="annottext">[SpreadChildren SPitch]
</span><a href="#local-6989586621679478490"><span class="hs-identifier hs-var">dists</span></a></span><span>
</span><span id="line-1131"></span><span>      </span><span id="local-6989586621679478494"><span class="annot"><a href="#local-6989586621679478494"><span class="hs-identifier hs-var hs-var">notesRight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SpreadChildren SPitch -&gt; Maybe (Note SPitch))
-&gt; [SpreadChildren SPitch] -&gt; [Note SPitch]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">SpreadChildren SPitch -&gt; Maybe (Note SPitch)
forall n. SpreadChildren n -&gt; Maybe (Note n)
</span><a href="PVGrammar.html#rightSpreadChild"><span class="hs-identifier hs-var">rightSpreadChild</span></a></span><span> </span><span class="annot"><span class="annottext">[SpreadChildren SPitch]
</span><a href="#local-6989586621679478490"><span class="hs-identifier hs-var">dists</span></a></span><span>
</span><span id="line-1132"></span><span>  </span><span class="hs-comment">-- generate repetition edges</span><span>
</span><span id="line-1133"></span><span>  </span><span id="local-6989586621679478496"><span class="annot"><a href="#local-6989586621679478496"><span class="hs-identifier hs-var">repeats</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sequence</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1134"></span><span>    </span><span class="hs-comment">-- List</span><span>
</span><span id="line-1135"></span><span>    </span><span id="local-6989586621679478498"><span class="annot"><a href="#local-6989586621679478498"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679478492"><span class="hs-identifier hs-type">notesLeft</span></a></span><span>
</span><span id="line-1136"></span><span>    </span><span id="local-6989586621679478499"><span class="annot"><a href="#local-6989586621679478499"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679478494"><span class="hs-identifier hs-type">notesRight</span></a></span><span>
</span><span id="line-1137"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">guard</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">pc</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#notePitch"><span class="hs-identifier hs-var">notePitch</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478498"><span class="hs-identifier hs-type">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">pc</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#notePitch"><span class="hs-identifier hs-var">notePitch</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478499"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1138"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1139"></span><span>      </span><span class="hs-comment">-- m</span><span>
</span><span id="line-1140"></span><span>      </span><span id="local-6989586621679478501"><span class="annot"><a href="#local-6989586621679478501"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1141"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">sampleValue</span></span><span> </span><span class="annot"><span class="hs-string">&quot;spreadRepeatEdge&quot;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bernoulli</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1142"></span><span>          </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-type">pInner</span></a></span><span>
</span><span id="line-1143"></span><span>            </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pSpreadRepetitionEdge"><span class="hs-identifier hs-type">pSpreadRepetitionEdge</span></a></span><span>
</span><span id="line-1144"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679478501"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478498"><span class="hs-identifier hs-type">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478499"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>
</span><span id="line-1145"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679478505"><span class="annot"><a href="#local-6989586621679478505"><span class="hs-identifier hs-var hs-var">repEdges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Edge SPitch] -&gt; HashSet (Edge SPitch)
forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">([Edge SPitch] -&gt; HashSet (Edge SPitch))
-&gt; [Edge SPitch] -&gt; HashSet (Edge SPitch)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (Edge SPitch)] -&gt; [Edge SPitch]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (Edge SPitch)]
</span><a href="#local-6989586621679478496"><span class="hs-identifier hs-var">repeats</span></a></span><span>
</span><span id="line-1146"></span><span>  </span><span class="hs-comment">-- generate passing edges</span><span>
</span><span id="line-1147"></span><span>  </span><span id="local-6989586621679478506"><span class="annot"><a href="#local-6989586621679478506"><span class="hs-identifier hs-var">passEdges</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#samplePassing"><span class="hs-identifier hs-type">samplePassing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478492"><span class="hs-identifier hs-type">notesLeft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478494"><span class="hs-identifier hs-type">notesRight</span></a></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pNewPassingMid"><span class="hs-identifier hs-type">pNewPassingMid</span></a></span><span>
</span><span id="line-1148"></span><span>  </span><span class="hs-comment">-- construct result</span><span>
</span><span id="line-1149"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679478509"><span class="annot"><a href="#local-6989586621679478509"><span class="hs-identifier hs-var hs-var">distMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Note SPitch, SpreadChildren SPitch)]
-&gt; HashMap (Note SPitch) (SpreadChildren SPitch)
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HM.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Note SPitch]
-&gt; [SpreadChildren SPitch]
-&gt; [(Note SPitch, SpreadChildren SPitch)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Note SPitch]
</span><a href="#local-6989586621679478489"><span class="hs-identifier hs-var">notes</span></a></span><span> </span><span class="annot"><span class="annottext">[SpreadChildren SPitch]
</span><a href="#local-6989586621679478490"><span class="hs-identifier hs-var">dists</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1150"></span><span>      </span><span id="local-6989586621679478511"><span class="annot"><a href="#local-6989586621679478511"><span class="hs-identifier hs-var hs-var">edges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
-&gt; MultiSet (InnerEdge SPitch) -&gt; Edges SPitch
forall n. HashSet (Edge n) -&gt; MultiSet (InnerEdge n) -&gt; Edges n
</span><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-var">Edges</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679478505"><span class="hs-identifier hs-var">repEdges</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679478506"><span class="hs-identifier hs-var">passEdges</span></a></span><span>
</span><span id="line-1151"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="PVGrammar.html#SpreadOp"><span class="hs-identifier hs-type">SpreadOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478509"><span class="hs-identifier hs-type">distMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478511"><span class="hs-identifier hs-type">edges</span></a></span><span>
</span><span id="line-1152"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1153"></span><span>  </span><span id="local-6989586621679478514"><span class="annot"><span class="annottext">leftifyID :: Note n -&gt; Note n
</span><a href="#local-6989586621679478514"><span class="hs-identifier hs-var hs-var">leftifyID</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span id="local-6989586621679478515"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679478515"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679478516"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679478516"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">n -&gt; String -&gt; Note n
forall n. n -&gt; String -&gt; Note n
</span><a href="PVGrammar.html#Note"><span class="hs-identifier hs-var">Note</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679478515"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679478516"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;l&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-1154"></span><span>  </span><span id="local-6989586621679478518"><span class="annot"><span class="annottext">rightifyID :: Note n -&gt; Note n
</span><a href="#local-6989586621679478518"><span class="hs-identifier hs-var hs-var">rightifyID</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span id="local-6989586621679478519"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679478519"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679478520"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679478520"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">n -&gt; String -&gt; Note n
forall n. n -&gt; String -&gt; Note n
</span><a href="PVGrammar.html#Note"><span class="hs-identifier hs-var">Note</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679478519"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679478520"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;r&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-1155"></span><span>  </span><span class="hs-comment">-- distribute a note to the two child slices</span><span>
</span><span id="line-1156"></span><span>  </span><span id="local-6989586621679478491"><span class="annot"><span class="annottext">distNote :: Note n -&gt; m (SpreadChildren n)
</span><a href="#local-6989586621679478491"><span class="hs-identifier hs-var hs-var">distNote</span></a></span></span><span> </span><span id="local-6989586621679478544"><span class="annot"><span class="annottext">Note n
</span><a href="#local-6989586621679478544"><span class="hs-identifier hs-var">note</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1157"></span><span>    </span><span id="local-6989586621679478545"><span class="annot"><a href="#local-6989586621679478545"><span class="hs-identifier hs-var">dir</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1158"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Categorical 3
-&gt; Accessor PVParams (Dirichlet 3)
-&gt; m (Support (Categorical 3))
forall p l.
(Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor PVParams p -&gt; m (Support l)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;noteSpreadDirection&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (n :: Nat). Categorical n
</span><span class="hs-identifier hs-var">Categorical</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Accessor PVParams (Dirichlet 3) -&gt; m (Support (Categorical 3)))
-&gt; Accessor PVParams (Dirichlet 3) -&gt; m (Support (Categorical 3))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1159"></span><span>        </span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span>
</span><span id="line-1160"></span><span>          </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f (Dirichlet 3) -&gt; f (f (Dirichlet 3)))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f (Dirichlet 3) -&gt; f (f (Dirichlet 3)))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f (Dirichlet 3) -&gt; f (f (Dirichlet 3)))
-&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f (Dirichlet 3) -&gt; f (f (Dirichlet 3)))
-&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pNoteSpreadDirection"><span class="hs-identifier hs-var">pNoteSpreadDirection</span></a></span><span>
</span><span id="line-1161"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679478545"><span class="hs-identifier hs-type">dir</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1162"></span><span>      </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Note n -&gt; Note n -&gt; SpreadChildren n
forall n. Note n -&gt; Note n -&gt; SpreadChildren n
</span><a href="PVGrammar.html#SpreadBothChildren"><span class="hs-identifier hs-var">SpreadBothChildren</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Note n -&gt; Note n
forall {n}. Note n -&gt; Note n
</span><a href="#local-6989586621679478514"><span class="hs-identifier hs-var">leftifyID</span></a></span><span> </span><span class="annot"><span class="annottext">Note n
</span><a href="#local-6989586621679478544"><span class="hs-identifier hs-var">note</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Note n -&gt; Note n
forall {n}. Note n -&gt; Note n
</span><a href="#local-6989586621679478518"><span class="hs-identifier hs-var">rightifyID</span></a></span><span> </span><span class="annot"><span class="annottext">Note n
</span><a href="#local-6989586621679478544"><span class="hs-identifier hs-var">note</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1163"></span><span>      </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Note n -&gt; SpreadChildren n
forall n. Note n -&gt; SpreadChildren n
</span><a href="PVGrammar.html#SpreadLeftChild"><span class="hs-identifier hs-var">SpreadLeftChild</span></a></span><span> </span><span class="annot"><span class="annottext">(Note n -&gt; SpreadChildren n) -&gt; Note n -&gt; SpreadChildren n
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Note n -&gt; Note n
forall {n}. Note n -&gt; Note n
</span><a href="#local-6989586621679478514"><span class="hs-identifier hs-var">leftifyID</span></a></span><span> </span><span class="annot"><span class="annottext">Note n
</span><a href="#local-6989586621679478544"><span class="hs-identifier hs-var">note</span></a></span><span>
</span><span id="line-1164"></span><span>      </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Note n -&gt; SpreadChildren n
forall n. Note n -&gt; SpreadChildren n
</span><a href="PVGrammar.html#SpreadRightChild"><span class="hs-identifier hs-var">SpreadRightChild</span></a></span><span> </span><span class="annot"><span class="annottext">(Note n -&gt; SpreadChildren n) -&gt; Note n -&gt; SpreadChildren n
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Note n -&gt; Note n
forall {n}. Note n -&gt; Note n
</span><a href="#local-6989586621679478518"><span class="hs-identifier hs-var">rightifyID</span></a></span><span> </span><span class="annot"><span class="annottext">Note n
</span><a href="#local-6989586621679478544"><span class="hs-identifier hs-var">note</span></a></span><span>
</span><span id="line-1165"></span><span>
</span><span id="line-1166"></span><span class="hs-comment">-- 0 -&gt; pure ToBoth</span><span>
</span><span id="line-1167"></span><span class="hs-comment">-- 1 -&gt; do</span><span>
</span><span id="line-1168"></span><span class="hs-comment">--   nother &lt;-</span><span>
</span><span id="line-1169"></span><span class="hs-comment">--     sampleValue &quot;notesOnOtherSide&quot; (Binomial $ n - 1) $</span><span>
</span><span id="line-1170"></span><span class="hs-comment">--       pInner</span><span>
</span><span id="line-1171"></span><span class="hs-comment">--         . pNotesOnOtherSide</span><span>
</span><span id="line-1172"></span><span class="hs-comment">--   pure $ ToLeft $ n - nother</span><span>
</span><span id="line-1173"></span><span class="hs-comment">-- _ -&gt; do</span><span>
</span><span id="line-1174"></span><span class="hs-comment">--   nother &lt;-</span><span>
</span><span id="line-1175"></span><span class="hs-comment">--     sampleValue &quot;notesOnOtherSide&quot; (Binomial $ n - 1) $</span><span>
</span><span id="line-1176"></span><span class="hs-comment">--       pInner</span><span>
</span><span id="line-1177"></span><span class="hs-comment">--         . pNotesOnOtherSide</span><span>
</span><span id="line-1178"></span><span class="hs-comment">--   pure $ ToRight $ n - nother</span><span>
</span><span id="line-1179"></span><span class="hs-comment">-- pure ((note, n), to)</span><span>
</span><span id="line-1180"></span><span>
</span><span id="line-1181"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeSpread"><span class="hs-identifier hs-type">observeSpread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextDouble"><span class="hs-identifier hs-type">ContextDouble</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1182"></span><span id="observeSpread"><span class="annot"><span class="annottext">observeSpread :: ContextDouble SPitch
-&gt; Spread SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeSpread"><span class="hs-identifier hs-var hs-var">observeSpread</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679478553"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679478553"><span class="hs-identifier hs-var">_sliceL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478554"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679478554"><span class="hs-identifier hs-var">_transL</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679478555"><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679478555"><span class="hs-identifier hs-var">sliceM</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478556"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679478556"><span class="hs-identifier hs-var">_transR</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478557"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679478557"><span class="hs-identifier hs-var">_sliceR</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#SpreadOp"><span class="hs-identifier hs-type">SpreadOp</span></a></span><span> </span><span id="local-6989586621679478558"><span class="annot"><span class="annottext">HashMap (Note SPitch) (SpreadChildren SPitch)
</span><a href="#local-6989586621679478558"><span class="hs-identifier hs-var">obsDists</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span id="local-6989586621679478559"><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679478559"><span class="hs-identifier hs-var">repEdges</span></a></span></span><span> </span><span id="local-6989586621679478560"><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679478560"><span class="hs-identifier hs-var">passEdges</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1183"></span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-1184"></span><span>    </span><span class="hs-comment">-- observe note distribution</span><span>
</span><span id="line-1185"></span><span>    </span><span id="local-6989586621679478561"><span class="annot"><a href="#local-6989586621679478561"><span class="hs-identifier hs-var">dists</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Note SPitch
 -&gt; StateT (Trace PVParams) (Either String) (SpreadChildren SPitch))
-&gt; [Note SPitch]
-&gt; StateT (Trace PVParams) (Either String) [SpreadChildren SPitch]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap (Note SPitch) (SpreadChildren SPitch)
-&gt; Note SPitch
-&gt; StateT (Trace PVParams) (Either String) (SpreadChildren SPitch)
forall {a} {n}.
(Hashable a, Show a) =&gt;
HashMap a (SpreadChildren n)
-&gt; a -&gt; StateT (Trace PVParams) (Either String) (SpreadChildren n)
</span><a href="#local-6989586621679478562"><span class="hs-identifier hs-var">observeNoteDist</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap (Note SPitch) (SpreadChildren SPitch)
</span><a href="#local-6989586621679478558"><span class="hs-identifier hs-var">obsDists</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Note SPitch]
 -&gt; StateT (Trace PVParams) (Either String) [SpreadChildren SPitch])
-&gt; [Note SPitch]
-&gt; StateT (Trace PVParams) (Either String) [SpreadChildren SPitch]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Note SPitch] -&gt; [Note SPitch]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">([Note SPitch] -&gt; [Note SPitch]) -&gt; [Note SPitch] -&gt; [Note SPitch]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch) -&gt; [Note SPitch]
forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Note SPitch)
</span><a href="#local-6989586621679478555"><span class="hs-identifier hs-var">sliceM</span></a></span><span>
</span><span id="line-1186"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679478563"><span class="annot"><a href="#local-6989586621679478563"><span class="hs-identifier hs-var hs-var">notesLeft</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SpreadChildren SPitch -&gt; Maybe (Note SPitch))
-&gt; [SpreadChildren SPitch] -&gt; [Note SPitch]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">SpreadChildren SPitch -&gt; Maybe (Note SPitch)
forall n. SpreadChildren n -&gt; Maybe (Note n)
</span><a href="PVGrammar.html#leftSpreadChild"><span class="hs-identifier hs-var">leftSpreadChild</span></a></span><span> </span><span class="annot"><span class="annottext">[SpreadChildren SPitch]
</span><a href="#local-6989586621679478561"><span class="hs-identifier hs-var">dists</span></a></span><span>
</span><span id="line-1187"></span><span>        </span><span id="local-6989586621679478564"><span class="annot"><a href="#local-6989586621679478564"><span class="hs-identifier hs-var hs-var">notesRight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SpreadChildren SPitch -&gt; Maybe (Note SPitch))
-&gt; [SpreadChildren SPitch] -&gt; [Note SPitch]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">SpreadChildren SPitch -&gt; Maybe (Note SPitch)
forall n. SpreadChildren n -&gt; Maybe (Note n)
</span><a href="PVGrammar.html#rightSpreadChild"><span class="hs-identifier hs-var">rightSpreadChild</span></a></span><span> </span><span class="annot"><span class="annottext">[SpreadChildren SPitch]
</span><a href="#local-6989586621679478561"><span class="hs-identifier hs-var">dists</span></a></span><span>
</span><span id="line-1188"></span><span>    </span><span class="hs-comment">-- observe repetition edges</span><span>
</span><span id="line-1189"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">sequence_</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1190"></span><span>      </span><span class="hs-comment">-- List</span><span>
</span><span id="line-1191"></span><span>      </span><span id="local-6989586621679478566"><span class="annot"><a href="#local-6989586621679478566"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679478563"><span class="hs-identifier hs-type">notesLeft</span></a></span><span>
</span><span id="line-1192"></span><span>      </span><span id="local-6989586621679478567"><span class="annot"><a href="#local-6989586621679478567"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679478564"><span class="hs-identifier hs-type">notesRight</span></a></span><span>
</span><span id="line-1193"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">guard</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">pc</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#notePitch"><span class="hs-identifier hs-var">notePitch</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478566"><span class="hs-identifier hs-type">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">pc</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#notePitch"><span class="hs-identifier hs-var">notePitch</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478567"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1194"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1195"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">observeValue</span></span><span>
</span><span id="line-1196"></span><span>          </span><span class="annot"><span class="hs-string">&quot;spreadRepeatEdge&quot;</span></span><span>
</span><span id="line-1197"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Bernoulli</span></span><span>
</span><span id="line-1198"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-type">pInner</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pSpreadRepetitionEdge"><span class="hs-identifier hs-type">pSpreadRepetitionEdge</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1199"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478566"><span class="hs-identifier hs-type">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478567"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679478559"><span class="hs-identifier hs-type">repEdges</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1200"></span><span>    </span><span class="hs-comment">-- observe passing edges</span><span>
</span><span id="line-1201"></span><span>    </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observePassing"><span class="hs-identifier hs-type">observePassing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478563"><span class="hs-identifier hs-type">notesLeft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478564"><span class="hs-identifier hs-type">notesRight</span></a></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pNewPassingMid"><span class="hs-identifier hs-type">pNewPassingMid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478560"><span class="hs-identifier hs-type">passEdges</span></a></span><span>
</span><span id="line-1202"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1203"></span><span>  </span><span id="local-6989586621679478562"><span class="annot"><span class="annottext">observeNoteDist :: HashMap a (SpreadChildren n)
-&gt; a -&gt; StateT (Trace PVParams) (Either String) (SpreadChildren n)
</span><a href="#local-6989586621679478562"><span class="hs-identifier hs-var hs-var">observeNoteDist</span></a></span></span><span> </span><span id="local-6989586621679478601"><span class="annot"><span class="annottext">HashMap a (SpreadChildren n)
</span><a href="#local-6989586621679478601"><span class="hs-identifier hs-var">distMap</span></a></span></span><span> </span><span id="local-6989586621679478602"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679478602"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">a -&gt; HashMap a (SpreadChildren n) -&gt; Maybe (SpreadChildren n)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HM.lookup</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679478602"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap a (SpreadChildren n)
</span><a href="#local-6989586621679478601"><span class="hs-identifier hs-var">distMap</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1204"></span><span>    </span><span class="annot"><span class="annottext">Maybe (SpreadChildren n)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1205"></span><span>      </span><span class="annot"><span class="annottext">Either String (SpreadChildren n)
-&gt; StateT (Trace PVParams) (Either String) (SpreadChildren n)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (Trace PVParams) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Either String (SpreadChildren n)
 -&gt; StateT (Trace PVParams) (Either String) (SpreadChildren n))
-&gt; Either String (SpreadChildren n)
-&gt; StateT (Trace PVParams) (Either String) (SpreadChildren n)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String (SpreadChildren n)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Either String (SpreadChildren n))
-&gt; String -&gt; Either String (SpreadChildren n)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Note &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679478602"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; is not distributed.&quot;</span></span><span>
</span><span id="line-1206"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679478604"><span class="annot"><span class="annottext">SpreadChildren n
</span><a href="#local-6989586621679478604"><span class="hs-identifier hs-var">dir</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1207"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SpreadChildren n
</span><a href="#local-6989586621679478604"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1208"></span><span>        </span><span class="annot"><a href="PVGrammar.html#SpreadBothChildren"><span class="hs-identifier hs-type">SpreadBothChildren</span></a></span><span> </span><span class="annot"><span class="annottext">Note n
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Note n
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1209"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; Categorical 3
-&gt; Accessor PVParams (Dirichlet 3)
-&gt; Support (Categorical 3)
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-1210"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;noteSpreadDirection&quot;</span></span><span>
</span><span id="line-1211"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (n :: Nat). Categorical n
</span><span class="hs-identifier hs-var">Categorical</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span>
</span><span id="line-1212"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f (Dirichlet 3) -&gt; f (f (Dirichlet 3)))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f (Dirichlet 3) -&gt; f (f (Dirichlet 3)))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f (Dirichlet 3) -&gt; f (f (Dirichlet 3)))
-&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f (Dirichlet 3) -&gt; f (f (Dirichlet 3)))
-&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pNoteSpreadDirection"><span class="hs-identifier hs-var">pNoteSpreadDirection</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1213"></span><span>            </span><span class="annot"><span class="annottext">Int
Support (Categorical 3)
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1214"></span><span>        </span><span class="annot"><a href="PVGrammar.html#SpreadLeftChild"><span class="hs-identifier hs-type">SpreadLeftChild</span></a></span><span> </span><span class="annot"><span class="annottext">Note n
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1215"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; Categorical 3
-&gt; Accessor PVParams (Dirichlet 3)
-&gt; Support (Categorical 3)
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-1216"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;noteSpreadDirection&quot;</span></span><span>
</span><span id="line-1217"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (n :: Nat). Categorical n
</span><span class="hs-identifier hs-var">Categorical</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span>
</span><span id="line-1218"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f (Dirichlet 3) -&gt; f (f (Dirichlet 3)))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f (Dirichlet 3) -&gt; f (f (Dirichlet 3)))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f (Dirichlet 3) -&gt; f (f (Dirichlet 3)))
-&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f (Dirichlet 3) -&gt; f (f (Dirichlet 3)))
-&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pNoteSpreadDirection"><span class="hs-identifier hs-var">pNoteSpreadDirection</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1219"></span><span>            </span><span class="annot"><span class="annottext">Int
Support (Categorical 3)
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1220"></span><span>        </span><span class="annot"><a href="PVGrammar.html#SpreadRightChild"><span class="hs-identifier hs-type">SpreadRightChild</span></a></span><span> </span><span class="annot"><span class="annottext">Note n
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1221"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; Categorical 3
-&gt; Accessor PVParams (Dirichlet 3)
-&gt; Support (Categorical 3)
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-1222"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;noteSpreadDirection&quot;</span></span><span>
</span><span id="line-1223"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (n :: Nat). Categorical n
</span><span class="hs-identifier hs-var">Categorical</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span>
</span><span id="line-1224"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsInner f -&gt; f (PVParamsInner f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f (Dirichlet 3) -&gt; f (f (Dirichlet 3)))
    -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; (f (Dirichlet 3) -&gt; f (f (Dirichlet 3)))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f (Dirichlet 3) -&gt; f (f (Dirichlet 3)))
-&gt; PVParamsInner f -&gt; f (PVParamsInner f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f (Dirichlet 3) -&gt; f (f (Dirichlet 3)))
-&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pNoteSpreadDirection"><span class="hs-identifier hs-var">pNoteSpreadDirection</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1225"></span><span>            </span><span class="annot"><span class="annottext">Int
Support (Categorical 3)
</span><span class="hs-number">2</span></span><span>
</span><span id="line-1226"></span><span>      </span><span class="annot"><span class="annottext">SpreadChildren n
-&gt; StateT (Trace PVParams) (Either String) (SpreadChildren n)
forall a. a -&gt; StateT (Trace PVParams) (Either String) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SpreadChildren n
</span><a href="#local-6989586621679478604"><span class="hs-identifier hs-var">dir</span></a></span><span>
</span><span id="line-1227"></span><span>
</span><span id="line-1228"></span><span id="local-6989586621679478614"><span class="annot"><a href="PVGrammar.Prob.Simple.html#samplePassing"><span class="hs-identifier hs-type">samplePassing</span></a></span><span>
</span><span id="line-1229"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-1230"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span>
</span><span id="line-1231"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span>
</span><span id="line-1232"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Accessor</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-1233"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679478614"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Internal.MultiSet.html#MultiSet"><span class="hs-identifier hs-type">MS.MultiSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#InnerEdge"><span class="hs-identifier hs-type">InnerEdge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-1234"></span><span id="samplePassing"><span class="annot"><span class="annottext">samplePassing :: [Note SPitch]
-&gt; [Note SPitch]
-&gt; (forall (f :: * -&gt; *) (f :: * -&gt; *).
    Functor f =&gt;
    (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; m (MultiSet (InnerEdge SPitch))
</span><a href="PVGrammar.Prob.Simple.html#samplePassing"><span class="hs-identifier hs-var hs-var">samplePassing</span></a></span></span><span> </span><span id="local-6989586621679478664"><span class="annot"><span class="annottext">[Note SPitch]
</span><a href="#local-6989586621679478664"><span class="hs-identifier hs-var">notesLeft</span></a></span></span><span> </span><span id="local-6989586621679478665"><span class="annot"><span class="annottext">[Note SPitch]
</span><a href="#local-6989586621679478665"><span class="hs-identifier hs-var">notesRight</span></a></span></span><span> </span><span id="local-6989586621679478666"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="#local-6989586621679478666"><span class="hs-identifier hs-var">pNewPassing</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1235"></span><span>  </span><span class="annot"><span class="annottext">([[InnerEdge SPitch]] -&gt; MultiSet (InnerEdge SPitch))
-&gt; m [[InnerEdge SPitch]] -&gt; m (MultiSet (InnerEdge SPitch))
forall a b. (a -&gt; b) -&gt; m a -&gt; m b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[InnerEdge SPitch] -&gt; MultiSet (InnerEdge SPitch)
forall (t :: * -&gt; *) a.
(Foldable t, Eq a, Hashable a) =&gt;
t a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#fromList"><span class="hs-identifier hs-var">MS.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([InnerEdge SPitch] -&gt; MultiSet (InnerEdge SPitch))
-&gt; ([[InnerEdge SPitch]] -&gt; [InnerEdge SPitch])
-&gt; [[InnerEdge SPitch]]
-&gt; MultiSet (InnerEdge SPitch)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[[InnerEdge SPitch]] -&gt; [InnerEdge SPitch]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m [[InnerEdge SPitch]] -&gt; m (MultiSet (InnerEdge SPitch)))
-&gt; m [[InnerEdge SPitch]] -&gt; m (MultiSet (InnerEdge SPitch))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[m [InnerEdge SPitch]] -&gt; m [[InnerEdge SPitch]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Traversable t, Monad m) =&gt;
t (m a) -&gt; m (t a)
forall (m :: * -&gt; *) a. Monad m =&gt; [m a] -&gt; m [a]
</span><span class="hs-identifier hs-var">sequence</span></span><span> </span><span class="annot"><span class="annottext">([m [InnerEdge SPitch]] -&gt; m [[InnerEdge SPitch]])
-&gt; [m [InnerEdge SPitch]] -&gt; m [[InnerEdge SPitch]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1236"></span><span>    </span><span class="hs-comment">-- List</span><span>
</span><span id="line-1237"></span><span>    </span><span class="hs-comment">-- DT.traceM $ &quot;notesLeft (smp)&quot; &lt;&gt; show notesLeft</span><span>
</span><span id="line-1238"></span><span>    </span><span class="hs-comment">-- DT.traceM $ &quot;notesRight (smp)&quot; &lt;&gt; show notesRight</span><span>
</span><span id="line-1239"></span><span>    </span><span id="local-6989586621679478669"><span class="annot"><a href="#local-6989586621679478669"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Note SPitch]
</span><a href="#local-6989586621679478664"><span class="hs-identifier hs-var">notesLeft</span></a></span><span>
</span><span id="line-1240"></span><span>    </span><span id="local-6989586621679478670"><span class="annot"><a href="#local-6989586621679478670"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679478665"><span class="hs-identifier hs-type">notesRight</span></a></span><span>
</span><span id="line-1241"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679478671"><span class="annot"><a href="#local-6989586621679478671"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SIC -&gt; SIC
forall i. Interval i =&gt; i -&gt; i
</span><span class="hs-identifier hs-var">iabs</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Note SPitch -&gt; SPitch
forall n. Note n -&gt; n
</span><a href="PVGrammar.html#notePitch"><span class="hs-identifier hs-var">notePitch</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679478669"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Pitch SIC -&gt; Pitch SIC -&gt; SIC
forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Note SPitch -&gt; SPitch
forall n. Note n -&gt; n
</span><a href="PVGrammar.html#notePitch"><span class="hs-identifier hs-var">notePitch</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679478670"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1242"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">guard</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">degree</span></span><span> </span><span class="annot"><a href="#local-6989586621679478671"><span class="hs-identifier hs-type">step</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;=</span></span><span> </span><span class="annot"><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">degree</span></span><span> </span><span class="annot"><a href="#local-6989586621679478671"><span class="hs-identifier hs-type">step</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">alteration</span></span><span> </span><span class="annot"><a href="#local-6989586621679478671"><span class="hs-identifier hs-type">step</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;=</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-1243"></span><span>    </span><span class="hs-comment">-- DT.traceM $ &quot;parent edge (sample)&quot; &lt;&gt; show (l, r)</span><span>
</span><span id="line-1244"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1245"></span><span>      </span><span class="hs-comment">-- m</span><span>
</span><span id="line-1246"></span><span>      </span><span id="local-6989586621679478674"><span class="annot"><a href="#local-6989586621679478674"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sampleValue</span></span><span> </span><span class="annot"><span class="hs-string">&quot;newPassing&quot;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Geometric0</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-type">pInner</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="#local-6989586621679478666"><span class="hs-identifier hs-type">pNewPassing</span></a></span><span>
</span><span id="line-1247"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">replicate</span></span><span> </span><span class="annot"><a href="#local-6989586621679478674"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679478669"><span class="hs-identifier hs-type">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679478670"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1248"></span><span>
</span><span id="line-1249"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observePassing"><span class="hs-identifier hs-type">observePassing</span></a></span><span>
</span><span id="line-1250"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span>
</span><span id="line-1251"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#Note"><span class="hs-identifier hs-type">Note</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span>
</span><span id="line-1252"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Accessor</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-1253"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Internal.MultiSet.html#MultiSet"><span class="hs-identifier hs-type">MS.MultiSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#InnerEdge"><span class="hs-identifier hs-type">InnerEdge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-1254"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1255"></span><span id="observePassing"><span class="annot"><span class="annottext">observePassing :: [Note SPitch]
-&gt; [Note SPitch]
-&gt; (forall (f :: * -&gt; *) (f :: * -&gt; *).
    Functor f =&gt;
    (f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f))
-&gt; MultiSet (InnerEdge SPitch)
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observePassing"><span class="hs-identifier hs-var hs-var">observePassing</span></a></span></span><span> </span><span id="local-6989586621679478679"><span class="annot"><span class="annottext">[Note SPitch]
</span><a href="#local-6989586621679478679"><span class="hs-identifier hs-var">notesLeft</span></a></span></span><span> </span><span id="local-6989586621679478680"><span class="annot"><span class="annottext">[Note SPitch]
</span><a href="#local-6989586621679478680"><span class="hs-identifier hs-var">notesRight</span></a></span></span><span> </span><span id="local-6989586621679478681"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsInner f -&gt; f (PVParamsInner f)
</span><a href="#local-6989586621679478681"><span class="hs-identifier hs-var">pNewPassing</span></a></span></span><span> </span><span id="local-6989586621679478682"><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679478682"><span class="hs-identifier hs-var">edges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[StateT (Trace PVParams) (Either String) ()]
-&gt; StateT (Trace PVParams) (Either String) ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, Monad m) =&gt;
t (m a) -&gt; m ()
</span><span class="hs-identifier hs-var">sequence_</span></span><span> </span><span class="annot"><span class="annottext">([StateT (Trace PVParams) (Either String) ()]
 -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; [StateT (Trace PVParams) (Either String) ()]
-&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1256"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;edges (obs)&quot; &lt;&gt; show edges</span><span>
</span><span id="line-1257"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;notesLeft (obs)&quot; &lt;&gt; show notesLeft</span><span>
</span><span id="line-1258"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;notesRight (obs)&quot; &lt;&gt; show notesRight</span><span>
</span><span id="line-1259"></span><span>  </span><span id="local-6989586621679478683"><span class="annot"><a href="#local-6989586621679478683"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Note SPitch]
</span><a href="#local-6989586621679478679"><span class="hs-identifier hs-var">notesLeft</span></a></span><span>
</span><span id="line-1260"></span><span>  </span><span id="local-6989586621679478684"><span class="annot"><a href="#local-6989586621679478684"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679478680"><span class="hs-identifier hs-type">notesRight</span></a></span><span>
</span><span id="line-1261"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679478685"><span class="annot"><a href="#local-6989586621679478685"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SIC -&gt; SIC
forall i. Interval i =&gt; i -&gt; i
</span><span class="hs-identifier hs-var">iabs</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Note SPitch -&gt; SPitch
forall n. Note n -&gt; n
</span><a href="PVGrammar.html#notePitch"><span class="hs-identifier hs-var">notePitch</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679478683"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Pitch SIC -&gt; Pitch SIC -&gt; SIC
forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; Pitch (ICOf SInterval)
forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Note SPitch -&gt; SPitch
forall n. Note n -&gt; n
</span><a href="PVGrammar.html#notePitch"><span class="hs-identifier hs-var">notePitch</span></a></span><span> </span><span class="annot"><span class="annottext">Note SPitch
</span><a href="#local-6989586621679478684"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1262"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">guard</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">degree</span></span><span> </span><span class="annot"><a href="#local-6989586621679478685"><span class="hs-identifier hs-type">step</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;=</span></span><span> </span><span class="annot"><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">degree</span></span><span> </span><span class="annot"><a href="#local-6989586621679478685"><span class="hs-identifier hs-type">step</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">alteration</span></span><span> </span><span class="annot"><a href="#local-6989586621679478685"><span class="hs-identifier hs-type">step</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;=</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-1263"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;parent edge (obs)&quot; &lt;&gt; show (l, r)</span><span>
</span><span id="line-1264"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1265"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">observeValue</span></span><span>
</span><span id="line-1266"></span><span>      </span><span class="annot"><span class="hs-string">&quot;newPassing&quot;</span></span><span>
</span><span id="line-1267"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Geometric0</span></span><span>
</span><span id="line-1268"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-type">pInner</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="#local-6989586621679478681"><span class="hs-identifier hs-type">pNewPassing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1269"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679478682"><span class="hs-identifier hs-type">edges</span></a></span><span> </span><span class="annot"><a href="Internal.MultiSet.html#%21"><span class="hs-operator hs-type">MS.!</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679478683"><span class="hs-identifier hs-type">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679478684"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1270"></span><span>
</span><span id="line-1271"></span><span class="hs-comment">-- Helpers for bottom-up evaluation (parsing)</span><span>
</span><span id="line-1272"></span><span class="hs-comment">-- ------------------------------------------</span><span>
</span><span id="line-1273"></span><span>
</span><span id="line-1274"></span><span class="annot"><span class="hs-comment">{- | Sample a single step in a bottom-up context.
Only used for evaluating the probability of a step, therefore returns '()'.
-}</span></span><span>
</span><span id="line-1277"></span><span id="local-6989586621679478690"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSingleStepParsing"><span class="hs-identifier hs-type">sampleSingleStepParsing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextSingle"><span class="hs-identifier hs-type">ContextSingle</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679478690"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-1278"></span><span id="sampleSingleStepParsing"><span class="annot"><span class="annottext">sampleSingleStepParsing :: ContextSingle SPitch -&gt; m ()
</span><a href="PVGrammar.Prob.Simple.html#sampleSingleStepParsing"><span class="hs-identifier hs-var hs-var">sampleSingleStepParsing</span></a></span></span><span> </span><span id="local-6989586621679478719"><span class="annot"><span class="annottext">ContextSingle SPitch
</span><a href="#local-6989586621679478719"><span class="hs-identifier hs-var">parents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1279"></span><span>  </span><span id="local-6989586621679478720"><span class="annot"><a href="#local-6989586621679478720"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch
-&gt; m (LeftmostSingle (Split SPitch) (Freeze SPitch))
forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m Geometric1,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 SampleCtx m MagicalID, RandomInterpreter m PVParams) =&gt;
ContextSingle SPitch
-&gt; m (LeftmostSingle (Split SPitch) (Freeze SPitch))
</span><a href="PVGrammar.Prob.Simple.html#sampleSingleStep"><span class="hs-identifier hs-var">sampleSingleStep</span></a></span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch
</span><a href="#local-6989586621679478719"><span class="hs-identifier hs-var">parents</span></a></span><span>
</span><span id="line-1280"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679478720"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1281"></span><span>    </span><span class="annot"><a href="Common.html#LMSingleFreeze"><span class="hs-identifier hs-type">LMSingleFreeze</span></a></span><span> </span><span class="annot"><span class="annottext">Freeze SPitch
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1282"></span><span>    </span><span class="annot"><a href="Common.html#LMSingleSplit"><span class="hs-identifier hs-type">LMSingleSplit</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1283"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli -&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall p l.
(Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor PVParams p -&gt; m (Support l)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;continueLeft&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">(Accessor PVParams Beta -&gt; m (Support Bernoulli))
-&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeft"><span class="hs-identifier hs-var">pDoubleLeft</span></a></span><span>
</span><span id="line-1284"></span><span>      </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1285"></span><span>
</span><span id="line-1286"></span><span class="annot"><span class="hs-comment">{- | Observerse a single step in a bottom-up context.
Since double operations don't know whether they have to make a &quot;continueLeft&quot; decision
when going bottom-up, this decision is moved to the previous step, where the context is know.
Therefore, if the following step would have to make this decision, it is added here.
-}</span></span><span>
</span><span id="line-1291"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeSingleStepParsing"><span class="hs-identifier hs-type">observeSingleStepParsing</span></a></span><span>
</span><span id="line-1292"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextSingle"><span class="hs-identifier hs-type">ContextSingle</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-1293"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ the parent path</span></span><span>
</span><span id="line-1294"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1295"></span><span>  </span><span class="hs-comment">-- ^ If the following (generative) step is a double op,</span><span>
</span><span id="line-1296"></span><span>  </span><span class="hs-comment">-- this is the result of the &quot;continueLeft&quot; decision,</span><span>
</span><span id="line-1297"></span><span>  </span><span class="hs-comment">-- i.e., 'Just True' for split-left and freeze-left,</span><span>
</span><span id="line-1298"></span><span>  </span><span class="hs-comment">-- and 'Just False' for spread and split-right.</span><span>
</span><span id="line-1299"></span><span>  </span><span class="hs-comment">-- If the following step is a single op, this is 'Nothing' (as no decision is made).</span><span>
</span><span id="line-1300"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.html#LeftmostSingle"><span class="hs-identifier hs-type">LeftmostSingle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-1301"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ the performed operation</span></span><span>
</span><span id="line-1302"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Trace</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1303"></span><span id="observeSingleStepParsing"><span class="annot"><span class="annottext">observeSingleStepParsing :: ContextSingle SPitch
-&gt; Maybe Bool
-&gt; LeftmostSingle (Split SPitch) (Freeze SPitch)
-&gt; Either String (Trace PVParams)
</span><a href="PVGrammar.Prob.Simple.html#observeSingleStepParsing"><span class="hs-identifier hs-var hs-var">observeSingleStepParsing</span></a></span></span><span> </span><span id="local-6989586621679478724"><span class="annot"><span class="annottext">ContextSingle SPitch
</span><a href="#local-6989586621679478724"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span id="local-6989586621679478725"><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621679478725"><span class="hs-identifier hs-var">decision</span></a></span></span><span> </span><span id="local-6989586621679478726"><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) (Freeze SPitch)
</span><a href="#local-6989586621679478726"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(StateT (Trace PVParams) (Either String) ()
 -&gt; Trace PVParams -&gt; Either String (Trace PVParams))
-&gt; Trace PVParams
-&gt; StateT (Trace PVParams) (Either String) ()
-&gt; Either String (Trace PVParams)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">StateT (Trace PVParams) (Either String) ()
-&gt; Trace PVParams -&gt; Either String (Trace PVParams)
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m s
</span><span class="hs-identifier hs-var">execStateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Seq (String, Dynamic) -&gt; Trace PVParams
forall (r :: (* -&gt; *) -&gt; *). Seq (String, Dynamic) -&gt; Trace r
</span><span class="hs-identifier hs-var">Trace</span></span><span> </span><span class="annot"><span class="annottext">Seq (String, Dynamic)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT (Trace PVParams) (Either String) ()
 -&gt; Either String (Trace PVParams))
-&gt; StateT (Trace PVParams) (Either String) ()
-&gt; Either String (Trace PVParams)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1304"></span><span>  </span><span class="hs-comment">-- observe the step as normal</span><span>
</span><span id="line-1305"></span><span>  </span><span class="annot"><span class="annottext">ContextSingle SPitch
-&gt; LeftmostSingle (Split SPitch) (Freeze SPitch)
-&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeSingleStep"><span class="hs-identifier hs-var">observeSingleStep</span></a></span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch
</span><a href="#local-6989586621679478724"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) (Freeze SPitch)
</span><a href="#local-6989586621679478726"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-1306"></span><span>  </span><span class="hs-comment">-- account for possible extra decision in next step</span><span>
</span><span id="line-1307"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621679478725"><span class="hs-identifier hs-var">decision</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1308"></span><span>    </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; StateT (Trace PVParams) (Either String) ()
forall a. a -&gt; StateT (Trace PVParams) (Either String) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1309"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679478728"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679478728"><span class="hs-identifier hs-var">goLeft</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;continueLeft&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeft"><span class="hs-identifier hs-var">pDoubleLeft</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><a href="#local-6989586621679478728"><span class="hs-identifier hs-var">goLeft</span></a></span><span>
</span><span id="line-1310"></span><span>
</span><span id="line-1311"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#evalSingleStep"><span class="hs-identifier hs-type">evalSingleStep</span></a></span><span>
</span><span id="line-1312"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Probs</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span>
</span><span id="line-1313"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextSingle"><span class="hs-identifier hs-type">ContextSingle</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-1314"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.html#LeftmostSingle"><span class="hs-identifier hs-type">LeftmostSingle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-1315"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1316"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1317"></span><span id="evalSingleStep"><span class="annot"><span class="annottext">evalSingleStep :: Probs PVParams
-&gt; ContextSingle SPitch
-&gt; LeftmostSingle (Split SPitch) (Freeze SPitch)
-&gt; Maybe Bool
-&gt; Either String (Maybe ((), Double))
</span><a href="PVGrammar.Prob.Simple.html#evalSingleStep"><span class="hs-identifier hs-var hs-var">evalSingleStep</span></a></span></span><span> </span><span id="local-6989586621679478732"><span class="annot"><span class="annottext">Probs PVParams
</span><a href="#local-6989586621679478732"><span class="hs-identifier hs-var">probs</span></a></span></span><span> </span><span id="local-6989586621679478733"><span class="annot"><span class="annottext">ContextSingle SPitch
</span><a href="#local-6989586621679478733"><span class="hs-identifier hs-var">parents</span></a></span></span><span> </span><span id="local-6989586621679478734"><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) (Freeze SPitch)
</span><a href="#local-6989586621679478734"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621679478735"><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621679478735"><span class="hs-identifier hs-var">decision</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1318"></span><span>  </span><span id="local-6989586621679478736"><span class="annot"><a href="#local-6989586621679478736"><span class="hs-identifier hs-var">trace</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch
-&gt; Maybe Bool
-&gt; LeftmostSingle (Split SPitch) (Freeze SPitch)
-&gt; Either String (Trace PVParams)
</span><a href="PVGrammar.Prob.Simple.html#observeSingleStepParsing"><span class="hs-identifier hs-var">observeSingleStepParsing</span></a></span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch
</span><a href="#local-6989586621679478733"><span class="hs-identifier hs-var">parents</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621679478735"><span class="hs-identifier hs-var">decision</span></a></span><span> </span><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) (Freeze SPitch)
</span><a href="#local-6989586621679478734"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-1319"></span><span>  </span><span class="hs-comment">-- DT.traceM &quot;evalSingleStep&quot;</span><span>
</span><span id="line-1320"></span><span>  </span><span class="hs-comment">-- DT.traceM $ show $ runTrace trace</span><span>
</span><span id="line-1321"></span><span>  </span><span class="hs-comment">-- let !_ = traceTrace trace $ sampleSingleStepParsing parents</span><span>
</span><span id="line-1322"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">evalTraceLogP</span></span><span> </span><span class="annot"><a href="#local-6989586621679478732"><span class="hs-identifier hs-type">probs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478736"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSingleStepParsing"><span class="hs-identifier hs-type">sampleSingleStepParsing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478733"><span class="hs-identifier hs-type">parents</span></a></span><span>
</span><span id="line-1323"></span><span>
</span><span id="line-1324"></span><span class="annot"><span class="hs-comment">{- | Sample a double step in a bottom-up context.
Only used for evaluating the probability of a step,
therefore takes the &quot;resulting&quot; op and returns '()'.
-}</span></span><span>
</span><span id="line-1328"></span><span id="local-6989586621679478737"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleDoubleStepParsing"><span class="hs-identifier hs-type">sampleDoubleStepParsing</span></a></span><span>
</span><span id="line-1329"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-1330"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextDouble"><span class="hs-identifier hs-type">ContextDouble</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-1331"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.html#LeftmostDouble"><span class="hs-identifier hs-type">LeftmostDouble</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-1332"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679478737"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-1333"></span><span id="sampleDoubleStepParsing"><span class="annot"><span class="annottext">sampleDoubleStepParsing :: ContextDouble SPitch
-&gt; LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
-&gt; m ()
</span><a href="PVGrammar.Prob.Simple.html#sampleDoubleStepParsing"><span class="hs-identifier hs-var hs-var">sampleDoubleStepParsing</span></a></span></span><span> </span><span id="local-6989586621679478806"><span class="annot"><span class="annottext">parents :: ContextDouble SPitch
</span><a href="#local-6989586621679478806"><span class="hs-identifier hs-var">parents</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679478807"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679478807"><span class="hs-identifier hs-var">sliceL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478808"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679478808"><span class="hs-identifier hs-var">transL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478809"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679478809"><span class="hs-identifier hs-var">sliceM</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478810"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679478810"><span class="hs-identifier hs-var">transR</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478811"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679478811"><span class="hs-identifier hs-var">sliceR</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679478812"><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
</span><a href="#local-6989586621679478812"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1334"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679478813"><span class="hs-identifier hs-var">continueLeft</span></a></span><span>
</span><span id="line-1335"></span><span>    </span><span class="hs-keyword">then</span><span>
</span><span id="line-1336"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Edges SPitch -&gt; Bool
forall n. (Eq (IntervalOf n), HasPitch n) =&gt; Edges n -&gt; Bool
</span><a href="PVGrammar.Generate.html#freezable"><span class="hs-identifier hs-var">freezable</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679478808"><span class="hs-identifier hs-var">transL</span></a></span><span>
</span><span id="line-1337"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1338"></span><span>          </span><span id="local-6989586621679478814"><span class="annot"><a href="#local-6989586621679478814"><span class="hs-identifier hs-var">shouldFreeze</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1339"></span><span>            </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli -&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall p l.
(Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor PVParams p -&gt; m (Support l)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldFreeze (double)&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">(Accessor PVParams Beta -&gt; m (Support Bernoulli))
-&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeftFreeze"><span class="hs-identifier hs-var">pDoubleLeftFreeze</span></a></span><span>
</span><span id="line-1340"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679478814"><span class="hs-identifier hs-type">shouldFreeze</span></a></span><span>
</span><span id="line-1341"></span><span>            </span><span class="hs-keyword">then</span><span>
</span><span id="line-1342"></span><span>              </span><span class="annot"><a href="Common.html#LMDoubleFreezeLeft"><span class="hs-identifier hs-type">LMDoubleFreezeLeft</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleFreeze"><span class="hs-identifier hs-type">sampleFreeze</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679478807"><span class="hs-identifier hs-type">sliceL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679478808"><span class="hs-identifier hs-type">transL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478809"><span class="hs-identifier hs-type">sliceM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1343"></span><span>            </span><span class="hs-keyword">else</span><span>
</span><span id="line-1344"></span><span>              </span><span class="annot"><a href="Common.html#LMDoubleSplitLeft"><span class="hs-identifier hs-type">LMDoubleSplitLeft</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSplit"><span class="hs-identifier hs-type">sampleSplit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679478807"><span class="hs-identifier hs-type">sliceL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679478808"><span class="hs-identifier hs-type">transL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478809"><span class="hs-identifier hs-type">sliceM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1345"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Split SPitch
-&gt; LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
forall s f h. s -&gt; LeftmostDouble s f h
</span><a href="Common.html#LMDoubleSplitLeft"><span class="hs-identifier hs-var">LMDoubleSplitLeft</span></a></span><span> </span><span class="annot"><span class="annottext">(Split SPitch
 -&gt; LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch))
-&gt; m (Split SPitch)
-&gt; m (LeftmostDouble
        (Split SPitch) (Freeze SPitch) (Spread SPitch))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch -&gt; m (Split SPitch)
forall (m :: * -&gt; *).
(SampleCtx m Geometric1, SampleCtx m Bernoulli,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 SampleCtx m MagicalID, RandomInterpreter m PVParams) =&gt;
ContextSingle SPitch -&gt; m (Split SPitch)
</span><a href="PVGrammar.Prob.Simple.html#sampleSplit"><span class="hs-identifier hs-var">sampleSplit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679478807"><span class="hs-identifier hs-var">sliceL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679478808"><span class="hs-identifier hs-var">transL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Notes SPitch -&gt; StartStop (Notes SPitch)
forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679478809"><span class="hs-identifier hs-var">sliceM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1346"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1347"></span><span>      </span><span id="local-6989586621679478818"><span class="annot"><a href="#local-6989586621679478818"><span class="hs-identifier hs-var">shouldSplitRight</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1348"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli -&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall p l.
(Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor PVParams p -&gt; m (Support l)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldSplitRight&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">(Accessor PVParams Beta -&gt; m (Support Bernoulli))
-&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleRightSplit"><span class="hs-identifier hs-var">pDoubleRightSplit</span></a></span><span>
</span><span id="line-1349"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679478818"><span class="hs-identifier hs-type">shouldSplitRight</span></a></span><span>
</span><span id="line-1350"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="Common.html#LMDoubleSplitRight"><span class="hs-identifier hs-type">LMDoubleSplitRight</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSplit"><span class="hs-identifier hs-type">sampleSplit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478809"><span class="hs-identifier hs-type">sliceM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679478810"><span class="hs-identifier hs-type">transR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679478811"><span class="hs-identifier hs-type">sliceR</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1351"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="Common.html#LMDoubleSpread"><span class="hs-identifier hs-type">LMDoubleSpread</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSpread"><span class="hs-identifier hs-type">sampleSpread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478806"><span class="hs-identifier hs-type">parents</span></a></span><span>
</span><span id="line-1352"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
</span><a href="#local-6989586621679478812"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1353"></span><span>    </span><span class="hs-comment">-- split right? no extra decision</span><span>
</span><span id="line-1354"></span><span>    </span><span class="annot"><a href="Common.html#LMDoubleSplitRight"><span class="hs-identifier hs-type">LMDoubleSplitRight</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1355"></span><span>    </span><span class="hs-comment">-- reached the end? next step is single, so no extra decision</span><span>
</span><span id="line-1356"></span><span>    </span><span class="annot"><a href="Common.html#LMDoubleFreezeLeft"><span class="hs-identifier hs-type">LMDoubleFreezeLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Freeze SPitch
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-1357"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679478811"><span class="hs-identifier hs-var">sliceR</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch) -&gt; StartStop (Notes SPitch) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
forall a. StartStop a
</span><a href="Common.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1358"></span><span>    </span><span class="hs-comment">-- all other cases: extra &quot;continueLeft&quot; decision in next step</span><span>
</span><span id="line-1359"></span><span>    </span><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1360"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli -&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall p l.
(Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor PVParams p -&gt; m (Support l)
forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;continueLeft&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">(Accessor PVParams Beta -&gt; m (Support Bernoulli))
-&gt; Accessor PVParams Beta -&gt; m (Support Bernoulli)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeft"><span class="hs-identifier hs-var">pDoubleLeft</span></a></span><span>
</span><span id="line-1361"></span><span>      </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1362"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1363"></span><span>  </span><span id="local-6989586621679478813"><span class="annot"><span class="annottext">continueLeft :: Bool
</span><a href="#local-6989586621679478813"><span class="hs-identifier hs-var hs-var">continueLeft</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
</span><a href="#local-6989586621679478812"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1364"></span><span>    </span><span class="annot"><a href="Common.html#LMDoubleFreezeLeft"><span class="hs-identifier hs-type">LMDoubleFreezeLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Freeze SPitch
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1365"></span><span>    </span><span class="annot"><a href="Common.html#LMDoubleSplitLeft"><span class="hs-identifier hs-type">LMDoubleSplitLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1366"></span><span>    </span><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1367"></span><span>
</span><span id="line-1368"></span><span class="annot"><span class="hs-comment">{- | Observerse a double step without knowing
if it happened after a right split (e.g., when parsing).
The extra decision that is necessary if it doesn't follow a right split
is &quot;moved&quot; to the previous step.
Therefore, this step is rated as if it follows a right split (not making the decision).
In addition, if the following step would have to make the extra decision, it is added here.
-}</span></span><span>
</span><span id="line-1375"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeDoubleStepParsing"><span class="hs-identifier hs-type">observeDoubleStepParsing</span></a></span><span>
</span><span id="line-1376"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextDouble"><span class="hs-identifier hs-type">ContextDouble</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-1377"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ the parent path</span></span><span>
</span><span id="line-1378"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1379"></span><span>  </span><span class="hs-comment">-- ^ If the following (generative) step is a double op,</span><span>
</span><span id="line-1380"></span><span>  </span><span class="hs-comment">-- this is the result of the &quot;continueLeft&quot; decision,</span><span>
</span><span id="line-1381"></span><span>  </span><span class="hs-comment">-- i.e., 'Just True' for split-left</span><span>
</span><span id="line-1382"></span><span>  </span><span class="hs-comment">-- and freeze-left and 'Just False' for spread and split-right.</span><span>
</span><span id="line-1383"></span><span>  </span><span class="hs-comment">-- If the following step is a single op, this is 'Nothing', as not decision is made.</span><span>
</span><span id="line-1384"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.html#LeftmostDouble"><span class="hs-identifier hs-type">LeftmostDouble</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-1385"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ the performed operation</span></span><span>
</span><span id="line-1386"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Trace</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1387"></span><span id="observeDoubleStepParsing"><span class="annot"><span class="annottext">observeDoubleStepParsing :: ContextDouble SPitch
-&gt; Maybe Bool
-&gt; LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
-&gt; Either String (Trace PVParams)
</span><a href="PVGrammar.Prob.Simple.html#observeDoubleStepParsing"><span class="hs-identifier hs-var hs-var">observeDoubleStepParsing</span></a></span></span><span> </span><span id="local-6989586621679478825"><span class="annot"><span class="annottext">parents :: ContextDouble SPitch
</span><a href="#local-6989586621679478825"><span class="hs-identifier hs-var">parents</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679478826"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679478826"><span class="hs-identifier hs-var">sliceL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478827"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679478827"><span class="hs-identifier hs-var">transL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478828"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679478828"><span class="hs-identifier hs-var">sliceM</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478829"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679478829"><span class="hs-identifier hs-var">transR</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679478830"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679478830"><span class="hs-identifier hs-var">sliceR</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679478831"><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621679478831"><span class="hs-identifier hs-var">decision</span></a></span></span><span> </span><span id="local-6989586621679478832"><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
</span><a href="#local-6989586621679478832"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1388"></span><span>  </span><span class="annot"><span class="annottext">(StateT (Trace PVParams) (Either String) ()
 -&gt; Trace PVParams -&gt; Either String (Trace PVParams))
-&gt; Trace PVParams
-&gt; StateT (Trace PVParams) (Either String) ()
-&gt; Either String (Trace PVParams)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">StateT (Trace PVParams) (Either String) ()
-&gt; Trace PVParams -&gt; Either String (Trace PVParams)
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m s
</span><span class="hs-identifier hs-var">execStateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Seq (String, Dynamic) -&gt; Trace PVParams
forall (r :: (* -&gt; *) -&gt; *). Seq (String, Dynamic) -&gt; Trace r
</span><span class="hs-identifier hs-var">Trace</span></span><span> </span><span class="annot"><span class="annottext">Seq (String, Dynamic)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT (Trace PVParams) (Either String) ()
 -&gt; Either String (Trace PVParams))
-&gt; StateT (Trace PVParams) (Either String) ()
-&gt; Either String (Trace PVParams)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1389"></span><span>    </span><span class="hs-comment">-- observe step but skip &quot;continueLeft&quot; decisions</span><span>
</span><span id="line-1390"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
</span><a href="#local-6989586621679478832"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1391"></span><span>      </span><span class="annot"><a href="Common.html#LMDoubleFreezeLeft"><span class="hs-identifier hs-type">LMDoubleFreezeLeft</span></a></span><span> </span><span id="local-6989586621679478833"><span class="annot"><span class="annottext">Freeze SPitch
</span><a href="#local-6989586621679478833"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1392"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldFreeze (double)&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeftFreeze"><span class="hs-identifier hs-var">pDoubleLeftFreeze</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1393"></span><span>        </span><span class="annot"><span class="annottext">ContextSingle SPitch
-&gt; Freeze SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeFreeze"><span class="hs-identifier hs-var">observeFreeze</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679478826"><span class="hs-identifier hs-var">sliceL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679478827"><span class="hs-identifier hs-var">transL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Notes SPitch -&gt; StartStop (Notes SPitch)
forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679478828"><span class="hs-identifier hs-var">sliceM</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Freeze SPitch
</span><a href="#local-6989586621679478833"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-1394"></span><span>      </span><span class="annot"><a href="Common.html#LMDoubleSplitLeft"><span class="hs-identifier hs-type">LMDoubleSplitLeft</span></a></span><span> </span><span id="local-6989586621679478837"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679478837"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1395"></span><span>        </span><span class="annot"><span class="annottext">Bool
-&gt; StateT (Trace PVParams) (Either String) ()
-&gt; StateT (Trace PVParams) (Either String) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Edges SPitch -&gt; Bool
forall n. (Eq (IntervalOf n), HasPitch n) =&gt; Edges n -&gt; Bool
</span><a href="PVGrammar.Generate.html#freezable"><span class="hs-identifier hs-var">freezable</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679478827"><span class="hs-identifier hs-var">transL</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT (Trace PVParams) (Either String) ()
 -&gt; StateT (Trace PVParams) (Either String) ())
-&gt; StateT (Trace PVParams) (Either String) ()
-&gt; StateT (Trace PVParams) (Either String) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1396"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldFreeze (double)&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeftFreeze"><span class="hs-identifier hs-var">pDoubleLeftFreeze</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1397"></span><span>        </span><span class="annot"><span class="annottext">ContextSingle SPitch
-&gt; Split SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeSplit"><span class="hs-identifier hs-var">observeSplit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679478826"><span class="hs-identifier hs-var">sliceL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679478827"><span class="hs-identifier hs-var">transL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Notes SPitch -&gt; StartStop (Notes SPitch)
forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679478828"><span class="hs-identifier hs-var">sliceM</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679478837"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1398"></span><span>      </span><span class="annot"><a href="Common.html#LMDoubleSplitRight"><span class="hs-identifier hs-type">LMDoubleSplitRight</span></a></span><span> </span><span id="local-6989586621679478841"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679478841"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1399"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldSplitRight&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleRightSplit"><span class="hs-identifier hs-var">pDoubleRightSplit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1400"></span><span>        </span><span class="annot"><span class="annottext">ContextSingle SPitch
-&gt; Split SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeSplit"><span class="hs-identifier hs-var">observeSplit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Notes SPitch -&gt; StartStop (Notes SPitch)
forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679478828"><span class="hs-identifier hs-var">sliceM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679478829"><span class="hs-identifier hs-var">transR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679478830"><span class="hs-identifier hs-var">sliceR</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679478841"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1401"></span><span>      </span><span class="annot"><a href="Common.html#LMDoubleSpread"><span class="hs-identifier hs-type">LMDoubleSpread</span></a></span><span> </span><span id="local-6989586621679478845"><span class="annot"><span class="annottext">Spread SPitch
</span><a href="#local-6989586621679478845"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1402"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldSplitRight&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleRightSplit"><span class="hs-identifier hs-var">pDoubleRightSplit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1403"></span><span>        </span><span class="annot"><span class="annottext">ContextDouble SPitch
-&gt; Spread SPitch -&gt; StateT (Trace PVParams) (Either String) ()
</span><a href="PVGrammar.Prob.Simple.html#observeSpread"><span class="hs-identifier hs-var">observeSpread</span></a></span><span> </span><span class="annot"><span class="annottext">ContextDouble SPitch
</span><a href="#local-6989586621679478825"><span class="hs-identifier hs-var">parents</span></a></span><span> </span><span class="annot"><span class="annottext">Spread SPitch
</span><a href="#local-6989586621679478845"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-1404"></span><span>    </span><span class="hs-comment">-- account for possible extra decision in next step, if this is a right split</span><span>
</span><span id="line-1405"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
</span><a href="#local-6989586621679478832"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1406"></span><span>      </span><span class="hs-comment">-- right split? no extra decision can follow</span><span>
</span><span id="line-1407"></span><span>      </span><span class="annot"><a href="Common.html#LMDoubleSplitRight"><span class="hs-identifier hs-type">LMDoubleSplitRight</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; StateT (Trace PVParams) (Either String) ()
forall a. a -&gt; StateT (Trace PVParams) (Either String) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1408"></span><span>      </span><span class="hs-comment">-- otherwise? possible extra decision</span><span>
</span><span id="line-1409"></span><span>      </span><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621679478831"><span class="hs-identifier hs-var">decision</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1410"></span><span>        </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; StateT (Trace PVParams) (Either String) ()
forall a. a -&gt; StateT (Trace PVParams) (Either String) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1411"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679478849"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679478849"><span class="hs-identifier hs-var">goLeft</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Bernoulli
-&gt; Accessor PVParams Beta
-&gt; Support Bernoulli
-&gt; StateT (Trace PVParams) (Either String) ()
forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;continueLeft&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; PVParams f -&gt; f (PVParams f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">((PVParamsOuter f -&gt; f (PVParamsOuter f))
 -&gt; PVParams f -&gt; f (PVParams f))
-&gt; ((f Beta -&gt; f (f Beta))
    -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f))
-&gt; (f Beta -&gt; f (f Beta))
-&gt; PVParams f
-&gt; f (PVParams f)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
forall (f :: * -&gt; *) (f :: * -&gt; *).
Functor f =&gt;
(f Beta -&gt; f (f Beta)) -&gt; PVParamsOuter f -&gt; f (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeft"><span class="hs-identifier hs-var">pDoubleLeft</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
Support Bernoulli
</span><a href="#local-6989586621679478849"><span class="hs-identifier hs-var">goLeft</span></a></span><span>
</span><span id="line-1412"></span><span>
</span><span id="line-1413"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#evalDoubleStep"><span class="hs-identifier hs-type">evalDoubleStep</span></a></span><span>
</span><span id="line-1414"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Probs</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span>
</span><span id="line-1415"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextDouble"><span class="hs-identifier hs-type">ContextDouble</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-1416"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.html#LeftmostDouble"><span class="hs-identifier hs-type">LeftmostDouble</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-1417"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1418"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1419"></span><span id="evalDoubleStep"><span class="annot"><span class="annottext">evalDoubleStep :: Probs PVParams
-&gt; ContextDouble SPitch
-&gt; LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
-&gt; Maybe Bool
-&gt; Either String (Maybe ((), Double))
</span><a href="PVGrammar.Prob.Simple.html#evalDoubleStep"><span class="hs-identifier hs-var hs-var">evalDoubleStep</span></a></span></span><span> </span><span id="local-6989586621679478853"><span class="annot"><span class="annottext">Probs PVParams
</span><a href="#local-6989586621679478853"><span class="hs-identifier hs-var">probs</span></a></span></span><span> </span><span id="local-6989586621679478854"><span class="annot"><span class="annottext">ContextDouble SPitch
</span><a href="#local-6989586621679478854"><span class="hs-identifier hs-var">parents</span></a></span></span><span> </span><span id="local-6989586621679478855"><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
</span><a href="#local-6989586621679478855"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621679478856"><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621679478856"><span class="hs-identifier hs-var">decision</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1420"></span><span>  </span><span id="local-6989586621679478857"><span class="annot"><a href="#local-6989586621679478857"><span class="hs-identifier hs-var">trace</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ContextDouble SPitch
-&gt; Maybe Bool
-&gt; LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
-&gt; Either String (Trace PVParams)
</span><a href="PVGrammar.Prob.Simple.html#observeDoubleStepParsing"><span class="hs-identifier hs-var">observeDoubleStepParsing</span></a></span><span> </span><span class="annot"><span class="annottext">ContextDouble SPitch
</span><a href="#local-6989586621679478854"><span class="hs-identifier hs-var">parents</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621679478856"><span class="hs-identifier hs-var">decision</span></a></span><span> </span><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) (Freeze SPitch) (Spread SPitch)
</span><a href="#local-6989586621679478855"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-1421"></span><span>  </span><span class="hs-comment">-- DT.traceM &quot;evalDoubleStep&quot;</span><span>
</span><span id="line-1422"></span><span>  </span><span class="hs-comment">-- DT.traceM $ show $ runTrace trace</span><span>
</span><span id="line-1423"></span><span>  </span><span class="hs-comment">-- let !_ = traceTrace trace $ sampleDoubleStepParsing parents op</span><span>
</span><span id="line-1424"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">evalTraceLogP</span></span><span> </span><span class="annot"><a href="#local-6989586621679478853"><span class="hs-identifier hs-type">probs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478857"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleDoubleStepParsing"><span class="hs-identifier hs-type">sampleDoubleStepParsing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478854"><span class="hs-identifier hs-type">parents</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679478855"><span class="hs-identifier hs-type">op</span></a></span><span>
</span><span id="line-1425"></span></pre></body></html>