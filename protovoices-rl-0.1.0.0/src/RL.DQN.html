<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DerivingStrategies #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GADTs #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE PartialTypeSignatures #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-partial-type-signatures #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# HLINT ignore &quot;Use &lt;$&gt;&quot; #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-unrecognised-pragmas #-}</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="RL.DQN.html"><span class="hs-identifier">RL.DQN</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Common</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Display</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">replayDerivation</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">viewGraph</span></span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GreedyParser</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Action</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ActionDouble</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ActionDouble</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ActionSingle</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ActionSingle</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">GreedyState</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">getActions</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">initParseState</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">parseGreedy</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">parseStep</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">pickRandom</span></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">PVGrammar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Edge</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Edges</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Edges</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Freeze</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">FreezeOp</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Notes</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Notes</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">PVAnalysis</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">PVLeftmost</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Split</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Spread</span></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">PVGrammar.Generate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">derivationPlayerPV</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">PVGrammar.Parse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">protoVoiceEvaluator</span></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">PVGrammar.Prob.Simple</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PVParams</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">evalDoubleStep</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">evalSingleStep</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">observeDerivation</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">observeDerivation'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">observeDoubleStepParsing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">observeSingleStepParsing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">sampleDerivation'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">sampleDoubleStepParsing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">sampleSingleStepParsing</span></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="RL.Callbacks.html"><span class="hs-identifier">RL.Callbacks</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="RL.Encoding.html"><span class="hs-identifier">RL.Encoding</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="RL.Model.html"><span class="hs-identifier">RL.Model</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="RL.ModelTypes.html"><span class="hs-identifier">RL.ModelTypes</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="RL.Plotting.html"><span class="hs-identifier">RL.Plotting</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="RL.ReplayBuffer.html"><span class="hs-identifier">RL.ReplayBuffer</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="RL.TorchHelpers.html"><span class="hs-identifier">RL.TorchHelpers</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TH</span></span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span class="hs-comment">-- import Control.DeepSeq (force)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Exception</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">catch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">onException</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">foldM</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">foldM_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">forM_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">replicateM</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">when</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ET</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Primitive</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">RealWorld</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ST</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">lift</span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">F</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.Extra</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">E</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vector</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Debug.Trace</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DT</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Float</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">double2Float</span></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Inference.Conjugate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hyper</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">HyperRep</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Prior</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">expectedProbs</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">evalTraceLogP</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">printTrace</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">sampleProbs</span></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Musicology.Pitch</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Random.MWC.Distributions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">categorical</span></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Random.MWC.Probability</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MWC</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Random.Stateful</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Rand</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">StatefulGen</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">UniformRange</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">uniformRM</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">split</span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Torch</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Torch.HList</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TT</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Torch.Lens</span></span><span> </span><span class="hs-keyword">qualified</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Torch.Typed</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TT</span></span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-comment">-- Notes</span><span>
</span><span id="line-50"></span><span class="hs-comment">-- -----</span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-comment">{-
Idee: Variant of Q-learning:
- instead of Q value (expected total reward) under optimal policy
  learn &quot;P value&quot;: expected probability under random policy
- does this lead to a policy where p(as) &#8733; reward?
  - then you learn a method of sampling from the reward distribution
  - if reward is a probability (e.g. p(deriv)), you learn to sample from that!
    - useful for unsupervised inference
- changes:
  - use proportional random policy (is this MC-tree-search?)
  - loss uses E[] instead of max over next actions.
-}</span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-comment">-- global settings</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- ---------------</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="hs-comment">-- discount factor</span><span>
</span><span id="line-69"></span><span id="local-6989586621679378051"><span class="annot"><a href="RL.DQN.html#gamma"><span class="hs-identifier hs-type">gamma</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TT.KnownDevice</span></span><span> </span><span class="annot"><a href="#local-6989586621679378051"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QTensor"><span class="hs-identifier hs-type">QTensor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378051"><span class="hs-identifier hs-type">dev</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span></span><span>
</span><span id="line-70"></span><span class="hs-comment">-- gamma = toOpts $ T.asTensor @Double 0.99</span><span>
</span><span id="line-71"></span><span id="gamma"><span class="annot"><span class="annottext">gamma :: forall (dev :: (DeviceType, Nat)).
KnownDevice dev =&gt;
QTensor dev '[]
</span><a href="RL.DQN.html#gamma"><span class="hs-identifier hs-var hs-var">gamma</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QTensor dev '[]
</span><span class="hs-number">0.99</span></span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span class="hs-comment">-- interpolation factor between target and policy net</span><span>
</span><span id="line-74"></span><span class="annot"><a href="RL.DQN.html#tau"><span class="hs-identifier hs-type">tau</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span> </span><span class="hs-comment">-- T.Tensor -- QTensor '[]</span><span>
</span><span id="line-75"></span><span class="hs-comment">-- tau = toOpts $ T.asTensor @Double 0.05</span><span>
</span><span id="line-76"></span><span id="tau"><span class="annot"><span class="annottext">tau :: QType
</span><a href="RL.DQN.html#tau"><span class="hs-identifier hs-var hs-var">tau</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType
</span><span class="hs-number">0.1</span></span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span id="local-6989586621679378061"><span class="annot"><a href="RL.DQN.html#learningRate"><span class="hs-identifier hs-type">learningRate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.ModelTypes.html#IsValidDevice"><span class="hs-identifier hs-type">IsValidDevice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378061"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.LearningRate</span></span><span> </span><span class="annot"><a href="#local-6989586621679378061"><span class="hs-identifier hs-type">dev</span></a></span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QDType"><span class="hs-identifier hs-type">QDType</span></a></span></span><span>
</span><span id="line-79"></span><span class="hs-comment">-- learningRate _ = 0.1</span><span>
</span><span id="line-80"></span><span class="hs-comment">-- learningRate progress = 0.01 + TT.mulScalar progress (-0.009)</span><span>
</span><span id="line-81"></span><span id="learningRate"><span class="annot"><span class="annottext">learningRate :: forall (dev :: (DeviceType, Nat)).
IsValidDevice dev =&gt;
QType -&gt; LearningRate dev QDType
</span><a href="RL.DQN.html#learningRate"><span class="hs-identifier hs-var hs-var">learningRate</span></a></span></span><span> </span><span id="local-6989586621679378732"><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679378732"><span class="hs-identifier hs-var">progress</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LearningRate dev QDType
</span><span class="hs-number">0.1</span></span><span> </span><span class="annot"><span class="annottext">LearningRate dev QDType
-&gt; LearningRate dev QDType -&gt; LearningRate dev QDType
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">LearningRate dev QDType -&gt; LearningRate dev QDType
forall (shape :: [Nat]) (dtype :: DType)
       (device :: (DeviceType, Nat)).
StandardFloatingPointDTypeValidation device dtype =&gt;
Tensor device dtype shape -&gt; Tensor device dtype shape
</span><span class="hs-identifier hs-var">TT.exp</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QType -&gt; LearningRate dev QDType -&gt; LearningRate dev QDType
forall a (shape :: [Nat]) (dtype :: DType)
       (device :: (DeviceType, Nat)).
Scalar a =&gt;
a -&gt; Tensor device dtype shape -&gt; Tensor device dtype shape
</span><span class="hs-identifier hs-var">TT.mulScalar</span></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679378732"><span class="hs-identifier hs-var">progress</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LearningRate dev QDType -&gt; LearningRate dev QDType
forall (shape :: [Nat]) (dtype :: DType)
       (device :: (DeviceType, Nat)).
Tensor device dtype shape -&gt; Tensor device dtype shape
</span><span class="hs-identifier hs-var">TT.log</span></span><span> </span><span class="annot"><span class="annottext">LearningRate dev QDType
</span><span class="hs-number">0.1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span class="hs-comment">-- replay buffer</span><span>
</span><span id="line-84"></span><span class="annot"><a href="RL.DQN.html#bufferSize"><span class="hs-identifier hs-type">bufferSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-85"></span><span id="bufferSize"><span class="annot"><span class="annottext">bufferSize :: Int
</span><a href="RL.DQN.html#bufferSize"><span class="hs-identifier hs-var hs-var">bufferSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1_000</span></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="annot"><a href="RL.DQN.html#replayN"><span class="hs-identifier hs-type">replayN</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-88"></span><span id="replayN"><span class="annot"><span class="annottext">replayN :: Int
</span><a href="RL.DQN.html#replayN"><span class="hs-identifier hs-var hs-var">replayN</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">200</span></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="hs-comment">-- exploration factors</span><span>
</span><span id="line-91"></span><span class="annot"><a href="RL.DQN.html#epsStart"><span class="hs-identifier hs-type">epsStart</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span>
</span><span id="line-92"></span><span id="epsStart"><span class="annot"><span class="annottext">epsStart :: QType
</span><a href="RL.DQN.html#epsStart"><span class="hs-identifier hs-var hs-var">epsStart</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType
</span><span class="hs-number">0.9</span></span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span class="annot"><a href="RL.DQN.html#epsEnd"><span class="hs-identifier hs-type">epsEnd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span>
</span><span id="line-95"></span><span id="epsEnd"><span class="annot"><span class="annottext">epsEnd :: QType
</span><a href="RL.DQN.html#epsEnd"><span class="hs-identifier hs-var hs-var">epsEnd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType
</span><span class="hs-number">0.2</span></span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-comment">-- epsDecay :: QType</span><span>
</span><span id="line-98"></span><span class="hs-comment">-- epsDecay = 2</span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="annot"><a href="RL.DQN.html#eps"><span class="hs-identifier hs-type">eps</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span>
</span><span id="line-101"></span><span id="eps"><span class="annot"><span class="annottext">eps :: Int -&gt; Int -&gt; QType
</span><a href="RL.DQN.html#eps"><span class="hs-identifier hs-var hs-var">eps</span></a></span></span><span> </span><span id="local-6989586621679378742"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679378742"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679378743"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679378743"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType -&gt; QType -&gt; QType -&gt; QType -&gt; QType
</span><a href="RL.Callbacks.html#expSchedule"><span class="hs-identifier hs-var">expSchedule</span></a></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="RL.DQN.html#epsStart"><span class="hs-identifier hs-var">epsStart</span></a></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="RL.DQN.html#epsEnd"><span class="hs-identifier hs-var">epsEnd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; QType
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679378743"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; QType
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679378742"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="hs-comment">-- device = T.Device T.CPU 0</span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-comment">-- Deep Q-Learning</span><span>
</span><span id="line-106"></span><span class="hs-comment">-- ---------------</span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="hs-keyword">data</span><span> </span><span id="DQNState"><span class="annot"><a href="RL.DQN.html#DQNState"><span class="hs-identifier hs-var">DQNState</span></a></span></span><span> </span><span id="local-6989586621679378092"><span class="annot"><a href="#local-6989586621679378092"><span class="hs-identifier hs-type">dev</span></a></span></span><span> </span><span id="local-6989586621679378093"><span class="annot"><a href="#local-6989586621679378093"><span class="hs-identifier hs-type">opt</span></a></span></span><span> </span><span id="local-6989586621679378094"><span class="annot"><a href="#local-6989586621679378094"><span class="hs-identifier hs-type">tr</span></a></span></span><span> </span><span id="local-6989586621679378095"><span class="annot"><a href="#local-6989586621679378095"><span class="hs-identifier hs-type">tr'</span></a></span></span><span> </span><span id="local-6989586621679378096"><span class="annot"><a href="#local-6989586621679378096"><span class="hs-identifier hs-type">slc</span></a></span></span><span> </span><span id="local-6989586621679378097"><span class="annot"><a href="#local-6989586621679378097"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679378098"><span class="annot"><a href="#local-6989586621679378098"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621679378099"><span class="annot"><a href="#local-6989586621679378099"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span id="local-6989586621679378100"><span class="annot"><a href="#local-6989586621679378100"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DQNState"><span class="annot"><a href="RL.DQN.html#DQNState"><span class="hs-identifier hs-var">DQNState</span></a></span></span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="pnet"><span class="annot"><span class="annottext">forall {k} (dev :: (DeviceType, Nat)) opt tr tr' slc s f h
       (r :: k).
DQNState dev opt tr tr' slc s f h r -&gt; QModel dev
</span><a href="RL.DQN.html#pnet"><span class="hs-identifier hs-var hs-var">pnet</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="RL.Model.html#QModel"><span class="hs-identifier hs-type">QModel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378092"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tnet"><span class="annot"><span class="annottext">forall {k} (dev :: (DeviceType, Nat)) opt tr tr' slc s f h
       (r :: k).
DQNState dev opt tr tr' slc s f h r -&gt; QModel dev
</span><a href="RL.DQN.html#tnet"><span class="hs-identifier hs-var hs-var">tnet</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="RL.Model.html#QModel"><span class="hs-identifier hs-type">QModel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378092"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="opt"><span class="annot"><span class="annottext">forall {k} (dev :: (DeviceType, Nat)) opt tr tr' slc s f h
       (r :: k).
DQNState dev opt tr tr' slc s f h r -&gt; opt
</span><a href="RL.DQN.html#opt"><span class="hs-identifier hs-var hs-var">opt</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679378093"><span class="hs-identifier hs-type">opt</span></a></span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="buffer"><span class="annot"><span class="annottext">forall {k} (dev :: (DeviceType, Nat)) opt tr tr' slc s f h
       (r :: k).
DQNState dev opt tr tr' slc s f h r
-&gt; ReplayBuffer dev tr tr' slc s f h
</span><a href="RL.DQN.html#buffer"><span class="hs-identifier hs-var hs-var">buffer</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="RL.ReplayBuffer.html#ReplayBuffer"><span class="hs-identifier hs-type">ReplayBuffer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378092"><span class="hs-identifier hs-type">dev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378094"><span class="hs-identifier hs-type">tr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378095"><span class="hs-identifier hs-type">tr'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378096"><span class="hs-identifier hs-type">slc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378097"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378098"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378099"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span class="hs-comment">-- epsilonGreedyPolicy</span><span>
</span><span id="line-116"></span><span class="hs-comment">--   :: (StatefulGen gen m)</span><span>
</span><span id="line-117"></span><span class="hs-comment">--   =&gt; gen</span><span>
</span><span id="line-118"></span><span class="hs-comment">--   -&gt; QType</span><span>
</span><span id="line-119"></span><span class="hs-comment">--   -&gt; (embedding -&gt; QTensor '[1])</span><span>
</span><span id="line-120"></span><span class="hs-comment">--   -&gt; [embedding]</span><span>
</span><span id="line-121"></span><span class="hs-comment">--   -&gt; m Int</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- epsilonGreedyPolicy gen epsilon q actions = do</span><span>
</span><span id="line-123"></span><span class="hs-comment">--   coin &lt;- uniformRM (0, 1) gen</span><span>
</span><span id="line-124"></span><span class="hs-comment">--   if coin &gt;= epsilon</span><span>
</span><span id="line-125"></span><span class="hs-comment">--     then pure $ T.asValue $ T.argmax (T.Dim 0) T.RemoveDim $ T.cat (T.Dim 0) (TT.toDynamic . q &lt;$&gt; actions)</span><span>
</span><span id="line-126"></span><span class="hs-comment">--     else do</span><span>
</span><span id="line-127"></span><span class="hs-comment">--       uniformRM (0, length actions - 1) gen</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span id="local-6989586621679378144"><span id="local-6989586621679378145"><span id="local-6989586621679378146"><span class="annot"><a href="RL.DQN.html#greedyPolicy"><span class="hs-identifier hs-type">greedyPolicy</span></a></span><span>
</span><span id="line-130"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="#local-6989586621679378144"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679378145"><span class="hs-identifier hs-type">embedding</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QTensor"><span class="hs-identifier hs-type">QTensor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378146"><span class="hs-identifier hs-type">dev</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679378145"><span class="hs-identifier hs-type">embedding</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679378144"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span></span></span><span>
</span><span id="line-134"></span><span id="greedyPolicy"><span class="annot"><span class="annottext">greedyPolicy :: forall (m :: * -&gt; *) embedding (dev :: (DeviceType, Nat)).
Applicative m =&gt;
(embedding -&gt; QTensor dev '[1]) -&gt; [embedding] -&gt; m Int
</span><a href="RL.DQN.html#greedyPolicy"><span class="hs-identifier hs-var hs-var">greedyPolicy</span></a></span></span><span> </span><span id="local-6989586621679378763"><span class="annot"><span class="annottext">embedding -&gt; QTensor dev '[1]
</span><a href="#local-6989586621679378763"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621679378764"><span class="annot"><span class="annottext">[embedding]
</span><a href="#local-6989586621679378764"><span class="hs-identifier hs-var">actions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-135"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; m Int
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; m Int) -&gt; Int -&gt; m Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tensor -&gt; Int
forall a. TensorLike a =&gt; Tensor -&gt; a
</span><span class="hs-identifier hs-var">T.asValue</span></span><span> </span><span class="annot"><span class="annottext">(Tensor -&gt; Int) -&gt; Tensor -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Dim -&gt; KeepDim -&gt; Tensor -&gt; Tensor
</span><span class="hs-identifier hs-var">T.argmax</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Dim
</span><span class="hs-identifier hs-var">T.Dim</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">KeepDim
</span><span class="hs-identifier hs-var">T.RemoveDim</span></span><span> </span><span class="annot"><span class="annottext">(Tensor -&gt; Tensor) -&gt; Tensor -&gt; Tensor
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Dim -&gt; [Tensor] -&gt; Tensor
</span><span class="hs-identifier hs-var">T.cat</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Dim
</span><span class="hs-identifier hs-var">T.Dim</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QTensor dev '[1] -&gt; Tensor
forall t. Unnamed t =&gt; t -&gt; Tensor
</span><span class="hs-identifier hs-var">TT.toDynamic</span></span><span> </span><span class="annot"><span class="annottext">(QTensor dev '[1] -&gt; Tensor)
-&gt; (embedding -&gt; QTensor dev '[1]) -&gt; embedding -&gt; Tensor
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">embedding -&gt; QTensor dev '[1]
</span><a href="#local-6989586621679378763"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">(embedding -&gt; Tensor) -&gt; [embedding] -&gt; [Tensor]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[embedding]
</span><a href="#local-6989586621679378764"><span class="hs-identifier hs-var">actions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span id="local-6989586621679378175"><span id="local-6989586621679378176"><span id="local-6989586621679378178"><span class="annot"><a href="RL.DQN.html#epsilonic"><span class="hs-identifier hs-type">epsilonic</span></a></span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StatefulGen</span></span><span> </span><span class="annot"><a href="#local-6989586621679378175"><span class="hs-identifier hs-type">gen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378176"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679378175"><span class="hs-identifier hs-type">gen</span></a></span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679378178"><span class="hs-identifier hs-type">embedding</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679378176"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679378178"><span class="hs-identifier hs-type">embedding</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679378176"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span></span></span><span>
</span><span id="line-144"></span><span id="epsilonic"><span class="annot"><span class="annottext">epsilonic :: forall gen (m :: * -&gt; *) embedding.
StatefulGen gen m =&gt;
gen -&gt; QType -&gt; ([embedding] -&gt; m Int) -&gt; [embedding] -&gt; m Int
</span><a href="RL.DQN.html#epsilonic"><span class="hs-identifier hs-var hs-var">epsilonic</span></a></span></span><span> </span><span id="local-6989586621679378794"><span class="annot"><span class="annottext">gen
</span><a href="#local-6989586621679378794"><span class="hs-identifier hs-var">gen</span></a></span></span><span> </span><span id="local-6989586621679378795"><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679378795"><span class="hs-identifier hs-var">epsilon</span></a></span></span><span> </span><span id="local-6989586621679378796"><span class="annot"><span class="annottext">[embedding] -&gt; m Int
</span><a href="#local-6989586621679378796"><span class="hs-identifier hs-var">policy</span></a></span></span><span> </span><span id="local-6989586621679378797"><span class="annot"><span class="annottext">[embedding]
</span><a href="#local-6989586621679378797"><span class="hs-identifier hs-var">actions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-145"></span><span>  </span><span id="local-6989586621679378798"><span class="annot"><a href="#local-6989586621679378798"><span class="hs-identifier hs-var">coin</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(QType, QType) -&gt; gen -&gt; m QType
forall a g (m :: * -&gt; *).
(UniformRange a, StatefulGen g m) =&gt;
(a, a) -&gt; g -&gt; m a
forall g (m :: * -&gt; *).
StatefulGen g m =&gt;
(QType, QType) -&gt; g -&gt; m QType
</span><span class="hs-identifier hs-var">uniformRM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QType
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">QType
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">gen
</span><a href="#local-6989586621679378794"><span class="hs-identifier hs-var">gen</span></a></span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679378798"><span class="hs-identifier hs-type">coin</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;=</span></span><span> </span><span class="annot"><a href="#local-6989586621679378795"><span class="hs-identifier hs-type">epsilon</span></a></span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="#local-6989586621679378796"><span class="hs-identifier hs-type">policy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378797"><span class="hs-identifier hs-type">actions</span></a></span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">uniformRM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">length</span></span><span> </span><span class="annot"><a href="#local-6989586621679378797"><span class="hs-identifier hs-type">actions</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">-</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679378794"><span class="hs-identifier hs-type">gen</span></a></span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span id="local-6989586621679378191"><span id="local-6989586621679378192"><span id="local-6989586621679378193"><span id="local-6989586621679378194"><span class="annot"><a href="RL.DQN.html#softmaxPolicy"><span class="hs-identifier hs-type">softmaxPolicy</span></a></span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StatefulGen</span></span><span> </span><span class="annot"><a href="#local-6989586621679378191"><span class="hs-identifier hs-type">gen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378192"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679378191"><span class="hs-identifier hs-type">gen</span></a></span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679378193"><span class="hs-identifier hs-type">embedding</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QTensor"><span class="hs-identifier hs-type">QTensor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378194"><span class="hs-identifier hs-type">dev</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679378193"><span class="hs-identifier hs-type">embedding</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679378192"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span></span></span></span><span>
</span><span id="line-156"></span><span id="softmaxPolicy"><span class="annot"><span class="annottext">softmaxPolicy :: forall gen (m :: * -&gt; *) embedding (dev :: (DeviceType, Nat)).
StatefulGen gen m =&gt;
gen -&gt; (embedding -&gt; QTensor dev '[1]) -&gt; [embedding] -&gt; m Int
</span><a href="RL.DQN.html#softmaxPolicy"><span class="hs-identifier hs-var hs-var">softmaxPolicy</span></a></span></span><span> </span><span id="local-6989586621679378814"><span class="annot"><span class="annottext">gen
</span><a href="#local-6989586621679378814"><span class="hs-identifier hs-var">gen</span></a></span></span><span> </span><span id="local-6989586621679378815"><span class="annot"><span class="annottext">embedding -&gt; QTensor dev '[1]
</span><a href="#local-6989586621679378815"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621679378816"><span class="annot"><span class="annottext">[embedding]
</span><a href="#local-6989586621679378816"><span class="hs-identifier hs-var">actions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679378817"><span class="annot"><span class="annottext">probs :: Tensor
</span><a href="#local-6989586621679378817"><span class="hs-identifier hs-var hs-var">probs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Dim -&gt; Tensor -&gt; Tensor
</span><span class="hs-identifier hs-var">T.softmax</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Dim
</span><span class="hs-identifier hs-var">T.Dim</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Tensor -&gt; Tensor) -&gt; Tensor -&gt; Tensor
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Dim -&gt; [Tensor] -&gt; Tensor
</span><span class="hs-identifier hs-var">T.cat</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Dim
</span><span class="hs-identifier hs-var">T.Dim</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Tensor] -&gt; Tensor) -&gt; [Tensor] -&gt; Tensor
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QTensor dev '[1] -&gt; Tensor
forall t. Unnamed t =&gt; t -&gt; Tensor
</span><span class="hs-identifier hs-var">TT.toDynamic</span></span><span> </span><span class="annot"><span class="annottext">(QTensor dev '[1] -&gt; Tensor)
-&gt; (embedding -&gt; QTensor dev '[1]) -&gt; embedding -&gt; Tensor
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">embedding -&gt; QTensor dev '[1]
</span><a href="#local-6989586621679378815"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">(embedding -&gt; Tensor) -&gt; [embedding] -&gt; [Tensor]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[embedding]
</span><a href="#local-6989586621679378816"><span class="hs-identifier hs-var">actions</span></a></span><span>
</span><span id="line-158"></span><span>  </span><span class="annot"><span class="annottext">Vector QType -&gt; gen -&gt; m Int
forall g (m :: * -&gt; *) (v :: * -&gt; *).
(StatefulGen g m, Vector v QType) =&gt;
v QType -&gt; g -&gt; m Int
</span><span class="hs-identifier hs-var">categorical</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[QType] -&gt; Vector QType
forall a. [a] -&gt; Vector a
</span><span class="hs-identifier hs-var">V.fromList</span></span><span> </span><span class="annot"><span class="annottext">([QType] -&gt; Vector QType) -&gt; [QType] -&gt; Vector QType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tensor -&gt; [QType]
forall a. TensorLike a =&gt; Tensor -&gt; a
</span><span class="hs-identifier hs-var">T.asValue</span></span><span> </span><span class="annot"><span class="annottext">(Tensor -&gt; [QType]) -&gt; Tensor -&gt; [QType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; Tensor -&gt; Tensor
</span><span class="hs-identifier hs-var">T.toDType</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><span class="hs-identifier hs-var">T.Double</span></span><span> </span><span class="annot"><span class="annottext">Tensor
</span><a href="#local-6989586621679378817"><span class="hs-identifier hs-var">probs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">gen
</span><a href="#local-6989586621679378814"><span class="hs-identifier hs-var">gen</span></a></span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span class="annot"><a href="RL.DQN.html#runEpisode"><span class="hs-identifier hs-type">runEpisode</span></a></span><span>
</span><span id="line-161"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679378220"><span class="annot"><a href="#local-6989586621679378220"><span class="hs-identifier hs-type">dev</span></a></span></span><span> </span><span id="local-6989586621679378209"><span class="annot"><a href="#local-6989586621679378209"><span class="hs-identifier hs-type">tr</span></a></span></span><span> </span><span id="local-6989586621679378210"><span class="annot"><a href="#local-6989586621679378210"><span class="hs-identifier hs-type">tr'</span></a></span></span><span> </span><span id="local-6989586621679378211"><span class="annot"><a href="#local-6989586621679378211"><span class="hs-identifier hs-type">slc</span></a></span></span><span> </span><span id="local-6989586621679378223"><span class="annot"><a href="#local-6989586621679378223"><span class="hs-identifier hs-type">slc'</span></a></span></span><span> </span><span id="local-6989586621679378212"><span class="annot"><a href="#local-6989586621679378212"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679378213"><span class="annot"><a href="#local-6989586621679378213"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621679378214"><span class="annot"><a href="#local-6989586621679378214"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span id="local-6989586621679378227"><span class="annot"><a href="#local-6989586621679378227"><span class="hs-identifier hs-type">gen</span></a></span></span><span> </span><span id="local-6989586621679378208"><span class="annot"><a href="#local-6989586621679378208"><span class="hs-identifier hs-type">state</span></a></span></span><span> </span><span id="local-6989586621679378217"><span class="annot"><a href="#local-6989586621679378217"><span class="hs-identifier hs-type">action</span></a></span></span><span> </span><span id="local-6989586621679378219"><span class="annot"><a href="#local-6989586621679378219"><span class="hs-identifier hs-type">encoding</span></a></span></span><span> </span><span id="local-6989586621679378222"><span class="annot"><a href="#local-6989586621679378222"><span class="hs-identifier hs-type">step</span></a></span></span><span>
</span><span id="line-162"></span><span>   </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="#local-6989586621679378208"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">GreedyState</span></span><span> </span><span class="annot"><a href="#local-6989586621679378209"><span class="hs-identifier hs-type">tr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378210"><span class="hs-identifier hs-type">tr'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378211"><span class="hs-identifier hs-type">slc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Leftmost</span></span><span> </span><span class="annot"><a href="#local-6989586621679378212"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378213"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378214"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679378217"><span class="hs-identifier hs-type">action</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Action</span></span><span> </span><span class="annot"><a href="#local-6989586621679378211"><span class="hs-identifier hs-type">slc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378209"><span class="hs-identifier hs-type">tr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378212"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378213"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378214"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-164"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679378219"><span class="hs-identifier hs-type">encoding</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="RL.Encoding.html#QEncoding"><span class="hs-identifier hs-type">QEncoding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378220"><span class="hs-identifier hs-type">dev</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-165"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679378222"><span class="hs-identifier hs-type">step</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679378208"><span class="hs-identifier hs-type">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679378217"><span class="hs-identifier hs-type">action</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679378219"><span class="hs-identifier hs-type">encoding</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679378208"><span class="hs-identifier hs-type">state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679378219"><span class="hs-identifier hs-type">encoding</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eval</span></span><span> </span><span class="annot"><a href="#local-6989586621679378209"><span class="hs-identifier hs-type">tr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378210"><span class="hs-identifier hs-type">tr'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378211"><span class="hs-identifier hs-type">slc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378223"><span class="hs-identifier hs-type">slc'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378214"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Leftmost</span></span><span> </span><span class="annot"><a href="#local-6989586621679378212"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378213"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378214"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679378208"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679378217"><span class="hs-identifier hs-type">action</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679378219"><span class="hs-identifier hs-type">encoding</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679378219"><span class="hs-identifier hs-type">encoding</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><a href="#local-6989586621679378223"><span class="hs-identifier hs-type">slc'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378210"><span class="hs-identifier hs-type">tr'</span></a></span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span>
</span><span id="line-172"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span>
</span><span id="line-173"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-174"></span><span>          </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679378222"><span class="hs-identifier hs-type">step</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Analysis</span></span><span> </span><span class="annot"><a href="#local-6989586621679378212"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378213"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378214"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378209"><span class="hs-identifier hs-type">tr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378211"><span class="hs-identifier hs-type">slc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span id="runEpisode"><span class="annot"><span class="annottext">runEpisode :: forall {k} (dev :: (DeviceType, Nat)) tr tr' slc slc' s f h
       (gen :: k) state action encoding step.
(state ~ GreedyState tr tr' slc (Leftmost s f h),
 action ~ Action slc tr s f h, encoding ~ QEncoding dev '[],
 step
 ~ (state, action, encoding, Maybe (state, [encoding]),
    Maybe Bool)) =&gt;
Eval tr tr' slc slc' h (Leftmost s f h)
-&gt; (state -&gt; action -&gt; encoding)
-&gt; ([encoding] -&gt; IO Int)
-&gt; Path slc' tr'
-&gt; IO (Either String ([step], Analysis s f h tr slc))
</span><a href="RL.DQN.html#runEpisode"><span class="hs-identifier hs-var hs-var">runEpisode</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679378879"><span class="annot"><span class="annottext">Eval tr tr' slc slc' h (Leftmost s f h)
</span><a href="#local-6989586621679378879"><span class="hs-identifier hs-var">eval</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679378880"><span class="annot"><span class="annottext">state -&gt; action -&gt; encoding
</span><a href="#local-6989586621679378880"><span class="hs-identifier hs-var">encode</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679378881"><span class="annot"><span class="annottext">[encoding] -&gt; IO Int
</span><a href="#local-6989586621679378881"><span class="hs-identifier hs-var">policyF</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679378882"><span class="annot"><span class="annottext">Path slc' tr'
</span><a href="#local-6989586621679378882"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-177"></span><span>  </span><span class="annot"><span class="annottext">StateT
  (Maybe (action, encoding), [encoding])
  IO
  (Either String ([step], Analysis s f h tr slc))
-&gt; (Maybe (action, encoding), [encoding])
-&gt; IO (Either String ([step], Analysis s f h tr slc))
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><span class="hs-identifier hs-var">ST.evalStateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExceptT
  String
  (StateT (Maybe (action, encoding), [encoding]) IO)
  ([step], Analysis s f h tr slc)
-&gt; StateT
     (Maybe (action, encoding), [encoding])
     IO
     (Either String ([step], Analysis s f h tr slc))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">ET.runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT
   String
   (StateT (Maybe (action, encoding), [encoding]) IO)
   ([step], Analysis s f h tr slc)
 -&gt; StateT
      (Maybe (action, encoding), [encoding])
      IO
      (Either String ([step], Analysis s f h tr slc)))
-&gt; ExceptT
     String
     (StateT (Maybe (action, encoding), [encoding]) IO)
     ([step], Analysis s f h tr slc)
-&gt; StateT
     (Maybe (action, encoding), [encoding])
     IO
     (Either String ([step], Analysis s f h tr slc))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(state, action, encoding, Maybe (state, [encoding]), Maybe Bool)]
-&gt; Maybe (state, Maybe (action, encoding), Maybe Bool)
-&gt; GreedyState tr tr' slc (Leftmost s f h)
-&gt; ExceptT
     String
     (StateT (Maybe (action, encoding), [encoding]) IO)
     ([(state, action, encoding, Maybe (state, [encoding]),
        Maybe Bool)],
      Analysis s f h tr slc)
</span><a href="#local-6989586621679378885"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Maybe (state, Maybe (action, encoding), Maybe Bool)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(GreedyState tr tr' slc (Leftmost s f h)
 -&gt; ExceptT
      String
      (StateT (Maybe (action, encoding), [encoding]) IO)
      ([step], Analysis s f h tr slc))
-&gt; GreedyState tr tr' slc (Leftmost s f h)
-&gt; ExceptT
     String
     (StateT (Maybe (action, encoding), [encoding]) IO)
     ([step], Analysis s f h tr slc)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Eval tr tr' slc slc' h (Leftmost s f h)
-&gt; Path slc' tr' -&gt; GreedyState tr tr' slc (Leftmost s f h)
forall tr tr' slc slc' h v op.
Eval tr tr' slc slc' h v
-&gt; Path slc' tr' -&gt; GreedyState tr tr' slc op
</span><span class="hs-identifier hs-var">initParseState</span></span><span> </span><span class="annot"><span class="annottext">Eval tr tr' slc slc' h (Leftmost s f h)
</span><a href="#local-6989586621679378879"><span class="hs-identifier hs-var">eval</span></a></span><span> </span><span class="annot"><span class="annottext">Path slc' tr'
</span><a href="#local-6989586621679378882"><span class="hs-identifier hs-var">input</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (action, encoding)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-179"></span><span>  </span><span class="hs-comment">-- go :: [step] -&gt; (state, Maybe (action, encoding), Maybe Bool) -&gt; state -&gt; [step]</span><span>
</span><span id="line-180"></span><span>  </span><span id="local-6989586621679378885"><span class="annot"><span class="annottext">go :: [(state, action, encoding, Maybe (state, [encoding]), Maybe Bool)]
-&gt; Maybe (state, Maybe (action, encoding), Maybe Bool)
-&gt; GreedyState tr tr' slc (Leftmost s f h)
-&gt; ExceptT
     String
     (StateT (Maybe (action, encoding), [encoding]) IO)
     ([(state, action, encoding, Maybe (state, [encoding]),
        Maybe Bool)],
      Analysis s f h tr slc)
</span><a href="#local-6989586621679378885"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679378886"><span class="annot"><span class="annottext">[(state, action, encoding, Maybe (state, [encoding]), Maybe Bool)]
</span><a href="#local-6989586621679378886"><span class="hs-identifier hs-var">transitions</span></a></span></span><span> </span><span id="local-6989586621679378887"><span class="annot"><span class="annottext">Maybe (state, Maybe (action, encoding), Maybe Bool)
</span><a href="#local-6989586621679378887"><span class="hs-identifier hs-var">prev</span></a></span></span><span> </span><span id="local-6989586621679378888"><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679378888"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-181"></span><span>    </span><span class="hs-comment">-- run step</span><span>
</span><span id="line-182"></span><span>    </span><span class="annot"><span class="annottext">(Maybe (Action slc tr s f h, QEncoding dev '[]),
 [QEncoding dev '[]])
-&gt; ExceptT
     String (StateT (Maybe (action, encoding), [encoding]) IO) ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><span class="hs-identifier hs-var">ST.put</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Action slc tr s f h, QEncoding dev '[])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- TODO: have parseStep return the action instead of using State</span><span>
</span><span id="line-183"></span><span>    </span><span id="local-6989586621679378890"><span class="annot"><a href="#local-6989586621679378890"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eval tr tr' slc slc' h (Leftmost s f h)
-&gt; ([Action slc tr s f h]
    -&gt; ExceptT
         String
         (StateT (Maybe (action, encoding), [encoding]) IO)
         (Action slc tr s f h))
-&gt; GreedyState tr tr' slc (Leftmost s f h)
-&gt; ExceptT
     String
     (StateT (Maybe (action, encoding), [encoding]) IO)
     (Either
        (GreedyState tr tr' slc (Leftmost s f h)) (tr, [Leftmost s f h]))
forall (m :: * -&gt; *) tr tr' slc slc' s f h.
Monad m =&gt;
Eval tr tr' slc slc' h (Leftmost s f h)
-&gt; ([Action slc tr s f h]
    -&gt; ExceptT String m (Action slc tr s f h))
-&gt; GreedyState tr tr' slc (Leftmost s f h)
-&gt; ExceptT
     String
     m
     (Either
        (GreedyState tr tr' slc (Leftmost s f h)) (tr, [Leftmost s f h]))
</span><span class="hs-identifier hs-var">parseStep</span></span><span> </span><span class="annot"><span class="annottext">Eval tr tr' slc slc' h (Leftmost s f h)
</span><a href="#local-6989586621679378879"><span class="hs-identifier hs-var">eval</span></a></span><span> </span><span class="annot"><span class="annottext">[action]
-&gt; ExceptT
     String (StateT (Maybe (action, encoding), [encoding]) IO) action
[Action slc tr s f h]
-&gt; ExceptT
     String
     (StateT (Maybe (action, encoding), [encoding]) IO)
     (Action slc tr s f h)
</span><a href="#local-6989586621679378891"><span class="hs-identifier hs-var">policy</span></a></span><span> </span><span class="annot"><span class="annottext">state
GreedyState tr tr' slc (Leftmost s f h)
</span><a href="#local-6989586621679378888"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679378892"><span class="annot"><a href="#local-6989586621679378892"><span class="hs-identifier hs-var">actionAndEncoding</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679378893"><span class="annot"><a href="#local-6989586621679378893"><span class="hs-identifier hs-var">actions</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST.get</span></span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-comment">-- add previous step if it exists</span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679378895"><span class="annot"><a href="#local-6989586621679378895"><span class="hs-identifier hs-var hs-var">transitions'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (state, Maybe (action, encoding), Maybe Bool)
</span><a href="#local-6989586621679378887"><span class="hs-identifier hs-var">prev</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-187"></span><span>          </span><span class="annot"><span class="annottext">Maybe (state, Maybe (action, encoding), Maybe Bool)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(state, action, encoding, Maybe (state, [encoding]), Maybe Bool)]
</span><a href="#local-6989586621679378886"><span class="hs-identifier hs-var">transitions</span></a></span><span>
</span><span id="line-188"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679378896"><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679378896"><span class="hs-identifier hs-var">prevState</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679378897"><span class="annot"><span class="annottext">Maybe (action, encoding)
</span><a href="#local-6989586621679378897"><span class="hs-identifier hs-var">prevAction</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679378898"><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621679378898"><span class="hs-identifier hs-var">goLeft</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-189"></span><span>            </span><span class="annot"><span class="annottext">state
-&gt; Maybe (action, encoding)
-&gt; Maybe (state, [encoding])
-&gt; Maybe Bool
-&gt; [(state, action, encoding, Maybe (state, [encoding]),
     Maybe Bool)]
-&gt; [(state, action, encoding, Maybe (state, [encoding]),
     Maybe Bool)]
</span><a href="#local-6989586621679378899"><span class="hs-identifier hs-var">addStep</span></a></span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679378896"><span class="hs-identifier hs-var">prevState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (action, encoding)
</span><a href="#local-6989586621679378897"><span class="hs-identifier hs-var">prevAction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(state, [encoding]) -&gt; Maybe (state, [encoding])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679378888"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[encoding]
</span><a href="#local-6989586621679378893"><span class="hs-identifier hs-var">actions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621679378898"><span class="hs-identifier hs-var">goLeft</span></a></span><span> </span><span class="annot"><span class="annottext">[(state, action, encoding, Maybe (state, [encoding]), Maybe Bool)]
</span><a href="#local-6989586621679378886"><span class="hs-identifier hs-var">transitions</span></a></span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-comment">-- get previous &quot;continueLeft&quot; decision from previous action</span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679378900"><span class="annot"><a href="#local-6989586621679378900"><span class="hs-identifier hs-var hs-var">goLeft'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (state, Maybe (action, encoding), Maybe Bool)
</span><a href="#local-6989586621679378887"><span class="hs-identifier hs-var">prev</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-192"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">state
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ActionDouble</span></span><span> </span><span class="annot"><span class="annottext">DoubleParent slc tr
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679378901"><span class="annot"><span class="annottext">LeftmostDouble s f h
</span><a href="#local-6989586621679378901"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">encoding
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LeftmostDouble s f h
</span><a href="#local-6989586621679378901"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-193"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">LMDoubleFreezeLeft</span></span><span> </span><span class="annot"><span class="annottext">f
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-194"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">LMDoubleSplitLeft</span></span><span> </span><span class="annot"><span class="annottext">s
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-195"></span><span>            </span><span class="annot"><span class="annottext">LeftmostDouble s f h
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-196"></span><span>          </span><span class="annot"><span class="annottext">Maybe (state, Maybe (action, encoding), Maybe Bool)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-comment">-- evaluate current step</span><span>
</span><span id="line-198"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679378890"><span class="hs-identifier hs-type">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-199"></span><span>      </span><span class="hs-comment">-- done parsing</span><span>
</span><span id="line-200"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679378904"><span class="annot"><span class="annottext">tr
</span><a href="#local-6989586621679378904"><span class="hs-identifier hs-var">top</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679378905"><span class="annot"><span class="annottext">[Leftmost s f h]
</span><a href="#local-6989586621679378905"><span class="hs-identifier hs-var">deriv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-201"></span><span>        </span><span class="annot"><span class="annottext">([(state, action, encoding, Maybe (state, [encoding]),
   Maybe Bool)],
 Analysis s f h tr slc)
-&gt; ExceptT
     String
     (StateT (Maybe (action, encoding), [encoding]) IO)
     ([(state, action, encoding, Maybe (state, [encoding]),
        Maybe Bool)],
      Analysis s f h tr slc)
forall a.
a
-&gt; ExceptT
     String (StateT (Maybe (action, encoding), [encoding]) IO) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">state
-&gt; Maybe (action, encoding)
-&gt; Maybe (state, [encoding])
-&gt; Maybe Bool
-&gt; [(state, action, encoding, Maybe (state, [encoding]),
     Maybe Bool)]
-&gt; [(state, action, encoding, Maybe (state, [encoding]),
     Maybe Bool)]
</span><a href="#local-6989586621679378899"><span class="hs-identifier hs-var">addStep</span></a></span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679378888"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (action, encoding)
</span><a href="#local-6989586621679378892"><span class="hs-identifier hs-var">actionAndEncoding</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (state, [encoding])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621679378900"><span class="hs-identifier hs-var">goLeft'</span></a></span><span> </span><span class="annot"><span class="annottext">[(state, action, encoding, Maybe (state, [encoding]), Maybe Bool)]
</span><a href="#local-6989586621679378895"><span class="hs-identifier hs-var">transitions'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Leftmost s f h] -&gt; Path tr slc -&gt; Analysis s f h tr slc
forall s f h tr slc.
[Leftmost s f h] -&gt; Path tr slc -&gt; Analysis s f h tr slc
</span><span class="hs-identifier hs-var">Analysis</span></span><span> </span><span class="annot"><span class="annottext">[Leftmost s f h]
</span><a href="#local-6989586621679378905"><span class="hs-identifier hs-var">deriv</span></a></span><span> </span><span class="annot"><span class="annottext">(Path tr slc -&gt; Analysis s f h tr slc)
-&gt; Path tr slc -&gt; Analysis s f h tr slc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">tr -&gt; Path tr slc
forall around between. around -&gt; Path around between
</span><span class="hs-identifier hs-var">PathEnd</span></span><span> </span><span class="annot"><span class="annottext">tr
</span><a href="#local-6989586621679378904"><span class="hs-identifier hs-var">top</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>      </span><span class="hs-comment">-- continue parsing</span><span>
</span><span id="line-203"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679378908"><span class="annot"><span class="annottext">GreedyState tr tr' slc (Leftmost s f h)
</span><a href="#local-6989586621679378908"><span class="hs-identifier hs-var">state'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(state, action, encoding, Maybe (state, [encoding]), Maybe Bool)]
-&gt; Maybe (state, Maybe (action, encoding), Maybe Bool)
-&gt; GreedyState tr tr' slc (Leftmost s f h)
-&gt; ExceptT
     String
     (StateT (Maybe (action, encoding), [encoding]) IO)
     ([(state, action, encoding, Maybe (state, [encoding]),
        Maybe Bool)],
      Analysis s f h tr slc)
</span><a href="#local-6989586621679378885"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[(state, action, encoding, Maybe (state, [encoding]), Maybe Bool)]
</span><a href="#local-6989586621679378895"><span class="hs-identifier hs-var">transitions'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(state, Maybe (action, encoding), Maybe Bool)
-&gt; Maybe (state, Maybe (action, encoding), Maybe Bool)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679378888"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (action, encoding)
</span><a href="#local-6989586621679378892"><span class="hs-identifier hs-var">actionAndEncoding</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621679378900"><span class="hs-identifier hs-var">goLeft'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">GreedyState tr tr' slc (Leftmost s f h)
</span><a href="#local-6989586621679378908"><span class="hs-identifier hs-var">state'</span></a></span><span>
</span><span id="line-204"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-205"></span><span>    </span><span class="annot"><a href="#local-6989586621679378899"><span class="hs-identifier hs-type">addStep</span></a></span><span>
</span><span id="line-206"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679378208"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-207"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679378217"><span class="hs-identifier hs-type">action</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679378219"><span class="hs-identifier hs-type">encoding</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679378208"><span class="hs-identifier hs-type">state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679378219"><span class="hs-identifier hs-type">encoding</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-210"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679378208"><span class="hs-identifier hs-type">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679378217"><span class="hs-identifier hs-type">action</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679378219"><span class="hs-identifier hs-type">encoding</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679378208"><span class="hs-identifier hs-type">state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679378219"><span class="hs-identifier hs-type">encoding</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-211"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679378208"><span class="hs-identifier hs-type">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679378217"><span class="hs-identifier hs-type">action</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679378219"><span class="hs-identifier hs-type">encoding</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679378208"><span class="hs-identifier hs-type">state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679378219"><span class="hs-identifier hs-type">encoding</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-212"></span><span>    </span><span id="local-6989586621679378899"><span class="annot"><span class="annottext">addStep :: state
-&gt; Maybe (action, encoding)
-&gt; Maybe (state, [encoding])
-&gt; Maybe Bool
-&gt; [(state, action, encoding, Maybe (state, [encoding]),
     Maybe Bool)]
-&gt; [(state, action, encoding, Maybe (state, [encoding]),
     Maybe Bool)]
</span><a href="#local-6989586621679378899"><span class="hs-identifier hs-var hs-var">addStep</span></a></span></span><span> </span><span id="local-6989586621679378909"><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679378909"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (action, encoding)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span id="local-6989586621679378910"><span class="annot"><span class="annottext">Maybe (state, [encoding])
</span><a href="#local-6989586621679378910"><span class="hs-identifier hs-var">_next</span></a></span></span><span> </span><span id="local-6989586621679378911"><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621679378911"><span class="hs-identifier hs-var">_goLeft</span></a></span></span><span> </span><span id="local-6989586621679378912"><span class="annot"><span class="annottext">[(state, action, encoding, Maybe (state, [encoding]), Maybe Bool)]
</span><a href="#local-6989586621679378912"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(state, action, encoding, Maybe (state, [encoding]), Maybe Bool)]
</span><a href="#local-6989586621679378912"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-213"></span><span>    </span><span class="annot"><a href="#local-6989586621679378899"><span class="hs-identifier hs-var">addStep</span></a></span><span> </span><span id="local-6989586621679378913"><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679378913"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679378914"><span class="annot"><span class="annottext">action
</span><a href="#local-6989586621679378914"><span class="hs-identifier hs-var">action</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679378915"><span class="annot"><span class="annottext">encoding
</span><a href="#local-6989586621679378915"><span class="hs-identifier hs-var">actEnc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679378916"><span class="annot"><span class="annottext">Maybe (state, [encoding])
</span><a href="#local-6989586621679378916"><span class="hs-identifier hs-var">next</span></a></span></span><span> </span><span id="local-6989586621679378917"><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621679378917"><span class="hs-identifier hs-var">goLeft</span></a></span></span><span> </span><span id="local-6989586621679378918"><span class="annot"><span class="annottext">[(state, action, encoding, Maybe (state, [encoding]), Maybe Bool)]
</span><a href="#local-6989586621679378918"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679378913"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">action
</span><a href="#local-6989586621679378914"><span class="hs-identifier hs-var">action</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">encoding
</span><a href="#local-6989586621679378915"><span class="hs-identifier hs-var">actEnc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (state, [encoding])
</span><a href="#local-6989586621679378916"><span class="hs-identifier hs-var">next</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621679378917"><span class="hs-identifier hs-var">goLeft</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(state, action, encoding, Maybe (state, [encoding]), Maybe Bool)
-&gt; [(state, action, encoding, Maybe (state, [encoding]),
     Maybe Bool)]
-&gt; [(state, action, encoding, Maybe (state, [encoding]),
     Maybe Bool)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(state, action, encoding, Maybe (state, [encoding]), Maybe Bool)]
</span><a href="#local-6989586621679378918"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span>    </span><span class="annot"><a href="#local-6989586621679378891"><span class="hs-identifier hs-type">policy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679378217"><span class="hs-identifier hs-type">action</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ET.ExceptT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ST.StateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679378217"><span class="hs-identifier hs-type">action</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679378219"><span class="hs-identifier hs-type">encoding</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679378219"><span class="hs-identifier hs-type">encoding</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679378217"><span class="hs-identifier hs-type">action</span></a></span><span>
</span><span id="line-216"></span><span>    </span><span id="local-6989586621679378891"><span class="annot"><span class="annottext">policy :: [action]
-&gt; ExceptT
     String (StateT (Maybe (action, encoding), [encoding]) IO) action
</span><a href="#local-6989586621679378891"><span class="hs-identifier hs-var hs-var">policy</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
-&gt; ExceptT
     String (StateT (Maybe (action, encoding), [encoding]) IO) action
forall a.
String
-&gt; ExceptT
     String (StateT (Maybe (action, encoding), [encoding]) IO) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">ET.throwError</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;no actions to select from&quot;</span></span><span>
</span><span id="line-217"></span><span>    </span><span class="annot"><a href="#local-6989586621679378891"><span class="hs-identifier hs-var">policy</span></a></span><span> </span><span id="local-6989586621679378920"><span class="annot"><span class="annottext">[action]
</span><a href="#local-6989586621679378920"><span class="hs-identifier hs-var">actions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-218"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679378921"><span class="annot"><span class="annottext">encodings :: [encoding]
</span><a href="#local-6989586621679378921"><span class="hs-identifier hs-var hs-var hs-var">encodings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">state -&gt; action -&gt; encoding
</span><a href="#local-6989586621679378880"><span class="hs-identifier hs-var">encode</span></a></span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679378888"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">(action -&gt; encoding) -&gt; [action] -&gt; [encoding]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[action]
</span><a href="#local-6989586621679378920"><span class="hs-identifier hs-var">actions</span></a></span><span>
</span><span id="line-219"></span><span>      </span><span id="local-6989586621679378922"><span class="annot"><a href="#local-6989586621679378922"><span class="hs-identifier hs-var">actionIndex</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT (Maybe (action, encoding), [encoding]) IO Int
-&gt; ExceptT
     String (StateT (Maybe (action, encoding), [encoding]) IO) Int
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT String m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT (Maybe (action, encoding), [encoding]) IO Int
 -&gt; ExceptT
      String (StateT (Maybe (action, encoding), [encoding]) IO) Int)
-&gt; StateT (Maybe (action, encoding), [encoding]) IO Int
-&gt; ExceptT
     String (StateT (Maybe (action, encoding), [encoding]) IO) Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO Int -&gt; StateT (Maybe (action, encoding), [encoding]) IO Int
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (Maybe (action, encoding), [encoding]) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(IO Int -&gt; StateT (Maybe (action, encoding), [encoding]) IO Int)
-&gt; IO Int -&gt; StateT (Maybe (action, encoding), [encoding]) IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[encoding] -&gt; IO Int
</span><a href="#local-6989586621679378881"><span class="hs-identifier hs-var">policyF</span></a></span><span> </span><span class="annot"><span class="annottext">[encoding]
</span><a href="#local-6989586621679378921"><span class="hs-identifier hs-var">encodings</span></a></span><span>
</span><span id="line-220"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679378923"><span class="annot"><a href="#local-6989586621679378923"><span class="hs-identifier hs-var hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[action]
</span><a href="#local-6989586621679378920"><span class="hs-identifier hs-var">actions</span></a></span><span> </span><span class="annot"><span class="annottext">[action] -&gt; Int -&gt; action
forall a. HasCallStack =&gt; [a] -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">!!</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679378922"><span class="hs-identifier hs-var">actionIndex</span></a></span><span>
</span><span id="line-221"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">ST.put</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679378920"><span class="hs-identifier hs-type">actions</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">!!</span></span><span> </span><span class="annot"><a href="#local-6989586621679378922"><span class="hs-identifier hs-type">actionIndex</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679378921"><span class="hs-identifier hs-type">encodings</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">!!</span></span><span> </span><span class="annot"><a href="#local-6989586621679378922"><span class="hs-identifier hs-type">actionIndex</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679378921"><span class="hs-identifier hs-type">encodings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621679378923"><span class="hs-identifier hs-type">action</span></a></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span class="annot"><a href="RL.DQN.html#trainLoop"><span class="hs-identifier hs-type">trainLoop</span></a></span><span>
</span><span id="line-225"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679378926"><span class="annot"><a href="#local-6989586621679378926"><span class="hs-identifier hs-type">dev</span></a></span></span><span> </span><span id="local-6989586621679378927"><span class="annot"><a href="#local-6989586621679378927"><span class="hs-identifier hs-type">tr</span></a></span></span><span> </span><span id="local-6989586621679378928"><span class="annot"><a href="#local-6989586621679378928"><span class="hs-identifier hs-type">tr'</span></a></span></span><span> </span><span id="local-6989586621679378929"><span class="annot"><a href="#local-6989586621679378929"><span class="hs-identifier hs-type">slc</span></a></span></span><span> </span><span id="local-6989586621679378930"><span class="annot"><a href="#local-6989586621679378930"><span class="hs-identifier hs-type">slc'</span></a></span></span><span> </span><span id="local-6989586621679378931"><span class="annot"><a href="#local-6989586621679378931"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679378932"><span class="annot"><a href="#local-6989586621679378932"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621679378933"><span class="annot"><a href="#local-6989586621679378933"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span id="local-6989586621679378934"><span class="annot"><a href="#local-6989586621679378934"><span class="hs-identifier hs-type">gen</span></a></span></span><span> </span><span id="local-6989586621679378935"><span class="annot"><a href="#local-6989586621679378935"><span class="hs-identifier hs-type">opt</span></a></span></span><span> </span><span class="hs-comment">-- params (grads :: [Type])</span><span>
</span><span id="line-226"></span><span>   </span><span class="hs-operator">.</span><span> </span><span class="hs-comment">-- . ( StatefulGen gen IO</span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-comment">--   , params ~ TT.Parameters QModel</span><span>
</span><span id="line-228"></span><span>  </span><span class="hs-comment">--   , TT.HasGrad (TT.HList params) (TT.HList grads)</span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-comment">--   , TT.Optimizer opt grads grads T.Double QDevice</span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-comment">--   , TT.HMap' TT.ToDependent params grads</span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-comment">--   , TT.HFoldrM IO TT.TensorListFold [T.ATenTensor] grads [T.ATenTensor]</span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-comment">--   , TT.Apply TT.TensorListUnfold [T.ATenTensor] (TT.HUnfoldMRes IO [T.ATenTensor] grads)</span><span>
</span><span id="line-233"></span><span>  </span><span class="hs-comment">--   , TT.HUnfoldM IO TT.TensorListUnfold (TT.HUnfoldMRes IO [T.ATenTensor] grads) grads</span><span>
</span><span id="line-234"></span><span>  </span><span class="hs-comment">--   -- , Show opt</span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-comment">--   )</span><span>
</span><span id="line-236"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679378934"><span class="hs-identifier hs-type">gen</span></a></span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eval</span></span><span> </span><span class="annot"><a href="#local-6989586621679378927"><span class="hs-identifier hs-type">tr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378928"><span class="hs-identifier hs-type">tr'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378929"><span class="hs-identifier hs-type">slc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378930"><span class="hs-identifier hs-type">slc'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378933"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Leftmost</span></span><span> </span><span class="annot"><a href="#local-6989586621679378931"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378932"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378933"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GreedyState</span></span><span> </span><span class="annot"><a href="#local-6989586621679378927"><span class="hs-identifier hs-type">tr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378928"><span class="hs-identifier hs-type">tr'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378929"><span class="hs-identifier hs-type">slc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Leftmost</span></span><span> </span><span class="annot"><a href="#local-6989586621679378931"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378932"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378933"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Action</span></span><span> </span><span class="annot"><a href="#local-6989586621679378929"><span class="hs-identifier hs-type">slc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378927"><span class="hs-identifier hs-type">tr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378931"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378932"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378933"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.Encoding.html#QEncoding"><span class="hs-identifier hs-type">QEncoding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378926"><span class="hs-identifier hs-type">dev</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Analysis</span></span><span> </span><span class="annot"><a href="#local-6989586621679378931"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378932"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378933"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378927"><span class="hs-identifier hs-type">tr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378929"><span class="hs-identifier hs-type">slc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Action</span></span><span> </span><span class="annot"><a href="#local-6989586621679378929"><span class="hs-identifier hs-type">slc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378927"><span class="hs-identifier hs-type">tr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378931"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378932"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378933"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><a href="#local-6989586621679378930"><span class="hs-identifier hs-type">slc'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378928"><span class="hs-identifier hs-type">tr'</span></a></span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.DQN.html#DQNState"><span class="hs-identifier hs-type">DQNState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378926"><span class="hs-identifier hs-type">dev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378935"><span class="hs-identifier hs-type">opt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378927"><span class="hs-identifier hs-type">tr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378928"><span class="hs-identifier hs-type">tr'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378929"><span class="hs-identifier hs-type">slc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378931"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378932"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378933"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.DQN.html#DQNState"><span class="hs-identifier hs-type">DQNState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378926"><span class="hs-identifier hs-type">dev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378935"><span class="hs-identifier hs-type">opt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378927"><span class="hs-identifier hs-type">tr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378928"><span class="hs-identifier hs-type">tr'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378929"><span class="hs-identifier hs-type">slc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378931"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378932"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378933"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span id="trainLoop"><span class="annot"><span class="annottext">trainLoop :: gen
-&gt; Eval tr tr' slc slc' h (Leftmost s f h)
-&gt; (GreedyState tr tr' slc (Leftmost s f h)
    -&gt; Action slc tr s f h -&gt; QEncoding dev '[])
-&gt; (Analysis s f h tr slc -&gt; IO QType)
-&gt; (Action slc tr s f h -&gt; Maybe Bool -&gt; IO QType)
-&gt; Path slc' tr'
-&gt; DQNState dev opt tr tr' slc s f h QType
-&gt; Int
-&gt; Int
-&gt; IO (DQNState dev opt tr tr' slc s f h QType, QType, QType)
</span><a href="RL.DQN.html#trainLoop"><span class="hs-identifier hs-var hs-var">trainLoop</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679384015"><span class="annot"><span class="annottext">gen
</span><a href="#local-6989586621679384015"><span class="hs-identifier hs-var">gen</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679384016"><span class="annot"><span class="annottext">Eval tr tr' slc slc' h (Leftmost s f h)
</span><a href="#local-6989586621679384016"><span class="hs-identifier hs-var">eval</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679384017"><span class="annot"><span class="annottext">GreedyState tr tr' slc (Leftmost s f h)
-&gt; Action slc tr s f h -&gt; QEncoding dev '[]
</span><a href="#local-6989586621679384017"><span class="hs-identifier hs-var">encode</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679384018"><span class="annot"><span class="annottext">Analysis s f h tr slc -&gt; IO QType
</span><a href="#local-6989586621679384018"><span class="hs-identifier hs-var">reward</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679384019"><span class="annot"><span class="annottext">Action slc tr s f h -&gt; Maybe Bool -&gt; IO QType
</span><a href="#local-6989586621679384019"><span class="hs-identifier hs-var">rewardStep</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679384020"><span class="annot"><span class="annottext">Path slc' tr'
</span><a href="#local-6989586621679384020"><span class="hs-identifier hs-var">piece</span></a></span></span><span> </span><span id="local-6989586621679384021"><span class="annot"><span class="annottext">oldstate :: DQNState dev opt tr tr' slc s f h QType
</span><a href="#local-6989586621679384021"><span class="hs-identifier hs-var">oldstate</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="RL.DQN.html#DQNState"><span class="hs-identifier hs-type">DQNState</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679384022"><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679384022"><span class="hs-identifier hs-var">pnet</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679384023"><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679384023"><span class="hs-identifier hs-var">tnet</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679384024"><span class="annot"><span class="annottext">opt
</span><a href="#local-6989586621679384024"><span class="hs-identifier hs-var">opt</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679384025"><span class="annot"><span class="annottext">ReplayBuffer dev tr tr' slc s f h
</span><a href="#local-6989586621679384025"><span class="hs-identifier hs-var">buffer</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679384026"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679384026"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679384027"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679384027"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-comment">-- 1. run episode, collect results</span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-comment">-- let policy q = epsilonic gen (eps i n) (greedyPolicy q)</span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-comment">-- let policy = softmaxPolicy gen</span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679384028"><span class="annot"><span class="annottext">policy :: (QEncoding dev '[] -&gt; QTensor dev '[1])
-&gt; [QEncoding dev '[]] -&gt; IO Int
</span><a href="#local-6989586621679384028"><span class="hs-identifier hs-var hs-var hs-var">policy</span></a></span></span><span> </span><span id="local-6989586621679384029"><span class="annot"><span class="annottext">QEncoding dev '[] -&gt; QTensor dev '[1]
</span><a href="#local-6989586621679384029"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">gen
-&gt; QType
-&gt; ([QEncoding dev '[]] -&gt; IO Int)
-&gt; [QEncoding dev '[]]
-&gt; IO Int
forall gen (m :: * -&gt; *) embedding.
StatefulGen gen m =&gt;
gen -&gt; QType -&gt; ([embedding] -&gt; m Int) -&gt; [embedding] -&gt; m Int
</span><a href="RL.DQN.html#epsilonic"><span class="hs-identifier hs-var">epsilonic</span></a></span><span> </span><span class="annot"><span class="annottext">gen
</span><a href="#local-6989586621679384015"><span class="hs-identifier hs-var">gen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; QType
</span><a href="RL.DQN.html#eps"><span class="hs-identifier hs-var">eps</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679384026"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679384027"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([QEncoding dev '[]] -&gt; IO Int) -&gt; [QEncoding dev '[]] -&gt; IO Int)
-&gt; ([QEncoding dev '[]] -&gt; IO Int) -&gt; [QEncoding dev '[]] -&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">gen
-&gt; (QEncoding dev '[] -&gt; QTensor dev '[1])
-&gt; [QEncoding dev '[]]
-&gt; IO Int
forall gen (m :: * -&gt; *) embedding (dev :: (DeviceType, Nat)).
StatefulGen gen m =&gt;
gen -&gt; (embedding -&gt; QTensor dev '[1]) -&gt; [embedding] -&gt; m Int
</span><a href="RL.DQN.html#softmaxPolicy"><span class="hs-identifier hs-var">softmaxPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">gen
</span><a href="#local-6989586621679384015"><span class="hs-identifier hs-var">gen</span></a></span><span> </span><span class="annot"><span class="annottext">QEncoding dev '[] -&gt; QTensor dev '[1]
</span><a href="#local-6989586621679384029"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-252"></span><span>  </span><span id="local-6989586621679384030"><span class="annot"><a href="#local-6989586621679384030"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eval tr tr' slc slc' h (Leftmost s f h)
-&gt; (GreedyState tr tr' slc (Leftmost s f h)
    -&gt; Action slc tr s f h -&gt; QEncoding dev '[])
-&gt; ([QEncoding dev '[]] -&gt; IO Int)
-&gt; Path slc' tr'
-&gt; IO
     (Either
        String
        ([(GreedyState tr tr' slc (Leftmost s f h), Action slc tr s f h,
           QEncoding dev '[],
           Maybe
             (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]]),
           Maybe Bool)],
         Analysis s f h tr slc))
forall {k} (dev :: (DeviceType, Nat)) tr tr' slc slc' s f h
       (gen :: k) state action encoding step.
(state ~ GreedyState tr tr' slc (Leftmost s f h),
 action ~ Action slc tr s f h, encoding ~ QEncoding dev '[],
 step
 ~ (state, action, encoding, Maybe (state, [encoding]),
    Maybe Bool)) =&gt;
Eval tr tr' slc slc' h (Leftmost s f h)
-&gt; (state -&gt; action -&gt; encoding)
-&gt; ([encoding] -&gt; IO Int)
-&gt; Path slc' tr'
-&gt; IO (Either String ([step], Analysis s f h tr slc))
</span><a href="RL.DQN.html#runEpisode"><span class="hs-identifier hs-var">runEpisode</span></a></span><span> </span><span class="annot"><span class="annottext">Eval tr tr' slc slc' h (Leftmost s f h)
</span><a href="#local-6989586621679384016"><span class="hs-identifier hs-var">eval</span></a></span><span> </span><span class="annot"><span class="annottext">GreedyState tr tr' slc (Leftmost s f h)
-&gt; Action slc tr s f h -&gt; QEncoding dev '[]
</span><a href="#local-6989586621679384017"><span class="hs-identifier hs-var">encode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(QEncoding dev '[] -&gt; QTensor dev '[1])
-&gt; [QEncoding dev '[]] -&gt; IO Int
</span><a href="#local-6989586621679384028"><span class="hs-identifier hs-var">policy</span></a></span><span> </span><span class="annot"><span class="annottext">((QEncoding dev '[] -&gt; QTensor dev '[1])
 -&gt; [QEncoding dev '[]] -&gt; IO Int)
-&gt; (QEncoding dev '[] -&gt; QTensor dev '[1])
-&gt; [QEncoding dev '[]]
-&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QModel dev -&gt; QEncoding dev '[] -&gt; QTensor dev '[1]
forall f a b. HasForward f a b =&gt; f -&gt; a -&gt; b
</span><span class="hs-identifier hs-var">T.forward</span></span><span> </span><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679384022"><span class="hs-identifier hs-var">pnet</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Path slc' tr'
</span><a href="#local-6989586621679384020"><span class="hs-identifier hs-var">piece</span></a></span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679384030"><span class="hs-identifier hs-type">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-comment">-- error? skip</span><span>
</span><span id="line-255"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679384032"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679384032"><span class="hs-identifier hs-var">error</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-256"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall a. Show a =&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">print</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679384032"><span class="hs-identifier hs-var">error</span></a></span><span>
</span><span id="line-257"></span><span>      </span><span class="annot"><span class="annottext">(DQNState dev opt tr tr' slc s f h QType, QType, QType)
-&gt; IO (DQNState dev opt tr tr' slc s f h QType, QType, QType)
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DQNState dev opt tr tr' slc s f h QType
</span><a href="#local-6989586621679384021"><span class="hs-identifier hs-var">oldstate</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">QType
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">QType
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679384033"><span class="annot"><span class="annottext">[(GreedyState tr tr' slc (Leftmost s f h), Action slc tr s f h,
  QEncoding dev '[],
  Maybe
    (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]]),
  Maybe Bool)]
</span><a href="#local-6989586621679384033"><span class="hs-identifier hs-var">steps</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679384034"><span class="annot"><span class="annottext">Analysis s f h tr slc
</span><a href="#local-6989586621679384034"><span class="hs-identifier hs-var">analysis</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-259"></span><span>      </span><span class="hs-comment">-- 2. compute reward and add steps to replay buffer</span><span>
</span><span id="line-260"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679384035"><span class="annot"><a href="#local-6989586621679384035"><span class="hs-identifier hs-var">steps'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679384036"><span class="annot"><a href="#local-6989586621679384036"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(GreedyState tr tr' slc (Leftmost s f h), Action slc tr s f h,
  QEncoding dev '[],
  Maybe
    (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]]),
  Maybe Bool)]
-&gt; Analysis s f h tr slc
-&gt; IO ([ReplayStep dev tr tr' slc s f h], QType)
</span><a href="#local-6989586621679384037"><span class="hs-identifier hs-var">rewardEpisode</span></a></span><span> </span><span class="annot"><span class="annottext">[(GreedyState tr tr' slc (Leftmost s f h), Action slc tr s f h,
  QEncoding dev '[],
  Maybe
    (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]]),
  Maybe Bool)]
</span><a href="#local-6989586621679384033"><span class="hs-identifier hs-var">steps</span></a></span><span> </span><span class="annot"><span class="annottext">Analysis s f h tr slc
</span><a href="#local-6989586621679384034"><span class="hs-identifier hs-var">analysis</span></a></span><span>
</span><span id="line-261"></span><span>      </span><span class="hs-comment">-- rall &lt;- reward analysis</span><span>
</span><span id="line-262"></span><span>      </span><span class="hs-comment">-- putStrLn $ &quot;total episode reward: &quot; &lt;&gt; show r</span><span>
</span><span id="line-263"></span><span>      </span><span class="hs-comment">-- putStrLn $ &quot;hypothetical reward: &quot; &lt;&gt; show rall</span><span>
</span><span id="line-264"></span><span>      </span><span class="hs-comment">-- mapM_ print (anaDerivation analysis)</span><span>
</span><span id="line-265"></span><span>      </span><span class="hs-comment">-- mapM_ print steps'</span><span>
</span><span id="line-266"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679384038"><span class="annot"><a href="#local-6989586621679384038"><span class="hs-identifier hs-var hs-var">buffer'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ReplayBuffer dev tr tr' slc s f h
 -&gt; ReplayStep dev tr tr' slc s f h
 -&gt; ReplayBuffer dev tr tr' slc s f h)
-&gt; ReplayBuffer dev tr tr' slc s f h
-&gt; [ReplayStep dev tr tr' slc s f h]
-&gt; ReplayBuffer dev tr tr' slc s f h
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">F.foldl'</span></span><span> </span><span class="annot"><span class="annottext">ReplayBuffer dev tr tr' slc s f h
-&gt; ReplayStep dev tr tr' slc s f h
-&gt; ReplayBuffer dev tr tr' slc s f h
forall (dev :: (DeviceType, Nat)) tr tr' slc s f h.
ReplayBuffer dev tr tr' slc s f h
-&gt; ReplayStep dev tr tr' slc s f h
-&gt; ReplayBuffer dev tr tr' slc s f h
</span><a href="RL.ReplayBuffer.html#pushStep"><span class="hs-identifier hs-var">pushStep</span></a></span><span> </span><span class="annot"><span class="annottext">ReplayBuffer dev tr tr' slc s f h
</span><a href="#local-6989586621679384025"><span class="hs-identifier hs-var">buffer</span></a></span><span> </span><span class="annot"><span class="annottext">[ReplayStep dev tr tr' slc s f h]
</span><a href="#local-6989586621679384035"><span class="hs-identifier hs-var">steps'</span></a></span><span>
</span><span id="line-267"></span><span>      </span><span class="hs-comment">-- 3. optimize models</span><span>
</span><span id="line-268"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679384041"><span class="annot"><a href="#local-6989586621679384041"><span class="hs-identifier hs-var">pnet'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679384042"><span class="annot"><a href="#local-6989586621679384042"><span class="hs-identifier hs-var">tnet'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679384043"><span class="annot"><a href="#local-6989586621679384043"><span class="hs-identifier hs-var">opt'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679384044"><span class="annot"><a href="#local-6989586621679384044"><span class="hs-identifier hs-var">loss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679384045"><span class="hs-identifier hs-type">optimizeModels</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679384038"><span class="hs-identifier hs-type">buffer'</span></a></span><span>
</span><span id="line-269"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.DQN.html#DQNState"><span class="hs-identifier hs-type">DQNState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679384041"><span class="hs-identifier hs-type">pnet'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679384042"><span class="hs-identifier hs-type">tnet'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679384043"><span class="hs-identifier hs-type">opt'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679384038"><span class="hs-identifier hs-type">buffer'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679384036"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679384044"><span class="hs-identifier hs-type">loss</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-271"></span><span>  </span><span id="local-6989586621679384046"><span class="annot"><span class="annottext">mkReplay :: QType
-&gt; (GreedyState tr tr' slc (Leftmost s f h), Action slc tr s f h,
    QEncoding dev '[],
    Maybe
      (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]]),
    e)
-&gt; ReplayStep dev tr tr' slc s f h
</span><a href="#local-6989586621679384046"><span class="hs-identifier hs-var hs-var">mkReplay</span></a></span></span><span> </span><span id="local-6989586621679384047"><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679384047"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679384048"><span class="annot"><span class="annottext">GreedyState tr tr' slc (Leftmost s f h)
</span><a href="#local-6989586621679384048"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679384049"><span class="annot"><span class="annottext">Action slc tr s f h
</span><a href="#local-6989586621679384049"><span class="hs-identifier hs-var">action</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679384050"><span class="annot"><span class="annottext">QEncoding dev '[]
</span><a href="#local-6989586621679384050"><span class="hs-identifier hs-var">actEnc</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679384051"><span class="annot"><span class="annottext">Maybe
  (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]])
</span><a href="#local-6989586621679384051"><span class="hs-identifier hs-var">next</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679384052"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679384052"><span class="hs-identifier hs-var">goLeft</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-272"></span><span>    </span><span class="annot"><span class="annottext">RPState tr tr' slc s f h
-&gt; RPAction slc tr s f h
-&gt; QEncoding dev '[]
-&gt; Maybe (RPState tr tr' slc s f h)
-&gt; [QEncoding dev '[]]
-&gt; QType
-&gt; ReplayStep dev tr tr' slc s f h
forall (dev :: (DeviceType, Nat)) tr tr' slc s f h.
RPState tr tr' slc s f h
-&gt; RPAction slc tr s f h
-&gt; QEncoding dev '[]
-&gt; Maybe (RPState tr tr' slc s f h)
-&gt; [QEncoding dev '[]]
-&gt; QType
-&gt; ReplayStep dev tr tr' slc s f h
</span><a href="RL.ReplayBuffer.html#ReplayStep"><span class="hs-identifier hs-var">ReplayStep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GreedyState tr tr' slc (Leftmost s f h) -&gt; RPState tr tr' slc s f h
forall tr tr' slc s f h.
GreedyState tr tr' slc (Leftmost s f h) -&gt; RPState tr tr' slc s f h
</span><a href="RL.ReplayBuffer.html#RPState"><span class="hs-identifier hs-var">RPState</span></a></span><span> </span><span class="annot"><span class="annottext">GreedyState tr tr' slc (Leftmost s f h)
</span><a href="#local-6989586621679384048"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Action slc tr s f h -&gt; RPAction slc tr s f h
forall slc tr s f h. Action slc tr s f h -&gt; RPAction slc tr s f h
</span><a href="RL.ReplayBuffer.html#RPAction"><span class="hs-identifier hs-var">RPAction</span></a></span><span> </span><span class="annot"><span class="annottext">Action slc tr s f h
</span><a href="#local-6989586621679384049"><span class="hs-identifier hs-var">action</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">QEncoding dev '[]
</span><a href="#local-6989586621679384050"><span class="hs-identifier hs-var">actEnc</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (RPState tr tr' slc s f h)
</span><a href="#local-6989586621679384056"><span class="hs-identifier hs-var">state'</span></a></span><span> </span><span class="annot"><span class="annottext">[QEncoding dev '[]]
</span><a href="#local-6989586621679384057"><span class="hs-identifier hs-var">steps'</span></a></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679384047"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-273"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-274"></span><span>    </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679384056"><span class="annot"><span class="annottext">Maybe (RPState tr tr' slc s f h)
</span><a href="#local-6989586621679384056"><span class="hs-identifier hs-var">state'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679384057"><span class="annot"><span class="annottext">[QEncoding dev '[]]
</span><a href="#local-6989586621679384057"><span class="hs-identifier hs-var">steps'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe
  (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]])
</span><a href="#local-6989586621679384051"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-275"></span><span>      </span><span class="annot"><span class="annottext">Maybe
  (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]])
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (RPState tr tr' slc s f h)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679384058"><span class="annot"><span class="annottext">GreedyState tr tr' slc (Leftmost s f h)
</span><a href="#local-6989586621679384058"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679384059"><span class="annot"><span class="annottext">[QEncoding dev '[]]
</span><a href="#local-6989586621679384059"><span class="hs-identifier hs-var">acts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RPState tr tr' slc s f h -&gt; Maybe (RPState tr tr' slc s f h)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(RPState tr tr' slc s f h -&gt; Maybe (RPState tr tr' slc s f h))
-&gt; RPState tr tr' slc s f h -&gt; Maybe (RPState tr tr' slc s f h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GreedyState tr tr' slc (Leftmost s f h) -&gt; RPState tr tr' slc s f h
forall tr tr' slc s f h.
GreedyState tr tr' slc (Leftmost s f h) -&gt; RPState tr tr' slc s f h
</span><a href="RL.ReplayBuffer.html#RPState"><span class="hs-identifier hs-var">RPState</span></a></span><span> </span><span class="annot"><span class="annottext">GreedyState tr tr' slc (Leftmost s f h)
</span><a href="#local-6989586621679384058"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[QEncoding dev '[]]
</span><a href="#local-6989586621679384059"><span class="hs-identifier hs-var">acts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-277"></span><span>  </span><span id="local-6989586621679384037"><span class="annot"><span class="annottext">rewardEpisode :: [(GreedyState tr tr' slc (Leftmost s f h), Action slc tr s f h,
  QEncoding dev '[],
  Maybe
    (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]]),
  Maybe Bool)]
-&gt; Analysis s f h tr slc
-&gt; IO ([ReplayStep dev tr tr' slc s f h], QType)
</span><a href="#local-6989586621679384037"><span class="hs-identifier hs-var hs-var">rewardEpisode</span></a></span></span><span> </span><span id="local-6989586621679384060"><span class="annot"><span class="annottext">[(GreedyState tr tr' slc (Leftmost s f h), Action slc tr s f h,
  QEncoding dev '[],
  Maybe
    (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]]),
  Maybe Bool)]
</span><a href="#local-6989586621679384060"><span class="hs-identifier hs-var">steps</span></a></span></span><span> </span><span id="local-6989586621679384061"><span class="annot"><span class="annottext">Analysis s f h tr slc
</span><a href="#local-6989586621679384061"><span class="hs-identifier hs-var">analysis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-278"></span><span>    </span><span id="local-6989586621679384062"><span class="annot"><a href="#local-6989586621679384062"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Analysis s f h tr slc -&gt; IO QType
</span><a href="#local-6989586621679384018"><span class="hs-identifier hs-var">reward</span></a></span><span> </span><span class="annot"><span class="annottext">Analysis s f h tr slc
</span><a href="#local-6989586621679384061"><span class="hs-identifier hs-var">analysis</span></a></span><span>
</span><span id="line-279"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679384063"><span class="annot"><a href="#local-6989586621679384063"><span class="hs-identifier hs-var hs-var">steps'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[(GreedyState tr tr' slc (Leftmost s f h), Action slc tr s f h,
  QEncoding dev '[],
  Maybe
    (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]]),
  Maybe Bool)]
</span><a href="#local-6989586621679384060"><span class="hs-identifier hs-var">steps</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-280"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-281"></span><span>          </span><span id="local-6989586621679384064"><span class="annot"><span class="annottext">(GreedyState tr tr' slc (Leftmost s f h), Action slc tr s f h,
 QEncoding dev '[],
 Maybe
   (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]]),
 Maybe Bool)
</span><a href="#local-6989586621679384064"><span class="hs-identifier hs-var">last</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679384065"><span class="annot"><span class="annottext">[(GreedyState tr tr' slc (Leftmost s f h), Action slc tr s f h,
  QEncoding dev '[],
  Maybe
    (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]]),
  Maybe Bool)]
</span><a href="#local-6989586621679384065"><span class="hs-identifier hs-var">rest</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QType
-&gt; (GreedyState tr tr' slc (Leftmost s f h), Action slc tr s f h,
    QEncoding dev '[],
    Maybe
      (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]]),
    Maybe Bool)
-&gt; ReplayStep dev tr tr' slc s f h
forall {tr} {tr'} {slc} {s} {f} {h} {dev :: (DeviceType, Nat)} {e}.
QType
-&gt; (GreedyState tr tr' slc (Leftmost s f h), Action slc tr s f h,
    QEncoding dev '[],
    Maybe
      (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]]),
    e)
-&gt; ReplayStep dev tr tr' slc s f h
</span><a href="#local-6989586621679384046"><span class="hs-identifier hs-var">mkReplay</span></a></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679384062"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">(GreedyState tr tr' slc (Leftmost s f h), Action slc tr s f h,
 QEncoding dev '[],
 Maybe
   (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]]),
 Maybe Bool)
</span><a href="#local-6989586621679384064"><span class="hs-identifier hs-var">last</span></a></span><span> </span><span class="annot"><span class="annottext">ReplayStep dev tr tr' slc s f h
-&gt; [ReplayStep dev tr tr' slc s f h]
-&gt; [ReplayStep dev tr tr' slc s f h]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">((GreedyState tr tr' slc (Leftmost s f h), Action slc tr s f h,
  QEncoding dev '[],
  Maybe
    (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]]),
  Maybe Bool)
 -&gt; ReplayStep dev tr tr' slc s f h)
-&gt; [(GreedyState tr tr' slc (Leftmost s f h), Action slc tr s f h,
     QEncoding dev '[],
     Maybe
       (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]]),
     Maybe Bool)]
-&gt; [ReplayStep dev tr tr' slc s f h]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QType
-&gt; (GreedyState tr tr' slc (Leftmost s f h), Action slc tr s f h,
    QEncoding dev '[],
    Maybe
      (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]]),
    Maybe Bool)
-&gt; ReplayStep dev tr tr' slc s f h
forall {tr} {tr'} {slc} {s} {f} {h} {dev :: (DeviceType, Nat)} {e}.
QType
-&gt; (GreedyState tr tr' slc (Leftmost s f h), Action slc tr s f h,
    QEncoding dev '[],
    Maybe
      (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]]),
    e)
-&gt; ReplayStep dev tr tr' slc s f h
</span><a href="#local-6989586621679384046"><span class="hs-identifier hs-var">mkReplay</span></a></span><span> </span><span class="annot"><span class="annottext">QType
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(GreedyState tr tr' slc (Leftmost s f h), Action slc tr s f h,
  QEncoding dev '[],
  Maybe
    (GreedyState tr tr' slc (Leftmost s f h), [QEncoding dev '[]]),
  Maybe Bool)]
</span><a href="#local-6989586621679384065"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-282"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679384063"><span class="hs-identifier hs-type">steps'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679384062"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-comment">-- rewardSteps steps _analysis = do</span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-comment">--   steps' &lt;- mapM mkStep steps</span><span>
</span><span id="line-285"></span><span>  </span><span class="hs-comment">--   let r = sum $ replayReward &lt;$&gt; steps'</span><span>
</span><span id="line-286"></span><span>  </span><span class="hs-comment">--   pure (steps', r)</span><span>
</span><span id="line-287"></span><span>  </span><span class="hs-comment">--  where</span><span>
</span><span id="line-288"></span><span>  </span><span class="hs-comment">--   mkStep step@(_, action, _, _, goLeft) = do</span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-comment">--     rstep &lt;- rewardStep action goLeft</span><span>
</span><span id="line-290"></span><span>  </span><span class="hs-comment">--     pure $ mkReplay rstep step</span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-comment">-- A single optimization step for deep q learning (DQN)</span><span>
</span><span id="line-293"></span><span>  </span><span id="local-6989586621679384045"><span class="annot"><span class="annottext">optimizeModels :: ReplayBuffer dev tr tr' slc s f h
-&gt; IO (QModel dev, QModel dev, opt, QType)
</span><a href="#local-6989586621679384045"><span class="hs-identifier hs-var hs-var">optimizeModels</span></a></span></span><span> </span><span id="local-6989586621679384066"><span class="annot"><span class="annottext">ReplayBuffer dev tr tr' slc s f h
</span><a href="#local-6989586621679384066"><span class="hs-identifier hs-var">buffer'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-294"></span><span>    </span><span class="hs-comment">-- choose batch from replay buffer</span><span>
</span><span id="line-295"></span><span>    </span><span id="local-6989586621679384067"><span class="annot"><a href="#local-6989586621679384067"><span class="hs-identifier hs-var">batch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReplayBuffer dev tr tr' slc s f h
-&gt; Int -&gt; IO [ReplayStep dev tr tr' slc s f h]
forall (dev :: (DeviceType, Nat)) tr tr' slc s f h.
ReplayBuffer dev tr tr' slc s f h
-&gt; Int -&gt; IO [ReplayStep dev tr tr' slc s f h]
</span><a href="RL.ReplayBuffer.html#sampleSteps"><span class="hs-identifier hs-var">sampleSteps</span></a></span><span> </span><span class="annot"><span class="annottext">ReplayBuffer dev tr tr' slc s f h
</span><a href="#local-6989586621679384066"><span class="hs-identifier hs-var">buffer'</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="RL.DQN.html#replayN"><span class="hs-identifier hs-var">replayN</span></a></span><span>
</span><span id="line-296"></span><span>    </span><span class="hs-comment">-- compute loss over batch</span><span>
</span><span id="line-297"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679384069"><span class="annot"><a href="#local-6989586621679384069"><span class="hs-identifier hs-var">qsNow</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679384070"><span class="annot"><a href="#local-6989586621679384070"><span class="hs-identifier hs-var">qsExpected</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unzip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679384072"><span class="hs-identifier hs-type">dqnValues</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621679384067"><span class="hs-identifier hs-type">batch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span>    </span><span id="local-6989586621679384073"><span class="annot"><a href="#local-6989586621679384073"><span class="hs-identifier hs-var">expectedDetached</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.detach</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.stack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T.Dim</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679384070"><span class="hs-identifier hs-type">qsExpected</span></a></span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679384076"><span class="annot"><a href="#local-6989586621679384076"><span class="hs-identifier hs-var hs-var">loss</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-300"></span><span>          </span><span class="annot"><span class="annottext">Reduction -&gt; Tensor -&gt; Tensor -&gt; Tensor
</span><span class="hs-identifier hs-var">T.smoothL1Loss</span></span><span>
</span><span id="line-301"></span><span>            </span><span class="annot"><span class="annottext">Reduction
</span><span class="hs-identifier hs-var">T.ReduceMean</span></span><span>
</span><span id="line-302"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Dim -&gt; [Tensor] -&gt; Tensor
</span><span class="hs-identifier hs-var">T.stack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Dim
</span><span class="hs-identifier hs-var">T.Dim</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Tensor]
</span><a href="#local-6989586621679384069"><span class="hs-identifier hs-var">qsNow</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>            </span><span class="annot"><span class="annottext">Tensor
</span><a href="#local-6989586621679384073"><span class="hs-identifier hs-var">expectedDetached</span></a></span><span>
</span><span id="line-304"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679384079"><span class="annot"><a href="#local-6989586621679384079"><span class="hs-identifier hs-var hs-var">lossWithFake</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tensor -&gt; Tensor device QDType '[]
forall (device :: (DeviceType, Nat)) (dtype :: DType)
       (shape :: [Nat]).
Tensor -&gt; Tensor device dtype shape
</span><span class="hs-identifier hs-var">TT.UnsafeMkTensor</span></span><span> </span><span class="annot"><span class="annottext">(Tensor -&gt; Tensor device QDType '[])
-&gt; Tensor -&gt; Tensor device QDType '[]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tensor
</span><a href="#local-6989586621679384076"><span class="hs-identifier hs-var">loss</span></a></span><span> </span><span class="annot"><span class="annottext">Tensor -&gt; Tensor -&gt; Tensor
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">QTensor dev '[] -&gt; Tensor
forall t. Unnamed t =&gt; t -&gt; Tensor
</span><span class="hs-identifier hs-var">TT.toDynamic</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QModel dev -&gt; QTensor dev '[]
forall (dev :: (DeviceType, Nat)) (ps :: [*]).
(IsValidDevice dev, ps ~ Parameters (QModel dev)) =&gt;
QModel dev -&gt; QTensor dev '[]
</span><a href="RL.Model.html#fakeLoss"><span class="hs-identifier hs-var">fakeLoss</span></a></span><span> </span><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679384022"><span class="hs-identifier hs-var">pnet</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>    </span><span class="hs-comment">-- print loss</span><span>
</span><span id="line-306"></span><span>    </span><span class="hs-comment">-- optimize policy net</span><span>
</span><span id="line-307"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">putStr</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;loss: &quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T.asValue</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.toDynamic</span></span><span> </span><span class="annot"><a href="#local-6989586621679384079"><span class="hs-identifier hs-type">lossWithFake</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">putStrLn</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;\tavgq: &quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T.asValue</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.mean</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.stack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T.Dim</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679384069"><span class="hs-identifier hs-type">qsNow</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-comment">-- let params = TT.flattenParameters pnet</span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-comment">--     grads = TT.grad lossWithFake params</span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679384087"><span class="annot"><a href="#local-6989586621679384087"><span class="hs-identifier hs-var hs-var">lr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType -&gt; Tensor device QDType '[]
forall (dev :: (DeviceType, Nat)).
IsValidDevice dev =&gt;
QType -&gt; LearningRate dev QDType
</span><a href="RL.DQN.html#learningRate"><span class="hs-identifier hs-var">learningRate</span></a></span><span> </span><span class="annot"><span class="annottext">(QType -&gt; Tensor device QDType '[])
-&gt; QType -&gt; Tensor device QDType '[]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; QType
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679384026"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">QType -&gt; QType -&gt; QType
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; QType
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679384027"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-312"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679384089"><span class="annot"><a href="#local-6989586621679384089"><span class="hs-identifier hs-var">pnet'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679384090"><span class="annot"><a href="#local-6989586621679384090"><span class="hs-identifier hs-var">opt'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.runStep</span></span><span> </span><span class="annot"><a href="#local-6989586621679384022"><span class="hs-identifier hs-type">pnet</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679384024"><span class="hs-identifier hs-type">opt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679384079"><span class="hs-identifier hs-type">lossWithFake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679384087"><span class="hs-identifier hs-type">lr</span></a></span><span>
</span><span id="line-313"></span><span>    </span><span class="hs-comment">-- update target net</span><span>
</span><span id="line-314"></span><span>    </span><span id="local-6989586621679384092"><span class="annot"><a href="#local-6989586621679384092"><span class="hs-identifier hs-var">tparams</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.hmapM'</span></span><span> </span><span class="annot"><a href="RL.TorchHelpers.html#Detach"><span class="hs-identifier hs-type">TH.Detach</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.hmap'</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.ToDependent</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.flattenParameters</span></span><span> </span><span class="annot"><a href="#local-6989586621679384023"><span class="hs-identifier hs-type">tnet</span></a></span><span>
</span><span id="line-315"></span><span>    </span><span id="local-6989586621679384098"><span class="annot"><a href="#local-6989586621679384098"><span class="hs-identifier hs-var">pparams</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.hmapM'</span></span><span> </span><span class="annot"><a href="RL.TorchHelpers.html#Detach"><span class="hs-identifier hs-type">TH.Detach</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.hmap'</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.ToDependent</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.flattenParameters</span></span><span> </span><span class="annot"><a href="#local-6989586621679384089"><span class="hs-identifier hs-type">pnet'</span></a></span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679384099"><span class="annot"><a href="#local-6989586621679384099"><span class="hs-identifier hs-var hs-var">tparams'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Interpolate QType
-&gt; HList
     '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
       Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[5],
       Tensor dev QDType '[5], Tensor dev QDType '[5],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8],
       Tensor dev QDType '[1, 8], QTensor dev '[1],
       Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8],
       Tensor dev QDType '[1, 8], QTensor dev '[1]]
-&gt; HList
     '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
       Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[5],
       Tensor dev QDType '[5], Tensor dev QDType '[5],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8],
       Tensor dev QDType '[1, 8], QTensor dev '[1],
       Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8],
       Tensor dev QDType '[1, 8], QTensor dev '[1]]
-&gt; HList
     '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
       Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[5],
       Tensor dev QDType '[5], Tensor dev QDType '[5],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8],
       Tensor dev QDType '[1, 8], QTensor dev '[1],
       Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8],
       Tensor dev QDType '[1, 8], QTensor dev '[1]]
forall k f (xs :: [k]) (ys :: [k]) (zs :: [k]).
HZipWith f xs ys zs =&gt;
f -&gt; HList xs -&gt; HList ys -&gt; HList zs
</span><span class="hs-identifier hs-var">TT.hzipWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QType -&gt; Interpolate QType
forall num. num -&gt; Interpolate num
</span><a href="RL.TorchHelpers.html#Interpolate"><span class="hs-identifier hs-var">TH.Interpolate</span></a></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="RL.DQN.html#tau"><span class="hs-identifier hs-var">tau</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HList
  '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
    Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[5],
    Tensor dev QDType '[5], Tensor dev QDType '[5],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8], Tensor dev QDType '[8],
    Tensor dev QDType '[1, 8], QTensor dev '[1],
    Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
    Tensor dev QDType '[8], Tensor dev QDType '[8],
    Tensor dev QDType '[1, 8], QTensor dev '[1]]
</span><a href="#local-6989586621679384098"><span class="hs-identifier hs-var">pparams</span></a></span><span> </span><span class="annot"><span class="annottext">HList
  '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
    Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[5],
    Tensor dev QDType '[5], Tensor dev QDType '[5],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8], Tensor dev QDType '[8],
    Tensor dev QDType '[1, 8], QTensor dev '[1],
    Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
    Tensor dev QDType '[8], Tensor dev QDType '[8],
    Tensor dev QDType '[1, 8], QTensor dev '[1]]
</span><a href="#local-6989586621679384092"><span class="hs-identifier hs-var">tparams</span></a></span><span>
</span><span id="line-317"></span><span>    </span><span id="local-6989586621679384102"><span class="annot"><a href="#local-6989586621679384102"><span class="hs-identifier hs-var">tparamsNew</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.hmapM'</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.MakeIndependent</span></span><span> </span><span class="annot"><a href="#local-6989586621679384099"><span class="hs-identifier hs-type">tparams'</span></a></span><span>
</span><span id="line-318"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679384104"><span class="annot"><a href="#local-6989586621679384104"><span class="hs-identifier hs-var hs-var">tnet'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QModel dev -&gt; HList (Parameters (QModel dev)) -&gt; QModel dev
forall f. Parameterized f =&gt; f -&gt; HList (Parameters f) -&gt; f
</span><span class="hs-identifier hs-var">TT.replaceParameters</span></span><span> </span><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679384023"><span class="hs-identifier hs-var">tnet</span></a></span><span> </span><span class="annot"><span class="annottext">HList
  '[Parameter dev QDType '[8, 1, 1, 1], Parameter dev QDType '[8],
    Parameter dev QDType '[8, 8, 13, 5], Parameter dev QDType '[8],
    Parameter dev QDType '[8, 13, 5], Parameter dev QDType '[8, 13, 5],
    Parameter dev QDType '[8, 2, 13, 5], Parameter dev QDType '[8],
    Parameter dev QDType '[8, 2, 13, 5], Parameter dev QDType '[8],
    Parameter dev QDType '[8, 1, 1, 1], Parameter dev QDType '[8],
    Parameter dev QDType '[8, 1, 1, 1], Parameter dev QDType '[8],
    Parameter dev QDType '[8], Parameter dev QDType '[8, 8, 13, 5],
    Parameter dev QDType '[8], Parameter dev QDType '[8, 8, 13, 5],
    Parameter dev QDType '[8], Parameter dev QDType '[8, 8, 13, 5],
    Parameter dev QDType '[8], Parameter dev QDType '[8, 8, 13, 5],
    Parameter dev QDType '[8], Parameter dev QDType '[8, 8, 13, 5],
    Parameter dev QDType '[8], Parameter dev QDType '[8, 8, 13, 5],
    Parameter dev QDType '[8], Parameter dev QDType '[8, 8, 13, 5],
    Parameter dev QDType '[8], Parameter dev QDType '[5],
    Parameter dev QDType '[5], Parameter dev QDType '[5],
    Parameter dev QDType '[8, 8, 13, 5], Parameter dev QDType '[8],
    Parameter dev QDType '[8, 8, 13, 5], Parameter dev QDType '[8],
    Parameter dev QDType '[8, 8, 13, 5], Parameter dev QDType '[8],
    Parameter dev QDType '[8, 8, 13, 5], Parameter dev QDType '[8],
    Parameter dev QDType '[8, 8, 13, 5], Parameter dev QDType '[8],
    Parameter dev QDType '[8, 8, 13, 5], Parameter dev QDType '[8],
    Parameter dev QDType '[8, 8, 13, 5], Parameter dev QDType '[8],
    Parameter dev QDType '[8, 8, 13, 5], Parameter dev QDType '[8],
    Parameter dev QDType '[8], Parameter dev QDType '[8],
    Parameter dev QDType '[1, 8], Parameter dev QDType '[1],
    Parameter dev QDType '[8, 8], Parameter dev QDType '[8],
    Parameter dev QDType '[8], Parameter dev QDType '[8],
    Parameter dev QDType '[1, 8], Parameter dev QDType '[1]]
HList (Parameters (QModel dev))
</span><a href="#local-6989586621679384102"><span class="hs-identifier hs-var">tparamsNew</span></a></span><span>
</span><span id="line-319"></span><span>    </span><span class="hs-comment">-- return new state</span><span>
</span><span id="line-320"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679384089"><span class="hs-identifier hs-type">pnet'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679384104"><span class="hs-identifier hs-type">tnet'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679384090"><span class="hs-identifier hs-type">opt'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.asValue</span></span><span> </span><span class="annot"><a href="#local-6989586621679384076"><span class="hs-identifier hs-type">loss</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span>  </span><span class="hs-comment">-- The loss function of a single replay step</span><span>
</span><span id="line-323"></span><span>  </span><span class="annot"><a href="#local-6989586621679384072"><span class="hs-identifier hs-type">dqnValues</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RL.ReplayBuffer.html#ReplayStep"><span class="hs-identifier hs-type">ReplayStep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378926"><span class="hs-identifier hs-type">dev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378927"><span class="hs-identifier hs-type">tr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378928"><span class="hs-identifier hs-type">tr'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378929"><span class="hs-identifier hs-type">slc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378931"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378932"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378933"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T.Tensor</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Tensor</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- (QTensor '[1], QTensor '[1])</span><span>
</span><span id="line-324"></span><span>  </span><span id="local-6989586621679384072"><span class="annot"><span class="annottext">dqnValues :: ReplayStep dev tr tr' slc s f h -&gt; (Tensor, Tensor)
</span><a href="#local-6989586621679384072"><span class="hs-identifier hs-var hs-var">dqnValues</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.ReplayBuffer.html#ReplayStep"><span class="hs-identifier hs-type">ReplayStep</span></a></span><span> </span><span class="annot"><span class="annottext">RPState tr tr' slc s f h
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">RPAction slc tr s f h
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679384106"><span class="annot"><span class="annottext">QEncoding dev '[]
</span><a href="#local-6989586621679384106"><span class="hs-identifier hs-var">step0Enc</span></a></span></span><span> </span><span id="local-6989586621679384107"><span class="annot"><span class="annottext">Maybe (RPState tr tr' slc s f h)
</span><a href="#local-6989586621679384107"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span id="local-6989586621679384108"><span class="annot"><span class="annottext">[QEncoding dev '[]]
</span><a href="#local-6989586621679384108"><span class="hs-identifier hs-var">step1Encs</span></a></span></span><span> </span><span id="local-6989586621679384109"><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679384109"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tensor
</span><a href="#local-6989586621679384110"><span class="hs-identifier hs-var">qnow</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Tensor
</span><a href="#local-6989586621679384111"><span class="hs-identifier hs-var">qexpected</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-326"></span><span>    </span><span id="local-6989586621679384120"><span class="annot"><span class="annottext">qzero :: QTensor dev '[1]
</span><a href="#local-6989586621679384120"><span class="hs-identifier hs-var hs-var">qzero</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QTensor dev '[1]
forall (shape :: [Nat]) (dtype :: DType)
       (device :: (DeviceType, Nat)).
TensorOptions shape dtype device =&gt;
Tensor device dtype shape
</span><span class="hs-identifier hs-var">TT.zeros</span></span><span>
</span><span id="line-327"></span><span>    </span><span id="local-6989586621679384122"><span class="annot"><span class="annottext">qnext :: QTensor dev '[1]
</span><a href="#local-6989586621679384122"><span class="hs-identifier hs-var hs-var">qnext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (RPState tr tr' slc s f h)
</span><a href="#local-6989586621679384107"><span class="hs-identifier hs-var">s'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-328"></span><span>      </span><span class="annot"><span class="annottext">Maybe (RPState tr tr' slc s f h)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QTensor dev '[1]
</span><a href="#local-6989586621679384120"><span class="hs-identifier hs-var">qzero</span></a></span><span>
</span><span id="line-329"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.ReplayBuffer.html#RPState"><span class="hs-identifier hs-type">RPState</span></a></span><span> </span><span id="local-6989586621679384123"><span class="annot"><span class="annottext">GreedyState tr tr' slc (Leftmost s f h)
</span><a href="#local-6989586621679384123"><span class="hs-identifier hs-var">state'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-330"></span><span>        </span><span class="hs-keyword">let</span><span>
</span><span id="line-331"></span><span>          </span><span class="annot"><a href="#local-6989586621679384124"><span class="hs-identifier hs-type">nextQs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="RL.ModelTypes.html#QTensor"><span class="hs-identifier hs-type">QTensor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378926"><span class="hs-identifier hs-type">dev</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-332"></span><span>          </span><span id="local-6989586621679384124"><span class="annot"><span class="annottext">nextQs :: [QTensor dev '[1]]
</span><a href="#local-6989586621679384124"><span class="hs-identifier hs-var hs-var">nextQs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QModel dev -&gt; QEncoding dev '[] -&gt; QTensor dev '[1]
forall f a b. HasForward f a b =&gt; f -&gt; a -&gt; b
</span><span class="hs-identifier hs-var">TT.forward</span></span><span> </span><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679384023"><span class="hs-identifier hs-var">tnet</span></a></span><span> </span><span class="annot"><span class="annottext">(QEncoding dev '[] -&gt; QTensor dev '[1])
-&gt; [QEncoding dev '[]] -&gt; [QTensor dev '[1]]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[QEncoding dev '[]]
</span><a href="#local-6989586621679384108"><span class="hs-identifier hs-var">step1Encs</span></a></span><span>
</span><span id="line-333"></span><span>          </span><span class="hs-comment">-- nextQs = runQ' encode tnet state' &lt;$&gt; getActions eval state'</span><span>
</span><span id="line-334"></span><span>          </span><span class="annot"><a href="#local-6989586621679384125"><span class="hs-identifier hs-type">toVal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QTensor"><span class="hs-identifier hs-type">QTensor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378926"><span class="hs-identifier hs-type">dev</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span>
</span><span id="line-335"></span><span>          </span><span id="local-6989586621679384125"><span class="annot"><span class="annottext">toVal :: QTensor dev '[1] -&gt; QType
</span><a href="#local-6989586621679384125"><span class="hs-identifier hs-var hs-var">toVal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. TensorLike a =&gt; Tensor -&gt; a
</span><span class="hs-identifier hs-var">T.asValue</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span> </span><span class="annot"><span class="annottext">(Tensor -&gt; QType)
-&gt; (QTensor dev '[1] -&gt; Tensor) -&gt; QTensor dev '[1] -&gt; QType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">QTensor dev '[1] -&gt; Tensor
forall t. Unnamed t =&gt; t -&gt; Tensor
</span><span class="hs-identifier hs-var">TT.toDynamic</span></span><span>
</span><span id="line-336"></span><span>         </span><span class="hs-keyword">in</span><span>
</span><span id="line-337"></span><span>          </span><span class="annot"><span class="annottext">(QTensor dev '[1] -&gt; QType)
-&gt; [QTensor dev '[1]] -&gt; QTensor dev '[1]
forall b a. (HasCallStack, Ord b) =&gt; (a -&gt; b) -&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">E.maximumOn</span></span><span> </span><span class="annot"><span class="annottext">QTensor dev '[1] -&gt; QType
</span><a href="#local-6989586621679384125"><span class="hs-identifier hs-var">toVal</span></a></span><span> </span><span class="annot"><span class="annottext">[QTensor dev '[1]]
</span><a href="#local-6989586621679384124"><span class="hs-identifier hs-var">nextQs</span></a></span><span>
</span><span id="line-338"></span><span>    </span><span id="local-6989586621679384110"><span class="annot"><span class="annottext">qnow :: Tensor
</span><a href="#local-6989586621679384110"><span class="hs-identifier hs-var hs-var">qnow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QTensor dev '[1] -&gt; Tensor
forall t. Unnamed t =&gt; t -&gt; Tensor
</span><span class="hs-identifier hs-var">TT.toDynamic</span></span><span> </span><span class="annot"><span class="annottext">(QTensor dev '[1] -&gt; Tensor) -&gt; QTensor dev '[1] -&gt; Tensor
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QModel dev -&gt; QEncoding dev '[] -&gt; QTensor dev '[1]
forall f a b. HasForward f a b =&gt; f -&gt; a -&gt; b
</span><span class="hs-identifier hs-var">T.forward</span></span><span> </span><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679384022"><span class="hs-identifier hs-var">pnet</span></a></span><span> </span><span class="annot"><span class="annottext">QEncoding dev '[]
</span><a href="#local-6989586621679384106"><span class="hs-identifier hs-var">step0Enc</span></a></span><span> </span><span class="hs-comment">-- (encode s a)</span><span>
</span><span id="line-339"></span><span>    </span><span id="local-6989586621679384111"><span class="annot"><span class="annottext">qexpected :: Tensor
</span><a href="#local-6989586621679384111"><span class="hs-identifier hs-var hs-var">qexpected</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QTensor dev '[1] -&gt; Tensor
forall t. Unnamed t =&gt; t -&gt; Tensor
</span><span class="hs-identifier hs-var">TT.toDynamic</span></span><span> </span><span class="annot"><span class="annottext">(QTensor dev '[1] -&gt; Tensor) -&gt; QTensor dev '[1] -&gt; Tensor
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QType -&gt; QTensor dev '[1] -&gt; QTensor dev '[1]
forall a (shape :: [Nat]) (dtype :: DType)
       (device :: (DeviceType, Nat)).
Scalar a =&gt;
a -&gt; Tensor device dtype shape -&gt; Tensor device dtype shape
</span><span class="hs-identifier hs-var">TT.addScalar</span></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679384109"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QTensor dev '[]
forall (dev :: (DeviceType, Nat)).
KnownDevice dev =&gt;
QTensor dev '[]
</span><a href="RL.DQN.html#gamma"><span class="hs-identifier hs-var">gamma</span></a></span><span> </span><span class="annot"><span class="annottext">QTensor dev '[] -&gt; QTensor dev '[1] -&gt; QTensor dev '[1]
forall (shape'' :: [Nat]) (shape :: [Nat]) (shape' :: [Nat])
       (dtype :: DType) (dtype' :: DType) (dtype'' :: DType)
       (device :: (DeviceType, Nat)).
(dtype'' ~ DTypePromotion dtype dtype',
 shape'' ~ Broadcast shape shape',
 BasicArithmeticDTypeIsValid device dtype,
 BasicArithmeticDTypeIsValid device dtype',
 BasicArithmeticDTypeIsValid device dtype'') =&gt;
Tensor device dtype shape
-&gt; Tensor device dtype' shape' -&gt; Tensor device dtype'' shape''
</span><span class="hs-operator hs-var">`TT.mul`</span></span><span> </span><span class="annot"><span class="annottext">QTensor dev '[1]
</span><a href="#local-6989586621679384122"><span class="hs-identifier hs-var">qnext</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span class="hs-comment">-- delta = qnow - qexpected</span><span>
</span><span id="line-342"></span><span>
</span><span id="line-343"></span><span class="annot"><a href="RL.DQN.html#trainDQN"><span class="hs-identifier hs-type">trainDQN</span></a></span><span>
</span><span id="line-344"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679378535"><span class="annot"><a href="#local-6989586621679378535"><span class="hs-identifier hs-type">dev</span></a></span></span><span> </span><span id="local-6989586621679378536"><span class="annot"><a href="#local-6989586621679378536"><span class="hs-identifier hs-type">gen</span></a></span></span><span> </span><span id="local-6989586621679378545"><span class="annot"><a href="#local-6989586621679378545"><span class="hs-identifier hs-type">tr</span></a></span></span><span> </span><span id="local-6989586621679378546"><span class="annot"><a href="#local-6989586621679378546"><span class="hs-identifier hs-type">tr'</span></a></span></span><span> </span><span id="local-6989586621679378544"><span class="annot"><a href="#local-6989586621679378544"><span class="hs-identifier hs-type">slc</span></a></span></span><span> </span><span id="local-6989586621679378547"><span class="annot"><a href="#local-6989586621679378547"><span class="hs-identifier hs-type">slc'</span></a></span></span><span> </span><span id="local-6989586621679378537"><span class="annot"><a href="#local-6989586621679378537"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679378538"><span class="annot"><a href="#local-6989586621679378538"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621679378539"><span class="annot"><a href="#local-6989586621679378539"><span class="hs-identifier hs-type">h</span></a></span></span><span>
</span><span id="line-345"></span><span>   </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#IsValidDevice"><span class="hs-identifier hs-type">IsValidDevice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378535"><span class="hs-identifier hs-type">dev</span></a></span><span>
</span><span id="line-346"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StatefulGen</span></span><span> </span><span class="annot"><a href="#local-6989586621679378536"><span class="hs-identifier hs-type">gen</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span>
</span><span id="line-347"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621679378537"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-348"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621679378538"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-349"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621679378539"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-350"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679378537"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Split</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-comment">-- TODO: keep fully open or specialize</span><span>
</span><span id="line-351"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679378538"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Freeze</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-352"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679378539"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Spread</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-353"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621679378544"><span class="hs-identifier hs-type">slc</span></a></span><span>
</span><span id="line-354"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621679378545"><span class="hs-identifier hs-type">tr</span></a></span><span>
</span><span id="line-355"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679378536"><span class="hs-identifier hs-type">gen</span></a></span><span>
</span><span id="line-357"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eval</span></span><span> </span><span class="annot"><a href="#local-6989586621679378545"><span class="hs-identifier hs-type">tr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378546"><span class="hs-identifier hs-type">tr'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378544"><span class="hs-identifier hs-type">slc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378547"><span class="hs-identifier hs-type">slc'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378539"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Leftmost</span></span><span> </span><span class="annot"><a href="#local-6989586621679378537"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378538"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378539"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GreedyState</span></span><span> </span><span class="annot"><a href="#local-6989586621679378545"><span class="hs-identifier hs-type">tr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378546"><span class="hs-identifier hs-type">tr'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378544"><span class="hs-identifier hs-type">slc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Leftmost</span></span><span> </span><span class="annot"><a href="#local-6989586621679378537"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378538"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378539"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Action</span></span><span> </span><span class="annot"><a href="#local-6989586621679378544"><span class="hs-identifier hs-type">slc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378545"><span class="hs-identifier hs-type">tr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378537"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378538"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378539"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.Encoding.html#QEncoding"><span class="hs-identifier hs-type">QEncoding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378535"><span class="hs-identifier hs-type">dev</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-359"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Analysis</span></span><span> </span><span class="annot"><a href="#local-6989586621679378537"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378538"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378539"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378545"><span class="hs-identifier hs-type">tr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378544"><span class="hs-identifier hs-type">slc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Action</span></span><span> </span><span class="annot"><a href="#local-6989586621679378544"><span class="hs-identifier hs-type">slc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378545"><span class="hs-identifier hs-type">tr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378537"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378538"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378539"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><a href="#local-6989586621679378547"><span class="hs-identifier hs-type">slc'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378546"><span class="hs-identifier hs-type">tr'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-362"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-363"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RL.Model.html#QModel"><span class="hs-identifier hs-type">QModel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679378535"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-364"></span><span id="trainDQN"><span class="annot"><span class="annottext">trainDQN :: forall (dev :: (DeviceType, Nat)) gen tr tr' slc slc' s f h.
(IsValidDevice dev, StatefulGen gen IO, Show s, Show f, Show h,
 s ~ Split SPitch, f ~ Freeze SPitch, h ~ Spread SPitch, Show slc,
 Show tr) =&gt;
gen
-&gt; Eval tr tr' slc slc' h (Leftmost s f h)
-&gt; (GreedyState tr tr' slc (Leftmost s f h)
    -&gt; Action slc tr s f h -&gt; QEncoding dev '[])
-&gt; (Analysis s f h tr slc -&gt; IO QType)
-&gt; (Action slc tr s f h -&gt; Maybe Bool -&gt; IO QType)
-&gt; [Path slc' tr']
-&gt; Int
-&gt; IO ([QType], [QType], QModel dev)
</span><a href="RL.DQN.html#trainDQN"><span class="hs-identifier hs-var hs-var">trainDQN</span></a></span></span><span> </span><span id="local-6989586621679385043"><span class="annot"><span class="annottext">gen
</span><a href="#local-6989586621679385043"><span class="hs-identifier hs-var">gen</span></a></span></span><span> </span><span id="local-6989586621679385044"><span class="annot"><span class="annottext">Eval tr tr' slc slc' h (Leftmost s f h)
</span><a href="#local-6989586621679385044"><span class="hs-identifier hs-var">eval</span></a></span></span><span> </span><span id="local-6989586621679385045"><span class="annot"><span class="annottext">GreedyState tr tr' slc (Leftmost s f h)
-&gt; Action slc tr s f h -&gt; QEncoding dev '[]
</span><a href="#local-6989586621679385045"><span class="hs-identifier hs-var">encode</span></a></span></span><span> </span><span id="local-6989586621679385046"><span class="annot"><span class="annottext">Analysis s f h tr slc -&gt; IO QType
</span><a href="#local-6989586621679385046"><span class="hs-identifier hs-var">reward</span></a></span></span><span> </span><span id="local-6989586621679385047"><span class="annot"><span class="annottext">Action slc tr s f h -&gt; Maybe Bool -&gt; IO QType
</span><a href="#local-6989586621679385047"><span class="hs-identifier hs-var">rewardStep</span></a></span></span><span> </span><span id="local-6989586621679385048"><span class="annot"><span class="annottext">[Path slc' tr']
</span><a href="#local-6989586621679385048"><span class="hs-identifier hs-var">pieces</span></a></span></span><span> </span><span id="local-6989586621679385049"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679385049"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-365"></span><span>  </span><span id="local-6989586621679385050"><span class="annot"><a href="#local-6989586621679385050"><span class="hs-identifier hs-var">model0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (QModel dev)
forall (dev :: (DeviceType, Nat)).
IsValidDevice dev =&gt;
IO (QModel dev)
</span><a href="RL.Model.html#mkQModel"><span class="hs-identifier hs-var">mkQModel</span></a></span><span>
</span><span id="line-366"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679385052"><span class="annot"><a href="#local-6989586621679385052"><span class="hs-identifier hs-var hs-var">opt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AdamIter
-&gt; Float
-&gt; Float
-&gt; HList
     '[Parameter dev QDType '[8, 1, 1, 1], Parameter dev QDType '[8],
       Parameter dev QDType '[8, 8, 13, 5], Parameter dev QDType '[8],
       Parameter dev QDType '[8, 13, 5], Parameter dev QDType '[8, 13, 5],
       Parameter dev QDType '[8, 2, 13, 5], Parameter dev QDType '[8],
       Parameter dev QDType '[8, 2, 13, 5], Parameter dev QDType '[8],
       Parameter dev QDType '[8, 1, 1, 1], Parameter dev QDType '[8],
       Parameter dev QDType '[8, 1, 1, 1], Parameter dev QDType '[8],
       Parameter dev QDType '[8], Parameter dev QDType '[8, 8, 13, 5],
       Parameter dev QDType '[8], Parameter dev QDType '[8, 8, 13, 5],
       Parameter dev QDType '[8], Parameter dev QDType '[8, 8, 13, 5],
       Parameter dev QDType '[8], Parameter dev QDType '[8, 8, 13, 5],
       Parameter dev QDType '[8], Parameter dev QDType '[8, 8, 13, 5],
       Parameter dev QDType '[8], Parameter dev QDType '[8, 8, 13, 5],
       Parameter dev QDType '[8], Parameter dev QDType '[8, 8, 13, 5],
       Parameter dev QDType '[8], Parameter dev QDType '[5],
       Parameter dev QDType '[5], Parameter dev QDType '[5],
       Parameter dev QDType '[8, 8, 13, 5], Parameter dev QDType '[8],
       Parameter dev QDType '[8, 8, 13, 5], Parameter dev QDType '[8],
       Parameter dev QDType '[8, 8, 13, 5], Parameter dev QDType '[8],
       Parameter dev QDType '[8, 8, 13, 5], Parameter dev QDType '[8],
       Parameter dev QDType '[8, 8, 13, 5], Parameter dev QDType '[8],
       Parameter dev QDType '[8, 8, 13, 5], Parameter dev QDType '[8],
       Parameter dev QDType '[8, 8, 13, 5], Parameter dev QDType '[8],
       Parameter dev QDType '[8, 8, 13, 5], Parameter dev QDType '[8],
       Parameter dev QDType '[8], Parameter dev QDType '[8],
       Parameter dev QDType '[1, 8], Parameter dev QDType '[1],
       Parameter dev QDType '[8, 8], Parameter dev QDType '[8],
       Parameter dev QDType '[8], Parameter dev QDType '[8],
       Parameter dev QDType '[1, 8], Parameter dev QDType '[1]]
-&gt; Adam
     '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
       Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[5],
       Tensor dev QDType '[5], Tensor dev QDType '[5],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8],
       Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
       Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8],
       Tensor dev QDType '[1, 8], Tensor dev QDType '[1]]
forall (parameters :: [*]) (momenta :: [*]).
HMap' ZerosLike parameters momenta =&gt;
AdamIter -&gt; Float -&gt; Float -&gt; HList parameters -&gt; Adam momenta
</span><span class="hs-identifier hs-var">TT.mkAdam</span></span><span> </span><span class="annot"><span class="annottext">AdamIter
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0.9</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0.99</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QModel dev -&gt; HList (Parameters (QModel dev))
forall f. Parameterized f =&gt; f -&gt; HList (Parameters f)
</span><span class="hs-identifier hs-var">TT.flattenParameters</span></span><span> </span><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679385050"><span class="hs-identifier hs-var">model0</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- T.GD</span><span>
</span><span id="line-367"></span><span>      </span><span id="local-6989586621679385054"><span class="annot"><a href="#local-6989586621679385054"><span class="hs-identifier hs-var hs-var">buffer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ReplayBuffer dev tr tr' slc s f h
forall (dev :: (DeviceType, Nat)) tr tr' slc s f h.
Int -&gt; ReplayBuffer dev tr tr' slc s f h
</span><a href="RL.ReplayBuffer.html#mkReplayBuffer"><span class="hs-identifier hs-var">mkReplayBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="RL.DQN.html#bufferSize"><span class="hs-identifier hs-var">bufferSize</span></a></span><span>
</span><span id="line-368"></span><span>      </span><span id="local-6989586621679385056"><span class="annot"><a href="#local-6989586621679385056"><span class="hs-identifier hs-var hs-var">state0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QModel dev
-&gt; QModel dev
-&gt; Adam
     '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
       Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[5],
       Tensor dev QDType '[5], Tensor dev QDType '[5],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8],
       Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
       Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8],
       Tensor dev QDType '[1, 8], Tensor dev QDType '[1]]
-&gt; ReplayBuffer dev tr tr' slc s f h
-&gt; DQNState
     dev
     (Adam
        '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
          Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
          Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
          Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
          Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
          Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
          Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
          Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
          Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
          Tensor dev QDType '[8], Tensor dev QDType '[5],
          Tensor dev QDType '[5], Tensor dev QDType '[5],
          Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8], Tensor dev QDType '[8],
          Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
          Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
          Tensor dev QDType '[8], Tensor dev QDType '[8],
          Tensor dev QDType '[1, 8], Tensor dev QDType '[1]])
     tr
     tr'
     slc
     s
     f
     h
     QType
forall {k} (dev :: (DeviceType, Nat)) opt tr tr' slc s f h
       (r :: k).
QModel dev
-&gt; QModel dev
-&gt; opt
-&gt; ReplayBuffer dev tr tr' slc s f h
-&gt; DQNState dev opt tr tr' slc s f h r
</span><a href="RL.DQN.html#DQNState"><span class="hs-identifier hs-var">DQNState</span></a></span><span> </span><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679385050"><span class="hs-identifier hs-var">model0</span></a></span><span> </span><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679385050"><span class="hs-identifier hs-var">model0</span></a></span><span> </span><span class="annot"><span class="annottext">Adam
  '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
    Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
    Tensor dev QDType '[8], Tensor dev QDType '[5],
    Tensor dev QDType '[5], Tensor dev QDType '[5],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
    Tensor dev QDType '[8], Tensor dev QDType '[8],
    Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
    Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
    Tensor dev QDType '[8], Tensor dev QDType '[8],
    Tensor dev QDType '[1, 8], Tensor dev QDType '[1]]
</span><a href="#local-6989586621679385052"><span class="hs-identifier hs-var">opt</span></a></span><span> </span><span class="annot"><span class="annottext">ReplayBuffer dev tr tr' slc s f h
forall {dev :: (DeviceType, Nat)} {tr} {tr'} {slc} {s} {f} {h}.
ReplayBuffer dev tr tr' slc s f h
</span><a href="#local-6989586621679385054"><span class="hs-identifier hs-var">buffer</span></a></span><span>
</span><span id="line-369"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="RL.DQN.html#DQNState"><span class="hs-identifier hs-type">DQNState</span></a></span><span> </span><span id="local-6989586621679385057"><span class="annot"><a href="#local-6989586621679385057"><span class="hs-identifier hs-var">modelTrained</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679385058"><span class="annot"><a href="#local-6989586621679385058"><span class="hs-identifier hs-var">rewards</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679385059"><span class="annot"><a href="#local-6989586621679385059"><span class="hs-identifier hs-var">losses</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679385060"><span class="annot"><a href="#local-6989586621679385060"><span class="hs-identifier hs-var">accs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.foldLoop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679385056"><span class="hs-identifier hs-type">state0</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679385049"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679385062"><span class="hs-identifier hs-type">trainEpoch</span></a></span><span>
</span><span id="line-370"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">reverse</span></span><span> </span><span class="annot"><a href="#local-6989586621679385058"><span class="hs-identifier hs-type">rewards</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">reverse</span></span><span> </span><span class="annot"><a href="#local-6989586621679385059"><span class="hs-identifier hs-type">losses</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679385057"><span class="hs-identifier hs-type">modelTrained</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- (modelTrained, rewards)</span><span>
</span><span id="line-371"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-372"></span><span>  </span><span id="local-6989586621679385064"><span class="annot"><span class="annottext">trainPiece :: Int
-&gt; (DQNState
      dev
      (Adam
         '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
           Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[5],
           Tensor dev QDType '[5], Tensor dev QDType '[5],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8], Tensor dev QDType '[8],
           Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
           Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
           Tensor dev QDType '[8], Tensor dev QDType '[8],
           Tensor dev QDType '[1, 8], Tensor dev QDType '[1]])
      tr
      tr'
      slc
      s
      f
      h
      QType,
    [QType], [QType])
-&gt; Path slc' tr'
-&gt; IO
     (DQNState
        dev
        (Adam
           '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
             Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[5],
             Tensor dev QDType '[5], Tensor dev QDType '[5],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8], Tensor dev QDType '[8],
             Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
             Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
             Tensor dev QDType '[8], Tensor dev QDType '[8],
             Tensor dev QDType '[1, 8], Tensor dev QDType '[1]])
        tr
        tr'
        slc
        s
        f
        h
        QType,
      [QType], [QType])
</span><a href="#local-6989586621679385064"><span class="hs-identifier hs-var hs-var">trainPiece</span></a></span></span><span> </span><span id="local-6989586621679385065"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679385065"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679385066"><span class="annot"><span class="annottext">DQNState
  dev
  (Adam
     '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
       Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[5],
       Tensor dev QDType '[5], Tensor dev QDType '[5],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8],
       Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
       Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8],
       Tensor dev QDType '[1, 8], Tensor dev QDType '[1]])
  tr
  tr'
  slc
  s
  f
  h
  QType
</span><a href="#local-6989586621679385066"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679385067"><span class="annot"><span class="annottext">[QType]
</span><a href="#local-6989586621679385067"><span class="hs-identifier hs-var">rewards</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679385068"><span class="annot"><span class="annottext">[QType]
</span><a href="#local-6989586621679385068"><span class="hs-identifier hs-var">losses</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679385069"><span class="annot"><span class="annottext">Path slc' tr'
</span><a href="#local-6989586621679385069"><span class="hs-identifier hs-var">piece</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-373"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679385070"><span class="annot"><a href="#local-6989586621679385070"><span class="hs-identifier hs-var">state'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679385071"><span class="annot"><a href="#local-6989586621679385071"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679385072"><span class="annot"><a href="#local-6989586621679385072"><span class="hs-identifier hs-var">loss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">gen
-&gt; Eval tr tr' slc slc' h (Leftmost s f h)
-&gt; (GreedyState tr tr' slc (Leftmost s f h)
    -&gt; Action slc tr s f h -&gt; QEncoding dev '[])
-&gt; (Analysis s f h tr slc -&gt; IO QType)
-&gt; (Action slc tr s f h -&gt; Maybe Bool -&gt; IO QType)
-&gt; Path slc' tr'
-&gt; DQNState
     dev
     (Adam
        '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
          Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
          Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
          Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
          Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
          Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
          Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
          Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
          Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
          Tensor dev QDType '[8], Tensor dev QDType '[5],
          Tensor dev QDType '[5], Tensor dev QDType '[5],
          Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
          Tensor dev QDType '[8], Tensor dev QDType '[8],
          Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
          Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
          Tensor dev QDType '[8], Tensor dev QDType '[8],
          Tensor dev QDType '[1, 8], Tensor dev QDType '[1]])
     tr
     tr'
     slc
     s
     f
     h
     QType
-&gt; Int
-&gt; Int
-&gt; IO
     (DQNState
        dev
        (Adam
           '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
             Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[5],
             Tensor dev QDType '[5], Tensor dev QDType '[5],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8], Tensor dev QDType '[8],
             Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
             Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
             Tensor dev QDType '[8], Tensor dev QDType '[8],
             Tensor dev QDType '[1, 8], Tensor dev QDType '[1]])
        tr
        tr'
        slc
        s
        f
        h
        QType,
      QType, QType)
forall (dev :: (DeviceType, Nat)) tr tr' slc slc' s f h gen opt
       {device :: (DeviceType, Nat)}.
(GeluDTypeIsValid dev QDType, RandDTypeIsValid dev QDType,
 SumDTypeIsValid dev QDType, MeanDTypeValidation dev QDType,
 StandardFloatingPointDTypeValidation dev QDType,
 GeluDTypeIsValid device QDType, RandDTypeIsValid device QDType,
 BasicArithmeticDTypeIsValid device QDType,
 SumDTypeIsValid device QDType, MeanDTypeValidation device QDType,
 StandardFloatingPointDTypeValidation device QDType,
 BasicArithmeticDTypeIsValid dev QDType, StatefulGen gen IO,
 Optimizer
   opt
   '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
     Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
     Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
     Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
     Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
     Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
     Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
     Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
     Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
     Tensor dev QDType '[8], Tensor dev QDType '[5],
     Tensor dev QDType '[5], Tensor dev QDType '[5],
     Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8], Tensor dev QDType '[8],
     Tensor dev QDType '[1, 8], QTensor dev '[1],
     Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
     Tensor dev QDType '[8], Tensor dev QDType '[8],
     Tensor dev QDType '[1, 8], QTensor dev '[1]]
   '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
     Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
     Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
     Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
     Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
     Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
     Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
     Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
     Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
     Tensor dev QDType '[8], Tensor dev QDType '[5],
     Tensor dev QDType '[5], Tensor dev QDType '[5],
     Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
     Tensor dev QDType '[8], Tensor dev QDType '[8],
     Tensor dev QDType '[1, 8], QTensor dev '[1],
     Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
     Tensor dev QDType '[8], Tensor dev QDType '[8],
     Tensor dev QDType '[1, 8], QTensor dev '[1]]
   QDType
   device,
 KnownDevice device, KnownDevice dev) =&gt;
gen
-&gt; Eval tr tr' slc slc' h (Leftmost s f h)
-&gt; (GreedyState tr tr' slc (Leftmost s f h)
    -&gt; Action slc tr s f h -&gt; QEncoding dev '[])
-&gt; (Analysis s f h tr slc -&gt; IO QType)
-&gt; (Action slc tr s f h -&gt; Maybe Bool -&gt; IO QType)
-&gt; Path slc' tr'
-&gt; DQNState dev opt tr tr' slc s f h QType
-&gt; Int
-&gt; Int
-&gt; IO (DQNState dev opt tr tr' slc s f h QType, QType, QType)
</span><a href="RL.DQN.html#trainLoop"><span class="hs-identifier hs-var">trainLoop</span></a></span><span> </span><span class="annot"><span class="annottext">gen
</span><a href="#local-6989586621679385043"><span class="hs-identifier hs-var">gen</span></a></span><span> </span><span class="annot"><span class="annottext">Eval tr tr' slc slc' h (Leftmost s f h)
</span><a href="#local-6989586621679385044"><span class="hs-identifier hs-var">eval</span></a></span><span> </span><span class="annot"><span class="annottext">GreedyState tr tr' slc (Leftmost s f h)
-&gt; Action slc tr s f h -&gt; QEncoding dev '[]
</span><a href="#local-6989586621679385045"><span class="hs-identifier hs-var">encode</span></a></span><span> </span><span class="annot"><span class="annottext">Analysis s f h tr slc -&gt; IO QType
</span><a href="#local-6989586621679385046"><span class="hs-identifier hs-var">reward</span></a></span><span> </span><span class="annot"><span class="annottext">Action slc tr s f h -&gt; Maybe Bool -&gt; IO QType
</span><a href="#local-6989586621679385047"><span class="hs-identifier hs-var">rewardStep</span></a></span><span> </span><span class="annot"><span class="annottext">Path slc' tr'
</span><a href="#local-6989586621679385069"><span class="hs-identifier hs-var">piece</span></a></span><span> </span><span class="annot"><span class="annottext">DQNState
  dev
  (Adam
     '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
       Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[5],
       Tensor dev QDType '[5], Tensor dev QDType '[5],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8],
       Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
       Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8],
       Tensor dev QDType '[1, 8], Tensor dev QDType '[1]])
  tr
  tr'
  slc
  s
  f
  h
  QType
</span><a href="#local-6989586621679385066"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679385065"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679385049"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-374"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679385070"><span class="hs-identifier hs-type">state'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679385071"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621679385067"><span class="hs-identifier hs-type">rewards</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679385072"><span class="hs-identifier hs-type">loss</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621679385068"><span class="hs-identifier hs-type">losses</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span>  </span><span id="local-6989586621679385062"><span class="annot"><span class="annottext">trainEpoch :: (DQNState
   dev
   (Adam
      '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
        Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
        Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
        Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
        Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
        Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
        Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
        Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
        Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
        Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
        Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
        Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
        Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
        Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
        Tensor dev QDType '[8], Tensor dev QDType '[5],
        Tensor dev QDType '[5], Tensor dev QDType '[5],
        Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
        Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
        Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
        Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
        Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
        Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
        Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
        Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
        Tensor dev QDType '[8], Tensor dev QDType '[8],
        Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
        Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
        Tensor dev QDType '[8], Tensor dev QDType '[8],
        Tensor dev QDType '[1, 8], Tensor dev QDType '[1]])
   tr
   tr'
   slc
   s
   f
   h
   QType,
 [QType], [QType], [QType])
-&gt; Int
-&gt; IO
     (DQNState
        dev
        (Adam
           '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
             Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[5],
             Tensor dev QDType '[5], Tensor dev QDType '[5],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8], Tensor dev QDType '[8],
             Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
             Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
             Tensor dev QDType '[8], Tensor dev QDType '[8],
             Tensor dev QDType '[1, 8], Tensor dev QDType '[1]])
        tr
        tr'
        slc
        s
        f
        h
        QType,
      [QType], [QType], [QType])
</span><a href="#local-6989586621679385062"><span class="hs-identifier hs-var hs-var">trainEpoch</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679385073"><span class="annot"><span class="annottext">DQNState
  dev
  (Adam
     '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
       Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[5],
       Tensor dev QDType '[5], Tensor dev QDType '[5],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8],
       Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
       Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8],
       Tensor dev QDType '[1, 8], Tensor dev QDType '[1]])
  tr
  tr'
  slc
  s
  f
  h
  QType
</span><a href="#local-6989586621679385073"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679385074"><span class="annot"><span class="annottext">[QType]
</span><a href="#local-6989586621679385074"><span class="hs-identifier hs-var">meanRewards</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679385075"><span class="annot"><span class="annottext">[QType]
</span><a href="#local-6989586621679385075"><span class="hs-identifier hs-var">meanLosses</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679385076"><span class="annot"><span class="annottext">[QType]
</span><a href="#local-6989586621679385076"><span class="hs-identifier hs-var">accuracies</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679385077"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679385077"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-376"></span><span>    </span><span class="hs-comment">-- run epoch</span><span>
</span><span id="line-377"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679385078"><span class="annot"><a href="#local-6989586621679385078"><span class="hs-identifier hs-var">state'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679385079"><span class="annot"><a href="#local-6989586621679385079"><span class="hs-identifier hs-var">rewards</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679385080"><span class="annot"><a href="#local-6989586621679385080"><span class="hs-identifier hs-var">losses</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-378"></span><span>      </span><span class="annot"><span class="annottext">((DQNState
    dev
    (Adam
       '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
         Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
         Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
         Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
         Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
         Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
         Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
         Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
         Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
         Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
         Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
         Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
         Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
         Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
         Tensor dev QDType '[8], Tensor dev QDType '[5],
         Tensor dev QDType '[5], Tensor dev QDType '[5],
         Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
         Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
         Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
         Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
         Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
         Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
         Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
         Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
         Tensor dev QDType '[8], Tensor dev QDType '[8],
         Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
         Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
         Tensor dev QDType '[8], Tensor dev QDType '[8],
         Tensor dev QDType '[1, 8], Tensor dev QDType '[1]])
    tr
    tr'
    slc
    s
    f
    h
    QType,
  [QType], [QType])
 -&gt; Path slc' tr'
 -&gt; IO
      (DQNState
         dev
         (Adam
            '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
              Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
              Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
              Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
              Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
              Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
              Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
              Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
              Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
              Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
              Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
              Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
              Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
              Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
              Tensor dev QDType '[8], Tensor dev QDType '[5],
              Tensor dev QDType '[5], Tensor dev QDType '[5],
              Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
              Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
              Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
              Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
              Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
              Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
              Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
              Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
              Tensor dev QDType '[8], Tensor dev QDType '[8],
              Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
              Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
              Tensor dev QDType '[8], Tensor dev QDType '[8],
              Tensor dev QDType '[1, 8], Tensor dev QDType '[1]])
         tr
         tr'
         slc
         s
         f
         h
         QType,
       [QType], [QType]))
-&gt; (DQNState
      dev
      (Adam
         '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
           Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[5],
           Tensor dev QDType '[5], Tensor dev QDType '[5],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8], Tensor dev QDType '[8],
           Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
           Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
           Tensor dev QDType '[8], Tensor dev QDType '[8],
           Tensor dev QDType '[1, 8], Tensor dev QDType '[1]])
      tr
      tr'
      slc
      s
      f
      h
      QType,
    [QType], [QType])
-&gt; [Path slc' tr']
-&gt; IO
     (DQNState
        dev
        (Adam
           '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
             Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[5],
             Tensor dev QDType '[5], Tensor dev QDType '[5],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8], Tensor dev QDType '[8],
             Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
             Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
             Tensor dev QDType '[8], Tensor dev QDType '[8],
             Tensor dev QDType '[1, 8], Tensor dev QDType '[1]])
        tr
        tr'
        slc
        s
        f
        h
        QType,
      [QType], [QType])
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
-&gt; (DQNState
      dev
      (Adam
         '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
           Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
           Tensor dev QDType '[8], Tensor dev QDType '[5],
           Tensor dev QDType '[5], Tensor dev QDType '[5],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
           Tensor dev QDType '[8], Tensor dev QDType '[8],
           Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
           Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
           Tensor dev QDType '[8], Tensor dev QDType '[8],
           Tensor dev QDType '[1, 8], Tensor dev QDType '[1]])
      tr
      tr'
      slc
      s
      f
      h
      QType,
    [QType], [QType])
-&gt; Path slc' tr'
-&gt; IO
     (DQNState
        dev
        (Adam
           '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
             Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
             Tensor dev QDType '[8], Tensor dev QDType '[5],
             Tensor dev QDType '[5], Tensor dev QDType '[5],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
             Tensor dev QDType '[8], Tensor dev QDType '[8],
             Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
             Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
             Tensor dev QDType '[8], Tensor dev QDType '[8],
             Tensor dev QDType '[1, 8], Tensor dev QDType '[1]])
        tr
        tr'
        slc
        s
        f
        h
        QType,
      [QType], [QType])
</span><a href="#local-6989586621679385064"><span class="hs-identifier hs-var">trainPiece</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679385077"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DQNState
  dev
  (Adam
     '[Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 13, 5], Tensor dev QDType '[8, 13, 5],
       Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 2, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 1, 1, 1], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[8, 8, 13, 5],
       Tensor dev QDType '[8], Tensor dev QDType '[5],
       Tensor dev QDType '[5], Tensor dev QDType '[5],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8, 8, 13, 5], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8],
       Tensor dev QDType '[1, 8], Tensor dev QDType '[1],
       Tensor dev QDType '[8, 8], Tensor dev QDType '[8],
       Tensor dev QDType '[8], Tensor dev QDType '[8],
       Tensor dev QDType '[1, 8], Tensor dev QDType '[1]])
  tr
  tr'
  slc
  s
  f
  h
  QType
</span><a href="#local-6989586621679385073"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Path slc' tr']
</span><a href="#local-6989586621679385048"><span class="hs-identifier hs-var">pieces</span></a></span><span>
</span><span id="line-379"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679385081"><span class="annot"><a href="#local-6989586621679385081"><span class="hs-identifier hs-var hs-var">meanRewards'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[QType] -&gt; QType
forall (t :: * -&gt; *). Foldable t =&gt; t QType -&gt; QType
</span><a href="RL.Plotting.html#mean"><span class="hs-identifier hs-var">mean</span></a></span><span> </span><span class="annot"><span class="annottext">[QType]
</span><a href="#local-6989586621679385079"><span class="hs-identifier hs-var">rewards</span></a></span><span> </span><span class="annot"><span class="annottext">QType -&gt; [QType] -&gt; [QType]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[QType]
</span><a href="#local-6989586621679385074"><span class="hs-identifier hs-var">meanRewards</span></a></span><span>
</span><span id="line-380"></span><span>        </span><span id="local-6989586621679385083"><span class="annot"><a href="#local-6989586621679385083"><span class="hs-identifier hs-var hs-var">meanLosses'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[QType] -&gt; QType
forall (t :: * -&gt; *). Foldable t =&gt; t QType -&gt; QType
</span><a href="RL.Plotting.html#mean"><span class="hs-identifier hs-var">mean</span></a></span><span> </span><span class="annot"><span class="annottext">[QType]
</span><a href="#local-6989586621679385080"><span class="hs-identifier hs-var">losses</span></a></span><span> </span><span class="annot"><span class="annottext">QType -&gt; [QType] -&gt; [QType]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[QType]
</span><a href="#local-6989586621679385075"><span class="hs-identifier hs-var">meanLosses</span></a></span><span>
</span><span id="line-381"></span><span>    </span><span class="hs-comment">-- compute greedy reward (&quot;accuracy&quot;)</span><span>
</span><span id="line-382"></span><span>    </span><span id="local-6989586621679385084"><span class="annot"><a href="#local-6989586621679385084"><span class="hs-identifier hs-var">accuracies'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-383"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679385077"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`mod`</span></span><span> </span><span class="annot"><span class="hs-number">10</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-384"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-385"></span><span>          </span><span id="local-6989586621679385086"><span class="annot"><a href="#local-6989586621679385086"><span class="hs-identifier hs-var">results</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.DQN.html#runEpisode"><span class="hs-identifier hs-type">runEpisode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679385044"><span class="hs-identifier hs-type">eval</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679385045"><span class="hs-identifier hs-type">encode</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="RL.DQN.html#greedyPolicy"><span class="hs-identifier hs-type">greedyPolicy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T.forward</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.DQN.html#pnet"><span class="hs-identifier hs-var">pnet</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679385078"><span class="hs-identifier hs-type">state'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679385048"><span class="hs-identifier hs-type">pieces</span></a></span><span>
</span><span id="line-386"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sequence</span></span><span> </span><span class="annot"><a href="#local-6989586621679385086"><span class="hs-identifier hs-type">results</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-387"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679385089"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679385089"><span class="hs-identifier hs-var">error</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-388"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679385089"><span class="hs-identifier hs-var">error</span></a></span><span>
</span><span id="line-389"></span><span>              </span><span class="annot"><span class="annottext">[QType] -&gt; IO [QType]
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([QType] -&gt; IO [QType]) -&gt; [QType] -&gt; IO [QType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">QType
</span><a href="RL.ModelTypes.html#inf"><span class="hs-identifier hs-var">inf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">QType -&gt; [QType] -&gt; [QType]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[QType]
</span><a href="#local-6989586621679385076"><span class="hs-identifier hs-var">accuracies</span></a></span><span>
</span><span id="line-390"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679385091"><span class="annot"><span class="annottext">[([(GreedyState
      tr
      tr'
      slc
      (Leftmost (Split SPitch) (Freeze SPitch) (Spread SPitch)),
    Action slc tr (Split SPitch) (Freeze SPitch) (Spread SPitch),
    QEncoding dev '[],
    Maybe
      (GreedyState
         tr
         tr'
         slc
         (Leftmost (Split SPitch) (Freeze SPitch) (Spread SPitch)),
       [QEncoding dev '[]]),
    Maybe Bool)],
  Analysis s f h tr slc)]
</span><a href="#local-6989586621679385091"><span class="hs-identifier hs-var">episodes</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-391"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679385092"><span class="annot"><span class="annottext">analyses :: [Analysis s f h tr slc]
</span><a href="#local-6989586621679385092"><span class="hs-identifier hs-var hs-var hs-var">analyses</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(([(GreedyState
      tr
      tr'
      slc
      (Leftmost (Split SPitch) (Freeze SPitch) (Spread SPitch)),
    Action slc tr (Split SPitch) (Freeze SPitch) (Spread SPitch),
    QEncoding dev '[],
    Maybe
      (GreedyState
         tr
         tr'
         slc
         (Leftmost (Split SPitch) (Freeze SPitch) (Spread SPitch)),
       [QEncoding dev '[]]),
    Maybe Bool)],
  Analysis s f h tr slc)
 -&gt; Analysis s f h tr slc)
-&gt; [([(GreedyState
         tr
         tr'
         slc
         (Leftmost (Split SPitch) (Freeze SPitch) (Spread SPitch)),
       Action slc tr (Split SPitch) (Freeze SPitch) (Spread SPitch),
       QEncoding dev '[],
       Maybe
         (GreedyState
            tr
            tr'
            slc
            (Leftmost (Split SPitch) (Freeze SPitch) (Spread SPitch)),
          [QEncoding dev '[]]),
       Maybe Bool)],
     Analysis s f h tr slc)]
-&gt; [Analysis s f h tr slc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">([(GreedyState
     tr
     tr'
     slc
     (Leftmost (Split SPitch) (Freeze SPitch) (Spread SPitch)),
   Action slc tr (Split SPitch) (Freeze SPitch) (Spread SPitch),
   QEncoding dev '[],
   Maybe
     (GreedyState
        tr
        tr'
        slc
        (Leftmost (Split SPitch) (Freeze SPitch) (Spread SPitch)),
      [QEncoding dev '[]]),
   Maybe Bool)],
 Analysis s f h tr slc)
-&gt; Analysis s f h tr slc
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[([(GreedyState
      tr
      tr'
      slc
      (Leftmost (Split SPitch) (Freeze SPitch) (Spread SPitch)),
    Action slc tr (Split SPitch) (Freeze SPitch) (Spread SPitch),
    QEncoding dev '[],
    Maybe
      (GreedyState
         tr
         tr'
         slc
         (Leftmost (Split SPitch) (Freeze SPitch) (Spread SPitch)),
       [QEncoding dev '[]]),
    Maybe Bool)],
  Analysis s f h tr slc)]
</span><a href="#local-6989586621679385091"><span class="hs-identifier hs-var">episodes</span></a></span><span>
</span><span id="line-392"></span><span>              </span><span id="local-6989586621679385094"><span class="annot"><a href="#local-6989586621679385094"><span class="hs-identifier hs-var">accs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Analysis s f h tr slc -&gt; IO QType)
-&gt; [Analysis s f h tr slc] -&gt; IO [QType]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Analysis s f h tr slc -&gt; IO QType
</span><a href="#local-6989586621679385046"><span class="hs-identifier hs-var">reward</span></a></span><span> </span><span class="annot"><span class="annottext">[Analysis s f h tr slc]
</span><a href="#local-6989586621679385092"><span class="hs-identifier hs-var">analyses</span></a></span><span>
</span><span id="line-393"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">when</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679385077"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`mod`</span></span><span> </span><span class="annot"><span class="hs-number">100</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-394"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">putStrLn</span></span><span> </span><span class="annot"><span class="hs-string">&quot;current best analyses:&quot;</span></span><span>
</span><span id="line-395"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">zip</span></span><span> </span><span class="annot"><a href="#local-6989586621679385092"><span class="hs-identifier hs-type">analyses</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Analysis</span></span><span> </span><span id="local-6989586621679385095"><span class="annot"><span class="annottext">[Leftmost s f h]
</span><a href="#local-6989586621679385095"><span class="hs-identifier hs-var">deriv</span></a></span></span><span> </span><span class="annot"><span class="annottext">Path tr slc
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679385096"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679385096"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-396"></span><span>                  </span><span class="annot"><span class="annottext">(Leftmost s f h -&gt; IO ()) -&gt; [Leftmost s f h] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">Leftmost s f h -&gt; IO ()
forall a. Show a =&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">print</span></span><span> </span><span class="annot"><span class="annottext">[Leftmost s f h]
</span><a href="#local-6989586621679385095"><span class="hs-identifier hs-var">deriv</span></a></span><span>
</span><span id="line-397"></span><span>                  </span><span class="annot"><span class="annottext">String
-&gt; [Leftmost (Split SPitch) (Freeze SPitch) (Spread SPitch)]
-&gt; IO ()
forall (t :: * -&gt; *).
Foldable t =&gt;
String
-&gt; t (Leftmost (Split SPitch) (Freeze SPitch) (Spread SPitch))
-&gt; IO ()
</span><a href="RL.Plotting.html#plotDeriv"><span class="hs-identifier hs-var">plotDeriv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rl/deriv&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679385096"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.tex&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Leftmost s f h]
[Leftmost (Split SPitch) (Freeze SPitch) (Spread SPitch)]
</span><a href="#local-6989586621679385095"><span class="hs-identifier hs-var">deriv</span></a></span><span>
</span><span id="line-398"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="RL.Plotting.html#mean"><span class="hs-identifier hs-type">mean</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679385094"><span class="hs-identifier hs-type">accs</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621679385076"><span class="hs-identifier hs-type">accuracies</span></a></span><span>
</span><span id="line-399"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621679385076"><span class="hs-identifier hs-type">accuracies</span></a></span><span>
</span><span id="line-400"></span><span>    </span><span class="hs-comment">-- logging</span><span>
</span><span id="line-401"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">when</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679385077"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`mod`</span></span><span> </span><span class="annot"><span class="hs-number">10</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-402"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">putStrLn</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;epoch &quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">show</span></span><span> </span><span class="annot"><a href="#local-6989586621679385077"><span class="hs-identifier hs-type">i</span></a></span><span>
</span><span id="line-403"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.ReplayBuffer.html#ReplayBuffer"><span class="hs-identifier hs-type">ReplayBuffer</span></a></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679385100"><span class="annot"><a href="#local-6989586621679385100"><span class="hs-identifier hs-var">bcontent</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="RL.DQN.html#buffer"><span class="hs-identifier hs-var">buffer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679385078"><span class="hs-identifier hs-type">state'</span></a></span><span>
</span><span id="line-404"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">putStrLn</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;buffer size: &quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">length</span></span><span> </span><span class="annot"><a href="#local-6989586621679385100"><span class="hs-identifier hs-type">bcontent</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span>      </span><span class="hs-comment">-- mapM_ print $ take 10 bcontent</span><span>
</span><span id="line-406"></span><span>      </span><span class="annot"><a href="RL.Plotting.html#plotHistory"><span class="hs-identifier hs-type">plotHistory</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;rewards&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">reverse</span></span><span> </span><span class="annot"><a href="#local-6989586621679385081"><span class="hs-identifier hs-type">meanRewards'</span></a></span><span>
</span><span id="line-407"></span><span>      </span><span class="annot"><a href="RL.Plotting.html#plotHistory"><span class="hs-identifier hs-type">plotHistory</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;losses&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">reverse</span></span><span> </span><span class="annot"><a href="#local-6989586621679385083"><span class="hs-identifier hs-type">meanLosses'</span></a></span><span>
</span><span id="line-408"></span><span>      </span><span class="annot"><a href="RL.Plotting.html#plotHistory"><span class="hs-identifier hs-type">plotHistory</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;accuracy&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">reverse</span></span><span> </span><span class="annot"><a href="#local-6989586621679385084"><span class="hs-identifier hs-type">accuracies'</span></a></span><span>
</span><span id="line-409"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679385078"><span class="hs-identifier hs-type">state'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679385081"><span class="hs-identifier hs-type">meanRewards'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679385083"><span class="hs-identifier hs-type">meanLosses'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679385084"><span class="hs-identifier hs-type">accuracies'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span class="hs-comment">-- Plotting</span><span>
</span><span id="line-412"></span><span class="hs-comment">-- --------</span><span>
</span><span id="line-413"></span><span>
</span><span id="line-414"></span><span id="hi"><span class="annot"><span class="annottext">hi :: String -&gt; IO ()
</span><a href="RL.DQN.html#hi"><span class="hs-identifier hs-var hs-var">hi</span></a></span></span><span> </span><span id="local-6989586621679385104"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679385104"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Found the Exception:&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679385104"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-415"></span></pre></body></html>