<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE PartialTypeSignatures #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE Strict #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-partial-type-signatures #-}</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="RL.A2C.html"><span class="hs-identifier">RL.A2C</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Common</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GreedyParser</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">PVGrammar</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">PVGrammar.Prob.Simple</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PVParams</span></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="RL.A2CHelpers.html"><span class="hs-identifier">RL.A2CHelpers</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="RL.Encoding.html"><span class="hs-identifier">RL.Encoding</span></a></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="RL.Model.html"><span class="hs-identifier">RL.Model</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="RL.ModelTypes.html"><span class="hs-identifier">RL.ModelTypes</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="RL.Plotting.html"><span class="hs-identifier">RL.Plotting</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="RL.TorchHelpers.html"><span class="hs-identifier">RL.TorchHelpers</span></a></span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.DeepSeq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NFData</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">force</span></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Foldl</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Foldl</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">foldM</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">forM</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">forM_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">when</span></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ET</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">lift</span></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Except</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ET</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">partitionEithers</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">F</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.NonEmpty</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">mapMaybe</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Lazy</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Txt</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vector</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Debug.Trace</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DT</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Generics</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Inference.Conjugate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hyper</span></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Musicology.Pitch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">NoThunks.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">noThunks</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ThunkInfo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">thunkContext</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">StrictList</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SL</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">hFlush</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">stdout</span></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Mem</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">performGC</span></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.ProgressBar</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PB</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Random.MWC.Distributions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">categorical</span></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Random.Stateful</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">StatefulGen</span></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Random.Stateful</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Rand</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Torch</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Torch.Typed</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TT</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Torch.Typed.Optim.CppOptim</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TT</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Torch.Typed.Optim.CppOptim</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TTC</span></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-comment">-- global settings</span><span>
</span><span id="line-53"></span><span class="hs-comment">-- ===============</span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-comment">-- discount factor</span><span>
</span><span id="line-56"></span><span class="annot"><a href="RL.A2C.html#gamma"><span class="hs-identifier hs-type">gamma</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span>
</span><span id="line-57"></span><span id="gamma"><span class="annot"><span class="annottext">gamma :: QType
</span><a href="RL.A2C.html#gamma"><span class="hs-identifier hs-var hs-var">gamma</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType
</span><span class="hs-number">0.99</span></span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="hs-comment">-- eligibility decay factor (values)</span><span>
</span><span id="line-60"></span><span class="annot"><a href="RL.A2C.html#lambdaV"><span class="hs-identifier hs-type">lambdaV</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span>
</span><span id="line-61"></span><span id="lambdaV"><span class="annot"><span class="annottext">lambdaV :: QType
</span><a href="RL.A2C.html#lambdaV"><span class="hs-identifier hs-var hs-var">lambdaV</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType
</span><span class="hs-number">0.3</span></span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="hs-comment">-- eligibility decay factor (policy)</span><span>
</span><span id="line-64"></span><span class="annot"><a href="RL.A2C.html#lambdaP"><span class="hs-identifier hs-type">lambdaP</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span>
</span><span id="line-65"></span><span id="lambdaP"><span class="annot"><span class="annottext">lambdaP :: QType
</span><a href="RL.A2C.html#lambdaP"><span class="hs-identifier hs-var hs-var">lambdaP</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType
</span><span class="hs-number">0.3</span></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-comment">-- learning rate</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- learningRate :: TT.LearningRate QDevice QDType</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- learningRate = 0.01</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="annot"><a href="RL.A2C.html#nWorkers"><span class="hs-identifier hs-type">nWorkers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-72"></span><span id="nWorkers"><span class="annot"><span class="annottext">nWorkers :: Int
</span><a href="RL.A2C.html#nWorkers"><span class="hs-identifier hs-var hs-var">nWorkers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-comment">-- A2C</span><span>
</span><span id="line-75"></span><span class="hs-comment">-- ===</span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span id="local-6989586621679386353"><span class="annot"><a href="RL.A2C.html#printTensors"><span class="hs-identifier hs-type">printTensors</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.HList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.A2CHelpers.html#ModelTensors"><span class="hs-identifier hs-type">ModelTensors</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386353"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-78"></span><span id="printTensors"><span class="annot"><span class="annottext">printTensors :: forall (dev :: (DeviceType, Nat)).
HList (ModelTensors dev) -&gt; IO ()
</span><a href="RL.A2C.html#printTensors"><span class="hs-identifier hs-var hs-var">printTensors</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tensor dev 'Double '[8, 1, 1, 1]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">TT.:.</span></span><span> </span><span id="local-6989586621679386858"><span class="annot"><span class="annottext">Tensor dev 'Double '[8]
</span><a href="#local-6989586621679386858"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">TT.:.</span></span><span> </span><span class="annot"><span class="annottext">HList
  '[Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 13, 5], Tensor dev 'Double '[8, 13, 5],
    Tensor dev 'Double '[8, 2, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 2, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[5],
    Tensor dev 'Double '[5], Tensor dev 'Double '[5],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8],
    Tensor dev 'Double '[1, 8], Tensor dev 'Double '[1],
    Tensor dev 'Double '[8, 8], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8],
    Tensor dev 'Double '[1, 8], Tensor dev 'Double '[1]]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tensor dev 'Double '[8] -&gt; IO ()
forall a. Show a =&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">print</span></span><span> </span><span class="annot"><span class="annottext">Tensor dev 'Double '[8]
</span><a href="#local-6989586621679386858"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span id="local-6989586621679386364"><span class="annot"><a href="RL.A2C.html#printParams"><span class="hs-identifier hs-type">printParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.HList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.A2CHelpers.html#ModelParams"><span class="hs-identifier hs-type">ModelParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386364"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-81"></span><span id="printParams"><span class="annot"><span class="annottext">printParams :: forall (dev :: (DeviceType, Nat)). HList (ModelParams dev) -&gt; IO ()
</span><a href="RL.A2C.html#printParams"><span class="hs-identifier hs-var hs-var">printParams</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Parameter dev 'Double '[8, 1, 1, 1]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">TT.:.</span></span><span> </span><span id="local-6989586621679386862"><span class="annot"><span class="annottext">Parameter dev 'Double '[8]
</span><a href="#local-6989586621679386862"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">TT.:.</span></span><span> </span><span class="annot"><span class="annottext">HList
  '[Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
    Parameter dev 'Double '[8, 13, 5],
    Parameter dev 'Double '[8, 13, 5],
    Parameter dev 'Double '[8, 2, 13, 5], Parameter dev 'Double '[8],
    Parameter dev 'Double '[8, 2, 13, 5], Parameter dev 'Double '[8],
    Parameter dev 'Double '[8, 1, 1, 1], Parameter dev 'Double '[8],
    Parameter dev 'Double '[8, 1, 1, 1], Parameter dev 'Double '[8],
    Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
    Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
    Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
    Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
    Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
    Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
    Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
    Parameter dev 'Double '[8], Parameter dev 'Double '[5],
    Parameter dev 'Double '[5], Parameter dev 'Double '[5],
    Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
    Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
    Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
    Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
    Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
    Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
    Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
    Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
    Parameter dev 'Double '[8], Parameter dev 'Double '[8],
    Parameter dev 'Double '[1, 8], Parameter dev 'Double '[1],
    Parameter dev 'Double '[8, 8], Parameter dev 'Double '[8],
    Parameter dev 'Double '[8], Parameter dev 'Double '[8],
    Parameter dev 'Double '[1, 8], Parameter dev 'Double '[1]]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Parameter dev 'Double '[8] -&gt; IO ()
forall a. Show a =&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">print</span></span><span> </span><span class="annot"><span class="annottext">Parameter dev 'Double '[8]
</span><a href="#local-6989586621679386862"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span class="hs-keyword">data</span><span> </span><span id="A2CState"><span class="annot"><a href="RL.A2C.html#A2CState"><span class="hs-identifier hs-var">A2CState</span></a></span></span><span> </span><span id="local-6989586621679386371"><span class="annot"><a href="#local-6989586621679386371"><span class="hs-identifier hs-type">dev</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="A2CState"><span class="annot"><a href="RL.A2C.html#A2CState"><span class="hs-identifier hs-var">A2CState</span></a></span></span><span>
</span><span id="line-84"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="a2cActor"><span class="annot"><span class="annottext">forall (dev :: (DeviceType, Nat)). A2CState dev -&gt; QModel dev
</span><a href="RL.A2C.html#a2cActor"><span class="hs-identifier hs-var hs-var">a2cActor</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="RL.Model.html#QModel"><span class="hs-identifier hs-type">QModel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386371"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="a2cCritic"><span class="annot"><span class="annottext">forall (dev :: (DeviceType, Nat)). A2CState dev -&gt; QModel dev
</span><a href="RL.A2C.html#a2cCritic"><span class="hs-identifier hs-var hs-var">a2cCritic</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="RL.Model.html#QModel"><span class="hs-identifier hs-type">QModel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386371"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="a2cOptActor"><span class="annot"><span class="annottext">forall (dev :: (DeviceType, Nat)). A2CState dev -&gt; GD
</span><a href="RL.A2C.html#a2cOptActor"><span class="hs-identifier hs-var hs-var">a2cOptActor</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">TT.GD</span></span><span> </span><span class="hs-comment">-- !(TT.CppOptimizerState TT.AdamOptions ModelParams) -- !(TT.Adam ModelTensors) --</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="a2cOptCritic"><span class="annot"><span class="annottext">forall (dev :: (DeviceType, Nat)). A2CState dev -&gt; GD
</span><a href="RL.A2C.html#a2cOptCritic"><span class="hs-identifier hs-var hs-var">a2cOptCritic</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">TT.GD</span></span><span> </span><span class="hs-comment">-- !(TT.Adam ModelTensors)</span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679386869"><span id="local-6989586621679386871"><span class="annot"><span class="annottext">(forall x. A2CState dev -&gt; Rep (A2CState dev) x)
-&gt; (forall x. Rep (A2CState dev) x -&gt; A2CState dev)
-&gt; Generic (A2CState dev)
forall x. Rep (A2CState dev) x -&gt; A2CState dev
forall x. A2CState dev -&gt; Rep (A2CState dev) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (dev :: (DeviceType, Nat)) x.
Rep (A2CState dev) x -&gt; A2CState dev
forall (dev :: (DeviceType, Nat)) x.
A2CState dev -&gt; Rep (A2CState dev) x
$cfrom :: forall (dev :: (DeviceType, Nat)) x.
A2CState dev -&gt; Rep (A2CState dev) x
from :: forall x. A2CState dev -&gt; Rep (A2CState dev) x
$cto :: forall (dev :: (DeviceType, Nat)) x.
Rep (A2CState dev) x -&gt; A2CState dev
to :: forall x. Rep (A2CState dev) x -&gt; A2CState dev
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="hs-keyword">data</span><span> </span><span id="A2CStepState"><span class="annot"><a href="RL.A2C.html#A2CStepState"><span class="hs-identifier hs-var">A2CStepState</span></a></span></span><span> </span><span id="local-6989586621679386384"><span class="annot"><a href="#local-6989586621679386384"><span class="hs-identifier hs-type">dev</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="A2CStepState"><span class="annot"><a href="RL.A2C.html#A2CStepState"><span class="hs-identifier hs-var">A2CStepState</span></a></span></span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="a2cStepZV"><span class="annot"><span class="annottext">forall (dev :: (DeviceType, Nat)).
A2CStepState dev -&gt; HList (ModelTensors dev)
</span><a href="RL.A2C.html#a2cStepZV"><span class="hs-identifier hs-var hs-var">a2cStepZV</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TT.HList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.A2CHelpers.html#ModelTensors"><span class="hs-identifier hs-type">ModelTensors</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386384"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="a2cStepZP"><span class="annot"><span class="annottext">forall (dev :: (DeviceType, Nat)).
A2CStepState dev -&gt; HList (ModelTensors dev)
</span><a href="RL.A2C.html#a2cStepZP"><span class="hs-identifier hs-var hs-var">a2cStepZP</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TT.HList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.A2CHelpers.html#ModelTensors"><span class="hs-identifier hs-type">ModelTensors</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386384"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="a2cStepIntensity"><span class="annot"><span class="annottext">forall (dev :: (DeviceType, Nat)). A2CStepState dev -&gt; QType
</span><a href="RL.A2C.html#a2cStepIntensity"><span class="hs-identifier hs-var hs-var">a2cStepIntensity</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="a2cStepReward"><span class="annot"><span class="annottext">forall (dev :: (DeviceType, Nat)). A2CStepState dev -&gt; QType
</span><a href="RL.A2C.html#a2cStepReward"><span class="hs-identifier hs-var hs-var">a2cStepReward</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="a2cStepState"><span class="annot"><span class="annottext">forall (dev :: (DeviceType, Nat)).
A2CStepState dev
-&gt; GreedyState
     (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><a href="RL.A2C.html#a2cStepState"><span class="hs-identifier hs-var hs-var">a2cStepState</span></a></span></span><span>
</span><span id="line-97"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GreedyState</span></span><span>
</span><span id="line-98"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Edges</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>              </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Edge</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span>
</span><span id="line-100"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Notes</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PVLeftmost</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="a2cStepActions"><span class="annot"><span class="annottext">forall (dev :: (DeviceType, Nat)).
A2CStepState dev -&gt; NonEmpty PVAction
</span><a href="RL.A2C.html#a2cStepActions"><span class="hs-identifier hs-var hs-var">a2cStepActions</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NE.NonEmpty</span></span><span> </span><span class="annot"><a href="RL.ModelTypes.html#PVAction"><span class="hs-identifier hs-type">PVAction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span id="local-6989586621679386399"><span class="annot"><a href="RL.A2C.html#initPieceState"><span class="hs-identifier hs-type">initPieceState</span></a></span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TT.KnownDevice</span></span><span> </span><span class="annot"><a href="#local-6989586621679386399"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eval</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Edges</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Edge</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Notes</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Note</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Spread</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PVLeftmost</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Note</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Edge</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.HList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.A2CHelpers.html#ModelTensors"><span class="hs-identifier hs-type">ModelTensors</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386399"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.A2C.html#A2CStepState"><span class="hs-identifier hs-type">A2CStepState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386399"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span></span><span>
</span><span id="line-112"></span><span id="initPieceState"><span class="annot"><span class="annottext">initPieceState :: forall (dev :: (DeviceType, Nat)).
KnownDevice dev =&gt;
Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
-&gt; Path [Note SPitch] [Edge SPitch]
-&gt; HList (ModelTensors dev)
-&gt; Either (A2CStepState dev) QType
</span><a href="RL.A2C.html#initPieceState"><span class="hs-identifier hs-var hs-var">initPieceState</span></a></span></span><span> </span><span id="local-6989586621679386887"><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
</span><a href="#local-6989586621679386887"><span class="hs-identifier hs-var">eval</span></a></span></span><span> </span><span id="local-6989586621679386888"><span class="annot"><span class="annottext">Path [Note SPitch] [Edge SPitch]
</span><a href="#local-6989586621679386888"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span id="local-6989586621679386889"><span class="annot"><span class="annottext">HList (ModelTensors dev)
</span><a href="#local-6989586621679386889"><span class="hs-identifier hs-var">z0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-114"></span><span>    </span><span id="local-6989586621679386890"><span class="annot"><span class="annottext">state :: GreedyState (Edges SPitch) [Edge SPitch] (Notes SPitch) op
</span><a href="#local-6989586621679386890"><span class="hs-identifier hs-var hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
-&gt; Path [Note SPitch] [Edge SPitch]
-&gt; GreedyState (Edges SPitch) [Edge SPitch] (Notes SPitch) op
forall tr tr' slc slc' h v op.
Eval tr tr' slc slc' h v
-&gt; Path slc' tr' -&gt; GreedyState tr tr' slc op
</span><span class="hs-identifier hs-var">initParseState</span></span><span> </span><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
</span><a href="#local-6989586621679386887"><span class="hs-identifier hs-var">eval</span></a></span><span> </span><span class="annot"><span class="annottext">Path [Note SPitch] [Edge SPitch]
</span><a href="#local-6989586621679386888"><span class="hs-identifier hs-var">input</span></a></span><span>
</span><span id="line-115"></span><span>    </span><span id="local-6989586621679386892"><span class="annot"><span class="annottext">actions :: [PVAction]
</span><a href="#local-6989586621679386892"><span class="hs-identifier hs-var hs-var">actions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [PVAction] -&gt; [PVAction]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">200</span></span><span> </span><span class="annot"><span class="annottext">([PVAction] -&gt; [PVAction]) -&gt; [PVAction] -&gt; [PVAction]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
-&gt; GreedyState
     (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; [PVAction]
forall {k} (m :: k) tr tr' slc slc' s f h.
Eval tr tr' slc slc' h (Leftmost s f h)
-&gt; GreedyState tr tr' slc (Leftmost s f h) -&gt; [Action slc tr s f h]
</span><span class="hs-identifier hs-var">getActions</span></span><span> </span><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
</span><a href="#local-6989586621679386887"><span class="hs-identifier hs-var">eval</span></a></span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
forall {op}.
GreedyState (Edges SPitch) [Edge SPitch] (Notes SPitch) op
</span><a href="#local-6989586621679386890"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-116"></span><span>   </span><span class="hs-keyword">in</span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[PVAction]
</span><a href="#local-6989586621679386892"><span class="hs-identifier hs-var">actions</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-118"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QType -&gt; Either (A2CStepState dev) QType
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">QType
</span><a href="RL.ModelTypes.html#inf"><span class="hs-identifier hs-var">inf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679386896"><span class="annot"><span class="annottext">PVAction
</span><a href="#local-6989586621679386896"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679386897"><span class="annot"><span class="annottext">[PVAction]
</span><a href="#local-6989586621679386897"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">A2CStepState dev -&gt; Either (A2CStepState dev) QType
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(A2CStepState dev -&gt; Either (A2CStepState dev) QType)
-&gt; A2CStepState dev -&gt; Either (A2CStepState dev) QType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HList (ModelTensors dev)
-&gt; HList (ModelTensors dev)
-&gt; QType
-&gt; QType
-&gt; GreedyState
     (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; NonEmpty PVAction
-&gt; A2CStepState dev
forall (dev :: (DeviceType, Nat)).
HList (ModelTensors dev)
-&gt; HList (ModelTensors dev)
-&gt; QType
-&gt; QType
-&gt; GreedyState
     (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; NonEmpty PVAction
-&gt; A2CStepState dev
</span><a href="RL.A2C.html#A2CStepState"><span class="hs-identifier hs-var">A2CStepState</span></a></span><span> </span><span class="annot"><span class="annottext">HList (ModelTensors dev)
</span><a href="#local-6989586621679386889"><span class="hs-identifier hs-var">z0</span></a></span><span> </span><span class="annot"><span class="annottext">HList (ModelTensors dev)
</span><a href="#local-6989586621679386889"><span class="hs-identifier hs-var">z0</span></a></span><span> </span><span class="annot"><span class="annottext">QType
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">QType
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
forall {op}.
GreedyState (Edges SPitch) [Edge SPitch] (Notes SPitch) op
</span><a href="#local-6989586621679386890"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PVAction
</span><a href="#local-6989586621679386896"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">PVAction -&gt; [PVAction] -&gt; NonEmpty PVAction
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">NE.:|</span></span><span> </span><span class="annot"><span class="annottext">[PVAction]
</span><a href="#local-6989586621679386897"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="annot"><a href="RL.A2C.html#pieceStep"><span class="hs-identifier hs-type">pieceStep</span></a></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679386433"><span class="annot"><a href="#local-6989586621679386433"><span class="hs-identifier hs-type">dev</span></a></span></span><span> </span><span id="local-6989586621679386437"><span class="annot"><a href="#local-6989586621679386437"><span class="hs-keyword hs-type">label</span></a></span></span><span>
</span><span id="line-123"></span><span>   </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.ModelTypes.html#IsValidDevice"><span class="hs-identifier hs-type">IsValidDevice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386433"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eval</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Edges</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Edge</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Notes</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Note</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Spread</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PVLeftmost</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rand.IOGenM</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rand.StdGen</span></span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#PVRewardFn"><span class="hs-identifier hs-type">PVRewardFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386437"><span class="hs-keyword hs-type">label</span></a></span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679386437"><span class="hs-keyword hs-type">label</span></a></span><span>
</span><span id="line-128"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span>
</span><span id="line-129"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ learning rate</span></span><span>
</span><span id="line-130"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span>
</span><span id="line-131"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ temperature</span></span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-133"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ iteration</span></span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.A2C.html#A2CState"><span class="hs-identifier hs-type">A2CState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386433"><span class="hs-identifier hs-type">dev</span></a></span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.A2C.html#A2CStepState"><span class="hs-identifier hs-type">A2CStepState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386433"><span class="hs-identifier hs-type">dev</span></a></span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ET.ExceptT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.A2C.html#A2CState"><span class="hs-identifier hs-type">A2CState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386433"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.A2C.html#A2CStepState"><span class="hs-identifier hs-type">A2CStepState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386433"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span id="pieceStep"><span class="annot"><span class="annottext">pieceStep :: forall (dev :: (DeviceType, Nat)) label.
IsValidDevice dev =&gt;
Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
-&gt; IOGenM StdGen
-&gt; PVRewardFn label
-&gt; label
-&gt; QType
-&gt; QType
-&gt; Int
-&gt; A2CState dev
-&gt; A2CStepState dev
-&gt; ExceptT
     String IO (A2CState dev, Either (A2CStepState dev) QType, QType)
</span><a href="RL.A2C.html#pieceStep"><span class="hs-identifier hs-var hs-var">pieceStep</span></a></span></span><span> </span><span id="local-6989586621679387232"><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
</span><a href="#local-6989586621679387232"><span class="hs-identifier hs-var">eval</span></a></span></span><span> </span><span id="local-6989586621679387233"><span class="annot"><span class="annottext">IOGenM StdGen
</span><a href="#local-6989586621679387233"><span class="hs-identifier hs-var">gen</span></a></span></span><span> </span><span id="local-6989586621679387234"><span class="annot"><span class="annottext">PVRewardFn label
</span><a href="#local-6989586621679387234"><span class="hs-identifier hs-var">fReward</span></a></span></span><span> </span><span id="local-6989586621679387235"><span class="annot"><span class="annottext">label
</span><a href="#local-6989586621679387235"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span id="local-6989586621679387236"><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679387236"><span class="hs-identifier hs-var">lr</span></a></span></span><span> </span><span id="local-6989586621679387237"><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679387237"><span class="hs-identifier hs-var">temp</span></a></span></span><span> </span><span id="local-6989586621679387238"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679387238"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.A2C.html#A2CState"><span class="hs-identifier hs-type">A2CState</span></a></span><span> </span><span id="local-6989586621679387239"><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679387239"><span class="hs-identifier hs-var">actor</span></a></span></span><span> </span><span id="local-6989586621679387240"><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679387240"><span class="hs-identifier hs-var">critic</span></a></span></span><span> </span><span id="local-6989586621679387241"><span class="annot"><span class="annottext">GD
</span><a href="#local-6989586621679387241"><span class="hs-identifier hs-var">opta</span></a></span></span><span> </span><span id="local-6989586621679387242"><span class="annot"><span class="annottext">GD
</span><a href="#local-6989586621679387242"><span class="hs-identifier hs-var">optc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.A2C.html#A2CStepState"><span class="hs-identifier hs-type">A2CStepState</span></a></span><span> </span><span id="local-6989586621679387243"><span class="annot"><span class="annottext">HList (ModelTensors dev)
</span><a href="#local-6989586621679387243"><span class="hs-identifier hs-var">zV</span></a></span></span><span> </span><span id="local-6989586621679387244"><span class="annot"><span class="annottext">HList (ModelTensors dev)
</span><a href="#local-6989586621679387244"><span class="hs-identifier hs-var">zP</span></a></span></span><span> </span><span id="local-6989586621679387245"><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679387245"><span class="hs-identifier hs-var">intensity</span></a></span></span><span> </span><span id="local-6989586621679387246"><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679387246"><span class="hs-identifier hs-var">reward</span></a></span></span><span> </span><span id="local-6989586621679387247"><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><a href="#local-6989586621679387247"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span id="local-6989586621679387248"><span class="annot"><span class="annottext">NonEmpty PVAction
</span><a href="#local-6989586621679387248"><span class="hs-identifier hs-var">actions</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-comment">-- EitherT String IO</span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-comment">-- preparation: list actions, compute policy</span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-comment">-- TODO: smarter cap than taking 200 actions</span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-comment">-- encodings = encodeStep state &lt;$&gt; actions</span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-comment">-- policy = T.softmax (T.Dim 0) $ T.cat (T.Dim 0) $ TT.toDynamic . forwardPolicy actor &lt;$&gt; encodings</span><span>
</span><span id="line-144"></span><span>    </span><span id="local-6989586621679387255"><span class="annot"><span class="annottext">policy :: Tensor
</span><a href="#local-6989586621679387255"><span class="hs-identifier hs-var hs-var hs-var">policy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType -&gt; Tensor -&gt; Tensor
forall a. Scalar a =&gt; a -&gt; Tensor -&gt; Tensor
</span><span class="hs-identifier hs-var">T.pow</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QType
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">QType -&gt; QType -&gt; QType
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679387237"><span class="hs-identifier hs-var">temp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Tensor -&gt; Tensor) -&gt; Tensor -&gt; Tensor
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; NonEmpty PVAction
-&gt; (forall (n :: Nat). KnownNat n =&gt; QEncoding dev '[n] -&gt; Tensor)
-&gt; Tensor
forall (dev :: (DeviceType, Nat)) r.
KnownDevice dev =&gt;
GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; NonEmpty PVAction
-&gt; (forall (n :: Nat). KnownNat n =&gt; QEncoding dev '[n] -&gt; r)
-&gt; r
</span><a href="RL.Encoding.html#withBatchedEncoding"><span class="hs-identifier hs-var">withBatchedEncoding</span></a></span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><a href="#local-6989586621679387247"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty PVAction
</span><a href="#local-6989586621679387248"><span class="hs-identifier hs-var">actions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QModel dev -&gt; QEncoding dev '[n] -&gt; Tensor
forall (dev :: (DeviceType, Nat)) (batchSize :: Nat).
(IsValidDevice dev, KnownNat batchSize) =&gt;
QModel dev -&gt; QEncoding dev '[batchSize] -&gt; Tensor
</span><a href="RL.Model.html#runBatchedPolicy"><span class="hs-identifier hs-var">runBatchedPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679387239"><span class="hs-identifier hs-var">actor</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-comment">-- choose action according to policy</span><span>
</span><span id="line-146"></span><span>  </span><span id="local-6989586621679387270"><span class="annot"><a href="#local-6989586621679387270"><span class="hs-identifier hs-var">actionIndex</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Int -&gt; ExceptT String IO Int
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT String m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(IO Int -&gt; ExceptT String IO Int)
-&gt; IO Int -&gt; ExceptT String IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Vector QType -&gt; IOGenM StdGen -&gt; IO Int
forall g (m :: * -&gt; *) (v :: * -&gt; *).
(StatefulGen g m, Vector v QType) =&gt;
v QType -&gt; g -&gt; m Int
</span><span class="hs-identifier hs-var">categorical</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[QType] -&gt; Vector QType
forall a. [a] -&gt; Vector a
</span><span class="hs-identifier hs-var">V.fromList</span></span><span> </span><span class="annot"><span class="annottext">([QType] -&gt; Vector QType) -&gt; [QType] -&gt; Vector QType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tensor -&gt; [QType]
forall a. TensorLike a =&gt; Tensor -&gt; a
</span><span class="hs-identifier hs-var">T.asValue</span></span><span> </span><span class="annot"><span class="annottext">(Tensor -&gt; [QType]) -&gt; Tensor -&gt; [QType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; Tensor -&gt; Tensor
</span><span class="hs-identifier hs-var">T.toDType</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><span class="hs-identifier hs-var">T.Double</span></span><span> </span><span class="annot"><span class="annottext">Tensor
</span><a href="#local-6989586621679387255"><span class="hs-identifier hs-var">policy</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IOGenM StdGen
</span><a href="#local-6989586621679387233"><span class="hs-identifier hs-var">gen</span></a></span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679387276"><span class="annot"><a href="#local-6989586621679387276"><span class="hs-identifier hs-var hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty PVAction
</span><a href="#local-6989586621679387248"><span class="hs-identifier hs-var">actions</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty PVAction -&gt; Int -&gt; PVAction
forall a. HasCallStack =&gt; NonEmpty a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">NE.!!</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679387270"><span class="hs-identifier hs-var">actionIndex</span></a></span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-comment">-- apply action</span><span>
</span><span id="line-149"></span><span>  </span><span id="local-6989586621679387278"><span class="annot"><a href="#local-6989586621679387278"><span class="hs-identifier hs-var">state'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ET.except</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">applyAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679387247"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679387276"><span class="hs-identifier hs-type">action</span></a></span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679387281"><span class="annot"><a href="#local-6989586621679387281"><span class="hs-identifier hs-var hs-var">actions'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either
  (GreedyState
     (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch))
  (Edges SPitch, [PVLeftmost SPitch])
</span><a href="#local-6989586621679387278"><span class="hs-identifier hs-var">state'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-151"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679387282"><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><a href="#local-6989586621679387282"><span class="hs-identifier hs-var">newState</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[PVAction] -&gt; Maybe (NonEmpty PVAction)
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><span class="hs-identifier hs-var">NE.nonEmpty</span></span><span> </span><span class="annot"><span class="annottext">([PVAction] -&gt; Maybe (NonEmpty PVAction))
-&gt; [PVAction] -&gt; Maybe (NonEmpty PVAction)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [PVAction] -&gt; [PVAction]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">200</span></span><span> </span><span class="annot"><span class="annottext">([PVAction] -&gt; [PVAction]) -&gt; [PVAction] -&gt; [PVAction]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
-&gt; GreedyState
     (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; [PVAction]
forall {k} (m :: k) tr tr' slc slc' s f h.
Eval tr tr' slc slc' h (Leftmost s f h)
-&gt; GreedyState tr tr' slc (Leftmost s f h) -&gt; [Action slc tr s f h]
</span><span class="hs-identifier hs-var">getActions</span></span><span> </span><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
</span><a href="#local-6989586621679387232"><span class="hs-identifier hs-var">eval</span></a></span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><a href="#local-6989586621679387282"><span class="hs-identifier hs-var">newState</span></a></span><span>
</span><span id="line-152"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">(Edges SPitch, [PVLeftmost SPitch])
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (NonEmpty PVAction)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-comment">-- compute A2C update</span><span>
</span><span id="line-154"></span><span>  </span><span id="local-6989586621679387284"><span class="annot"><a href="#local-6989586621679387284"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">lift</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621679387234"><span class="hs-identifier hs-type">fReward</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679387278"><span class="hs-identifier hs-type">state'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679387281"><span class="hs-identifier hs-type">actions'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679387276"><span class="hs-identifier hs-type">action</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679387235"><span class="hs-identifier hs-type">len</span></a></span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679387294"><span class="annot"><a href="#local-6989586621679387294"><span class="hs-identifier hs-var hs-var">vS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QModel dev -&gt; StateEncoding dev -&gt; Tensor dev 'Double '[1]
forall (dev :: (DeviceType, Nat)).
IsValidDevice dev =&gt;
QModel dev -&gt; StateEncoding dev -&gt; QTensor dev '[1]
</span><a href="RL.Model.html#forwardValue"><span class="hs-identifier hs-var">forwardValue</span></a></span><span> </span><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679387240"><span class="hs-identifier hs-var">critic</span></a></span><span> </span><span class="annot"><span class="annottext">(StateEncoding dev -&gt; Tensor dev 'Double '[1])
-&gt; StateEncoding dev -&gt; Tensor dev 'Double '[1]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; StateEncoding dev
forall (dev :: (DeviceType, Nat)).
KnownDevice dev =&gt;
GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; StateEncoding dev
</span><a href="RL.Encoding.html#encodePVState"><span class="hs-identifier hs-var">encodePVState</span></a></span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><a href="#local-6989586621679387247"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-156"></span><span>      </span><span id="local-6989586621679387308"><span class="annot"><a href="#local-6989586621679387308"><span class="hs-identifier hs-var hs-var">vS'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either
  (GreedyState
     (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch))
  (Edges SPitch, [PVLeftmost SPitch])
</span><a href="#local-6989586621679387278"><span class="hs-identifier hs-var">state'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-157"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679387309"><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><a href="#local-6989586621679387309"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QModel dev -&gt; StateEncoding dev -&gt; Tensor dev 'Double '[1]
forall (dev :: (DeviceType, Nat)).
IsValidDevice dev =&gt;
QModel dev -&gt; StateEncoding dev -&gt; QTensor dev '[1]
</span><a href="RL.Model.html#forwardValue"><span class="hs-identifier hs-var">forwardValue</span></a></span><span> </span><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679387240"><span class="hs-identifier hs-var">critic</span></a></span><span> </span><span class="annot"><span class="annottext">(StateEncoding dev -&gt; Tensor dev 'Double '[1])
-&gt; StateEncoding dev -&gt; Tensor dev 'Double '[1]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; StateEncoding dev
forall (dev :: (DeviceType, Nat)).
KnownDevice dev =&gt;
GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; StateEncoding dev
</span><a href="RL.Encoding.html#encodePVState"><span class="hs-identifier hs-var">encodePVState</span></a></span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><a href="#local-6989586621679387309"><span class="hs-identifier hs-var">s'</span></a></span><span>
</span><span id="line-158"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">(Edges SPitch, [PVLeftmost SPitch])
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Tensor dev 'Double '[1]
</span><span class="hs-number">0</span></span><span>
</span><span id="line-159"></span><span>      </span><span id="local-6989586621679387316"><span class="annot"><a href="#local-6989586621679387316"><span class="hs-identifier hs-var hs-var">delta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType -&gt; Tensor dev 'Double '[] -&gt; Tensor dev 'Double '[]
forall a (shape :: [Nat]) (dtype :: DType)
       (device :: (DeviceType, Nat)).
Scalar a =&gt;
a -&gt; Tensor device dtype shape -&gt; Tensor device dtype shape
</span><span class="hs-identifier hs-var">TT.addScalar</span></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679387284"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">(Tensor dev 'Double '[] -&gt; Tensor dev 'Double '[])
-&gt; Tensor dev 'Double '[] -&gt; Tensor dev 'Double '[]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tensor dev 'Double '[1] -&gt; Tensor dev 'Double '[]
forall (shape :: [Nat]) (shape' :: [Nat]) (dtype :: DType)
       (device :: (DeviceType, Nat)).
(shape' ~ SqueezeAll shape) =&gt;
Tensor device dtype shape -&gt; Tensor device dtype shape'
</span><span class="hs-identifier hs-var">TT.squeezeAll</span></span><span> </span><span class="annot"><span class="annottext">(Tensor dev 'Double '[1] -&gt; Tensor dev 'Double '[])
-&gt; Tensor dev 'Double '[1] -&gt; Tensor dev 'Double '[]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QType -&gt; Tensor dev 'Double '[1] -&gt; Tensor dev 'Double '[1]
forall a (shape :: [Nat]) (dtype :: DType)
       (device :: (DeviceType, Nat)).
Scalar a =&gt;
a -&gt; Tensor device dtype shape -&gt; Tensor device dtype shape
</span><span class="hs-identifier hs-var">TT.mulScalar</span></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="RL.A2C.html#gamma"><span class="hs-identifier hs-var">gamma</span></a></span><span> </span><span class="annot"><span class="annottext">Tensor dev 'Double '[1]
</span><a href="#local-6989586621679387308"><span class="hs-identifier hs-var">vS'</span></a></span><span> </span><span class="annot"><span class="annottext">Tensor dev 'Double '[1]
-&gt; Tensor dev 'Double '[1] -&gt; Tensor dev 'Double '[1]
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Tensor dev 'Double '[1]
</span><a href="#local-6989586621679387294"><span class="hs-identifier hs-var">vS</span></a></span><span>
</span><span id="line-160"></span><span>      </span><span id="local-6989586621679391533"><span class="annot"><a href="#local-6989586621679391533"><span class="hs-identifier hs-var hs-var">gradV</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tensor dev 'Double '[]
-&gt; HList
     '[Parameter dev 'Double '[8, 1, 1, 1], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 13, 5],
       Parameter dev 'Double '[8, 13, 5],
       Parameter dev 'Double '[8, 2, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 2, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 1, 1, 1], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 1, 1, 1], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[5],
       Parameter dev 'Double '[5], Parameter dev 'Double '[5],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8],
       Parameter dev 'Double '[1, 8], Parameter dev 'Double '[1],
       Parameter dev 'Double '[8, 8], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8],
       Parameter dev 'Double '[1, 8], Parameter dev 'Double '[1]]
-&gt; HList
     '[Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 13, 5], Tensor dev 'Double '[8, 13, 5],
       Tensor dev 'Double '[8, 2, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 2, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[5],
       Tensor dev 'Double '[5], Tensor dev 'Double '[5],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8],
       Tensor dev 'Double '[1, 8], Tensor dev 'Double '[1],
       Tensor dev 'Double '[8, 8], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8],
       Tensor dev 'Double '[1, 8], Tensor dev 'Double '[1]]
forall a b (dtype :: DType) (device :: (DeviceType, Nat)).
HasGrad a b =&gt;
Tensor device dtype '[] -&gt; a -&gt; b
forall (dtype :: DType) (device :: (DeviceType, Nat)).
Tensor device dtype '[]
-&gt; HList
     '[Parameter dev 'Double '[8, 1, 1, 1], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 13, 5],
       Parameter dev 'Double '[8, 13, 5],
       Parameter dev 'Double '[8, 2, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 2, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 1, 1, 1], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 1, 1, 1], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[5],
       Parameter dev 'Double '[5], Parameter dev 'Double '[5],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8],
       Parameter dev 'Double '[1, 8], Parameter dev 'Double '[1],
       Parameter dev 'Double '[8, 8], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8],
       Parameter dev 'Double '[1, 8], Parameter dev 'Double '[1]]
-&gt; HList
     '[Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 13, 5], Tensor dev 'Double '[8, 13, 5],
       Tensor dev 'Double '[8, 2, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 2, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[5],
       Tensor dev 'Double '[5], Tensor dev 'Double '[5],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8],
       Tensor dev 'Double '[1, 8], Tensor dev 'Double '[1],
       Tensor dev 'Double '[8, 8], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8],
       Tensor dev 'Double '[1, 8], Tensor dev 'Double '[1]]
</span><span class="hs-identifier hs-var">TT.grad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tensor dev 'Double '[1] -&gt; Tensor dev 'Double '[]
forall (shape :: [Nat]) (shape' :: [Nat]) (dtype :: DType)
       (device :: (DeviceType, Nat)).
(shape' ~ SqueezeAll shape) =&gt;
Tensor device dtype shape -&gt; Tensor device dtype shape'
</span><span class="hs-identifier hs-var">TT.squeezeAll</span></span><span> </span><span class="annot"><span class="annottext">Tensor dev 'Double '[1]
</span><a href="#local-6989586621679387294"><span class="hs-identifier hs-var">vS</span></a></span><span> </span><span class="annot"><span class="annottext">Tensor dev 'Double '[]
-&gt; Tensor dev 'Double '[] -&gt; Tensor dev 'Double '[]
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">QModel dev -&gt; Tensor dev 'Double '[]
forall (dev :: (DeviceType, Nat)) (ps :: [*]).
(IsValidDevice dev, ps ~ Parameters (QModel dev)) =&gt;
QModel dev -&gt; QTensor dev '[]
</span><a href="RL.Model.html#fakeLoss"><span class="hs-identifier hs-var">fakeLoss</span></a></span><span> </span><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679387240"><span class="hs-identifier hs-var">critic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QModel dev -&gt; HList (Parameters (QModel dev))
forall f. Parameterized f =&gt; f -&gt; HList (Parameters f)
</span><span class="hs-identifier hs-var">TT.flattenParameters</span></span><span> </span><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679387240"><span class="hs-identifier hs-var">critic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>      </span><span id="local-6989586621679391539"><span class="annot"><a href="#local-6989586621679391539"><span class="hs-identifier hs-var hs-var">zV'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType
-&gt; QType
-&gt; HList (ModelTensors dev)
-&gt; HList (ModelTensors dev)
-&gt; HList (ModelTensors dev)
forall (dev :: (DeviceType, Nat)).
KnownDevice dev =&gt;
QType
-&gt; QType
-&gt; HList (ModelTensors dev)
-&gt; HList (ModelTensors dev)
-&gt; HList (ModelTensors dev)
</span><a href="RL.A2CHelpers.html#updateEligCritic"><span class="hs-identifier hs-var">updateEligCritic</span></a></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="RL.A2C.html#gamma"><span class="hs-identifier hs-var">gamma</span></a></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="RL.A2C.html#lambdaV"><span class="hs-identifier hs-var">lambdaV</span></a></span><span> </span><span class="annot"><span class="annottext">HList (ModelTensors dev)
</span><a href="#local-6989586621679387243"><span class="hs-identifier hs-var">zV</span></a></span><span> </span><span class="annot"><span class="annottext">HList
  '[Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 13, 5], Tensor dev 'Double '[8, 13, 5],
    Tensor dev 'Double '[8, 2, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 2, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[5],
    Tensor dev 'Double '[5], Tensor dev 'Double '[5],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8],
    Tensor dev 'Double '[1, 8], Tensor dev 'Double '[1],
    Tensor dev 'Double '[8, 8], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8],
    Tensor dev 'Double '[1, 8], Tensor dev 'Double '[1]]
HList (ModelTensors dev)
</span><a href="#local-6989586621679391533"><span class="hs-identifier hs-var">gradV</span></a></span><span>
</span><span id="line-162"></span><span>      </span><span class="annot"><a href="#local-6989586621679391541"><span class="hs-identifier hs-type">actionLogProb</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QTensor"><span class="hs-identifier hs-type">QTensor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386433"><span class="hs-identifier hs-type">dev</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-163"></span><span>      </span><span id="local-6989586621679391541"><span class="annot"><a href="#local-6989586621679391541"><span class="hs-identifier hs-var hs-var">actionLogProb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tensor dev 'Double '[] -&gt; Tensor dev 'Double '[]
forall (shape :: [Nat]) (dtype :: DType)
       (device :: (DeviceType, Nat)).
Tensor device dtype shape -&gt; Tensor device dtype shape
</span><span class="hs-identifier hs-var">TT.log</span></span><span> </span><span class="annot"><span class="annottext">(Tensor dev 'Double '[] -&gt; Tensor dev 'Double '[])
-&gt; Tensor dev 'Double '[] -&gt; Tensor dev 'Double '[]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tensor -&gt; Tensor dev 'Double '[]
forall (device :: (DeviceType, Nat)) (dtype :: DType)
       (shape :: [Nat]).
Tensor -&gt; Tensor device dtype shape
</span><span class="hs-identifier hs-var">TT.UnsafeMkTensor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tensor -&gt; Tensor
</span><span class="hs-identifier hs-var">T.squeezeAll</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tensor
</span><a href="#local-6989586621679387255"><span class="hs-identifier hs-var">policy</span></a></span><span> </span><span class="annot"><span class="annottext">Tensor -&gt; Int -&gt; Tensor
forall a. TensorIndex a =&gt; Tensor -&gt; a -&gt; Tensor
</span><span class="hs-operator hs-var">T.!</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679387270"><span class="hs-identifier hs-var">actionIndex</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>      </span><span id="local-6989586621679395745"><span class="annot"><a href="#local-6989586621679395745"><span class="hs-identifier hs-var hs-var">gradP</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tensor dev 'Double '[]
-&gt; HList
     '[Parameter dev 'Double '[8, 1, 1, 1], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 13, 5],
       Parameter dev 'Double '[8, 13, 5],
       Parameter dev 'Double '[8, 2, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 2, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 1, 1, 1], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 1, 1, 1], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[5],
       Parameter dev 'Double '[5], Parameter dev 'Double '[5],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8],
       Parameter dev 'Double '[1, 8], Parameter dev 'Double '[1],
       Parameter dev 'Double '[8, 8], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8],
       Parameter dev 'Double '[1, 8], Parameter dev 'Double '[1]]
-&gt; HList
     '[Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 13, 5], Tensor dev 'Double '[8, 13, 5],
       Tensor dev 'Double '[8, 2, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 2, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[5],
       Tensor dev 'Double '[5], Tensor dev 'Double '[5],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8],
       Tensor dev 'Double '[1, 8], Tensor dev 'Double '[1],
       Tensor dev 'Double '[8, 8], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8],
       Tensor dev 'Double '[1, 8], Tensor dev 'Double '[1]]
forall a b (dtype :: DType) (device :: (DeviceType, Nat)).
HasGrad a b =&gt;
Tensor device dtype '[] -&gt; a -&gt; b
forall (dtype :: DType) (device :: (DeviceType, Nat)).
Tensor device dtype '[]
-&gt; HList
     '[Parameter dev 'Double '[8, 1, 1, 1], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 13, 5],
       Parameter dev 'Double '[8, 13, 5],
       Parameter dev 'Double '[8, 2, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 2, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 1, 1, 1], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 1, 1, 1], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8, 8, 13, 5],
       Parameter dev 'Double '[8], Parameter dev 'Double '[5],
       Parameter dev 'Double '[5], Parameter dev 'Double '[5],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8, 8, 13, 5], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8],
       Parameter dev 'Double '[1, 8], Parameter dev 'Double '[1],
       Parameter dev 'Double '[8, 8], Parameter dev 'Double '[8],
       Parameter dev 'Double '[8], Parameter dev 'Double '[8],
       Parameter dev 'Double '[1, 8], Parameter dev 'Double '[1]]
-&gt; HList
     '[Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 13, 5], Tensor dev 'Double '[8, 13, 5],
       Tensor dev 'Double '[8, 2, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 2, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
       Tensor dev 'Double '[8], Tensor dev 'Double '[5],
       Tensor dev 'Double '[5], Tensor dev 'Double '[5],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8],
       Tensor dev 'Double '[1, 8], Tensor dev 'Double '[1],
       Tensor dev 'Double '[8, 8], Tensor dev 'Double '[8],
       Tensor dev 'Double '[8], Tensor dev 'Double '[8],
       Tensor dev 'Double '[1, 8], Tensor dev 'Double '[1]]
</span><span class="hs-identifier hs-var">TT.grad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tensor dev 'Double '[]
</span><a href="#local-6989586621679391541"><span class="hs-identifier hs-var">actionLogProb</span></a></span><span> </span><span class="annot"><span class="annottext">Tensor dev 'Double '[]
-&gt; Tensor dev 'Double '[] -&gt; Tensor dev 'Double '[]
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">QModel dev -&gt; Tensor dev 'Double '[]
forall (dev :: (DeviceType, Nat)) (ps :: [*]).
(IsValidDevice dev, ps ~ Parameters (QModel dev)) =&gt;
QModel dev -&gt; QTensor dev '[]
</span><a href="RL.Model.html#fakeLoss"><span class="hs-identifier hs-var">fakeLoss</span></a></span><span> </span><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679387239"><span class="hs-identifier hs-var">actor</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QModel dev -&gt; HList (Parameters (QModel dev))
forall f. Parameterized f =&gt; f -&gt; HList (Parameters f)
</span><span class="hs-identifier hs-var">TT.flattenParameters</span></span><span> </span><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679387239"><span class="hs-identifier hs-var">actor</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>      </span><span id="local-6989586621679395747"><span class="annot"><a href="#local-6989586621679395747"><span class="hs-identifier hs-var hs-var">zP'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType
-&gt; QType
-&gt; QType
-&gt; HList (ModelTensors dev)
-&gt; HList (ModelTensors dev)
-&gt; HList (ModelTensors dev)
forall (dev :: (DeviceType, Nat)).
KnownDevice dev =&gt;
QType
-&gt; QType
-&gt; QType
-&gt; HList (ModelTensors dev)
-&gt; HList (ModelTensors dev)
-&gt; HList (ModelTensors dev)
</span><a href="RL.A2CHelpers.html#updateEligActor"><span class="hs-identifier hs-var">updateEligActor</span></a></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="RL.A2C.html#gamma"><span class="hs-identifier hs-var">gamma</span></a></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="RL.A2C.html#lambdaP"><span class="hs-identifier hs-var">lambdaP</span></a></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679387245"><span class="hs-identifier hs-var">intensity</span></a></span><span> </span><span class="annot"><span class="annottext">HList (ModelTensors dev)
</span><a href="#local-6989586621679387244"><span class="hs-identifier hs-var">zP</span></a></span><span> </span><span class="annot"><span class="annottext">HList
  '[Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 13, 5], Tensor dev 'Double '[8, 13, 5],
    Tensor dev 'Double '[8, 2, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 2, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[5],
    Tensor dev 'Double '[5], Tensor dev 'Double '[5],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8],
    Tensor dev 'Double '[1, 8], Tensor dev 'Double '[1],
    Tensor dev 'Double '[8, 8], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8],
    Tensor dev 'Double '[1, 8], Tensor dev 'Double '[1]]
HList (ModelTensors dev)
</span><a href="#local-6989586621679395745"><span class="hs-identifier hs-var">gradP</span></a></span><span>
</span><span id="line-166"></span><span>      </span><span id="local-6989586621679395750"><span class="annot"><a href="#local-6989586621679395750"><span class="hs-identifier hs-var hs-var">intensity'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="RL.A2C.html#gamma"><span class="hs-identifier hs-var">gamma</span></a></span><span> </span><span class="annot"><span class="annottext">QType -&gt; QType -&gt; QType
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679387245"><span class="hs-identifier hs-var">intensity</span></a></span><span>
</span><span id="line-167"></span><span>      </span><span id="local-6989586621679395754"><span class="annot"><a href="#local-6989586621679395754"><span class="hs-identifier hs-var hs-var">learningRate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType -&gt; Tensor dev 'Double '[]
forall (dev :: (DeviceType, Nat)).
KnownDevice dev =&gt;
QType -&gt; QTensor dev '[]
</span><a href="RL.ModelTypes.html#toQTensor"><span class="hs-identifier hs-var">toQTensor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QType -&gt; QType
forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679387236"><span class="hs-identifier hs-var">lr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679395756"><span class="annot"><a href="#local-6989586621679395756"><span class="hs-identifier hs-var">actor'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395757"><span class="annot"><a href="#local-6989586621679395757"><span class="hs-identifier hs-var">opta'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">lift</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.runStep'</span></span><span> </span><span class="annot"><a href="#local-6989586621679387239"><span class="hs-identifier hs-type">actor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679387241"><span class="hs-identifier hs-type">opta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679395754"><span class="hs-identifier hs-type">learningRate</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="RL.A2CHelpers.html#mulModelTensors"><span class="hs-identifier hs-type">mulModelTensors</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679387316"><span class="hs-identifier hs-type">delta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679395747"><span class="hs-identifier hs-type">zP'</span></a></span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679395760"><span class="annot"><a href="#local-6989586621679395760"><span class="hs-identifier hs-var">critic'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395761"><span class="annot"><a href="#local-6989586621679395761"><span class="hs-identifier hs-var">optc'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">lift</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.runStep'</span></span><span> </span><span class="annot"><a href="#local-6989586621679387240"><span class="hs-identifier hs-type">critic</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679387242"><span class="hs-identifier hs-type">optc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679395754"><span class="hs-identifier hs-type">learningRate</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="RL.A2CHelpers.html#mulModelTensors"><span class="hs-identifier hs-type">mulModelTensors</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679387316"><span class="hs-identifier hs-type">delta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679391539"><span class="hs-identifier hs-type">zV'</span></a></span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679395765"><span class="annot"><a href="#local-6989586621679395765"><span class="hs-identifier hs-var hs-var">loss'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tensor -&gt; QType
forall a. TensorLike a =&gt; Tensor -&gt; a
</span><span class="hs-identifier hs-var">T.asValue</span></span><span> </span><span class="annot"><span class="annottext">(Tensor -&gt; QType) -&gt; Tensor -&gt; QType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tensor dev 'Double '[] -&gt; Tensor
forall t. Unnamed t =&gt; t -&gt; Tensor
</span><span class="hs-identifier hs-var">TT.toDynamic</span></span><span> </span><span class="annot"><span class="annottext">Tensor dev 'Double '[]
</span><a href="#local-6989586621679387316"><span class="hs-identifier hs-var">delta</span></a></span><span>
</span><span id="line-171"></span><span>      </span><span id="local-6989586621679395768"><span class="annot"><a href="#local-6989586621679395768"><span class="hs-identifier hs-var hs-var">reward'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679387246"><span class="hs-identifier hs-var">reward</span></a></span><span> </span><span class="annot"><span class="annottext">QType -&gt; QType -&gt; QType
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679387284"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679395769"><span class="annot"><a href="#local-6989586621679395769"><span class="hs-identifier hs-var hs-var">pieceState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Either
  (GreedyState
     (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch))
  (Edges SPitch, [PVLeftmost SPitch])
</span><a href="#local-6989586621679387278"><span class="hs-identifier hs-var">state'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (NonEmpty PVAction)
</span><a href="#local-6989586621679387281"><span class="hs-identifier hs-var">actions'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-173"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679395770"><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><a href="#local-6989586621679395770"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679395771"><span class="annot"><span class="annottext">NonEmpty PVAction
</span><a href="#local-6989586621679395771"><span class="hs-identifier hs-var">a'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">A2CStepState dev -&gt; Either (A2CStepState dev) QType
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(A2CStepState dev -&gt; Either (A2CStepState dev) QType)
-&gt; A2CStepState dev -&gt; Either (A2CStepState dev) QType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HList (ModelTensors dev)
-&gt; HList (ModelTensors dev)
-&gt; QType
-&gt; QType
-&gt; GreedyState
     (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; NonEmpty PVAction
-&gt; A2CStepState dev
forall (dev :: (DeviceType, Nat)).
HList (ModelTensors dev)
-&gt; HList (ModelTensors dev)
-&gt; QType
-&gt; QType
-&gt; GreedyState
     (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; NonEmpty PVAction
-&gt; A2CStepState dev
</span><a href="RL.A2C.html#A2CStepState"><span class="hs-identifier hs-var">A2CStepState</span></a></span><span> </span><span class="annot"><span class="annottext">HList
  '[Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 13, 5], Tensor dev 'Double '[8, 13, 5],
    Tensor dev 'Double '[8, 2, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 2, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[5],
    Tensor dev 'Double '[5], Tensor dev 'Double '[5],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8],
    Tensor dev 'Double '[1, 8], Tensor dev 'Double '[1],
    Tensor dev 'Double '[8, 8], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8],
    Tensor dev 'Double '[1, 8], Tensor dev 'Double '[1]]
HList (ModelTensors dev)
</span><a href="#local-6989586621679391539"><span class="hs-identifier hs-var">zV'</span></a></span><span> </span><span class="annot"><span class="annottext">HList
  '[Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 13, 5], Tensor dev 'Double '[8, 13, 5],
    Tensor dev 'Double '[8, 2, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 2, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 1, 1, 1], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8, 8, 13, 5],
    Tensor dev 'Double '[8], Tensor dev 'Double '[5],
    Tensor dev 'Double '[5], Tensor dev 'Double '[5],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8, 8, 13, 5], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8],
    Tensor dev 'Double '[1, 8], Tensor dev 'Double '[1],
    Tensor dev 'Double '[8, 8], Tensor dev 'Double '[8],
    Tensor dev 'Double '[8], Tensor dev 'Double '[8],
    Tensor dev 'Double '[1, 8], Tensor dev 'Double '[1]]
HList (ModelTensors dev)
</span><a href="#local-6989586621679395747"><span class="hs-identifier hs-var">zP'</span></a></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679395750"><span class="hs-identifier hs-var">intensity'</span></a></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679395768"><span class="hs-identifier hs-var">reward'</span></a></span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><a href="#local-6989586621679395770"><span class="hs-identifier hs-var">s'</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty PVAction
</span><a href="#local-6989586621679395771"><span class="hs-identifier hs-var">a'</span></a></span><span>
</span><span id="line-174"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679395772"><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><a href="#local-6989586621679395772"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (NonEmpty PVAction)
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-175"></span><span>          </span><span class="hs-comment">-- DT.trace (&quot;incomplete parse:\n&quot; &lt;&gt; show s') $</span><span>
</span><span id="line-176"></span><span>          </span><span class="annot"><span class="annottext">QType -&gt; Either (A2CStepState dev) QType
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679395768"><span class="hs-identifier hs-var">reward'</span></a></span><span>
</span><span id="line-177"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">(Edges SPitch, [PVLeftmost SPitch])
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (NonEmpty PVAction)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QType -&gt; Either (A2CStepState dev) QType
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679395768"><span class="hs-identifier hs-var">reward'</span></a></span><span> </span><span class="hs-comment">-- TT.toDouble (TT.squeezeAll vS) - r</span><span>
</span><span id="line-178"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.A2C.html#A2CState"><span class="hs-identifier hs-type">A2CState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679395756"><span class="hs-identifier hs-type">actor'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679395760"><span class="hs-identifier hs-type">critic'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679395757"><span class="hs-identifier hs-type">opta'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679395761"><span class="hs-identifier hs-type">optc'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679395769"><span class="hs-identifier hs-type">pieceState'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679395765"><span class="hs-identifier hs-type">loss'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span class="annot"><span class="hs-comment">-- | Run an episode</span></span><span>
</span><span id="line-181"></span><span class="annot"><a href="RL.A2C.html#runEpisode"><span class="hs-identifier hs-type">runEpisode</span></a></span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679395774"><span class="annot"><a href="#local-6989586621679395774"><span class="hs-identifier hs-type">dev</span></a></span></span><span> </span><span id="local-6989586621679395775"><span class="annot"><a href="#local-6989586621679395775"><span class="hs-keyword hs-type">label</span></a></span></span><span>
</span><span id="line-183"></span><span>   </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eval</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Edges</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Edge</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Notes</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Note</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Spread</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PVLeftmost</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rand.IOGenM</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rand.StdGen</span></span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#PVRewardFn"><span class="hs-identifier hs-type">PVRewardFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679395775"><span class="hs-keyword hs-type">label</span></a></span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Note</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Edge</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span>
</span><span id="line-190"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679395775"><span class="hs-keyword hs-type">label</span></a></span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.A2C.html#A2CState"><span class="hs-identifier hs-type">A2CState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679395774"><span class="hs-identifier hs-type">dev</span></a></span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-193"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.A2C.html#A2CState"><span class="hs-identifier hs-type">A2CState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679395774"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span id="runEpisode"><span class="annot"><span class="annottext">runEpisode :: Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
-&gt; IOGenM StdGen
-&gt; PVRewardFn label
-&gt; (QType -&gt; QType)
-&gt; (QType -&gt; QType)
-&gt; Path [Note SPitch] [Edge SPitch]
-&gt; label
-&gt; A2CState dev
-&gt; Int
-&gt; IO (Either String (A2CState dev, QType, QType))
</span><a href="RL.A2C.html#runEpisode"><span class="hs-identifier hs-var hs-var">runEpisode</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395802"><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
</span><a href="#local-6989586621679395802"><span class="hs-identifier hs-var">eval</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395803"><span class="annot"><span class="annottext">IOGenM StdGen
</span><a href="#local-6989586621679395803"><span class="hs-identifier hs-var">gen</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395804"><span class="annot"><span class="annottext">PVRewardFn label
</span><a href="#local-6989586621679395804"><span class="hs-identifier hs-var">fReward</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395805"><span class="annot"><span class="annottext">QType -&gt; QType
</span><a href="#local-6989586621679395805"><span class="hs-identifier hs-var">fLr</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395806"><span class="annot"><span class="annottext">QType -&gt; QType
</span><a href="#local-6989586621679395806"><span class="hs-identifier hs-var">fTemp</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395807"><span class="annot"><span class="annottext">Path [Note SPitch] [Edge SPitch]
</span><a href="#local-6989586621679395807"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395808"><span class="annot"><span class="annottext">label
</span><a href="#local-6989586621679395808"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395809"><span class="annot"><span class="annottext">A2CState dev
</span><a href="#local-6989586621679395809"><span class="hs-identifier hs-var">modelState</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395810"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679395810"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
-&gt; Path [Note SPitch] [Edge SPitch]
-&gt; HList (ModelTensors dev)
-&gt; Either (A2CStepState dev) QType
forall (dev :: (DeviceType, Nat)).
KnownDevice dev =&gt;
Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
-&gt; Path [Note SPitch] [Edge SPitch]
-&gt; HList (ModelTensors dev)
-&gt; Either (A2CStepState dev) QType
</span><a href="RL.A2C.html#initPieceState"><span class="hs-identifier hs-var">initPieceState</span></a></span><span> </span><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
</span><a href="#local-6989586621679395802"><span class="hs-identifier hs-var">eval</span></a></span><span> </span><span class="annot"><span class="annottext">Path [Note SPitch] [Edge SPitch]
</span><a href="#local-6989586621679395807"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="annot"><span class="annottext">HList (ModelTensors dev)
</span><a href="#local-6989586621679395811"><span class="hs-identifier hs-var">z0</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679395812"><span class="annot"><span class="annottext">A2CStepState dev
</span><a href="#local-6989586621679395812"><span class="hs-identifier hs-var">s0</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ExceptT String IO (A2CState dev, QType, QType)
-&gt; IO (Either String (A2CState dev, QType, QType))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">ET.runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT String IO (A2CState dev, QType, QType)
 -&gt; IO (Either String (A2CState dev, QType, QType)))
-&gt; ExceptT String IO (A2CState dev, QType, QType)
-&gt; IO (Either String (A2CState dev, QType, QType))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">A2CState dev
-&gt; A2CStepState dev
-&gt; List QType
-&gt; ExceptT String IO (A2CState dev, QType, QType)
forall {dev :: (DeviceType, Nat)}.
(GeluDTypeIsValid dev 'Double, RandDTypeIsValid dev 'Double,
 BasicArithmeticDTypeIsValid dev 'Double,
 SumDTypeIsValid dev 'Double, MeanDTypeValidation dev 'Double,
 StandardFloatingPointDTypeValidation dev 'Double,
 KnownDevice dev) =&gt;
A2CState dev
-&gt; A2CStepState dev
-&gt; List QType
-&gt; ExceptT String IO (A2CState dev, QType, QType)
</span><a href="#local-6989586621679395814"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">A2CState dev
</span><a href="#local-6989586621679395809"><span class="hs-identifier hs-var">modelState</span></a></span><span> </span><span class="annot"><span class="annottext">A2CStepState dev
</span><a href="#local-6989586621679395812"><span class="hs-identifier hs-var">s0</span></a></span><span> </span><span class="annot"><span class="annottext">List QType
forall a. List a
</span><span class="hs-identifier hs-var">SL.Nil</span></span><span>
</span><span id="line-197"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679395816"><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679395816"><span class="hs-identifier hs-var">reward</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either String (A2CState dev, QType, QType)
-&gt; IO (Either String (A2CState dev, QType, QType))
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either String (A2CState dev, QType, QType)
 -&gt; IO (Either String (A2CState dev, QType, QType)))
-&gt; Either String (A2CState dev, QType, QType)
-&gt; IO (Either String (A2CState dev, QType, QType))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(A2CState dev, QType, QType)
-&gt; Either String (A2CState dev, QType, QType)
forall a. a -&gt; Either String a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">A2CState dev
</span><a href="#local-6989586621679395809"><span class="hs-identifier hs-var">modelState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679395816"><span class="hs-identifier hs-var">reward</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">QType
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><a href="#local-6989586621679395811"><span class="hs-identifier hs-type">z0</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.HList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.A2CHelpers.html#ModelTensors"><span class="hs-identifier hs-type">ModelTensors</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679395774"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span>  </span><span id="local-6989586621679395811"><span class="annot"><span class="annottext">z0 :: HList (ModelTensors dev)
</span><a href="#local-6989586621679395811"><span class="hs-identifier hs-var hs-var">z0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QModel dev -&gt; HList (ModelTensors dev)
forall (dev :: (DeviceType, Nat)).
IsValidDevice dev =&gt;
QModel dev -&gt; HList (ModelTensors dev)
</span><a href="RL.A2CHelpers.html#modelZeros"><span class="hs-identifier hs-var">modelZeros</span></a></span><span> </span><span class="annot"><span class="annottext">(QModel dev -&gt; HList (ModelTensors dev))
-&gt; QModel dev -&gt; HList (ModelTensors dev)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">A2CState dev -&gt; QModel dev
forall (dev :: (DeviceType, Nat)). A2CState dev -&gt; QModel dev
</span><a href="RL.A2C.html#a2cActor"><span class="hs-identifier hs-var">a2cActor</span></a></span><span> </span><span class="annot"><span class="annottext">A2CState dev
</span><a href="#local-6989586621679395809"><span class="hs-identifier hs-var">modelState</span></a></span><span>
</span><span id="line-201"></span><span>  </span><span id="local-6989586621679395821"><span class="annot"><span class="annottext">lr :: QType
</span><a href="#local-6989586621679395821"><span class="hs-identifier hs-var hs-var">lr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType -&gt; QType
</span><a href="#local-6989586621679395805"><span class="hs-identifier hs-var">fLr</span></a></span><span> </span><span class="annot"><span class="annottext">(QType -&gt; QType) -&gt; QType -&gt; QType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; QType
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679395810"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-202"></span><span>  </span><span id="local-6989586621679395824"><span class="annot"><span class="annottext">temp :: QType
</span><a href="#local-6989586621679395824"><span class="hs-identifier hs-var hs-var">temp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType -&gt; QType
</span><a href="#local-6989586621679395806"><span class="hs-identifier hs-var">fTemp</span></a></span><span> </span><span class="annot"><span class="annottext">(QType -&gt; QType) -&gt; QType -&gt; QType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; QType
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679395810"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-comment">-- len = pathLen input</span><span>
</span><span id="line-204"></span><span>  </span><span id="local-6989586621679395814"><span class="annot"><span class="annottext">go :: A2CState dev
-&gt; A2CStepState dev
-&gt; List QType
-&gt; ExceptT String IO (A2CState dev, QType, QType)
</span><a href="#local-6989586621679395814"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679395846"><span class="annot"><span class="annottext">A2CState dev
</span><a href="#local-6989586621679395846"><span class="hs-identifier hs-var">modelState</span></a></span></span><span> </span><span id="local-6989586621679395847"><span class="annot"><span class="annottext">A2CStepState dev
</span><a href="#local-6989586621679395847"><span class="hs-identifier hs-var">pieceState</span></a></span></span><span> </span><span id="local-6989586621679395848"><span class="annot"><span class="annottext">List QType
</span><a href="#local-6989586621679395848"><span class="hs-identifier hs-var">losses</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-205"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679395849"><span class="annot"><a href="#local-6989586621679395849"><span class="hs-identifier hs-var">modelState'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679395850"><span class="annot"><a href="#local-6989586621679395850"><span class="hs-identifier hs-var">pieceState'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679395851"><span class="annot"><a href="#local-6989586621679395851"><span class="hs-identifier hs-var">loss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
-&gt; IOGenM StdGen
-&gt; PVRewardFn label
-&gt; label
-&gt; QType
-&gt; QType
-&gt; Int
-&gt; A2CState dev
-&gt; A2CStepState dev
-&gt; ExceptT
     String IO (A2CState dev, Either (A2CStepState dev) QType, QType)
forall (dev :: (DeviceType, Nat)) label.
IsValidDevice dev =&gt;
Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
-&gt; IOGenM StdGen
-&gt; PVRewardFn label
-&gt; label
-&gt; QType
-&gt; QType
-&gt; Int
-&gt; A2CState dev
-&gt; A2CStepState dev
-&gt; ExceptT
     String IO (A2CState dev, Either (A2CStepState dev) QType, QType)
</span><a href="RL.A2C.html#pieceStep"><span class="hs-identifier hs-var">pieceStep</span></a></span><span> </span><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
</span><a href="#local-6989586621679395802"><span class="hs-identifier hs-var">eval</span></a></span><span> </span><span class="annot"><span class="annottext">IOGenM StdGen
</span><a href="#local-6989586621679395803"><span class="hs-identifier hs-var">gen</span></a></span><span> </span><span class="annot"><span class="annottext">PVRewardFn label
</span><a href="#local-6989586621679395804"><span class="hs-identifier hs-var">fReward</span></a></span><span> </span><span class="annot"><span class="annottext">label
</span><a href="#local-6989586621679395808"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679395821"><span class="hs-identifier hs-var">lr</span></a></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679395824"><span class="hs-identifier hs-var">temp</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679395810"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">A2CState dev
</span><a href="#local-6989586621679395846"><span class="hs-identifier hs-var">modelState</span></a></span><span> </span><span class="annot"><span class="annottext">A2CStepState dev
</span><a href="#local-6989586621679395847"><span class="hs-identifier hs-var">pieceState</span></a></span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679395852"><span class="annot"><a href="#local-6989586621679395852"><span class="hs-identifier hs-var hs-var">losses'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679395851"><span class="hs-identifier hs-var">loss</span></a></span><span> </span><span class="annot"><span class="annottext">QType -&gt; List QType -&gt; List QType
forall a. a -&gt; List a -&gt; List a
</span><span class="hs-operator hs-var">`SL.Cons`</span></span><span> </span><span class="annot"><span class="annottext">List QType
</span><a href="#local-6989586621679395848"><span class="hs-identifier hs-var">losses</span></a></span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679395850"><span class="hs-identifier hs-type">pieceState'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-208"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679395854"><span class="annot"><span class="annottext">A2CStepState dev
</span><a href="#local-6989586621679395854"><span class="hs-identifier hs-var">ps'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">A2CState dev
-&gt; A2CStepState dev
-&gt; List QType
-&gt; ExceptT String IO (A2CState dev, QType, QType)
</span><a href="#local-6989586621679395814"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">A2CState dev
</span><a href="#local-6989586621679395849"><span class="hs-identifier hs-var">modelState'</span></a></span><span> </span><span class="annot"><span class="annottext">A2CStepState dev
</span><a href="#local-6989586621679395854"><span class="hs-identifier hs-var">ps'</span></a></span><span> </span><span class="annot"><span class="annottext">List QType
</span><a href="#local-6989586621679395852"><span class="hs-identifier hs-var">losses'</span></a></span><span>
</span><span id="line-209"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679395855"><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679395855"><span class="hs-identifier hs-var">reward</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(A2CState dev, QType, QType)
-&gt; ExceptT String IO (A2CState dev, QType, QType)
forall a. a -&gt; ExceptT String IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">A2CState dev
</span><a href="#local-6989586621679395849"><span class="hs-identifier hs-var">modelState'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679395855"><span class="hs-identifier hs-var">reward</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">List QType -&gt; QType
forall (t :: * -&gt; *). Foldable t =&gt; t QType -&gt; QType
</span><a href="RL.Plotting.html#mean"><span class="hs-identifier hs-var">mean</span></a></span><span> </span><span class="annot"><span class="annottext">List QType
</span><a href="#local-6989586621679395852"><span class="hs-identifier hs-var">losses'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span id="local-6989586621679386673"><span id="local-6989586621679386674"><span id="local-6989586621679386675"><span class="annot"><a href="RL.A2C.html#runAccuracy"><span class="hs-identifier hs-type">runAccuracy</span></a></span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.ModelTypes.html#IsValidDevice"><span class="hs-identifier hs-type">IsValidDevice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386673"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eval</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Edges</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Edge</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Notes</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679386674"><span class="hs-identifier hs-type">slc'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Spread</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PVLeftmost</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#PVRewardFn"><span class="hs-identifier hs-type">PVRewardFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386675"><span class="hs-keyword hs-type">label</span></a></span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.Model.html#QModel"><span class="hs-identifier hs-type">QModel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386673"><span class="hs-identifier hs-type">dev</span></a></span><span>
</span><span id="line-216"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><a href="#local-6989586621679386674"><span class="hs-identifier hs-type">slc'</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Edge</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679386675"><span class="hs-keyword hs-type">label</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PVAnalysis</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-218"></span><span id="runAccuracy"><span class="annot"><span class="annottext">runAccuracy :: forall (dev :: (DeviceType, Nat)) slc' label.
IsValidDevice dev =&gt;
Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  slc'
  (Spread SPitch)
  (PVLeftmost SPitch)
-&gt; PVRewardFn label
-&gt; QModel dev
-&gt; (Path slc' [Edge SPitch], label)
-&gt; IO (Either String (QType, PVAnalysis SPitch))
</span><a href="RL.A2C.html#runAccuracy"><span class="hs-identifier hs-var hs-var">runAccuracy</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395872"><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  slc'
  (Spread SPitch)
  (PVLeftmost SPitch)
</span><a href="#local-6989586621679395872"><span class="hs-identifier hs-var">eval</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395873"><span class="annot"><span class="annottext">PVRewardFn label
</span><a href="#local-6989586621679395873"><span class="hs-identifier hs-var">fReward</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395874"><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679395874"><span class="hs-identifier hs-var">actor</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679395875"><span class="annot"><span class="annottext">Path slc' [Edge SPitch]
</span><a href="#local-6989586621679395875"><span class="hs-identifier hs-var">input</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395876"><span class="annot"><span class="annottext">label
</span><a href="#local-6989586621679395876"><span class="hs-keyword hs-var">label</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [PVAction] -&gt; [PVAction]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">200</span></span><span> </span><span class="annot"><span class="annottext">([PVAction] -&gt; [PVAction]) -&gt; [PVAction] -&gt; [PVAction]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  slc'
  (Spread SPitch)
  (PVLeftmost SPitch)
-&gt; GreedyState
     (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; [PVAction]
forall {k} (m :: k) tr tr' slc slc' s f h.
Eval tr tr' slc slc' h (Leftmost s f h)
-&gt; GreedyState tr tr' slc (Leftmost s f h) -&gt; [Action slc tr s f h]
</span><span class="hs-identifier hs-var">getActions</span></span><span> </span><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  slc'
  (Spread SPitch)
  (PVLeftmost SPitch)
</span><a href="#local-6989586621679395872"><span class="hs-identifier hs-var">eval</span></a></span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
forall {op}.
GreedyState (Edges SPitch) [Edge SPitch] (Notes SPitch) op
</span><a href="#local-6989586621679395877"><span class="hs-identifier hs-var">s0</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-219"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either String (QType, PVAnalysis SPitch)
-&gt; IO (Either String (QType, PVAnalysis SPitch))
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either String (QType, PVAnalysis SPitch)
 -&gt; IO (Either String (QType, PVAnalysis SPitch)))
-&gt; Either String (QType, PVAnalysis SPitch)
-&gt; IO (Either String (QType, PVAnalysis SPitch))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String (QType, PVAnalysis SPitch)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cannot parse: no possible actions for first step!&quot;</span></span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679395878"><span class="annot"><span class="annottext">PVAction
</span><a href="#local-6989586621679395878"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679395879"><span class="annot"><span class="annottext">[PVAction]
</span><a href="#local-6989586621679395879"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ExceptT String IO (QType, PVAnalysis SPitch)
-&gt; IO (Either String (QType, PVAnalysis SPitch))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">ET.runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT String IO (QType, PVAnalysis SPitch)
 -&gt; IO (Either String (QType, PVAnalysis SPitch)))
-&gt; ExceptT String IO (QType, PVAnalysis SPitch)
-&gt; IO (Either String (QType, PVAnalysis SPitch))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tensor
-&gt; QType
-&gt; GreedyState
     (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; NonEmpty PVAction
-&gt; ExceptT String IO (QType, PVAnalysis SPitch)
forall {slc}.
Tensor
-&gt; QType
-&gt; GreedyState
     (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; NonEmpty PVAction
-&gt; ExceptT
     String
     IO
     (QType,
      Analysis
        (Split SPitch) (Freeze SPitch) (Spread SPitch) (Edges SPitch) slc)
</span><a href="#local-6989586621679395880"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Tensor
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">QType
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
forall {op}.
GreedyState (Edges SPitch) [Edge SPitch] (Notes SPitch) op
</span><a href="#local-6989586621679395877"><span class="hs-identifier hs-var">s0</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PVAction
</span><a href="#local-6989586621679395878"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">PVAction -&gt; [PVAction] -&gt; NonEmpty PVAction
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">NE.:|</span></span><span> </span><span class="annot"><span class="annottext">[PVAction]
</span><a href="#local-6989586621679395879"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-222"></span><span>  </span><span id="local-6989586621679395877"><span class="annot"><span class="annottext">s0 :: GreedyState (Edges SPitch) [Edge SPitch] (Notes SPitch) op
</span><a href="#local-6989586621679395877"><span class="hs-identifier hs-var hs-var">s0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  slc'
  (Spread SPitch)
  (PVLeftmost SPitch)
-&gt; Path slc' [Edge SPitch]
-&gt; GreedyState (Edges SPitch) [Edge SPitch] (Notes SPitch) op
forall tr tr' slc slc' h v op.
Eval tr tr' slc slc' h v
-&gt; Path slc' tr' -&gt; GreedyState tr tr' slc op
</span><span class="hs-identifier hs-var">initParseState</span></span><span> </span><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  slc'
  (Spread SPitch)
  (PVLeftmost SPitch)
</span><a href="#local-6989586621679395872"><span class="hs-identifier hs-var">eval</span></a></span><span> </span><span class="annot"><span class="annottext">Path slc' [Edge SPitch]
</span><a href="#local-6989586621679395875"><span class="hs-identifier hs-var">input</span></a></span><span>
</span><span id="line-223"></span><span>  </span><span id="local-6989586621679395880"><span class="annot"><span class="annottext">go :: Tensor
-&gt; QType
-&gt; GreedyState
     (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; NonEmpty PVAction
-&gt; ExceptT
     String
     IO
     (QType,
      Analysis
        (Split SPitch) (Freeze SPitch) (Spread SPitch) (Edges SPitch) slc)
</span><a href="#local-6989586621679395880"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395910"><span class="annot"><span class="annottext">Tensor
</span><a href="#local-6989586621679395910"><span class="hs-identifier hs-var">cost</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395911"><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679395911"><span class="hs-identifier hs-var">reward</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395912"><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><a href="#local-6989586621679395912"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679395913"><span class="annot"><span class="annottext">NonEmpty PVAction
</span><a href="#local-6989586621679395913"><span class="hs-identifier hs-var">actions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-224"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-225"></span><span>      </span><span class="hs-comment">-- encodings = encodeStep state &lt;$&gt; actions</span><span>
</span><span id="line-226"></span><span>      </span><span class="hs-comment">-- probs = T.softmax (T.Dim 0) $ T.cat (T.Dim 0) $ TT.toDynamic . forwardPolicy actor &lt;$&gt; encodings</span><span>
</span><span id="line-227"></span><span>      </span><span id="local-6989586621679395915"><span class="annot"><span class="annottext">probs :: Tensor
</span><a href="#local-6989586621679395915"><span class="hs-identifier hs-var hs-var hs-var">probs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; NonEmpty PVAction
-&gt; (forall (n :: Nat). KnownNat n =&gt; QEncoding dev '[n] -&gt; Tensor)
-&gt; Tensor
forall (dev :: (DeviceType, Nat)) r.
KnownDevice dev =&gt;
GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; NonEmpty PVAction
-&gt; (forall (n :: Nat). KnownNat n =&gt; QEncoding dev '[n] -&gt; r)
-&gt; r
</span><a href="RL.Encoding.html#withBatchedEncoding"><span class="hs-identifier hs-var">withBatchedEncoding</span></a></span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><a href="#local-6989586621679395912"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty PVAction
</span><a href="#local-6989586621679395913"><span class="hs-identifier hs-var">actions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QModel dev -&gt; QEncoding dev '[n] -&gt; Tensor
forall (dev :: (DeviceType, Nat)) (batchSize :: Nat).
(IsValidDevice dev, KnownNat batchSize) =&gt;
QModel dev -&gt; QEncoding dev '[batchSize] -&gt; Tensor
</span><a href="RL.Model.html#runBatchedPolicy"><span class="hs-identifier hs-var">runBatchedPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679395874"><span class="hs-identifier hs-var">actor</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span>      </span><span id="local-6989586621679395931"><span class="annot"><span class="annottext">best :: Int
</span><a href="#local-6989586621679395931"><span class="hs-identifier hs-var hs-var hs-var">best</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tensor -&gt; Int
forall a. TensorLike a =&gt; Tensor -&gt; a
</span><span class="hs-identifier hs-var">T.asValue</span></span><span> </span><span class="annot"><span class="annottext">(Tensor -&gt; Int) -&gt; Tensor -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Dim -&gt; KeepDim -&gt; Tensor -&gt; Tensor
</span><span class="hs-identifier hs-var">T.argmax</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Dim
</span><span class="hs-identifier hs-var">T.Dim</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">KeepDim
</span><span class="hs-identifier hs-var">T.KeepDim</span></span><span> </span><span class="annot"><span class="annottext">Tensor
</span><a href="#local-6989586621679395915"><span class="hs-identifier hs-var">probs</span></a></span><span>
</span><span id="line-229"></span><span>      </span><span id="local-6989586621679395937"><span class="annot"><span class="annottext">action :: PVAction
</span><a href="#local-6989586621679395937"><span class="hs-identifier hs-var hs-var hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty PVAction
</span><a href="#local-6989586621679395913"><span class="hs-identifier hs-var">actions</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty PVAction -&gt; Int -&gt; PVAction
forall a. HasCallStack =&gt; NonEmpty a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">NE.!!</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679395931"><span class="hs-identifier hs-var">best</span></a></span><span>
</span><span id="line-230"></span><span>      </span><span id="local-6989586621679395939"><span class="annot"><span class="annottext">bestprob :: Tensor
</span><a href="#local-6989586621679395939"><span class="hs-identifier hs-var hs-var hs-var">bestprob</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tensor
</span><a href="#local-6989586621679395915"><span class="hs-identifier hs-var">probs</span></a></span><span> </span><span class="annot"><span class="annottext">Tensor -&gt; Int -&gt; Tensor
forall a. TensorIndex a =&gt; Tensor -&gt; a -&gt; Tensor
</span><span class="hs-operator hs-var">T.!</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679395931"><span class="hs-identifier hs-var">best</span></a></span><span>
</span><span id="line-231"></span><span>      </span><span id="local-6989586621679395941"><span class="annot"><span class="annottext">cost' :: Tensor
</span><a href="#local-6989586621679395941"><span class="hs-identifier hs-var hs-var hs-var">cost'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tensor
</span><a href="#local-6989586621679395910"><span class="hs-identifier hs-var">cost</span></a></span><span> </span><span class="annot"><span class="annottext">Tensor -&gt; Tensor -&gt; Tensor
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Tensor -&gt; Tensor
</span><span class="hs-identifier hs-var">T.log</span></span><span> </span><span class="annot"><span class="annottext">Tensor
</span><a href="#local-6989586621679395939"><span class="hs-identifier hs-var">bestprob</span></a></span><span>
</span><span id="line-232"></span><span>    </span><span id="local-6989586621679395943"><span class="annot"><a href="#local-6989586621679395943"><span class="hs-identifier hs-var">state'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either
  String
  (Either
     (GreedyState
        (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch))
     (Edges SPitch, [PVLeftmost SPitch]))
-&gt; ExceptT
     String
     IO
     (Either
        (GreedyState
           (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch))
        (Edges SPitch, [PVLeftmost SPitch]))
forall (m :: * -&gt; *) e a. Monad m =&gt; Either e a -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">ET.except</span></span><span> </span><span class="annot"><span class="annottext">(Either
   String
   (Either
      (GreedyState
         (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch))
      (Edges SPitch, [PVLeftmost SPitch]))
 -&gt; ExceptT
      String
      IO
      (Either
         (GreedyState
            (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch))
         (Edges SPitch, [PVLeftmost SPitch])))
-&gt; Either
     String
     (Either
        (GreedyState
           (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch))
        (Edges SPitch, [PVLeftmost SPitch]))
-&gt; ExceptT
     String
     IO
     (Either
        (GreedyState
           (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch))
        (Edges SPitch, [PVLeftmost SPitch]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; PVAction
-&gt; Either
     String
     (Either
        (GreedyState
           (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch))
        (Edges SPitch, [PVLeftmost SPitch]))
forall {k1} {k2} (m :: k1) tr tr' slc (slc' :: k2) s f h.
GreedyState tr tr' slc (Leftmost s f h)
-&gt; Action slc tr s f h
-&gt; Either
     String
     (Either
        (GreedyState tr tr' slc (Leftmost s f h)) (tr, [Leftmost s f h]))
</span><span class="hs-identifier hs-var">applyAction</span></span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><a href="#local-6989586621679395912"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">PVAction
</span><a href="#local-6989586621679395937"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679395944"><span class="annot"><a href="#local-6989586621679395944"><span class="hs-identifier hs-var hs-var">actions'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either
  (GreedyState
     (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch))
  (Edges SPitch, [PVLeftmost SPitch])
</span><a href="#local-6989586621679395943"><span class="hs-identifier hs-var">state'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-234"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679395945"><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><a href="#local-6989586621679395945"><span class="hs-identifier hs-var">newState</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[PVAction] -&gt; Maybe (NonEmpty PVAction)
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><span class="hs-identifier hs-var">NE.nonEmpty</span></span><span> </span><span class="annot"><span class="annottext">([PVAction] -&gt; Maybe (NonEmpty PVAction))
-&gt; [PVAction] -&gt; Maybe (NonEmpty PVAction)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [PVAction] -&gt; [PVAction]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">200</span></span><span> </span><span class="annot"><span class="annottext">([PVAction] -&gt; [PVAction]) -&gt; [PVAction] -&gt; [PVAction]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  slc'
  (Spread SPitch)
  (PVLeftmost SPitch)
-&gt; GreedyState
     (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; [PVAction]
forall {k} (m :: k) tr tr' slc slc' s f h.
Eval tr tr' slc slc' h (Leftmost s f h)
-&gt; GreedyState tr tr' slc (Leftmost s f h) -&gt; [Action slc tr s f h]
</span><span class="hs-identifier hs-var">getActions</span></span><span> </span><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  slc'
  (Spread SPitch)
  (PVLeftmost SPitch)
</span><a href="#local-6989586621679395872"><span class="hs-identifier hs-var">eval</span></a></span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><a href="#local-6989586621679395945"><span class="hs-identifier hs-var">newState</span></a></span><span>
</span><span id="line-235"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">(Edges SPitch, [PVLeftmost SPitch])
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (NonEmpty PVAction)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-236"></span><span>    </span><span id="local-6989586621679395946"><span class="annot"><a href="#local-6989586621679395946"><span class="hs-identifier hs-var">actionReward</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">lift</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621679395873"><span class="hs-identifier hs-type">fReward</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679395943"><span class="hs-identifier hs-type">state'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679395944"><span class="hs-identifier hs-type">actions'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679395937"><span class="hs-identifier hs-type">action</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679395876"><span class="hs-keyword hs-type">label</span></a></span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679395948"><span class="annot"><a href="#local-6989586621679395948"><span class="hs-identifier hs-var hs-var">reward'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679395911"><span class="hs-identifier hs-var">reward</span></a></span><span> </span><span class="annot"><span class="annottext">QType -&gt; QType -&gt; QType
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679395946"><span class="hs-identifier hs-var">actionReward</span></a></span><span>
</span><span id="line-238"></span><span>    </span><span class="hs-comment">-- lift $ print probs</span><span>
</span><span id="line-239"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679395943"><span class="hs-identifier hs-type">state'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679395944"><span class="hs-identifier hs-type">actions'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-240"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (NonEmpty PVAction)
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-241"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; ExceptT
     String
     IO
     (QType,
      Analysis
        (Split SPitch) (Freeze SPitch) (Spread SPitch) (Edges SPitch) slc)
forall (m :: * -&gt; *) e a. Monad m =&gt; e -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">ET.throwE</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cannot parse: no possible actions in non-terminal state!&quot;</span></span><span>
</span><span id="line-242"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679395950"><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><a href="#local-6989586621679395950"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679395951"><span class="annot"><span class="annottext">NonEmpty PVAction
</span><a href="#local-6989586621679395951"><span class="hs-identifier hs-var">a'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Tensor
-&gt; QType
-&gt; GreedyState
     (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
-&gt; NonEmpty PVAction
-&gt; ExceptT
     String
     IO
     (QType,
      Analysis
        (Split SPitch) (Freeze SPitch) (Spread SPitch) (Edges SPitch) slc)
</span><a href="#local-6989586621679395880"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Tensor
</span><a href="#local-6989586621679395941"><span class="hs-identifier hs-var">cost'</span></a></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679395948"><span class="hs-identifier hs-var">reward'</span></a></span><span> </span><span class="annot"><span class="annottext">GreedyState
  (Edges SPitch) [Edge SPitch] (Notes SPitch) (PVLeftmost SPitch)
</span><a href="#local-6989586621679395950"><span class="hs-identifier hs-var">s'</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty PVAction
</span><a href="#local-6989586621679395951"><span class="hs-identifier hs-var">a'</span></a></span><span>
</span><span id="line-243"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679395952"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679395952"><span class="hs-identifier hs-var">top</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679395953"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679395953"><span class="hs-identifier hs-var">deriv</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (NonEmpty PVAction)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-244"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; ExceptT String IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT String m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ExceptT String IO ()) -&gt; IO () -&gt; ExceptT String IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;accuracy cost: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Tensor -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Tensor
</span><a href="#local-6989586621679395941"><span class="hs-identifier hs-var">cost'</span></a></span><span>
</span><span id="line-245"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; ExceptT String IO () -&gt; ExceptT String IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tensor -&gt; QType
forall a. TensorLike a =&gt; Tensor -&gt; a
</span><span class="hs-identifier hs-var">T.asValue</span></span><span> </span><span class="annot"><span class="annottext">Tensor
</span><a href="#local-6989586621679395910"><span class="hs-identifier hs-var">cost</span></a></span><span> </span><span class="annot"><span class="annottext">QType -&gt; QType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QType
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExceptT String IO () -&gt; ExceptT String IO ())
-&gt; ExceptT String IO () -&gt; ExceptT String IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-246"></span><span>          </span><span class="annot"><span class="annottext">IO () -&gt; ExceptT String IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT String m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ExceptT String IO ()) -&gt; IO () -&gt; ExceptT String IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tensor -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Tensor
</span><a href="#local-6989586621679395939"><span class="hs-identifier hs-var">bestprob</span></a></span><span>
</span><span id="line-247"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679395956"><span class="annot"><span class="annottext">ana :: Analysis
  (Split SPitch) (Freeze SPitch) (Spread SPitch) (Edges SPitch) slc
</span><a href="#local-6989586621679395956"><span class="hs-identifier hs-var hs-var">ana</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
-&gt; Path (Edges SPitch) slc
-&gt; Analysis
     (Split SPitch) (Freeze SPitch) (Spread SPitch) (Edges SPitch) slc
forall s f h tr slc.
[Leftmost s f h] -&gt; Path tr slc -&gt; Analysis s f h tr slc
</span><span class="hs-identifier hs-var">Analysis</span></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679395953"><span class="hs-identifier hs-var">deriv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) slc
forall around between. around -&gt; Path around between
</span><span class="hs-identifier hs-var">PathEnd</span></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679395952"><span class="hs-identifier hs-var">top</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>        </span><span class="annot"><span class="annottext">(QType,
 Analysis
   (Split SPitch) (Freeze SPitch) (Spread SPitch) (Edges SPitch) slc)
-&gt; ExceptT
     String
     IO
     (QType,
      Analysis
        (Split SPitch) (Freeze SPitch) (Spread SPitch) (Edges SPitch) slc)
forall a. a -&gt; ExceptT String IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679395948"><span class="hs-identifier hs-var">reward'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Analysis
  (Split SPitch) (Freeze SPitch) (Spread SPitch) (Edges SPitch) slc
forall {slc}.
Analysis
  (Split SPitch) (Freeze SPitch) (Spread SPitch) (Edges SPitch) slc
</span><a href="#local-6989586621679395956"><span class="hs-identifier hs-var">ana</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span id="local-6989586621679386747"><span id="local-6989586621679395961"><span id="local-6989586621679395965"><span id="local-6989586621679395972"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="annot"><a href="#local-6989586621679386747"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SL.List</span></span><span> </span><span class="annot"><a href="#local-6989586621679386747"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span class="hs-keyword">data</span><span> </span><span id="A2CLoopState"><span class="annot"><a href="RL.A2C.html#A2CLoopState"><span class="hs-identifier hs-var">A2CLoopState</span></a></span></span><span> </span><span id="local-6989586621679386748"><span class="annot"><a href="#local-6989586621679386748"><span class="hs-identifier hs-type">dev</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="A2CLoopState"><span class="annot"><a href="RL.A2C.html#A2CLoopState"><span class="hs-identifier hs-var">A2CLoopState</span></a></span></span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="a2clState"><span class="annot"><span class="annottext">forall (dev :: (DeviceType, Nat)). A2CLoopState dev -&gt; A2CState dev
</span><a href="RL.A2C.html#a2clState"><span class="hs-identifier hs-var hs-var">a2clState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RL.A2C.html#A2CState"><span class="hs-identifier hs-type">A2CState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386748"><span class="hs-identifier hs-type">dev</span></a></span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="a2clRewards"><span class="annot"><span class="annottext">forall (dev :: (DeviceType, Nat)).
A2CLoopState dev -&gt; List (List QType)
</span><a href="RL.A2C.html#a2clRewards"><span class="hs-identifier hs-var hs-var">a2clRewards</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SL.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SL.List</span></span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="a2clLosses"><span class="annot"><span class="annottext">forall (dev :: (DeviceType, Nat)).
A2CLoopState dev -&gt; List (List QType)
</span><a href="RL.A2C.html#a2clLosses"><span class="hs-identifier hs-var hs-var">a2clLosses</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SL.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SL.List</span></span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="a2clAccs"><span class="annot"><span class="annottext">forall (dev :: (DeviceType, Nat)).
A2CLoopState dev -&gt; List (List QType)
</span><a href="RL.A2C.html#a2clAccs"><span class="hs-identifier hs-var hs-var">a2clAccs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SL.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SL.List</span></span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-258"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679396008"><span id="local-6989586621679396010"><span class="annot"><span class="annottext">(forall x. A2CLoopState dev -&gt; Rep (A2CLoopState dev) x)
-&gt; (forall x. Rep (A2CLoopState dev) x -&gt; A2CLoopState dev)
-&gt; Generic (A2CLoopState dev)
forall x. Rep (A2CLoopState dev) x -&gt; A2CLoopState dev
forall x. A2CLoopState dev -&gt; Rep (A2CLoopState dev) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (dev :: (DeviceType, Nat)) x.
Rep (A2CLoopState dev) x -&gt; A2CLoopState dev
forall (dev :: (DeviceType, Nat)) x.
A2CLoopState dev -&gt; Rep (A2CLoopState dev) x
$cfrom :: forall (dev :: (DeviceType, Nat)) x.
A2CLoopState dev -&gt; Rep (A2CLoopState dev) x
from :: forall x. A2CLoopState dev -&gt; Rep (A2CLoopState dev) x
$cto :: forall (dev :: (DeviceType, Nat)) x.
Rep (A2CLoopState dev) x -&gt; A2CLoopState dev
to :: forall x. Rep (A2CLoopState dev) x -&gt; A2CLoopState dev
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span class="annot"><a href="RL.A2C.html#trainA2C"><span class="hs-identifier hs-type">trainA2C</span></a></span><span>
</span><span id="line-261"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679386756"><span class="annot"><a href="#local-6989586621679386756"><span class="hs-identifier hs-type">dev</span></a></span></span><span> </span><span id="local-6989586621679386757"><span class="annot"><a href="#local-6989586621679386757"><span class="hs-keyword hs-type">label</span></a></span></span><span>
</span><span id="line-262"></span><span>   </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.ModelTypes.html#IsValidDevice"><span class="hs-identifier hs-type">IsValidDevice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386756"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eval</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Edges</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Edge</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Notes</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Note</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Spread</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PVLeftmost</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rand.IOGenM</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rand.StdGen</span></span><span>
</span><span id="line-265"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#PVRewardFn"><span class="hs-identifier hs-type">PVRewardFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386757"><span class="hs-keyword hs-type">label</span></a></span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ learning rate schedule</span></span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ temperature schedule</span></span><span>
</span><span id="line-270"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-271"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.Model.html#QModel"><span class="hs-identifier hs-type">QModel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386756"><span class="hs-identifier hs-type">dev</span></a></span><span>
</span><span id="line-272"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RL.Model.html#QModel"><span class="hs-identifier hs-type">QModel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386756"><span class="hs-identifier hs-type">dev</span></a></span><span>
</span><span id="line-273"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Note</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Edge</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679386757"><span class="hs-keyword hs-type">label</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-274"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="RL.ModelTypes.html#QType"><span class="hs-identifier hs-type">QType</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RL.Model.html#QModel"><span class="hs-identifier hs-type">QModel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386756"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RL.Model.html#QModel"><span class="hs-identifier hs-type">QModel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679386756"><span class="hs-identifier hs-type">dev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span id="trainA2C"><span class="annot"><span class="annottext">trainA2C :: forall (dev :: (DeviceType, Nat)) label.
IsValidDevice dev =&gt;
Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
-&gt; IOGenM StdGen
-&gt; PVRewardFn label
-&gt; (QType -&gt; QType)
-&gt; (QType -&gt; QType)
-&gt; Maybe [QType]
-&gt; QModel dev
-&gt; QModel dev
-&gt; [(Path [Note SPitch] [Edge SPitch], label)]
-&gt; Int
-&gt; IO ([[QType]], [QType], QModel dev, QModel dev)
</span><a href="RL.A2C.html#trainA2C"><span class="hs-identifier hs-var hs-var">trainA2C</span></a></span></span><span> </span><span id="local-6989586621679396034"><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
</span><a href="#local-6989586621679396034"><span class="hs-identifier hs-var">eval</span></a></span></span><span> </span><span id="local-6989586621679396035"><span class="annot"><span class="annottext">IOGenM StdGen
</span><a href="#local-6989586621679396035"><span class="hs-identifier hs-var">gen</span></a></span></span><span> </span><span id="local-6989586621679396036"><span class="annot"><span class="annottext">PVRewardFn label
</span><a href="#local-6989586621679396036"><span class="hs-identifier hs-var">fReward</span></a></span></span><span> </span><span id="local-6989586621679396037"><span class="annot"><span class="annottext">QType -&gt; QType
</span><a href="#local-6989586621679396037"><span class="hs-identifier hs-var">fLr</span></a></span></span><span> </span><span id="local-6989586621679396038"><span class="annot"><span class="annottext">QType -&gt; QType
</span><a href="#local-6989586621679396038"><span class="hs-identifier hs-var">fTemp</span></a></span></span><span> </span><span id="local-6989586621679396039"><span class="annot"><span class="annottext">Maybe [QType]
</span><a href="#local-6989586621679396039"><span class="hs-identifier hs-var">targets</span></a></span></span><span> </span><span id="local-6989586621679396040"><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679396040"><span class="hs-identifier hs-var">actor0</span></a></span></span><span> </span><span id="local-6989586621679396041"><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679396041"><span class="hs-identifier hs-var">critic0</span></a></span></span><span> </span><span id="local-6989586621679396042"><span class="annot"><span class="annottext">[(Path [Note SPitch] [Edge SPitch], label)]
</span><a href="#local-6989586621679396042"><span class="hs-identifier hs-var">pieces</span></a></span></span><span> </span><span id="local-6989586621679396043"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679396043"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-277"></span><span>  </span><span class="hs-comment">-- print $ qModelFinal2 model0</span><span>
</span><span id="line-278"></span><span>  </span><span class="hs-comment">-- opta &lt;- TT.initOptimizer (TT.AdamOptions 0.0001 (0.9, 0.999) 1e-8 0 False) actor0</span><span>
</span><span id="line-279"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-280"></span><span>    </span><span id="local-6989586621679396044"><span class="annot"><span class="annottext">opta :: GD
</span><a href="#local-6989586621679396044"><span class="hs-identifier hs-var hs-var hs-var">opta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GD
</span><span class="hs-identifier hs-var">TT.GD</span></span><span> </span><span class="hs-comment">-- TT.mkAdam 0 0.9 0.99 (TT.flattenParameters actor0)</span><span>
</span><span id="line-281"></span><span>    </span><span id="local-6989586621679396046"><span class="annot"><span class="annottext">optc :: GD
</span><a href="#local-6989586621679396046"><span class="hs-identifier hs-var hs-var hs-var">optc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GD
</span><span class="hs-identifier hs-var">TT.GD</span></span><span> </span><span class="hs-comment">-- TT.mkAdam 0 0.9 0.99 (TT.flattenParameters critic0)</span><span>
</span><span id="line-282"></span><span>    </span><span id="local-6989586621679396049"><span class="annot"><span class="annottext">emptyStat :: List (List a)
</span><a href="#local-6989586621679396049"><span class="hs-identifier hs-var hs-var hs-var">emptyStat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[List a] -&gt; List (List a)
forall a. [a] -&gt; List a
</span><span class="hs-identifier hs-var">SL.fromListReversed</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; List a -&gt; [List a]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Path [Note SPitch] [Edge SPitch], label)] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(Path [Note SPitch] [Edge SPitch], label)]
</span><a href="#local-6989586621679396042"><span class="hs-identifier hs-var">pieces</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">List a
forall a. List a
</span><span class="hs-identifier hs-var">SL.Nil</span></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>    </span><span id="local-6989586621679396053"><span class="annot"><span class="annottext">state0 :: A2CState dev
</span><a href="#local-6989586621679396053"><span class="hs-identifier hs-var hs-var hs-var">state0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QModel dev -&gt; QModel dev -&gt; GD -&gt; GD -&gt; A2CState dev
forall (dev :: (DeviceType, Nat)).
QModel dev -&gt; QModel dev -&gt; GD -&gt; GD -&gt; A2CState dev
</span><a href="RL.A2C.html#A2CState"><span class="hs-identifier hs-var">A2CState</span></a></span><span> </span><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679396040"><span class="hs-identifier hs-var">actor0</span></a></span><span> </span><span class="annot"><span class="annottext">QModel dev
</span><a href="#local-6989586621679396041"><span class="hs-identifier hs-var">critic0</span></a></span><span> </span><span class="annot"><span class="annottext">GD
</span><a href="#local-6989586621679396044"><span class="hs-identifier hs-var">opta</span></a></span><span> </span><span class="annot"><span class="annottext">GD
</span><a href="#local-6989586621679396046"><span class="hs-identifier hs-var">optc</span></a></span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="RL.A2C.html#A2CLoopState"><span class="hs-identifier hs-type">A2CLoopState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.A2C.html#A2CState"><span class="hs-identifier hs-type">A2CState</span></a></span><span> </span><span id="local-6989586621679396054"><span class="annot"><a href="#local-6989586621679396054"><span class="hs-identifier hs-var">actorTrained</span></a></span></span><span> </span><span id="local-6989586621679396055"><span class="annot"><a href="#local-6989586621679396055"><span class="hs-identifier hs-var">criticTrained</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679396056"><span class="annot"><a href="#local-6989586621679396056"><span class="hs-identifier hs-var">rewards</span></a></span></span><span> </span><span id="local-6989586621679396057"><span class="annot"><a href="#local-6989586621679396057"><span class="hs-identifier hs-var">losses</span></a></span></span><span> </span><span id="local-6989586621679396058"><span class="annot"><a href="#local-6989586621679396058"><span class="hs-identifier hs-var">accs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">A2CLoopState dev
-&gt; Int
-&gt; (A2CLoopState dev -&gt; Int -&gt; IO (A2CLoopState dev))
-&gt; IO (A2CLoopState dev)
forall a. a -&gt; Int -&gt; (a -&gt; Int -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">T.foldLoop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">A2CState dev
-&gt; List (List QType)
-&gt; List (List QType)
-&gt; List (List QType)
-&gt; A2CLoopState dev
forall (dev :: (DeviceType, Nat)).
A2CState dev
-&gt; List (List QType)
-&gt; List (List QType)
-&gt; List (List QType)
-&gt; A2CLoopState dev
</span><a href="RL.A2C.html#A2CLoopState"><span class="hs-identifier hs-var">A2CLoopState</span></a></span><span> </span><span class="annot"><span class="annottext">A2CState dev
</span><a href="#local-6989586621679396053"><span class="hs-identifier hs-var">state0</span></a></span><span> </span><span class="annot"><span class="annottext">List (List QType)
forall {a}. List (List a)
</span><a href="#local-6989586621679396049"><span class="hs-identifier hs-var">emptyStat</span></a></span><span> </span><span class="annot"><span class="annottext">List (List QType)
forall {a}. List (List a)
</span><a href="#local-6989586621679396049"><span class="hs-identifier hs-var">emptyStat</span></a></span><span> </span><span class="annot"><span class="annottext">List (List QType)
forall {a}. List (List a)
</span><a href="#local-6989586621679396049"><span class="hs-identifier hs-var">emptyStat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679396043"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">A2CLoopState dev -&gt; Int -&gt; IO (A2CLoopState dev)
forall {dev :: (DeviceType, Nat)}.
(GeluDTypeIsValid dev 'Double, RandDTypeIsValid dev 'Double,
 BasicArithmeticDTypeIsValid dev 'Double,
 SumDTypeIsValid dev 'Double, MeanDTypeValidation dev 'Double,
 StandardFloatingPointDTypeValidation dev 'Double,
 KnownDevice dev) =&gt;
A2CLoopState dev -&gt; Int -&gt; IO (A2CLoopState dev)
</span><a href="#local-6989586621679396060"><span class="hs-identifier hs-var">trainEpoch</span></a></span><span>
</span><span id="line-285"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span>
</span><span id="line-286"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SL.toListReversed</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SL.toListReversed</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621679396056"><span class="hs-identifier hs-type">rewards</span></a></span><span>
</span><span id="line-287"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SL.toListReversed</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="RL.Plotting.html#mean"><span class="hs-identifier hs-type">mean</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621679396057"><span class="hs-identifier hs-type">losses</span></a></span><span>
</span><span id="line-288"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679396054"><span class="hs-identifier hs-type">actorTrained</span></a></span><span>
</span><span id="line-289"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679396055"><span class="hs-identifier hs-type">criticTrained</span></a></span><span>
</span><span id="line-290"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-comment">-- \| train a single episode on a single piece</span><span>
</span><span id="line-293"></span><span>  </span><span id="local-6989586621679396085"><span class="annot"><span class="annottext">trainPiece :: ProgressBar s
-&gt; Int
-&gt; (A2CState dev, List QType, List QType)
-&gt; ((Path [Note SPitch] [Edge SPitch], label), b)
-&gt; IO (A2CState dev, List QType, List QType)
</span><a href="#local-6989586621679396085"><span class="hs-identifier hs-var hs-var">trainPiece</span></a></span></span><span> </span><span id="local-6989586621679396086"><span class="annot"><span class="annottext">ProgressBar s
</span><a href="#local-6989586621679396086"><span class="hs-identifier hs-var">pb</span></a></span></span><span> </span><span id="local-6989586621679396087"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679396087"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679396088"><span class="annot"><span class="annottext">A2CState dev
</span><a href="#local-6989586621679396088"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679396089"><span class="annot"><span class="annottext">List QType
</span><a href="#local-6989586621679396089"><span class="hs-identifier hs-var">rewards</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679396090"><span class="annot"><span class="annottext">List QType
</span><a href="#local-6989586621679396090"><span class="hs-identifier hs-var">losses</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679396091"><span class="annot"><span class="annottext">Path [Note SPitch] [Edge SPitch]
</span><a href="#local-6989586621679396091"><span class="hs-identifier hs-var">piece</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679396092"><span class="annot"><span class="annottext">label
</span><a href="#local-6989586621679396092"><span class="hs-keyword hs-var">label</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679396093"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679396093"><span class="hs-identifier hs-var">j</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-294"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621679396094"><span class="annot"><a href="#local-6989586621679396094"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
-&gt; IOGenM StdGen
-&gt; PVRewardFn label
-&gt; (QType -&gt; QType)
-&gt; (QType -&gt; QType)
-&gt; Path [Note SPitch] [Edge SPitch]
-&gt; label
-&gt; A2CState dev
-&gt; Int
-&gt; IO (Either String (A2CState dev, QType, QType))
forall (dev :: (DeviceType, Nat)) label.
(GeluDTypeIsValid dev 'Double, RandDTypeIsValid dev 'Double,
 BasicArithmeticDTypeIsValid dev 'Double,
 SumDTypeIsValid dev 'Double, MeanDTypeValidation dev 'Double,
 StandardFloatingPointDTypeValidation dev 'Double,
 KnownDevice dev) =&gt;
Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
-&gt; IOGenM StdGen
-&gt; PVRewardFn label
-&gt; (QType -&gt; QType)
-&gt; (QType -&gt; QType)
-&gt; Path [Note SPitch] [Edge SPitch]
-&gt; label
-&gt; A2CState dev
-&gt; Int
-&gt; IO (Either String (A2CState dev, QType, QType))
</span><a href="RL.A2C.html#runEpisode"><span class="hs-identifier hs-var">runEpisode</span></a></span><span> </span><span class="annot"><span class="annottext">Eval
  (Edges SPitch)
  [Edge SPitch]
  (Notes SPitch)
  [Note SPitch]
  (Spread SPitch)
  (PVLeftmost SPitch)
</span><a href="#local-6989586621679396034"><span class="hs-identifier hs-var">eval</span></a></span><span> </span><span class="annot"><span class="annottext">IOGenM StdGen
</span><a href="#local-6989586621679396035"><span class="hs-identifier hs-var">gen</span></a></span><span> </span><span class="annot"><span class="annottext">PVRewardFn label
</span><a href="#local-6989586621679396036"><span class="hs-identifier hs-var">fReward</span></a></span><span> </span><span class="annot"><span class="annottext">QType -&gt; QType
</span><a href="#local-6989586621679396037"><span class="hs-identifier hs-var">fLr</span></a></span><span> </span><span class="annot"><span class="annottext">QType -&gt; QType
</span><a href="#local-6989586621679396038"><span class="hs-identifier hs-var">fTemp</span></a></span><span> </span><span class="annot"><span class="annottext">Path [Note SPitch] [Edge SPitch]
</span><a href="#local-6989586621679396091"><span class="hs-identifier hs-var">piece</span></a></span><span> </span><span class="annot"><span class="annottext">label
</span><a href="#local-6989586621679396092"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">A2CState dev
</span><a href="#local-6989586621679396088"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679396087"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-295"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">PB.incProgress</span></span><span> </span><span class="annot"><a href="#local-6989586621679396086"><span class="hs-identifier hs-type">pb</span></a></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span>
</span><span id="line-296"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679396094"><span class="hs-identifier hs-type">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-297"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679396096"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679396096"><span class="hs-identifier hs-var">error</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-298"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Episode error: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679396096"><span class="hs-identifier hs-var">error</span></a></span><span>
</span><span id="line-299"></span><span>        </span><span class="annot"><span class="annottext">(A2CState dev, List QType, List QType)
-&gt; IO (A2CState dev, List QType, List QType)
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">A2CState dev
</span><a href="#local-6989586621679396088"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">List QType
</span><a href="#local-6989586621679396089"><span class="hs-identifier hs-var">rewards</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">List QType
</span><a href="#local-6989586621679396090"><span class="hs-identifier hs-var">losses</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679396097"><span class="annot"><span class="annottext">A2CState dev
</span><a href="#local-6989586621679396097"><span class="hs-identifier hs-var">state'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679396098"><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679396098"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679396099"><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679396099"><span class="hs-identifier hs-var">loss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-301"></span><span>        </span><span class="hs-comment">-- putStrLn $ &quot;loss &quot; &lt;&gt; show j &lt;&gt; &quot;: &quot; &lt;&gt; show loss</span><span>
</span><span id="line-302"></span><span>        </span><span class="annot"><span class="annottext">(A2CState dev, List QType, List QType)
-&gt; IO (A2CState dev, List QType, List QType)
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">A2CState dev
</span><a href="#local-6989586621679396097"><span class="hs-identifier hs-var">state'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679396098"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">QType -&gt; List QType -&gt; List QType
forall a. a -&gt; List a -&gt; List a
</span><span class="hs-operator hs-var">`SL.Cons`</span></span><span> </span><span class="annot"><span class="annottext">List QType
</span><a href="#local-6989586621679396089"><span class="hs-identifier hs-var">rewards</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679396099"><span class="hs-identifier hs-var">loss</span></a></span><span> </span><span class="annot"><span class="annottext">QType -&gt; List QType -&gt; List QType
forall a. a -&gt; List a -&gt; List a
</span><span class="hs-operator hs-var">`SL.Cons`</span></span><span> </span><span class="annot"><span class="annottext">List QType
</span><a href="#local-6989586621679396090"><span class="hs-identifier hs-var">losses</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>  </span><span class="hs-comment">-- \| train one episode on each piece</span><span>
</span><span id="line-304"></span><span>  </span><span id="local-6989586621679396060"><span class="annot"><span class="annottext">trainEpoch :: A2CLoopState dev -&gt; Int -&gt; IO (A2CLoopState dev)
</span><a href="#local-6989586621679396060"><span class="hs-identifier hs-var hs-var">trainEpoch</span></a></span></span><span> </span><span id="local-6989586621679396812"><span class="annot"><span class="annottext">fullstate :: A2CLoopState dev
</span><a href="#local-6989586621679396812"><span class="hs-identifier hs-var">fullstate</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="RL.A2C.html#A2CLoopState"><span class="hs-identifier hs-type">A2CLoopState</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679396813"><span class="annot"><span class="annottext">A2CState dev
</span><a href="#local-6989586621679396813"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679396814"><span class="annot"><span class="annottext">List (List QType)
</span><a href="#local-6989586621679396814"><span class="hs-identifier hs-var">rewardsHist</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679396815"><span class="annot"><span class="annottext">List (List QType)
</span><a href="#local-6989586621679396815"><span class="hs-identifier hs-var">lossHist</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679396816"><span class="annot"><span class="annottext">List (List QType)
</span><a href="#local-6989586621679396816"><span class="hs-identifier hs-var">accuracies</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679396817"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679396817"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-305"></span><span>    </span><span class="hs-comment">-- putStrLn $ &quot;\nepoch &quot; &lt;&gt; show i</span><span>
</span><span id="line-306"></span><span>    </span><span id="local-6989586621679396818"><span class="annot"><a href="#local-6989586621679396818"><span class="hs-identifier hs-var">pb</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-307"></span><span>      </span><span class="annot"><span class="annottext">Style () -&gt; QType -&gt; Progress () -&gt; IO (ProgressBar ())
forall s. Style s -&gt; QType -&gt; Progress s -&gt; IO (ProgressBar s)
</span><span class="hs-identifier hs-var">PB.newProgressBar</span></span><span>
</span><span id="line-308"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Style ()
forall s. Style s
</span><span class="hs-identifier hs-var">PB.defStyle</span></span><span>
</span><span id="line-309"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier hs-var">PB.stylePrefix</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-string">&quot;Epoch &quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PB.msg</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Txt.show</span></span><span> </span><span class="annot"><a href="#local-6989586621679396817"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;: &quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PB.elapsedTime</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PB.renderDuration</span></span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-var">PB.stylePostfix</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PB.exact</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot; (&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PB.percentage</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;)&quot;</span></span><span>
</span><span id="line-311"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-var">PB.styleWidth</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PB.ConstantWidth</span></span><span> </span><span class="annot"><span class="hs-number">80</span></span><span>
</span><span id="line-312"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-313"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span>        </span><span class="annot"><span class="annottext">QType
</span><span class="hs-number">10</span></span><span>
</span><span id="line-315"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; () -&gt; Progress ()
forall s. Int -&gt; Int -&gt; s -&gt; Progress s
</span><span class="hs-identifier hs-var">PB.Progress</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Path [Note SPitch] [Edge SPitch], label)] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(Path [Note SPitch] [Edge SPitch], label)]
</span><a href="#local-6989586621679396042"><span class="hs-identifier hs-var">pieces</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-comment">-- performGC</span><span>
</span><span id="line-317"></span><span>    </span><span class="hs-comment">-- thunkCheck &lt;- noThunks [&quot;trainA2C&quot;, &quot;trainEpoch&quot;] fullstate</span><span>
</span><span id="line-318"></span><span>    </span><span class="hs-comment">-- case thunkCheck of</span><span>
</span><span id="line-319"></span><span>    </span><span class="hs-comment">--   Nothing -&gt; pure ()</span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-comment">--   Just thunkInfo -&gt; error $ &quot;Unexpected thunk at &quot; &lt;&gt; show (thunkContext thunkInfo)</span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-comment">-- run epoch</span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679396832"><span class="annot"><a href="#local-6989586621679396832"><span class="hs-identifier hs-var">state'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679396833"><span class="annot"><a href="#local-6989586621679396833"><span class="hs-identifier hs-var">rewards</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679396834"><span class="annot"><a href="#local-6989586621679396834"><span class="hs-identifier hs-var">losses</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-323"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">foldM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679396085"><span class="hs-identifier hs-type">trainPiece</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679396818"><span class="hs-identifier hs-type">pb</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679396817"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679396813"><span class="hs-identifier hs-type">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SL.Nil</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SL.Nil</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">zip</span></span><span> </span><span class="annot"><a href="#local-6989586621679396042"><span class="hs-identifier hs-type">pieces</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679396835"><span class="annot"><a href="#local-6989586621679396835"><span class="hs-identifier hs-var hs-var">rewardsHist'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(QType -&gt; List QType -&gt; List QType)
-&gt; List QType -&gt; List (List QType) -&gt; List (List QType)
forall a b c. (a -&gt; b -&gt; c) -&gt; List a -&gt; List b -&gt; List c
</span><a href="RL.Plotting.html#zipWithStrict"><span class="hs-identifier hs-var">zipWithStrict</span></a></span><span> </span><span class="annot"><span class="annottext">QType -&gt; List QType -&gt; List QType
forall a. a -&gt; List a -&gt; List a
</span><span class="hs-identifier hs-var">SL.Cons</span></span><span> </span><span class="annot"><span class="annottext">List QType
</span><a href="#local-6989586621679396833"><span class="hs-identifier hs-var">rewards</span></a></span><span> </span><span class="annot"><span class="annottext">List (List QType)
</span><a href="#local-6989586621679396814"><span class="hs-identifier hs-var">rewardsHist</span></a></span><span>
</span><span id="line-325"></span><span>        </span><span id="local-6989586621679396837"><span class="annot"><a href="#local-6989586621679396837"><span class="hs-identifier hs-var hs-var">lossHist'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(QType -&gt; List QType -&gt; List QType)
-&gt; List QType -&gt; List (List QType) -&gt; List (List QType)
forall a b c. (a -&gt; b -&gt; c) -&gt; List a -&gt; List b -&gt; List c
</span><a href="RL.Plotting.html#zipWithStrict"><span class="hs-identifier hs-var">zipWithStrict</span></a></span><span> </span><span class="annot"><span class="annottext">QType -&gt; List QType -&gt; List QType
forall a. a -&gt; List a -&gt; List a
</span><span class="hs-identifier hs-var">SL.Cons</span></span><span> </span><span class="annot"><span class="annottext">List QType
</span><a href="#local-6989586621679396834"><span class="hs-identifier hs-var">losses</span></a></span><span> </span><span class="annot"><span class="annottext">List (List QType)
</span><a href="#local-6989586621679396815"><span class="hs-identifier hs-var">lossHist</span></a></span><span>
</span><span id="line-326"></span><span>    </span><span class="hs-comment">-- compute greedy reward (&quot;accuracy&quot;)</span><span>
</span><span id="line-327"></span><span>    </span><span id="local-6989586621679396838"><span class="annot"><a href="#local-6989586621679396838"><span class="hs-identifier hs-var">accuracies'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-328"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679396817"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`mod`</span></span><span> </span><span class="annot"><span class="hs-number">10</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-329"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-330"></span><span>          </span><span id="local-6989586621679396840"><span class="annot"><a href="#local-6989586621679396840"><span class="hs-identifier hs-var">results</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.A2C.html#runAccuracy"><span class="hs-identifier hs-type">runAccuracy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679396034"><span class="hs-identifier hs-type">eval</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679396036"><span class="hs-identifier hs-type">fReward</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RL.A2C.html#a2cActor"><span class="hs-identifier hs-var">a2cActor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679396813"><span class="hs-identifier hs-type">state</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679396042"><span class="hs-identifier hs-type">pieces</span></a></span><span>
</span><span id="line-331"></span><span>          </span><span id="local-6989586621679396842"><span class="annot"><a href="#local-6989586621679396842"><span class="hs-identifier hs-var">newAccs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">zip</span></span><span> </span><span class="annot"><a href="#local-6989586621679396840"><span class="hs-identifier hs-type">results</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679396843"><span class="annot"><span class="annottext">Either String (QType, PVAnalysis SPitch)
</span><a href="#local-6989586621679396843"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679396844"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679396844"><span class="hs-identifier hs-var">j</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-332"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either String (QType, PVAnalysis SPitch)
</span><a href="#local-6989586621679396843"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-333"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679396845"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679396845"><span class="hs-identifier hs-var">error</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-334"></span><span>                </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679396845"><span class="hs-identifier hs-var">error</span></a></span><span>
</span><span id="line-335"></span><span>                </span><span class="annot"><span class="annottext">QType -&gt; IO QType
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">QType
</span><a href="RL.ModelTypes.html#inf"><span class="hs-identifier hs-var">inf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679396846"><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679396846"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Analysis</span></span><span> </span><span id="local-6989586621679396847"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679396847"><span class="hs-identifier hs-var">deriv</span></a></span></span><span> </span><span id="local-6989586621679396848"><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679396848"><span class="hs-identifier hs-var">top</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-337"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679396817"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mod`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">100</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-338"></span><span>                  </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;current best analysis (piece &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679396844"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;):&quot;</span></span><span>
</span><span id="line-339"></span><span>                  </span><span class="annot"><span class="annottext">(PVLeftmost SPitch -&gt; IO ()) -&gt; [PVLeftmost SPitch] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">PVLeftmost SPitch -&gt; IO ()
forall a. Show a =&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">print</span></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679396847"><span class="hs-identifier hs-var">deriv</span></a></span><span>
</span><span id="line-340"></span><span>                </span><span class="hs-comment">-- plotDeriv (&quot;rl/deriv&quot; &lt;&gt; show j &lt;&gt; &quot;.tex&quot;) deriv</span><span>
</span><span id="line-341"></span><span>                </span><span class="annot"><span class="annottext">QType -&gt; IO QType
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">QType
</span><a href="#local-6989586621679396846"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-342"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="RL.Plotting.html#zipWithStrict"><span class="hs-identifier hs-type">zipWithStrict</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SL.Cons</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SL.fromListReversed</span></span><span> </span><span class="annot"><a href="#local-6989586621679396842"><span class="hs-identifier hs-type">newAccs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679396816"><span class="hs-identifier hs-type">accuracies</span></a></span><span>
</span><span id="line-343"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621679396816"><span class="hs-identifier hs-type">accuracies</span></a></span><span>
</span><span id="line-344"></span><span>    </span><span class="hs-comment">-- logging</span><span>
</span><span id="line-345"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">when</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679396817"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`mod`</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-346"></span><span>      </span><span class="hs-comment">-- putStrLn $ &quot;epoch &quot; &lt;&gt; show i</span><span>
</span><span id="line-347"></span><span>      </span><span class="hs-comment">-- mapM_ print $ take 10 bcontent</span><span>
</span><span id="line-348"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679396852"><span class="annot"><a href="#local-6989586621679396852"><span class="hs-identifier hs-var hs-var">rews</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">List QType -&gt; [QType]
forall a. List a -&gt; [a]
</span><span class="hs-identifier hs-var">SL.toListReversed</span></span><span> </span><span class="annot"><span class="annottext">(List QType -&gt; [QType]) -&gt; [List QType] -&gt; [[QType]]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">List (List QType) -&gt; [List QType]
forall a. List a -&gt; [a]
</span><span class="hs-identifier hs-var">SL.toListReversed</span></span><span> </span><span class="annot"><span class="annottext">List (List QType)
</span><a href="#local-6989586621679396835"><span class="hs-identifier hs-var">rewardsHist'</span></a></span><span>
</span><span id="line-349"></span><span>          </span><span id="local-6989586621679396854"><span class="annot"><a href="#local-6989586621679396854"><span class="hs-identifier hs-var hs-var">accs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">List QType -&gt; [QType]
forall a. List a -&gt; [a]
</span><span class="hs-identifier hs-var">SL.toListReversed</span></span><span> </span><span class="annot"><span class="annottext">(List QType -&gt; [QType]) -&gt; [List QType] -&gt; [[QType]]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">List (List QType) -&gt; [List QType]
forall a. List a -&gt; [a]
</span><span class="hs-identifier hs-var">SL.toListReversed</span></span><span> </span><span class="annot"><span class="annottext">List (List QType)
</span><a href="#local-6989586621679396838"><span class="hs-identifier hs-var">accuracies'</span></a></span><span>
</span><span id="line-350"></span><span>          </span><span id="local-6989586621679396856"><span class="annot"><a href="#local-6989586621679396856"><span class="hs-identifier hs-var hs-var">losses</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">List QType -&gt; [QType]
forall a. List a -&gt; [a]
</span><span class="hs-identifier hs-var">SL.toListReversed</span></span><span> </span><span class="annot"><span class="annottext">(List QType -&gt; [QType]) -&gt; [List QType] -&gt; [[QType]]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">List (List QType) -&gt; [List QType]
forall a. List a -&gt; [a]
</span><span class="hs-identifier hs-var">SL.toListReversed</span></span><span> </span><span class="annot"><span class="annottext">List (List QType)
</span><a href="#local-6989586621679396837"><span class="hs-identifier hs-var">lossHist'</span></a></span><span>
</span><span id="line-351"></span><span>          </span><span id="local-6989586621679396859"><span class="annot"><a href="#local-6989586621679396859"><span class="hs-identifier hs-var hs-var">avgReward</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[QType] -&gt; QType
forall (t :: * -&gt; *). Foldable t =&gt; t QType -&gt; QType
</span><a href="RL.Plotting.html#mean"><span class="hs-identifier hs-var">mean</span></a></span><span> </span><span class="annot"><span class="annottext">([QType] -&gt; QType) -&gt; [[QType]] -&gt; [QType]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[[QType]] -&gt; [[QType]]
forall a. [[a]] -&gt; [[a]]
</span><span class="hs-identifier hs-var">L.transpose</span></span><span> </span><span class="annot"><span class="annottext">[[QType]]
</span><a href="#local-6989586621679396852"><span class="hs-identifier hs-var">rews</span></a></span><span>
</span><span id="line-352"></span><span>          </span><span id="local-6989586621679396865"><span class="annot"><a href="#local-6989586621679396865"><span class="hs-identifier hs-var hs-var">avgAbsLoss</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[QType] -&gt; QType
forall (t :: * -&gt; *). Foldable t =&gt; t QType -&gt; QType
</span><a href="RL.Plotting.html#mean"><span class="hs-identifier hs-var">mean</span></a></span><span> </span><span class="annot"><span class="annottext">([QType] -&gt; QType) -&gt; ([QType] -&gt; [QType]) -&gt; [QType] -&gt; QType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(QType -&gt; QType) -&gt; [QType] -&gt; [QType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">QType -&gt; QType
forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">abs</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([QType] -&gt; QType) -&gt; [[QType]] -&gt; [QType]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[[QType]] -&gt; [[QType]]
forall a. [[a]] -&gt; [[a]]
</span><span class="hs-identifier hs-var">L.transpose</span></span><span> </span><span class="annot"><span class="annottext">[[QType]]
</span><a href="#local-6989586621679396856"><span class="hs-identifier hs-var">losses</span></a></span><span>
</span><span id="line-353"></span><span>      </span><span class="annot"><a href="RL.Plotting.html#plotHistories"><span class="hs-identifier hs-type">plotHistories</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;losses&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679396856"><span class="hs-identifier hs-type">losses</span></a></span><span>
</span><span id="line-354"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679396039"><span class="hs-identifier hs-type">targets</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-355"></span><span>        </span><span class="annot"><span class="annottext">Maybe [QType]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-356"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; [[QType]] -&gt; IO ()
</span><a href="RL.Plotting.html#plotHistories"><span class="hs-identifier hs-var">plotHistories</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rewards&quot;</span></span><span> </span><span class="annot"><span class="annottext">[[QType]]
</span><a href="#local-6989586621679396852"><span class="hs-identifier hs-var">rews</span></a></span><span>
</span><span id="line-357"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; [[QType]] -&gt; IO ()
</span><a href="RL.Plotting.html#plotHistories"><span class="hs-identifier hs-var">plotHistories</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;accuracy&quot;</span></span><span> </span><span class="annot"><span class="annottext">[[QType]]
</span><a href="#local-6989586621679396854"><span class="hs-identifier hs-var">accs</span></a></span><span>
</span><span id="line-358"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679396869"><span class="annot"><span class="annottext">[QType]
</span><a href="#local-6989586621679396869"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-359"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; [QType] -&gt; [[QType]] -&gt; IO ()
</span><a href="RL.Plotting.html#plotHistories%27"><span class="hs-identifier hs-var">plotHistories'</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rewards&quot;</span></span><span> </span><span class="annot"><span class="annottext">[QType]
</span><a href="#local-6989586621679396869"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">[[QType]]
</span><a href="#local-6989586621679396852"><span class="hs-identifier hs-var">rews</span></a></span><span>
</span><span id="line-360"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; [QType] -&gt; [[QType]] -&gt; IO ()
</span><a href="RL.Plotting.html#plotHistories%27"><span class="hs-identifier hs-var">plotHistories'</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;accuracy&quot;</span></span><span> </span><span class="annot"><span class="annottext">[QType]
</span><a href="#local-6989586621679396869"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">[[QType]]
</span><a href="#local-6989586621679396854"><span class="hs-identifier hs-var">accs</span></a></span><span>
</span><span id="line-361"></span><span>      </span><span class="annot"><a href="RL.Plotting.html#plotHistory"><span class="hs-identifier hs-type">plotHistory</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;mean_reward&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679396859"><span class="hs-identifier hs-type">avgReward</span></a></span><span>
</span><span id="line-362"></span><span>      </span><span class="annot"><a href="RL.Plotting.html#plotHistory"><span class="hs-identifier hs-type">plotHistory</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;mean_loss&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679396865"><span class="hs-identifier hs-type">avgAbsLoss</span></a></span><span>
</span><span id="line-363"></span><span>      </span><span class="hs-comment">-- print $ qModelFinal2 (a2cModel state)</span><span>
</span><span id="line-364"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">TT.save</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TT.hmap'</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.ToDependent</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.flattenParameters</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="RL.A2C.html#a2cActor"><span class="hs-identifier hs-var">a2cActor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679396813"><span class="hs-identifier hs-type">state</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-string">&quot;actor_checkpoint.ht&quot;</span></span><span>
</span><span id="line-365"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">TT.save</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TT.hmap'</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.ToDependent</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TT.flattenParameters</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="RL.A2C.html#a2cCritic"><span class="hs-identifier hs-var">a2cCritic</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679396813"><span class="hs-identifier hs-type">state</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-string">&quot;critic_checkpoint.ht&quot;</span></span><span>
</span><span id="line-366"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="RL.A2C.html#A2CLoopState"><span class="hs-identifier hs-type">A2CLoopState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679396832"><span class="hs-identifier hs-type">state'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679396835"><span class="hs-identifier hs-type">rewardsHist'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679396837"><span class="hs-identifier hs-type">lossHist'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679396838"><span class="hs-identifier hs-type">accuracies'</span></a></span><span>
</span><span id="line-367"></span></pre></body></html>