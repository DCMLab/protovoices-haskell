<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE RankNTypes, NamedFieldPuns, BangPatterns,
             ExistentialQuantification, CPP, ScopedTypeVariables,
             TypeSynonymInstances, MultiParamTypeClasses,
             GeneralizedNewtypeDeriving, PackageImports,
             ParallelListComp #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-comment">{- OPTIONS_GHC -Wall -fno-warn-name-shadowing -fno-warn-unused-do-bind -}</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-comment">-- {- LANGUAGE Trustworthy -}</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- TODO: Before declaring this module TRUSTWORTHY/SAFE, we need to</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- make the IVar type abstract.</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-comment">-- | A scheduler for the Par monad based on directly performing IO</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- actions when Par methods are called (i.e. without using a lazy</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- trace data structure).</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Control.Monad.Par.Scheds.Direct</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-21"></span><span>   </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Sched"><span class="hs-identifier">Sched</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>   </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier">Par</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- abstract: Constructor not exported.</span><span>
</span><span id="line-23"></span><span>   </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier">IVar</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVarContents"><span class="hs-identifier">IVarContents</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span class="hs-comment">--    sched,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#runPar"><span class="hs-identifier">runPar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#runParIO"><span class="hs-identifier">runParIO</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#new"><span class="hs-identifier">new</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#get"><span class="hs-identifier">get</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#put_"><span class="hs-identifier">put_</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#fork"><span class="hs-identifier">fork</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#newFull"><span class="hs-identifier">newFull</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#newFull_"><span class="hs-identifier">newFull_</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#put"><span class="hs-identifier">put</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#spawn"><span class="hs-identifier">spawn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#spawn_"><span class="hs-identifier">spawn_</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#spawnP"><span class="hs-identifier">spawnP</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#spawn1_"><span class="hs-identifier">spawn1_</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#fixPar"><span class="hs-identifier">fixPar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#FixParException"><span class="hs-identifier">FixParException</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-comment">--   runParAsync, runParAsyncHelper,</span><span>
</span><span id="line-31"></span><span class="hs-comment">--   yield,</span><span>
</span><span id="line-32"></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Applicative</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">yield</span></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef</span></span><span>         </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">IORef</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">newIORef</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">readIORef</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">writeIORef</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">atomicModifyIORef</span></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Text.Printf</span></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">printf</span></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Conc</span></span><span>           </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">numCapabilities</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">yield</span></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="hs-string">&quot;mtl&quot;</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Cont</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-string">&quot;mtl&quot;</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">RD</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span>       </span><span class="annot"><span class="hs-identifier">System.Random.MWC</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Random</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>                 </span><span class="annot"><span class="hs-identifier">System.IO.Unsafe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unsafePerformIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>                 </span><span class="annot"><span class="hs-identifier">System.Mem.StableName</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">makeStableName</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">hashStableName</span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span>       </span><span class="annot"><span class="hs-identifier">Control.Monad.Par.Class</span></span><span>  </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PC</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span>       </span><span class="annot"><span class="hs-identifier">Control.Monad.Par.Unsafe</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UN</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>                 </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html"><span class="hs-identifier">Control.Monad.Par.Scheds.DirectInternal</span></a></span><span>
</span><span id="line-47"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier">Par</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Sched"><span class="hs-identifier">Sched</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#HotVar"><span class="hs-identifier">HotVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#SessionID"><span class="hs-identifier">SessionID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Session"><span class="hs-identifier">Session</span></a></span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Session"><span class="hs-identifier">Session</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>                        </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#newHotVar"><span class="hs-identifier">newHotVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#readHotVar"><span class="hs-identifier">readHotVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#modifyHotVar"><span class="hs-identifier">modifyHotVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#modifyHotVar_"><span class="hs-identifier">modifyHotVar_</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>                        </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#writeHotVarRaw"><span class="hs-identifier">writeHotVarRaw</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#fixPar"><span class="hs-identifier">fixPar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#FixParException"><span class="hs-identifier">FixParException</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-cpp">
#ifdef NEW_GENERIC
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span>       </span><span class="hs-identifier">Control.Par.Class</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PN</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span>       </span><span class="hs-identifier">Control.Par.Class.Unsafe</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PU</span><span class="hs-cpp">
#endif
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.DeepSeq</span></span><span class="hs-cpp">
#ifdef NESTED_SCHEDS
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span class="hs-cpp">
#endif
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">catMaybes</span></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Word</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Word64</span></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-comment">-- import Data.Concurrent.Deque.Class (WSDeque)</span><span class="hs-cpp">
#ifdef USE_CHASELEV
</span><span class="hs-cpp">#warning &quot;Note: using Chase-Lev lockfree workstealing deques...&quot;
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Concurrent.Deque.ChaseLev.DequeInstance</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Concurrent.Deque.ChaseLev</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">R</span><span class="hs-cpp">
#else
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Concurrent.Deque.Reference.DequeInstance</span></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Concurrent.Deque.Reference</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">R</span></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">E</span></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">null</span></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span class="hs-cpp">

#if __GLASGOW_HASKELL__ &lt;= 700
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Conc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">forkOnIO</span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span class="hs-identifier">forkOn</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">forkOnIO</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-82"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- Configuration Toggles</span><span>
</span><span id="line-84"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span class="hs-comment">-- [2012.08.30] This shows a 10X improvement on nested parfib:</span><span>
</span><span id="line-87"></span><span class="hs-comment">-- #define NESTED_SCHEDS</span><span class="hs-cpp">
#define PARPUTS
</span><span class="hs-cpp">#define FORKPARENT
</span><span class="hs-cpp">#define IDLING_ON
</span><span>   </span><span class="hs-comment">-- Next, IF idling is on, should we do wakeups?:</span><span class="hs-cpp">
#define WAKEIDLE
</span><span>
</span><span id="line-94"></span><span class="hs-comment">-- #define WAIT_FOR_WORKERS</span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-comment">-------------------------------------------------------------------</span><span>
</span><span id="line-97"></span><span class="hs-comment">-- Ifdefs for the above preprocessor defines.  Try to MINIMIZE code</span><span>
</span><span id="line-98"></span><span class="hs-comment">-- that lives in this dangerous region, and instead do normal</span><span>
</span><span id="line-99"></span><span class="hs-comment">-- conditionals and trust dead-code-elimination.</span><span>
</span><span id="line-100"></span><span class="hs-comment">--------------------------------------------------------------------</span><span class="hs-cpp">

#ifdef DEBUG_DIRECT
</span><span class="hs-cpp">#warning &quot;DEBUG: Activating debugging for Direct.hs&quot;
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Debug.Trace</span><span>        </span><span class="hs-special">(</span><span class="hs-identifier">trace</span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Environment</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">getEnvironment</span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span class="hs-identifier">theEnv</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unsafePerformIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">getEnvironment</span><span>
</span><span id="line-107"></span><span class="hs-identifier">dbg</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">True</span><span>
</span><span id="line-108"></span><span class="hs-identifier">dbglvl</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span class="hs-cpp">
#else
</span><span id="dbg"><span class="annot"><span class="annottext">dbg :: Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var hs-var">dbg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-111"></span><span id="dbglvl"><span class="annot"><span class="annottext">dbglvl :: Int
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbglvl"><span class="hs-identifier hs-var hs-var">dbglvl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-cpp">
#endif
</span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-type">dbg</span></a></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-114"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#dbglvl"><span class="hs-identifier hs-type">dbglvl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#_PARPUTS"><span class="hs-identifier hs-type">_PARPUTS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-cpp">
#ifdef PARPUTS
</span><span id="_PARPUTS"><span class="annot"><span class="annottext">_PARPUTS :: Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#_PARPUTS"><span class="hs-identifier hs-var hs-var">_PARPUTS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-cpp">
#else
</span><span class="hs-identifier">_PARPUTS</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">False</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-123"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#_FORKPARENT"><span class="hs-identifier hs-type">_FORKPARENT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-cpp">
#ifdef FORKPARENT
</span><span id="_FORKPARENT"><span class="annot"><span class="annottext">_FORKPARENT :: Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#_FORKPARENT"><span class="hs-identifier hs-var hs-var">_FORKPARENT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-cpp">
#else
</span><span class="hs-cpp">#warning &quot;FORKPARENT POLICY NOT USED; THIS IS GENERALLY WORSE&quot;
</span><span class="hs-identifier">_FORKPARENT</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">False</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-131"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#_IDLING_ON"><span class="hs-identifier hs-type">_IDLING_ON</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-cpp">
#ifdef IDLING_ON
</span><span id="_IDLING_ON"><span class="annot"><span class="annottext">_IDLING_ON :: Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#_IDLING_ON"><span class="hs-identifier hs-var hs-var">_IDLING_ON</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-cpp">
#else
</span><span class="hs-identifier">_IDLING_ON</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">False</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-138"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#_WAIT_FOR_WORKERS"><span class="hs-identifier hs-type">_WAIT_FOR_WORKERS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-cpp">
#ifdef WAIT_FOR_WORKERS
</span><span class="hs-identifier">_WAIT_FOR_WORKERS</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">True</span><span class="hs-cpp">
#else
</span><span id="_WAIT_FOR_WORKERS"><span class="annot"><span class="annottext">_WAIT_FOR_WORKERS :: Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#_WAIT_FOR_WORKERS"><span class="hs-identifier hs-var hs-var">_WAIT_FOR_WORKERS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- Core type definitions</span><span>
</span><span id="line-149"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span class="hs-keyword">type</span><span> </span><span id="ROnly"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#ROnly"><span class="hs-identifier hs-var">ROnly</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RD.ReaderT</span></span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Sched"><span class="hs-identifier hs-type">Sched</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="hs-keyword">newtype</span><span> </span><span id="IVar"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-var">IVar</span></a></span></span><span> </span><span id="local-6989586621679060499"><span class="annot"><a href="#local-6989586621679060499"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="IVar"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-var">IVar</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVarContents"><span class="hs-identifier hs-type">IVarContents</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060499"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span class="hs-keyword">data</span><span> </span><span id="IVarContents"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVarContents"><span class="hs-identifier hs-var">IVarContents</span></a></span></span><span> </span><span id="local-6989586621679060500"><span class="annot"><a href="#local-6989586621679060500"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Full"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#Full"><span class="hs-identifier hs-var">Full</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679060500"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Empty"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#Empty"><span class="hs-identifier hs-var">Empty</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Blocked"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#Blocked"><span class="hs-identifier hs-var">Blocked</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679060500"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span id="local-6989586621679060607"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#unsafeParIO"><span class="hs-identifier hs-type">unsafeParIO</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679060607"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060607"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-158"></span><span id="unsafeParIO"><span class="annot"><span class="annottext">unsafeParIO :: IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#unsafeParIO"><span class="hs-identifier hs-var hs-var">unsafeParIO</span></a></span></span><span> </span><span id="local-6989586621679060354"><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679060354"><span class="hs-identifier hs-var">iom</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ContT () ROnly a -&gt; Par a
forall a. ContT () ROnly a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-var">Par</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReaderT Sched IO a -&gt; ContT () ROnly a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span class="annot"><span class="annottext">(ReaderT Sched IO a -&gt; ContT () ROnly a)
-&gt; ReaderT Sched IO a -&gt; ContT () ROnly a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO a -&gt; ReaderT Sched IO a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679060354"><span class="hs-identifier hs-var">iom</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span id="local-6989586621679060351"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#io"><span class="hs-identifier hs-type">io</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679060351"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060351"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-161"></span><span id="io"><span class="annot"><span class="annottext">io :: IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#io"><span class="hs-identifier hs-var hs-var">io</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; Par a
forall a. IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#unsafeParIO"><span class="hs-identifier hs-var">unsafeParIO</span></a></span><span> </span><span class="hs-comment">-- shorthand used below</span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-164"></span><span class="hs-comment">-- Global State</span><span>
</span><span id="line-165"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span class="hs-comment">-- This keeps track of ALL worker threads across all unreated</span><span>
</span><span id="line-168"></span><span class="hs-comment">-- `runPar` instantiations.  This is used to detect nested invocations</span><span>
</span><span id="line-169"></span><span class="hs-comment">-- of `runPar` and avoid reinitialization.</span><span>
</span><span id="line-170"></span><span class="hs-comment">-- globalWorkerPool :: IORef (Data.IntMap ())</span><span class="hs-cpp">
#ifdef NESTED_SCHEDS
</span><span class="hs-identifier">globalWorkerPool</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">M.Map</span><span> </span><span class="hs-identifier">ThreadId</span><span> </span><span class="hs-identifier">Sched</span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span class="hs-identifier">globalWorkerPool</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unsafePerformIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">newIORef</span><span> </span><span class="hs-identifier">M.empty</span><span class="hs-cpp">
#endif
</span><span class="hs-comment">-- TODO! Make this semi-local! (not shared between &quot;top-level&quot; runPars)</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#amINested"><span class="hs-pragma hs-type">amINested</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-178"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#registerWorker"><span class="hs-pragma hs-type">registerWorker</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-179"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#unregisterWorker"><span class="hs-pragma hs-type">unregisterWorker</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-180"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#amINested"><span class="hs-identifier hs-type">amINested</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Sched"><span class="hs-identifier hs-type">Sched</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#registerWorker"><span class="hs-identifier hs-type">registerWorker</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Sched"><span class="hs-identifier hs-type">Sched</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#unregisterWorker"><span class="hs-identifier hs-type">unregisterWorker</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">
#ifdef NESTED_SCHEDS
</span><span class="hs-comment">-- | If the current threadID is ALREADY a worker, return the corresponding Sched structure.</span><span>
</span><span id="line-185"></span><span class="hs-identifier">amINested</span><span> </span><span class="hs-identifier">tid</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-comment">-- There is no race here.  Each thread inserts itself before it</span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-comment">-- becomes an active worker.</span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-identifier">wp</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">readIORef</span><span> </span><span class="hs-identifier">globalWorkerPool</span><span>
</span><span id="line-189"></span><span>  </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">M.lookup</span><span> </span><span class="hs-identifier">tid</span><span> </span><span class="hs-identifier">wp</span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span class="hs-identifier">registerWorker</span><span> </span><span class="hs-identifier">tid</span><span> </span><span class="hs-identifier">sched</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-identifier">atomicModifyIORef</span><span> </span><span class="hs-identifier">globalWorkerPool</span><span> </span><span class="hs-operator">$</span><span>
</span><span id="line-192"></span><span>    </span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">mp</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">M.insert</span><span> </span><span class="hs-identifier">tid</span><span> </span><span class="hs-identifier">sched</span><span> </span><span class="hs-identifier">mp</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span class="hs-identifier">unregisterWorker</span><span> </span><span class="hs-identifier">tid</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-194"></span><span>  </span><span class="hs-identifier">atomicModifyIORef</span><span> </span><span class="hs-identifier">globalWorkerPool</span><span> </span><span class="hs-operator">$</span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">mp</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">M.delete</span><span> </span><span class="hs-identifier">tid</span><span> </span><span class="hs-identifier">mp</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-cpp">
#else
</span><span id="amINested"><span class="annot"><span class="annottext">amINested :: ThreadId -&gt; IO (Maybe Sched)
</span><a href="Control.Monad.Par.Scheds.Direct.html#amINested"><span class="hs-identifier hs-var hs-var">amINested</span></a></span></span><span>      </span><span class="annot"><span class="annottext">ThreadId
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Sched -&gt; IO (Maybe Sched)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Sched
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-198"></span><span id="registerWorker"><span class="annot"><span class="annottext">registerWorker :: ThreadId -&gt; Sched -&gt; IO ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#registerWorker"><span class="hs-identifier hs-var hs-var">registerWorker</span></a></span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Sched
</span><span class="hs-identifier">_</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span id="unregisterWorker"><span class="annot"><span class="annottext">unregisterWorker :: ThreadId -&gt; IO ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#unregisterWorker"><span class="hs-identifier hs-var hs-var">unregisterWorker</span></a></span></span><span> </span><span id="local-6989586621679060346"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060346"><span class="hs-identifier hs-var">_tid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-202"></span><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><span id="line-203"></span><span class="hs-comment">-- Helpers #2:  Pushing and popping work.</span><span>
</span><span id="line-204"></span><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#popWork"><span class="hs-pragma hs-type">popWork</span></a></span><span>  </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-207"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#popWork"><span class="hs-identifier hs-type">popWork</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Sched"><span class="hs-identifier hs-type">Sched</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span id="popWork"><span class="annot"><span class="annottext">popWork :: Sched -&gt; IO (Maybe (Par ()))
</span><a href="Control.Monad.Par.Scheds.Direct.html#popWork"><span class="hs-identifier hs-var hs-var">popWork</span></a></span></span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Sched"><span class="hs-identifier hs-type">Sched</span></a></span><span class="hs-special">{</span><span> </span><span id="local-6989586621679060343"><span class="annot"><span class="annottext">WSDeque (Par ())
workpool :: Sched -&gt; WSDeque (Par ())
workpool :: WSDeque (Par ())
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#workpool"><span class="hs-identifier hs-var hs-var">workpool</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679060341"><span class="annot"><span class="annottext">Int
no :: Sched -&gt; Int
no :: Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var hs-var">no</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-209"></span><span>  </span><span id="local-6989586621679060339"><span class="annot"><span class="annottext">Maybe (Par ())
</span><a href="#local-6989586621679060339"><span class="hs-identifier hs-var">mb</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleDeque (Par ()) -&gt; IO (Maybe (Par ()))
forall a. SimpleDeque a -&gt; IO (Maybe a)
</span><span class="hs-identifier hs-var">R.tryPopL</span></span><span> </span><span class="annot"><span class="annottext">SimpleDeque (Par ())
WSDeque (Par ())
</span><a href="#local-6989586621679060343"><span class="hs-identifier hs-var">workpool</span></a></span><span>
</span><span id="line-210"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Par ())
</span><a href="#local-6989586621679060339"><span class="hs-identifier hs-var">mb</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-211"></span><span>         </span><span class="annot"><span class="annottext">Maybe (Par ())
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Par ()
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679060336"><span class="annot"><span class="annottext">StableName (Maybe (Par ()))
</span><a href="#local-6989586621679060336"><span class="hs-identifier hs-var">sn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (Par ()) -&gt; IO (StableName (Maybe (Par ())))
forall a. a -&gt; IO (StableName a)
</span><span class="hs-identifier hs-var">makeStableName</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Par ())
</span><a href="#local-6989586621679060339"><span class="hs-identifier hs-var">mb</span></a></span><span>
</span><span id="line-213"></span><span>                       </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; Int -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d]                                   -&gt; POP work unit %d\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060341"><span class="hs-identifier hs-var">no</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StableName (Maybe (Par ())) -&gt; Int
forall a. StableName a -&gt; Int
</span><span class="hs-identifier hs-var">hashStableName</span></span><span> </span><span class="annot"><span class="annottext">StableName (Maybe (Par ()))
</span><a href="#local-6989586621679060336"><span class="hs-identifier hs-var">sn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><span class="annottext">Maybe (Par ()) -&gt; IO (Maybe (Par ()))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Par ())
</span><a href="#local-6989586621679060339"><span class="hs-identifier hs-var">mb</span></a></span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#pushWork"><span class="hs-pragma hs-type">pushWork</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-217"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#pushWork"><span class="hs-identifier hs-type">pushWork</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Sched"><span class="hs-identifier hs-type">Sched</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span id="pushWork"><span class="annot"><span class="annottext">pushWork :: Sched -&gt; Par () -&gt; IO ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#pushWork"><span class="hs-identifier hs-var hs-var">pushWork</span></a></span></span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Sched"><span class="hs-identifier hs-type">Sched</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679060334"><span class="annot"><span class="annottext">WSDeque (Par ())
workpool :: WSDeque (Par ())
workpool :: Sched -&gt; WSDeque (Par ())
</span><a href="#local-6989586621679060334"><span class="hs-identifier hs-var hs-var">workpool</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679060333"><span class="annot"><span class="annottext">HotVar [MVar Bool]
idle :: Sched -&gt; HotVar [MVar Bool]
idle :: HotVar [MVar Bool]
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#idle"><span class="hs-identifier hs-var hs-var">idle</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679060331"><span class="annot"><span class="annottext">Int
no :: Int
no :: Sched -&gt; Int
</span><a href="#local-6989586621679060331"><span class="hs-identifier hs-var hs-var">no</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679060330"><span class="annot"><span class="annottext">Par ()
</span><a href="#local-6989586621679060330"><span class="hs-identifier hs-var">task</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-219"></span><span>  </span><span class="annot"><span class="annottext">SimpleDeque (Par ()) -&gt; Par () -&gt; IO ()
forall t. SimpleDeque t -&gt; t -&gt; IO ()
</span><span class="hs-identifier hs-var">R.pushL</span></span><span> </span><span class="annot"><span class="annottext">SimpleDeque (Par ())
WSDeque (Par ())
</span><a href="#local-6989586621679060334"><span class="hs-identifier hs-var">workpool</span></a></span><span> </span><span class="annot"><span class="annottext">Par ()
</span><a href="#local-6989586621679060330"><span class="hs-identifier hs-var">task</span></a></span><span>
</span><span id="line-220"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679060328"><span class="annot"><span class="annottext">StableName (Par ())
</span><a href="#local-6989586621679060328"><span class="hs-identifier hs-var">sn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Par () -&gt; IO (StableName (Par ()))
forall a. a -&gt; IO (StableName a)
</span><span class="hs-identifier hs-var">makeStableName</span></span><span> </span><span class="annot"><span class="annottext">Par ()
</span><a href="#local-6989586621679060330"><span class="hs-identifier hs-var">task</span></a></span><span>
</span><span id="line-221"></span><span>                </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; Int -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d]                                   -&gt; PUSH work unit %d\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060331"><span class="hs-identifier hs-var">no</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StableName (Par ()) -&gt; Int
forall a. StableName a -&gt; Int
</span><span class="hs-identifier hs-var">hashStableName</span></span><span> </span><span class="annot"><span class="annottext">StableName (Par ())
</span><a href="#local-6989586621679060328"><span class="hs-identifier hs-var">sn</span></a></span><span class="hs-special">)</span><span class="hs-cpp">
#if  defined(IDLING_ON) &amp;&amp; defined(WAKEIDLE)
</span><span>  </span><span class="hs-comment">--when isMain$    -- Experimenting with reducing contention by doing this only from a single thread.</span><span>
</span><span id="line-224"></span><span>                    </span><span class="hs-comment">-- TODO: We need to have a proper binary wakeup-tree.</span><span>
</span><span id="line-225"></span><span>  </span><span class="annot"><span class="annottext">HotVar [MVar Bool] -&gt; IO ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#tryWakeIdle"><span class="hs-identifier hs-var">tryWakeIdle</span></a></span><span> </span><span class="annot"><span class="annottext">HotVar [MVar Bool]
</span><a href="#local-6989586621679060333"><span class="hs-identifier hs-var">idle</span></a></span><span class="hs-cpp">
#endif
</span><span>  </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#tryWakeIdle"><span class="hs-identifier hs-type">tryWakeIdle</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#HotVar"><span class="hs-identifier hs-type">HotVar</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-230"></span><span id="tryWakeIdle"><span class="annot"><span class="annottext">tryWakeIdle :: HotVar [MVar Bool] -&gt; IO ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#tryWakeIdle"><span class="hs-identifier hs-var hs-var">tryWakeIdle</span></a></span></span><span> </span><span id="local-6989586621679060326"><span class="annot"><span class="annottext">HotVar [MVar Bool]
</span><a href="#local-6989586621679060326"><span class="hs-identifier hs-var">idle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-231"></span><span class="hs-comment">-- NOTE: I worry about having the idle var hammmered by all threads on their spawn-path:</span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-comment">-- If any worker is idle, wake one up and give it work to do.</span><span>
</span><span id="line-233"></span><span>  </span><span id="local-6989586621679060325"><span class="annot"><span class="annottext">[MVar Bool]
</span><a href="#local-6989586621679060325"><span class="hs-identifier hs-var">idles</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HotVar [MVar Bool] -&gt; IO [MVar Bool]
forall a. HotVar a -&gt; IO a
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#readHotVar"><span class="hs-identifier hs-var">readHotVar</span></a></span><span> </span><span class="annot"><span class="annottext">HotVar [MVar Bool]
</span><a href="#local-6989586621679060326"><span class="hs-identifier hs-var">idle</span></a></span><span> </span><span class="hs-comment">-- Optimistically do a normal read first.</span><span>
</span><span id="line-234"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[MVar Bool] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">Prelude.null</span></span><span> </span><span class="annot"><span class="annottext">[MVar Bool]
</span><a href="#local-6989586621679060325"><span class="hs-identifier hs-var">idles</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-235"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Waking %d idle thread(s).\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[MVar Bool] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[MVar Bool]
</span><a href="#local-6989586621679060325"><span class="hs-identifier hs-var">idles</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span>    </span><span id="local-6989586621679060322"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679060322"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HotVar [MVar Bool]
-&gt; ([MVar Bool] -&gt; ([MVar Bool], IO ())) -&gt; IO (IO ())
forall a b. HotVar a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#modifyHotVar"><span class="hs-identifier hs-var">modifyHotVar</span></a></span><span> </span><span class="annot"><span class="annottext">HotVar [MVar Bool]
</span><a href="#local-6989586621679060326"><span class="hs-identifier hs-var">idle</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679060321"><span class="annot"><span class="annottext">[MVar Bool]
</span><a href="#local-6989586621679060321"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[MVar Bool]
</span><a href="#local-6989586621679060321"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-237"></span><span>                             </span><span class="hs-special">[</span><span class="hs-special">]</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>                             </span><span class="hs-special">(</span><span id="local-6989586621679060320"><span class="annot"><span class="annottext">MVar Bool
</span><a href="#local-6989586621679060320"><span class="hs-identifier hs-var">i</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679060319"><span class="annot"><span class="annottext">[MVar Bool]
</span><a href="#local-6989586621679060319"><span class="hs-identifier hs-var">ils</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[MVar Bool]
</span><a href="#local-6989586621679060319"><span class="hs-identifier hs-var">ils</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MVar Bool -&gt; Bool -&gt; IO ()
forall a. MVar a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">putMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar Bool
</span><a href="#local-6989586621679060320"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>    </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679060322"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-comment">-- wake an idle worker up by putting an MVar.</span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#rand"><span class="hs-identifier hs-type">rand</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#HotVar"><span class="hs-identifier hs-type">HotVar</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Random.GenIO</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-242"></span><span id="rand"><span class="annot"><span class="annottext">rand :: HotVar GenIO -&gt; IO Int
</span><a href="Control.Monad.Par.Scheds.Direct.html#rand"><span class="hs-identifier hs-var hs-var">rand</span></a></span></span><span> </span><span id="local-6989586621679060316"><span class="annot"><span class="annottext">HotVar GenIO
</span><a href="#local-6989586621679060316"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int, Int) -&gt; GenIO -&gt; IO Int
forall a (m :: * -&gt; *).
(Variate a, PrimMonad m) =&gt;
(a, a) -&gt; Gen (PrimState m) -&gt; m a
</span><span class="hs-identifier hs-var">Random.uniformR</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier hs-var">numCapabilities</span></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Gen RealWorld -&gt; IO Int) -&gt; IO (Gen RealWorld) -&gt; IO Int
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">HotVar (Gen RealWorld) -&gt; IO (Gen RealWorld)
forall a. HotVar a -&gt; IO a
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#readHotVar"><span class="hs-identifier hs-var">readHotVar</span></a></span><span> </span><span class="annot"><span class="annottext">HotVar (Gen RealWorld)
HotVar GenIO
</span><a href="#local-6989586621679060316"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-245"></span><span class="hs-comment">-- Running computations in the Par monad</span><span>
</span><span id="line-246"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span id="local-6989586621679060313"><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NFData</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060313"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-249"></span><span>  </span><span id="local-6989586621679060310"><span class="annot"><span class="annottext">rnf :: IVar a -&gt; ()
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">rnf</span></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">IVar a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#runPar"><span class="hs-pragma hs-type">runPar</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-252"></span><span id="runPar"><span class="annot"><span class="annottext">runPar :: Par a -&gt; a
</span><a href="Control.Monad.Par.Scheds.Direct.html#runPar"><span class="hs-identifier hs-var hs-var">runPar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; a
forall a. IO a -&gt; a
</span><span class="hs-identifier hs-var">unsafePerformIO</span></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; a) -&gt; (Par a -&gt; IO a) -&gt; Par a -&gt; a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Par a -&gt; IO a
forall a. Par a -&gt; IO a
</span><a href="Control.Monad.Par.Scheds.Direct.html#runParIO"><span class="hs-identifier hs-var">runParIO</span></a></span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span class="hs-comment">-- | This procedure creates a new worker on the current thread (with a</span><span>
</span><span id="line-256"></span><span class="hs-comment">--   new session ID) and plugs it into the work-stealing environment.</span><span>
</span><span id="line-257"></span><span class="hs-comment">--   This new worker extracts itself from the work stealing pool when</span><span>
</span><span id="line-258"></span><span class="hs-comment">--   `userComp` has completed, thus freeing the current thread (this</span><span>
</span><span id="line-259"></span><span class="hs-comment">--   procedure) to return normally.</span><span>
</span><span id="line-260"></span><span id="local-6989586621679060529"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#runNewSessionAndWait"><span class="hs-identifier hs-type">runNewSessionAndWait</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Sched"><span class="hs-identifier hs-type">Sched</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060529"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679060529"><span class="hs-identifier hs-type">b</span></a></span></span><span>
</span><span id="line-261"></span><span id="runNewSessionAndWait"><span class="annot"><span class="annottext">runNewSessionAndWait :: String -&gt; Sched -&gt; Par b -&gt; IO b
</span><a href="Control.Monad.Par.Scheds.Direct.html#runNewSessionAndWait"><span class="hs-identifier hs-var hs-var">runNewSessionAndWait</span></a></span></span><span> </span><span id="local-6989586621679060306"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679060306"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679060305"><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060305"><span class="hs-identifier hs-var">sched</span></a></span></span><span> </span><span id="local-6989586621679060304"><span class="annot"><span class="annottext">Par b
</span><a href="#local-6989586621679060304"><span class="hs-identifier hs-var">userComp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-262"></span><span>    </span><span id="local-6989586621679060303"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060303"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span> </span><span class="hs-comment">-- TODO: remove when done debugging</span><span>
</span><span id="line-263"></span><span>    </span><span id="local-6989586621679060301"><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060301"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HotVar SessionID
-&gt; (SessionID -&gt; (SessionID, SessionID)) -&gt; IO SessionID
forall a b. HotVar a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#modifyHotVar"><span class="hs-identifier hs-var">modifyHotVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; HotVar SessionID
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#sessionCounter"><span class="hs-identifier hs-var hs-var">sessionCounter</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060305"><span class="hs-identifier hs-var">sched</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621679060299"><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060299"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060299"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">SessionID -&gt; SessionID -&gt; SessionID
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">SessionID
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060299"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>    </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HotVar (Set SessionID)
-&gt; (Set SessionID -&gt; (Set SessionID, ())) -&gt; IO ()
forall a b. HotVar a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#modifyHotVar"><span class="hs-identifier hs-var">modifyHotVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; HotVar (Set SessionID)
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#activeSessions"><span class="hs-identifier hs-var hs-var">activeSessions</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060305"><span class="hs-identifier hs-var">sched</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621679060296"><span class="annot"><span class="annottext">Set SessionID
</span><a href="#local-6989586621679060296"><span class="hs-identifier hs-var">set</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SessionID -&gt; Set SessionID -&gt; Set SessionID
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.insert</span></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060301"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">Set SessionID
</span><a href="#local-6989586621679060296"><span class="hs-identifier hs-var">set</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span>    </span><span class="hs-comment">-- Here we have an extra IORef... ugly.</span><span>
</span><span id="line-267"></span><span>    </span><span id="local-6989586621679060294"><span class="annot"><span class="annottext">IORef b
</span><a href="#local-6989586621679060294"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">b -&gt; IO (IORef b)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; b
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span class="annot"><span class="annottext">(String -&gt; b) -&gt; String -&gt; b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Empty session-result ref (&quot;</span></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679060306"><span class="hs-identifier hs-var">name</span></a></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;) should never be touched (sid &quot;</span></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">SessionID -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060301"><span class="hs-identifier hs-var">sid</span></a></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, &quot;</span></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060303"><span class="hs-identifier hs-var">tid</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;)&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>    </span><span id="local-6989586621679060291"><span class="annot"><span class="annottext">HotVar Bool
</span><a href="#local-6989586621679060291"><span class="hs-identifier hs-var">newFlag</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (HotVar Bool)
forall a. a -&gt; IO (IORef a)
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#newHotVar"><span class="hs-identifier hs-var">newHotVar</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-269"></span><span>    </span><span class="hs-comment">-- Push the new session:</span><span>
</span><span id="line-270"></span><span>    </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HotVar [Session] -&gt; ([Session] -&gt; ([Session], ())) -&gt; IO ()
forall a b. HotVar a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#modifyHotVar"><span class="hs-identifier hs-var">modifyHotVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; HotVar [Session]
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#sessions"><span class="hs-identifier hs-var hs-var">sessions</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060305"><span class="hs-identifier hs-var">sched</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621679060289"><span class="annot"><span class="annottext">[Session]
</span><a href="#local-6989586621679060289"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">SessionID -&gt; HotVar Bool -&gt; Session
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#Session"><span class="hs-identifier hs-var">Session</span></a></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060301"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">HotVar Bool
</span><a href="#local-6989586621679060291"><span class="hs-identifier hs-var">newFlag</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Session -&gt; [Session] -&gt; [Session]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Session]
</span><a href="#local-6989586621679060289"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679060288"><span class="annot"><span class="annottext">userComp' :: Par ()
</span><a href="#local-6989586621679060288"><span class="hs-identifier hs-var hs-var">userComp'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Par () -&gt; Par ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span class="annot"><span class="annottext">(Par () -&gt; Par ()) -&gt; Par () -&gt; Par ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Par ()
forall a. IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#io"><span class="hs-identifier hs-var">io</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; Par ()) -&gt; IO () -&gt; Par ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-273"></span><span>                           </span><span id="local-6989586621679060287"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060287"><span class="hs-identifier hs-var">tid2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-274"></span><span>                           </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; String -&gt; String -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d %s] Starting Par computation on %s.\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var hs-var">no</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060305"><span class="hs-identifier hs-var">sched</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060287"><span class="hs-identifier hs-var">tid2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679060306"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-275"></span><span>                       </span><span id="local-6989586621679060286"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679060286"><span class="hs-identifier hs-var">ans</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Par b
</span><a href="#local-6989586621679060304"><span class="hs-identifier hs-var">userComp</span></a></span><span>
</span><span id="line-276"></span><span>                       </span><span class="hs-comment">-- This add-on to userComp will run only after userComp has completed successfully,</span><span>
</span><span id="line-277"></span><span>                       </span><span class="hs-comment">-- but that does NOT guarantee that userComp-forked computations have terminated:</span><span>
</span><span id="line-278"></span><span>                       </span><span class="annot"><span class="annottext">IO () -&gt; Par ()
forall a. IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#io"><span class="hs-identifier hs-var">io</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; Par ()) -&gt; IO () -&gt; Par ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbglvl"><span class="hs-identifier hs-var">dbglvl</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-279"></span><span>                                </span><span id="local-6989586621679060285"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060285"><span class="hs-identifier hs-var">tid3</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-280"></span><span>                                </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; String -&gt; String -&gt; SessionID -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d %s] Continuation for %s called, finishing it up (%d)...\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var hs-var">no</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060305"><span class="hs-identifier hs-var">sched</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060285"><span class="hs-identifier hs-var">tid3</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679060306"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060301"><span class="hs-identifier hs-var">sid</span></a></span><span>
</span><span id="line-281"></span><span>                              </span><span class="annot"><span class="annottext">IORef b -&gt; b -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef b
</span><a href="#local-6989586621679060294"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679060286"><span class="hs-identifier hs-var">ans</span></a></span><span>
</span><span id="line-282"></span><span>                              </span><span class="annot"><span class="annottext">HotVar Bool -&gt; Bool -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#writeHotVarRaw"><span class="hs-identifier hs-var">writeHotVarRaw</span></a></span><span> </span><span class="annot"><span class="annottext">HotVar Bool
</span><a href="#local-6989586621679060291"><span class="hs-identifier hs-var">newFlag</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-283"></span><span>                              </span><span class="annot"><span class="annottext">HotVar (Set SessionID)
-&gt; (Set SessionID -&gt; (Set SessionID, ())) -&gt; IO ()
forall a b. HotVar a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#modifyHotVar"><span class="hs-identifier hs-var">modifyHotVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; HotVar (Set SessionID)
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#activeSessions"><span class="hs-identifier hs-var hs-var">activeSessions</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060305"><span class="hs-identifier hs-var">sched</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621679060284"><span class="annot"><span class="annottext">Set SessionID
</span><a href="#local-6989586621679060284"><span class="hs-identifier hs-var">set</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SessionID -&gt; Set SessionID -&gt; Set SessionID
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.delete</span></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060301"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">Set SessionID
</span><a href="#local-6989586621679060284"><span class="hs-identifier hs-var">set</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>        </span><span id="local-6989586621679060533"><span class="annot"><a href="#local-6989586621679060282"><span class="hs-identifier hs-type">kont</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679060533"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#ROnly"><span class="hs-identifier hs-type">ROnly</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-285"></span><span>        </span><span id="local-6989586621679060282"><span class="annot"><span class="annottext">kont :: SessionID -&gt; a -&gt; ROnly ()
</span><a href="#local-6989586621679060282"><span class="hs-identifier hs-var hs-var">kont</span></a></span></span><span> </span><span id="local-6989586621679060281"><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060281"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; a -&gt; ROnly ()
forall a. String -&gt; a -&gt; ROnly ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#trivialCont"><span class="hs-identifier hs-var">trivialCont</span></a></span><span class="annot"><span class="annottext">(String -&gt; a -&gt; ROnly ()) -&gt; String -&gt; a -&gt; ROnly ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;(&quot;</span></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679060306"><span class="hs-identifier hs-var">name</span></a></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, sid &quot;</span></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">SessionID -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060301"><span class="hs-identifier hs-var">sid</span></a></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, round &quot;</span></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">SessionID -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060281"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;)&quot;</span></span><span>
</span><span id="line-286"></span><span>        </span><span class="annot"><a href="#local-6989586621679060279"><span class="hs-identifier hs-type">loop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#ROnly"><span class="hs-identifier hs-type">ROnly</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>        </span><span id="local-6989586621679060279"><span class="annot"><span class="annottext">loop :: SessionID -&gt; ROnly ()
</span><a href="#local-6989586621679060279"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621679060278"><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060278"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679060277"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679060277"><span class="hs-identifier hs-var">flg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Bool -&gt; ReaderT Sched IO Bool
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span class="annot"><span class="annottext">(IO Bool -&gt; ReaderT Sched IO Bool)
-&gt; IO Bool -&gt; ReaderT Sched IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HotVar Bool -&gt; IO Bool
forall a. HotVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">HotVar Bool
</span><a href="#local-6989586621679060291"><span class="hs-identifier hs-var">newFlag</span></a></span><span>
</span><span id="line-288"></span><span>                    </span><span class="annot"><span class="annottext">Bool -&gt; ROnly () -&gt; ROnly ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679060277"><span class="hs-identifier hs-var">flg</span></a></span><span> </span><span class="annot"><span class="annottext">(ROnly () -&gt; ROnly ()) -&gt; ROnly () -&gt; ROnly ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-289"></span><span>                      </span><span class="annot"><span class="annottext">Bool -&gt; ROnly () -&gt; ROnly ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span> </span><span class="annot"><span class="annottext">(ROnly () -&gt; ROnly ()) -&gt; ROnly () -&gt; ROnly ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; ROnly ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span class="annot"><span class="annottext">(IO () -&gt; ROnly ()) -&gt; IO () -&gt; ROnly ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-290"></span><span>                        </span><span id="local-6989586621679060274"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060274"><span class="hs-identifier hs-var">tid4</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-291"></span><span>                        </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; String -&gt; SessionID -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d %s] BOUNCE %d... going into reschedule until finished.\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var hs-var">no</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060305"><span class="hs-identifier hs-var">sched</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060274"><span class="hs-identifier hs-var">tid4</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060278"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-292"></span><span>                      </span><span class="annot"><span class="annottext">SessionID -&gt; (Any -&gt; ROnly ()) -&gt; ROnly ()
forall a. SessionID -&gt; (a -&gt; ROnly ()) -&gt; ROnly ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#rescheduleR"><span class="hs-identifier hs-var">rescheduleR</span></a></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">((Any -&gt; ROnly ()) -&gt; ROnly ()) -&gt; (Any -&gt; ROnly ()) -&gt; ROnly ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Any -&gt; ROnly ()
forall a. String -&gt; a -&gt; ROnly ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#trivialCont"><span class="hs-identifier hs-var">trivialCont</span></a></span><span class="annot"><span class="annottext">(String -&gt; Any -&gt; ROnly ()) -&gt; String -&gt; Any -&gt; ROnly ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;(&quot;</span></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679060306"><span class="hs-identifier hs-var">name</span></a></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, sid &quot;</span></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">SessionID -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060301"><span class="hs-identifier hs-var">sid</span></a></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;)&quot;</span></span><span>
</span><span id="line-293"></span><span>                      </span><span class="annot"><span class="annottext">SessionID -&gt; ROnly ()
</span><a href="#local-6989586621679060279"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060278"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">SessionID -&gt; SessionID -&gt; SessionID
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">SessionID
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-comment">-- THIS IS RETURNING TOO EARLY!!:</span><span>
</span><span id="line-296"></span><span>    </span><span class="annot"><span class="annottext">Sched -&gt; ROnly () -&gt; IO ()
forall r (m :: * -&gt; *) a. r -&gt; ReaderT r m a -&gt; m a
</span><a href="Control.Monad.Par.Scheds.Direct.html#runReaderWith"><span class="hs-identifier hs-var">runReaderWith</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060305"><span class="hs-identifier hs-var">sched</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ContT () ROnly () -&gt; (() -&gt; ROnly ()) -&gt; ROnly ()
forall k (r :: k) (m :: k -&gt; *) a. ContT r m a -&gt; (a -&gt; m r) -&gt; m r
</span><span class="hs-identifier hs-var hs-var">C.runContT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Par () -&gt; ContT () ROnly ()
forall a. Par a -&gt; ContT () ROnly a
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#unPar"><span class="hs-identifier hs-var hs-var">unPar</span></a></span><span> </span><span class="annot"><span class="annottext">Par ()
</span><a href="#local-6989586621679060288"><span class="hs-identifier hs-var">userComp'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SessionID -&gt; () -&gt; ROnly ()
forall a. SessionID -&gt; a -&gt; ROnly ()
</span><a href="#local-6989586621679060282"><span class="hs-identifier hs-var">kont</span></a></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Does this ASSUME child stealing?</span><span>
</span><span id="line-297"></span><span>    </span><span class="annot"><span class="annottext">Sched -&gt; ROnly () -&gt; IO ()
forall r (m :: * -&gt; *) a. r -&gt; ReaderT r m a -&gt; m a
</span><a href="Control.Monad.Par.Scheds.Direct.html#runReaderWith"><span class="hs-identifier hs-var">runReaderWith</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060305"><span class="hs-identifier hs-var">sched</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SessionID -&gt; ROnly ()
</span><a href="#local-6989586621679060279"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-comment">-- TODO: Ideally we would wait for ALL outstanding (stolen) work on this &quot;team&quot; to complete.</span><span>
</span><span id="line-300"></span><span>
</span><span id="line-301"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbglvl"><span class="hs-identifier hs-var">dbglvl</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-302"></span><span>      </span><span id="local-6989586621679060269"><span class="annot"><span class="annottext">Set SessionID
</span><a href="#local-6989586621679060269"><span class="hs-identifier hs-var">active</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HotVar (Set SessionID) -&gt; IO (Set SessionID)
forall a. HotVar a -&gt; IO a
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#readHotVar"><span class="hs-identifier hs-var">readHotVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; HotVar (Set SessionID)
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#activeSessions"><span class="hs-identifier hs-var hs-var">activeSessions</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060305"><span class="hs-identifier hs-var">sched</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>      </span><span id="local-6989586621679060268"><span class="annot"><span class="annottext">sess :: Bool
</span><a href="#local-6989586621679060268"><span class="hs-identifier hs-var">sess</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HotVar Bool -&gt; IO Bool
forall a. HotVar a -&gt; IO a
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#readHotVar"><span class="hs-identifier hs-var">readHotVar</span></a></span><span> </span><span class="annot"><span class="annottext">HotVar Bool
</span><a href="#local-6989586621679060291"><span class="hs-identifier hs-var">newFlag</span></a></span><span> </span><span class="hs-comment">-- ASSERT!</span><span>
</span><span id="line-304"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Int
-&gt; String
-&gt; String
-&gt; String
-&gt; SessionID
-&gt; String
-&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d %s] RETURN from %s (sessFin %s) runContT (%d) active set %s\n&quot;</span></span><span>
</span><span id="line-305"></span><span>               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var hs-var">no</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060305"><span class="hs-identifier hs-var">sched</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060303"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679060306"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679060268"><span class="hs-identifier hs-var">sess</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060301"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set SessionID -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Set SessionID
</span><a href="#local-6989586621679060269"><span class="hs-identifier hs-var">active</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-comment">-- Here we pop off the frame we added to the session stack:</span><span>
</span><span id="line-308"></span><span>    </span><span class="annot"><span class="annottext">HotVar [Session] -&gt; ([Session] -&gt; [Session]) -&gt; IO ()
forall a. HotVar a -&gt; (a -&gt; a) -&gt; IO ()
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#modifyHotVar_"><span class="hs-identifier hs-var">modifyHotVar_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; HotVar [Session]
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#sessions"><span class="hs-identifier hs-var hs-var">sessions</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060305"><span class="hs-identifier hs-var">sched</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([Session] -&gt; [Session]) -&gt; IO ())
-&gt; ([Session] -&gt; [Session]) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Session"><span class="hs-identifier hs-type">Session</span></a></span><span> </span><span id="local-6989586621679060267"><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060267"><span class="hs-identifier hs-var">sid2</span></a></span></span><span> </span><span class="annot"><span class="annottext">HotVar Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679060266"><span class="annot"><span class="annottext">[Session]
</span><a href="#local-6989586621679060266"><span class="hs-identifier hs-var">tl</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-309"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060301"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">SessionID -&gt; SessionID -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060267"><span class="hs-identifier hs-var">sid2</span></a></span><span>
</span><span id="line-310"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[Session]
</span><a href="#local-6989586621679060266"><span class="hs-identifier hs-var">tl</span></a></span><span>
</span><span id="line-311"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String -&gt; [Session]
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span class="annot"><span class="annottext">(String -&gt; [Session]) -&gt; String -&gt; [Session]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Tried to pop the session stack and found we (&quot;</span></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">SessionID -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060301"><span class="hs-identifier hs-var">sid</span></a></span><span>
</span><span id="line-312"></span><span>                   </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;) were not on the top! (instead &quot;</span></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">SessionID -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060267"><span class="hs-identifier hs-var">sid2</span></a></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;)&quot;</span></span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span>    </span><span class="hs-comment">-- By returning here we ARE implicitly reengaging the scheduler, since we</span><span>
</span><span id="line-315"></span><span>    </span><span class="hs-comment">-- are already inside the rescheduleR loop on this thread</span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-comment">-- (before runParIO was called in a nested fashion).</span><span>
</span><span id="line-317"></span><span>    </span><span class="annot"><span class="annottext">IORef b -&gt; IO b
forall a. HotVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef b
</span><a href="#local-6989586621679060294"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-318"></span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#runParIO"><span class="hs-pragma hs-type">runParIO</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-321"></span><span id="runParIO"><span class="annot"><span class="annottext">runParIO :: Par a -&gt; IO a
</span><a href="Control.Monad.Par.Scheds.Direct.html#runParIO"><span class="hs-identifier hs-var hs-var">runParIO</span></a></span></span><span> </span><span id="local-6989586621679060265"><span class="annot"><span class="annottext">Par a
</span><a href="#local-6989586621679060265"><span class="hs-identifier hs-var">userComp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-322"></span><span>   </span><span id="local-6989586621679060264"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060264"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span class="hs-cpp">
#if __GLASGOW_HASKELL__ &gt;= 701 /* 20110301 */
</span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-325"></span><span>    </span><span class="hs-comment">-- We create a thread on each CPU with forkOn.  The CPU on which</span><span>
</span><span id="line-326"></span><span>    </span><span class="hs-comment">-- the current thread is running will host the main thread; the</span><span>
</span><span id="line-327"></span><span>    </span><span class="hs-comment">-- other CPUs will host worker threads.</span><span>
</span><span id="line-328"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-329"></span><span>    </span><span class="hs-comment">-- Note: GHC 7.1.20110301 is required for this to work, because that</span><span>
</span><span id="line-330"></span><span>    </span><span class="hs-comment">-- is when threadCapability was added.</span><span>
</span><span id="line-331"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-332"></span><span>   </span><span class="hs-special">(</span><span id="local-6989586621679060263"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060263"><span class="hs-identifier hs-var">main_cpu</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; IO (Int, Bool)
</span><span class="hs-identifier hs-var">threadCapability</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060264"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-cpp">
#else
</span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-335"></span><span>    </span><span class="hs-comment">-- Lacking threadCapability, we always pick CPU #0 to run the main</span><span>
</span><span id="line-336"></span><span>    </span><span class="hs-comment">-- thread.  If the current thread is not running on CPU #0, this</span><span>
</span><span id="line-337"></span><span>    </span><span class="hs-comment">-- will require some data to be shipped over the memory bus, and</span><span>
</span><span id="line-338"></span><span>    </span><span class="hs-comment">-- hence will be slightly slower than the version above.</span><span>
</span><span id="line-339"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-340"></span><span>   </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">main_cpu</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span class="hs-cpp">
#endif
</span><span>   </span><span id="local-6989586621679060261"><span class="annot"><span class="annottext">Maybe Sched
</span><a href="#local-6989586621679060261"><span class="hs-identifier hs-var">maybSched</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; IO (Maybe Sched)
</span><a href="Control.Monad.Par.Scheds.Direct.html#amINested"><span class="hs-identifier hs-var">amINested</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060264"><span class="hs-identifier hs-var">tid</span></a></span><span>
</span><span id="line-343"></span><span>   </span><span id="local-6989586621679060260"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060260"><span class="hs-identifier hs-var">tidorig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span> </span><span class="hs-comment">-- TODO: remove when done debugging</span><span>
</span><span id="line-344"></span><span>   </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Sched
</span><a href="#local-6989586621679060261"><span class="hs-identifier hs-var">maybSched</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-345"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679060259"><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060259"><span class="hs-identifier hs-var">sched</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-346"></span><span>       </span><span class="hs-comment">-- Here the current thread is ALREADY a worker.  All we need to</span><span>
</span><span id="line-347"></span><span>       </span><span class="hs-comment">-- do is plug the users new computation in.</span><span>
</span><span id="line-348"></span><span>
</span><span id="line-349"></span><span>       </span><span id="local-6989586621679060258"><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060258"><span class="hs-identifier hs-var">sid0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HotVar SessionID -&gt; IO SessionID
forall a. HotVar a -&gt; IO a
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#readHotVar"><span class="hs-identifier hs-var">readHotVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; HotVar SessionID
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#sessionCounter"><span class="hs-identifier hs-var hs-var">sessionCounter</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060259"><span class="hs-identifier hs-var">sched</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>       </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbglvl"><span class="hs-identifier hs-var">dbglvl</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; String -&gt; SessionID -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d %s] runPar called from existing worker thread, new session (%d)....\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var hs-var">no</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060259"><span class="hs-identifier hs-var">sched</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060264"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060258"><span class="hs-identifier hs-var">sid0</span></a></span><span> </span><span class="annot"><span class="annottext">SessionID -&gt; SessionID -&gt; SessionID
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span>       </span><span class="annot"><span class="annottext">String -&gt; Sched -&gt; Par a -&gt; IO a
forall b. String -&gt; Sched -&gt; Par b -&gt; IO b
</span><a href="Control.Monad.Par.Scheds.Direct.html#runNewSessionAndWait"><span class="hs-identifier hs-var">runNewSessionAndWait</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nested runPar&quot;</span></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060259"><span class="hs-identifier hs-var">sched</span></a></span><span> </span><span class="annot"><span class="annottext">Par a
</span><a href="#local-6989586621679060265"><span class="hs-identifier hs-var">userComp</span></a></span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span>     </span><span class="hs-comment">------------------------------------------------------------</span><span>
</span><span id="line-354"></span><span>     </span><span class="hs-comment">-- Non-nested case, make a new set of worker threads:</span><span>
</span><span id="line-355"></span><span>     </span><span class="hs-comment">------------------------------------------------------------</span><span>
</span><span id="line-356"></span><span>     </span><span class="annot"><span class="annottext">Maybe Sched
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-357"></span><span>       </span><span id="local-6989586621679060257"><span class="annot"><span class="annottext">[Sched]
</span><a href="#local-6989586621679060257"><span class="hs-identifier hs-var">allscheds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO [Sched]
</span><a href="Control.Monad.Par.Scheds.Direct.html#makeScheds"><span class="hs-identifier hs-var">makeScheds</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060263"><span class="hs-identifier hs-var">main_cpu</span></a></span><span>
</span><span id="line-358"></span><span>       </span><span class="hs-special">[</span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Session"><span class="hs-identifier hs-type">Session</span></a></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679060255"><span class="annot"><span class="annottext">HotVar Bool
</span><a href="#local-6989586621679060255"><span class="hs-identifier hs-var">topSessFlag</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HotVar [Session] -&gt; IO [Session]
forall a. HotVar a -&gt; IO a
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#readHotVar"><span class="hs-identifier hs-var">readHotVar</span></a></span><span class="annot"><span class="annottext">(HotVar [Session] -&gt; IO [Session])
-&gt; HotVar [Session] -&gt; IO [Session]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Sched -&gt; HotVar [Session]
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#sessions"><span class="hs-identifier hs-var hs-var">sessions</span></a></span><span class="annot"><span class="annottext">(Sched -&gt; HotVar [Session]) -&gt; Sched -&gt; HotVar [Session]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Sched] -&gt; Sched
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">head</span></span><span> </span><span class="annot"><span class="annottext">[Sched]
</span><a href="#local-6989586621679060257"><span class="hs-identifier hs-var">allscheds</span></a></span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span>       </span><span id="local-6989586621679060253"><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621679060253"><span class="hs-identifier hs-var">mfin</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (MVar a)
forall a. IO (MVar a)
</span><span class="hs-identifier hs-var">newEmptyMVar</span></span><span>
</span><span id="line-361"></span><span>       </span><span id="local-6989586621679060251"><span class="annot"><span class="annottext">[Maybe (MVar Int)]
</span><a href="#local-6989586621679060251"><span class="hs-identifier hs-var">doneFlags</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Int, Sched)]
-&gt; ((Int, Sched) -&gt; IO (Maybe (MVar Int))) -&gt; IO [Maybe (MVar Int)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; [Sched] -&gt; [(Int, Sched)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Sched]
</span><a href="#local-6989586621679060257"><span class="hs-identifier hs-var">allscheds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Int, Sched) -&gt; IO (Maybe (MVar Int))) -&gt; IO [Maybe (MVar Int)])
-&gt; ((Int, Sched) -&gt; IO (Maybe (MVar Int))) -&gt; IO [Maybe (MVar Int)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679060249"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060249"><span class="hs-identifier hs-var">cpu</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679060248"><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060248"><span class="hs-identifier hs-var">sched</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-362"></span><span>            </span><span id="local-6989586621679060247"><span class="annot"><span class="annottext">MVar Int
</span><a href="#local-6989586621679060247"><span class="hs-identifier hs-var">workerDone</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (MVar Int)
forall a. IO (MVar a)
</span><span class="hs-identifier hs-var">newEmptyMVar</span></span><span>
</span><span id="line-363"></span><span>            </span><span class="hs-comment">----------------------------------------</span><span>
</span><span id="line-364"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679060246"><span class="annot"><span class="annottext">wname :: String
</span><a href="#local-6989586621679060246"><span class="hs-identifier hs-var hs-var">wname</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;(worker &quot;</span></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060249"><span class="hs-identifier hs-var">cpu</span></a></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; of originator &quot;</span></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060260"><span class="hs-identifier hs-var">tidorig</span></a></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;)&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-365"></span><span class="hs-comment">--            forkOn cpu $ do</span><span>
</span><span id="line-366"></span><span>            </span><span class="annot"><span class="annottext">ThreadId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ThreadId) -&gt; String -&gt; IO () -&gt; IO ThreadId
</span><a href="Control.Monad.Par.Scheds.Direct.html#forkWithExceptions"><span class="hs-identifier hs-var">forkWithExceptions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; IO () -&gt; IO ThreadId
</span><span class="hs-identifier hs-var">forkOn</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060249"><span class="hs-identifier hs-var">cpu</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679060246"><span class="hs-identifier hs-var">wname</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ThreadId) -&gt; IO () -&gt; IO ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-367"></span><span>            </span><span class="hs-comment">------------------------------------------------------------STRT WORKER THREAD</span><span>
</span><span id="line-368"></span><span>              </span><span id="local-6989586621679060243"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060243"><span class="hs-identifier hs-var">tid2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-369"></span><span>              </span><span class="annot"><span class="annottext">ThreadId -&gt; Sched -&gt; IO ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#registerWorker"><span class="hs-identifier hs-var">registerWorker</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060243"><span class="hs-identifier hs-var">tid2</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060248"><span class="hs-identifier hs-var">sched</span></a></span><span>
</span><span id="line-370"></span><span>              </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060249"><span class="hs-identifier hs-var">cpu</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060263"><span class="hs-identifier hs-var">main_cpu</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>                 </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; String -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d %s] Anonymous worker entering scheduling loop.\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060249"><span class="hs-identifier hs-var">cpu</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060243"><span class="hs-identifier hs-var">tid2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>                         </span><span class="annot"><span class="annottext">Sched -&gt; ROnly () -&gt; IO ()
forall r (m :: * -&gt; *) a. r -&gt; ReaderT r m a -&gt; m a
</span><a href="Control.Monad.Par.Scheds.Direct.html#runReaderWith"><span class="hs-identifier hs-var">runReaderWith</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060248"><span class="hs-identifier hs-var">sched</span></a></span><span> </span><span class="annot"><span class="annottext">(ROnly () -&gt; IO ()) -&gt; ROnly () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SessionID -&gt; (Any -&gt; ROnly ()) -&gt; ROnly ()
forall a. SessionID -&gt; (a -&gt; ROnly ()) -&gt; ROnly ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#rescheduleR"><span class="hs-identifier hs-var">rescheduleR</span></a></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Any -&gt; ROnly ()
forall a. String -&gt; a -&gt; ROnly ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#trivialCont"><span class="hs-identifier hs-var">trivialCont</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679060246"><span class="hs-identifier hs-var">wname</span></a></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060243"><span class="hs-identifier hs-var">tid2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-373"></span><span>                         </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d] Anonymous worker exited scheduling loop.  FINISHED.\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060249"><span class="hs-identifier hs-var">cpu</span></a></span><span>
</span><span id="line-374"></span><span>                         </span><span class="annot"><span class="annottext">MVar Int -&gt; Int -&gt; IO ()
forall a. MVar a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">putMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar Int
</span><a href="#local-6989586621679060247"><span class="hs-identifier hs-var">workerDone</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060249"><span class="hs-identifier hs-var">cpu</span></a></span><span>
</span><span id="line-375"></span><span>                         </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-376"></span><span>                 </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679060241"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060241"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Sched -&gt; Par a -&gt; IO a
forall b. String -&gt; Sched -&gt; Par b -&gt; IO b
</span><a href="Control.Monad.Par.Scheds.Direct.html#runNewSessionAndWait"><span class="hs-identifier hs-var">runNewSessionAndWait</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;top-lvl main worker&quot;</span></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060248"><span class="hs-identifier hs-var">sched</span></a></span><span> </span><span class="annot"><span class="annottext">Par a
</span><a href="#local-6989586621679060265"><span class="hs-identifier hs-var">userComp</span></a></span><span>
</span><span id="line-377"></span><span>                         </span><span class="hs-comment">-- When the main worker finishes we can tell the anonymous &quot;system&quot; workers:</span><span>
</span><span id="line-378"></span><span>                         </span><span class="annot"><span class="annottext">HotVar Bool -&gt; Bool -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">HotVar Bool
</span><a href="#local-6989586621679060255"><span class="hs-identifier hs-var">topSessFlag</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-379"></span><span>                         </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; *** Out of entire runContT user computation on main thread %s.\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060243"><span class="hs-identifier hs-var">tid2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span>                         </span><span class="hs-comment">--  sanityCheck allscheds</span><span>
</span><span id="line-381"></span><span>                         </span><span class="annot"><span class="annottext">MVar a -&gt; a -&gt; IO ()
forall a. MVar a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">putMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621679060253"><span class="hs-identifier hs-var">mfin</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060241"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-382"></span><span>
</span><span id="line-383"></span><span>              </span><span class="annot"><span class="annottext">ThreadId -&gt; IO ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#unregisterWorker"><span class="hs-identifier hs-var">unregisterWorker</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060264"><span class="hs-identifier hs-var">tid</span></a></span><span>
</span><span id="line-384"></span><span>            </span><span class="hs-comment">------------------------------------------------------------END WORKER THREAD</span><span>
</span><span id="line-385"></span><span>            </span><span class="annot"><span class="annottext">Maybe (MVar Int) -&gt; IO (Maybe (MVar Int))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060249"><span class="hs-identifier hs-var">cpu</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060263"><span class="hs-identifier hs-var">main_cpu</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe (MVar Int)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">MVar Int -&gt; Maybe (MVar Int)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">MVar Int
</span><a href="#local-6989586621679060247"><span class="hs-identifier hs-var">workerDone</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span>       </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#_WAIT_FOR_WORKERS"><span class="hs-identifier hs-var">_WAIT_FOR_WORKERS</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-388"></span><span>           </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; *** [%s] Originator thread: waiting for workers to complete.&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060260"><span class="hs-identifier hs-var">tidorig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-389"></span><span>           </span><span class="annot"><span class="annottext">[MVar Int] -&gt; (MVar Int -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Maybe (MVar Int)] -&gt; [MVar Int]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (MVar Int)]
</span><a href="#local-6989586621679060251"><span class="hs-identifier hs-var">doneFlags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((MVar Int -&gt; IO ()) -&gt; IO ()) -&gt; (MVar Int -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621679060239"><span class="annot"><span class="annottext">MVar Int
</span><a href="#local-6989586621679060239"><span class="hs-identifier hs-var">mv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-390"></span><span>             </span><span id="local-6989586621679060238"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060238"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar Int -&gt; IO Int
forall a. MVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar Int
</span><a href="#local-6989586621679060239"><span class="hs-identifier hs-var">mv</span></a></span><span>
</span><span id="line-391"></span><span>    </span><span class="hs-comment">--         n &lt;- A.wait mv</span><span>
</span><span id="line-392"></span><span>             </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;   * [%s]  Worker %s completed\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060260"><span class="hs-identifier hs-var">tidorig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060238"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span>       </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; *** [%s] Reading final MVar on originator thread.\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060260"><span class="hs-identifier hs-var">tidorig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-395"></span><span>       </span><span class="hs-comment">-- We don't directly use the thread we come in on.  Rather, that thread waits</span><span>
</span><span id="line-396"></span><span>       </span><span class="hs-comment">-- waits.  One reason for this is that the main/progenitor thread in</span><span>
</span><span id="line-397"></span><span>       </span><span class="hs-comment">-- GHC is expensive like a forkOS thread.</span><span>
</span><span id="line-398"></span><span>       </span><span class="hs-comment">----------------------------------------</span><span>
</span><span id="line-399"></span><span>       </span><span class="hs-comment">--              DEBUGGING             --</span><span class="hs-cpp">
#ifdef DEBUG_DIRECT
</span><span>       </span><span class="hs-identifier">busyTakeMVar</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot; The global wait &quot;</span><span class="hs-operator">++</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">tidorig</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">mfin</span><span> </span><span class="hs-comment">-- Final value.</span><span>
</span><span id="line-402"></span><span class="hs-comment">--       dbgTakeMVar &quot;global waiting thread&quot; mfin -- Final value.</span><span class="hs-cpp">
#else
</span><span>       </span><span class="annot"><span class="annottext">MVar a -&gt; IO a
forall a. MVar a -&gt; IO a
</span><span class="hs-identifier hs-var">takeMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621679060253"><span class="hs-identifier hs-var">mfin</span></a></span><span> </span><span class="hs-comment">-- Final value.</span><span class="hs-cpp">
#endif
</span><span>       </span><span class="hs-comment">----------------------------------------</span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span class="hs-comment">-- Create the default scheduler(s) state:</span><span>
</span><span id="line-409"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#makeScheds"><span class="hs-identifier hs-type">makeScheds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Sched"><span class="hs-identifier hs-type">Sched</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-410"></span><span id="makeScheds"><span class="annot"><span class="annottext">makeScheds :: Int -&gt; IO [Sched]
</span><a href="Control.Monad.Par.Scheds.Direct.html#makeScheds"><span class="hs-identifier hs-var hs-var">makeScheds</span></a></span></span><span> </span><span id="local-6989586621679060235"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060235"><span class="hs-identifier hs-var">main</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-411"></span><span>   </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679060234"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060234"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-412"></span><span>                </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; String -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;[initialization] Creating %d worker threads, currently on %s\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier hs-var">numCapabilities</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060234"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-413"></span><span>   </span><span id="local-6989586621679060233"><span class="annot"><span class="annottext">[SimpleDeque (Par ())]
</span><a href="#local-6989586621679060233"><span class="hs-identifier hs-var">workpools</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (SimpleDeque (Par ())) -&gt; IO [SimpleDeque (Par ())]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier hs-var">numCapabilities</span></span><span> </span><span class="annot"><span class="annottext">(IO (SimpleDeque (Par ())) -&gt; IO [SimpleDeque (Par ())])
-&gt; IO (SimpleDeque (Par ())) -&gt; IO [SimpleDeque (Par ())]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (SimpleDeque (Par ()))
forall elt. IO (SimpleDeque elt)
</span><span class="hs-identifier hs-var">R.newQ</span></span><span>
</span><span id="line-414"></span><span>   </span><span id="local-6989586621679060230"><span class="annot"><span class="annottext">[HotVar (Gen RealWorld)]
</span><a href="#local-6989586621679060230"><span class="hs-identifier hs-var">rngs</span></a></span></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (HotVar (Gen RealWorld)) -&gt; IO [HotVar (Gen RealWorld)]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier hs-var">numCapabilities</span></span><span> </span><span class="annot"><span class="annottext">(IO (HotVar (Gen RealWorld)) -&gt; IO [HotVar (Gen RealWorld)])
-&gt; IO (HotVar (Gen RealWorld)) -&gt; IO [HotVar (Gen RealWorld)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Gen RealWorld)
forall (m :: * -&gt; *). PrimMonad m =&gt; m (Gen (PrimState m))
</span><span class="hs-identifier hs-var">Random.create</span></span><span> </span><span class="annot"><span class="annottext">IO (Gen RealWorld)
-&gt; (Gen RealWorld -&gt; IO (HotVar (Gen RealWorld)))
-&gt; IO (HotVar (Gen RealWorld))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Gen RealWorld -&gt; IO (HotVar (Gen RealWorld))
forall a. a -&gt; IO (IORef a)
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#newHotVar"><span class="hs-identifier hs-var">newHotVar</span></a></span><span>
</span><span id="line-415"></span><span>   </span><span id="local-6989586621679060228"><span class="annot"><span class="annottext">HotVar [MVar Bool]
</span><a href="#local-6989586621679060228"><span class="hs-identifier hs-var">idle</span></a></span></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[MVar Bool] -&gt; IO (HotVar [MVar Bool])
forall a. a -&gt; IO (IORef a)
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#newHotVar"><span class="hs-identifier hs-var">newHotVar</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-416"></span><span>   </span><span class="hs-comment">-- The STACKs are per-worker.. but the root finished flag is shared between all anonymous system workers:</span><span>
</span><span id="line-417"></span><span>   </span><span id="local-6989586621679060227"><span class="annot"><span class="annottext">HotVar Bool
</span><a href="#local-6989586621679060227"><span class="hs-identifier hs-var">sessionFinished</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (HotVar Bool)
forall a. a -&gt; IO (IORef a)
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#newHotVar"><span class="hs-identifier hs-var">newHotVar</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-418"></span><span>   </span><span id="local-6989586621679060226"><span class="annot"><span class="annottext">[HotVar [Session]]
</span><a href="#local-6989586621679060226"><span class="hs-identifier hs-var">sessionStacks</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([Session] -&gt; IO (HotVar [Session]))
-&gt; [[Session]] -&gt; IO [HotVar [Session]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">[Session] -&gt; IO (HotVar [Session])
forall a. a -&gt; IO (IORef a)
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#newHotVar"><span class="hs-identifier hs-var">newHotVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [Session] -&gt; [[Session]]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier hs-var">numCapabilities</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SessionID -&gt; HotVar Bool -&gt; Session
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#Session"><span class="hs-identifier hs-var">Session</span></a></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><a href="Control.Monad.Par.Scheds.Direct.html#baseSessionID"><span class="hs-identifier hs-var">baseSessionID</span></a></span><span> </span><span class="annot"><span class="annottext">HotVar Bool
</span><a href="#local-6989586621679060227"><span class="hs-identifier hs-var">sessionFinished</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>   </span><span id="local-6989586621679060222"><span class="annot"><span class="annottext">HotVar (Set SessionID)
</span><a href="#local-6989586621679060222"><span class="hs-identifier hs-var">activeSessions</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Set SessionID -&gt; IO (HotVar (Set SessionID))
forall a. a -&gt; IO (IORef a)
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#newHotVar"><span class="hs-identifier hs-var">newHotVar</span></a></span><span> </span><span class="annot"><span class="annottext">Set SessionID
forall a. Set a
</span><span class="hs-identifier hs-var">S.empty</span></span><span>
</span><span id="line-420"></span><span>   </span><span id="local-6989586621679060220"><span class="annot"><span class="annottext">HotVar SessionID
</span><a href="#local-6989586621679060220"><span class="hs-identifier hs-var">sessionCounter</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SessionID -&gt; IO (HotVar SessionID)
forall a. a -&gt; IO (IORef a)
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#newHotVar"><span class="hs-identifier hs-var">newHotVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SessionID
</span><a href="Control.Monad.Par.Scheds.Direct.html#baseSessionID"><span class="hs-identifier hs-var">baseSessionID</span></a></span><span> </span><span class="annot"><span class="annottext">SessionID -&gt; SessionID -&gt; SessionID
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-421"></span><span>   </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679060219"><span class="annot"><span class="annottext">allscheds :: [Sched]
</span><a href="#local-6989586621679060219"><span class="hs-identifier hs-var hs-var">allscheds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Sched :: Int
-&gt; WSDeque (Par ())
-&gt; HotVar GenIO
-&gt; Bool
-&gt; HotVar [Session]
-&gt; HotVar [MVar Bool]
-&gt; [Sched]
-&gt; HotVar (Set SessionID)
-&gt; HotVar SessionID
-&gt; Sched
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#Sched"><span class="hs-identifier hs-type">Sched</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">no :: Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var">no</span></a></span><span class="hs-glyph">=</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060218"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HotVar [MVar Bool]
idle :: HotVar [MVar Bool]
idle :: HotVar [MVar Bool]
</span><a href="#local-6989586621679060228"><span class="hs-identifier hs-var hs-var">idle</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">isMain :: Bool
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#isMain"><span class="hs-identifier hs-var">isMain</span></a></span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060218"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060235"><span class="hs-identifier hs-var">main</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-422"></span><span>                             </span><span class="annot"><span class="annottext">workpool :: WSDeque (Par ())
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#workpool"><span class="hs-identifier hs-var">workpool</span></a></span><span class="hs-glyph">=</span><span class="annot"><span class="annottext">SimpleDeque (Par ())
WSDeque (Par ())
</span><a href="#local-6989586621679060216"><span class="hs-identifier hs-var">wp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">scheds :: [Sched]
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#scheds"><span class="hs-identifier hs-var">scheds</span></a></span><span class="hs-glyph">=</span><span class="annot"><span class="annottext">[Sched]
</span><a href="#local-6989586621679060219"><span class="hs-identifier hs-var">allscheds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rng :: HotVar GenIO
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#rng"><span class="hs-identifier hs-var">rng</span></a></span><span class="hs-glyph">=</span><span class="annot"><span class="annottext">HotVar (Gen RealWorld)
HotVar GenIO
</span><a href="#local-6989586621679060213"><span class="hs-identifier hs-var">rng</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-423"></span><span>                             </span><span class="annot"><span class="annottext">sessions :: HotVar [Session]
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#sessions"><span class="hs-identifier hs-var">sessions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HotVar [Session]
</span><a href="#local-6989586621679060212"><span class="hs-identifier hs-var">stck</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-424"></span><span>                             </span><span class="annot"><span class="annottext">activeSessions :: HotVar (Set SessionID)
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#activeSessions"><span class="hs-identifier hs-var">activeSessions</span></a></span><span class="hs-glyph">=</span><span class="annot"><span class="annottext">HotVar (Set SessionID)
</span><a href="#local-6989586621679060222"><span class="hs-identifier hs-var">activeSessions</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-425"></span><span>                             </span><span class="annot"><span class="annottext">sessionCounter :: HotVar SessionID
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#sessionCounter"><span class="hs-identifier hs-var">sessionCounter</span></a></span><span class="hs-glyph">=</span><span class="annot"><span class="annottext">HotVar SessionID
</span><a href="#local-6989586621679060220"><span class="hs-identifier hs-var">sessionCounter</span></a></span><span>
</span><span id="line-426"></span><span>                           </span><span class="hs-special">}</span><span>
</span><span id="line-427"></span><span>                   </span><span class="hs-comment">--  | (x,wp,rng,stck) &lt;- zip4 [0..] workpools rngs sessionStacks</span><span>
</span><span id="line-428"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679060218"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060218"><span class="hs-identifier hs-var">x</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier hs-var">numCapabilities</span></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-429"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679060216"><span class="annot"><span class="annottext">SimpleDeque (Par ())
</span><a href="#local-6989586621679060216"><span class="hs-identifier hs-var">wp</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SimpleDeque (Par ())]
</span><a href="#local-6989586621679060233"><span class="hs-identifier hs-var">workpools</span></a></span><span>
</span><span id="line-430"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679060213"><span class="annot"><span class="annottext">HotVar (Gen RealWorld)
</span><a href="#local-6989586621679060213"><span class="hs-identifier hs-var">rng</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[HotVar (Gen RealWorld)]
</span><a href="#local-6989586621679060230"><span class="hs-identifier hs-var">rngs</span></a></span><span>
</span><span id="line-431"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679060212"><span class="annot"><span class="annottext">HotVar [Session]
</span><a href="#local-6989586621679060212"><span class="hs-identifier hs-var">stck</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[HotVar [Session]]
</span><a href="#local-6989586621679060226"><span class="hs-identifier hs-var">sessionStacks</span></a></span><span>
</span><span id="line-432"></span><span>                   </span><span class="hs-special">]</span><span>
</span><span id="line-433"></span><span>   </span><span class="annot"><span class="annottext">[Sched] -&gt; IO [Sched]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[Sched]
</span><a href="#local-6989586621679060219"><span class="hs-identifier hs-var">allscheds</span></a></span><span>
</span><span id="line-434"></span><span>
</span><span id="line-435"></span><span>
</span><span id="line-436"></span><span class="hs-comment">-- The ID of top-level runPar sessions.</span><span>
</span><span id="line-437"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#baseSessionID"><span class="hs-identifier hs-type">baseSessionID</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#SessionID"><span class="hs-identifier hs-type">SessionID</span></a></span><span>
</span><span id="line-438"></span><span id="baseSessionID"><span class="annot"><span class="annottext">baseSessionID :: SessionID
</span><a href="Control.Monad.Par.Scheds.Direct.html#baseSessionID"><span class="hs-identifier hs-var hs-var">baseSessionID</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SessionID
</span><span class="hs-number">1000</span></span><span>
</span><span id="line-439"></span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-442"></span><span class="hs-comment">-- IVar operations</span><span>
</span><span id="line-443"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-444"></span><span>
</span><span id="line-445"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#new"><span class="hs-pragma hs-type">new</span></a></span><span>  </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-446"></span><span class="hs-comment">-- | Creates a new @IVar@</span><span>
</span><span id="line-447"></span><span id="local-6989586621679060463"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#new"><span class="hs-identifier hs-type">new</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060463"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-448"></span><span id="new"><span class="annot"><span class="annottext">new :: Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#new"><span class="hs-identifier hs-var hs-var">new</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (IVar a) -&gt; Par (IVar a)
forall a. IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#io"><span class="hs-identifier hs-var">io</span></a></span><span class="annot"><span class="annottext">(IO (IVar a) -&gt; Par (IVar a)) -&gt; IO (IVar a) -&gt; Par (IVar a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679060211"><span class="annot"><span class="annottext">IORef (IVarContents a)
</span><a href="#local-6989586621679060211"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IVarContents a -&gt; IO (IORef (IVarContents a))
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">IVarContents a
forall a. IVarContents a
</span><a href="Control.Monad.Par.Scheds.Direct.html#Empty"><span class="hs-identifier hs-var">Empty</span></a></span><span>
</span><span id="line-449"></span><span>              </span><span class="annot"><span class="annottext">IVar a -&gt; IO (IVar a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IORef (IVarContents a) -&gt; IVar a
forall a. IORef (IVarContents a) -&gt; IVar a
</span><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-var">IVar</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (IVarContents a)
</span><a href="#local-6989586621679060211"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-450"></span><span>
</span><span id="line-451"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#get"><span class="hs-pragma hs-type">get</span></a></span><span>  </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-452"></span><span class="hs-comment">-- | Read the value in an @IVar@.  The 'get' operation can only return when the</span><span>
</span><span id="line-453"></span><span class="hs-comment">-- value has been written by a prior or parallel @put@ to the same</span><span>
</span><span id="line-454"></span><span class="hs-comment">-- @IVar@.</span><span>
</span><span id="line-455"></span><span id="get"><span class="annot"><span class="annottext">get :: IVar a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#get"><span class="hs-identifier hs-var hs-var">get</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span id="local-6989586621679060210"><span class="annot"><span class="annottext">IORef (IVarContents a)
</span><a href="#local-6989586621679060210"><span class="hs-identifier hs-var">vr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-456"></span><span>  </span><span class="annot"><span class="annottext">((a -&gt; Par ()) -&gt; Par a) -&gt; Par a
forall (m :: * -&gt; *) a b. MonadCont m =&gt; ((a -&gt; m b) -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">callCC</span></span><span> </span><span class="annot"><span class="annottext">(((a -&gt; Par ()) -&gt; Par a) -&gt; Par a)
-&gt; ((a -&gt; Par ()) -&gt; Par a) -&gt; Par a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679060208"><span class="annot"><span class="annottext">a -&gt; Par ()
</span><a href="#local-6989586621679060208"><span class="hs-identifier hs-var">kont</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-457"></span><span>    </span><span class="hs-keyword">do</span><span>
</span><span id="line-458"></span><span>       </span><span id="local-6989586621679060207"><span class="annot"><span class="annottext">IVarContents a
</span><a href="#local-6989586621679060207"><span class="hs-identifier hs-var">e</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IVarContents a) -&gt; Par (IVarContents a)
forall a. IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#io"><span class="hs-identifier hs-var">io</span></a></span><span class="annot"><span class="annottext">(IO (IVarContents a) -&gt; Par (IVarContents a))
-&gt; IO (IVarContents a) -&gt; Par (IVarContents a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef (IVarContents a) -&gt; IO (IVarContents a)
forall a. HotVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (IVarContents a)
</span><a href="#local-6989586621679060210"><span class="hs-identifier hs-var">vr</span></a></span><span>
</span><span id="line-459"></span><span>       </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IVarContents a
</span><a href="#local-6989586621679060207"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-460"></span><span>          </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#Full"><span class="hs-identifier hs-type">Full</span></a></span><span> </span><span id="local-6989586621679060206"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060206"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; Par a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060206"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-461"></span><span>          </span><span class="annot"><span class="annottext">IVarContents a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-462"></span><span>            </span><span id="local-6989586621679060205"><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060205"><span class="hs-identifier hs-var">sch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Par Sched
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">RD.ask</span></span><span class="hs-cpp">
#  ifdef DEBUG_DIRECT
</span><span>            </span><span class="hs-identifier">sn</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">io</span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">makeStableName</span><span> </span><span class="hs-identifier">vr</span><span>  </span><span class="hs-comment">-- Should probably do the MutVar inside...</span><span>
</span><span id="line-465"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">resched</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">trace</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot; [&quot;</span><span class="hs-operator">++</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">no</span><span> </span><span class="hs-identifier">sch</span><span class="hs-special">)</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot;]  - Rescheduling on unavailable ivar &quot;</span><span class="hs-operator">++</span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hashStableName</span><span> </span><span class="hs-identifier">sn</span><span class="hs-special">)</span><span class="hs-operator">++</span><span class="hs-string">&quot;!&quot;</span><span class="hs-special">)</span><span class="hs-cpp">
#else
</span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679060203"><span class="annot"><span class="annottext">resched :: Par a
</span><a href="#local-6989586621679060203"><span class="hs-identifier hs-var hs-var">resched</span></a></span></span><span> </span><span class="hs-glyph">=</span><span class="hs-cpp">
#  endif
</span><span>                          </span><span class="annot"><span class="annottext">Par a
forall a. Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#longjmpSched"><span class="hs-identifier hs-var">longjmpSched</span></a></span><span> </span><span class="hs-comment">-- Invariant: kont must not be lost.</span><span>
</span><span id="line-470"></span><span>            </span><span class="hs-comment">-- Because we continue on the same processor the Sched stays the same:</span><span>
</span><span id="line-471"></span><span>            </span><span class="hs-comment">-- TODO: Try NOT using monadic values as first class.  Check for performance effect:</span><span>
</span><span id="line-472"></span><span>            </span><span id="local-6989586621679060201"><span class="annot"><span class="annottext">Par a
</span><a href="#local-6989586621679060201"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Par a) -&gt; Par (Par a)
forall a. IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#io"><span class="hs-identifier hs-var">io</span></a></span><span class="annot"><span class="annottext">(IO (Par a) -&gt; Par (Par a)) -&gt; IO (Par a) -&gt; Par (Par a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef (IVarContents a)
-&gt; (IVarContents a -&gt; (IVarContents a, Par a)) -&gt; IO (Par a)
forall a b. HotVar a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (IVarContents a)
</span><a href="#local-6989586621679060210"><span class="hs-identifier hs-var">vr</span></a></span><span> </span><span class="annot"><span class="annottext">((IVarContents a -&gt; (IVarContents a, Par a)) -&gt; IO (Par a))
-&gt; (IVarContents a -&gt; (IVarContents a, Par a)) -&gt; IO (Par a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679060200"><span class="annot"><span class="annottext">IVarContents a
</span><a href="#local-6989586621679060200"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IVarContents a
</span><a href="#local-6989586621679060200"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-473"></span><span>                      </span><span class="annot"><span class="annottext">IVarContents a
</span><a href="Control.Monad.Par.Scheds.Direct.html#Empty"><span class="hs-identifier hs-var">Empty</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a -&gt; IO ()] -&gt; IVarContents a
forall a. [a -&gt; IO ()] -&gt; IVarContents a
</span><a href="Control.Monad.Par.Scheds.Direct.html#Blocked"><span class="hs-identifier hs-var">Blocked</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Sched -&gt; Par () -&gt; IO ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#pushWork"><span class="hs-identifier hs-var">pushWork</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060205"><span class="hs-identifier hs-var">sch</span></a></span><span> </span><span class="annot"><span class="annottext">(Par () -&gt; IO ()) -&gt; (a -&gt; Par ()) -&gt; a -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Par ()
</span><a href="#local-6989586621679060208"><span class="hs-identifier hs-var">kont</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Par a
forall a. Par a
</span><a href="#local-6989586621679060203"><span class="hs-identifier hs-var">resched</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-474"></span><span>                      </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#Full"><span class="hs-identifier hs-type">Full</span></a></span><span> </span><span id="local-6989586621679060199"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060199"><span class="hs-identifier hs-var">a</span></a></span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; IVarContents a
forall a. a -&gt; IVarContents a
</span><a href="Control.Monad.Par.Scheds.Direct.html#Full"><span class="hs-identifier hs-var">Full</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060199"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Par a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060199"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- kont is implicit here.</span><span>
</span><span id="line-475"></span><span>                      </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#Blocked"><span class="hs-identifier hs-type">Blocked</span></a></span><span> </span><span id="local-6989586621679060198"><span class="annot"><span class="annottext">[a -&gt; IO ()]
</span><a href="#local-6989586621679060198"><span class="hs-identifier hs-var">ks</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a -&gt; IO ()] -&gt; IVarContents a
forall a. [a -&gt; IO ()] -&gt; IVarContents a
</span><a href="Control.Monad.Par.Scheds.Direct.html#Blocked"><span class="hs-identifier hs-var">Blocked</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; Par () -&gt; IO ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#pushWork"><span class="hs-identifier hs-var">pushWork</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060205"><span class="hs-identifier hs-var">sch</span></a></span><span> </span><span class="annot"><span class="annottext">(Par () -&gt; IO ()) -&gt; (a -&gt; Par ()) -&gt; a -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Par ()
</span><a href="#local-6989586621679060208"><span class="hs-identifier hs-var">kont</span></a></span><span class="annot"><span class="annottext">(a -&gt; IO ()) -&gt; [a -&gt; IO ()] -&gt; [a -&gt; IO ()]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a -&gt; IO ()]
</span><a href="#local-6989586621679060198"><span class="hs-identifier hs-var">ks</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Par a
forall a. Par a
</span><a href="#local-6989586621679060203"><span class="hs-identifier hs-var">resched</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-476"></span><span>            </span><span class="annot"><span class="annottext">Par a
</span><a href="#local-6989586621679060201"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-477"></span><span>
</span><span id="line-478"></span><span class="hs-comment">-- | NOTE unsafePeek is NOT exposed directly through this module.  (So</span><span>
</span><span id="line-479"></span><span class="hs-comment">-- this module remains SAFE in the Safe Haskell sense.)  It can only</span><span>
</span><span id="line-480"></span><span class="hs-comment">-- be accessed by importing Control.Monad.Par.Unsafe.</span><span>
</span><span id="line-481"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#unsafePeek"><span class="hs-pragma hs-type">unsafePeek</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-482"></span><span id="local-6989586621679060196"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#unsafePeek"><span class="hs-identifier hs-type">unsafePeek</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060196"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679060196"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-483"></span><span id="unsafePeek"><span class="annot"><span class="annottext">unsafePeek :: IVar a -&gt; Par (Maybe a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#unsafePeek"><span class="hs-identifier hs-var hs-var">unsafePeek</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span id="local-6989586621679060195"><span class="annot"><span class="annottext">IORef (IVarContents a)
</span><a href="#local-6989586621679060195"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-484"></span><span>  </span><span id="local-6989586621679060194"><span class="annot"><span class="annottext">IVarContents a
</span><a href="#local-6989586621679060194"><span class="hs-identifier hs-var">e</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IVarContents a) -&gt; Par (IVarContents a)
forall a. IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#io"><span class="hs-identifier hs-var">io</span></a></span><span class="annot"><span class="annottext">(IO (IVarContents a) -&gt; Par (IVarContents a))
-&gt; IO (IVarContents a) -&gt; Par (IVarContents a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef (IVarContents a) -&gt; IO (IVarContents a)
forall a. HotVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (IVarContents a)
</span><a href="#local-6989586621679060195"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-485"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IVarContents a
</span><a href="#local-6989586621679060194"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-486"></span><span>    </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#Full"><span class="hs-identifier hs-type">Full</span></a></span><span> </span><span id="local-6989586621679060193"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060193"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Par (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060193"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-487"></span><span>    </span><span class="annot"><span class="annottext">IVarContents a
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Par (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span class="hs-comment">------------------------------------------------------------</span><span>
</span><span id="line-490"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#put_"><span class="hs-pragma hs-type">put_</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-491"></span><span class="hs-comment">-- | @put_@ is a version of @put@ that is head-strict rather than fully-strict.</span><span>
</span><span id="line-492"></span><span class="hs-comment">--   In this scheduler, puts immediately execute woken work in the current thread.</span><span>
</span><span id="line-493"></span><span id="put_"><span class="annot"><span class="annottext">put_ :: IVar a -&gt; a -&gt; Par ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#put_"><span class="hs-identifier hs-var hs-var">put_</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span id="local-6989586621679060192"><span class="annot"><span class="annottext">IORef (IVarContents a)
</span><a href="#local-6989586621679060192"><span class="hs-identifier hs-var">vr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679060191"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060191"><span class="hs-identifier hs-var">content</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-494"></span><span>   </span><span id="local-6989586621679060190"><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060190"><span class="hs-identifier hs-var">sched</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Par Sched
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">RD.ask</span></span><span>
</span><span id="line-495"></span><span>   </span><span id="local-6989586621679060189"><span class="annot"><span class="annottext">[a -&gt; IO ()]
</span><a href="#local-6989586621679060189"><span class="hs-identifier hs-var">ks</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [a -&gt; IO ()] -&gt; Par [a -&gt; IO ()]
forall a. IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#io"><span class="hs-identifier hs-var">io</span></a></span><span class="annot"><span class="annottext">(IO [a -&gt; IO ()] -&gt; Par [a -&gt; IO ()])
-&gt; IO [a -&gt; IO ()] -&gt; Par [a -&gt; IO ()]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-496"></span><span>      </span><span id="local-6989586621679060188"><span class="annot"><span class="annottext">[a -&gt; IO ()]
</span><a href="#local-6989586621679060188"><span class="hs-identifier hs-var">ks</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (IVarContents a)
-&gt; (IVarContents a -&gt; (IVarContents a, [a -&gt; IO ()]))
-&gt; IO [a -&gt; IO ()]
forall a b. HotVar a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (IVarContents a)
</span><a href="#local-6989586621679060192"><span class="hs-identifier hs-var">vr</span></a></span><span> </span><span class="annot"><span class="annottext">((IVarContents a -&gt; (IVarContents a, [a -&gt; IO ()]))
 -&gt; IO [a -&gt; IO ()])
-&gt; (IVarContents a -&gt; (IVarContents a, [a -&gt; IO ()]))
-&gt; IO [a -&gt; IO ()]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679060187"><span class="annot"><span class="annottext">IVarContents a
</span><a href="#local-6989586621679060187"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IVarContents a
</span><a href="#local-6989586621679060187"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-497"></span><span>               </span><span class="annot"><span class="annottext">IVarContents a
</span><a href="Control.Monad.Par.Scheds.Direct.html#Empty"><span class="hs-identifier hs-var">Empty</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; IVarContents a
forall a. a -&gt; IVarContents a
</span><a href="Control.Monad.Par.Scheds.Direct.html#Full"><span class="hs-identifier hs-var">Full</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060191"><span class="hs-identifier hs-var">content</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-498"></span><span>               </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#Full"><span class="hs-identifier hs-type">Full</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; (IVarContents a, [a -&gt; IO ()])
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;multiple put&quot;</span></span><span>
</span><span id="line-499"></span><span>               </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#Blocked"><span class="hs-identifier hs-type">Blocked</span></a></span><span> </span><span id="local-6989586621679060186"><span class="annot"><span class="annottext">[a -&gt; IO ()]
</span><a href="#local-6989586621679060186"><span class="hs-identifier hs-var">ks</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; IVarContents a
forall a. a -&gt; IVarContents a
</span><a href="Control.Monad.Par.Scheds.Direct.html#Full"><span class="hs-identifier hs-var">Full</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060191"><span class="hs-identifier hs-var">content</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[a -&gt; IO ()]
</span><a href="#local-6989586621679060186"><span class="hs-identifier hs-var">ks</span></a></span><span class="hs-special">)</span><span class="hs-cpp">
#ifdef DEBUG_DIRECT
</span><span>      </span><span class="hs-identifier">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dbglvl</span><span> </span><span class="hs-operator">&gt;=</span><span>  </span><span class="hs-number">3</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-502"></span><span>         </span><span class="hs-identifier">sn</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">makeStableName</span><span> </span><span class="hs-identifier">vr</span><span>
</span><span id="line-503"></span><span>         </span><span class="hs-identifier">printf</span><span> </span><span class="hs-string">&quot; [%d] Put value %s into IVar %d.  Waking up %d continuations.\n&quot;</span><span>
</span><span id="line-504"></span><span>                </span><span class="hs-special">(</span><span class="hs-identifier">no</span><span> </span><span class="hs-identifier">sched</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">content</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hashStableName</span><span> </span><span class="hs-identifier">sn</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">length</span><span> </span><span class="hs-identifier">ks</span><span class="hs-special">)</span><span>
</span><span id="line-505"></span><span>         </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>      </span><span class="annot"><span class="annottext">[a -&gt; IO ()] -&gt; IO [a -&gt; IO ()]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[a -&gt; IO ()]
</span><a href="#local-6989586621679060188"><span class="hs-identifier hs-var">ks</span></a></span><span>
</span><span id="line-508"></span><span>   </span><span class="annot"><span class="annottext">Sched -&gt; [a -&gt; IO ()] -&gt; a -&gt; Par ()
forall a. Sched -&gt; [a -&gt; IO ()] -&gt; a -&gt; Par ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#wakeUp"><span class="hs-identifier hs-var">wakeUp</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060190"><span class="hs-identifier hs-var">sched</span></a></span><span> </span><span class="annot"><span class="annottext">[a -&gt; IO ()]
</span><a href="#local-6989586621679060189"><span class="hs-identifier hs-var">ks</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060191"><span class="hs-identifier hs-var">content</span></a></span><span>
</span><span id="line-509"></span><span>
</span><span id="line-510"></span><span class="hs-comment">-- | NOTE unsafeTryPut is NOT exposed directly through this module.  (So</span><span>
</span><span id="line-511"></span><span class="hs-comment">-- this module remains SAFE in the Safe Haskell sense.)  It can only</span><span>
</span><span id="line-512"></span><span class="hs-comment">-- be accessed by importing Control.Monad.Par.Unsafe.</span><span>
</span><span id="line-513"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#unsafeTryPut"><span class="hs-pragma hs-type">unsafeTryPut</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-514"></span><span id="unsafeTryPut"><span class="annot"><span class="annottext">unsafeTryPut :: IVar b -&gt; b -&gt; Par b
</span><a href="Control.Monad.Par.Scheds.Direct.html#unsafeTryPut"><span class="hs-identifier hs-var hs-var">unsafeTryPut</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span id="local-6989586621679060183"><span class="annot"><span class="annottext">IORef (IVarContents b)
</span><a href="#local-6989586621679060183"><span class="hs-identifier hs-var">vr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679060182"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679060182"><span class="hs-identifier hs-var">content</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-515"></span><span>   </span><span class="hs-comment">-- Head strict rather than fully strict.</span><span>
</span><span id="line-516"></span><span>   </span><span id="local-6989586621679060181"><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060181"><span class="hs-identifier hs-var">sched</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Par Sched
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">RD.ask</span></span><span>
</span><span id="line-517"></span><span>   </span><span class="hs-special">(</span><span id="local-6989586621679060180"><span class="annot"><span class="annottext">[b -&gt; IO ()]
</span><a href="#local-6989586621679060180"><span class="hs-identifier hs-var">ks</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679060179"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679060179"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ([b -&gt; IO ()], b) -&gt; Par ([b -&gt; IO ()], b)
forall a. IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#io"><span class="hs-identifier hs-var">io</span></a></span><span class="annot"><span class="annottext">(IO ([b -&gt; IO ()], b) -&gt; Par ([b -&gt; IO ()], b))
-&gt; IO ([b -&gt; IO ()], b) -&gt; Par ([b -&gt; IO ()], b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-518"></span><span>      </span><span id="local-6989586621679060178"><span class="annot"><span class="annottext">([b -&gt; IO ()], b)
</span><a href="#local-6989586621679060178"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (IVarContents b)
-&gt; (IVarContents b -&gt; (IVarContents b, ([b -&gt; IO ()], b)))
-&gt; IO ([b -&gt; IO ()], b)
forall a b. HotVar a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (IVarContents b)
</span><a href="#local-6989586621679060183"><span class="hs-identifier hs-var">vr</span></a></span><span> </span><span class="annot"><span class="annottext">((IVarContents b -&gt; (IVarContents b, ([b -&gt; IO ()], b)))
 -&gt; IO ([b -&gt; IO ()], b))
-&gt; (IVarContents b -&gt; (IVarContents b, ([b -&gt; IO ()], b)))
-&gt; IO ([b -&gt; IO ()], b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679060177"><span class="annot"><span class="annottext">IVarContents b
</span><a href="#local-6989586621679060177"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IVarContents b
</span><a href="#local-6989586621679060177"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-519"></span><span>                   </span><span class="annot"><span class="annottext">IVarContents b
</span><a href="Control.Monad.Par.Scheds.Direct.html#Empty"><span class="hs-identifier hs-var">Empty</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; IVarContents b
forall a. a -&gt; IVarContents a
</span><a href="Control.Monad.Par.Scheds.Direct.html#Full"><span class="hs-identifier hs-var">Full</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679060182"><span class="hs-identifier hs-var">content</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679060182"><span class="hs-identifier hs-var">content</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-520"></span><span>                   </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#Full"><span class="hs-identifier hs-type">Full</span></a></span><span> </span><span id="local-6989586621679060176"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679060176"><span class="hs-identifier hs-var">x</span></a></span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; IVarContents b
forall a. a -&gt; IVarContents a
</span><a href="Control.Monad.Par.Scheds.Direct.html#Full"><span class="hs-identifier hs-var">Full</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679060176"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679060176"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-521"></span><span>                   </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#Blocked"><span class="hs-identifier hs-type">Blocked</span></a></span><span> </span><span id="local-6989586621679060175"><span class="annot"><span class="annottext">[b -&gt; IO ()]
</span><a href="#local-6989586621679060175"><span class="hs-identifier hs-var">ks</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; IVarContents b
forall a. a -&gt; IVarContents a
</span><a href="Control.Monad.Par.Scheds.Direct.html#Full"><span class="hs-identifier hs-var">Full</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679060182"><span class="hs-identifier hs-var">content</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[b -&gt; IO ()]
</span><a href="#local-6989586621679060175"><span class="hs-identifier hs-var">ks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679060182"><span class="hs-identifier hs-var">content</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-cpp">
#ifdef DEBUG_DIRECT
</span><span>      </span><span class="hs-identifier">sn</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">makeStableName</span><span> </span><span class="hs-identifier">vr</span><span>
</span><span id="line-524"></span><span>      </span><span class="hs-identifier">printf</span><span> </span><span class="hs-string">&quot; [%d] unsafeTryPut: value %s in IVar %d.  Waking up %d continuations.\n&quot;</span><span>
</span><span id="line-525"></span><span>             </span><span class="hs-special">(</span><span class="hs-identifier">no</span><span> </span><span class="hs-identifier">sched</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">content</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hashStableName</span><span> </span><span class="hs-identifier">sn</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">length</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fst</span><span> </span><span class="hs-identifier">pr</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>      </span><span class="annot"><span class="annottext">([b -&gt; IO ()], b) -&gt; IO ([b -&gt; IO ()], b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([b -&gt; IO ()], b)
</span><a href="#local-6989586621679060178"><span class="hs-identifier hs-var">pr</span></a></span><span>
</span><span id="line-528"></span><span>   </span><span class="annot"><span class="annottext">Sched -&gt; [b -&gt; IO ()] -&gt; b -&gt; Par ()
forall a. Sched -&gt; [a -&gt; IO ()] -&gt; a -&gt; Par ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#wakeUp"><span class="hs-identifier hs-var">wakeUp</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060181"><span class="hs-identifier hs-var">sched</span></a></span><span> </span><span class="annot"><span class="annottext">[b -&gt; IO ()]
</span><a href="#local-6989586621679060180"><span class="hs-identifier hs-var">ks</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679060182"><span class="hs-identifier hs-var">content</span></a></span><span>
</span><span id="line-529"></span><span>   </span><span class="annot"><span class="annottext">b -&gt; Par b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679060179"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-530"></span><span>
</span><span id="line-531"></span><span class="hs-comment">-- | When an IVar is filled in, continuations wake up.</span><span>
</span><span id="line-532"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#wakeUp"><span class="hs-pragma hs-type">wakeUp</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-533"></span><span id="local-6989586621679060486"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#wakeUp"><span class="hs-identifier hs-type">wakeUp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Sched"><span class="hs-identifier hs-type">Sched</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679060486"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679060486"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-534"></span><span id="wakeUp"><span class="annot"><span class="annottext">wakeUp :: Sched -&gt; [a -&gt; IO ()] -&gt; a -&gt; Par ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#wakeUp"><span class="hs-identifier hs-var hs-var">wakeUp</span></a></span></span><span> </span><span id="local-6989586621679060174"><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060174"><span class="hs-identifier hs-var">_sched</span></a></span></span><span> </span><span id="local-6989586621679060173"><span class="annot"><span class="annottext">[a -&gt; IO ()]
</span><a href="#local-6989586621679060173"><span class="hs-identifier hs-var">ks</span></a></span></span><span> </span><span id="local-6989586621679060172"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060172"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a -&gt; IO ()] -&gt; Par ()
</span><a href="#local-6989586621679060171"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">[a -&gt; IO ()]
</span><a href="#local-6989586621679060173"><span class="hs-identifier hs-var">ks</span></a></span><span>
</span><span id="line-535"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-536"></span><span>   </span><span id="local-6989586621679060171"><span class="annot"><span class="annottext">loop :: [a -&gt; IO ()] -&gt; Par ()
</span><a href="#local-6989586621679060171"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; Par ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-537"></span><span>   </span><span class="annot"><a href="#local-6989586621679060171"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679060170"><span class="annot"><span class="annottext">a -&gt; IO ()
</span><a href="#local-6989586621679060170"><span class="hs-identifier hs-var">kont</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679060169"><span class="annot"><span class="annottext">[a -&gt; IO ()]
</span><a href="#local-6989586621679060169"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-538"></span><span>     </span><span class="hs-comment">-- FIXME -- without strict firewalls keeping ivars from moving</span><span>
</span><span id="line-539"></span><span>     </span><span class="hs-comment">-- between runPar sessions, if we allow nested scheduler use</span><span>
</span><span id="line-540"></span><span>     </span><span class="hs-comment">-- we could potentially wake up work belonging to a different</span><span>
</span><span id="line-541"></span><span>     </span><span class="hs-comment">-- runPar and thus bring it into our worker and delay our own</span><span>
</span><span id="line-542"></span><span>     </span><span class="hs-comment">-- continuation until its completion.</span><span>
</span><span id="line-543"></span><span>     </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#_PARPUTS"><span class="hs-identifier hs-var">_PARPUTS</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-544"></span><span>       </span><span class="hs-comment">-- We do NOT force the putting thread to postpone its continuation.</span><span>
</span><span id="line-545"></span><span>       </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">IVar ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Par () -&gt; Par (IVar ())
forall a. Par a -&gt; Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#spawn_"><span class="hs-identifier hs-var">spawn_</span></a></span><span class="annot"><span class="annottext">(Par () -&gt; Par (IVar ())) -&gt; Par () -&gt; Par (IVar ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; IO ()) -&gt; [a -&gt; IO ()] -&gt; Par ()
</span><a href="#local-6989586621679060168"><span class="hs-identifier hs-var">pMap</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; IO ()
</span><a href="#local-6989586621679060170"><span class="hs-identifier hs-var">kont</span></a></span><span> </span><span class="annot"><span class="annottext">[a -&gt; IO ()]
</span><a href="#local-6989586621679060169"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-546"></span><span>          </span><span class="annot"><span class="annottext">() -&gt; Par ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-547"></span><span>       </span><span class="hs-comment">-- case rest of</span><span>
</span><span id="line-548"></span><span>       </span><span class="hs-comment">--   [] -&gt; spawn_$ io$ kont arg</span><span>
</span><span id="line-549"></span><span>       </span><span class="hs-comment">--   _  -&gt; spawn_$ do spawn_$ io$ kont arg</span><span>
</span><span id="line-550"></span><span>       </span><span class="hs-comment">--                    io$ parchain rest</span><span>
</span><span id="line-551"></span><span>       </span><span class="hs-comment">-- error$&quot;FINISHME - wake &quot;++show (length ks)++&quot; conts&quot;</span><span>
</span><span id="line-552"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-553"></span><span>       </span><span class="hs-comment">-- This version sacrifices a parallelism opportunity and</span><span>
</span><span id="line-554"></span><span>       </span><span class="hs-comment">-- imposes additional serialization.</span><span>
</span><span id="line-555"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-556"></span><span>       </span><span class="hs-comment">-- [2012.08.31] WARNING -- this serialzation CAN cause deadlock.</span><span>
</span><span id="line-557"></span><span>       </span><span class="hs-comment">-- This &quot;optimization&quot; should not be on the table.</span><span>
</span><span id="line-558"></span><span>       </span><span class="hs-comment">-- mapM_ ($arg) ks</span><span>
</span><span id="line-559"></span><span>       </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Par ()
forall a. IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#io"><span class="hs-identifier hs-var">io</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; Par ()) -&gt; IO () -&gt; Par ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; IO ()
</span><a href="#local-6989586621679060170"><span class="hs-identifier hs-var">kont</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060172"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-560"></span><span>          </span><span class="annot"><span class="annottext">[a -&gt; IO ()] -&gt; Par ()
</span><a href="#local-6989586621679060171"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">[a -&gt; IO ()]
</span><a href="#local-6989586621679060169"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-561"></span><span>     </span><span class="annot"><span class="annottext">() -&gt; Par ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-562"></span><span>
</span><span id="line-563"></span><span>   </span><span id="local-6989586621679060168"><span class="annot"><span class="annottext">pMap :: (a -&gt; IO ()) -&gt; [a -&gt; IO ()] -&gt; Par ()
</span><a href="#local-6989586621679060168"><span class="hs-identifier hs-var hs-var">pMap</span></a></span></span><span> </span><span id="local-6989586621679060167"><span class="annot"><span class="annottext">a -&gt; IO ()
</span><a href="#local-6989586621679060167"><span class="hs-identifier hs-var">kont</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Par ()
forall a. IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#io"><span class="hs-identifier hs-var">io</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; Par ()) -&gt; IO () -&gt; Par ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; IO ()
</span><a href="#local-6989586621679060167"><span class="hs-identifier hs-var">kont</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060172"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-564"></span><span>   </span><span class="annot"><a href="#local-6989586621679060168"><span class="hs-identifier hs-var">pMap</span></a></span><span> </span><span id="local-6989586621679060166"><span class="annot"><span class="annottext">a -&gt; IO ()
</span><a href="#local-6989586621679060166"><span class="hs-identifier hs-var">kont</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679060165"><span class="annot"><span class="annottext">a -&gt; IO ()
</span><a href="#local-6989586621679060165"><span class="hs-identifier hs-var">more</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679060164"><span class="annot"><span class="annottext">[a -&gt; IO ()]
</span><a href="#local-6989586621679060164"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-565"></span><span>     </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">IVar ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Par () -&gt; Par (IVar ())
forall a. Par a -&gt; Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#spawn_"><span class="hs-identifier hs-var">spawn_</span></a></span><span class="annot"><span class="annottext">(Par () -&gt; Par (IVar ())) -&gt; Par () -&gt; Par (IVar ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Par ()
forall a. IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#io"><span class="hs-identifier hs-var">io</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; Par ()) -&gt; IO () -&gt; Par ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; IO ()
</span><a href="#local-6989586621679060166"><span class="hs-identifier hs-var">kont</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060172"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-566"></span><span>        </span><span class="annot"><span class="annottext">(a -&gt; IO ()) -&gt; [a -&gt; IO ()] -&gt; Par ()
</span><a href="#local-6989586621679060168"><span class="hs-identifier hs-var">pMap</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; IO ()
</span><a href="#local-6989586621679060165"><span class="hs-identifier hs-var">more</span></a></span><span> </span><span class="annot"><span class="annottext">[a -&gt; IO ()]
</span><a href="#local-6989586621679060164"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-567"></span><span>
</span><span id="line-568"></span><span>   </span><span class="hs-comment">-- parchain [kont] = kont arg</span><span>
</span><span id="line-569"></span><span>   </span><span class="hs-comment">-- parchain (kont:rest) = do spawn$ io$ kont arg</span><span>
</span><span id="line-570"></span><span>   </span><span class="hs-comment">--                           parchain rest</span><span>
</span><span id="line-571"></span><span>
</span><span id="line-572"></span><span>
</span><span id="line-573"></span><span class="hs-comment">------------------------------------------------------------</span><span>
</span><span id="line-574"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#fork"><span class="hs-pragma hs-type">fork</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-575"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#fork"><span class="hs-identifier hs-type">fork</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-576"></span><span id="fork"><span class="annot"><span class="annottext">fork :: Par () -&gt; Par ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#fork"><span class="hs-identifier hs-var hs-var">fork</span></a></span></span><span> </span><span id="local-6989586621679060163"><span class="annot"><span class="annottext">Par ()
</span><a href="#local-6989586621679060163"><span class="hs-identifier hs-var">task</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-577"></span><span>  </span><span class="hs-comment">-- Forking the &quot;parent&quot; means offering up the continuation of the</span><span>
</span><span id="line-578"></span><span>  </span><span class="hs-comment">-- fork rather than the task argument for stealing:</span><span>
</span><span id="line-579"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#_FORKPARENT"><span class="hs-identifier hs-var">_FORKPARENT</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-580"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-581"></span><span>      </span><span id="local-6989586621679060162"><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060162"><span class="hs-identifier hs-var">sched</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Par Sched
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">RD.ask</span></span><span>
</span><span id="line-582"></span><span>      </span><span class="annot"><span class="annottext">((() -&gt; Par ()) -&gt; Par ()) -&gt; Par ()
forall (m :: * -&gt; *) a b. MonadCont m =&gt; ((a -&gt; m b) -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">callCC</span></span><span class="annot"><span class="annottext">(((() -&gt; Par ()) -&gt; Par ()) -&gt; Par ())
-&gt; ((() -&gt; Par ()) -&gt; Par ()) -&gt; Par ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679060161"><span class="annot"><span class="annottext">() -&gt; Par ()
</span><a href="#local-6989586621679060161"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-583"></span><span>         </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679060160"><span class="annot"><span class="annottext">wrapped :: Par ()
</span><a href="#local-6989586621679060160"><span class="hs-identifier hs-var hs-var">wrapped</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; Par ()
</span><a href="#local-6989586621679060161"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-584"></span><span>         </span><span class="annot"><span class="annottext">IO () -&gt; Par ()
forall a. IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#io"><span class="hs-identifier hs-var">io</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; Par ()) -&gt; IO () -&gt; Par ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Sched -&gt; Par () -&gt; IO ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#pushWork"><span class="hs-identifier hs-var">pushWork</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060162"><span class="hs-identifier hs-var">sched</span></a></span><span> </span><span class="annot"><span class="annottext">Par ()
</span><a href="#local-6989586621679060160"><span class="hs-identifier hs-var">wrapped</span></a></span><span>
</span><span id="line-585"></span><span>         </span><span class="hs-comment">-- Then execute the child task and return to the scheduler when it is complete:</span><span>
</span><span id="line-586"></span><span>         </span><span class="annot"><span class="annottext">Par ()
</span><a href="#local-6989586621679060163"><span class="hs-identifier hs-var">task</span></a></span><span>
</span><span id="line-587"></span><span>         </span><span class="hs-comment">-- If we get to this point we have finished the child task:</span><span>
</span><span id="line-588"></span><span>         </span><span class="annot"><span class="annottext">Any
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Par Any
forall a. Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#longjmpSched"><span class="hs-identifier hs-var">longjmpSched</span></a></span><span> </span><span class="hs-comment">-- We reschedule to pop the cont we pushed.</span><span>
</span><span id="line-589"></span><span>         </span><span class="hs-comment">-- TODO... OPTIMIZATION: we could also try the pop directly, and if it succeeds return normally....</span><span>
</span><span id="line-590"></span><span>         </span><span class="annot"><span class="annottext">IO () -&gt; Par ()
forall a. IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#io"><span class="hs-identifier hs-var">io</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; Par ()) -&gt; IO () -&gt; Par ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; !!! ERROR: Should never reach this point #1\n&quot;</span></span><span>
</span><span id="line-591"></span><span>
</span><span id="line-592"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Par () -&gt; Par ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span class="annot"><span class="annottext">(Par () -&gt; Par ()) -&gt; Par () -&gt; Par ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-593"></span><span>       </span><span id="local-6989586621679060159"><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060159"><span class="hs-identifier hs-var">sched2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Par Sched
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">RD.ask</span></span><span>
</span><span id="line-594"></span><span>       </span><span class="annot"><span class="annottext">IO () -&gt; Par ()
forall a. IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#io"><span class="hs-identifier hs-var">io</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; Par ()) -&gt; IO () -&gt; Par ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; Int -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;  -  called parent continuation... was on worker [%d] now on worker [%d]\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var hs-var">no</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060162"><span class="hs-identifier hs-var">sched</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var hs-var">no</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060159"><span class="hs-identifier hs-var">sched2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-595"></span><span>       </span><span class="annot"><span class="annottext">() -&gt; Par ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-596"></span><span>
</span><span id="line-597"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-598"></span><span>      </span><span id="local-6989586621679060158"><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060158"><span class="hs-identifier hs-var">sch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Par Sched
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">RD.ask</span></span><span>
</span><span id="line-599"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Par () -&gt; Par ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span class="annot"><span class="annottext">(Par () -&gt; Par ()) -&gt; Par () -&gt; Par ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Par ()
forall a. IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#io"><span class="hs-identifier hs-var">io</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; Par ()) -&gt; IO () -&gt; Par ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d] forking task...\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var hs-var">no</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060158"><span class="hs-identifier hs-var">sch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-600"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; Par ()
forall a. IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#io"><span class="hs-identifier hs-var">io</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; Par ()) -&gt; IO () -&gt; Par ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Sched -&gt; Par () -&gt; IO ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#pushWork"><span class="hs-identifier hs-var">pushWork</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060158"><span class="hs-identifier hs-var">sch</span></a></span><span> </span><span class="annot"><span class="annottext">Par ()
</span><a href="#local-6989586621679060163"><span class="hs-identifier hs-var">task</span></a></span><span>
</span><span id="line-601"></span><span>
</span><span id="line-602"></span><span class="hs-comment">-- This routine &quot;longjmp&quot;s to the scheduler, throwing out its own continuation.</span><span>
</span><span id="line-603"></span><span id="local-6989586621679060489"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#longjmpSched"><span class="hs-identifier hs-type">longjmpSched</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060489"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-604"></span><span class="hs-comment">-- longjmpSched = Par $ C.ContT rescheduleR</span><span>
</span><span id="line-605"></span><span id="longjmpSched"><span class="annot"><span class="annottext">longjmpSched :: Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#longjmpSched"><span class="hs-identifier hs-var hs-var">longjmpSched</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ContT () ROnly a -&gt; Par a
forall a. ContT () ROnly a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-var">Par</span></a></span><span> </span><span class="annot"><span class="annottext">(ContT () ROnly a -&gt; Par a) -&gt; ContT () ROnly a -&gt; Par a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((a -&gt; ROnly ()) -&gt; ROnly ()) -&gt; ContT () ROnly a
forall k (r :: k) (m :: k -&gt; *) a.
((a -&gt; m r) -&gt; m r) -&gt; ContT r m a
</span><span class="hs-identifier hs-var">C.ContT</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621679060156"><span class="annot"><span class="annottext">a -&gt; ROnly ()
</span><a href="#local-6989586621679060156"><span class="hs-identifier hs-var">_k</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SessionID -&gt; (Any -&gt; ROnly ()) -&gt; ROnly ()
forall a. SessionID -&gt; (a -&gt; ROnly ()) -&gt; ROnly ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#rescheduleR"><span class="hs-identifier hs-var">rescheduleR</span></a></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Any -&gt; ROnly ()
forall a. String -&gt; a -&gt; ROnly ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#trivialCont"><span class="hs-identifier hs-var">trivialCont</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;longjmpSched&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-606"></span><span>
</span><span id="line-607"></span><span class="hs-comment">-- Reschedule the scheduler loop until it observes sessionFinished==True, and</span><span>
</span><span id="line-608"></span><span class="hs-comment">-- then it finally invokes its continuation.</span><span>
</span><span id="line-609"></span><span id="local-6989586621679060541"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#rescheduleR"><span class="hs-identifier hs-type">rescheduleR</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679060541"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#ROnly"><span class="hs-identifier hs-type">ROnly</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#ROnly"><span class="hs-identifier hs-type">ROnly</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-610"></span><span id="rescheduleR"><span class="annot"><span class="annottext">rescheduleR :: SessionID -&gt; (a -&gt; ROnly ()) -&gt; ROnly ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#rescheduleR"><span class="hs-identifier hs-var hs-var">rescheduleR</span></a></span></span><span> </span><span id="local-6989586621679060155"><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060155"><span class="hs-identifier hs-var">cnt</span></a></span></span><span> </span><span id="local-6989586621679060154"><span class="annot"><span class="annottext">a -&gt; ROnly ()
</span><a href="#local-6989586621679060154"><span class="hs-identifier hs-var">kont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-611"></span><span>  </span><span id="local-6989586621679060153"><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060153"><span class="hs-identifier hs-var">mysched</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT Sched IO Sched
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">RD.ask</span></span><span>
</span><span id="line-612"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; ROnly () -&gt; ROnly ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span class="annot"><span class="annottext">(ROnly () -&gt; ROnly ()) -&gt; ROnly () -&gt; ROnly ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; ROnly ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span class="annot"><span class="annottext">(IO () -&gt; ROnly ()) -&gt; IO () -&gt; ROnly ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679060152"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060152"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-613"></span><span>                       </span><span id="local-6989586621679060151"><span class="annot"><span class="annottext">[(SessionID, Bool)]
</span><a href="#local-6989586621679060151"><span class="hs-identifier hs-var">sess</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Sched -&gt; IO [(SessionID, Bool)]
</span><a href="Control.Monad.Par.Scheds.Direct.html#readSessions"><span class="hs-identifier hs-var">readSessions</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060153"><span class="hs-identifier hs-var">mysched</span></a></span><span>
</span><span id="line-614"></span><span>                       </span><span id="local-6989586621679060149"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679060149"><span class="hs-identifier hs-var">null</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleDeque (Par ()) -&gt; IO Bool
forall elt. SimpleDeque elt -&gt; IO Bool
</span><span class="hs-identifier hs-var">R.nullQ</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; WSDeque (Par ())
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#workpool"><span class="hs-identifier hs-var hs-var">workpool</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060153"><span class="hs-identifier hs-var">mysched</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-615"></span><span>                       </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; String -&gt; SessionID -&gt; String -&gt; String -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d %s]  - Reschedule #%d... sessions %s, pool empty %s\n&quot;</span></span><span>
</span><span id="line-616"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var hs-var">no</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060153"><span class="hs-identifier hs-var">mysched</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060152"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060155"><span class="hs-identifier hs-var">cnt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(SessionID, Bool)] -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">[(SessionID, Bool)]
</span><a href="#local-6989586621679060151"><span class="hs-identifier hs-var">sess</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679060149"><span class="hs-identifier hs-var">null</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-617"></span><span>  </span><span id="local-6989586621679060147"><span class="annot"><span class="annottext">Maybe (Par ())
</span><a href="#local-6989586621679060147"><span class="hs-identifier hs-var">mtask</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Maybe (Par ())) -&gt; ReaderT Sched IO (Maybe (Par ()))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span class="annot"><span class="annottext">(IO (Maybe (Par ())) -&gt; ReaderT Sched IO (Maybe (Par ())))
-&gt; IO (Maybe (Par ())) -&gt; ReaderT Sched IO (Maybe (Par ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Sched -&gt; IO (Maybe (Par ()))
</span><a href="Control.Monad.Par.Scheds.Direct.html#popWork"><span class="hs-identifier hs-var">popWork</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060153"><span class="hs-identifier hs-var">mysched</span></a></span><span>
</span><span id="line-618"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Par ())
</span><a href="#local-6989586621679060147"><span class="hs-identifier hs-var">mtask</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-619"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Par ())
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-620"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Session"><span class="hs-identifier hs-type">Session</span></a></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679060146"><span class="annot"><span class="annottext">HotVar Bool
</span><a href="#local-6989586621679060146"><span class="hs-identifier hs-var">finRef</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[Session]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [Session] -&gt; ReaderT Sched IO [Session]
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span class="annot"><span class="annottext">(IO [Session] -&gt; ReaderT Sched IO [Session])
-&gt; IO [Session] -&gt; ReaderT Sched IO [Session]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HotVar [Session] -&gt; IO [Session]
forall a. HotVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(HotVar [Session] -&gt; IO [Session])
-&gt; HotVar [Session] -&gt; IO [Session]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Sched -&gt; HotVar [Session]
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#sessions"><span class="hs-identifier hs-var hs-var">sessions</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060153"><span class="hs-identifier hs-var">mysched</span></a></span><span>
</span><span id="line-621"></span><span>                  </span><span id="local-6989586621679060145"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679060145"><span class="hs-identifier hs-var">fin</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Bool -&gt; ReaderT Sched IO Bool
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span class="annot"><span class="annottext">(IO Bool -&gt; ReaderT Sched IO Bool)
-&gt; IO Bool -&gt; ReaderT Sched IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HotVar Bool -&gt; IO Bool
forall a. HotVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">HotVar Bool
</span><a href="#local-6989586621679060146"><span class="hs-identifier hs-var">finRef</span></a></span><span>
</span><span id="line-622"></span><span>                  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679060145"><span class="hs-identifier hs-var">fin</span></a></span><span>
</span><span id="line-623"></span><span>                   </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ROnly () -&gt; ROnly ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbglvl"><span class="hs-identifier hs-var">dbglvl</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ROnly () -&gt; ROnly ()) -&gt; ROnly () -&gt; ROnly ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; ROnly ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ROnly ()) -&gt; IO () -&gt; ROnly ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-624"></span><span>                             </span><span id="local-6989586621679060144"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060144"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-625"></span><span>                             </span><span id="local-6989586621679060143"><span class="annot"><span class="annottext">[(SessionID, Bool)]
</span><a href="#local-6989586621679060143"><span class="hs-identifier hs-var">sess</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Sched -&gt; IO [(SessionID, Bool)]
</span><a href="Control.Monad.Par.Scheds.Direct.html#readSessions"><span class="hs-identifier hs-var">readSessions</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060153"><span class="hs-identifier hs-var">mysched</span></a></span><span>
</span><span id="line-626"></span><span>                             </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; String -&gt; String -&gt; String -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d %s]  - DROP out of reschedule loop, sessionFinished=%s, all sessions %s\n&quot;</span></span><span>
</span><span id="line-627"></span><span>                                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var hs-var">no</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060153"><span class="hs-identifier hs-var">mysched</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060144"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679060145"><span class="hs-identifier hs-var">fin</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(SessionID, Bool)] -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">[(SessionID, Bool)]
</span><a href="#local-6989586621679060143"><span class="hs-identifier hs-var">sess</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-628"></span><span>                             </span><span id="local-6989586621679060142"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679060142"><span class="hs-identifier hs-var">empt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleDeque (Par ()) -&gt; IO Bool
forall elt. SimpleDeque elt -&gt; IO Bool
</span><span class="hs-identifier hs-var">R.nullQ</span></span><span class="annot"><span class="annottext">(SimpleDeque (Par ()) -&gt; IO Bool)
-&gt; SimpleDeque (Par ()) -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Sched -&gt; WSDeque (Par ())
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#workpool"><span class="hs-identifier hs-var hs-var">workpool</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060153"><span class="hs-identifier hs-var">mysched</span></a></span><span>
</span><span id="line-629"></span><span>                             </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679060142"><span class="hs-identifier hs-var">empt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-630"></span><span>                               </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; String -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d %s] - WARNING - leaving rescheduleR while local workpoll is nonempty\n&quot;</span></span><span>
</span><span id="line-631"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var hs-var">no</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060153"><span class="hs-identifier hs-var">mysched</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060144"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-632"></span><span>
</span><span id="line-633"></span><span>                           </span><span class="annot"><span class="annottext">a -&gt; ROnly ()
</span><a href="#local-6989586621679060154"><span class="hs-identifier hs-var">kont</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; a
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Direct.hs: The result value from rescheduleR should not be used.&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-634"></span><span>                   </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-635"></span><span>                     </span><span class="hs-comment">-- when (dbglvl &gt;= 1) $ liftIO $ do</span><span>
</span><span id="line-636"></span><span>                     </span><span class="hs-comment">--     tid &lt;- myThreadId</span><span>
</span><span id="line-637"></span><span>                     </span><span class="hs-comment">--     sess &lt;- readSessions mysched</span><span>
</span><span id="line-638"></span><span>                     </span><span class="hs-comment">--     printf &quot; [%d %s]  -    Apparently NOT finished with head session... trying to steal, all sessions %s\n&quot;</span><span>
</span><span id="line-639"></span><span>                     </span><span class="hs-comment">--            (no mysched) (show tid) (show sess)</span><span>
</span><span id="line-640"></span><span>                     </span><span class="annot"><span class="annottext">IO () -&gt; ROnly ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span class="annot"><span class="annottext">(IO () -&gt; ROnly ()) -&gt; IO () -&gt; ROnly ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Sched -&gt; IO ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#steal"><span class="hs-identifier hs-var">steal</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060153"><span class="hs-identifier hs-var">mysched</span></a></span><span class="hs-cpp">
#ifdef WAKEIDLE
</span><span class="hs-comment">--                     io$ tryWakeIdle (idle mysched)</span><span class="hs-cpp">
#endif
</span><span>                     </span><span class="annot"><span class="annottext">IO () -&gt; ROnly ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><span class="hs-identifier hs-var">yield</span></span><span>
</span><span id="line-645"></span><span>                     </span><span class="annot"><span class="annottext">SessionID -&gt; (a -&gt; ROnly ()) -&gt; ROnly ()
forall a. SessionID -&gt; (a -&gt; ROnly ()) -&gt; ROnly ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#rescheduleR"><span class="hs-identifier hs-var">rescheduleR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060155"><span class="hs-identifier hs-var">cnt</span></a></span><span class="annot"><span class="annottext">SessionID -&gt; SessionID -&gt; SessionID
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">SessionID
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; ROnly ()
</span><a href="#local-6989586621679060154"><span class="hs-identifier hs-var">kont</span></a></span><span>
</span><span id="line-646"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679060140"><span class="annot"><span class="annottext">Par ()
</span><a href="#local-6989586621679060140"><span class="hs-identifier hs-var">task</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-647"></span><span>       </span><span class="hs-comment">-- When popping work from our own queue the Sched (Reader value) stays the same:</span><span>
</span><span id="line-648"></span><span>       </span><span class="annot"><span class="annottext">Bool -&gt; ROnly () -&gt; ROnly ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span> </span><span class="annot"><span class="annottext">(ROnly () -&gt; ROnly ()) -&gt; ROnly () -&gt; ROnly ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679060139"><span class="annot"><span class="annottext">StableName (Par ())
</span><a href="#local-6989586621679060139"><span class="hs-identifier hs-var">sn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (StableName (Par ())) -&gt; ReaderT Sched IO (StableName (Par ()))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span class="annot"><span class="annottext">(IO (StableName (Par ()))
 -&gt; ReaderT Sched IO (StableName (Par ())))
-&gt; IO (StableName (Par ()))
-&gt; ReaderT Sched IO (StableName (Par ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Par () -&gt; IO (StableName (Par ()))
forall a. a -&gt; IO (StableName a)
</span><span class="hs-identifier hs-var">makeStableName</span></span><span> </span><span class="annot"><span class="annottext">Par ()
</span><a href="#local-6989586621679060140"><span class="hs-identifier hs-var">task</span></a></span><span>
</span><span id="line-649"></span><span>                     </span><span class="annot"><span class="annottext">IO () -&gt; ROnly ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span class="annot"><span class="annottext">(IO () -&gt; ROnly ()) -&gt; IO () -&gt; ROnly ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; Int -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d] popped work %d from own queue\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var hs-var">no</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060153"><span class="hs-identifier hs-var">mysched</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StableName (Par ()) -&gt; Int
forall a. StableName a -&gt; Int
</span><span class="hs-identifier hs-var">hashStableName</span></span><span> </span><span class="annot"><span class="annottext">StableName (Par ())
</span><a href="#local-6989586621679060139"><span class="hs-identifier hs-var">sn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-650"></span><span>       </span><span class="hs-keyword">let</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.ContT</span></span><span> </span><span id="local-6989586621679060138"><span class="annot"><span class="annottext">(() -&gt; ROnly ()) -&gt; ROnly ()
</span><a href="#local-6989586621679060138"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Par () -&gt; ContT () ROnly ()
forall a. Par a -&gt; ContT () ROnly a
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#unPar"><span class="hs-identifier hs-var hs-var">unPar</span></a></span><span> </span><span class="annot"><span class="annottext">Par ()
</span><a href="#local-6989586621679060140"><span class="hs-identifier hs-var">task</span></a></span><span>
</span><span id="line-651"></span><span>       </span><span class="hs-comment">-- Run the stolen task with a continuation that returns to the scheduler if the task exits normally:</span><span>
</span><span id="line-652"></span><span>       </span><span class="annot"><span class="annottext">(() -&gt; ROnly ()) -&gt; ROnly ()
</span><a href="#local-6989586621679060138"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-653"></span><span>           </span><span id="local-6989586621679060137"><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060137"><span class="hs-identifier hs-var">sch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT Sched IO Sched
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">RD.ask</span></span><span>
</span><span id="line-654"></span><span>           </span><span class="annot"><span class="annottext">Bool -&gt; ROnly () -&gt; ROnly ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span class="annot"><span class="annottext">(ROnly () -&gt; ROnly ()) -&gt; ROnly () -&gt; ROnly ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; ROnly ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span class="annot"><span class="annottext">(IO () -&gt; ROnly ()) -&gt; IO () -&gt; ROnly ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;  + task finished successfully on cpu %d, calling reschedule continuation..\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var hs-var">no</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060137"><span class="hs-identifier hs-var">sch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-655"></span><span>           </span><span class="annot"><span class="annottext">SessionID -&gt; (a -&gt; ROnly ()) -&gt; ROnly ()
forall a. SessionID -&gt; (a -&gt; ROnly ()) -&gt; ROnly ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#rescheduleR"><span class="hs-identifier hs-var">rescheduleR</span></a></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; ROnly ()
</span><a href="#local-6989586621679060154"><span class="hs-identifier hs-var">kont</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-656"></span><span>
</span><span id="line-657"></span><span>
</span><span id="line-658"></span><span class="hs-comment">-- | Attempt to steal work or, failing that, give up and go idle.</span><span>
</span><span id="line-659"></span><span class="hs-comment">--</span><span>
</span><span id="line-660"></span><span class="hs-comment">--   The current policy is to do a burst of of N tries without</span><span>
</span><span id="line-661"></span><span class="hs-comment">--   yielding or pausing inbetween.</span><span>
</span><span id="line-662"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#steal"><span class="hs-identifier hs-type">steal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Sched"><span class="hs-identifier hs-type">Sched</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-663"></span><span id="steal"><span class="annot"><span class="annottext">steal :: Sched -&gt; IO ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#steal"><span class="hs-identifier hs-var hs-var">steal</span></a></span></span><span> </span><span id="local-6989586621679060136"><span class="annot"><span class="annottext">mysched :: Sched
</span><a href="#local-6989586621679060136"><span class="hs-identifier hs-var">mysched</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Sched"><span class="hs-identifier hs-type">Sched</span></a></span><span class="hs-special">{</span><span> </span><span id="local-6989586621679060135"><span class="annot"><span class="annottext">HotVar [MVar Bool]
idle :: HotVar [MVar Bool]
idle :: Sched -&gt; HotVar [MVar Bool]
</span><a href="#local-6989586621679060135"><span class="hs-identifier hs-var hs-var">idle</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679060134"><span class="annot"><span class="annottext">[Sched]
scheds :: [Sched]
scheds :: Sched -&gt; [Sched]
</span><a href="#local-6989586621679060134"><span class="hs-identifier hs-var hs-var">scheds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679060133"><span class="annot"><span class="annottext">HotVar GenIO
rng :: HotVar GenIO
rng :: Sched -&gt; HotVar GenIO
</span><a href="#local-6989586621679060133"><span class="hs-identifier hs-var hs-var">rng</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">no :: Sched -&gt; Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var">no</span></a></span><span class="hs-glyph">=</span><span id="local-6989586621679060132"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060132"><span class="hs-identifier hs-var">my_no</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-664"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbglvl"><span class="hs-identifier hs-var">dbglvl</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679060131"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060131"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-665"></span><span>                       </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; String -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d %s]  + stealing\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060132"><span class="hs-identifier hs-var">my_no</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060131"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-666"></span><span>  </span><span id="local-6989586621679060130"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060130"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO Int
</span><a href="#local-6989586621679060129"><span class="hs-identifier hs-var">getnext</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-667"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; IO ()
</span><a href="#local-6989586621679060128"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060127"><span class="hs-identifier hs-var">maxtries</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060130"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-668"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-669"></span><span class="hs-comment">--    maxtries = numCapabilities -- How many times should we attempt theft before going idle?</span><span>
</span><span id="line-670"></span><span>    </span><span id="local-6989586621679060127"><span class="annot"><span class="annottext">maxtries :: Int
</span><a href="#local-6989586621679060127"><span class="hs-identifier hs-var hs-var">maxtries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">20</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier hs-var">numCapabilities</span></span><span> </span><span class="hs-comment">-- How many times should we attempt theft before going idle?</span><span>
</span><span id="line-671"></span><span>
</span><span id="line-672"></span><span>    </span><span id="local-6989586621679060129"><span class="annot"><span class="annottext">getnext :: Int -&gt; IO Int
</span><a href="#local-6989586621679060129"><span class="hs-identifier hs-var hs-var">getnext</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HotVar GenIO -&gt; IO Int
</span><a href="Control.Monad.Par.Scheds.Direct.html#rand"><span class="hs-identifier hs-var">rand</span></a></span><span> </span><span class="annot"><span class="annottext">HotVar GenIO
</span><a href="#local-6989586621679060133"><span class="hs-identifier hs-var">rng</span></a></span><span>
</span><span id="line-673"></span><span>
</span><span id="line-674"></span><span>    </span><span class="hs-comment">----------------------------------------</span><span>
</span><span id="line-675"></span><span>    </span><span class="hs-comment">-- IDLING behavior:</span><span>
</span><span id="line-676"></span><span>    </span><span id="local-6989586621679060128"><span class="annot"><span class="annottext">go :: Int -&gt; Int -&gt; IO ()
</span><a href="#local-6989586621679060128"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#_IDLING_ON"><span class="hs-identifier hs-var">_IDLING_ON</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-677"></span><span>            </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679060125"><span class="annot"><span class="annottext">MVar Bool
</span><a href="#local-6989586621679060125"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (MVar Bool)
forall a. IO (MVar a)
</span><span class="hs-identifier hs-var">newEmptyMVar</span></span><span>
</span><span id="line-678"></span><span>               </span><span id="local-6989586621679060124"><span class="annot"><span class="annottext">[MVar Bool]
</span><a href="#local-6989586621679060124"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HotVar [MVar Bool]
-&gt; ([MVar Bool] -&gt; ([MVar Bool], [MVar Bool])) -&gt; IO [MVar Bool]
forall a b. HotVar a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#modifyHotVar"><span class="hs-identifier hs-var">modifyHotVar</span></a></span><span> </span><span class="annot"><span class="annottext">HotVar [MVar Bool]
</span><a href="#local-6989586621679060135"><span class="hs-identifier hs-var">idle</span></a></span><span> </span><span class="annot"><span class="annottext">(([MVar Bool] -&gt; ([MVar Bool], [MVar Bool])) -&gt; IO [MVar Bool])
-&gt; ([MVar Bool] -&gt; ([MVar Bool], [MVar Bool])) -&gt; IO [MVar Bool]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679060123"><span class="annot"><span class="annottext">[MVar Bool]
</span><a href="#local-6989586621679060123"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MVar Bool
</span><a href="#local-6989586621679060125"><span class="hs-identifier hs-var">m</span></a></span><span class="annot"><span class="annottext">MVar Bool -&gt; [MVar Bool] -&gt; [MVar Bool]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[MVar Bool]
</span><a href="#local-6989586621679060123"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[MVar Bool]
</span><a href="#local-6989586621679060123"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-679"></span><span>               </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[MVar Bool] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[MVar Bool]
</span><a href="#local-6989586621679060124"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier hs-var">numCapabilities</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-680"></span><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-681"></span><span>                     </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d]  | waking up all threads\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060132"><span class="hs-identifier hs-var">my_no</span></a></span><span>
</span><span id="line-682"></span><span>                     </span><span class="annot"><span class="annottext">HotVar [MVar Bool] -&gt; [MVar Bool] -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#writeHotVarRaw"><span class="hs-identifier hs-var">writeHotVarRaw</span></a></span><span> </span><span class="annot"><span class="annottext">HotVar [MVar Bool]
</span><a href="#local-6989586621679060135"><span class="hs-identifier hs-var">idle</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-683"></span><span>                     </span><span class="annot"><span class="annottext">(MVar Bool -&gt; IO ()) -&gt; [MVar Bool] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679060121"><span class="annot"><span class="annottext">MVar Bool
</span><a href="#local-6989586621679060121"><span class="hs-identifier hs-var">vr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MVar Bool -&gt; Bool -&gt; IO ()
forall a. MVar a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">putMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar Bool
</span><a href="#local-6989586621679060121"><span class="hs-identifier hs-var">vr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[MVar Bool]
</span><a href="#local-6989586621679060124"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-684"></span><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-685"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Session"><span class="hs-identifier hs-type">Session</span></a></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679060120"><span class="annot"><span class="annottext">HotVar Bool
</span><a href="#local-6989586621679060120"><span class="hs-identifier hs-var">finRef</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[Session]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HotVar [Session] -&gt; IO [Session]
forall a. HotVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(HotVar [Session] -&gt; IO [Session])
-&gt; HotVar [Session] -&gt; IO [Session]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Sched -&gt; HotVar [Session]
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#sessions"><span class="hs-identifier hs-var hs-var">sessions</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060136"><span class="hs-identifier hs-var">mysched</span></a></span><span>
</span><span id="line-686"></span><span>                    </span><span id="local-6989586621679060119"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679060119"><span class="hs-identifier hs-var">fin</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HotVar Bool -&gt; IO Bool
forall a. HotVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">HotVar Bool
</span><a href="#local-6989586621679060120"><span class="hs-identifier hs-var">finRef</span></a></span><span>
</span><span id="line-687"></span><span>                    </span><span id="local-6989586621679060118"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679060118"><span class="hs-identifier hs-var">done</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679060119"><span class="hs-identifier hs-var">fin</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">MVar Bool -&gt; IO Bool
forall a. MVar a -&gt; IO a
</span><span class="hs-identifier hs-var">takeMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar Bool
</span><a href="#local-6989586621679060125"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-688"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679060118"><span class="hs-identifier hs-var">done</span></a></span><span>
</span><span id="line-689"></span><span>                       </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-690"></span><span>                         </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d]  | shutting down\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060132"><span class="hs-identifier hs-var">my_no</span></a></span><span>
</span><span id="line-691"></span><span>                         </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-692"></span><span>                       </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-693"></span><span>                         </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d]  | woken up\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060132"><span class="hs-identifier hs-var">my_no</span></a></span><span>
</span><span id="line-694"></span><span>                         </span><span id="local-6989586621679060117"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060117"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO Int
</span><a href="#local-6989586621679060129"><span class="hs-identifier hs-var">getnext</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-glyph">::</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-695"></span><span>                         </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; IO ()
</span><a href="#local-6989586621679060128"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060127"><span class="hs-identifier hs-var">maxtries</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060117"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-696"></span><span>
</span><span id="line-697"></span><span>    </span><span class="hs-comment">-- We need to return from this loop to check sessionFinished and exit the scheduler if necessary.</span><span>
</span><span id="line-698"></span><span>    </span><span class="annot"><a href="#local-6989586621679060128"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621679060116"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060116"><span class="hs-identifier hs-var">_i</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#_IDLING_ON"><span class="hs-identifier hs-var">_IDLING_ON</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><span class="hs-identifier hs-var">yield</span></span><span>
</span><span id="line-699"></span><span>
</span><span id="line-700"></span><span>    </span><span class="hs-comment">----------------------------------------</span><span>
</span><span id="line-701"></span><span>    </span><span class="annot"><a href="#local-6989586621679060128"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621679060115"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060115"><span class="hs-identifier hs-var">tries</span></a></span></span><span> </span><span id="local-6989586621679060114"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060114"><span class="hs-identifier hs-var">i</span></a></span></span><span>
</span><span id="line-702"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060114"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060132"><span class="hs-identifier hs-var">my_no</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679060113"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060113"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO Int
</span><a href="#local-6989586621679060129"><span class="hs-identifier hs-var">getnext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060114"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-703"></span><span>                        </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; IO ()
</span><a href="#local-6989586621679060128"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060115"><span class="hs-identifier hs-var">tries</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060113"><span class="hs-identifier hs-var">i'</span></a></span><span>
</span><span id="line-704"></span><span>
</span><span id="line-705"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-706"></span><span>         </span><span class="hs-comment">-- We ONLY go through the global sched array to access victims:</span><span>
</span><span id="line-707"></span><span>         </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679060112"><span class="annot"><span class="annottext">schd :: Sched
</span><a href="#local-6989586621679060112"><span class="hs-identifier hs-var hs-var">schd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Sched]
</span><a href="#local-6989586621679060134"><span class="hs-identifier hs-var">scheds</span></a></span><span class="annot"><span class="annottext">[Sched] -&gt; Int -&gt; Sched
forall a. [a] -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">!!</span></span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060114"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-708"></span><span>         </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbglvl"><span class="hs-identifier hs-var">dbglvl</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; Int -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d]  | trying steal from %d\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060132"><span class="hs-identifier hs-var">my_no</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var hs-var">no</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060112"><span class="hs-identifier hs-var">schd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-709"></span><span>
</span><span id="line-710"></span><span class="hs-comment">--         let dq = workpool schd :: WSDeque (Par ())</span><span>
</span><span id="line-711"></span><span>         </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679060110"><span class="annot"><span class="annottext">dq :: WSDeque (Par ())
</span><a href="#local-6989586621679060110"><span class="hs-identifier hs-var hs-var">dq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Sched -&gt; WSDeque (Par ())
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#workpool"><span class="hs-identifier hs-var hs-var">workpool</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060112"><span class="hs-identifier hs-var">schd</span></a></span><span>
</span><span id="line-712"></span><span>         </span><span id="local-6989586621679060109"><span class="annot"><span class="annottext">Maybe (Par ())
</span><a href="#local-6989586621679060109"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleDeque (Par ()) -&gt; IO (Maybe (Par ()))
forall a. SimpleDeque a -&gt; IO (Maybe a)
</span><span class="hs-identifier hs-var">R.tryPopR</span></span><span> </span><span class="annot"><span class="annottext">SimpleDeque (Par ())
WSDeque (Par ())
</span><a href="#local-6989586621679060110"><span class="hs-identifier hs-var">dq</span></a></span><span>
</span><span id="line-713"></span><span>
</span><span id="line-714"></span><span>         </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Par ())
</span><a href="#local-6989586621679060109"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-715"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679060107"><span class="annot"><span class="annottext">Par ()
</span><a href="#local-6989586621679060107"><span class="hs-identifier hs-var">task</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-716"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679060106"><span class="annot"><span class="annottext">StableName (Par ())
</span><a href="#local-6989586621679060106"><span class="hs-identifier hs-var">sn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Par () -&gt; IO (StableName (Par ()))
forall a. a -&gt; IO (StableName a)
</span><span class="hs-identifier hs-var">makeStableName</span></span><span> </span><span class="annot"><span class="annottext">Par ()
</span><a href="#local-6989586621679060107"><span class="hs-identifier hs-var">task</span></a></span><span>
</span><span id="line-717"></span><span>                           </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; Int -&gt; Int -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d]  | stole work (unit %d) from cpu %d\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060132"><span class="hs-identifier hs-var">my_no</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StableName (Par ()) -&gt; Int
forall a. StableName a -&gt; Int
</span><span class="hs-identifier hs-var">hashStableName</span></span><span> </span><span class="annot"><span class="annottext">StableName (Par ())
</span><a href="#local-6989586621679060106"><span class="hs-identifier hs-var">sn</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var hs-var">no</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060112"><span class="hs-identifier hs-var">schd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-718"></span><span>              </span><span class="annot"><span class="annottext">Sched -&gt; ROnly () -&gt; IO ()
forall r (m :: * -&gt; *) a. r -&gt; ReaderT r m a -&gt; m a
</span><a href="Control.Monad.Par.Scheds.Direct.html#runReaderWith"><span class="hs-identifier hs-var">runReaderWith</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060136"><span class="hs-identifier hs-var">mysched</span></a></span><span> </span><span class="annot"><span class="annottext">(ROnly () -&gt; IO ()) -&gt; ROnly () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-719"></span><span>                </span><span class="annot"><span class="annottext">ContT () ROnly () -&gt; (() -&gt; ROnly ()) -&gt; ROnly ()
forall k (r :: k) (m :: k -&gt; *) a. ContT r m a -&gt; (a -&gt; m r) -&gt; m r
</span><span class="hs-identifier hs-var hs-var">C.runContT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Par () -&gt; ContT () ROnly ()
forall a. Par a -&gt; ContT () ROnly a
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#unPar"><span class="hs-identifier hs-var hs-var">unPar</span></a></span><span> </span><span class="annot"><span class="annottext">Par ()
</span><a href="#local-6989586621679060107"><span class="hs-identifier hs-var">task</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-720"></span><span>                 </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-721"></span><span>                   </span><span class="annot"><span class="annottext">Bool -&gt; ROnly () -&gt; ROnly ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Monad.Par.Scheds.Direct.html#dbg"><span class="hs-identifier hs-var">dbg</span></a></span><span class="annot"><span class="annottext">(ROnly () -&gt; ROnly ()) -&gt; ROnly () -&gt; ROnly ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679060105"><span class="annot"><span class="annottext">StableName (Par ())
</span><a href="#local-6989586621679060105"><span class="hs-identifier hs-var">sn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (StableName (Par ())) -&gt; ReaderT Sched IO (StableName (Par ()))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span class="annot"><span class="annottext">(IO (StableName (Par ()))
 -&gt; ReaderT Sched IO (StableName (Par ())))
-&gt; IO (StableName (Par ()))
-&gt; ReaderT Sched IO (StableName (Par ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Par () -&gt; IO (StableName (Par ()))
forall a. a -&gt; IO (StableName a)
</span><span class="hs-identifier hs-var">makeStableName</span></span><span> </span><span class="annot"><span class="annottext">Par ()
</span><a href="#local-6989586621679060107"><span class="hs-identifier hs-var">task</span></a></span><span>
</span><span id="line-722"></span><span>                                </span><span class="annot"><span class="annottext">IO () -&gt; ROnly ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span class="annot"><span class="annottext">(IO () -&gt; ROnly ()) -&gt; IO () -&gt; ROnly ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; Int -&gt; Int -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; [%d]  | DONE running stolen work (unit %d) from %d\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060132"><span class="hs-identifier hs-var">my_no</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StableName (Par ()) -&gt; Int
forall a. StableName a -&gt; Int
</span><span class="hs-identifier hs-var">hashStableName</span></span><span> </span><span class="annot"><span class="annottext">StableName (Par ())
</span><a href="#local-6989586621679060105"><span class="hs-identifier hs-var">sn</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; Int
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#no"><span class="hs-identifier hs-var hs-var">no</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060112"><span class="hs-identifier hs-var">schd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-723"></span><span>                   </span><span class="annot"><span class="annottext">() -&gt; ROnly ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-724"></span><span>
</span><span id="line-725"></span><span>           </span><span class="annot"><span class="annottext">Maybe (Par ())
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679060104"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060104"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO Int
</span><a href="#local-6989586621679060129"><span class="hs-identifier hs-var">getnext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060114"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-726"></span><span>                         </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; IO ()
</span><a href="#local-6989586621679060128"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060115"><span class="hs-identifier hs-var">tries</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060104"><span class="hs-identifier hs-var">i'</span></a></span><span>
</span><span id="line-727"></span><span>
</span><span id="line-728"></span><span class="hs-comment">-- | The continuation which should not be called.</span><span>
</span><span id="line-729"></span><span id="local-6989586621679060103"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#_errK"><span class="hs-identifier hs-type">_errK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679060103"><span class="hs-identifier hs-type">t</span></a></span></span><span>
</span><span id="line-730"></span><span id="_errK"><span class="annot"><span class="annottext">_errK :: t
</span><a href="Control.Monad.Par.Scheds.Direct.html#_errK"><span class="hs-identifier hs-var hs-var">_errK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; t
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Error cont: this closure shouldn't be used&quot;</span></span><span>
</span><span id="line-731"></span><span>
</span><span id="line-732"></span><span id="local-6989586621679060545"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#trivialCont"><span class="hs-identifier hs-type">trivialCont</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679060545"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#ROnly"><span class="hs-identifier hs-type">ROnly</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span class="hs-cpp">
#ifdef DEBUG_DIRECT
</span><span class="hs-identifier">trivialCont</span><span> </span><span class="hs-identifier">str</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-735"></span><span class="hs-comment">--                trace (str ++&quot; trivialCont evaluated!&quot;)</span><span>
</span><span id="line-736"></span><span>                </span><span class="hs-identifier">liftIO</span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">printf</span><span> </span><span class="hs-string">&quot; !! trivialCont evaluated, msg: %s\n&quot;</span><span> </span><span class="hs-identifier">str</span><span class="hs-cpp">
#else
</span><span id="trivialCont"><span class="annot"><span class="annottext">trivialCont :: String -&gt; a -&gt; ROnly ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#trivialCont"><span class="hs-identifier hs-var hs-var">trivialCont</span></a></span></span><span> </span><span id="local-6989586621679060101"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679060101"><span class="hs-identifier hs-var">_str</span></a></span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span class="hs-cpp">
#endif
</span><span>                </span><span class="annot"><span class="annottext">() -&gt; ROnly ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-741"></span><span>
</span><span id="line-742"></span><span class="hs-comment">----------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-743"></span><span>
</span><span id="line-744"></span><span>
</span><span id="line-745"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-746"></span><span class="hs-comment">-- &lt;boilerplate&gt;</span><span>
</span><span id="line-747"></span><span>
</span><span id="line-748"></span><span class="hs-comment">-- TEMP: TODO: Factor out this boilerplate somehow.</span><span>
</span><span id="line-749"></span><span>
</span><span id="line-750"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#spawn1_"><span class="hs-pragma hs-type">spawn1_</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-751"></span><span class="hs-comment">-- Spawn a one argument function instead of a thunk.  This is good for debugging if the value supports &quot;Show&quot;.</span><span>
</span><span id="line-752"></span><span id="spawn1_"><span class="annot"><span class="annottext">spawn1_ :: (a -&gt; Par b) -&gt; a -&gt; Par (IVar b)
</span><a href="Control.Monad.Par.Scheds.Direct.html#spawn1_"><span class="hs-identifier hs-var hs-var">spawn1_</span></a></span></span><span> </span><span id="local-6989586621679060100"><span class="annot"><span class="annottext">a -&gt; Par b
</span><a href="#local-6989586621679060100"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679060099"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060099"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span class="hs-cpp">
#ifdef DEBUG_DIRECT
</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier">sn</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">io</span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">makeStableName</span><span> </span><span class="hs-identifier">f</span><span>
</span><span id="line-755"></span><span>    </span><span class="hs-identifier">sch</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">RD.ask</span><span class="hs-special">;</span><span> </span><span class="hs-identifier">when</span><span> </span><span class="hs-identifier">dbg</span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">io</span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">printf</span><span> </span><span class="hs-string">&quot; [%d] spawning fn %d with arg %s\n&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">no</span><span> </span><span class="hs-identifier">sch</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hashStableName</span><span> </span><span class="hs-identifier">sn</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">x</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>    </span><span class="annot"><span class="annottext">Par b -&gt; Par (IVar b)
forall a. Par a -&gt; Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#spawn_"><span class="hs-identifier hs-var">spawn_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Par b
</span><a href="#local-6989586621679060100"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060099"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-758"></span><span>
</span><span id="line-759"></span><span class="hs-comment">-- The following is usually inefficient!</span><span>
</span><span id="line-760"></span><span id="newFull_"><span class="annot"><span class="annottext">newFull_ :: a -&gt; Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#newFull_"><span class="hs-identifier hs-var hs-var">newFull_</span></a></span></span><span> </span><span id="local-6989586621679060098"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060098"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679060097"><span class="annot"><span class="annottext">IVar a
</span><a href="#local-6989586621679060097"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Par (IVar a)
forall a. Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#new"><span class="hs-identifier hs-var">new</span></a></span><span>
</span><span id="line-761"></span><span>                </span><span class="annot"><span class="annottext">IVar a -&gt; a -&gt; Par ()
forall a. IVar a -&gt; a -&gt; Par ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#put_"><span class="hs-identifier hs-var">put_</span></a></span><span> </span><span class="annot"><span class="annottext">IVar a
</span><a href="#local-6989586621679060097"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060098"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-762"></span><span>                </span><span class="annot"><span class="annottext">IVar a -&gt; Par (IVar a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">IVar a
</span><a href="#local-6989586621679060097"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-763"></span><span>
</span><span id="line-764"></span><span id="newFull"><span class="annot"><span class="annottext">newFull :: a -&gt; Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#newFull"><span class="hs-identifier hs-var hs-var">newFull</span></a></span></span><span> </span><span id="local-6989586621679060096"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060096"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Par (IVar a) -&gt; Par (IVar a)
forall a b. NFData a =&gt; a -&gt; b -&gt; b
</span><span class="hs-identifier hs-var">deepseq</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060096"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Par (IVar a)
forall a. a -&gt; Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#newFull_"><span class="hs-identifier hs-var">newFull_</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060096"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-765"></span><span>
</span><span id="line-766"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#put"><span class="hs-pragma hs-type">put</span></a></span><span>  </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-767"></span><span id="put"><span class="annot"><span class="annottext">put :: IVar a -&gt; a -&gt; Par ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#put"><span class="hs-identifier hs-var hs-var">put</span></a></span></span><span> </span><span id="local-6989586621679060094"><span class="annot"><span class="annottext">IVar a
</span><a href="#local-6989586621679060094"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679060093"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060093"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Par () -&gt; Par ()
forall a b. NFData a =&gt; a -&gt; b -&gt; b
</span><span class="hs-identifier hs-var">deepseq</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060093"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IVar a -&gt; a -&gt; Par ()
forall a. IVar a -&gt; a -&gt; Par ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#put_"><span class="hs-identifier hs-var">put_</span></a></span><span> </span><span class="annot"><span class="annottext">IVar a
</span><a href="#local-6989586621679060094"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060093"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-768"></span><span>
</span><span id="line-769"></span><span id="spawn"><span class="annot"><span class="annottext">spawn :: Par a -&gt; Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#spawn"><span class="hs-identifier hs-var hs-var">spawn</span></a></span></span><span> </span><span id="local-6989586621679060092"><span class="annot"><span class="annottext">Par a
</span><a href="#local-6989586621679060092"><span class="hs-identifier hs-var">p</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679060091"><span class="annot"><span class="annottext">IVar a
</span><a href="#local-6989586621679060091"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Par (IVar a)
forall a. Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#new"><span class="hs-identifier hs-var">new</span></a></span><span class="hs-special">;</span><span>  </span><span class="annot"><span class="annottext">Par () -&gt; Par ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#fork"><span class="hs-identifier hs-var">fork</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Par a
</span><a href="#local-6989586621679060092"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Par a -&gt; (a -&gt; Par ()) -&gt; Par ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">IVar a -&gt; a -&gt; Par ()
forall a. NFData a =&gt; IVar a -&gt; a -&gt; Par ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#put"><span class="hs-identifier hs-var">put</span></a></span><span> </span><span class="annot"><span class="annottext">IVar a
</span><a href="#local-6989586621679060091"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="hs-special">;</span><span>   </span><span class="annot"><span class="annottext">IVar a -&gt; Par (IVar a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">IVar a
</span><a href="#local-6989586621679060091"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-770"></span><span id="spawn_"><span class="annot"><span class="annottext">spawn_ :: Par a -&gt; Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#spawn_"><span class="hs-identifier hs-var hs-var">spawn_</span></a></span></span><span> </span><span id="local-6989586621679060090"><span class="annot"><span class="annottext">Par a
</span><a href="#local-6989586621679060090"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679060089"><span class="annot"><span class="annottext">IVar a
</span><a href="#local-6989586621679060089"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Par (IVar a)
forall a. Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#new"><span class="hs-identifier hs-var">new</span></a></span><span class="hs-special">;</span><span>  </span><span class="annot"><span class="annottext">Par () -&gt; Par ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#fork"><span class="hs-identifier hs-var">fork</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Par a
</span><a href="#local-6989586621679060090"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Par a -&gt; (a -&gt; Par ()) -&gt; Par ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">IVar a -&gt; a -&gt; Par ()
forall a. IVar a -&gt; a -&gt; Par ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#put_"><span class="hs-identifier hs-var">put_</span></a></span><span> </span><span class="annot"><span class="annottext">IVar a
</span><a href="#local-6989586621679060089"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="hs-special">;</span><span>  </span><span class="annot"><span class="annottext">IVar a -&gt; Par (IVar a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">IVar a
</span><a href="#local-6989586621679060089"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-771"></span><span id="spawnP"><span class="annot"><span class="annottext">spawnP :: a -&gt; Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#spawnP"><span class="hs-identifier hs-var hs-var">spawnP</span></a></span></span><span> </span><span id="local-6989586621679060088"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060088"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Par a -&gt; Par (IVar a)
forall a. NFData a =&gt; Par a -&gt; Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#spawn"><span class="hs-identifier hs-var">spawn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Par a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679060088"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-772"></span><span>
</span><span id="line-773"></span><span class="hs-comment">-- In Debug mode we require that IVar contents be Show-able:</span><span class="hs-cpp">
#ifdef DEBUG_DIRECT
</span><span class="hs-identifier">put</span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">NFData</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">IVar</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-776"></span><span class="hs-identifier">spawn</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">NFData</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">IVar</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">)</span><span>
</span><span id="line-777"></span><span class="hs-identifier">spawn_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">IVar</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">)</span><span>
</span><span id="line-778"></span><span class="hs-identifier">spawn1_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">b</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-identifier">b</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">IVar</span><span> </span><span class="hs-identifier">b</span><span class="hs-special">)</span><span>
</span><span id="line-779"></span><span class="hs-identifier">spawnP</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">NFData</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">IVar</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">)</span><span>
</span><span id="line-780"></span><span class="hs-identifier">put_</span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">IVar</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-781"></span><span class="hs-identifier">get</span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">IVar</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-identifier">a</span><span>
</span><span id="line-782"></span><span class="hs-identifier">runPar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">a</span><span>
</span><span id="line-783"></span><span class="hs-identifier">runParIO</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">a</span><span>
</span><span id="line-784"></span><span class="hs-identifier">newFull</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">NFData</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">IVar</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">)</span><span>
</span><span id="line-785"></span><span class="hs-identifier">newFull_</span><span> </span><span class="hs-glyph">::</span><span>  </span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">IVar</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">)</span><span>
</span><span id="line-786"></span><span class="hs-identifier">unsafeTryPut</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">b</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">IVar</span><span> </span><span class="hs-identifier">b</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">b</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-identifier">b</span><span class="hs-cpp">
#else
</span><span id="local-6989586621679060452"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#spawn"><span class="hs-identifier hs-type">spawn</span></a></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NFData</span></span><span> </span><span class="annot"><a href="#local-6989586621679060452"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060452"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060452"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-789"></span><span id="local-6989586621679060483"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#spawn_"><span class="hs-identifier hs-type">spawn_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060483"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060483"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-790"></span><span id="local-6989586621679060086"><span id="local-6989586621679060087"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#spawn1_"><span class="hs-identifier hs-type">spawn1_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679060087"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060086"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679060087"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060086"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-791"></span><span id="local-6989586621679060085"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#spawnP"><span class="hs-identifier hs-type">spawnP</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NFData</span></span><span> </span><span class="annot"><a href="#local-6989586621679060085"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679060085"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060085"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-792"></span><span id="local-6989586621679060462"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#put_"><span class="hs-identifier hs-type">put_</span></a></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060462"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679060462"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-793"></span><span id="local-6989586621679060455"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#put"><span class="hs-identifier hs-type">put</span></a></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NFData</span></span><span> </span><span class="annot"><a href="#local-6989586621679060455"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060455"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679060455"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-794"></span><span id="local-6989586621679060084"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#get"><span class="hs-identifier hs-type">get</span></a></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060084"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060084"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-795"></span><span id="local-6989586621679060083"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#runPar"><span class="hs-identifier hs-type">runPar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060083"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679060083"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-796"></span><span id="local-6989586621679060562"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#runParIO"><span class="hs-identifier hs-type">runParIO</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060562"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679060562"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-797"></span><span id="local-6989586621679060082"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#newFull"><span class="hs-identifier hs-type">newFull</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NFData</span></span><span> </span><span class="annot"><a href="#local-6989586621679060082"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679060082"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060082"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-798"></span><span id="local-6989586621679060458"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#newFull_"><span class="hs-identifier hs-type">newFull_</span></a></span><span> </span><span class="hs-glyph">::</span><span>  </span><span class="annot"><a href="#local-6989586621679060458"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060458"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-799"></span><span id="local-6989586621679060081"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#unsafeTryPut"><span class="hs-identifier hs-type">unsafeTryPut</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060081"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679060081"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060081"><span class="hs-identifier hs-type">b</span></a></span></span><span>
</span><span id="line-800"></span><span>
</span><span id="line-801"></span><span class="hs-comment">-- We can't make proper instances with the extra Show constraints:</span><span>
</span><span id="line-802"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PC.ParFuture</span></span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-803"></span><span>  </span><span id="local-6989586621679060074"><span class="annot"><span class="annottext">get :: IVar a -&gt; Par a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">get</span></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IVar a -&gt; Par a
forall a. IVar a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#get"><span class="hs-identifier hs-var">get</span></a></span><span>
</span><span id="line-804"></span><span>  </span><span id="local-6989586621679060072"><span class="annot"><span class="annottext">spawn :: Par a -&gt; Par (IVar a)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">spawn</span></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Par a -&gt; Par (IVar a)
forall a. NFData a =&gt; Par a -&gt; Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#spawn"><span class="hs-identifier hs-var">spawn</span></a></span><span>
</span><span id="line-805"></span><span>  </span><span id="local-6989586621679060070"><span class="annot"><span class="annottext">spawn_ :: Par a -&gt; Par (IVar a)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">spawn_</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Par a -&gt; Par (IVar a)
forall a. Par a -&gt; Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#spawn_"><span class="hs-identifier hs-var">spawn_</span></a></span><span>
</span><span id="line-806"></span><span>  </span><span id="local-6989586621679060068"><span class="annot"><span class="annottext">spawnP :: a -&gt; Par (IVar a)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">spawnP</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Par (IVar a)
forall a. NFData a =&gt; a -&gt; Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#spawnP"><span class="hs-identifier hs-var">spawnP</span></a></span><span>
</span><span id="line-807"></span><span>
</span><span id="line-808"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679060062"><span class="annot"><span class="hs-identifier hs-type">PC.ParIVar</span></span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-809"></span><span>  </span><span id="local-6989586621679060057"><span class="annot"><span class="annottext">fork :: Par () -&gt; Par ()
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">fork</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Par () -&gt; Par ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#fork"><span class="hs-identifier hs-var">fork</span></a></span><span>
</span><span id="line-810"></span><span>  </span><span id="local-6989586621679060055"><span class="annot"><span class="annottext">new :: Par (IVar a)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">new</span></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Par (IVar a)
forall a. Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#new"><span class="hs-identifier hs-var">new</span></a></span><span>
</span><span id="line-811"></span><span>  </span><span id="local-6989586621679060053"><span class="annot"><span class="annottext">put_ :: IVar a -&gt; a -&gt; Par ()
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">put_</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IVar a -&gt; a -&gt; Par ()
forall a. IVar a -&gt; a -&gt; Par ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#put_"><span class="hs-identifier hs-var">put_</span></a></span><span>
</span><span id="line-812"></span><span>  </span><span id="local-6989586621679060051"><span class="annot"><span class="annottext">newFull :: a -&gt; Par (IVar a)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">newFull</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Par (IVar a)
forall a. NFData a =&gt; a -&gt; Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#newFull"><span class="hs-identifier hs-var">newFull</span></a></span><span>
</span><span id="line-813"></span><span>  </span><span id="local-6989586621679060049"><span class="annot"><span class="annottext">newFull_ :: a -&gt; Par (IVar a)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">newFull_</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Par (IVar a)
forall a. a -&gt; Par (IVar a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#newFull_"><span class="hs-identifier hs-var">newFull_</span></a></span><span>
</span><span id="line-814"></span><span>
</span><span id="line-815"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UN.ParUnsafe</span></span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#IVar"><span class="hs-identifier hs-type">IVar</span></a></span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Par"><span class="hs-identifier hs-type">Par</span></a></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-816"></span><span>  </span><span id="local-6989586621679060043"><span class="annot"><span class="annottext">unsafePeek :: IVar a -&gt; Par (Maybe a)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">unsafePeek</span></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IVar a -&gt; Par (Maybe a)
forall a. IVar a -&gt; Par (Maybe a)
</span><a href="Control.Monad.Par.Scheds.Direct.html#unsafePeek"><span class="hs-identifier hs-var">unsafePeek</span></a></span><span>
</span><span id="line-817"></span><span>  </span><span id="local-6989586621679060041"><span class="annot"><span class="annottext">unsafeTryPut :: IVar a -&gt; a -&gt; Par a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">unsafeTryPut</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IVar a -&gt; a -&gt; Par a
forall a. IVar a -&gt; a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#unsafeTryPut"><span class="hs-identifier hs-var">unsafeTryPut</span></a></span><span>
</span><span id="line-818"></span><span>  </span><span id="local-6989586621679060039"><span class="annot"><span class="annottext">unsafeParIO :: IO a -&gt; Par a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">unsafeParIO</span></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; Par a
forall a. IO a -&gt; Par a
</span><a href="Control.Monad.Par.Scheds.Direct.html#unsafeParIO"><span class="hs-identifier hs-var">unsafeParIO</span></a></span><span class="hs-cpp">
#endif
</span><span class="hs-cpp">


#ifdef NEW_GENERIC
</span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">PU.ParMonad</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-825"></span><span>  </span><span class="hs-identifier">fork</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fork</span><span>
</span><span id="line-826"></span><span>  </span><span class="hs-identifier">internalLiftIO</span><span> </span><span class="hs-identifier">io</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">lift</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">lift</span><span> </span><span class="hs-identifier">io</span><span class="hs-special">)</span><span>
</span><span id="line-827"></span><span>
</span><span id="line-828"></span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">PU.ParThreadSafe</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-829"></span><span>  </span><span class="hs-identifier">unsafeParIO</span><span> </span><span class="hs-identifier">io</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">lift</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">lift</span><span> </span><span class="hs-identifier">io</span><span class="hs-special">)</span><span>
</span><span id="line-830"></span><span>
</span><span id="line-831"></span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">PN.ParFuture</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-832"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">Future</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">IVar</span><span>
</span><span id="line-833"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">FutContents</span><span> </span><span class="hs-identifier">Par</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-834"></span><span>  </span><span class="hs-identifier">get</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">get</span><span>
</span><span id="line-835"></span><span>  </span><span class="hs-identifier">spawn</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">spawn</span><span>
</span><span id="line-836"></span><span>  </span><span class="hs-identifier">spawn_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">spawn_</span><span>
</span><span id="line-837"></span><span>  </span><span class="hs-identifier">spawnP</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">spawnP</span><span>
</span><span id="line-838"></span><span>
</span><span id="line-839"></span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">PN.ParIVar</span><span> </span><span class="hs-identifier">Par</span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-840"></span><span>  </span><span class="hs-identifier">new</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">new</span><span>
</span><span id="line-841"></span><span>  </span><span class="hs-identifier">put_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">put_</span><span>
</span><span id="line-842"></span><span>  </span><span class="hs-identifier">newFull</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">newFull</span><span>
</span><span id="line-843"></span><span>  </span><span class="hs-identifier">newFull_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">newFull_</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-846"></span><span class="hs-comment">-- &lt;/boilerplate&gt;</span><span>
</span><span id="line-847"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-848"></span><span>
</span><span id="line-849"></span><span>
</span><span id="line-850"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#runReaderWith"><span class="hs-pragma hs-type">runReaderWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-851"></span><span class="hs-comment">-- | Arguments flipped for convenience.</span><span>
</span><span id="line-852"></span><span id="local-6989586621679060538"><span id="local-6989586621679060539"><span id="local-6989586621679060540"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#runReaderWith"><span class="hs-identifier hs-type">runReaderWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679060540"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RD.ReaderT</span></span><span> </span><span class="annot"><a href="#local-6989586621679060540"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060539"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060538"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679060539"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679060538"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-853"></span><span id="runReaderWith"><span class="annot"><span class="annottext">runReaderWith :: r -&gt; ReaderT r m a -&gt; m a
</span><a href="Control.Monad.Par.Scheds.Direct.html#runReaderWith"><span class="hs-identifier hs-var hs-var">runReaderWith</span></a></span></span><span> </span><span id="local-6989586621679060037"><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621679060037"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span id="local-6989586621679060036"><span class="annot"><span class="annottext">ReaderT r m a
</span><a href="#local-6989586621679060036"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ReaderT r m a -&gt; r -&gt; m a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">RD.runReaderT</span></span><span> </span><span class="annot"><span class="annottext">ReaderT r m a
</span><a href="#local-6989586621679060036"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621679060037"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-854"></span><span>
</span><span id="line-855"></span><span>
</span><span id="line-856"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-857"></span><span class="hs-comment">-- DEBUGGING TOOLs</span><span>
</span><span id="line-858"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-859"></span><span>
</span><span id="line-860"></span><span class="hs-comment">-- Make sure there is no work left in any deque after exiting.</span><span>
</span><span id="line-861"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#_sanityCheck"><span class="hs-identifier hs-type">_sanityCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Sched"><span class="hs-identifier hs-type">Sched</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-862"></span><span id="_sanityCheck"><span class="annot"><span class="annottext">_sanityCheck :: [Sched] -&gt; IO ()
</span><a href="Control.Monad.Par.Scheds.Direct.html#_sanityCheck"><span class="hs-identifier hs-var hs-var">_sanityCheck</span></a></span></span><span> </span><span id="local-6989586621679060033"><span class="annot"><span class="annottext">[Sched]
</span><a href="#local-6989586621679060033"><span class="hs-identifier hs-var">allscheds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-863"></span><span>  </span><span class="annot"><span class="annottext">[Sched] -&gt; (Sched -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[Sched]
</span><a href="#local-6989586621679060033"><span class="hs-identifier hs-var">allscheds</span></a></span><span> </span><span class="annot"><span class="annottext">((Sched -&gt; IO ()) -&gt; IO ()) -&gt; (Sched -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Sched"><span class="hs-identifier hs-type">Sched</span></a></span><span class="hs-special">{</span><span id="local-6989586621679060032"><span class="annot"><span class="annottext">Int
no :: Int
no :: Sched -&gt; Int
</span><a href="#local-6989586621679060032"><span class="hs-identifier hs-var hs-var">no</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679060031"><span class="annot"><span class="annottext">WSDeque (Par ())
workpool :: WSDeque (Par ())
workpool :: Sched -&gt; WSDeque (Par ())
</span><a href="#local-6989586621679060031"><span class="hs-identifier hs-var hs-var">workpool</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-864"></span><span>     </span><span id="local-6989586621679060030"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679060030"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleDeque (Par ()) -&gt; IO Bool
forall elt. SimpleDeque elt -&gt; IO Bool
</span><span class="hs-identifier hs-var">R.nullQ</span></span><span> </span><span class="annot"><span class="annottext">SimpleDeque (Par ())
WSDeque (Par ())
</span><a href="#local-6989586621679060031"><span class="hs-identifier hs-var">workpool</span></a></span><span>
</span><span id="line-865"></span><span>     </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679060030"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-866"></span><span>         </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;WARNING: After main thread exited non-empty queue remains for worker %d\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060032"><span class="hs-identifier hs-var">no</span></a></span><span>
</span><span id="line-867"></span><span>         </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-868"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Sanity check complete.\n&quot;</span></span><span>
</span><span id="line-869"></span><span>
</span><span id="line-870"></span><span>
</span><span id="line-871"></span><span class="hs-comment">-- | This tries to localize the blocked-indefinitely exception:</span><span>
</span><span id="line-872"></span><span id="local-6989586621679060029"><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#_dbgTakeMVar"><span class="hs-identifier hs-type">_dbgTakeMVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679060029"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679060029"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-873"></span><span id="_dbgTakeMVar"><span class="annot"><span class="annottext">_dbgTakeMVar :: String -&gt; MVar a -&gt; IO a
</span><a href="Control.Monad.Par.Scheds.Direct.html#_dbgTakeMVar"><span class="hs-identifier hs-var hs-var">_dbgTakeMVar</span></a></span></span><span> </span><span id="local-6989586621679060027"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679060027"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span id="local-6989586621679060026"><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621679060026"><span class="hs-identifier hs-var">mv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-874"></span><span class="hs-comment">--  catch (takeMVar mv) ((\_ -&gt; doDebugStuff) :: BlockedIndefinitelyOnMVar -&gt; IO a)</span><span>
</span><span id="line-875"></span><span>  </span><span class="annot"><span class="annottext">IO a -&gt; (IOError -&gt; IO a) -&gt; IO a
forall e a. Exception e =&gt; IO a -&gt; (e -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">E.catch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MVar a -&gt; IO a
forall a. MVar a -&gt; IO a
</span><span class="hs-identifier hs-var">takeMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621679060026"><span class="hs-identifier hs-var">mv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">IOError
</span><span class="hs-identifier">_</span></span><span class="hs-glyph">::</span><span class="annot"><span class="hs-identifier hs-type">IOError</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679060024"><span class="hs-identifier hs-var">doDebugStuff</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-876"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-877"></span><span>   </span><span id="local-6989586621679060024"><span class="annot"><span class="annottext">doDebugStuff :: IO a
</span><a href="#local-6989586621679060024"><span class="hs-identifier hs-var hs-var">doDebugStuff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;This takeMVar blocked indefinitely!: %s\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679060027"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-878"></span><span>                     </span><span class="annot"><span class="annottext">String -&gt; IO a
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;failed&quot;</span></span><span>
</span><span id="line-879"></span><span>
</span><span id="line-880"></span><span class="hs-comment">-- | For debugging purposes.  This can help us figure out (by an ugly</span><span>
</span><span id="line-881"></span><span class="hs-comment">--   process of elimination) which MVar reads are leading to a &quot;Thread</span><span>
</span><span id="line-882"></span><span class="hs-comment">--   blocked indefinitely&quot; exception.</span><span>
</span><span id="line-883"></span><span class="hs-comment">{-
busyTakeMVar :: String -&gt; MVar a -&gt; IO a
busyTakeMVar msg mv = try (10 * 1000 * 1000)
 where
 try 0 = do
   when dbg $ do
     tid &lt;- myThreadId
     -- After we've failed enough times, start complaining:
     printf &quot;%s not getting anywhere, msg: %s\n&quot; (show tid) msg
   try (100 * 1000)
 try n = do
   x &lt;- tryTakeMVar mv
   case x of
     Just y  -&gt; return y
     Nothing -&gt; do yield; try (n-1)
-}</span><span>
</span><span id="line-899"></span><span>
</span><span id="line-900"></span><span class="hs-comment">-- | Fork a thread but ALSO set up an error handler that suppresses</span><span>
</span><span id="line-901"></span><span class="hs-comment">--   MVar exceptions.</span><span>
</span><span id="line-902"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#_forkIO_Suppress"><span class="hs-identifier hs-type">_forkIO_Suppress</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span>
</span><span id="line-903"></span><span id="_forkIO_Suppress"><span class="annot"><span class="annottext">_forkIO_Suppress :: Int -&gt; IO () -&gt; IO ThreadId
</span><a href="Control.Monad.Par.Scheds.Direct.html#_forkIO_Suppress"><span class="hs-identifier hs-var hs-var">_forkIO_Suppress</span></a></span></span><span> </span><span id="local-6989586621679060022"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060022"><span class="hs-identifier hs-var">whre</span></a></span></span><span> </span><span id="local-6989586621679060021"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679060021"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-904"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; IO () -&gt; IO ThreadId
</span><span class="hs-identifier hs-var">forkOn</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679060022"><span class="hs-identifier hs-var">whre</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ThreadId) -&gt; IO () -&gt; IO ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-905"></span><span>           </span><span class="annot"><span class="annottext">(BlockedIndefinitelyOnMVar -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall e a. Exception e =&gt; (e -&gt; IO a) -&gt; IO a -&gt; IO a
</span><span class="hs-identifier hs-var">E.handle</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679060019"><span class="annot"><span class="annottext">BlockedIndefinitelyOnMVar
</span><a href="#local-6989586621679060019"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-906"></span><span>                      </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockedIndefinitelyOnMVar
</span><a href="#local-6989586621679060019"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">E.BlockedIndefinitelyOnMVar</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-907"></span><span>                       </span><span class="annot"><span class="annottext">BlockedIndefinitelyOnMVar
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-908"></span><span>                               </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;CAUGHT child thread exception: &quot;</span></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="annot"><span class="annottext">BlockedIndefinitelyOnMVar -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">BlockedIndefinitelyOnMVar
</span><a href="#local-6989586621679060019"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-909"></span><span>                               </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-910"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-911"></span><span>           </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679060021"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-912"></span><span>
</span><span id="line-913"></span><span>
</span><span id="line-914"></span><span class="hs-comment">-- | Exceptions that walk up the fork tree of threads:</span><span>
</span><span id="line-915"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#forkWithExceptions"><span class="hs-identifier hs-type">forkWithExceptions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span>
</span><span id="line-916"></span><span id="forkWithExceptions"><span class="annot"><span class="annottext">forkWithExceptions :: (IO () -&gt; IO ThreadId) -&gt; String -&gt; IO () -&gt; IO ThreadId
</span><a href="Control.Monad.Par.Scheds.Direct.html#forkWithExceptions"><span class="hs-identifier hs-var hs-var">forkWithExceptions</span></a></span></span><span> </span><span id="local-6989586621679060017"><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><a href="#local-6989586621679060017"><span class="hs-identifier hs-var">forkit</span></a></span></span><span> </span><span id="local-6989586621679060016"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679060016"><span class="hs-identifier hs-var">descr</span></a></span></span><span> </span><span id="local-6989586621679060015"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679060015"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-917"></span><span>   </span><span id="local-6989586621679060014"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060014"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-918"></span><span>   </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><a href="#local-6989586621679060017"><span class="hs-identifier hs-var">forkit</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ThreadId) -&gt; IO () -&gt; IO ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-919"></span><span>      </span><span id="local-6989586621679060013"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060013"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-920"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; (SomeException -&gt; IO ()) -&gt; IO ()
forall e a. Exception e =&gt; IO a -&gt; (e -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">E.catch</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679060015"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-921"></span><span>         </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621679060012"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679060012"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-922"></span><span>           </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe AsyncException
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">E.fromException</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679060012"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-923"></span><span>             </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">AsyncException
</span><span class="hs-identifier hs-var">E.ThreadKilled</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span>
</span><span id="line-924"></span><span>                                    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\nThreadKilled exception inside child thread, %s (not propagating!): %s\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060013"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679060016"><span class="hs-identifier hs-var">descr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-925"></span><span>             </span><span class="annot"><span class="annottext">Maybe AsyncException
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String -&gt; String -&gt; IO ()
forall r. PrintfType r =&gt; String -&gt; r
</span><span class="hs-identifier hs-var">printf</span></span><span>
</span><span id="line-926"></span><span>                        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\nException inside child thread %s, %s: %s\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679060016"><span class="hs-identifier hs-var">descr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060013"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679060012"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-927"></span><span>                      </span><span class="annot"><span class="annottext">ThreadId -&gt; SomeException -&gt; IO ()
forall e. Exception e =&gt; ThreadId -&gt; e -&gt; IO ()
</span><span class="hs-identifier hs-var">E.throwTo</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679060014"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679060012"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">E.SomeException</span></span><span class="hs-special">)</span><span>
</span><span id="line-928"></span><span>         </span><span class="hs-special">)</span><span>
</span><span id="line-929"></span><span>
</span><span id="line-930"></span><span>
</span><span id="line-931"></span><span class="hs-comment">-- Do all the memory reads to snapshot the current session stack:</span><span>
</span><span id="line-932"></span><span class="annot"><a href="Control.Monad.Par.Scheds.Direct.html#readSessions"><span class="hs-identifier hs-type">readSessions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Sched"><span class="hs-identifier hs-type">Sched</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#SessionID"><span class="hs-identifier hs-type">SessionID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-933"></span><span id="readSessions"><span class="annot"><span class="annottext">readSessions :: Sched -&gt; IO [(SessionID, Bool)]
</span><a href="Control.Monad.Par.Scheds.Direct.html#readSessions"><span class="hs-identifier hs-var hs-var">readSessions</span></a></span></span><span> </span><span id="local-6989586621679060008"><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060008"><span class="hs-identifier hs-var">sched</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-934"></span><span>  </span><span id="local-6989586621679060007"><span class="annot"><span class="annottext">[Session]
</span><a href="#local-6989586621679060007"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HotVar [Session] -&gt; IO [Session]
forall a. HotVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sched -&gt; HotVar [Session]
</span><a href="Control.Monad.Par.Scheds.DirectInternal.html#sessions"><span class="hs-identifier hs-var hs-var">sessions</span></a></span><span> </span><span class="annot"><span class="annottext">Sched
</span><a href="#local-6989586621679060008"><span class="hs-identifier hs-var">sched</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-935"></span><span>  </span><span id="local-6989586621679060006"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621679060006"><span class="hs-identifier hs-var">bools</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Session -&gt; IO Bool) -&gt; [Session] -&gt; IO [Bool]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Session"><span class="hs-identifier hs-type">Session</span></a></span><span> </span><span class="annot"><span class="annottext">SessionID
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679060005"><span class="annot"><span class="annottext">HotVar Bool
</span><a href="#local-6989586621679060005"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HotVar Bool -&gt; IO Bool
forall a. HotVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">HotVar Bool
</span><a href="#local-6989586621679060005"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Session]
</span><a href="#local-6989586621679060007"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-936"></span><span>  </span><span class="annot"><span class="annottext">[(SessionID, Bool)] -&gt; IO [(SessionID, Bool)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SessionID] -&gt; [Bool] -&gt; [(SessionID, Bool)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Session -&gt; SessionID) -&gt; [Session] -&gt; [SessionID]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Par.Scheds.DirectInternal.html#Session"><span class="hs-identifier hs-type">Session</span></a></span><span> </span><span id="local-6989586621679060004"><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060004"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span class="annot"><span class="annottext">HotVar Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SessionID
</span><a href="#local-6989586621679060004"><span class="hs-identifier hs-var">sid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Session]
</span><a href="#local-6989586621679060007"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621679060006"><span class="hs-identifier hs-var">bools</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-937"></span></pre></body></html>