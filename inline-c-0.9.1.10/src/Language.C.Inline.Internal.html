<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE ConstraintKinds #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE DeriveDataTypeable #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE MonoLocalBinds #-}</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html"><span class="hs-identifier">Language.C.Inline.Internal</span></a></span><span>
</span><span id="line-17"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Context handling</span></span><span>
</span><span id="line-18"></span><span>      </span><span class="annot"><a href="Language.C.Inline.Internal.html#setContext"><span class="hs-identifier">setContext</span></a></span><span>
</span><span id="line-19"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#getContext"><span class="hs-identifier">getContext</span></a></span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span>      </span><span class="annot"><span class="hs-comment">-- * Substitution</span></span><span>
</span><span id="line-22"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#Substitutions"><span class="hs-identifier">Substitutions</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#substitute"><span class="hs-identifier">substitute</span></a></span><span>
</span><span id="line-24"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#getHaskellType"><span class="hs-identifier">getHaskellType</span></a></span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span>      </span><span class="annot"><span class="hs-comment">-- * Emitting and invoking C code</span></span><span>
</span><span id="line-27"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-28"></span><span>      </span><span class="hs-comment">-- | The functions in this section let us access more the C file</span><span>
</span><span id="line-29"></span><span>      </span><span class="hs-comment">-- associated with the current module.  They can be used to build</span><span>
</span><span id="line-30"></span><span>      </span><span class="hs-comment">-- additional features on top of the basic machinery.  All of</span><span>
</span><span id="line-31"></span><span>      </span><span class="hs-comment">-- @inline-c@ is based upon the functions defined here.</span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span>      </span><span class="annot"><span class="hs-comment">-- ** Emitting C code</span></span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#emitVerbatim"><span class="hs-identifier">emitVerbatim</span></a></span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#emitBlock"><span class="hs-identifier">emitBlock</span></a></span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span>      </span><span class="annot"><span class="hs-comment">-- ** Inlining C code</span></span><span>
</span><span id="line-38"></span><span>      </span><span class="annot"><span class="hs-comment">-- $embedding</span></span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#Code"><span class="hs-identifier">Code</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#inlineCode"><span class="hs-identifier">inlineCode</span></a></span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#inlineExp"><span class="hs-identifier">inlineExp</span></a></span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#inlineItems"><span class="hs-identifier">inlineItems</span></a></span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span>      </span><span class="annot"><span class="hs-comment">-- * Parsing</span></span><span>
</span><span id="line-45"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-46"></span><span>      </span><span class="hs-comment">-- | These functions are used to parse the anti-quotations.  They're</span><span>
</span><span id="line-47"></span><span>      </span><span class="hs-comment">-- exposed for testing purposes, you really should not use them.</span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#SomeEq"><span class="hs-identifier">SomeEq</span></a></span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#toSomeEq"><span class="hs-identifier">toSomeEq</span></a></span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#fromSomeEq"><span class="hs-identifier">fromSomeEq</span></a></span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#ParameterType"><span class="hs-identifier">ParameterType</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#ParseTypedC"><span class="hs-identifier">ParseTypedC</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#parseTypedC"><span class="hs-identifier">parseTypedC</span></a></span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#runParserInQ"><span class="hs-identifier">runParserInQ</span></a></span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#splitTypedC"><span class="hs-identifier">splitTypedC</span></a></span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span>      </span><span class="annot"><span class="hs-comment">-- * Line directives</span></span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#lineDirective"><span class="hs-identifier">lineDirective</span></a></span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#here"><span class="hs-identifier">here</span></a></span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#shiftLines"><span class="hs-identifier">shiftLines</span></a></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span>      </span><span class="annot"><span class="hs-comment">-- * Utility functions for writing quasiquoters</span></span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#genericQuote"><span class="hs-identifier">genericQuote</span></a></span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#funPtrQuote"><span class="hs-identifier">funPtrQuote</span></a></span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Applicative</span></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">forM</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">void</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">msum</span></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">evalStateT</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">StateT</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">get</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">put</span></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">lift</span></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">forM_</span></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromMaybe</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isJust</span></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Traversable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">for</span></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Typeable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Typeable</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">cast</span></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TH</span></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Quote</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TH</span></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Syntax</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TH</span></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.Environment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">lookupEnv</span></span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.IO.Unsafe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unsafePerformIO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unsafeDupablePerformIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Text.Parsec</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Parsec</span></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Text.Parsec.Pos</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Parsec</span></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Text.Parser.Char</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Parser</span></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Text.Parser.Combinators</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Parser</span></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Text.Parser.LookAhead</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Parser</span></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Text.Parser.Token</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Parser</span></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Prettyprinter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(&lt;+&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Prettyprinter</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PP</span></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Prettyprinter.Render.String</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PP</span></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Char</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hashable</span></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Foreign.Ptr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">FunPtr</span></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-comment">-- We cannot use getQ/putQ before 7.10.3 because of &lt;https://ghc.haskell.org/trac/ghc/ticket/10596&gt;</span><span class="hs-cpp">
#define USE_GETQ (__GLASGOW_HASKELL__ &gt; 710 || (__GLASGOW_HASKELL__ == 710 &amp;&amp; __GLASGOW_HASKELL_PATCHLEVEL1__ &gt;= 3))
</span><span class="hs-cpp">
#if !USE_GETQ
</span><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Concurrent.MVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">MVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">newMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">modifyMVar_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">readMVar</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Language.C.Inline.Context.html"><span class="hs-identifier">Language.C.Inline.Context</span></a></span><span>
</span><span id="line-104"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Language.C.Inline.FunPtr.html"><span class="hs-identifier">Language.C.Inline.FunPtr</span></a></span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Language.C.Inline.HaskellIdentifier.html"><span class="hs-identifier">Language.C.Inline.HaskellIdentifier</span></a></span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Language.C.Types.html"><span class="hs-identifier">Language.C.Types</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="hs-keyword">data</span><span> </span><span id="ModuleState"><span class="annot"><a href="Language.C.Inline.Internal.html#ModuleState"><span class="hs-identifier hs-var">ModuleState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ModuleState"><span class="annot"><a href="Language.C.Inline.Internal.html#ModuleState"><span class="hs-identifier hs-var">ModuleState</span></a></span></span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="msContext"><span class="annot"><span class="annottext">ModuleState -&gt; Context
</span><a href="Language.C.Inline.Internal.html#msContext"><span class="hs-identifier hs-var hs-var">msContext</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.C.Inline.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="msGeneratedNames"><span class="annot"><span class="annottext">ModuleState -&gt; Int
</span><a href="Language.C.Inline.Internal.html#msGeneratedNames"><span class="hs-identifier hs-var hs-var">msGeneratedNames</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="msFileChunks"><span class="annot"><span class="annottext">ModuleState -&gt; [String]
</span><a href="Language.C.Inline.Internal.html#msFileChunks"><span class="hs-identifier hs-var hs-var">msFileChunks</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">]</span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span class="annot"><a href="Language.C.Inline.Internal.html#getModuleState"><span class="hs-identifier hs-type">getModuleState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Q</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#ModuleState"><span class="hs-identifier hs-type">ModuleState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span class="annot"><a href="Language.C.Inline.Internal.html#putModuleState"><span class="hs-identifier hs-type">putModuleState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#ModuleState"><span class="hs-identifier hs-type">ModuleState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Q</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">

#if USE_GETQ
</span><span>
</span><span id="line-119"></span><span id="getModuleState"><span class="annot"><span class="annottext">getModuleState :: Q (Maybe ModuleState)
</span><a href="Language.C.Inline.Internal.html#getModuleState"><span class="hs-identifier hs-var hs-var">getModuleState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Q (Maybe ModuleState)
forall a. Typeable a =&gt; Q (Maybe a)
</span><span class="hs-identifier hs-var">TH.getQ</span></span><span>
</span><span id="line-120"></span><span id="putModuleState"><span class="annot"><span class="annottext">putModuleState :: ModuleState -&gt; Q ()
</span><a href="Language.C.Inline.Internal.html#putModuleState"><span class="hs-identifier hs-var hs-var">putModuleState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModuleState -&gt; Q ()
forall a. Typeable a =&gt; a -&gt; Q ()
</span><span class="hs-identifier hs-var">TH.putQ</span></span><span class="hs-cpp">

#else
</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- | Identifier for the current module.  Currently we use the file name.</span><span>
</span><span id="line-125"></span><span class="hs-comment">-- Since we're pairing Haskell files with C files, it makes more sense</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- to use the file name.  I'm not sure if it's possible to compile two</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- modules with the same name in one run of GHC, but in this way we make</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- sure that we don't run into trouble even it is.</span><span>
</span><span id="line-129"></span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">ModuleId</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">String</span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="hs-identifier">getModuleId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">TH.Q</span><span> </span><span class="hs-identifier">ModuleId</span><span>
</span><span id="line-132"></span><span class="hs-identifier">getModuleId</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">TH.loc_filename</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">TH.location</span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span class="hs-comment">-- | 'MVar' storing the state for all the modules we visited.  Note that</span><span>
</span><span id="line-135"></span><span class="hs-comment">-- currently we do not bother with cleaning up the state after we're</span><span>
</span><span id="line-136"></span><span class="hs-comment">-- done compiling a module.  TODO if there is an easy way, clean up the</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- state.</span><span>
</span><span id="line-138"></span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="hs-pragma">moduleStatesVar</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-139"></span><span class="hs-identifier">moduleStatesVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">MVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Map.Map</span><span> </span><span class="hs-identifier">ModuleId</span><span> </span><span class="hs-identifier">ModuleState</span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span class="hs-identifier">moduleStatesVar</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unsafePerformIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">newMVar</span><span> </span><span class="hs-identifier">Map.empty</span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-identifier">getModuleState</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-identifier">moduleStates</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">TH.runIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">readMVar</span><span> </span><span class="hs-identifier">moduleStatesVar</span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-identifier">moduleId</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getModuleId</span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Map.lookup</span><span> </span><span class="hs-identifier">moduleId</span><span> </span><span class="hs-identifier">moduleStates</span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span class="hs-identifier">putModuleState</span><span> </span><span class="hs-identifier">ms</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-identifier">moduleId</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getModuleId</span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-identifier">TH.runIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">modifyMVar_</span><span> </span><span class="hs-identifier">moduleStatesVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">return</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">Map.insert</span><span> </span><span class="hs-identifier">moduleId</span><span> </span><span class="hs-identifier">ms</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-cpp">

#endif
</span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span class="hs-comment">-- | Make sure that 'moduleStatesVar' and the respective C file are up</span><span>
</span><span id="line-155"></span><span class="hs-comment">--   to date.</span><span>
</span><span id="line-156"></span><span class="annot"><a href="Language.C.Inline.Internal.html#initialiseModuleState"><span class="hs-identifier hs-type">initialiseModuleState</span></a></span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.C.Inline.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span>
</span><span id="line-158"></span><span>  </span><span class="hs-comment">-- ^ The 'Context' to use if we initialise the module.  If 'Nothing',</span><span>
</span><span id="line-159"></span><span>  </span><span class="hs-comment">-- 'baseCtx' will be used.</span><span>
</span><span id="line-160"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Q</span></span><span> </span><span class="annot"><a href="Language.C.Inline.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span>
</span><span id="line-161"></span><span id="initialiseModuleState"><span class="annot"><span class="annottext">initialiseModuleState :: Maybe Context -&gt; Q Context
</span><a href="Language.C.Inline.Internal.html#initialiseModuleState"><span class="hs-identifier hs-var hs-var">initialiseModuleState</span></a></span></span><span> </span><span id="local-6989586621679299016"><span class="annot"><span class="annottext">Maybe Context
</span><a href="#local-6989586621679299016"><span class="hs-identifier hs-var">mbContext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-162"></span><span>  </span><span id="local-6989586621679299017"><span class="annot"><a href="#local-6989586621679299017"><span class="hs-identifier hs-var">mbModuleState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Q (Maybe ModuleState)
</span><a href="Language.C.Inline.Internal.html#getModuleState"><span class="hs-identifier hs-var">getModuleState</span></a></span><span>
</span><span id="line-163"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679299017"><span class="hs-identifier hs-type">mbModuleState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-164"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299018"><span class="annot"><span class="annottext">ModuleState
</span><a href="#local-6989586621679299018"><span class="hs-identifier hs-var">moduleState</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Q Context
forall a. a -&gt; Q a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModuleState -&gt; Context
</span><a href="Language.C.Inline.Internal.html#msContext"><span class="hs-identifier hs-var">msContext</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleState
</span><a href="#local-6989586621679299018"><span class="hs-identifier hs-var">moduleState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>    </span><span class="annot"><span class="annottext">Maybe ModuleState
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-166"></span><span>      </span><span class="hs-comment">-- Add hook to add the file</span><span>
</span><span id="line-167"></span><span>      </span><span class="annot"><span class="annottext">Q () -&gt; Q ()
</span><span class="hs-identifier hs-var">TH.addModFinalizer</span></span><span> </span><span class="annot"><span class="annottext">(Q () -&gt; Q ()) -&gt; Q () -&gt; Q ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-168"></span><span>        </span><span id="local-6989586621679299020"><span class="annot"><a href="#local-6989586621679299020"><span class="hs-identifier hs-var">mbMs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Q (Maybe ModuleState)
</span><a href="Language.C.Inline.Internal.html#getModuleState"><span class="hs-identifier hs-var">getModuleState</span></a></span><span>
</span><span id="line-169"></span><span>        </span><span id="local-6989586621679299021"><span class="annot"><a href="#local-6989586621679299021"><span class="hs-identifier hs-var">ms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679299020"><span class="hs-identifier hs-type">mbMs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-170"></span><span>          </span><span class="annot"><span class="annottext">Maybe ModuleState
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Q ModuleState
forall a. String -&gt; Q a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inline-c: ModuleState not present (initialiseModuleState)&quot;</span></span><span>
</span><span id="line-171"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299022"><span class="annot"><span class="annottext">ModuleState
</span><a href="#local-6989586621679299022"><span class="hs-identifier hs-var">ms</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ModuleState -&gt; Q ModuleState
forall a. a -&gt; Q a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ModuleState
</span><a href="#local-6989586621679299022"><span class="hs-identifier hs-var">ms</span></a></span><span>
</span><span id="line-172"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299023"><span class="annot"><a href="#local-6989586621679299023"><span class="hs-identifier hs-var hs-var">lang</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ForeignSrcLang -&gt; Maybe ForeignSrcLang -&gt; ForeignSrcLang
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">ForeignSrcLang
</span><span class="hs-identifier hs-var">TH.LangC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Maybe ForeignSrcLang
</span><a href="Language.C.Inline.Context.html#ctxForeignSrcLang"><span class="hs-identifier hs-var">ctxForeignSrcLang</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679299026"><span class="hs-identifier hs-var">context</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>            </span><span id="local-6989586621679299027"><span class="annot"><a href="#local-6989586621679299027"><span class="hs-identifier hs-var hs-var">addForeignSource</span></a></span></span><span> </span><span class="hs-glyph">=</span><span class="hs-cpp">
#if MIN_VERSION_base(4,12,0)
</span><span>              </span><span class="annot"><span class="annottext">ForeignSrcLang -&gt; String -&gt; Q ()
</span><span class="hs-identifier hs-var">TH.addForeignSource</span></span><span class="hs-cpp">
#else
</span><span>              </span><span class="hs-identifier">TH.addForeignFile</span><span class="hs-cpp">
#endif
</span><span>            </span><span id="local-6989586621679299029"><span class="annot"><a href="#local-6989586621679299029"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[String] -&gt; String
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[String] -&gt; [String]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModuleState -&gt; [String]
</span><a href="Language.C.Inline.Internal.html#msFileChunks"><span class="hs-identifier hs-var">msFileChunks</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleState
</span><a href="#local-6989586621679299021"><span class="hs-identifier hs-var">ms</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679299023"><span class="hs-identifier hs-type">lang</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Context.html#ctxRawObjectCompile"><span class="hs-identifier hs-var">ctxRawObjectCompile</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299026"><span class="hs-identifier hs-type">context</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-181"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ForeignSrcLang
</span><span class="hs-identifier hs-var">TH.RawObject</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299034"><span class="annot"><span class="annottext">String -&gt; Q String
</span><a href="#local-6989586621679299034"><span class="hs-identifier hs-var">compile</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Q String
</span><a href="#local-6989586621679299034"><span class="hs-identifier hs-var">compile</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299029"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">Q String -&gt; (String -&gt; Q ()) -&gt; Q ()
forall a b. Q a -&gt; (a -&gt; Q b) -&gt; Q b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">ForeignSrcLang -&gt; String -&gt; Q ()
</span><span class="hs-identifier hs-var">TH.addForeignFilePath</span></span><span> </span><span class="annot"><span class="annottext">ForeignSrcLang
</span><a href="#local-6989586621679299023"><span class="hs-identifier hs-var">lang</span></a></span><span>
</span><span id="line-182"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ForeignSrcLang
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (String -&gt; Q String)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ForeignSrcLang -&gt; String -&gt; Q ()
</span><a href="#local-6989586621679299027"><span class="hs-identifier hs-var">addForeignSource</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignSrcLang
</span><a href="#local-6989586621679299023"><span class="hs-identifier hs-var">lang</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299029"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-183"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299036"><span class="annot"><span class="annottext">moduleState :: ModuleState
</span><a href="#local-6989586621679299036"><span class="hs-identifier hs-var hs-var hs-var">moduleState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#ModuleState"><span class="hs-identifier hs-type">ModuleState</span></a></span><span>
</span><span id="line-184"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">msContext :: Context
</span><a href="Language.C.Inline.Internal.html#msContext"><span class="hs-identifier hs-var">msContext</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679299026"><span class="hs-identifier hs-var">context</span></a></span><span>
</span><span id="line-185"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">msGeneratedNames :: Int
</span><a href="Language.C.Inline.Internal.html#msGeneratedNames"><span class="hs-identifier hs-var">msGeneratedNames</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-186"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">msFileChunks :: [String]
</span><a href="Language.C.Inline.Internal.html#msFileChunks"><span class="hs-identifier hs-var">msFileChunks</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[String]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-187"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-188"></span><span>      </span><span class="annot"><span class="annottext">ModuleState -&gt; Q ()
</span><a href="Language.C.Inline.Internal.html#putModuleState"><span class="hs-identifier hs-var">putModuleState</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleState
</span><a href="#local-6989586621679299036"><span class="hs-identifier hs-var">moduleState</span></a></span><span>
</span><span id="line-189"></span><span>      </span><span class="annot"><span class="annottext">Context -&gt; Q Context
forall a. a -&gt; Q a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679299026"><span class="hs-identifier hs-var">context</span></a></span><span>
</span><span id="line-190"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-191"></span><span>    </span><span id="local-6989586621679299026"><span class="annot"><span class="annottext">context :: Context
</span><a href="#local-6989586621679299026"><span class="hs-identifier hs-var hs-var">context</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Maybe Context -&gt; Context
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="Language.C.Inline.Context.html#baseCtx"><span class="hs-identifier hs-var">baseCtx</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Context
</span><a href="#local-6989586621679299016"><span class="hs-identifier hs-var">mbContext</span></a></span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span class="hs-comment">-- | Gets the current 'Context'.  Also makes sure that the current</span><span>
</span><span id="line-194"></span><span class="hs-comment">-- module is initialised.</span><span>
</span><span id="line-195"></span><span class="annot"><a href="Language.C.Inline.Internal.html#getContext"><span class="hs-identifier hs-type">getContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Q</span></span><span> </span><span class="annot"><a href="Language.C.Inline.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span>
</span><span id="line-196"></span><span id="getContext"><span class="annot"><span class="annottext">getContext :: Q Context
</span><a href="Language.C.Inline.Internal.html#getContext"><span class="hs-identifier hs-var hs-var">getContext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Context -&gt; Q Context
</span><a href="Language.C.Inline.Internal.html#initialiseModuleState"><span class="hs-identifier hs-var">initialiseModuleState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Context
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span id="local-6989586621679298437"><span class="annot"><a href="Language.C.Inline.Internal.html#modifyModuleState"><span class="hs-identifier hs-type">modifyModuleState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Inline.Internal.html#ModuleState"><span class="hs-identifier hs-type">ModuleState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Inline.Internal.html#ModuleState"><span class="hs-identifier hs-type">ModuleState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679298437"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Q</span></span><span> </span><span class="annot"><a href="#local-6989586621679298437"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-199"></span><span id="modifyModuleState"><span class="annot"><span class="annottext">modifyModuleState :: forall a. (ModuleState -&gt; (ModuleState, a)) -&gt; Q a
</span><a href="Language.C.Inline.Internal.html#modifyModuleState"><span class="hs-identifier hs-var hs-var">modifyModuleState</span></a></span></span><span> </span><span id="local-6989586621679299042"><span class="annot"><span class="annottext">ModuleState -&gt; (ModuleState, a)
</span><a href="#local-6989586621679299042"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-200"></span><span>  </span><span id="local-6989586621679299043"><span class="annot"><a href="#local-6989586621679299043"><span class="hs-identifier hs-var">mbModuleState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Q (Maybe ModuleState)
</span><a href="Language.C.Inline.Internal.html#getModuleState"><span class="hs-identifier hs-var">getModuleState</span></a></span><span>
</span><span id="line-201"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679299043"><span class="hs-identifier hs-type">mbModuleState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-202"></span><span>    </span><span class="annot"><span class="annottext">Maybe ModuleState
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Q a
forall a. String -&gt; Q a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inline-c: ModuleState not present (modifyModuleState)&quot;</span></span><span>
</span><span id="line-203"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299044"><span class="annot"><span class="annottext">ModuleState
</span><a href="#local-6989586621679299044"><span class="hs-identifier hs-var">ms</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-204"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299045"><span class="annot"><span class="annottext">ModuleState
</span><a href="#local-6989586621679299045"><span class="hs-identifier hs-var hs-var">ms'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299046"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299046"><span class="hs-identifier hs-var hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModuleState -&gt; (ModuleState, a)
</span><a href="#local-6989586621679299042"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleState
</span><a href="#local-6989586621679299044"><span class="hs-identifier hs-var">ms</span></a></span><span>
</span><span id="line-205"></span><span>      </span><span class="annot"><span class="annottext">ModuleState -&gt; Q ()
</span><a href="Language.C.Inline.Internal.html#putModuleState"><span class="hs-identifier hs-var">putModuleState</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleState
</span><a href="#local-6989586621679299045"><span class="hs-identifier hs-var">ms'</span></a></span><span>
</span><span id="line-206"></span><span>      </span><span class="annot"><span class="annottext">a -&gt; Q a
forall a. a -&gt; Q a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299046"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span class="hs-comment">-- $context</span><span>
</span><span id="line-209"></span><span class="hs-comment">--</span><span>
</span><span id="line-210"></span><span class="hs-comment">-- The inline C functions ('cexp', 'c', etc.) need a 'Context' to</span><span>
</span><span id="line-211"></span><span class="hs-comment">-- operate.  Said context can be explicitely set with 'setContext'.</span><span>
</span><span id="line-212"></span><span class="hs-comment">-- Otherwise, at the first usage of one of the TH functions in this</span><span>
</span><span id="line-213"></span><span class="hs-comment">-- module the 'Context' is implicitely set to 'baseCtx'.</span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span class="hs-comment">-- | Sets the 'Context' for the current module.  This function, if</span><span>
</span><span id="line-216"></span><span class="hs-comment">-- called, must be called before any of the other TH functions in this</span><span>
</span><span id="line-217"></span><span class="hs-comment">-- module.  Fails if that's not the case.</span><span>
</span><span id="line-218"></span><span class="annot"><a href="Language.C.Inline.Internal.html#setContext"><span class="hs-identifier hs-type">setContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.C.Inline.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Q</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span id="setContext"><span class="annot"><span class="annottext">setContext :: Context -&gt; Q ()
</span><a href="Language.C.Inline.Internal.html#setContext"><span class="hs-identifier hs-var hs-var">setContext</span></a></span></span><span> </span><span id="local-6989586621679299047"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679299047"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-220"></span><span>  </span><span id="local-6989586621679299048"><span class="annot"><a href="#local-6989586621679299048"><span class="hs-identifier hs-var">mbModuleState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Q (Maybe ModuleState)
</span><a href="Language.C.Inline.Internal.html#getModuleState"><span class="hs-identifier hs-var">getModuleState</span></a></span><span>
</span><span id="line-221"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">forM_</span></span><span> </span><span class="annot"><a href="#local-6989586621679299048"><span class="hs-identifier hs-type">mbModuleState</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679299049"><span class="annot"><span class="annottext">ModuleState
</span><a href="#local-6989586621679299049"><span class="hs-identifier hs-var">_ms</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-222"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Q (ZonkAny 6)
forall a. String -&gt; Q a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inline-c: The module has already been initialised (setContext).&quot;</span></span><span>
</span><span id="line-223"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">void</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#initialiseModuleState"><span class="hs-identifier hs-type">initialiseModuleState</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621679299047"><span class="hs-identifier hs-type">ctx</span></a></span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span class="annot"><a href="Language.C.Inline.Internal.html#bumpGeneratedNames"><span class="hs-identifier hs-type">bumpGeneratedNames</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Q</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-226"></span><span id="bumpGeneratedNames"><span class="annot"><span class="annottext">bumpGeneratedNames :: Q Int
</span><a href="Language.C.Inline.Internal.html#bumpGeneratedNames"><span class="hs-identifier hs-var hs-var">bumpGeneratedNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-227"></span><span>  </span><span class="annot"><span class="annottext">(ModuleState -&gt; (ModuleState, Int)) -&gt; Q Int
forall a. (ModuleState -&gt; (ModuleState, a)) -&gt; Q a
</span><a href="Language.C.Inline.Internal.html#modifyModuleState"><span class="hs-identifier hs-var">modifyModuleState</span></a></span><span> </span><span class="annot"><span class="annottext">((ModuleState -&gt; (ModuleState, Int)) -&gt; Q Int)
-&gt; (ModuleState -&gt; (ModuleState, Int)) -&gt; Q Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679299051"><span class="annot"><span class="annottext">ModuleState
</span><a href="#local-6989586621679299051"><span class="hs-identifier hs-var">ms</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299052"><span class="annot"><span class="annottext">c' :: Int
</span><a href="#local-6989586621679299052"><span class="hs-identifier hs-var hs-var">c'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModuleState -&gt; Int
</span><a href="Language.C.Inline.Internal.html#msGeneratedNames"><span class="hs-identifier hs-var">msGeneratedNames</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleState
</span><a href="#local-6989586621679299051"><span class="hs-identifier hs-var">ms</span></a></span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModuleState
</span><a href="#local-6989586621679299051"><span class="hs-identifier hs-var">ms</span></a></span><span class="hs-special">{</span><span class="annot"><a href="Language.C.Inline.Internal.html#msGeneratedNames"><span class="hs-identifier hs-var">msGeneratedNames</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679299052"><span class="hs-identifier hs-type">c'</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679299052"><span class="hs-identifier hs-var">c'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-230"></span><span>
</span><span id="line-231"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-232"></span><span class="hs-comment">-- Emitting</span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span class="annot"><span class="hs-comment">-- | Simply appends some string to the module's C file.  Use with care.</span></span><span>
</span><span id="line-235"></span><span class="annot"><a href="Language.C.Inline.Internal.html#emitVerbatim"><span class="hs-identifier hs-type">emitVerbatim</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.DecsQ</span></span><span>
</span><span id="line-236"></span><span id="emitVerbatim"><span class="annot"><span class="annottext">emitVerbatim :: String -&gt; DecsQ
</span><a href="Language.C.Inline.Internal.html#emitVerbatim"><span class="hs-identifier hs-var hs-var">emitVerbatim</span></a></span></span><span> </span><span id="local-6989586621679299054"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299054"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-237"></span><span>  </span><span class="hs-comment">-- Make sure that the 'ModuleState' is initialized</span><span>
</span><span id="line-238"></span><span>  </span><span class="annot"><span class="annottext">Q Context -&gt; Q ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Context -&gt; Q Context
</span><a href="Language.C.Inline.Internal.html#initialiseModuleState"><span class="hs-identifier hs-var">initialiseModuleState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Context
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299055"><span class="annot"><span class="annottext">chunk :: String
</span><a href="#local-6989586621679299055"><span class="hs-identifier hs-var hs-var hs-var">chunk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299054"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n&quot;</span></span><span>
</span><span id="line-240"></span><span>  </span><span class="annot"><span class="annottext">(ModuleState -&gt; (ModuleState, ())) -&gt; Q ()
forall a. (ModuleState -&gt; (ModuleState, a)) -&gt; Q a
</span><a href="Language.C.Inline.Internal.html#modifyModuleState"><span class="hs-identifier hs-var">modifyModuleState</span></a></span><span> </span><span class="annot"><span class="annottext">((ModuleState -&gt; (ModuleState, ())) -&gt; Q ())
-&gt; (ModuleState -&gt; (ModuleState, ())) -&gt; Q ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679299056"><span class="annot"><span class="annottext">ModuleState
</span><a href="#local-6989586621679299056"><span class="hs-identifier hs-var">ms</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModuleState
</span><a href="#local-6989586621679299056"><span class="hs-identifier hs-var">ms</span></a></span><span class="hs-special">{</span><span class="annot"><a href="Language.C.Inline.Internal.html#msFileChunks"><span class="hs-identifier hs-var">msFileChunks</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679299055"><span class="hs-identifier hs-type">chunk</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#msFileChunks"><span class="hs-identifier hs-var">msFileChunks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299056"><span class="hs-identifier hs-type">ms</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>  </span><span class="annot"><span class="annottext">[Dec] -&gt; DecsQ
forall a. a -&gt; Q a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span class="annot"><span class="hs-comment">-- | Simply appends some string of block to the module's C file.  Use with care.</span></span><span>
</span><span id="line-245"></span><span class="annot"><a href="Language.C.Inline.Internal.html#emitBlock"><span class="hs-identifier hs-type">emitBlock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.QuasiQuoter</span></span><span>
</span><span id="line-246"></span><span id="emitBlock"><span class="annot"><span class="annottext">emitBlock :: QuasiQuoter
</span><a href="Language.C.Inline.Internal.html#emitBlock"><span class="hs-identifier hs-var hs-var">emitBlock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.QuasiQuoter</span></span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">quoteExp :: String -&gt; Q Exp
</span><span class="hs-identifier hs-var">TH.quoteExp</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Q Exp -&gt; String -&gt; Q Exp
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(Q Exp -&gt; String -&gt; Q Exp) -&gt; Q Exp -&gt; String -&gt; Q Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Q Exp
forall a. String -&gt; Q a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inline-c: quoteExp not implemented (quoteCode)&quot;</span></span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">quotePat :: String -&gt; Q Pat
</span><span class="hs-identifier hs-var">TH.quotePat</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Q Pat -&gt; String -&gt; Q Pat
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(Q Pat -&gt; String -&gt; Q Pat) -&gt; Q Pat -&gt; String -&gt; Q Pat
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Q Pat
forall a. String -&gt; Q a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inline-c: quotePat not implemented (quoteCode)&quot;</span></span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">quoteType :: String -&gt; Q Type
</span><span class="hs-identifier hs-var">TH.quoteType</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Q Type -&gt; String -&gt; Q Type
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(Q Type -&gt; String -&gt; Q Type) -&gt; Q Type -&gt; String -&gt; Q Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Q Type
forall a. String -&gt; Q a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inline-c: quoteType not implemented (quoteCode)&quot;</span></span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">quoteDec :: String -&gt; DecsQ
</span><span class="hs-identifier hs-var">TH.quoteDec</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; DecsQ
</span><a href="Language.C.Inline.Internal.html#emitVerbatim"><span class="hs-identifier hs-var">emitVerbatim</span></a></span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-254"></span><span class="hs-comment">-- Inlining</span><span>
</span><span id="line-255"></span><span>
</span><span id="line-256"></span><span class="hs-comment">-- $embedding</span><span>
</span><span id="line-257"></span><span class="hs-comment">--</span><span>
</span><span id="line-258"></span><span class="hs-comment">-- We use the 'Code' data structure to represent some C code that we</span><span>
</span><span id="line-259"></span><span class="hs-comment">-- want to emit to the module's C file and immediately generate a</span><span>
</span><span id="line-260"></span><span class="hs-comment">-- foreign call to.  For this reason, 'Code' includes both some C</span><span>
</span><span id="line-261"></span><span class="hs-comment">-- definition, and enough information to be able to generate a foreign</span><span>
</span><span id="line-262"></span><span class="hs-comment">-- call -- specifically the name of the function to call and the Haskell</span><span>
</span><span id="line-263"></span><span class="hs-comment">-- type.</span><span>
</span><span id="line-264"></span><span class="hs-comment">--</span><span>
</span><span id="line-265"></span><span class="hs-comment">-- All the quasi-quoters work by constructing a 'Code' and calling</span><span>
</span><span id="line-266"></span><span class="hs-comment">-- 'inlineCode'.</span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span class="hs-comment">-- | Data type representing a list of C definitions with a typed and named entry</span><span>
</span><span id="line-269"></span><span class="hs-comment">-- function.</span><span>
</span><span id="line-270"></span><span class="hs-comment">--</span><span>
</span><span id="line-271"></span><span class="hs-comment">-- We use it as a basis to inline and call C code.</span><span>
</span><span id="line-272"></span><span class="hs-keyword">data</span><span> </span><span id="Code"><span class="annot"><a href="Language.C.Inline.Internal.html#Code"><span class="hs-identifier hs-var">Code</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Code"><span class="annot"><a href="Language.C.Inline.Internal.html#Code"><span class="hs-identifier hs-var">Code</span></a></span></span><span>
</span><span id="line-273"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="codeCallSafety"><span class="annot"><span class="annottext">Code -&gt; Safety
</span><a href="Language.C.Inline.Internal.html#codeCallSafety"><span class="hs-identifier hs-var hs-var">codeCallSafety</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Safety</span></span><span>
</span><span id="line-274"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ Safety of the foreign call.</span></span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="codeLoc"><span class="annot"><span class="annottext">Code -&gt; Maybe Loc
</span><a href="Language.C.Inline.Internal.html#codeLoc"><span class="hs-identifier hs-var hs-var">codeLoc</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Loc</span></span><span>
</span><span id="line-276"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ The haskell source location used for the #line directive</span></span><span>
</span><span id="line-277"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="codeType"><span class="annot"><span class="annottext">Code -&gt; Q Type
</span><a href="Language.C.Inline.Internal.html#codeType"><span class="hs-identifier hs-var hs-var">codeType</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.TypeQ</span></span><span>
</span><span id="line-278"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ Type of the foreign call.</span></span><span>
</span><span id="line-279"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="codeFunName"><span class="annot"><span class="annottext">Code -&gt; String
</span><a href="Language.C.Inline.Internal.html#codeFunName"><span class="hs-identifier hs-var hs-var">codeFunName</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-280"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ Name of the function to call in the code below.</span></span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="codeDefs"><span class="annot"><span class="annottext">Code -&gt; String
</span><a href="Language.C.Inline.Internal.html#codeDefs"><span class="hs-identifier hs-var hs-var">codeDefs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-282"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ The C code.</span></span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="codeFunPtr"><span class="annot"><span class="annottext">Code -&gt; Bool
</span><a href="Language.C.Inline.Internal.html#codeFunPtr"><span class="hs-identifier hs-var hs-var">codeFunPtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-284"></span><span>    </span><span class="hs-comment">-- ^ If 'True', the type will be wrapped in 'FunPtr', and</span><span>
</span><span id="line-285"></span><span>    </span><span class="hs-comment">-- the call will be static (e.g. prefixed by &amp;).</span><span>
</span><span id="line-286"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span class="hs-comment">-- TODO use the #line CPP macro to have the functions in the C file</span><span>
</span><span id="line-289"></span><span class="hs-comment">-- refer to the source location in the Haskell file they come from.</span><span>
</span><span id="line-290"></span><span class="hs-comment">--</span><span>
</span><span id="line-291"></span><span class="hs-comment">-- See &lt;https://gcc.gnu.org/onlinedocs/cpp/Line-Control.html&gt;.</span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span class="hs-comment">-- | Inlines a piece of code inline.  The resulting 'TH.Exp' will have</span><span>
</span><span id="line-294"></span><span class="hs-comment">-- the type specified in the 'codeType'.</span><span>
</span><span id="line-295"></span><span class="hs-comment">--</span><span>
</span><span id="line-296"></span><span class="hs-comment">-- In practice, this function outputs the C code to the module's C file,</span><span>
</span><span id="line-297"></span><span class="hs-comment">-- and then inserts a foreign call of type 'codeType' calling the</span><span>
</span><span id="line-298"></span><span class="hs-comment">-- provided 'codeFunName'.</span><span>
</span><span id="line-299"></span><span class="hs-comment">--</span><span>
</span><span id="line-300"></span><span class="hs-comment">-- Example:</span><span>
</span><span id="line-301"></span><span class="hs-comment">--</span><span>
</span><span id="line-302"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-303"></span><span class="hs-comment">-- c_add :: Int -&gt; Int -&gt; Int</span><span>
</span><span id="line-304"></span><span class="hs-comment">-- c_add = $(do</span><span>
</span><span id="line-305"></span><span class="hs-comment">--   here &lt;- TH.location</span><span>
</span><span id="line-306"></span><span class="hs-comment">--   inlineCode $ Code</span><span>
</span><span id="line-307"></span><span class="hs-comment">--     TH.Unsafe                   -- Call safety</span><span>
</span><span id="line-308"></span><span class="hs-comment">--     (Just here)</span><span>
</span><span id="line-309"></span><span class="hs-comment">--     [t| Int -&gt; Int -&gt; Int |]    -- Call type</span><span>
</span><span id="line-310"></span><span class="hs-comment">--     &quot;francescos_add&quot;            -- Call name</span><span>
</span><span id="line-311"></span><span class="hs-comment">--     -- C Code</span><span>
</span><span id="line-312"></span><span class="hs-comment">--     \&quot;int francescos_add(int x, int y) { int z = x + y; return z; }\&quot;)</span><span>
</span><span id="line-313"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-314"></span><span class="annot"><a href="Language.C.Inline.Internal.html#inlineCode"><span class="hs-identifier hs-type">inlineCode</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#Code"><span class="hs-identifier hs-type">Code</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.ExpQ</span></span><span>
</span><span id="line-315"></span><span id="inlineCode"><span class="annot"><span class="annottext">inlineCode :: Code -&gt; Q Exp
</span><a href="Language.C.Inline.Internal.html#inlineCode"><span class="hs-identifier hs-var hs-var">inlineCode</span></a></span></span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#Code"><span class="hs-identifier hs-type">Code</span></a></span><span class="hs-special">{</span><span id="local-6989586621679299066"><span id="local-6989586621679299067"><span id="local-6989586621679299068"><span id="local-6989586621679299069"><span id="local-6989586621679299070"><span id="local-6989586621679299071"><span class="annot"><span class="annottext">Bool
String
Maybe Loc
Q Type
Safety
codeCallSafety :: Code -&gt; Safety
codeLoc :: Code -&gt; Maybe Loc
codeType :: Code -&gt; Q Type
codeFunName :: Code -&gt; String
codeDefs :: Code -&gt; String
codeFunPtr :: Code -&gt; Bool
codeCallSafety :: Safety
codeLoc :: Maybe Loc
codeType :: Q Type
codeFunName :: String
codeDefs :: String
codeFunPtr :: Bool
</span><a href="Language.C.Inline.Internal.html#codeCallSafety"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-316"></span><span>  </span><span class="hs-comment">-- Write out definitions</span><span>
</span><span id="line-317"></span><span>  </span><span id="local-6989586621679299072"><span class="annot"><a href="#local-6989586621679299072"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Q Context
</span><a href="Language.C.Inline.Internal.html#getContext"><span class="hs-identifier hs-var">getContext</span></a></span><span>
</span><span id="line-318"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299073"><span class="annot"><a href="#local-6989586621679299073"><span class="hs-identifier hs-var hs-var">out</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String -&gt; String) -&gt; Maybe (String -&gt; String) -&gt; String -&gt; String
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (String -&gt; String) -&gt; String -&gt; String)
-&gt; Maybe (String -&gt; String) -&gt; String -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Maybe (String -&gt; String)
</span><a href="Language.C.Inline.Context.html#ctxOutput"><span class="hs-identifier hs-var">ctxOutput</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679299072"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-319"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299076"><span class="annot"><a href="#local-6989586621679299076"><span class="hs-identifier hs-var hs-var">directive</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; (Loc -&gt; String) -&gt; Maybe Loc -&gt; String
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Loc -&gt; String
</span><a href="Language.C.Inline.Internal.html#lineDirective"><span class="hs-identifier hs-var">lineDirective</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Loc
</span><a href="#local-6989586621679299067"><span class="hs-identifier hs-var">codeLoc</span></a></span><span>
</span><span id="line-320"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">void</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#emitVerbatim"><span class="hs-identifier hs-type">emitVerbatim</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621679299073"><span class="hs-identifier hs-type">out</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621679299076"><span class="hs-identifier hs-type">directive</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621679299070"><span class="hs-identifier hs-type">codeDefs</span></a></span><span>
</span><span id="line-321"></span><span>  </span><span class="hs-comment">-- Create and add the FFI declaration.</span><span>
</span><span id="line-322"></span><span>  </span><span id="local-6989586621679299078"><span class="annot"><a href="#local-6989586621679299078"><span class="hs-identifier hs-var">ffiImportName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Language.C.Inline.FunPtr.html#uniqueFfiImportName"><span class="hs-identifier hs-type">uniqueFfiImportName</span></a></span><span>
</span><span id="line-323"></span><span>  </span><span class="hs-comment">-- Note [ghcide-support]</span><span>
</span><span id="line-324"></span><span>  </span><span class="hs-comment">-- haskell-language-server / ghcide cannot handle code that use</span><span>
</span><span id="line-325"></span><span>  </span><span class="hs-comment">-- `addForeignFile`/`addForeignSource` as we do here; it will result</span><span>
</span><span id="line-326"></span><span>  </span><span class="hs-comment">-- in linker errors during TH evaluations, see:</span><span>
</span><span id="line-327"></span><span>  </span><span class="hs-comment">-- &lt;https://github.com/haskell/haskell-language-server/issues/365#issuecomment-976294466&gt;</span><span>
</span><span id="line-328"></span><span>  </span><span class="hs-comment">-- Thus for GHCIDE, simply generate a call to `error` instead of a call to a foreign import.</span><span>
</span><span id="line-329"></span><span>  </span><span id="local-6989586621679299080"><span class="annot"><a href="#local-6989586621679299080"><span class="hs-identifier hs-var">usingGhcide</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.runIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">isJust</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">lookupEnv</span></span><span> </span><span class="annot"><span class="hs-string">&quot;__GHCIDE__&quot;</span></span><span>
</span><span id="line-330"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679299080"><span class="hs-identifier hs-type">usingGhcide</span></a></span><span>
</span><span id="line-331"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-332"></span><span>      </span><span class="hs-special">[e|</span><span class="annot"><span class="hs-identifier hs-type">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;inline-c: A 'usingGhcide' inlineCode stub was evaluated -- this should not happen&quot;</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679299071"><span class="hs-identifier hs-type">codeFunPtr</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[t|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FunPtr</span></span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679299068"><span class="hs-identifier hs-type">codeType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">|]</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="#local-6989586621679299068"><span class="hs-identifier hs-type">codeType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">|]</span><span>
</span><span id="line-333"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Actual foreign function call generation.</span><span>
</span><span id="line-334"></span><span>      </span><span id="local-6989586621679299084"><span class="annot"><a href="#local-6989586621679299084"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679299071"><span class="hs-identifier hs-type">codeFunPtr</span></a></span><span>
</span><span id="line-335"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.forImpD</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.CCall</span></span><span> </span><span class="annot"><a href="#local-6989586621679299066"><span class="hs-identifier hs-type">codeCallSafety</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;&amp;&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621679299069"><span class="hs-identifier hs-type">codeFunName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679299078"><span class="hs-identifier hs-type">ffiImportName</span></a></span><span> </span><span class="hs-special">[t|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FunPtr</span></span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679299068"><span class="hs-identifier hs-type">codeType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">|]</span><span>
</span><span id="line-336"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.forImpD</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.CCall</span></span><span> </span><span class="annot"><a href="#local-6989586621679299066"><span class="hs-identifier hs-type">codeCallSafety</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299069"><span class="hs-identifier hs-type">codeFunName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299078"><span class="hs-identifier hs-type">ffiImportName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299068"><span class="hs-identifier hs-type">codeType</span></a></span><span>
</span><span id="line-337"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">TH.addTopDecls</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679299084"><span class="hs-identifier hs-type">dec</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-338"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">TH.varE</span></span><span> </span><span class="annot"><a href="#local-6989586621679299078"><span class="hs-identifier hs-type">ffiImportName</span></a></span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span class="annot"><a href="Language.C.Inline.Internal.html#uniqueCName"><span class="hs-identifier hs-type">uniqueCName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Q</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-341"></span><span id="uniqueCName"><span class="annot"><span class="annottext">uniqueCName :: Maybe String -&gt; Q String
</span><a href="Language.C.Inline.Internal.html#uniqueCName"><span class="hs-identifier hs-var hs-var">uniqueCName</span></a></span></span><span> </span><span id="local-6989586621679299088"><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679299088"><span class="hs-identifier hs-var">mbPostfix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-342"></span><span>  </span><span class="hs-comment">-- The name looks like this:</span><span>
</span><span id="line-343"></span><span>  </span><span class="hs-comment">-- inline_c_MODULE_INDEX_POSTFIX</span><span>
</span><span id="line-344"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-345"></span><span>  </span><span class="hs-comment">-- Where:</span><span>
</span><span id="line-346"></span><span>  </span><span class="hs-comment">--  * MODULE is the module name but with _s instead of .s;</span><span>
</span><span id="line-347"></span><span>  </span><span class="hs-comment">--  * INDEX is a counter that keeps track of how many names we're generating</span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-comment">--    for each module.</span><span>
</span><span id="line-349"></span><span>  </span><span class="hs-comment">--  * POSTFIX is an optional postfix to ease debuggability</span><span>
</span><span id="line-350"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-351"></span><span>  </span><span class="hs-comment">-- we previously also generated a hash from the contents of the</span><span>
</span><span id="line-352"></span><span>  </span><span class="hs-comment">-- C code because of problems when cabal recompiled but now this</span><span>
</span><span id="line-353"></span><span>  </span><span class="hs-comment">-- is not needed anymore since we use 'addDependentFile' to compile</span><span>
</span><span id="line-354"></span><span>  </span><span class="hs-comment">-- the C code.</span><span>
</span><span id="line-355"></span><span>  </span><span id="local-6989586621679299089"><span class="annot"><a href="#local-6989586621679299089"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Q Int
</span><a href="Language.C.Inline.Internal.html#bumpGeneratedNames"><span class="hs-identifier hs-var">bumpGeneratedNames</span></a></span><span>
</span><span id="line-356"></span><span>  </span><span id="local-6989586621679299090"><span class="annot"><a href="#local-6989586621679299090"><span class="hs-identifier hs-var">module_</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-var">TH.loc_module</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.location</span></span><span>
</span><span id="line-357"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299093"><span class="annot"><a href="#local-6989586621679299093"><span class="hs-identifier hs-var hs-var">replaceDot</span></a></span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'.'</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'_'</span></span><span>
</span><span id="line-358"></span><span>      </span><span class="annot"><a href="#local-6989586621679299093"><span class="hs-identifier hs-var">replaceDot</span></a></span><span> </span><span id="local-6989586621679299094"><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679299094"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679299094"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-359"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299095"><span class="annot"><a href="#local-6989586621679299095"><span class="hs-identifier hs-var hs-var">postfix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679299088"><span class="hs-identifier hs-var">mbPostfix</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-360"></span><span>        </span><span class="annot"><span class="annottext">Maybe String
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-361"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299096"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299096"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299096"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_&quot;</span></span><span>
</span><span id="line-362"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;inline_c_&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><a href="#local-6989586621679299093"><span class="hs-identifier hs-type">replaceDot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299090"><span class="hs-identifier hs-type">module_</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">show</span></span><span> </span><span class="annot"><a href="#local-6989586621679299089"><span class="hs-identifier hs-type">c'</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621679299095"><span class="hs-identifier hs-type">postfix</span></a></span><span>
</span><span id="line-363"></span><span>
</span><span id="line-364"></span><span class="hs-comment">-- | Same as 'inlineCItems', but with a single expression.</span><span>
</span><span id="line-365"></span><span class="hs-comment">--</span><span>
</span><span id="line-366"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-367"></span><span class="hs-comment">-- c_cos :: Double -&gt; Double</span><span>
</span><span id="line-368"></span><span class="hs-comment">-- c_cos = $(do</span><span>
</span><span id="line-369"></span><span class="hs-comment">--   here &lt;- TH.location</span><span>
</span><span id="line-370"></span><span class="hs-comment">--   inlineExp</span><span>
</span><span id="line-371"></span><span class="hs-comment">--     TH.Unsafe</span><span>
</span><span id="line-372"></span><span class="hs-comment">--     here</span><span>
</span><span id="line-373"></span><span class="hs-comment">--     [t| Double -&gt; Double |]</span><span>
</span><span id="line-374"></span><span class="hs-comment">--     (quickCParser_ \&quot;double\&quot; parseType)</span><span>
</span><span id="line-375"></span><span class="hs-comment">--     [(&quot;x&quot;, quickCParser_ \&quot;double\&quot; parseType)]</span><span>
</span><span id="line-376"></span><span class="hs-comment">--     &quot;cos(x)&quot;)</span><span>
</span><span id="line-377"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-378"></span><span class="annot"><a href="Language.C.Inline.Internal.html#inlineExp"><span class="hs-identifier hs-type">inlineExp</span></a></span><span>
</span><span id="line-379"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Safety</span></span><span>
</span><span id="line-380"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Safety of the foreign call</span></span><span>
</span><span id="line-381"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Loc</span></span><span>
</span><span id="line-382"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ The location to report</span></span><span>
</span><span id="line-383"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.TypeQ</span></span><span>
</span><span id="line-384"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Type of the foreign call</span></span><span>
</span><span id="line-385"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.C.Types.html#Type"><span class="hs-identifier hs-type">C.Type</span></a></span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span>
</span><span id="line-386"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Return type of the C expr</span></span><span>
</span><span id="line-387"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Types.html#Type"><span class="hs-identifier hs-type">C.Type</span></a></span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-388"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Parameters of the C expr</span></span><span>
</span><span id="line-389"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-390"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ The C expression</span></span><span>
</span><span id="line-391"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.ExpQ</span></span><span>
</span><span id="line-392"></span><span id="inlineExp"><span class="annot"><span class="annottext">inlineExp :: Safety
-&gt; Loc
-&gt; Q Type
-&gt; Type CIdentifier
-&gt; [(CIdentifier, Type CIdentifier)]
-&gt; String
-&gt; Q Exp
</span><a href="Language.C.Inline.Internal.html#inlineExp"><span class="hs-identifier hs-var hs-var">inlineExp</span></a></span></span><span> </span><span id="local-6989586621679299098"><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621679299098"><span class="hs-identifier hs-var">callSafety</span></a></span></span><span> </span><span id="local-6989586621679299099"><span class="annot"><span class="annottext">Loc
</span><a href="#local-6989586621679299099"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621679299100"><span class="annot"><span class="annottext">Q Type
</span><a href="#local-6989586621679299100"><span class="hs-identifier hs-var">type_</span></a></span></span><span> </span><span id="local-6989586621679299101"><span class="annot"><span class="annottext">Type CIdentifier
</span><a href="#local-6989586621679299101"><span class="hs-identifier hs-var">cRetType</span></a></span></span><span> </span><span id="local-6989586621679299102"><span class="annot"><span class="annottext">[(CIdentifier, Type CIdentifier)]
</span><a href="#local-6989586621679299102"><span class="hs-identifier hs-var">cParams</span></a></span></span><span> </span><span id="local-6989586621679299103"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299103"><span class="hs-identifier hs-var">cExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-393"></span><span>  </span><span class="annot"><span class="annottext">Safety
-&gt; Bool
-&gt; Maybe String
-&gt; Loc
-&gt; Q Type
-&gt; Type CIdentifier
-&gt; [(CIdentifier, Type CIdentifier)]
-&gt; String
-&gt; Q Exp
</span><a href="Language.C.Inline.Internal.html#inlineItems"><span class="hs-identifier hs-var">inlineItems</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621679299098"><span class="hs-identifier hs-var">callSafety</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Maybe String
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Loc
</span><a href="#local-6989586621679299099"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Q Type
</span><a href="#local-6989586621679299100"><span class="hs-identifier hs-var">type_</span></a></span><span> </span><span class="annot"><span class="annottext">Type CIdentifier
</span><a href="#local-6989586621679299101"><span class="hs-identifier hs-var">cRetType</span></a></span><span> </span><span class="annot"><span class="annottext">[(CIdentifier, Type CIdentifier)]
</span><a href="#local-6989586621679299102"><span class="hs-identifier hs-var">cParams</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299104"><span class="hs-identifier hs-var">cItems</span></a></span><span>
</span><span id="line-394"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-395"></span><span>    </span><span id="local-6989586621679299104"><span class="annot"><span class="annottext">cItems :: String
</span><a href="#local-6989586621679299104"><span class="hs-identifier hs-var hs-var">cItems</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type CIdentifier
</span><a href="#local-6989586621679299101"><span class="hs-identifier hs-var">cRetType</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-396"></span><span>      </span><span class="annot"><a href="Language.C.Types.html#TypeSpecifier"><span class="hs-identifier hs-type">C.TypeSpecifier</span></a></span><span> </span><span id="local-6989586621679299106"><span class="annot"><span class="annottext">Specifiers
</span><a href="#local-6989586621679299106"><span class="hs-identifier hs-var">_quals</span></a></span></span><span> </span><span class="annot"><span class="annottext">TypeSpecifier
</span><a href="Language.C.Types.html#Void"><span class="hs-identifier hs-var">C.Void</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299103"><span class="hs-identifier hs-var">cExp</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;;&quot;</span></span><span>
</span><span id="line-397"></span><span>      </span><span class="annot"><span class="annottext">Type CIdentifier
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;return (&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299103"><span class="hs-identifier hs-var">cExp</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;);&quot;</span></span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span class="hs-comment">-- | Same as 'inlineCode', but accepts a string containing a list of C</span><span>
</span><span id="line-400"></span><span class="hs-comment">-- statements instead instead than a full-blown 'Code'.  A function</span><span>
</span><span id="line-401"></span><span class="hs-comment">-- containing the provided statement will be automatically generated.</span><span>
</span><span id="line-402"></span><span class="hs-comment">--</span><span>
</span><span id="line-403"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-404"></span><span class="hs-comment">-- c_cos :: Double -&gt; Double</span><span>
</span><span id="line-405"></span><span class="hs-comment">-- c_cos = $(do</span><span>
</span><span id="line-406"></span><span class="hs-comment">--  here &lt;- TH.location</span><span>
</span><span id="line-407"></span><span class="hs-comment">--  inlineItems</span><span>
</span><span id="line-408"></span><span class="hs-comment">--   TH.Unsafe</span><span>
</span><span id="line-409"></span><span class="hs-comment">--   False</span><span>
</span><span id="line-410"></span><span class="hs-comment">--   Nothing</span><span>
</span><span id="line-411"></span><span class="hs-comment">--   here</span><span>
</span><span id="line-412"></span><span class="hs-comment">--   [t| Double -&gt; Double |]</span><span>
</span><span id="line-413"></span><span class="hs-comment">--   (quickCParser_ \&quot;double\&quot; parseType)</span><span>
</span><span id="line-414"></span><span class="hs-comment">--   [(&quot;x&quot;, quickCParser_ \&quot;double\&quot; parseType)]</span><span>
</span><span id="line-415"></span><span class="hs-comment">--   &quot;return cos(x);&quot;)</span><span>
</span><span id="line-416"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-417"></span><span class="annot"><a href="Language.C.Inline.Internal.html#inlineItems"><span class="hs-identifier hs-type">inlineItems</span></a></span><span>
</span><span id="line-418"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Safety</span></span><span>
</span><span id="line-419"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Safety of the foreign call</span></span><span>
</span><span id="line-420"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-421"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Whether to return as a FunPtr or not</span></span><span>
</span><span id="line-422"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-423"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Optional postfix for the generated name</span></span><span>
</span><span id="line-424"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Loc</span></span><span>
</span><span id="line-425"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ The location to report</span></span><span>
</span><span id="line-426"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.TypeQ</span></span><span>
</span><span id="line-427"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Type of the foreign call</span></span><span>
</span><span id="line-428"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.C.Types.html#Type"><span class="hs-identifier hs-type">C.Type</span></a></span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span>
</span><span id="line-429"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Return type of the C expr</span></span><span>
</span><span id="line-430"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Types.html#Type"><span class="hs-identifier hs-type">C.Type</span></a></span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-431"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Parameters of the C expr</span></span><span>
</span><span id="line-432"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-433"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ The C items</span></span><span>
</span><span id="line-434"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.ExpQ</span></span><span>
</span><span id="line-435"></span><span id="inlineItems"><span class="annot"><span class="annottext">inlineItems :: Safety
-&gt; Bool
-&gt; Maybe String
-&gt; Loc
-&gt; Q Type
-&gt; Type CIdentifier
-&gt; [(CIdentifier, Type CIdentifier)]
-&gt; String
-&gt; Q Exp
</span><a href="Language.C.Inline.Internal.html#inlineItems"><span class="hs-identifier hs-var hs-var">inlineItems</span></a></span></span><span> </span><span id="local-6989586621679299108"><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621679299108"><span class="hs-identifier hs-var">callSafety</span></a></span></span><span> </span><span id="local-6989586621679299109"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299109"><span class="hs-identifier hs-var">funPtr</span></a></span></span><span> </span><span id="local-6989586621679299110"><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679299110"><span class="hs-identifier hs-var">mbPostfix</span></a></span></span><span> </span><span id="local-6989586621679299111"><span class="annot"><span class="annottext">Loc
</span><a href="#local-6989586621679299111"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621679299112"><span class="annot"><span class="annottext">Q Type
</span><a href="#local-6989586621679299112"><span class="hs-identifier hs-var">type_</span></a></span></span><span> </span><span id="local-6989586621679299113"><span class="annot"><span class="annottext">Type CIdentifier
</span><a href="#local-6989586621679299113"><span class="hs-identifier hs-var">cRetType</span></a></span></span><span> </span><span id="local-6989586621679299114"><span class="annot"><span class="annottext">[(CIdentifier, Type CIdentifier)]
</span><a href="#local-6989586621679299114"><span class="hs-identifier hs-var">cParams</span></a></span></span><span> </span><span id="local-6989586621679299115"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299115"><span class="hs-identifier hs-var">cItems</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-436"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299116"><span class="annot"><span class="annottext">mkParam :: (i, Type i) -&gt; ParameterDeclaration i
</span><a href="#local-6989586621679299116"><span class="hs-identifier hs-var hs-var hs-var">mkParam</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299117"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299117"><span class="hs-identifier hs-var">id'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299118"><span class="annot"><span class="annottext">Type i
</span><a href="#local-6989586621679299118"><span class="hs-identifier hs-var">paramTy</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe i -&gt; Type i -&gt; ParameterDeclaration i
forall i. Maybe i -&gt; Type i -&gt; ParameterDeclaration i
</span><a href="Language.C.Types.html#ParameterDeclaration"><span class="hs-identifier hs-var">C.ParameterDeclaration</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">i -&gt; Maybe i
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299117"><span class="hs-identifier hs-var">id'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type i
</span><a href="#local-6989586621679299118"><span class="hs-identifier hs-var">paramTy</span></a></span><span>
</span><span id="line-437"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299120"><span class="annot"><span class="annottext">proto :: Type CIdentifier
</span><a href="#local-6989586621679299120"><span class="hs-identifier hs-var hs-var hs-var">proto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type CIdentifier
-&gt; [ParameterDeclaration CIdentifier] -&gt; Type CIdentifier
forall i. Type i -&gt; [ParameterDeclaration i] -&gt; Type i
</span><a href="Language.C.Types.html#Proto"><span class="hs-identifier hs-var">C.Proto</span></a></span><span> </span><span class="annot"><span class="annottext">Type CIdentifier
</span><a href="#local-6989586621679299113"><span class="hs-identifier hs-var">cRetType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((CIdentifier, Type CIdentifier)
 -&gt; ParameterDeclaration CIdentifier)
-&gt; [(CIdentifier, Type CIdentifier)]
-&gt; [ParameterDeclaration CIdentifier]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(CIdentifier, Type CIdentifier) -&gt; ParameterDeclaration CIdentifier
forall {i}. (i, Type i) -&gt; ParameterDeclaration i
</span><a href="#local-6989586621679299116"><span class="hs-identifier hs-var">mkParam</span></a></span><span> </span><span class="annot"><span class="annottext">[(CIdentifier, Type CIdentifier)]
</span><a href="#local-6989586621679299114"><span class="hs-identifier hs-var">cParams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-438"></span><span>  </span><span id="local-6989586621679299122"><span class="annot"><a href="#local-6989586621679299122"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Q Context
</span><a href="Language.C.Inline.Internal.html#getContext"><span class="hs-identifier hs-var">getContext</span></a></span><span>
</span><span id="line-439"></span><span>  </span><span id="local-6989586621679299123"><span class="annot"><a href="#local-6989586621679299123"><span class="hs-identifier hs-var">funName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#uniqueCName"><span class="hs-identifier hs-type">uniqueCName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299110"><span class="hs-identifier hs-type">mbPostfix</span></a></span><span>
</span><span id="line-440"></span><span>  </span><span id="local-6989586621679299124"><span class="annot"><a href="#local-6989586621679299124"><span class="hs-identifier hs-var">cFunName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#cIdentifierFromString"><span class="hs-identifier hs-type">C.cIdentifierFromString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Inline.Context.html#ctxEnableCpp"><span class="hs-identifier hs-var">ctxEnableCpp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299122"><span class="hs-identifier hs-type">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679299123"><span class="hs-identifier hs-type">funName</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-441"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679299127"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299127"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Q CIdentifier
forall a. String -&gt; Q a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Q CIdentifier) -&gt; String -&gt; Q CIdentifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inlineItems: impossible, generated bad C identifier &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-442"></span><span>                       </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;funName:\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299127"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-443"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679299128"><span class="annot"><span class="annottext">CIdentifier
</span><a href="#local-6989586621679299128"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CIdentifier -&gt; Q CIdentifier
forall a. a -&gt; Q a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">CIdentifier
</span><a href="#local-6989586621679299128"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-444"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299129"><span class="annot"><a href="#local-6989586621679299129"><span class="hs-identifier hs-var hs-var">decl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe CIdentifier
-&gt; Type CIdentifier -&gt; ParameterDeclaration CIdentifier
forall i. Maybe i -&gt; Type i -&gt; ParameterDeclaration i
</span><a href="Language.C.Types.html#ParameterDeclaration"><span class="hs-identifier hs-var">C.ParameterDeclaration</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CIdentifier -&gt; Maybe CIdentifier
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">CIdentifier
</span><a href="#local-6989586621679299124"><span class="hs-identifier hs-var">cFunName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type CIdentifier
</span><a href="#local-6989586621679299120"><span class="hs-identifier hs-var">proto</span></a></span><span>
</span><span id="line-445"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299130"><span class="annot"><a href="#local-6989586621679299130"><span class="hs-identifier hs-var hs-var">defs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc (ZonkAny 4) -&gt; String
forall ann. Doc ann -&gt; String
</span><a href="Language.C.Inline.Internal.html#prettyOneLine"><span class="hs-identifier hs-var">prettyOneLine</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ParameterDeclaration CIdentifier -&gt; Doc (ZonkAny 4)
forall a ann. Pretty a =&gt; a -&gt; Doc ann
forall ann. ParameterDeclaration CIdentifier -&gt; Doc ann
</span><span class="hs-identifier hs-var">PP.pretty</span></span><span> </span><span class="annot"><span class="annottext">ParameterDeclaration CIdentifier
</span><a href="#local-6989586621679299129"><span class="hs-identifier hs-var">decl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; { &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299115"><span class="hs-identifier hs-var">cItems</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; }\n&quot;</span></span><span>
</span><span id="line-446"></span><span>  </span><span class="annot"><a href="Language.C.Inline.Internal.html#inlineCode"><span class="hs-identifier hs-type">inlineCode</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#Code"><span class="hs-identifier hs-type">Code</span></a></span><span>
</span><span id="line-447"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#codeCallSafety"><span class="hs-identifier hs-var">codeCallSafety</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679299108"><span class="hs-identifier hs-type">callSafety</span></a></span><span>
</span><span id="line-448"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#codeLoc"><span class="hs-identifier hs-var">codeLoc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621679299111"><span class="hs-identifier hs-type">loc</span></a></span><span>
</span><span id="line-449"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#codeType"><span class="hs-identifier hs-var">codeType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679299112"><span class="hs-identifier hs-type">type_</span></a></span><span>
</span><span id="line-450"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#codeFunName"><span class="hs-identifier hs-var">codeFunName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679299123"><span class="hs-identifier hs-type">funName</span></a></span><span>
</span><span id="line-451"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#codeDefs"><span class="hs-identifier hs-var">codeDefs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679299130"><span class="hs-identifier hs-type">defs</span></a></span><span>
</span><span id="line-452"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#codeFunPtr"><span class="hs-identifier hs-var">codeFunPtr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679299109"><span class="hs-identifier hs-type">funPtr</span></a></span><span>
</span><span id="line-453"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-454"></span><span>
</span><span id="line-455"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-456"></span><span class="hs-comment">-- Parsing</span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span id="local-6989586621679298477"><span id="local-6989586621679298481"><span class="annot"><a href="Language.C.Inline.Internal.html#runParserInQ"><span class="hs-identifier hs-type">runParserInQ</span></a></span><span>
</span><span id="line-459"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679298477"><span class="hs-identifier hs-type">ident</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-460"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-461"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CParserContext"><span class="hs-identifier hs-type">C.CParserContext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298477"><span class="hs-identifier hs-type">ident</span></a></span><span>
</span><span id="line-462"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679298479"><span class="annot"><a href="#local-6989586621679298479"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CParser"><span class="hs-identifier hs-type">C.CParser</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298477"><span class="hs-identifier hs-type">ident</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298479"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679298479"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298481"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Q</span></span><span> </span><span class="annot"><a href="#local-6989586621679298481"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-463"></span><span id="runParserInQ"><span class="annot"><span class="annottext">runParserInQ :: forall ident a.
Hashable ident =&gt;
String
-&gt; CParserContext ident
-&gt; (forall (m :: * -&gt; *). CParser ident m =&gt; m a)
-&gt; Q a
</span><a href="Language.C.Inline.Internal.html#runParserInQ"><span class="hs-identifier hs-var hs-var">runParserInQ</span></a></span></span><span> </span><span id="local-6989586621679299187"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299187"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679299188"><span class="annot"><span class="annottext">CParserContext ident
</span><a href="#local-6989586621679299188"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679299189"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). CParser ident m =&gt; m a
</span><a href="#local-6989586621679299189"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-464"></span><span>  </span><span id="local-6989586621679299190"><span class="annot"><a href="#local-6989586621679299190"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Q Loc
</span><span class="hs-identifier hs-var">TH.location</span></span><span>
</span><span id="line-465"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299191"><span class="annot"><a href="#local-6989586621679299191"><span class="hs-identifier hs-var">line</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299192"><span class="annot"><a href="#local-6989586621679299192"><span class="hs-identifier hs-var">col</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-var">TH.loc_start</span></span><span> </span><span class="annot"><a href="#local-6989586621679299190"><span class="hs-identifier hs-type">loc</span></a></span><span>
</span><span id="line-466"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299194"><span class="annot"><a href="#local-6989586621679299194"><span class="hs-identifier hs-var hs-var">parsecLoc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; Int -&gt; SourcePos
</span><span class="hs-identifier hs-var">Parsec.newPos</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Loc -&gt; String
</span><span class="hs-identifier hs-var">TH.loc_filename</span></span><span> </span><span class="annot"><span class="annottext">Loc
</span><a href="#local-6989586621679299190"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679299191"><span class="hs-identifier hs-var">line</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679299192"><span class="hs-identifier hs-var">col</span></a></span><span>
</span><span id="line-467"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299197"><span class="annot"><a href="#local-6989586621679299197"><span class="hs-identifier hs-var hs-var">p'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ParsecT String () Identity ()
-&gt; ReaderT (CParserContext ident) (ParsecT String () Identity) ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ReaderT (CParserContext ident) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourcePos -&gt; ParsecT String () Identity ()
forall (m :: * -&gt; *) s u. Monad m =&gt; SourcePos -&gt; ParsecT s u m ()
</span><span class="hs-identifier hs-var">Parsec.setPosition</span></span><span> </span><span class="annot"><span class="annottext">SourcePos
</span><a href="#local-6989586621679299194"><span class="hs-identifier hs-var">parsecLoc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ReaderT (CParserContext ident) (ParsecT String () Identity) ()
-&gt; ReaderT (CParserContext ident) (ParsecT String () Identity) a
-&gt; ReaderT (CParserContext ident) (ParsecT String () Identity) a
forall a b.
ReaderT (CParserContext ident) (ParsecT String () Identity) a
-&gt; ReaderT (CParserContext ident) (ParsecT String () Identity) b
-&gt; ReaderT (CParserContext ident) (ParsecT String () Identity) b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">ReaderT (CParserContext ident) (ParsecT String () Identity) a
forall (m :: * -&gt; *). CParser ident m =&gt; m a
</span><a href="#local-6989586621679299189"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT (CParserContext ident) (ParsecT String () Identity) a
-&gt; ReaderT (CParserContext ident) (ParsecT String () Identity) ()
-&gt; ReaderT (CParserContext ident) (ParsecT String () Identity) a
forall a b.
ReaderT (CParserContext ident) (ParsecT String () Identity) a
-&gt; ReaderT (CParserContext ident) (ParsecT String () Identity) b
-&gt; ReaderT (CParserContext ident) (ParsecT String () Identity) a
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f a
</span><span class="hs-operator hs-var">&lt;*</span></span><span> </span><span class="annot"><span class="annottext">ParsecT String () Identity ()
-&gt; ReaderT (CParserContext ident) (ParsecT String () Identity) ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ReaderT (CParserContext ident) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">ParsecT String () Identity ()
forall (m :: * -&gt; *). Parsing m =&gt; m ()
</span><span class="hs-identifier hs-var">Parser.eof</span></span><span>
</span><span id="line-468"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#runCParser"><span class="hs-identifier hs-type">C.runCParser</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299188"><span class="hs-identifier hs-type">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-var">TH.loc_filename</span></span><span> </span><span class="annot"><a href="#local-6989586621679299190"><span class="hs-identifier hs-type">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679299187"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299197"><span class="hs-identifier hs-type">p'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-469"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679299202"><span class="annot"><span class="annottext">ParseError
</span><a href="#local-6989586621679299202"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-470"></span><span>      </span><span class="hs-comment">-- TODO consider prefixing with &quot;error while parsing C&quot; or similar</span><span>
</span><span id="line-471"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; Q a
forall a. String -&gt; Q a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Q a) -&gt; String -&gt; Q a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ParseError -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ParseError
</span><a href="#local-6989586621679299202"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-472"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679299203"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299203"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-473"></span><span>      </span><span class="annot"><span class="annottext">a -&gt; Q a
forall a. a -&gt; Q a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299203"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span class="hs-keyword">data</span><span> </span><span id="SomeEq"><span class="annot"><a href="Language.C.Inline.Internal.html#SomeEq"><span class="hs-identifier hs-var">SomeEq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679299204"><span class="annot"><a href="#local-6989586621679299204"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span> </span><span class="annot"><a href="#local-6989586621679299204"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679299204"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span id="SomeEq"><span class="annot"><a href="Language.C.Inline.Internal.html#SomeEq"><span class="hs-identifier hs-var">SomeEq</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679299204"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-476"></span><span>
</span><span id="line-477"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679299208"><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#SomeEq"><span class="hs-identifier hs-type">SomeEq</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-478"></span><span>  </span><span class="annot"><a href="Language.C.Inline.Internal.html#SomeEq"><span class="hs-identifier hs-type">SomeEq</span></a></span><span> </span><span id="local-6989586621679299214"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299214"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679299215"><span class="annot"><span class="annottext">== :: SomeEq -&gt; SomeEq -&gt; Bool
</span><span class="hs-operator hs-var hs-var hs-var">==</span></span></span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#SomeEq"><span class="hs-identifier hs-type">SomeEq</span></a></span><span> </span><span id="local-6989586621679299221"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299221"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a b. (Typeable a, Typeable b) =&gt; a -&gt; Maybe b
</span><span class="hs-identifier hs-var">cast</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299214"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-479"></span><span>    </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-480"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299222"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299222"><span class="hs-identifier hs-var">x'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299222"><span class="hs-identifier hs-var">x'</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299221"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-481"></span><span>
</span><span id="line-482"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679299224"><span id="local-6989586621679299229"><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#SomeEq"><span class="hs-identifier hs-type">SomeEq</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-483"></span><span>  </span><span id="local-6989586621679299232"><span class="annot"><span class="annottext">show :: SomeEq -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var">show</span></span></span><span> </span><span class="annot"><span class="annottext">SomeEq
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&lt;&lt;SomeEq&gt;&gt;&quot;</span></span><span>
</span><span id="line-484"></span><span>
</span><span id="line-485"></span><span id="local-6989586621679298568"><span class="annot"><a href="Language.C.Inline.Internal.html#toSomeEq"><span class="hs-identifier hs-type">toSomeEq</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679298568"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span> </span><span class="annot"><a href="#local-6989586621679298568"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679298568"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#SomeEq"><span class="hs-identifier hs-type">SomeEq</span></a></span></span><span>
</span><span id="line-486"></span><span id="toSomeEq"><span class="annot"><span class="annottext">toSomeEq :: forall a. (Eq a, Typeable a) =&gt; a -&gt; SomeEq
</span><a href="Language.C.Inline.Internal.html#toSomeEq"><span class="hs-identifier hs-var hs-var">toSomeEq</span></a></span></span><span> </span><span id="local-6989586621679299237"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299237"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; SomeEq
forall a. (Typeable a, Eq a) =&gt; a -&gt; SomeEq
</span><a href="Language.C.Inline.Internal.html#SomeEq"><span class="hs-identifier hs-var">SomeEq</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299237"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span id="local-6989586621679298571"><span class="annot"><a href="Language.C.Inline.Internal.html#fromSomeEq"><span class="hs-identifier hs-type">fromSomeEq</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679298571"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span> </span><span class="annot"><a href="#local-6989586621679298571"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#SomeEq"><span class="hs-identifier hs-type">SomeEq</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679298571"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-489"></span><span id="fromSomeEq"><span class="annot"><span class="annottext">fromSomeEq :: forall a. (Eq a, Typeable a) =&gt; SomeEq -&gt; Maybe a
</span><a href="Language.C.Inline.Internal.html#fromSomeEq"><span class="hs-identifier hs-var hs-var">fromSomeEq</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Inline.Internal.html#SomeEq"><span class="hs-identifier hs-type">SomeEq</span></a></span><span> </span><span id="local-6989586621679299244"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299244"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a b. (Typeable a, Typeable b) =&gt; a -&gt; Maybe b
</span><span class="hs-identifier hs-var">cast</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299244"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span class="hs-keyword">data</span><span> </span><span id="ParameterType"><span class="annot"><a href="Language.C.Inline.Internal.html#ParameterType"><span class="hs-identifier hs-var">ParameterType</span></a></span></span><span>
</span><span id="line-492"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Plain"><span class="annot"><a href="Language.C.Inline.Internal.html#Plain"><span class="hs-identifier hs-var">Plain</span></a></span></span><span> </span><span class="annot"><a href="Language.C.Inline.HaskellIdentifier.html#HaskellIdentifier"><span class="hs-identifier hs-type">HaskellIdentifier</span></a></span><span>                </span><span class="hs-comment">-- The name of the captured variable</span><span>
</span><span id="line-493"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="AntiQuote"><span class="annot"><a href="Language.C.Inline.Internal.html#AntiQuote"><span class="hs-identifier hs-var">AntiQuote</span></a></span></span><span> </span><span class="annot"><a href="Language.C.Inline.Context.html#AntiQuoterId"><span class="hs-identifier hs-type">AntiQuoterId</span></a></span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#SomeEq"><span class="hs-identifier hs-type">SomeEq</span></a></span><span>
</span><span id="line-494"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299249"><span id="local-6989586621679299258"><span id="local-6989586621679299262"><span class="annot"><span class="annottext">Int -&gt; ParameterType -&gt; String -&gt; String
[ParameterType] -&gt; String -&gt; String
ParameterType -&gt; String
(Int -&gt; ParameterType -&gt; String -&gt; String)
-&gt; (ParameterType -&gt; String)
-&gt; ([ParameterType] -&gt; String -&gt; String)
-&gt; Show ParameterType
forall a.
(Int -&gt; a -&gt; String -&gt; String)
-&gt; (a -&gt; String) -&gt; ([a] -&gt; String -&gt; String) -&gt; Show a
$cshowsPrec :: Int -&gt; ParameterType -&gt; String -&gt; String
showsPrec :: Int -&gt; ParameterType -&gt; String -&gt; String
$cshow :: ParameterType -&gt; String
show :: ParameterType -&gt; String
$cshowList :: [ParameterType] -&gt; String -&gt; String
showList :: [ParameterType] -&gt; String -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299266"><span id="local-6989586621679299276"><span class="annot"><span class="annottext">ParameterType -&gt; ParameterType -&gt; Bool
(ParameterType -&gt; ParameterType -&gt; Bool)
-&gt; (ParameterType -&gt; ParameterType -&gt; Bool) -&gt; Eq ParameterType
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: ParameterType -&gt; ParameterType -&gt; Bool
== :: ParameterType -&gt; ParameterType -&gt; Bool
$c/= :: ParameterType -&gt; ParameterType -&gt; Bool
/= :: ParameterType -&gt; ParameterType -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-495"></span><span>
</span><span id="line-496"></span><span class="hs-keyword">data</span><span> </span><span id="ParseTypedC"><span class="annot"><a href="Language.C.Inline.Internal.html#ParseTypedC"><span class="hs-identifier hs-var">ParseTypedC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ParseTypedC"><span class="annot"><a href="Language.C.Inline.Internal.html#ParseTypedC"><span class="hs-identifier hs-var">ParseTypedC</span></a></span></span><span>
</span><span id="line-497"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="ptcReturnType"><span class="annot"><span class="annottext">ParseTypedC -&gt; Type CIdentifier
</span><a href="Language.C.Inline.Internal.html#ptcReturnType"><span class="hs-identifier hs-var hs-var">ptcReturnType</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.C.Types.html#Type"><span class="hs-identifier hs-type">C.Type</span></a></span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span>
</span><span id="line-498"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ptcParameters"><span class="annot"><span class="annottext">ParseTypedC -&gt; [(CIdentifier, Type CIdentifier, ParameterType)]
</span><a href="Language.C.Inline.Internal.html#ptcParameters"><span class="hs-identifier hs-var hs-var">ptcParameters</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Types.html#Type"><span class="hs-identifier hs-type">C.Type</span></a></span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#ParameterType"><span class="hs-identifier hs-type">ParameterType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-499"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ptcBody"><span class="annot"><span class="annottext">ParseTypedC -&gt; String
</span><a href="Language.C.Inline.Internal.html#ptcBody"><span class="hs-identifier hs-var hs-var">ptcBody</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-500"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-501"></span><span>
</span><span id="line-502"></span><span class="hs-keyword">newtype</span><span> </span><span id="Substitutions"><span class="annot"><a href="Language.C.Inline.Internal.html#Substitutions"><span class="hs-identifier hs-var">Substitutions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Substitutions"><span class="annot"><a href="Language.C.Inline.Internal.html#Substitutions"><span class="hs-identifier hs-var">Substitutions</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="unSubstitutions"><span class="annot"><span class="annottext">Substitutions -&gt; Map String (String -&gt; String)
</span><a href="Language.C.Inline.Internal.html#unSubstitutions"><span class="hs-identifier hs-var hs-var">unSubstitutions</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-503"></span><span>
</span><span id="line-504"></span><span class="annot"><a href="Language.C.Inline.Internal.html#applySubstitutions"><span class="hs-identifier hs-type">applySubstitutions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Q</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-505"></span><span id="applySubstitutions"><span class="annot"><span class="annottext">applySubstitutions :: String -&gt; Q String
</span><a href="Language.C.Inline.Internal.html#applySubstitutions"><span class="hs-identifier hs-var hs-var">applySubstitutions</span></a></span></span><span> </span><span id="local-6989586621679299286"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299286"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-506"></span><span>  </span><span id="local-6989586621679299287"><span class="annot"><a href="#local-6989586621679299287"><span class="hs-identifier hs-var">subs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map String (String -&gt; String)
-&gt; (Substitutions -&gt; Map String (String -&gt; String))
-&gt; Maybe Substitutions
-&gt; Map String (String -&gt; String)
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Map String (String -&gt; String)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Substitutions -&gt; Map String (String -&gt; String)
</span><a href="Language.C.Inline.Internal.html#unSubstitutions"><span class="hs-identifier hs-var">unSubstitutions</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Substitutions -&gt; Map String (String -&gt; String))
-&gt; Q (Maybe Substitutions) -&gt; Q (Map String (String -&gt; String))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Q (Maybe Substitutions)
forall a. Typeable a =&gt; Q (Maybe a)
</span><span class="hs-identifier hs-var">TH.getQ</span></span><span>
</span><span id="line-507"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299288"><span class="annot"><a href="#local-6989586621679299288"><span class="hs-identifier hs-var hs-var">substitution</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ParsecT String () Identity String]
-&gt; ParsecT String () Identity String
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, MonadPlus m) =&gt;
t (m a) -&gt; m a
</span><span class="hs-identifier hs-var">msum</span></span><span> </span><span class="annot"><span class="annottext">([ParsecT String () Identity String]
 -&gt; ParsecT String () Identity String)
-&gt; [ParsecT String () Identity String]
-&gt; ParsecT String () Identity String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(((String, String -&gt; String) -&gt; ParsecT String () Identity String)
 -&gt; [(String, String -&gt; String)]
 -&gt; [ParsecT String () Identity String])
-&gt; [(String, String -&gt; String)]
-&gt; ((String, String -&gt; String)
    -&gt; ParsecT String () Identity String)
-&gt; [ParsecT String () Identity String]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">((String, String -&gt; String) -&gt; ParsecT String () Identity String)
-&gt; [(String, String -&gt; String)]
-&gt; [ParsecT String () Identity String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map String (String -&gt; String) -&gt; [(String, String -&gt; String)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">Map String (String -&gt; String)
</span><a href="#local-6989586621679299287"><span class="hs-identifier hs-var">subs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((String, String -&gt; String) -&gt; ParsecT String () Identity String)
 -&gt; [ParsecT String () Identity String])
-&gt; ((String, String -&gt; String)
    -&gt; ParsecT String () Identity String)
-&gt; [ParsecT String () Identity String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span> </span><span id="local-6989586621679299291"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299291"><span class="hs-identifier hs-var">subName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299292"><span class="annot"><span class="annottext">String -&gt; String
</span><a href="#local-6989586621679299292"><span class="hs-identifier hs-var">subFunc</span></a></span></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-508"></span><span>        </span><span class="annot"><span class="annottext">ParsecT String () Identity String
-&gt; ParsecT String () Identity String
forall s u (m :: * -&gt; *) a. ParsecT s u m a -&gt; ParsecT s u m a
</span><span class="hs-identifier hs-var">Parsec.try</span></span><span> </span><span class="annot"><span class="annottext">(ParsecT String () Identity String
 -&gt; ParsecT String () Identity String)
-&gt; ParsecT String () Identity String
-&gt; ParsecT String () Identity String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-509"></span><span>          </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ParsecT String () Identity String
forall s (m :: * -&gt; *) u.
Stream s m Char =&gt;
String -&gt; ParsecT s u m String
</span><span class="hs-identifier hs-var">Parsec.string</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'@'</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; String -&gt; String
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299291"><span class="hs-identifier hs-var">subName</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;(&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-510"></span><span>          </span><span id="local-6989586621679299295"><span class="annot"><a href="#local-6989586621679299295"><span class="hs-identifier hs-var">subArg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Parsec.manyTill</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Parsec.anyChar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Parsec.char</span></span><span> </span><span class="annot"><span class="hs-char">')'</span></span><span class="hs-special">)</span><span>
</span><span id="line-511"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679299292"><span class="hs-identifier hs-type">subFunc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299295"><span class="hs-identifier hs-type">subArg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-512"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299306"><span class="annot"><a href="#local-6989586621679299306"><span class="hs-identifier hs-var hs-var">someChar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; String -&gt; String
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Char -&gt; String)
-&gt; ParsecT String u Identity Char
-&gt; ParsecT String u Identity String
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ParsecT String u Identity Char
forall s (m :: * -&gt; *) u. Stream s m Char =&gt; ParsecT s u m Char
</span><span class="hs-identifier hs-var">Parsec.anyChar</span></span><span>
</span><span id="line-513"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Parsec.parse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">many</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679299288"><span class="hs-identifier hs-type">substitution</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;|&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621679299306"><span class="hs-identifier hs-type">someChar</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679299286"><span class="hs-identifier hs-type">str</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-514"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">ParseError
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Q String
forall a. String -&gt; Q a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Substitution failed (should be impossible)&quot;</span></span><span>
</span><span id="line-515"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679299310"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679299310"><span class="hs-identifier hs-var">chunks</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Q String
forall a. a -&gt; Q a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[String] -&gt; String
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679299310"><span class="hs-identifier hs-var">chunks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-516"></span><span>
</span><span id="line-517"></span><span class="hs-comment">-- | Define macros that can be used in the nested Template Haskell expression.</span><span>
</span><span id="line-518"></span><span class="hs-comment">-- Macros can be used as @\@MACRO_NAME(input)@ in inline-c quotes, and will transform their input with the given function.</span><span>
</span><span id="line-519"></span><span class="hs-comment">-- They can be useful for passing in types when defining Haskell instances for C++ template types.</span><span>
</span><span id="line-520"></span><span id="local-6989586621679298613"><span class="annot"><a href="Language.C.Inline.Internal.html#substitute"><span class="hs-identifier hs-type">substitute</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Q</span></span><span> </span><span class="annot"><a href="#local-6989586621679298613"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Q</span></span><span> </span><span class="annot"><a href="#local-6989586621679298613"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-521"></span><span id="substitute"><span class="annot"><span class="annottext">substitute :: forall a. [(String, String -&gt; String)] -&gt; Q a -&gt; Q a
</span><a href="Language.C.Inline.Internal.html#substitute"><span class="hs-identifier hs-var hs-var">substitute</span></a></span></span><span> </span><span id="local-6989586621679299329"><span class="annot"><span class="annottext">[(String, String -&gt; String)]
</span><a href="#local-6989586621679299329"><span class="hs-identifier hs-var">subsList</span></a></span></span><span> </span><span id="local-6989586621679299330"><span class="annot"><span class="annottext">Q a
</span><a href="#local-6989586621679299330"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-522"></span><span>  </span><span id="local-6989586621679299331"><span class="annot"><a href="#local-6989586621679299331"><span class="hs-identifier hs-var">oldSubs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map String (String -&gt; String)
-&gt; (Substitutions -&gt; Map String (String -&gt; String))
-&gt; Maybe Substitutions
-&gt; Map String (String -&gt; String)
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Map String (String -&gt; String)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Substitutions -&gt; Map String (String -&gt; String)
</span><a href="Language.C.Inline.Internal.html#unSubstitutions"><span class="hs-identifier hs-var">unSubstitutions</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Substitutions -&gt; Map String (String -&gt; String))
-&gt; Q (Maybe Substitutions) -&gt; Q (Map String (String -&gt; String))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Q (Maybe Substitutions)
forall a. Typeable a =&gt; Q (Maybe a)
</span><span class="hs-identifier hs-var">TH.getQ</span></span><span>
</span><span id="line-523"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299332"><span class="annot"><a href="#local-6989586621679299332"><span class="hs-identifier hs-var hs-var">subs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(String, String -&gt; String)] -&gt; Map String (String -&gt; String)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(String, String -&gt; String)]
</span><a href="#local-6989586621679299329"><span class="hs-identifier hs-var">subsList</span></a></span><span>
</span><span id="line-524"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299334"><span class="annot"><a href="#local-6989586621679299334"><span class="hs-identifier hs-var hs-var">conflicting</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map String (String -&gt; String)
-&gt; Map String (String -&gt; String) -&gt; Map String (String -&gt; String)
forall k a b. Ord k =&gt; Map k a -&gt; Map k b -&gt; Map k a
</span><span class="hs-identifier hs-var">M.intersection</span></span><span> </span><span class="annot"><span class="annottext">Map String (String -&gt; String)
</span><a href="#local-6989586621679299332"><span class="hs-identifier hs-var">subs</span></a></span><span> </span><span class="annot"><span class="annottext">Map String (String -&gt; String)
</span><a href="#local-6989586621679299331"><span class="hs-identifier hs-var">oldSubs</span></a></span><span>
</span><span id="line-525"></span><span>  </span><span id="local-6989586621679299336"><span class="annot"><a href="#local-6989586621679299336"><span class="hs-identifier hs-var">newSubs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-526"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.null</span></span><span> </span><span class="annot"><a href="#local-6989586621679299334"><span class="hs-identifier hs-type">conflicting</span></a></span><span>
</span><span id="line-527"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Inline.Internal.html#Substitutions"><span class="hs-identifier hs-type">Substitutions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">M.union</span></span><span> </span><span class="annot"><a href="#local-6989586621679299331"><span class="hs-identifier hs-type">oldSubs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299332"><span class="hs-identifier hs-type">subs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-528"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">fail</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;Conflicting substitutions `&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">M.keys</span></span><span> </span><span class="annot"><a href="#local-6989586621679299334"><span class="hs-identifier hs-type">conflicting</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot;`&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-529"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TH.putQ</span></span><span> </span><span class="annot"><a href="#local-6989586621679299336"><span class="hs-identifier hs-type">newSubs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">*&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621679299330"><span class="hs-identifier hs-type">cont</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;*</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.putQ</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Inline.Internal.html#Substitutions"><span class="hs-identifier hs-type">Substitutions</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299331"><span class="hs-identifier hs-type">oldSubs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-530"></span><span>
</span><span id="line-531"></span><span class="hs-comment">-- | Given a C type name, return the Haskell type in Template Haskell. The first parameter controls whether function pointers</span><span>
</span><span id="line-532"></span><span class="hs-comment">-- should be mapped as pure or IO functions.</span><span>
</span><span id="line-533"></span><span class="annot"><a href="Language.C.Inline.Internal.html#getHaskellType"><span class="hs-identifier hs-type">getHaskellType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.TypeQ</span></span><span>
</span><span id="line-534"></span><span id="getHaskellType"><span class="annot"><span class="annottext">getHaskellType :: Bool -&gt; String -&gt; Q Type
</span><a href="Language.C.Inline.Internal.html#getHaskellType"><span class="hs-identifier hs-var hs-var">getHaskellType</span></a></span></span><span> </span><span id="local-6989586621679299340"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299340"><span class="hs-identifier hs-var">pureFunctions</span></a></span></span><span> </span><span id="local-6989586621679299341"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299341"><span class="hs-identifier hs-var">cTypeStr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-535"></span><span>  </span><span id="local-6989586621679299342"><span class="annot"><a href="#local-6989586621679299342"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Q Context
</span><a href="Language.C.Inline.Internal.html#getContext"><span class="hs-identifier hs-var">getContext</span></a></span><span>
</span><span id="line-536"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299343"><span class="annot"><a href="#local-6989586621679299343"><span class="hs-identifier hs-var hs-var">cParseCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TypeNames -&gt; CParserContext CIdentifier
</span><a href="Language.C.Types.Parse.html#cCParserContext"><span class="hs-identifier hs-var">C.cCParserContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Language.C.Inline.Context.html#ctxEnableCpp"><span class="hs-identifier hs-var">ctxEnableCpp</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679299342"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypesTable -&gt; TypeNames
</span><a href="Language.C.Inline.Context.html#typeNamesFromTypesTable"><span class="hs-identifier hs-var">typeNamesFromTypesTable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; TypesTable
</span><a href="Language.C.Inline.Context.html#ctxTypesTable"><span class="hs-identifier hs-var">ctxTypesTable</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679299342"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-537"></span><span>  </span><span id="local-6989586621679299347"><span class="annot"><a href="#local-6989586621679299347"><span class="hs-identifier hs-var">cType</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#runParserInQ"><span class="hs-identifier hs-type">runParserInQ</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299341"><span class="hs-identifier hs-type">cTypeStr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299343"><span class="hs-identifier hs-type">cParseCtx</span></a></span><span> </span><span class="annot"><a href="Language.C.Types.html#parseType"><span class="hs-identifier hs-type">C.parseType</span></a></span><span>
</span><span id="line-538"></span><span>  </span><span class="annot"><a href="Language.C.Inline.Internal.html#cToHs"><span class="hs-identifier hs-type">cToHs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299342"><span class="hs-identifier hs-type">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621679299340"><span class="hs-identifier hs-type">pureFunctions</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="Language.C.Inline.Context.html#Pure"><span class="hs-identifier hs-type">Pure</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="Language.C.Inline.Context.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679299347"><span class="hs-identifier hs-type">cType</span></a></span><span>
</span><span id="line-539"></span><span>
</span><span id="line-540"></span><span class="hs-comment">-- To parse C declarations, we're faced with a bit of a problem: we want</span><span>
</span><span id="line-541"></span><span class="hs-comment">-- to parse the anti-quotations so that Haskell identifiers are</span><span>
</span><span id="line-542"></span><span class="hs-comment">-- accepted, but we want them to appear only as the root of</span><span>
</span><span id="line-543"></span><span class="hs-comment">-- declarations.  For this reason, we parse allowing Haskell identifiers</span><span>
</span><span id="line-544"></span><span class="hs-comment">-- everywhere, and then we &quot;purge&quot; Haskell identifiers everywhere but at</span><span>
</span><span id="line-545"></span><span class="hs-comment">-- the root.</span><span>
</span><span id="line-546"></span><span class="annot"><a href="Language.C.Inline.Internal.html#parseTypedC"><span class="hs-identifier hs-type">parseTypedC</span></a></span><span>
</span><span id="line-547"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679298632"><span class="annot"><a href="#local-6989586621679298632"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CParser"><span class="hs-identifier hs-type">C.CParser</span></a></span><span> </span><span class="annot"><a href="Language.C.Inline.HaskellIdentifier.html#HaskellIdentifier"><span class="hs-identifier hs-type">HaskellIdentifier</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298632"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-548"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.C.Inline.Context.html#AntiQuoters"><span class="hs-identifier hs-type">AntiQuoters</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679298632"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#ParseTypedC"><span class="hs-identifier hs-type">ParseTypedC</span></a></span><span>
</span><span id="line-549"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Returns the return type, the captured variables, and the body.</span></span><span>
</span><span id="line-550"></span><span id="parseTypedC"><span class="annot"><span class="annottext">parseTypedC :: forall (m :: * -&gt; *).
CParser HaskellIdentifier m =&gt;
Bool -&gt; AntiQuoters -&gt; m ParseTypedC
</span><a href="Language.C.Inline.Internal.html#parseTypedC"><span class="hs-identifier hs-var hs-var">parseTypedC</span></a></span></span><span> </span><span id="local-6989586621679299464"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299464"><span class="hs-identifier hs-var">useCpp</span></a></span></span><span> </span><span id="local-6989586621679299465"><span class="annot"><span class="annottext">AntiQuoters
</span><a href="#local-6989586621679299465"><span class="hs-identifier hs-var">antiQs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-551"></span><span>  </span><span class="hs-comment">-- Parse return type (consume spaces first)</span><span>
</span><span id="line-552"></span><span>  </span><span class="annot"><span class="annottext">m ()
forall (m :: * -&gt; *). CharParsing m =&gt; m ()
</span><span class="hs-identifier hs-var">Parser.spaces</span></span><span>
</span><span id="line-553"></span><span>  </span><span id="local-6989586621679299467"><span class="annot"><a href="#local-6989586621679299467"><span class="hs-identifier hs-var">cRetType</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type HaskellIdentifier -&gt; m (Type CIdentifier)
forall (n :: * -&gt; *).
MonadFail n =&gt;
Type HaskellIdentifier -&gt; n (Type CIdentifier)
</span><a href="#local-6989586621679299468"><span class="hs-identifier hs-var">purgeHaskellIdentifiers</span></a></span><span> </span><span class="annot"><span class="annottext">(Type HaskellIdentifier -&gt; m (Type CIdentifier))
-&gt; m (Type HaskellIdentifier) -&gt; m (Type CIdentifier)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">m (Type HaskellIdentifier)
forall i (m :: * -&gt; *). (CParser i m, Pretty i) =&gt; m (Type i)
</span><a href="Language.C.Types.html#parseType"><span class="hs-identifier hs-var">C.parseType</span></a></span><span>
</span><span id="line-554"></span><span>  </span><span class="hs-comment">-- Parse the body</span><span>
</span><span id="line-555"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">void</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Parser.char</span></span><span> </span><span class="annot"><span class="hs-char">'{'</span></span><span>
</span><span id="line-556"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679299471"><span class="annot"><a href="#local-6989586621679299471"><span class="hs-identifier hs-var">cParams</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299472"><span class="annot"><a href="#local-6989586621679299472"><span class="hs-identifier hs-var">cBody</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">evalStateT</span></span><span> </span><span class="annot"><a href="#local-6989586621679299473"><span class="hs-identifier hs-type">parseBody</span></a></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-557"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#ParseTypedC"><span class="hs-identifier hs-type">ParseTypedC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299467"><span class="hs-identifier hs-type">cRetType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299471"><span class="hs-identifier hs-type">cParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299472"><span class="hs-identifier hs-type">cBody</span></a></span><span>
</span><span id="line-558"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-559"></span><span>    </span><span class="annot"><a href="#local-6989586621679299473"><span class="hs-identifier hs-type">parseBody</span></a></span><span>
</span><span id="line-560"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><a href="#local-6989586621679298632"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Types.html#Type"><span class="hs-identifier hs-type">C.Type</span></a></span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#ParameterType"><span class="hs-identifier hs-type">ParameterType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span>
</span><span id="line-561"></span><span>    </span><span id="local-6989586621679299473"><span class="annot"><span class="annottext">parseBody :: StateT
  Int m ([(CIdentifier, Type CIdentifier, ParameterType)], String)
</span><a href="#local-6989586621679299473"><span class="hs-identifier hs-var hs-var">parseBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-562"></span><span>      </span><span class="hs-comment">-- Note that this code does not use &quot;lexing&quot; combinators (apart</span><span>
</span><span id="line-563"></span><span>      </span><span class="hs-comment">-- when appropriate) because we want to make sure to preserve</span><span>
</span><span id="line-564"></span><span>      </span><span class="hs-comment">-- whitespace after we substitute things.</span><span>
</span><span id="line-565"></span><span>      </span><span id="local-6989586621679299474"><span class="annot"><a href="#local-6989586621679299474"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT Int m Char -&gt; StateT Int m Char -&gt; StateT Int m String
forall (m :: * -&gt; *) a end. Alternative m =&gt; m a -&gt; m end -&gt; m [a]
</span><span class="hs-identifier hs-var">Parser.manyTill</span></span><span> </span><span class="annot"><span class="annottext">StateT Int m Char
forall (m :: * -&gt; *). CharParsing m =&gt; m Char
</span><span class="hs-identifier hs-var">Parser.anyChar</span></span><span> </span><span class="annot"><span class="annottext">(StateT Int m Char -&gt; StateT Int m String)
-&gt; StateT Int m Char -&gt; StateT Int m String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-566"></span><span>           </span><span class="annot"><span class="annottext">StateT Int m Char -&gt; StateT Int m Char
forall a. StateT Int m a -&gt; StateT Int m a
forall (m :: * -&gt; *) a. LookAheadParsing m =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">Parser.lookAhead</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; StateT Int m Char
forall (m :: * -&gt; *). CharParsing m =&gt; Char -&gt; m Char
</span><span class="hs-identifier hs-var">Parser.char</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'}'</span></span><span> </span><span class="annot"><span class="annottext">StateT Int m Char -&gt; StateT Int m Char -&gt; StateT Int m Char
forall a. StateT Int m a -&gt; StateT Int m a -&gt; StateT Int m a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; StateT Int m Char
forall (m :: * -&gt; *). CharParsing m =&gt; Char -&gt; m Char
</span><span class="hs-identifier hs-var">Parser.char</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'$'</span></span><span class="hs-special">)</span><span>
</span><span id="line-567"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679299478"><span class="annot"><a href="#local-6989586621679299478"><span class="hs-identifier hs-var">decls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299479"><span class="annot"><a href="#local-6989586621679299479"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">msum</span></span><span>
</span><span id="line-568"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Parser.try</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Try because we might fail to parse the 'eof'</span><span>
</span><span id="line-569"></span><span>                </span><span class="hs-comment">-- 'symbolic' because we want to consume whitespace</span><span>
</span><span id="line-570"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">void</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Parser.symbolic</span></span><span> </span><span class="annot"><span class="hs-char">'}'</span></span><span>
</span><span id="line-571"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">Parser.eof</span></span><span>
</span><span id="line-572"></span><span>             </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-573"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="hs-identifier hs-type">void</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Parser.char</span></span><span> </span><span class="annot"><span class="hs-char">'}'</span></span><span>
</span><span id="line-574"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621679299482"><span class="annot"><a href="#local-6989586621679299482"><span class="hs-identifier hs-var">decls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299483"><span class="annot"><a href="#local-6989586621679299483"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679299473"><span class="hs-identifier hs-type">parseBody</span></a></span><span>
</span><span id="line-575"></span><span>             </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679299482"><span class="hs-identifier hs-type">decls</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;}&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621679299483"><span class="hs-identifier hs-type">s'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-576"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="hs-identifier hs-type">void</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Parser.char</span></span><span> </span><span class="annot"><span class="hs-char">'$'</span></span><span>
</span><span id="line-577"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621679299484"><span class="annot"><a href="#local-6989586621679299484"><span class="hs-identifier hs-var">decls1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299485"><span class="annot"><a href="#local-6989586621679299485"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679299486"><span class="hs-identifier hs-type">parseEscapedDollar</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;|&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621679299487"><span class="hs-identifier hs-type">parseAntiQuote</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;|&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621679299488"><span class="hs-identifier hs-type">parseTypedCapture</span></a></span><span>
</span><span id="line-578"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621679299489"><span class="annot"><a href="#local-6989586621679299489"><span class="hs-identifier hs-var">decls2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299490"><span class="annot"><a href="#local-6989586621679299490"><span class="hs-identifier hs-var">s2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679299473"><span class="hs-identifier hs-type">parseBody</span></a></span><span>
</span><span id="line-579"></span><span>             </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679299484"><span class="hs-identifier hs-type">decls1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621679299489"><span class="hs-identifier hs-type">decls2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679299485"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621679299490"><span class="hs-identifier hs-type">s2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-580"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-581"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679299478"><span class="hs-identifier hs-type">decls</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679299474"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621679299479"><span class="hs-identifier hs-type">s'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-582"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-583"></span><span>
</span><span id="line-584"></span><span>    </span><span class="annot"><a href="#local-6989586621679299487"><span class="hs-identifier hs-type">parseAntiQuote</span></a></span><span>
</span><span id="line-585"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><a href="#local-6989586621679298632"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Types.html#Type"><span class="hs-identifier hs-type">C.Type</span></a></span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#ParameterType"><span class="hs-identifier hs-type">ParameterType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span>
</span><span id="line-586"></span><span>    </span><span id="local-6989586621679299487"><span class="annot"><span class="annottext">parseAntiQuote :: StateT
  Int m ([(CIdentifier, Type CIdentifier, ParameterType)], String)
</span><a href="#local-6989586621679299487"><span class="hs-identifier hs-var hs-var">parseAntiQuote</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[StateT
   Int m ([(CIdentifier, Type CIdentifier, ParameterType)], String)]
-&gt; StateT
     Int m ([(CIdentifier, Type CIdentifier, ParameterType)], String)
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, MonadPlus m) =&gt;
t (m a) -&gt; m a
</span><span class="hs-identifier hs-var">msum</span></span><span>
</span><span id="line-587"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">StateT Int m String -&gt; StateT Int m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(StateT Int m String -&gt; StateT Int m ())
-&gt; StateT Int m String -&gt; StateT Int m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StateT Int m String -&gt; StateT Int m String
forall a. StateT Int m a -&gt; StateT Int m a
forall (m :: * -&gt; *) a. Parsing m =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">Parser.try</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; StateT Int m String
forall (m :: * -&gt; *). CharParsing m =&gt; String -&gt; m String
</span><span class="hs-identifier hs-var">Parser.string</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; StateT Int m String) -&gt; String -&gt; StateT Int m String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299495"><span class="hs-identifier hs-var">antiQId</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;:&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StateT Int m String -&gt; String -&gt; StateT Int m String
forall a. StateT Int m a -&gt; String -&gt; StateT Int m a
forall (m :: * -&gt; *) a. Parsing m =&gt; m a -&gt; String -&gt; m a
</span><span class="hs-operator hs-var">Parser.&lt;?&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;anti quoter id&quot;</span></span><span>
</span><span id="line-588"></span><span>           </span><span class="hs-special">(</span><span id="local-6989586621679299499"><span class="annot"><a href="#local-6989586621679299499"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299500"><span class="annot"><a href="#local-6989586621679299500"><span class="hs-identifier hs-var">cTy</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299501"><span class="annot"><a href="#local-6989586621679299501"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AntiQuoter a
-&gt; forall (m :: * -&gt; *).
   CParser HaskellIdentifier m =&gt;
   m (CIdentifier, Type CIdentifier, a)
forall a.
AntiQuoter a
-&gt; forall (m :: * -&gt; *).
   CParser HaskellIdentifier m =&gt;
   m (CIdentifier, Type CIdentifier, a)
</span><a href="Language.C.Inline.Context.html#aqParser"><span class="hs-identifier hs-var">aqParser</span></a></span><span> </span><span class="annot"><span class="annottext">AntiQuoter a
</span><a href="#local-6989586621679299504"><span class="hs-identifier hs-var">antiQ</span></a></span><span>
</span><span id="line-589"></span><span>           </span><span id="local-6989586621679299505"><span class="annot"><a href="#local-6989586621679299505"><span class="hs-identifier hs-var">id'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679299506"><span class="hs-identifier hs-type">freshId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299499"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-590"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679299505"><span class="hs-identifier hs-type">id'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679299500"><span class="hs-identifier hs-type">cTy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#AntiQuote"><span class="hs-identifier hs-type">AntiQuote</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299495"><span class="hs-identifier hs-type">antiQId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Inline.Internal.html#toSomeEq"><span class="hs-identifier hs-type">toSomeEq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299501"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#unCIdentifier"><span class="hs-identifier hs-var">C.unCIdentifier</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299505"><span class="hs-identifier hs-type">id'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-591"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299495"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299495"><span class="hs-identifier hs-var">antiQId</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Context.html#SomeAntiQuoter"><span class="hs-identifier hs-type">SomeAntiQuoter</span></a></span><span> </span><span id="local-6989586621679299504"><span class="annot"><span class="annottext">AntiQuoter a
</span><a href="#local-6989586621679299504"><span class="hs-identifier hs-var">antiQ</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AntiQuoters -&gt; [(String, SomeAntiQuoter)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">AntiQuoters
</span><a href="#local-6989586621679299465"><span class="hs-identifier hs-var">antiQs</span></a></span><span>
</span><span id="line-592"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-593"></span><span>
</span><span id="line-594"></span><span>    </span><span id="local-6989586621679298680"><span class="annot"><a href="#local-6989586621679299486"><span class="hs-identifier hs-type">parseEscapedDollar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><a href="#local-6989586621679298632"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679298680"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-595"></span><span>    </span><span id="local-6989586621679299486"><span class="annot"><span class="annottext">parseEscapedDollar :: forall a. StateT Int m ([a], String)
</span><a href="#local-6989586621679299486"><span class="hs-identifier hs-var hs-var">parseEscapedDollar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-596"></span><span>      </span><span class="annot"><span class="annottext">StateT Int m Char -&gt; StateT Int m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(StateT Int m Char -&gt; StateT Int m ())
-&gt; StateT Int m Char -&gt; StateT Int m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; StateT Int m Char
forall (m :: * -&gt; *). CharParsing m =&gt; Char -&gt; m Char
</span><span class="hs-identifier hs-var">Parser.char</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'$'</span></span><span>
</span><span id="line-597"></span><span>      </span><span class="annot"><span class="annottext">([a], String) -&gt; StateT Int m ([a], String)
forall a. a -&gt; StateT Int m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;$&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-598"></span><span>
</span><span id="line-599"></span><span>    </span><span class="annot"><a href="#local-6989586621679299488"><span class="hs-identifier hs-type">parseTypedCapture</span></a></span><span>
</span><span id="line-600"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><a href="#local-6989586621679298632"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Types.html#Type"><span class="hs-identifier hs-type">C.Type</span></a></span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#ParameterType"><span class="hs-identifier hs-type">ParameterType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span>
</span><span id="line-601"></span><span>    </span><span id="local-6989586621679299488"><span class="annot"><span class="annottext">parseTypedCapture :: StateT
  Int m ([(CIdentifier, Type CIdentifier, ParameterType)], String)
</span><a href="#local-6989586621679299488"><span class="hs-identifier hs-var hs-var">parseTypedCapture</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-602"></span><span>      </span><span class="annot"><span class="annottext">StateT Int m Char -&gt; StateT Int m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(StateT Int m Char -&gt; StateT Int m ())
-&gt; StateT Int m Char -&gt; StateT Int m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; StateT Int m Char
forall (m :: * -&gt; *). TokenParsing m =&gt; Char -&gt; m Char
</span><span class="hs-identifier hs-var">Parser.symbolic</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'('</span></span><span>
</span><span id="line-603"></span><span>      </span><span id="local-6989586621679299521"><span class="annot"><a href="#local-6989586621679299521"><span class="hs-identifier hs-var">decl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT Int m (ParameterDeclaration HaskellIdentifier)
forall i (m :: * -&gt; *).
(CParser i m, Pretty i) =&gt;
m (ParameterDeclaration i)
</span><a href="Language.C.Types.html#parseParameterDeclaration"><span class="hs-identifier hs-var">C.parseParameterDeclaration</span></a></span><span>
</span><span id="line-604"></span><span>      </span><span id="local-6989586621679299523"><span class="annot"><a href="#local-6989586621679299523"><span class="hs-identifier hs-var">declType</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679299468"><span class="hs-identifier hs-type">purgeHaskellIdentifiers</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Language.C.Types.html#parameterDeclarationType"><span class="hs-identifier hs-var">C.parameterDeclarationType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299521"><span class="hs-identifier hs-type">decl</span></a></span><span>
</span><span id="line-605"></span><span>      </span><span class="hs-comment">-- Purge the declaration type of all the Haskell identifiers.</span><span>
</span><span id="line-606"></span><span>      </span><span id="local-6989586621679299525"><span class="annot"><a href="#local-6989586621679299525"><span class="hs-identifier hs-var">hId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="Language.C.Types.html#parameterDeclarationId"><span class="hs-identifier hs-var">C.parameterDeclarationId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299521"><span class="hs-identifier hs-type">decl</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-607"></span><span>        </span><span class="annot"><span class="annottext">Maybe HaskellIdentifier
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; StateT Int m HaskellIdentifier
forall a. String -&gt; StateT Int m a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; StateT Int m HaskellIdentifier)
-&gt; String -&gt; StateT Int m HaskellIdentifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc (ZonkAny 2) -&gt; String
forall ann. Doc ann -&gt; String
</span><a href="Language.C.Inline.Internal.html#pretty80"><span class="hs-identifier hs-var">pretty80</span></a></span><span> </span><span class="annot"><span class="annottext">(Doc (ZonkAny 2) -&gt; String) -&gt; Doc (ZonkAny 2) -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-608"></span><span>          </span><span class="annot"><span class="annottext">Doc (ZonkAny 2)
</span><span class="hs-string">&quot;Un-named captured variable in decl&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc (ZonkAny 2) -&gt; Doc (ZonkAny 2) -&gt; Doc (ZonkAny 2)
forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">ParameterDeclaration HaskellIdentifier -&gt; Doc (ZonkAny 2)
forall a ann. Pretty a =&gt; a -&gt; Doc ann
forall ann. ParameterDeclaration HaskellIdentifier -&gt; Doc ann
</span><span class="hs-identifier hs-var">PP.pretty</span></span><span> </span><span class="annot"><span class="annottext">ParameterDeclaration HaskellIdentifier
</span><a href="#local-6989586621679299521"><span class="hs-identifier hs-var">decl</span></a></span><span>
</span><span id="line-609"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299528"><span class="annot"><span class="annottext">HaskellIdentifier
</span><a href="#local-6989586621679299528"><span class="hs-identifier hs-var">hId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HaskellIdentifier -&gt; StateT Int m HaskellIdentifier
forall a. a -&gt; StateT Int m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">HaskellIdentifier
</span><a href="#local-6989586621679299528"><span class="hs-identifier hs-var">hId</span></a></span><span>
</span><span id="line-610"></span><span>      </span><span id="local-6989586621679299529"><span class="annot"><a href="#local-6989586621679299529"><span class="hs-identifier hs-var">id'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679299506"><span class="hs-identifier hs-type">freshId</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Language.C.Inline.HaskellIdentifier.html#mangleHaskellIdentifier"><span class="hs-identifier hs-type">mangleHaskellIdentifier</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299464"><span class="hs-identifier hs-type">useCpp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299525"><span class="hs-identifier hs-type">hId</span></a></span><span>
</span><span id="line-611"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">void</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Parser.char</span></span><span> </span><span class="annot"><span class="hs-char">')'</span></span><span>
</span><span id="line-612"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679299529"><span class="hs-identifier hs-type">id'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679299523"><span class="hs-identifier hs-type">declType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#Plain"><span class="hs-identifier hs-type">Plain</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299525"><span class="hs-identifier hs-type">hId</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#unCIdentifier"><span class="hs-identifier hs-var">C.unCIdentifier</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299529"><span class="hs-identifier hs-type">id'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-613"></span><span>
</span><span id="line-614"></span><span>    </span><span id="local-6989586621679299506"><span class="annot"><span class="annottext">freshId :: CIdentifier -&gt; StateT Int m CIdentifier
</span><a href="#local-6989586621679299506"><span class="hs-identifier hs-var hs-var">freshId</span></a></span></span><span> </span><span id="local-6989586621679299531"><span class="annot"><span class="annottext">CIdentifier
</span><a href="#local-6989586621679299531"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-615"></span><span>      </span><span id="local-6989586621679299532"><span class="annot"><a href="#local-6989586621679299532"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT Int m Int
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-616"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">put</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621679299532"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span>
</span><span id="line-617"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#cIdentifierFromString"><span class="hs-identifier hs-type">C.cIdentifierFromString</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299464"><span class="hs-identifier hs-type">useCpp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Types.Parse.html#unCIdentifier"><span class="hs-identifier hs-var">C.unCIdentifier</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299531"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot;_inline_c_&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">show</span></span><span> </span><span class="annot"><a href="#local-6989586621679299532"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-618"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679299533"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299533"><span class="hs-identifier hs-var">_err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; StateT Int m CIdentifier
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;freshId: The impossible happened&quot;</span></span><span>
</span><span id="line-619"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679299534"><span class="annot"><span class="annottext">CIdentifier
</span><a href="#local-6989586621679299534"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CIdentifier -&gt; StateT Int m CIdentifier
forall a. a -&gt; StateT Int m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">CIdentifier
</span><a href="#local-6989586621679299534"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-620"></span><span>
</span><span id="line-621"></span><span>    </span><span class="hs-comment">-- The @m@ is polymorphic because we use this both for the plain</span><span>
</span><span id="line-622"></span><span>    </span><span class="hs-comment">-- parser and the StateT parser we use above.  We only need 'fail'.</span><span>
</span><span id="line-623"></span><span>    </span><span class="annot"><a href="#local-6989586621679299468"><span class="hs-identifier hs-type">purgeHaskellIdentifiers</span></a></span><span class="hs-cpp">
#if MIN_VERSION_base(4,13,0)
</span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679298665"><span class="annot"><a href="#local-6989586621679298665"><span class="hs-identifier hs-type">n</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadFail</span></span><span> </span><span class="annot"><a href="#local-6989586621679298665"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-cpp">
#else
</span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-identifier">n</span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Applicative</span><span> </span><span class="hs-identifier">n</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Monad</span><span> </span><span class="hs-identifier">n</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Language.C.Types.html#Type"><span class="hs-identifier hs-type">C.Type</span></a></span><span> </span><span class="annot"><a href="Language.C.Inline.HaskellIdentifier.html#HaskellIdentifier"><span class="hs-identifier hs-type">HaskellIdentifier</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679298665"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Types.html#Type"><span class="hs-identifier hs-type">C.Type</span></a></span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-630"></span><span>    </span><span id="local-6989586621679299468"><span class="annot"><span class="annottext">purgeHaskellIdentifiers :: forall (n :: * -&gt; *).
MonadFail n =&gt;
Type HaskellIdentifier -&gt; n (Type CIdentifier)
</span><a href="#local-6989586621679299468"><span class="hs-identifier hs-var hs-var">purgeHaskellIdentifiers</span></a></span></span><span> </span><span id="local-6989586621679299551"><span class="annot"><span class="annottext">Type HaskellIdentifier
</span><a href="#local-6989586621679299551"><span class="hs-identifier hs-var">cTy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type HaskellIdentifier
-&gt; (HaskellIdentifier -&gt; n CIdentifier) -&gt; n (Type CIdentifier)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="annot"><span class="annottext">Type HaskellIdentifier
</span><a href="#local-6989586621679299551"><span class="hs-identifier hs-var">cTy</span></a></span><span> </span><span class="annot"><span class="annottext">((HaskellIdentifier -&gt; n CIdentifier) -&gt; n (Type CIdentifier))
-&gt; (HaskellIdentifier -&gt; n CIdentifier) -&gt; n (Type CIdentifier)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679299552"><span class="annot"><span class="annottext">HaskellIdentifier
</span><a href="#local-6989586621679299552"><span class="hs-identifier hs-var">hsIdent</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-631"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299553"><span class="annot"><span class="annottext">hsIdentS :: String
</span><a href="#local-6989586621679299553"><span class="hs-identifier hs-var hs-var">hsIdentS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HaskellIdentifier -&gt; String
</span><a href="Language.C.Inline.HaskellIdentifier.html#unHaskellIdentifier"><span class="hs-identifier hs-var">unHaskellIdentifier</span></a></span><span> </span><span class="annot"><span class="annottext">HaskellIdentifier
</span><a href="#local-6989586621679299552"><span class="hs-identifier hs-var">hsIdent</span></a></span><span>
</span><span id="line-632"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; String -&gt; Either String CIdentifier
</span><a href="Language.C.Types.Parse.html#cIdentifierFromString"><span class="hs-identifier hs-var">C.cIdentifierFromString</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299464"><span class="hs-identifier hs-var">useCpp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299553"><span class="hs-identifier hs-var">hsIdentS</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-633"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679299555"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299555"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; n CIdentifier
forall a. String -&gt; n a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; n CIdentifier) -&gt; String -&gt; n CIdentifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Haskell identifier &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299553"><span class="hs-identifier hs-var">hsIdentS</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; in illegal position&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-634"></span><span>                           </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;in C type\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Doc (ZonkAny 3) -&gt; String
forall ann. Doc ann -&gt; String
</span><a href="Language.C.Inline.Internal.html#pretty80"><span class="hs-identifier hs-var">pretty80</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type HaskellIdentifier -&gt; Doc (ZonkAny 3)
forall a ann. Pretty a =&gt; a -&gt; Doc ann
forall ann. Type HaskellIdentifier -&gt; Doc ann
</span><span class="hs-identifier hs-var">PP.pretty</span></span><span> </span><span class="annot"><span class="annottext">Type HaskellIdentifier
</span><a href="#local-6989586621679299551"><span class="hs-identifier hs-var">cTy</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-635"></span><span>                           </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;A C identifier was expected, but:\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299555"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-636"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679299556"><span class="annot"><span class="annottext">CIdentifier
</span><a href="#local-6989586621679299556"><span class="hs-identifier hs-var">cIdent</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CIdentifier -&gt; n CIdentifier
forall a. a -&gt; n a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">CIdentifier
</span><a href="#local-6989586621679299556"><span class="hs-identifier hs-var">cIdent</span></a></span><span>
</span><span id="line-637"></span><span>
</span><span id="line-638"></span><span class="annot"><a href="Language.C.Inline.Internal.html#quoteCode"><span class="hs-identifier hs-type">quoteCode</span></a></span><span>
</span><span id="line-639"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.ExpQ</span></span><span class="hs-special">)</span><span>
</span><span id="line-640"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ The parser</span></span><span>
</span><span id="line-641"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.QuasiQuoter</span></span><span>
</span><span id="line-642"></span><span id="quoteCode"><span class="annot"><span class="annottext">quoteCode :: (String -&gt; Q Exp) -&gt; QuasiQuoter
</span><a href="Language.C.Inline.Internal.html#quoteCode"><span class="hs-identifier hs-var hs-var">quoteCode</span></a></span></span><span> </span><span id="local-6989586621679299558"><span class="annot"><span class="annottext">String -&gt; Q Exp
</span><a href="#local-6989586621679299558"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.QuasiQuoter</span></span><span>
</span><span id="line-643"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">quoteExp :: String -&gt; Q Exp
</span><span class="hs-identifier hs-var">TH.quoteExp</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Q Exp
</span><a href="#local-6989586621679299558"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-644"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">quotePat :: String -&gt; Q Pat
</span><span class="hs-identifier hs-var">TH.quotePat</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Q Pat -&gt; String -&gt; Q Pat
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(Q Pat -&gt; String -&gt; Q Pat) -&gt; Q Pat -&gt; String -&gt; Q Pat
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Q Pat
forall a. String -&gt; Q a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inline-c: quotePat not implemented (quoteCode)&quot;</span></span><span>
</span><span id="line-645"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">quoteType :: String -&gt; Q Type
</span><span class="hs-identifier hs-var">TH.quoteType</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Q Type -&gt; String -&gt; Q Type
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(Q Type -&gt; String -&gt; Q Type) -&gt; Q Type -&gt; String -&gt; Q Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Q Type
forall a. String -&gt; Q a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inline-c: quoteType not implemented (quoteCode)&quot;</span></span><span>
</span><span id="line-646"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">quoteDec :: String -&gt; DecsQ
</span><span class="hs-identifier hs-var">TH.quoteDec</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DecsQ -&gt; String -&gt; DecsQ
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(DecsQ -&gt; String -&gt; DecsQ) -&gt; DecsQ -&gt; String -&gt; DecsQ
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; DecsQ
forall a. String -&gt; Q a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inline-c: quoteDec not implemented (quoteCode)&quot;</span></span><span>
</span><span id="line-647"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-648"></span><span>
</span><span id="line-649"></span><span class="annot"><a href="Language.C.Inline.Internal.html#cToHs"><span class="hs-identifier hs-type">cToHs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.C.Inline.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.C.Inline.Context.html#Purity"><span class="hs-identifier hs-type">Purity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.C.Types.html#Type"><span class="hs-identifier hs-type">C.Type</span></a></span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.TypeQ</span></span><span>
</span><span id="line-650"></span><span id="cToHs"><span class="annot"><span class="annottext">cToHs :: Context -&gt; Purity -&gt; Type CIdentifier -&gt; Q Type
</span><a href="Language.C.Inline.Internal.html#cToHs"><span class="hs-identifier hs-var hs-var">cToHs</span></a></span></span><span> </span><span id="local-6989586621679299559"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679299559"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679299560"><span class="annot"><span class="annottext">Purity
</span><a href="#local-6989586621679299560"><span class="hs-identifier hs-var">purity</span></a></span></span><span> </span><span id="local-6989586621679299561"><span class="annot"><span class="annottext">Type CIdentifier
</span><a href="#local-6989586621679299561"><span class="hs-identifier hs-var">cTy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-651"></span><span>  </span><span id="local-6989586621679299562"><span class="annot"><a href="#local-6989586621679299562"><span class="hs-identifier hs-var">mbHsTy</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Purity -&gt; TypesTable -&gt; Type CIdentifier -&gt; Q (Maybe Type)
</span><a href="Language.C.Inline.Context.html#convertType"><span class="hs-identifier hs-var">convertType</span></a></span><span> </span><span class="annot"><span class="annottext">Purity
</span><a href="#local-6989586621679299560"><span class="hs-identifier hs-var">purity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; TypesTable
</span><a href="Language.C.Inline.Context.html#ctxTypesTable"><span class="hs-identifier hs-var">ctxTypesTable</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679299559"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type CIdentifier
</span><a href="#local-6989586621679299561"><span class="hs-identifier hs-var">cTy</span></a></span><span>
</span><span id="line-652"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679299562"><span class="hs-identifier hs-type">mbHsTy</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-653"></span><span>    </span><span class="annot"><span class="annottext">Maybe Type
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Q Type
forall a. String -&gt; Q a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Q Type) -&gt; String -&gt; Q Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Could not resolve Haskell type for C type &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Doc (ZonkAny 1) -&gt; String
forall ann. Doc ann -&gt; String
</span><a href="Language.C.Inline.Internal.html#pretty80"><span class="hs-identifier hs-var">pretty80</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type CIdentifier -&gt; Doc (ZonkAny 1)
forall a ann. Pretty a =&gt; a -&gt; Doc ann
forall ann. Type CIdentifier -&gt; Doc ann
</span><span class="hs-identifier hs-var">PP.pretty</span></span><span> </span><span class="annot"><span class="annottext">Type CIdentifier
</span><a href="#local-6989586621679299561"><span class="hs-identifier hs-var">cTy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-654"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299564"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679299564"><span class="hs-identifier hs-var">hsTy</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Q Type
forall a. a -&gt; Q a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679299564"><span class="hs-identifier hs-var">hsTy</span></a></span><span>
</span><span id="line-655"></span><span>
</span><span id="line-656"></span><span class="annot"><a href="Language.C.Inline.Internal.html#genericQuote"><span class="hs-identifier hs-type">genericQuote</span></a></span><span>
</span><span id="line-657"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.C.Inline.Context.html#Purity"><span class="hs-identifier hs-type">Purity</span></a></span><span>
</span><span id="line-658"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.Loc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.TypeQ</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.C.Types.html#Type"><span class="hs-identifier hs-type">C.Type</span></a></span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Types.html#Type"><span class="hs-identifier hs-type">C.Type</span></a></span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.ExpQ</span></span><span class="hs-special">)</span><span>
</span><span id="line-659"></span><span>  </span><span class="hs-comment">-- ^ Function building an Haskell expression, see 'inlineExp' for</span><span>
</span><span id="line-660"></span><span>  </span><span class="hs-comment">-- guidance on the other args.</span><span>
</span><span id="line-661"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.QuasiQuoter</span></span><span>
</span><span id="line-662"></span><span id="genericQuote"><span class="annot"><span class="annottext">genericQuote :: Purity
-&gt; (Loc
    -&gt; Q Type
    -&gt; Type CIdentifier
    -&gt; [(CIdentifier, Type CIdentifier)]
    -&gt; String
    -&gt; Q Exp)
-&gt; QuasiQuoter
</span><a href="Language.C.Inline.Internal.html#genericQuote"><span class="hs-identifier hs-var hs-var">genericQuote</span></a></span></span><span> </span><span id="local-6989586621679299565"><span class="annot"><span class="annottext">Purity
</span><a href="#local-6989586621679299565"><span class="hs-identifier hs-var">purity</span></a></span></span><span> </span><span id="local-6989586621679299566"><span class="annot"><span class="annottext">Loc
-&gt; Q Type
-&gt; Type CIdentifier
-&gt; [(CIdentifier, Type CIdentifier)]
-&gt; String
-&gt; Q Exp
</span><a href="#local-6989586621679299566"><span class="hs-identifier hs-var">build</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String -&gt; Q Exp) -&gt; QuasiQuoter
</span><a href="Language.C.Inline.Internal.html#quoteCode"><span class="hs-identifier hs-var">quoteCode</span></a></span><span> </span><span class="annot"><span class="annottext">((String -&gt; Q Exp) -&gt; QuasiQuoter)
-&gt; (String -&gt; Q Exp) -&gt; QuasiQuoter
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679299567"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299567"><span class="hs-identifier hs-var">rawStr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-663"></span><span>    </span><span id="local-6989586621679299568"><span class="annot"><a href="#local-6989586621679299568"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Q Context
</span><a href="Language.C.Inline.Internal.html#getContext"><span class="hs-identifier hs-var">getContext</span></a></span><span>
</span><span id="line-664"></span><span>    </span><span id="local-6989586621679299569"><span class="annot"><a href="#local-6989586621679299569"><span class="hs-identifier hs-var">here</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.location</span></span><span>
</span><span id="line-665"></span><span>    </span><span id="local-6989586621679299570"><span class="annot"><a href="#local-6989586621679299570"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#applySubstitutions"><span class="hs-identifier hs-type">applySubstitutions</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299567"><span class="hs-identifier hs-type">rawStr</span></a></span><span>
</span><span id="line-666"></span><span>    </span><span class="annot"><a href="Language.C.Inline.Internal.html#ParseTypedC"><span class="hs-identifier hs-type">ParseTypedC</span></a></span><span> </span><span id="local-6989586621679299571"><span class="annot"><a href="#local-6989586621679299571"><span class="hs-identifier hs-var">cType</span></a></span></span><span> </span><span id="local-6989586621679299572"><span class="annot"><a href="#local-6989586621679299572"><span class="hs-identifier hs-var">cParams</span></a></span></span><span> </span><span id="local-6989586621679299573"><span class="annot"><a href="#local-6989586621679299573"><span class="hs-identifier hs-var">cExp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-667"></span><span>      </span><span class="annot"><a href="Language.C.Inline.Internal.html#runParserInQ"><span class="hs-identifier hs-type">runParserInQ</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299570"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-668"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Inline.HaskellIdentifier.html#haskellCParserContext"><span class="hs-identifier hs-type">haskellCParserContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Inline.Context.html#ctxEnableCpp"><span class="hs-identifier hs-var">ctxEnableCpp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299568"><span class="hs-identifier hs-type">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Inline.Context.html#typeNamesFromTypesTable"><span class="hs-identifier hs-type">typeNamesFromTypesTable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Inline.Context.html#ctxTypesTable"><span class="hs-identifier hs-var">ctxTypesTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299568"><span class="hs-identifier hs-type">ctx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-669"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Inline.Internal.html#parseTypedC"><span class="hs-identifier hs-type">parseTypedC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Inline.Context.html#ctxEnableCpp"><span class="hs-identifier hs-var">ctxEnableCpp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299568"><span class="hs-identifier hs-type">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Inline.Context.html#ctxAntiQuoters"><span class="hs-identifier hs-var">ctxAntiQuoters</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299568"><span class="hs-identifier hs-type">ctx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-670"></span><span>    </span><span id="local-6989586621679299578"><span class="annot"><a href="#local-6989586621679299578"><span class="hs-identifier hs-var">hsType</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#cToHs"><span class="hs-identifier hs-type">cToHs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299568"><span class="hs-identifier hs-type">ctx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299565"><span class="hs-identifier hs-type">purity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299571"><span class="hs-identifier hs-type">cType</span></a></span><span>
</span><span id="line-671"></span><span>    </span><span id="local-6989586621679299579"><span class="annot"><a href="#local-6989586621679299579"><span class="hs-identifier hs-var">hsParams</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">forM</span></span><span> </span><span class="annot"><a href="#local-6989586621679299572"><span class="hs-identifier hs-type">cParams</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679299580"><span class="annot"><span class="annottext">CIdentifier
</span><a href="#local-6989586621679299580"><span class="hs-identifier hs-var">_cId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299581"><span class="annot"><span class="annottext">Type CIdentifier
</span><a href="#local-6989586621679299581"><span class="hs-identifier hs-var">cTy</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299582"><span class="annot"><span class="annottext">ParameterType
</span><a href="#local-6989586621679299582"><span class="hs-identifier hs-var">parTy</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-672"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ParameterType
</span><a href="#local-6989586621679299582"><span class="hs-identifier hs-var">parTy</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-673"></span><span>        </span><span class="annot"><a href="Language.C.Inline.Internal.html#Plain"><span class="hs-identifier hs-type">Plain</span></a></span><span> </span><span id="local-6989586621679299583"><span class="annot"><span class="annottext">HaskellIdentifier
</span><a href="#local-6989586621679299583"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-674"></span><span>          </span><span id="local-6989586621679299584"><span class="annot"><a href="#local-6989586621679299584"><span class="hs-identifier hs-var">hsTy</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Purity -&gt; Type CIdentifier -&gt; Q Type
</span><a href="Language.C.Inline.Internal.html#cToHs"><span class="hs-identifier hs-var">cToHs</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679299568"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Purity
</span><a href="#local-6989586621679299565"><span class="hs-identifier hs-var">purity</span></a></span><span> </span><span class="annot"><span class="annottext">Type CIdentifier
</span><a href="#local-6989586621679299581"><span class="hs-identifier hs-var">cTy</span></a></span><span>
</span><span id="line-675"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299585"><span class="annot"><a href="#local-6989586621679299585"><span class="hs-identifier hs-var hs-var">hsName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><span class="hs-identifier hs-var">TH.mkName</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HaskellIdentifier -&gt; String
</span><a href="Language.C.Inline.HaskellIdentifier.html#unHaskellIdentifier"><span class="hs-identifier hs-var">unHaskellIdentifier</span></a></span><span> </span><span class="annot"><span class="annottext">HaskellIdentifier
</span><a href="#local-6989586621679299583"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-676"></span><span>          </span><span id="local-6989586621679299586"><span class="annot"><a href="#local-6989586621679299586"><span class="hs-identifier hs-var">hsExp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[|</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679299587"><span class="annot"><a href="#local-6989586621679299587"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679299587"><span class="hs-identifier hs-type">cont</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.varE</span></span><span> </span><span class="annot"><a href="#local-6989586621679299585"><span class="hs-identifier hs-type">hsName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621679299584"><span class="hs-identifier hs-type">hsTy</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">|]</span><span>
</span><span id="line-677"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679299584"><span class="hs-identifier hs-type">hsTy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679299586"><span class="hs-identifier hs-type">hsExp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-678"></span><span>        </span><span class="annot"><a href="Language.C.Inline.Internal.html#AntiQuote"><span class="hs-identifier hs-type">AntiQuote</span></a></span><span> </span><span id="local-6989586621679299588"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299588"><span class="hs-identifier hs-var">antiId</span></a></span></span><span> </span><span id="local-6989586621679299589"><span class="annot"><span class="annottext">SomeEq
</span><a href="#local-6989586621679299589"><span class="hs-identifier hs-var">dyn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-679"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">String -&gt; AntiQuoters -&gt; Maybe SomeAntiQuoter
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299588"><span class="hs-identifier hs-var">antiId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; AntiQuoters
</span><a href="Language.C.Inline.Context.html#ctxAntiQuoters"><span class="hs-identifier hs-var">ctxAntiQuoters</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679299568"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-680"></span><span>            </span><span class="annot"><span class="annottext">Maybe SomeAntiQuoter
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-681"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; Q (Type, Exp)
forall a. String -&gt; Q a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Q (Type, Exp)) -&gt; String -&gt; Q (Type, Exp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;IMPOSSIBLE: could not find anti-quoter &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299588"><span class="hs-identifier hs-var">antiId</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-682"></span><span>                     </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;. (genericQuote)&quot;</span></span><span>
</span><span id="line-683"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Inline.Context.html#SomeAntiQuoter"><span class="hs-identifier hs-type">SomeAntiQuoter</span></a></span><span> </span><span id="local-6989586621679299599"><span class="annot"><span class="annottext">AntiQuoter a
</span><a href="#local-6989586621679299599"><span class="hs-identifier hs-var">antiQ</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SomeEq -&gt; Maybe a
forall a. (Eq a, Typeable a) =&gt; SomeEq -&gt; Maybe a
</span><a href="Language.C.Inline.Internal.html#fromSomeEq"><span class="hs-identifier hs-var">fromSomeEq</span></a></span><span> </span><span class="annot"><span class="annottext">SomeEq
</span><a href="#local-6989586621679299589"><span class="hs-identifier hs-var">dyn</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-684"></span><span>              </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-685"></span><span>                </span><span class="annot"><span class="annottext">String -&gt; Q (Type, Exp)
forall a. String -&gt; Q a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span>  </span><span class="annot"><span class="annottext">(String -&gt; Q (Type, Exp)) -&gt; String -&gt; Q (Type, Exp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;IMPOSSIBLE: could not cast value for anti-quoter &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-686"></span><span>                        </span><span class="annot"><span class="annottext">String -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299588"><span class="hs-identifier hs-var">antiId</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;. (genericQuote)&quot;</span></span><span>
</span><span id="line-687"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299600"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299600"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-688"></span><span>                </span><span class="annot"><span class="annottext">AntiQuoter a
-&gt; Purity -&gt; TypesTable -&gt; Type CIdentifier -&gt; a -&gt; Q (Type, Exp)
forall a.
AntiQuoter a
-&gt; Purity -&gt; TypesTable -&gt; Type CIdentifier -&gt; a -&gt; Q (Type, Exp)
</span><a href="Language.C.Inline.Context.html#aqMarshaller"><span class="hs-identifier hs-var">aqMarshaller</span></a></span><span> </span><span class="annot"><span class="annottext">AntiQuoter a
</span><a href="#local-6989586621679299599"><span class="hs-identifier hs-var">antiQ</span></a></span><span> </span><span class="annot"><span class="annottext">Purity
</span><a href="#local-6989586621679299565"><span class="hs-identifier hs-var">purity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; TypesTable
</span><a href="Language.C.Inline.Context.html#ctxTypesTable"><span class="hs-identifier hs-var">ctxTypesTable</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679299568"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type CIdentifier
</span><a href="#local-6989586621679299581"><span class="hs-identifier hs-var">cTy</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299600"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-689"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299602"><span class="annot"><a href="#local-6989586621679299602"><span class="hs-identifier hs-var hs-var">hsFunType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; Q Type
</span><a href="#local-6989586621679299603"><span class="hs-identifier hs-var">convertCFunSig</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679299578"><span class="hs-identifier hs-var">hsType</span></a></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; Q Type) -&gt; [Type] -&gt; Q Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Type, Exp) -&gt; Type) -&gt; [(Type, Exp)] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Type, Exp) -&gt; Type
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Type, Exp)]
</span><a href="#local-6989586621679299579"><span class="hs-identifier hs-var">hsParams</span></a></span><span>
</span><span id="line-690"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299605"><span class="annot"><a href="#local-6989586621679299605"><span class="hs-identifier hs-var hs-var">cParams'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">CIdentifier
</span><a href="#local-6989586621679299606"><span class="hs-identifier hs-var">cId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type CIdentifier
</span><a href="#local-6989586621679299607"><span class="hs-identifier hs-var">cTy</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299606"><span class="annot"><span class="annottext">CIdentifier
</span><a href="#local-6989586621679299606"><span class="hs-identifier hs-var">cId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299607"><span class="annot"><span class="annottext">Type CIdentifier
</span><a href="#local-6989586621679299607"><span class="hs-identifier hs-var">cTy</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ParameterType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(CIdentifier, Type CIdentifier, ParameterType)]
</span><a href="#local-6989586621679299572"><span class="hs-identifier hs-var">cParams</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-691"></span><span>    </span><span id="local-6989586621679299608"><span class="annot"><a href="#local-6989586621679299608"><span class="hs-identifier hs-var">ioCall</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679299609"><span class="hs-identifier hs-type">buildFunCall</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299568"><span class="hs-identifier hs-type">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679299566"><span class="hs-identifier hs-type">build</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299569"><span class="hs-identifier hs-type">here</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299602"><span class="hs-identifier hs-type">hsFunType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299571"><span class="hs-identifier hs-type">cType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299605"><span class="hs-identifier hs-type">cParams'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299573"><span class="hs-identifier hs-type">cExp</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">snd</span></span><span> </span><span class="annot"><a href="#local-6989586621679299579"><span class="hs-identifier hs-type">hsParams</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-692"></span><span>    </span><span class="hs-comment">-- If the user requested a pure function, make it so.</span><span>
</span><span id="line-693"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679299565"><span class="hs-identifier hs-type">purity</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-694"></span><span>      </span><span class="hs-comment">-- Using unsafeDupablePerformIO to increase performance of pure calls, see &lt;https://github.com/fpco/inline-c/issues/115&gt;</span><span>
</span><span id="line-695"></span><span>      </span><span class="annot"><span class="annottext">Purity
</span><a href="Language.C.Inline.Context.html#Pure"><span class="hs-identifier hs-var">Pure</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unsafeDupablePerformIO</span></span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Q Exp
forall a. a -&gt; Q a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679299608"><span class="hs-identifier hs-var">ioCall</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">|]</span><span>
</span><span id="line-696"></span><span>      </span><span class="annot"><span class="annottext">Purity
</span><a href="Language.C.Inline.Context.html#IO"><span class="hs-identifier hs-var">IO</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Q Exp
forall a. a -&gt; Q a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679299608"><span class="hs-identifier hs-var">ioCall</span></a></span><span>
</span><span id="line-697"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-698"></span><span>    </span><span class="annot"><a href="#local-6989586621679299609"><span class="hs-identifier hs-type">buildFunCall</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.C.Inline.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.ExpQ</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.Exp</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.ExpQ</span></span><span>
</span><span id="line-699"></span><span>    </span><span id="local-6989586621679299609"><span class="annot"><span class="annottext">buildFunCall :: Context -&gt; Q Exp -&gt; [Exp] -&gt; [Name] -&gt; Q Exp
</span><a href="#local-6989586621679299609"><span class="hs-identifier hs-var hs-var">buildFunCall</span></a></span></span><span> </span><span id="local-6989586621679299611"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679299611"><span class="hs-identifier hs-var">_ctx</span></a></span></span><span> </span><span id="local-6989586621679299612"><span class="annot"><span class="annottext">Q Exp
</span><a href="#local-6989586621679299612"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621679299613"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679299613"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-700"></span><span>      </span><span class="annot"><span class="annottext">(Q Exp -&gt; Name -&gt; Q Exp) -&gt; Q Exp -&gt; [Name] -&gt; Q Exp
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679299615"><span class="annot"><span class="annottext">Q Exp
</span><a href="#local-6989586621679299615"><span class="hs-identifier hs-var">f'</span></a></span></span><span> </span><span id="local-6989586621679299616"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679299616"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[|</span><span> </span><span class="hs-special">$</span><span class="annot"><span class="annottext">Q Exp
</span><a href="#local-6989586621679299615"><span class="hs-identifier hs-var">f'</span></a></span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Q Exp
forall (m :: * -&gt; *). Quote m =&gt; Name -&gt; m Exp
</span><span class="hs-identifier hs-var">TH.varE</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679299616"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">|]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Q Exp
</span><a href="#local-6989586621679299612"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679299613"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-701"></span><span>    </span><span class="annot"><a href="#local-6989586621679299609"><span class="hs-identifier hs-var">buildFunCall</span></a></span><span> </span><span id="local-6989586621679299617"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679299617"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679299618"><span class="annot"><span class="annottext">Q Exp
</span><a href="#local-6989586621679299618"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299619"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679299619"><span class="hs-identifier hs-var">hsExp</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679299620"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621679299620"><span class="hs-identifier hs-var">params</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679299621"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679299621"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-702"></span><span>       </span><span class="hs-special">[|</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Q Exp
forall a. a -&gt; Q a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679299619"><span class="hs-identifier hs-var">hsExp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679299622"><span class="annot"><a href="#local-6989586621679299622"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-703"></span><span>            </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Q Exp -&gt; [Exp] -&gt; [Name] -&gt; Q Exp
</span><a href="#local-6989586621679299609"><span class="hs-identifier hs-var">buildFunCall</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679299617"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Q Exp
</span><a href="#local-6989586621679299618"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621679299620"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679299621"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Name] -&gt; [Name]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">'</span><span class="hs-identifier">arg</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-704"></span><span>       </span><span class="hs-special">|]</span><span>
</span><span id="line-705"></span><span>
</span><span id="line-706"></span><span>    </span><span class="annot"><a href="#local-6989586621679299603"><span class="hs-identifier hs-type">convertCFunSig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.TypeQ</span></span><span>
</span><span id="line-707"></span><span>    </span><span id="local-6989586621679299603"><span class="annot"><span class="annottext">convertCFunSig :: Type -&gt; [Type] -&gt; Q Type
</span><a href="#local-6989586621679299603"><span class="hs-identifier hs-var hs-var">convertCFunSig</span></a></span></span><span> </span><span id="local-6989586621679299623"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679299623"><span class="hs-identifier hs-var">retType</span></a></span></span><span> </span><span id="local-6989586621679299624"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679299624"><span class="hs-identifier hs-var">params0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-708"></span><span>      </span><span class="annot"><span class="annottext">[Type] -&gt; Q Type
</span><a href="#local-6989586621679299625"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679299624"><span class="hs-identifier hs-var">params0</span></a></span><span>
</span><span id="line-709"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-710"></span><span>        </span><span id="local-6989586621679299625"><span class="annot"><span class="annottext">go :: [Type] -&gt; Q Type
</span><a href="#local-6989586621679299625"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-711"></span><span>          </span><span class="hs-special">[t|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Q Type
forall a. a -&gt; Q a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679299623"><span class="hs-identifier hs-var">retType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">|]</span><span>
</span><span id="line-712"></span><span>        </span><span class="annot"><a href="#local-6989586621679299625"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299626"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679299626"><span class="hs-identifier hs-var">paramType</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679299627"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679299627"><span class="hs-identifier hs-var">params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-713"></span><span>          </span><span class="hs-special">[t|</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Q Type
forall a. a -&gt; Q a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679299626"><span class="hs-identifier hs-var">paramType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; Q Type
</span><a href="#local-6989586621679299625"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679299627"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">|]</span><span>
</span><span id="line-714"></span><span>
</span><span id="line-715"></span><span>
</span><span id="line-716"></span><span class="hs-comment">-- NOTE: splitTypedC wouldn't be necessary if inline-c-cpp could reuse C.block</span><span>
</span><span id="line-717"></span><span class="hs-comment">-- internals with a clean interface.</span><span>
</span><span id="line-718"></span><span class="hs-comment">-- This would be a significant refactoring but presumably it would lead to an</span><span>
</span><span id="line-719"></span><span class="hs-comment">-- api that could let users write their own quasiquoters a bit more conveniently.</span><span>
</span><span id="line-720"></span><span>
</span><span id="line-721"></span><span class="annot"><span class="hs-comment">-- | Returns the type and the body separately.</span></span><span>
</span><span id="line-722"></span><span class="annot"><a href="Language.C.Inline.Internal.html#splitTypedC"><span class="hs-identifier hs-type">splitTypedC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-723"></span><span id="splitTypedC"><span class="annot"><span class="annottext">splitTypedC :: String -&gt; (String, String, Int)
</span><a href="Language.C.Inline.Internal.html#splitTypedC"><span class="hs-identifier hs-var hs-var">splitTypedC</span></a></span></span><span> </span><span id="local-6989586621679299628"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299628"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; String
</span><a href="#local-6989586621679299629"><span class="hs-identifier hs-var">trim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299630"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299631"><span class="hs-identifier hs-var">bodyIndent</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299632"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679299633"><span class="hs-identifier hs-var">bodyLineShift</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-724"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299630"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299630"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299632"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299632"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; String -&gt; (String, String)
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">span</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'{'</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299628"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-725"></span><span>        </span><span id="local-6989586621679299629"><span class="annot"><span class="annottext">trim :: String -&gt; String
</span><a href="#local-6989586621679299629"><span class="hs-identifier hs-var hs-var">trim</span></a></span></span><span> </span><span id="local-6989586621679299636"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299636"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; String -&gt; String
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.dropWhileEnd</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Bool
</span><span class="hs-identifier hs-var">C.isSpace</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; String -&gt; String
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">dropWhile</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Bool
</span><span class="hs-identifier hs-var">C.isSpace</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299636"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-726"></span><span>
</span><span id="line-727"></span><span>        </span><span class="hs-comment">-- We may need to correct the line number of the body</span><span>
</span><span id="line-728"></span><span>        </span><span id="local-6989586621679299633"><span class="annot"><span class="annottext">bodyLineShift :: Int
</span><a href="#local-6989586621679299633"><span class="hs-identifier hs-var hs-var">bodyLineShift</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; String -&gt; String
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'\n'</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299630"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-729"></span><span>
</span><span id="line-730"></span><span>        </span><span class="hs-comment">-- Indentation is relevant for error messages when the syntax is:</span><span>
</span><span id="line-731"></span><span>        </span><span class="hs-comment">-- [C.foo| type</span><span>
</span><span id="line-732"></span><span>        </span><span class="hs-comment">--   { foo(); }</span><span>
</span><span id="line-733"></span><span>        </span><span class="hs-comment">-- |]</span><span>
</span><span id="line-734"></span><span>        </span><span id="local-6989586621679299631"><span class="annot"><span class="annottext">bodyIndent :: String
</span><a href="#local-6989586621679299631"><span class="hs-identifier hs-var hs-var">bodyIndent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-735"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299641"><span class="annot"><span class="annottext">precedingSpaceReversed :: String
</span><a href="#local-6989586621679299641"><span class="hs-identifier hs-var hs-var">precedingSpaceReversed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-736"></span><span>                </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; String -&gt; String
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">takeWhile</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679299643"><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679299643"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Char -&gt; Bool
</span><span class="hs-identifier hs-var">C.isSpace</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679299643"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(String -&gt; String) -&gt; String -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-737"></span><span>                </span><span class="annot"><span class="annottext">String -&gt; String
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; String) -&gt; String -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-738"></span><span>                </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299630"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-739"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621679299644"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299644"><span class="hs-identifier hs-var">precedingSpacesTabsReversed</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299645"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299645"><span class="hs-identifier hs-var">precedingLine</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-740"></span><span>                </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; String -&gt; (String, String)
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">span</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; String -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`notElem`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n\r&quot;</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Char</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299641"><span class="hs-identifier hs-var">precedingSpaceReversed</span></a></span><span>
</span><span id="line-741"></span><span>          </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299645"><span class="hs-identifier hs-var">precedingLine</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-742"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'\n'</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; String
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299644"><span class="hs-identifier hs-var">precedingSpacesTabsReversed</span></a></span><span>
</span><span id="line-743"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'\r'</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; String
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299644"><span class="hs-identifier hs-var">precedingSpacesTabsReversed</span></a></span><span>
</span><span id="line-744"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-comment">-- it wasn't indentation after all; just spaces after the type</span><span>
</span><span id="line-745"></span><span>
</span><span id="line-746"></span><span class="annot"><span class="hs-comment">-- | Data to parse for the 'funPtr' quasi-quoter.</span></span><span>
</span><span id="line-747"></span><span class="hs-keyword">data</span><span> </span><span id="FunPtrDecl"><span class="annot"><a href="Language.C.Inline.Internal.html#FunPtrDecl"><span class="hs-identifier hs-var">FunPtrDecl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FunPtrDecl"><span class="annot"><a href="Language.C.Inline.Internal.html#FunPtrDecl"><span class="hs-identifier hs-var">FunPtrDecl</span></a></span></span><span>
</span><span id="line-748"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="funPtrReturnType"><span class="annot"><span class="annottext">FunPtrDecl -&gt; Type CIdentifier
</span><a href="Language.C.Inline.Internal.html#funPtrReturnType"><span class="hs-identifier hs-var hs-var">funPtrReturnType</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.C.Types.html#Type"><span class="hs-identifier hs-type">C.Type</span></a></span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span>
</span><span id="line-749"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="funPtrParameters"><span class="annot"><span class="annottext">FunPtrDecl -&gt; [(CIdentifier, Type CIdentifier)]
</span><a href="Language.C.Inline.Internal.html#funPtrParameters"><span class="hs-identifier hs-var hs-var">funPtrParameters</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Types.html#Type"><span class="hs-identifier hs-type">C.Type</span></a></span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-750"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="funPtrBody"><span class="annot"><span class="annottext">FunPtrDecl -&gt; String
</span><a href="Language.C.Inline.Internal.html#funPtrBody"><span class="hs-identifier hs-var hs-var">funPtrBody</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-751"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="funPtrName"><span class="annot"><span class="annottext">FunPtrDecl -&gt; Maybe String
</span><a href="Language.C.Inline.Internal.html#funPtrName"><span class="hs-identifier hs-var hs-var">funPtrName</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-752"></span><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299653"><span id="local-6989586621679299663"><span class="annot"><span class="annottext">FunPtrDecl -&gt; FunPtrDecl -&gt; Bool
(FunPtrDecl -&gt; FunPtrDecl -&gt; Bool)
-&gt; (FunPtrDecl -&gt; FunPtrDecl -&gt; Bool) -&gt; Eq FunPtrDecl
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: FunPtrDecl -&gt; FunPtrDecl -&gt; Bool
== :: FunPtrDecl -&gt; FunPtrDecl -&gt; Bool
$c/= :: FunPtrDecl -&gt; FunPtrDecl -&gt; Bool
/= :: FunPtrDecl -&gt; FunPtrDecl -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299669"><span id="local-6989586621679299680"><span id="local-6989586621679299684"><span class="annot"><span class="annottext">Int -&gt; FunPtrDecl -&gt; String -&gt; String
[FunPtrDecl] -&gt; String -&gt; String
FunPtrDecl -&gt; String
(Int -&gt; FunPtrDecl -&gt; String -&gt; String)
-&gt; (FunPtrDecl -&gt; String)
-&gt; ([FunPtrDecl] -&gt; String -&gt; String)
-&gt; Show FunPtrDecl
forall a.
(Int -&gt; a -&gt; String -&gt; String)
-&gt; (a -&gt; String) -&gt; ([a] -&gt; String -&gt; String) -&gt; Show a
$cshowsPrec :: Int -&gt; FunPtrDecl -&gt; String -&gt; String
showsPrec :: Int -&gt; FunPtrDecl -&gt; String -&gt; String
$cshow :: FunPtrDecl -&gt; String
show :: FunPtrDecl -&gt; String
$cshowList :: [FunPtrDecl] -&gt; String -&gt; String
showList :: [FunPtrDecl] -&gt; String -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-753"></span><span>
</span><span id="line-754"></span><span class="annot"><a href="Language.C.Inline.Internal.html#funPtrQuote"><span class="hs-identifier hs-type">funPtrQuote</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Safety</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.QuasiQuoter</span></span><span>
</span><span id="line-755"></span><span id="funPtrQuote"><span class="annot"><span class="annottext">funPtrQuote :: Safety -&gt; QuasiQuoter
</span><a href="Language.C.Inline.Internal.html#funPtrQuote"><span class="hs-identifier hs-var hs-var">funPtrQuote</span></a></span></span><span> </span><span id="local-6989586621679299688"><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621679299688"><span class="hs-identifier hs-var">callSafety</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String -&gt; Q Exp) -&gt; QuasiQuoter
</span><a href="Language.C.Inline.Internal.html#quoteCode"><span class="hs-identifier hs-var">quoteCode</span></a></span><span> </span><span class="annot"><span class="annottext">((String -&gt; Q Exp) -&gt; QuasiQuoter)
-&gt; (String -&gt; Q Exp) -&gt; QuasiQuoter
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679299689"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299689"><span class="hs-identifier hs-var">rawCode</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-756"></span><span>  </span><span id="local-6989586621679299690"><span class="annot"><a href="#local-6989586621679299690"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Q Loc
</span><span class="hs-identifier hs-var">TH.location</span></span><span>
</span><span id="line-757"></span><span>  </span><span id="local-6989586621679299691"><span class="annot"><a href="#local-6989586621679299691"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#getContext"><span class="hs-identifier hs-type">getContext</span></a></span><span>
</span><span id="line-758"></span><span>  </span><span id="local-6989586621679299692"><span class="annot"><a href="#local-6989586621679299692"><span class="hs-identifier hs-var">code</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#applySubstitutions"><span class="hs-identifier hs-type">applySubstitutions</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299689"><span class="hs-identifier hs-type">rawCode</span></a></span><span>
</span><span id="line-759"></span><span>  </span><span class="annot"><a href="Language.C.Inline.Internal.html#FunPtrDecl"><span class="hs-identifier hs-type">FunPtrDecl</span></a></span><span class="hs-special">{</span><span id="local-6989586621679299693"><span id="local-6989586621679299694"><span id="local-6989586621679299695"><span id="local-6989586621679299696"><span class="annot"><a href="Language.C.Inline.Internal.html#funPtrReturnType"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#runParserInQ"><span class="hs-identifier hs-type">runParserInQ</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299692"><span class="hs-identifier hs-type">code</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Types.Parse.html#cCParserContext"><span class="hs-identifier hs-type">C.cCParserContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Inline.Context.html#ctxEnableCpp"><span class="hs-identifier hs-var">ctxEnableCpp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299691"><span class="hs-identifier hs-type">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Inline.Context.html#typeNamesFromTypesTable"><span class="hs-identifier hs-type">typeNamesFromTypesTable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.C.Inline.Context.html#ctxTypesTable"><span class="hs-identifier hs-var">ctxTypesTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299691"><span class="hs-identifier hs-type">ctx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679299697"><span class="hs-identifier hs-type">parse</span></a></span><span>
</span><span id="line-760"></span><span>  </span><span id="local-6989586621679299700"><span class="annot"><a href="#local-6989586621679299700"><span class="hs-identifier hs-var">hsRetType</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#cToHs"><span class="hs-identifier hs-type">cToHs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299691"><span class="hs-identifier hs-type">ctx</span></a></span><span> </span><span class="annot"><a href="Language.C.Inline.Context.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299693"><span class="hs-identifier hs-type">funPtrReturnType</span></a></span><span>
</span><span id="line-761"></span><span>  </span><span id="local-6989586621679299701"><span class="annot"><a href="#local-6989586621679299701"><span class="hs-identifier hs-var">hsParams</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">forM</span></span><span> </span><span class="annot"><a href="#local-6989586621679299694"><span class="hs-identifier hs-type">funPtrParameters</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679299702"><span class="annot"><span class="annottext">CIdentifier
</span><a href="#local-6989586621679299702"><span class="hs-identifier hs-var">_ident</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299703"><span class="annot"><span class="annottext">Type CIdentifier
</span><a href="#local-6989586621679299703"><span class="hs-identifier hs-var">typ_</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Purity -&gt; Type CIdentifier -&gt; Q Type
</span><a href="Language.C.Inline.Internal.html#cToHs"><span class="hs-identifier hs-var">cToHs</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679299691"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Purity
</span><a href="Language.C.Inline.Context.html#IO"><span class="hs-identifier hs-var">IO</span></a></span><span> </span><span class="annot"><span class="annottext">Type CIdentifier
</span><a href="#local-6989586621679299703"><span class="hs-identifier hs-var">typ_</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-762"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299704"><span class="annot"><a href="#local-6989586621679299704"><span class="hs-identifier hs-var hs-var">hsFunType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; Q Type
</span><a href="#local-6989586621679299705"><span class="hs-identifier hs-var">convertCFunSig</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679299700"><span class="hs-identifier hs-var">hsRetType</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679299701"><span class="hs-identifier hs-var">hsParams</span></a></span><span>
</span><span id="line-763"></span><span>  </span><span class="annot"><a href="Language.C.Inline.Internal.html#inlineItems"><span class="hs-identifier hs-type">inlineItems</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299688"><span class="hs-identifier hs-type">callSafety</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span> </span><span class="annot"><a href="#local-6989586621679299696"><span class="hs-identifier hs-type">funPtrName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299690"><span class="hs-identifier hs-type">loc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299704"><span class="hs-identifier hs-type">hsFunType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299693"><span class="hs-identifier hs-type">funPtrReturnType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299694"><span class="hs-identifier hs-type">funPtrParameters</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299695"><span class="hs-identifier hs-type">funPtrBody</span></a></span><span>
</span><span id="line-764"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-765"></span><span>    </span><span class="annot"><a href="#local-6989586621679299705"><span class="hs-identifier hs-type">convertCFunSig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TH.Type</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.TypeQ</span></span><span>
</span><span id="line-766"></span><span>    </span><span id="local-6989586621679299705"><span class="annot"><span class="annottext">convertCFunSig :: Type -&gt; [Type] -&gt; Q Type
</span><a href="#local-6989586621679299705"><span class="hs-identifier hs-var hs-var">convertCFunSig</span></a></span></span><span> </span><span id="local-6989586621679299706"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679299706"><span class="hs-identifier hs-var">retType</span></a></span></span><span> </span><span id="local-6989586621679299707"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679299707"><span class="hs-identifier hs-var">params0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-767"></span><span>      </span><span class="annot"><span class="annottext">[Type] -&gt; Q Type
</span><a href="#local-6989586621679299708"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679299707"><span class="hs-identifier hs-var">params0</span></a></span><span>
</span><span id="line-768"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-769"></span><span>        </span><span id="local-6989586621679299708"><span class="annot"><span class="annottext">go :: [Type] -&gt; Q Type
</span><a href="#local-6989586621679299708"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-770"></span><span>          </span><span class="hs-special">[t|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Q Type
forall a. a -&gt; Q a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679299706"><span class="hs-identifier hs-var">retType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">|]</span><span>
</span><span id="line-771"></span><span>        </span><span class="annot"><a href="#local-6989586621679299708"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299709"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679299709"><span class="hs-identifier hs-var">paramType</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679299710"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679299710"><span class="hs-identifier hs-var">params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-772"></span><span>          </span><span class="hs-special">[t|</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Q Type
forall a. a -&gt; Q a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679299709"><span class="hs-identifier hs-var">paramType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; Q Type
</span><a href="#local-6989586621679299708"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679299710"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">|]</span><span>
</span><span id="line-773"></span><span>
</span><span id="line-774"></span><span>    </span><span id="local-6989586621679299711"><span class="annot"><a href="#local-6989586621679299697"><span class="hs-identifier hs-type">parse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CParser"><span class="hs-identifier hs-type">C.CParser</span></a></span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299711"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679299711"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#FunPtrDecl"><span class="hs-identifier hs-type">FunPtrDecl</span></a></span></span><span>
</span><span id="line-775"></span><span>    </span><span id="local-6989586621679299697"><span class="annot"><span class="annottext">parse :: forall (m :: * -&gt; *). CParser CIdentifier m =&gt; m FunPtrDecl
</span><a href="#local-6989586621679299697"><span class="hs-identifier hs-var hs-var">parse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-776"></span><span>      </span><span class="hs-comment">-- skip spaces</span><span>
</span><span id="line-777"></span><span>      </span><span class="annot"><span class="annottext">m ()
forall (m :: * -&gt; *). CharParsing m =&gt; m ()
</span><span class="hs-identifier hs-var">Parser.spaces</span></span><span>
</span><span id="line-778"></span><span>      </span><span class="hs-comment">-- parse a proto</span><span>
</span><span id="line-779"></span><span>      </span><span class="annot"><a href="Language.C.Types.html#ParameterDeclaration"><span class="hs-identifier hs-type">C.ParameterDeclaration</span></a></span><span> </span><span id="local-6989586621679299740"><span class="annot"><a href="#local-6989586621679299740"><span class="hs-identifier hs-var">mbName</span></a></span></span><span> </span><span id="local-6989586621679299741"><span class="annot"><a href="#local-6989586621679299741"><span class="hs-identifier hs-var">protoTyp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (ParameterDeclaration CIdentifier)
forall i (m :: * -&gt; *).
(CParser i m, Pretty i) =&gt;
m (ParameterDeclaration i)
</span><a href="Language.C.Types.html#parseParameterDeclaration"><span class="hs-identifier hs-var">C.parseParameterDeclaration</span></a></span><span>
</span><span id="line-780"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679299741"><span class="hs-identifier hs-type">protoTyp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-781"></span><span>        </span><span class="annot"><a href="Language.C.Types.html#Proto"><span class="hs-identifier hs-type">C.Proto</span></a></span><span> </span><span id="local-6989586621679299742"><span class="annot"><span class="annottext">Type CIdentifier
</span><a href="#local-6989586621679299742"><span class="hs-identifier hs-var">retType</span></a></span></span><span> </span><span id="local-6989586621679299743"><span class="annot"><span class="annottext">[ParameterDeclaration CIdentifier]
</span><a href="#local-6989586621679299743"><span class="hs-identifier hs-var">paramList</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-782"></span><span>          </span><span id="local-6989586621679299744"><span class="annot"><a href="#local-6989586621679299744"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[ParameterDeclaration CIdentifier]
-&gt; (ParameterDeclaration CIdentifier
    -&gt; m (CIdentifier, Type CIdentifier))
-&gt; m [(CIdentifier, Type CIdentifier)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[ParameterDeclaration CIdentifier]
</span><a href="#local-6989586621679299743"><span class="hs-identifier hs-var">paramList</span></a></span><span> </span><span class="annot"><span class="annottext">((ParameterDeclaration CIdentifier
  -&gt; m (CIdentifier, Type CIdentifier))
 -&gt; m [(CIdentifier, Type CIdentifier)])
-&gt; (ParameterDeclaration CIdentifier
    -&gt; m (CIdentifier, Type CIdentifier))
-&gt; m [(CIdentifier, Type CIdentifier)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679299745"><span class="annot"><span class="annottext">ParameterDeclaration CIdentifier
</span><a href="#local-6989586621679299745"><span class="hs-identifier hs-var">decl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ParameterDeclaration CIdentifier -&gt; Maybe CIdentifier
forall i. ParameterDeclaration i -&gt; Maybe i
</span><a href="Language.C.Types.html#parameterDeclarationId"><span class="hs-identifier hs-var">C.parameterDeclarationId</span></a></span><span> </span><span class="annot"><span class="annottext">ParameterDeclaration CIdentifier
</span><a href="#local-6989586621679299745"><span class="hs-identifier hs-var">decl</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-783"></span><span>            </span><span class="annot"><span class="annottext">Maybe CIdentifier
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; m (CIdentifier, Type CIdentifier)
forall a. String -&gt; m a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m (CIdentifier, Type CIdentifier))
-&gt; String -&gt; m (CIdentifier, Type CIdentifier)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc (ZonkAny 5) -&gt; String
forall ann. Doc ann -&gt; String
</span><a href="Language.C.Inline.Internal.html#pretty80"><span class="hs-identifier hs-var">pretty80</span></a></span><span> </span><span class="annot"><span class="annottext">(Doc (ZonkAny 5) -&gt; String) -&gt; Doc (ZonkAny 5) -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-784"></span><span>              </span><span class="annot"><span class="annottext">Doc (ZonkAny 5)
</span><span class="hs-string">&quot;Un-named captured variable in decl&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc (ZonkAny 5) -&gt; Doc (ZonkAny 5) -&gt; Doc (ZonkAny 5)
forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">ParameterDeclaration CIdentifier -&gt; Doc (ZonkAny 5)
forall a ann. Pretty a =&gt; a -&gt; Doc ann
forall ann. ParameterDeclaration CIdentifier -&gt; Doc ann
</span><span class="hs-identifier hs-var">PP.pretty</span></span><span> </span><span class="annot"><span class="annottext">ParameterDeclaration CIdentifier
</span><a href="#local-6989586621679299745"><span class="hs-identifier hs-var">decl</span></a></span><span>
</span><span id="line-785"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299746"><span class="annot"><span class="annottext">CIdentifier
</span><a href="#local-6989586621679299746"><span class="hs-identifier hs-var">declId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(CIdentifier, Type CIdentifier)
-&gt; m (CIdentifier, Type CIdentifier)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CIdentifier
</span><a href="#local-6989586621679299746"><span class="hs-identifier hs-var">declId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ParameterDeclaration CIdentifier -&gt; Type CIdentifier
forall i. ParameterDeclaration i -&gt; Type i
</span><a href="Language.C.Types.html#parameterDeclarationType"><span class="hs-identifier hs-var">C.parameterDeclarationType</span></a></span><span> </span><span class="annot"><span class="annottext">ParameterDeclaration CIdentifier
</span><a href="#local-6989586621679299745"><span class="hs-identifier hs-var">decl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-786"></span><span>          </span><span class="hs-comment">-- get the rest of the body</span><span>
</span><span id="line-787"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">void</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Parser.symbolic</span></span><span> </span><span class="annot"><span class="hs-char">'{'</span></span><span class="hs-special">)</span><span>
</span><span id="line-788"></span><span>          </span><span id="local-6989586621679299747"><span class="annot"><a href="#local-6989586621679299747"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679299748"><span class="hs-identifier hs-type">parseBody</span></a></span><span>
</span><span id="line-789"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#FunPtrDecl"><span class="hs-identifier hs-type">FunPtrDecl</span></a></span><span>
</span><span id="line-790"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#funPtrReturnType"><span class="hs-identifier hs-var">funPtrReturnType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679299742"><span class="hs-identifier hs-type">retType</span></a></span><span>
</span><span id="line-791"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#funPtrParameters"><span class="hs-identifier hs-var">funPtrParameters</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679299744"><span class="hs-identifier hs-type">args</span></a></span><span>
</span><span id="line-792"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#funPtrBody"><span class="hs-identifier hs-var">funPtrBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679299747"><span class="hs-identifier hs-type">body</span></a></span><span>
</span><span id="line-793"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.C.Inline.Internal.html#funPtrName"><span class="hs-identifier hs-var">funPtrName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#unCIdentifier"><span class="hs-identifier hs-var">C.unCIdentifier</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299740"><span class="hs-identifier hs-type">mbName</span></a></span><span>
</span><span id="line-794"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-795"></span><span>        </span><span class="annot"><span class="annottext">Type CIdentifier
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; m FunPtrDecl
forall a. String -&gt; m a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m FunPtrDecl) -&gt; String -&gt; m FunPtrDecl
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Expecting function declaration&quot;</span></span><span>
</span><span id="line-796"></span><span>
</span><span id="line-797"></span><span>    </span><span id="local-6989586621679298735"><span class="annot"><a href="#local-6989586621679299748"><span class="hs-identifier hs-type">parseBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CParser"><span class="hs-identifier hs-type">C.CParser</span></a></span><span> </span><span class="annot"><a href="Language.C.Types.Parse.html#CIdentifier"><span class="hs-identifier hs-type">C.CIdentifier</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679298735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span></span><span>
</span><span id="line-798"></span><span>    </span><span id="local-6989586621679299748"><span class="annot"><span class="annottext">parseBody :: forall (m :: * -&gt; *). CParser CIdentifier m =&gt; m String
</span><a href="#local-6989586621679299748"><span class="hs-identifier hs-var hs-var">parseBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-799"></span><span>      </span><span id="local-6989586621679299783"><span class="annot"><a href="#local-6989586621679299783"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Char -&gt; m Char -&gt; m String
forall (m :: * -&gt; *) a end. Alternative m =&gt; m a -&gt; m end -&gt; m [a]
</span><span class="hs-identifier hs-var">Parser.manyTill</span></span><span> </span><span class="annot"><span class="annottext">m Char
forall (m :: * -&gt; *). CharParsing m =&gt; m Char
</span><span class="hs-identifier hs-var">Parser.anyChar</span></span><span> </span><span class="annot"><span class="annottext">(m Char -&gt; m String) -&gt; m Char -&gt; m String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-800"></span><span>           </span><span class="annot"><span class="annottext">m Char -&gt; m Char
forall a. m a -&gt; m a
forall (m :: * -&gt; *) a. LookAheadParsing m =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">Parser.lookAhead</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; m Char
forall (m :: * -&gt; *). CharParsing m =&gt; Char -&gt; m Char
</span><span class="hs-identifier hs-var">Parser.char</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'}'</span></span><span class="hs-special">)</span><span>
</span><span id="line-801"></span><span>      </span><span id="local-6989586621679299784"><span class="annot"><a href="#local-6989586621679299784"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">msum</span></span><span>
</span><span id="line-802"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Parser.try</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Try because we might fail to parse the 'eof'</span><span>
</span><span id="line-803"></span><span>                </span><span class="hs-comment">-- 'symbolic' because we want to consume whitespace</span><span>
</span><span id="line-804"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">void</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Parser.symbolic</span></span><span> </span><span class="annot"><span class="hs-char">'}'</span></span><span>
</span><span id="line-805"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">Parser.eof</span></span><span>
</span><span id="line-806"></span><span>             </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-807"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="hs-identifier hs-type">void</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Parser.char</span></span><span> </span><span class="annot"><span class="hs-char">'}'</span></span><span>
</span><span id="line-808"></span><span>             </span><span id="local-6989586621679299785"><span class="annot"><a href="#local-6989586621679299785"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621679299748"><span class="hs-identifier hs-type">parseBody</span></a></span><span>
</span><span id="line-809"></span><span>             </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;}&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621679299785"><span class="hs-identifier hs-type">s'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-810"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-811"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679299783"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621679299784"><span class="hs-identifier hs-type">s'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-812"></span><span>
</span><span id="line-813"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-814"></span><span class="hs-comment">-- Line directives</span><span>
</span><span id="line-815"></span><span>
</span><span id="line-816"></span><span class="hs-comment">-- | Tell the C compiler where the next line came from.</span><span>
</span><span id="line-817"></span><span class="hs-comment">--</span><span>
</span><span id="line-818"></span><span class="hs-comment">-- Example:</span><span>
</span><span id="line-819"></span><span class="hs-comment">--</span><span>
</span><span id="line-820"></span><span class="hs-comment">-- @@@</span><span>
</span><span id="line-821"></span><span class="hs-comment">-- there &lt;- location</span><span>
</span><span id="line-822"></span><span class="hs-comment">-- f (unlines</span><span>
</span><span id="line-823"></span><span class="hs-comment">--   [ lineDirective $(here)</span><span>
</span><span id="line-824"></span><span class="hs-comment">--   , &quot;generated_code_user_did_not_write()&quot;</span><span>
</span><span id="line-825"></span><span class="hs-comment">--   , lineDirective there</span><span>
</span><span id="line-826"></span><span class="hs-comment">--   ] ++ userCode</span><span>
</span><span id="line-827"></span><span class="hs-comment">-- ])</span><span>
</span><span id="line-828"></span><span class="hs-comment">-- @@@</span><span>
</span><span id="line-829"></span><span class="hs-comment">--</span><span>
</span><span id="line-830"></span><span class="hs-comment">-- Use @lineDirective $(C.here)@ when generating code, so that any errors or</span><span>
</span><span id="line-831"></span><span class="hs-comment">-- warnings report the location of the generating haskell module, rather than</span><span>
</span><span id="line-832"></span><span class="hs-comment">-- tangentially related user code that doesn't contain the actual problem.</span><span>
</span><span id="line-833"></span><span class="annot"><a href="Language.C.Inline.Internal.html#lineDirective"><span class="hs-identifier hs-type">lineDirective</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Loc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-834"></span><span id="lineDirective"><span class="annot"><span class="annottext">lineDirective :: Loc -&gt; String
</span><a href="Language.C.Inline.Internal.html#lineDirective"><span class="hs-identifier hs-var hs-var">lineDirective</span></a></span></span><span> </span><span id="local-6989586621679299786"><span class="annot"><span class="annottext">Loc
</span><a href="#local-6989586621679299786"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;#line &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int, Int) -&gt; Int
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Int, Int) -&gt; Int) -&gt; (Int, Int) -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Loc -&gt; (Int, Int)
</span><span class="hs-identifier hs-var">TH.loc_start</span></span><span> </span><span class="annot"><span class="annottext">Loc
</span><a href="#local-6989586621679299786"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Loc -&gt; String
</span><span class="hs-identifier hs-var">TH.loc_filename</span></span><span> </span><span class="annot"><span class="annottext">Loc
</span><a href="#local-6989586621679299786"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n&quot;</span></span><span>
</span><span id="line-835"></span><span>
</span><span id="line-836"></span><span class="hs-comment">-- | Get the location of the code you're looking at, for use with</span><span>
</span><span id="line-837"></span><span class="hs-comment">-- 'lineDirective'; place before generated code that user did not write.</span><span>
</span><span id="line-838"></span><span class="annot"><a href="Language.C.Inline.Internal.html#here"><span class="hs-identifier hs-type">here</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.ExpQ</span></span><span>
</span><span id="line-839"></span><span id="here"><span class="annot"><span class="annottext">here :: Q Exp
</span><a href="Language.C.Inline.Internal.html#here"><span class="hs-identifier hs-var hs-var">here</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[|</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Q Loc
</span><span class="hs-identifier hs-var">TH.location</span></span><span> </span><span class="annot"><span class="annottext">Q Loc -&gt; (Loc -&gt; Q Exp) -&gt; Q Exp
forall a b. Q a -&gt; (a -&gt; Q b) -&gt; Q b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.Loc</span></span><span> </span><span id="local-6989586621679299788"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299788"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679299789"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299789"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679299790"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299790"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299791"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679299791"><span class="hs-identifier hs-var">d1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299792"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679299792"><span class="hs-identifier hs-var">d2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299793"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679299793"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299794"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679299794"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-840"></span><span>    </span><span class="hs-special">[|</span><span class="annot"><span class="hs-identifier">Loc</span></span><span>
</span><span id="line-841"></span><span>      </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Q Exp
forall t (m :: * -&gt; *). (Lift t, Quote m) =&gt; t -&gt; m Exp
forall (m :: * -&gt; *). Quote m =&gt; String -&gt; m Exp
</span><span class="hs-identifier hs-var">TH.lift</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299788"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-842"></span><span>      </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Q Exp
forall t (m :: * -&gt; *). (Lift t, Quote m) =&gt; t -&gt; m Exp
forall (m :: * -&gt; *). Quote m =&gt; String -&gt; m Exp
</span><span class="hs-identifier hs-var">TH.lift</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299789"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-843"></span><span>      </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Q Exp
forall t (m :: * -&gt; *). (Lift t, Quote m) =&gt; t -&gt; m Exp
forall (m :: * -&gt; *). Quote m =&gt; String -&gt; m Exp
</span><span class="hs-identifier hs-var">TH.lift</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299790"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-844"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Q Exp
forall t (m :: * -&gt; *). (Lift t, Quote m) =&gt; t -&gt; m Exp
forall (m :: * -&gt; *). Quote m =&gt; Int -&gt; m Exp
</span><span class="hs-identifier hs-var">TH.lift</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679299791"><span class="hs-identifier hs-var">d1</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Q Exp
forall t (m :: * -&gt; *). (Lift t, Quote m) =&gt; t -&gt; m Exp
forall (m :: * -&gt; *). Quote m =&gt; Int -&gt; m Exp
</span><span class="hs-identifier hs-var">TH.lift</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679299792"><span class="hs-identifier hs-var">d2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-845"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Q Exp
forall t (m :: * -&gt; *). (Lift t, Quote m) =&gt; t -&gt; m Exp
forall (m :: * -&gt; *). Quote m =&gt; Int -&gt; m Exp
</span><span class="hs-identifier hs-var">TH.lift</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679299793"><span class="hs-identifier hs-var">e1</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Q Exp
forall t (m :: * -&gt; *). (Lift t, Quote m) =&gt; t -&gt; m Exp
forall (m :: * -&gt; *). Quote m =&gt; Int -&gt; m Exp
</span><span class="hs-identifier hs-var">TH.lift</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679299794"><span class="hs-identifier hs-var">e2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-846"></span><span>    </span><span class="hs-special">|]</span><span class="hs-special">)</span><span>
</span><span id="line-847"></span><span>  </span><span class="hs-special">|]</span><span>
</span><span id="line-848"></span><span>
</span><span id="line-849"></span><span class="annot"><a href="Language.C.Inline.Internal.html#shiftLines"><span class="hs-identifier hs-type">shiftLines</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Loc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.Loc</span></span><span>
</span><span id="line-850"></span><span id="shiftLines"><span class="annot"><span class="annottext">shiftLines :: Int -&gt; Loc -&gt; Loc
</span><a href="Language.C.Inline.Internal.html#shiftLines"><span class="hs-identifier hs-var hs-var">shiftLines</span></a></span></span><span> </span><span id="local-6989586621679299795"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679299795"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679299796"><span class="annot"><span class="annottext">Loc
</span><a href="#local-6989586621679299796"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Loc
</span><a href="#local-6989586621679299796"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-851"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier hs-var">TH.loc_start</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-852"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299797"><span class="annot"><a href="#local-6989586621679299797"><span class="hs-identifier hs-var">startLn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299798"><span class="annot"><a href="#local-6989586621679299798"><span class="hs-identifier hs-var">startCol</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-var">TH.loc_start</span></span><span> </span><span class="annot"><a href="#local-6989586621679299796"><span class="hs-identifier hs-type">l</span></a></span><span>
</span><span id="line-853"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679299797"><span class="hs-identifier hs-type">startLn</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+</span></span><span> </span><span class="annot"><a href="#local-6989586621679299795"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679299798"><span class="hs-identifier hs-type">startCol</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-854"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-var">TH.loc_end</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-855"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299800"><span class="annot"><a href="#local-6989586621679299800"><span class="hs-identifier hs-var">endLn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299801"><span class="annot"><a href="#local-6989586621679299801"><span class="hs-identifier hs-var">endCol</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-var">TH.loc_end</span></span><span> </span><span class="annot"><a href="#local-6989586621679299796"><span class="hs-identifier hs-type">l</span></a></span><span>
</span><span id="line-856"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679299800"><span class="hs-identifier hs-type">endLn</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+</span></span><span> </span><span class="annot"><a href="#local-6989586621679299795"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679299801"><span class="hs-identifier hs-type">endCol</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-857"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-858"></span><span>
</span><span id="line-859"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-860"></span><span class="hs-comment">-- Utils</span><span>
</span><span id="line-861"></span><span>
</span><span id="line-862"></span><span id="local-6989586621679299802"><span class="annot"><a href="Language.C.Inline.Internal.html#pretty80"><span class="hs-identifier hs-type">pretty80</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PP.Doc</span></span><span> </span><span class="annot"><a href="#local-6989586621679299802"><span class="hs-identifier hs-type">ann</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span></span><span>
</span><span id="line-863"></span><span id="pretty80"><span class="annot"><span class="annottext">pretty80 :: forall ann. Doc ann -&gt; String
</span><a href="Language.C.Inline.Internal.html#pretty80"><span class="hs-identifier hs-var hs-var">pretty80</span></a></span></span><span> </span><span id="local-6989586621679299803"><span class="annot"><span class="annottext">Doc ann
</span><a href="#local-6989586621679299803"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimpleDocStream ann -&gt; String
forall ann. SimpleDocStream ann -&gt; String
</span><span class="hs-identifier hs-var">PP.renderString</span></span><span> </span><span class="annot"><span class="annottext">(SimpleDocStream ann -&gt; String) -&gt; SimpleDocStream ann -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LayoutOptions -&gt; Doc ann -&gt; SimpleDocStream ann
forall ann. LayoutOptions -&gt; Doc ann -&gt; SimpleDocStream ann
</span><span class="hs-identifier hs-var">PP.layoutSmart</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PP.LayoutOptions</span></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">layoutPageWidth :: PageWidth
</span><span class="hs-identifier hs-var">PP.layoutPageWidth</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Double -&gt; PageWidth
</span><span class="hs-identifier hs-var">PP.AvailablePerLine</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">80</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.8</span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><a href="#local-6989586621679299803"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-864"></span><span>
</span><span id="line-865"></span><span id="local-6989586621679298474"><span class="annot"><a href="Language.C.Inline.Internal.html#prettyOneLine"><span class="hs-identifier hs-type">prettyOneLine</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PP.Doc</span></span><span> </span><span class="annot"><a href="#local-6989586621679298474"><span class="hs-identifier hs-type">ann</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span></span><span>
</span><span id="line-866"></span><span id="prettyOneLine"><span class="annot"><span class="annottext">prettyOneLine :: forall ann. Doc ann -&gt; String
</span><a href="Language.C.Inline.Internal.html#prettyOneLine"><span class="hs-identifier hs-var hs-var">prettyOneLine</span></a></span></span><span> </span><span id="local-6989586621679299809"><span class="annot"><span class="annottext">Doc ann
</span><a href="#local-6989586621679299809"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimpleDocStream (ZonkAny 0) -&gt; String
forall ann. SimpleDocStream ann -&gt; String
</span><span class="hs-identifier hs-var">PP.renderString</span></span><span> </span><span class="annot"><span class="annottext">(SimpleDocStream (ZonkAny 0) -&gt; String)
-&gt; SimpleDocStream (ZonkAny 0) -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc ann -&gt; SimpleDocStream (ZonkAny 0)
forall ann1 ann2. Doc ann1 -&gt; SimpleDocStream ann2
</span><span class="hs-identifier hs-var">PP.layoutCompact</span></span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><a href="#local-6989586621679299809"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-867"></span></pre></body></html>